<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Golangå¼€å‘wasmç¨‹åº</title>
      <link href="/golang-wasm.html"/>
      <url>/golang-wasm.html</url>
      
        <content type="html"><![CDATA[<p>wasmä»¥å°å·§å®‰å…¨çš„ç‰¹æ€§å—åˆ°å¹¿æ³›çš„å…³æ³¨ï¼Œä½†æ˜¯ä»–ä¹Ÿæœ‰å¾ˆå¤šçš„å±€é™æ€§ã€‚<br>è¿™äº›å±€é™æ€§å¯ä»¥é€šè¿‡<code>Host Function</code>è¿›è¡Œæ‰©å±•ï¼Œä½¿å¾—<em>wasm</em>ä¸<em>host</em>èƒ½å¤Ÿè¿›è¡Œäº¤äº’ï¼Œå®Œæˆæ›´å¤šçš„åŠŸèƒ½ã€‚</p><p><code>Host Function</code>éœ€è¦<code>import</code>åˆ°wasmä¸­ï¼ŒåŒæ ·wasmä¸­çš„functionéœ€è¦<code>export</code>åˆ°hostä¸­æ‰èƒ½è°ƒç”¨ã€‚</p><p>æœ¬ç¯‡ä¸»è¦è®°å½•ä¸‹åœ¨Golangä¸‹ï¼Œ<code>wasm function</code>å¦‚ä½•ä¸<code>host function</code>è¿›è¡Œäº¤äº’ã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒä¾èµ–"><a href="#ç¯å¢ƒä¾èµ–" class="headerlink" title="ç¯å¢ƒä¾èµ–"></a>ç¯å¢ƒä¾èµ–</h2><ol><li>ä½¿ç”¨wazeroæˆ–è€…wasmtime-goä½œä¸ºwasmçš„runtime</li><li>Tinygoç¼–è¯‘Golangä¸ºwasmæ–‡ä»¶</li></ol><h2 id="ä¸ºä»€ä¹ˆéœ€è¦Host-Function"><a href="#ä¸ºä»€ä¹ˆéœ€è¦Host-Function" class="headerlink" title="ä¸ºä»€ä¹ˆéœ€è¦Host Function"></a>ä¸ºä»€ä¹ˆéœ€è¦<code>Host Function</code></h2><p><code>Host Function</code>æŒ‡åœ¨<code>Host</code>ç¨‹åºé‡Œå®šä¹‰çš„æ–¹æ³•ã€‚æŸäº›æ–¹é¢wasmè¿˜ä¸å¤ªå®Œå–„ï¼Œæ¯”å¦‚é»˜è®¤æƒ…å†µä¸‹ä¸èƒ½åœ¨ç»ˆç«¯ä¸Šæ‰“å°ä¿¡æ¯ï¼Œæ¯”å¦‚<code>fmt.Println(&quot;Hello&quot;)</code>ï¼Œæ­¤æ—¶å°±å¯ä»¥åœ¨<code>host</code>ç¨‹åºä¸­åˆ›å»ºä¸€ä¸ª<code>Print(string)</code>æ–¹æ³•ï¼Œè®©wasmè°ƒç”¨è¿™ä¸ª<code>Print(string)</code>æ–¹æ³•ã€‚</p><p>åœ¨Golangä¸­éœ€è¦wasm runtimeå°†<code>Host Function</code>(æ¯”å¦‚<code>Print(string)</code>)åŠ è½½åˆ°wasmä¸­å³å¯è¿è¡Œï¼Œè¿™ä¸ªæ“ä½œä»wasmè§’åº¦çœ‹ï¼Œä¸º<code>import</code>ã€‚</p><p><img src="/blogimgs/golang-wasm/print-import.png"></p><h2 id="show-me-code"><a href="#show-me-code" class="headerlink" title="show me code"></a>show me code</h2><p><em>wasm</em>ä¸<em>host</em>è¿›è¡Œäº¤äº’æ¶‰åŠåˆ°<code>import</code>å’Œ<code>export</code>æ“ä½œï¼Œé€šè¿‡ä»£ç å…·ä½“å±•ç¤ºä½•æ—¶ä½¿ç”¨<code>import</code>å’Œ<code>export</code>ï¼Œä»¥åŠåœ¨tinygoä¸­åˆè¯¥å¦‚ä½•ä½¿ç”¨ã€‚</p><h3 id="1-Golangåˆ›å»ºwasmæ¨¡å—"><a href="#1-Golangåˆ›å»ºwasmæ¨¡å—" class="headerlink" title="1. Golangåˆ›å»ºwasmæ¨¡å—"></a>1. Golangåˆ›å»ºwasmæ¨¡å—</h3><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//export add </span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x <span class="keyword">uint32</span>, y <span class="keyword">uint32</span>)</span> <span class="title">uint32</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> x + y</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>1æ ‡è®°çš„ç©º<code>main</code>å‡½æ•°æ˜¯tinygoç¼–è¯‘wasmæ—¶éœ€è¦çš„</li><li>2æ ‡è®°çš„æ˜¯å°†<code>add</code>æ–¹æ³•å¯¼å‡ºåˆ°<code>host</code>ï¼Œè¿™æ ·å°±å¯ä»¥åœ¨hostç¨‹åºä¸­è°ƒç”¨wasmæ¨¡å—</li></ul><p>ä½¿ç”¨tinygoå°†golangç¼–è¯‘ä¸ºwasmæ¨¡å—<br><code>tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go</code></p><h3 id="2-ç¼–å†™hostç¨‹åºè°ƒç”¨wasmæ¨¡å—"><a href="#2-ç¼–å†™hostç¨‹åºè°ƒç”¨wasmæ¨¡å—" class="headerlink" title="2. ç¼–å†™hostç¨‹åºè°ƒç”¨wasmæ¨¡å—"></a>2. ç¼–å†™<code>host</code>ç¨‹åºè°ƒç”¨wasmæ¨¡å—</h3><p><code>host</code>æ¨¡å—æ˜¯ç”¨<code>Wazero</code>runtimeç¼–å†™ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªWebAssembly Runtimeï¼Œç„¶åå®ä¾‹åŒ–ä¸€ä¸ªWebAssembly moduleï¼Œè¿™æ ·<code>host</code>ç¨‹åºå°±èƒ½è°ƒç”¨<code>wasm function</code>äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line">  <span class="string">&quot;context&quot;</span></span><br><span class="line">  <span class="string">&quot;fmt&quot;</span></span><br><span class="line">  <span class="string">&quot;log&quot;</span></span><br><span class="line">  <span class="string">&quot;os&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="string">&quot;github.com/tetratelabs/wazero&quot;</span></span><br><span class="line">  <span class="string">&quot;github.com/tetratelabs/wazero/wasi_snapshot_preview1&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  ctx := context.Background()</span><br><span class="line"></span><br><span class="line"><span class="comment">// 1</span></span><br><span class="line">  r := wazero.NewRuntimeWithConfig(</span><br><span class="line">    ctx, wazero.NewRuntimeConfig().</span><br><span class="line">    WithWasmCore2())</span><br><span class="line"></span><br><span class="line">  <span class="keyword">defer</span> r.Close(ctx) </span><br><span class="line"></span><br><span class="line">  _, err := wasi_snapshot_preview1.Instantiate(ctx, r)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Panicln(err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 2</span></span><br><span class="line">  helloWasm, err := os.ReadFile(<span class="string">&quot;./hello.wasm&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Panicln(err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 3</span></span><br><span class="line">  mod, err := r.InstantiateModuleFromBinary(ctx, helloWasm)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Panicln(err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 4</span></span><br><span class="line">  addWasmModuleFunction := mod.ExportedFunction(<span class="string">&quot;add&quot;</span>) </span><br><span class="line"></span><br><span class="line"><span class="comment">// 5</span></span><br><span class="line">  result, err := addWasmModuleFunction.Call(ctx, <span class="number">20</span>, <span class="number">22</span>)</span><br><span class="line">  <span class="keyword">if</span> err != <span class="literal">nil</span> &#123;</span><br><span class="line">    log.Panicln(err)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fmt.Println(<span class="string">&quot;result:&quot;</span>, result[<span class="number">0</span>])</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>1æ ‡è®°çš„æ˜¯åˆ›å»ºä¸€ä¸ªWebAssembly Runtime</li><li>2æ ‡è®°çš„æ˜¯åŠ è½½ä¸€ä¸ªwasmæ¨¡å—</li><li>3æ ‡è®°çš„æ˜¯å®ä¾‹åŒ–ä¸€ä¸ªWebAssembly module</li><li>4æ ‡è®°çš„æ˜¯è·å–ä¸€ä¸ª<code>wasm function</code> <strong>add</strong>çš„å¼•ç”¨</li><li>5æ ‡è®°çš„æ˜¯åœ¨hostç¨‹åºä¸­è°ƒç”¨wasm</li></ul><p>ç„¶åå¯ä»¥åƒè¿è¡Œæ­£å¸¸Goç¨‹åºé‚£æ ·æ‰§è¡Œ<code>go run main.go</code>ï¼Œè¾“å‡ºæ˜¯<code>result: 42</code></p><p>è¿™ä¸ªåŸºç¡€ä¾‹å­å±•ç¤ºäº†wasmæ¨¡å—çš„å¸¸è§„ç”¨æ³•ï¼Œä¸»è¦å±•ç¤ºäº†hostç¨‹åºå¦‚ä½•è°ƒç”¨wasmæ¨¡å—ã€‚</p><ol><li>ä½†æ˜¯wasmæ¨¡å—å¦‚ä½•è°ƒç”¨<code>host function</code>å‘¢ï¼Ÿ</li><li>åœ¨Goç¼–å†™çš„wasmæ¨¡å—ä¸­ï¼Œä½¿ç”¨<code>export</code>å…³é”®å­—æ ‡è®°hostç¨‹åºå¯è°ƒç”¨çš„<code>wasm function</code>ï¼Œé‚£<code>host function</code>åˆæ˜¯å¦‚ä½•æ ‡è®°è¢«wasmæ¨¡å—è°ƒç”¨çš„å‘¢ï¼Ÿ</li></ol><p>å¸¦ç€è¿™ä¸¤ä¸ªç–‘é—®çœ‹ä¸‹é¢è¿™ä¸€èŠ‚å†…å®¹ã€‚</p><h2 id="export-import-å‚»å‚»åˆ†ä¸æ¸…æ¥š"><a href="#export-import-å‚»å‚»åˆ†ä¸æ¸…æ¥š" class="headerlink" title="export import å‚»å‚»åˆ†ä¸æ¸…æ¥š"></a>export import å‚»å‚»åˆ†ä¸æ¸…æ¥š</h2><p>ä¸Šé¢è¯´wasmå±€é™æ€§æ—¶æåˆ°æ— æ³•åœ¨ç»ˆç«¯æ‰“å°ä¿¡æ¯ï¼Œéœ€è¦åœ¨<code>host function</code>ä¸­å®šä¹‰ä¸€ä¸ª<code>Print(string)</code>æ–¹æ³•ï¼Œç„¶ååœ¨wasmæ¨¡å—ä¸­è°ƒç”¨ï¼Œç°åœ¨å°±åœ¨<code>host</code>ç¨‹åºä¸­å®šä¹‰ä¸€ä¸ªåœ¨ç»ˆç«¯æ‰“å°æ•°å­—çš„æ–¹æ³•<code>hostLogUint32</code>ã€‚</p><blockquote><p>hostLogUint32</p></blockquote><p>wasmæ¨¡å—è°ƒç”¨<code>host function</code>éœ€è¦åœ¨hostç¨‹åºä¸­å’Œwasmä¸­éƒ½è¿›è¡Œæ”¹åŠ¨</p><ul><li>hostç¨‹åºä¸­çš„æ”¹åŠ¨</li></ul><ol><li>å®šä¹‰ä¸€ä¸ª<code>logUint32</code>æ–¹æ³•</li><li>export <code>logUint32</code>æ–¹æ³•åˆ°Wasm runtimeç§ï¼Œä¸ºäº†æ–¹ä¾¿æ ‡è®°<code>logUint32</code> exportçš„åå­—ä¸º<code>hostLogUint32</code></li></ol><ul><li>wasmç¨‹åºä¸­çš„æ”¹åŠ¨</li></ul><ol><li>import <code>hostLogUint32</code>æ–¹æ³•</li><li>åœ¨wasmæ¨¡å—ä¸­è°ƒç”¨<code>hostLogUint32</code>æ–¹æ³•åœ¨ç»ˆç«¯æ‰“å°ä¸€ä¸ªæ•°å­—</li></ol><p><img src="/blogimgs/golang-wasm/hostLogUint32.png"></p><p>çœ‹ä¸‹å…·ä½“çš„ä»£ç æ”¹åŠ¨ï¼Œåœ¨<code>main.go</code>ä¸­æ·»åŠ <code>logUint32</code>æ–¹æ³•</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">logUint32</span><span class="params">(value <span class="keyword">uint32</span>)</span></span> &#123;</span><br><span class="line">  fmt.Println(<span class="string">&quot;ğŸ¤–:&quot;</span>, value)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶ååœ¨runtimeä¸­export <code>logUint32</code>æ–¹æ³•ä¸º<code>hostLogUint32</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">_, errEnv := wasmRuntime.NewModuleBuilder(<span class="string">&quot;env&quot;</span>).</span><br><span class="line">  ExportFunction(<span class="string">&quot;hostLogUint32&quot;</span>, logUint32).</span><br><span class="line">  Instantiate(ctx, wasmRuntime)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> errEnv != <span class="literal">nil</span> &#123;</span><br><span class="line">  log.Panicln(<span class="string">&quot;env/host function(s) error:&quot;</span>, errEnv)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥åœ¨wasmæ¨¡å—ä¸­import <code>hostLogUint32</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//export hostLogUint32</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hostLogUint32</span><span class="params">(value <span class="keyword">uint32</span>)</span></span></span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œæ˜¯ä¸æ˜¯æœ‰äººå¼€å§‹ç–‘æƒ‘äº†ï¼Œä¸æ˜¯è¯´å¥½importå˜›ï¼Œæ€ä¹ˆè¿˜æ˜¯exportå‘€ï¼Ÿï¼Ÿï¼Ÿæˆ‘å½“æ—¶å¯æ˜¯å›°æ‰°äº†å¥½ä¹…å¥½ä¹…ã€‚ã€‚ã€‚</strong><br><strong>è¿™é‡Œ<code>//export hostLogUint32</code>å…¶å®æ˜¯wasmæ¨¡å—import <code>host function</code>ï¼Œå¯ä»¥æ³¨æ„åˆ°è¿™é‡Œçš„<code>hostLogUint32</code>å¹¶æ²¡æœ‰æ–¹æ³•ä½“ï¼Œè¿™ä¸ªå¯ä»¥ç”¨æ¥åŒºåˆ†æ˜¯exportè¿˜æ˜¯import</strong></p><p>æœ€åå°±æ˜¯åœ¨wasmæ¨¡å—ä¸­è°ƒç”¨<code>host function</code>äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//export hostLogUint32</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">hostLogUint32</span><span class="params">(value <span class="keyword">uint32</span>)</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">//export add</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">add</span><span class="params">(x <span class="keyword">uint32</span>, y <span class="keyword">uint32</span>)</span> <span class="title">uint32</span></span> &#123;</span><br><span class="line">  res := x + y</span><br><span class="line">  hostLogUint32(res)</span><br><span class="line">  <span class="keyword">return</span> res</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¨‹åºå‡†å¤‡å¥½ä¹‹åå°±å¯ä»¥è¿è¡Œï¼Œç”±äºwasmæ¨¡å—ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦é‡æ–°ç¼–è¯‘wasmæ–‡ä»¶ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">tinygo build -o hello.wasm -scheduler=none --no-debug -target wasi ./hello.go</span><br><span class="line"></span><br><span class="line">go run main.go</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> è¾“å‡ºå¦‚ä¸‹</span></span><br><span class="line">ğŸ¤–: 42         # from the Wasm module</span><br><span class="line">result: 42     # from the host program</span><br></pre></td></tr></table></figure><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>å†™è¿™ç¯‡æ–‡ç« çš„ä¸»è¦ç›®çš„å…¶å®æƒ³ç†è§£tinygoä¸­exportçš„ç”¨æ³•ï¼Œå› ä¸ºåœ¨å‚è€ƒwasmç›¸å…³æ•™ç¨‹ä¸­<code>host function</code>éœ€è¦importåˆ°wasmä¸­æ‰èƒ½ä½¿ç”¨ï¼Œä½†æ˜¯tinygoä¸­å¹¶æ²¡æœ‰æä¾›<code>import</code>å…³é”®å­—ï¼Œè¿™ä½¿æˆ‘ä¸€åº¦æ€€ç–‘ä»£ç æœ‰é—®é¢˜ï¼Œä¸ºäº†æ¶ˆé™¤ç–‘è™‘æ‰€ä»¥æ‰æŸ¥æ‰¾äº†å¾ˆå¤šèµ„æ–™ã€‚</p><p>æˆ‘çš„ç†è§£æ˜¯tinygoä¸­çš„<code>export</code>å…³é”®å­—æœ‰æ—¶é—´å……å½“å°†wasmæ¨¡å—ä¸­çš„æ–¹æ³•exportåˆ°hostçš„åŠŸèƒ½ï¼Œæœ‰æ—¶ä¹Ÿå……å½“å°†<code>host function</code>ä¸­çš„æ–¹æ³•importåˆ°wasmæ¨¡å—çš„åŠŸèƒ½ï¼Œé‚£è¿™ä¸¤ç§åœºæ™¯å¦‚ä½•åŒºåˆ†å‘¢ï¼Ÿæ˜¯çœ‹å¸¦æœ‰<code>export</code>å…³é”®å­—çš„æ–¹æ³•æ˜¯å¦æœ‰<code>æ–¹æ³•ä½“</code>ï¼Œå¦‚ä½•æœ‰å°±æ˜¯<code>export</code>ï¼Œæ²¡æœ‰åˆ™æ˜¯<code>import</code>ã€‚è¿™ä¸ªç»“æœä»<code>hostLogUint32</code>çš„è§£æå›¾ä¸­å¯ä»¥çŒœæƒ³åˆ°ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥å°†ç¼–è¯‘ä¹‹åçš„wasmæ–‡ä»¶è¿›è¡Œåç¼–è¯‘è¿›è¡ŒéªŒè¯ã€‚</p><p>wasmæ–‡ä»¶åç¼–è¯‘ä½¿ç”¨çš„æ˜¯<code>wasm-decompile</code>å‘½ä»¤ï¼Œå…·ä½“å‘½ä»¤ä¸º<code>wasm-decompile log.wasm -o log.dcmp</code>ï¼ŒæŸ¥çœ‹<code>log.dcmp</code>æ–‡ä»¶å¯çœ‹åˆ°importå’Œexportæ ‡æ³¨çš„æ–¹æ³•ã€‚</p><p><a href="https://www.wasm.builders/k33g_org/extend-wasm-with-host-functions-thanks-to-wazero-3n0n">å‚è€ƒ</a></p>]]></content>
      
      
      <categories>
          
          <category> Golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Wasm </tag>
            
            <tag> Golang </tag>
            
            <tag> Tinygo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åŸºäºWasmçš„è½»é‡å®æ—¶è®¡ç®—</title>
      <link href="/wasm-realtime.html"/>
      <url>/wasm-realtime.html</url>
      
        <content type="html"><![CDATA[<p>éšç€å„è¡Œå„ä¸šå¯¹å®æ—¶è®¡ç®—çš„éœ€æ±‚è¶Šæ¥è¶Šå¼ºçƒˆï¼Œå®æ—¶è®¡ç®—é¢†åŸŸçš„ç«äº‰ä¹Ÿè¶Šæ¥è¶Šæ¿€çƒˆï¼Œå‘ˆç°ç™¾èŠ±é½æ”¾çš„çŠ¶æ€ã€‚</p><p>è™½è¯´Flinkåœ¨å®æ—¶è®¡ç®—é¢†åŸŸå·²åç¨³è€å¤§å“¥ï¼Œä½†æ˜¯å´ä¹Ÿé˜»æŒ¡ä¸äº†å…¶å®ƒå®æ—¶è®¡ç®—æ¡†æ¶åœ¨æŸäº›ç»†åˆ†é¢†åŸŸå‘å…‰ã€‚</p><p>æœ¬ç¯‡ä¸»è¦ä»‹ç»å‡ æ¬¾åŸºäºwasmçš„è½»é‡å®æ—¶è®¡ç®—æ¡†æ¶ï¼Œæ¯”å¦‚Redpandaã€InfinyOnã€‚</p><span id="more"></span><h2 id="wasmæ˜¯ä»€ä¹ˆ"><a href="#wasmæ˜¯ä»€ä¹ˆ" class="headerlink" title="wasmæ˜¯ä»€ä¹ˆ"></a>wasmæ˜¯ä»€ä¹ˆ</h2><p>wasmæ˜¯WebAssemblyçš„ç®€ç§°ï¼Œå°±æ˜¯ä¸€ä¸ªå¯ç§»æ¤ã€ä½“ç§¯å°ã€åŠ è½½å¿«å¹¶ä¸”å…¼å®¹Webçš„å…¨æ–°æ ¼å¼ã€‚ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šç›¸å…³çš„ä»‹ç»ï¼Œå¯ä»¥å‚è€ƒä¸‹ã€‚</p><h2 id="Redpanda"><a href="#Redpanda" class="headerlink" title="Redpanda"></a>Redpanda</h2><p>æ¥è‡ªå®˜æ–¹çš„æè¿°ï¼š<em>Redpanda is a KafkaÂ®-compatible streaming data platform that is up to 10x faster and 6x more hardware-efficient. It is also JVM-free, ZooKeeperÂ®-free, Jepsen-tested and source available.</em><br>Redpandaæ˜¯ä¸€ä¸ªå®æ—¶æ•°æ®å¹³å°ï¼Œå®Œå…¨å…¼å®¹kafkaï¼Œå¹¶ä¸”æ²¡æœ‰å¤–éƒ¨ä¾èµ–ï¼Œæ¯”å¦‚zookeeperã€‚å®ƒæ˜¯ç”¨<code>C++</code>ç¼–å†™ï¼Œæ‰€ä»¥ä¹Ÿæ²¡æœ‰<code>JVM</code>ã€‚</p><p>ç”±å®˜æ–¹çš„æè¿°å¯çŸ¥å®ƒä¸»è¦æ˜¯å¯¹æ ‡kafkaï¼Œå…¶æ ¸å¿ƒåŠŸèƒ½ä¹Ÿå°±æ˜¯æ¶ˆæ¯é˜Ÿåˆ—ã€‚ä¸è¿‡å®ƒè¿˜å¯ä»¥å¯¹æ•°æ®è¿›è¡Œå®æ—¶å¤„ç†ï¼Œä¸ªäººæ„Ÿè§‰å…¶æ•´ä½“åŠŸèƒ½æœ‰ç‚¹ç±»ä¼¼Plusarã€‚</p><p>ç”±äºå®ƒå®Œå…¨å…¼å®¹kafkaï¼Œæ‰€ä»¥å®ƒä¹Ÿæœ‰topicã€partitionã€replicationè¿™äº›æ¦‚å¿µï¼Œè€Œä¸”ä½¿ç”¨æ–¹å¼ä¹Ÿä¸kafkaä¸€æ ·ï¼Œå°±ä¸å†èµ˜è¿°äº†ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸‹å®æ—¶å¤„ç†ä¹Ÿå°±æ˜¯<code>Data Transforms</code>åŠŸèƒ½</p><h3 id="Data-Transforms"><a href="#Data-Transforms" class="headerlink" title="Data Transforms"></a>Data Transforms</h3><p><code>Data Transforms</code>æ˜¯Redpandaç”¨äºå®æ—¶æ•°æ®å¤„ç†çš„æ¨¡å—ï¼Œå…¶åŸºäº<code>wasm</code>å®ç°ã€‚åŸºäº<code>wasm</code>å®ç°çš„å¥½å¤„æ˜¯ç”¨æˆ·å¯ä»¥ä½¿ç”¨è‡ªå·±ç†Ÿæ‚‰çš„è¯­è¨€(å¯ç¼–è¯‘ä¸ºwasm)å¼€å‘æ•°æ®å¤„ç†é€»è¾‘ï¼Œç„¶åå°†å…¶ç¼–è¯‘ä¸º<code>wasm</code>æ–‡ä»¶å¹¶æ³¨å†Œéƒ¨ç½²åˆ°Redpandaä¸­ï¼Œå°±å¯ä»¥å¯¹æ•°æ®è¿›è¡Œå®æ—¶å¤„ç†ï¼Œå¯¹ç”¨æˆ·åŠå…¶å‹å¥½ã€‚</p><p>ä¸Šé¢æ˜¯æˆ‘ä¸ªäººçš„ç†è§£ï¼Œä¸‹é¢æ˜¯å®˜æ–¹ç»™å‡ºçš„äº®ç‚¹ï¼š</p><ol><li>æ˜“ç”¨: ç”¨æˆ·åªéœ€ä½¿ç”¨wasmæ”¯æŒçš„è¯­è¨€ç¼–å†™TransFormé€»è¾‘ï¼Œç„¶åå°†å…¶æ³¨å†Œåˆ°Redpandä¸­å°±å¯ä»¥äº†ï¼Œæ— éœ€å…³kafkaçš„ä¾èµ–åº“ã€‚</li><li>é«˜æ•ˆ: Transformä»£ç ä¼šæ¨é€åˆ°é›†ç¾¤ä¸­çš„æ‰€æœ‰èŠ‚ç‚¹ä¸­ï¼ŒRedpandaèŠ‚ç‚¹ä¼šåƒè°ƒç”¨RPCé‚£æ ·è°ƒç”¨è¿™äº›æœ¬åœ°ä»£ç ã€‚</li><li>ç®€å•: Transformç®¡ç†è¾ƒç®€å•ï¼Œåªéœ€å°†å…¶æ³¨å†Œåˆ°Redpandaå³å¯ï¼Œå…¶ä¼šå­˜å‚¨åœ¨ä¸€ä¸ªå•ç‹¬çš„topicä¸­ï¼Œç”±Redpandaè‡ªå·±ç®¡ç†ã€‚</li></ol><h3 id="Data-Transformsæ¶æ„"><a href="#Data-Transformsæ¶æ„" class="headerlink" title="Data Transformsæ¶æ„"></a>Data Transformsæ¶æ„</h3><p>Data Transformsç”±4éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«æ˜¯<code>å®¢æˆ·ç«¯å·¥å…·</code>ã€<code>å­˜å‚¨å’ŒTransform code</code>ã€<code>Routing streams</code>å’Œ<code>æ‰§è¡Œå¼•æ“</code>ã€‚</p><p><img src="/blogimgs/wasm-realtime/arch.png" title="æ¶æ„å›¾"></p><blockquote><p>å®¢æˆ·ç«¯å·¥å…·(Client-side tooling)</p></blockquote><p>å®¢æˆ·ç«¯å·¥å…·<code>rpk</code>å¯ä»¥ç”Ÿæˆä¸€ä¸ªæ ‡å‡†å·¥ç¨‹æ¨¡ç‰ˆï¼Œå¼€å‘è€…åªéœ€å¡«å……æ•°æ®è½¬æ¢é€»è¾‘å³å¯ã€‚è¿˜å¯é€šè¿‡<code>rpk</code>è¿›è¡Œéƒ¨ç½²ã€æ›´æ–°<code>wasm</code>æ–‡ä»¶ã€‚</p><blockquote><p>å­˜å‚¨å’ŒTransform code(Storage and distribution of scripts)</p></blockquote><p>Redpandaæ ¸å¿ƒæ˜¯ä¸€ä¸ªå¯çº¿æ€§æ‰©å±•ã€æ”¯æŒäº‹åŠ¡çš„å­˜å‚¨å¼•æ“ï¼Œåº•å±‚ä½¿ç”¨raftåè®®ä¿è¯æ•°æ®å‰¯æœ¬ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚Redpandaå®Œå…¨æ”¯æŒkafkaåè®®ï¼Œæ‰€ä»¥ä¹Ÿæ˜¯æŒ‰ç…§topicã€partitionå’Œreplicationè¿›è¡Œå­˜å‚¨çš„ï¼ŒåŒæ ·ä¹Ÿæ”¯æŒå‹ç¼©å­˜å‚¨ã€‚</p><p>å¼€å‘è€…æ³¨å†Œçš„<code>.wasm</code>æ–‡ä»¶å­˜åœ¨ä¸€ä¸ªå•ç‹¬çš„å†…ç½®topicä¸­ï¼Œå…¶topicä¹Ÿæ˜¯æ”¯æŒå‹ç¼©çš„ã€‚<code>wasm</code>æ–‡ä»¶é€šè¿‡åå­—æ¥åŒºåˆ†ï¼Œç›¸åŒåå­—çš„wasmæ ¹æ®æ—¶é—´é¡ºåºè¿›è¡Œæ›´æ–°ï¼Œå‹ç¼©æ—¶ä¼šå°†å†å²ç‰ˆæœ¬ç§»é™¤ã€‚</p><blockquote><p>Routing streams(pacemaker)</p></blockquote><p>Routing streamsä¸»è¦ç”¨æ¥å°†æ•°æ®æ ¹æ®è§„åˆ™è·¯ç”±ç»™ä¸åŒçš„transformè¿›è¡Œå¤„ç†ï¼Œè¿™ä¸ªç»„ä»¶è¢«ç§°ä¸º<code>pacemaker</code>ã€‚å®ƒæ˜¯æ•´ä¸ªç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå®ƒéœ€è¦åœ¨ä¿è¯é«˜æ•ˆçš„å‰æä¸‹è¿˜éœ€è¦ä¿è¯æ•°æ®çš„é¡ºåºæ€§ã€‚å…¶æ•´ä¸ªå·¥ä½œæµåŒ…å«3æ­¥ï¼š</p><ol><li>å¹¶è¡Œä»<code>input</code>ä¸­è¯»å–æ•°æ®</li><li>æ¯ä¸ªåå¤„ç†å™¨é€šè¿‡RPCè°ƒç”¨<code>wasm</code>æ‰§è¡Œå¼•æ“æ‰§è¡Œä¼ è¿‡æ¥çš„æ•°æ®å’Œç›¸å…³çš„å…ƒæ•°æ®</li><li>å°†æ‰§è¡Œç»“æœå’Œoffsetå†™å…¥ç»“æœtopicä¸­</li></ol><p><img src="/blogimgs/wasm-realtime/pacemaker.png" title="pacemakerå·¥ä½œæµ"><br>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨å•ä¸ªåå¤„ç†å™¨ä¸­åªæœ‰åœ¨ç¬¬3æ­¥æ‰§è¡Œç»“æŸä¹‹åï¼Œç¬¬1æ­¥æ‰èƒ½å†æ¬¡è¢«æ‰§è¡Œï¼Œå¦åˆ™ç»“æœä¸­çš„æ•°æ®å°±ä¼šä¹±åºã€‚</p><p>peacemakerä¸­è¿˜ä¼šè®°å½•æ¯ä¸ªtransformå¤„ç†çš„offsetçŠ¶æ€ï¼Œä»¥ä¾¿å½“å¤„ç†å¤±è´¥æ—¶å·²è®°å½•çš„offsetå¤„è¿›è¡Œé‡æ”¾ï¼Œä»¥ä¿è¯å¹‚ç­‰æ€§ã€‚</p><blockquote><p>æ‰§è¡Œå¼•æ“(execution engine)</p></blockquote><p>æ‰§è¡Œå¼•æ“æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯åŒæ­¥å‡½æ•°è°ƒç”¨ï¼Œå¦ä¸€ç§æ˜¯åŸºäºå¼‚æ­¥çš„çŠ¶æ€è½¬æ¢ã€‚</p><ul><li>åŒæ­¥æ‰§è¡Œå¼•æ“<br>åŒæ­¥æ‰§è¡Œå¼•æ“ä¸»è¦åº”ç”¨åœ¨ä¸€äº›ç®€å•çš„æ•°æ®è¿‡æ»¤ã€æ•°æ®åŠ å¯†ç­‰è¾ƒä¸ºçº¯ç²¹çš„æ•°æ®å¤„ç†åœºæ™¯ä¸‹ï¼Œ<code>wasm</code>æ–‡ä»¶å°±åƒè°ƒç”¨åŒæ­¥å‡½æ•°é‚£æ ·è¢«æ‰§è¡Œã€‚å…¶æ¶æ„å¦‚å›¾ï¼š</li></ul><p><img src="/blogimgs/wasm-realtime/sync.png" title="åŒæ­¥æ‰§è¡Œå¼•æ“"></p><ul><li>å¼‚æ­¥æ‰§è¡Œå¼•æ“<br>å¼‚æ­¥æ‰§è¡Œå¼•æ“ä¸»è¦ç”¨äºåœ¨transformæ—¶éœ€è¦å¤–éƒ¨ä¾èµ–æˆ–è€…ä¸€äº›çŠ¶æ€çš„åœºæ™¯ä¸­ã€‚å› ä¸ºåœ¨è¿™äº›æƒ…å†µä¸‹<code>wasm</code>çš„æ‰§è¡Œæ—¶é•¿æ˜¯ä¸å—æ§åˆ¶çš„ï¼Œå®¹æ˜“é€ æˆé˜»å¡ï¼Œæ‰€ä»¥åœ¨å¼‚æ­¥æ‰§è¡Œå¼•æ“ä¸­ä¼šæ–°å»ºä¸€ä¸ªä¸åŸtopicåˆ†åŒºä¸€æ‘¸ä¸€æ ·çš„å­åˆ†åŒºï¼Œè¿™æ ·å°†producerã€transformå’Œconsumerè§£å¶ï¼Œæå‡æ•°æ®å¤„ç†èƒ½åŠ›ã€‚å…¶æ¶æ„å¦‚å›¾ï¼š</li></ul><p><img src="/blogimgs/wasm-realtime/async.png" title="å¼‚æ­¥æ‰§è¡Œå¼•æ“"></p><h3 id="Demo"><a href="#Demo" class="headerlink" title="Demo"></a>Demo</h3><p><a href="https://redpanda.com/blog/change-data-capture-postgres-debezium-kafka-connect">è¿™é‡Œ</a>æ˜¯å®˜æ–¹çš„ä¸€ä¸ªdemoï¼Œä»pgä¸­é€šè¿‡cdcå°†æ•°æ®ä¼ å…¥Redpandaä¸­ï¼Œæµç¨‹è¾ƒä¸ºç®€å•ï¼Œè€Œä¸”éƒ½æ˜¯åŸºäºdockerç¯å¢ƒçš„ï¼Œå°±ä¸å†é‡å¤äº†ã€‚</p><!--https://www.youtube.com/watch?v=skzWrp8eU-Yhttps://redpanda.com/blog/data-transformation-engine-with-wasm-runtimehttps://redpanda.com/blog/wasm-architecture--><h2 id="fluvio"><a href="#fluvio" class="headerlink" title="fluvio"></a>fluvio</h2><p>fluvioå‡ºè‡ªInfinyOnï¼Œå®ƒä¹Ÿæ˜¯å¼€æºçš„ï¼Œå¯å¯¹æ•°æ®è¿›è¡Œå®æ—¶èšåˆã€å…³è”å’Œå¯ç¼–ç¨‹ã€‚</p><p><img src="/blogimgs/wasm-realtime/fluvio.png" title="fluvio"></p><p>åˆ†ä¸º4éƒ¨åˆ†ï¼Œåˆ†åˆ«ä¸º<code>SmartModules</code>ã€<code>Data Streams</code>ã€<code>Immutable Store</code>å’Œ<code>Clients &amp; Connectors</code>ã€‚</p><ul><li><code>SmartModules</code>æ˜¯å¯ç¼–ç¨‹æ¨¡å—ï¼Œå¯ä»¥å®æ—¶å¯¹æ•°æ®è¿›è¡Œæ¸…æ´—ã€è¿‡æ»¤å’Œè®¡ç®—ï¼Œæ˜¯ç”¨<code>Rust</code>ç¼–å†™ç„¶åç¼–è¯‘ä¸º<code>wasm</code>è¿›è¡Œæ‰§è¡Œã€‚</li><li><code>Data Streams</code>æ˜¯åˆ†å¸ƒå¼æ¨¡å—ï¼Œæ”¯æŒå†—ä½™å’Œè‡ªåŠ¨æ¢å¤ã€‚</li><li><code>Immutable Store</code>æ˜¯ä¸€ä¸ªæŒä¹…ä¸å˜çš„å­˜å‚¨å±‚ï¼Œç”¨äºæŒä¹…åŒ–æ•°æ®</li><li><code>Clients &amp; Connectors</code>åŒ…å«ä¸€äº›å°è£…å¥½çš„APIï¼Œå¯ä»¥è¿›è¡Œç”Ÿäº§æ•°æ®å’Œæ¶ˆè´¹æ•°æ®ï¼Œè¿˜åŒ…æ‹¬ä¸€äº›å·²å°è£…å¥½çš„connectorç”¨äºè¿æ¥ä¸€äº›å¸¸è§æ•°æ®æºï¼Œæ¯”å¦‚pgsql</li></ul><h3 id="fluvioæ¶æ„"><a href="#fluvioæ¶æ„" class="headerlink" title="fluvioæ¶æ„"></a>fluvioæ¶æ„</h3><p>fluvioç”±2ä¸ªç»„ä»¶ç»„æˆï¼Œåˆ†åˆ«ä¸º<code>Streaming Controller(SC)</code>å’Œ<code>Streaming Processing Units(SPU)</code>ï¼Œé‡‡ç”¨master/workerå½¢å¼ï¼Œå…¶æ¶æ„å¦‚å›¾ï¼š</p><p><img src="/blogimgs/wasm-realtime/fluvio-arch.png" title="fluvioæ¶æ„å›¾"></p><p>SCè´Ÿè´£SPUçš„ç”Ÿå‘½å‘¨æœŸï¼ŒåŒ…æ‹¬æ•´ä¸ªé›†ç¾¤å„ä¸ªèŠ‚ç‚¹çš„æ‹“æ‰‘å›¾å’Œåˆ†å¸ƒå¼æ•°æ®æµç›¸å…³çš„ä¼˜åŒ–ã€‚SPUè´Ÿè´£å®æ—¶æ•°æ®ã€‚SCå’ŒSPUæ˜¯ç›¸äº’ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªæœåŠ¡éƒ½å¯å•ç‹¬é‡å¯ã€å‡çº§ã€‚</p><h3 id="SmartModules"><a href="#SmartModules" class="headerlink" title="SmartModules"></a>SmartModules</h3><p>SmartModulesæ˜¯å¼€å‘è€…å¯ç¼–ç¨‹çš„æ¨¡å—ï¼Œå¼€å‘è€…ä½¿ç”¨Rustè¯­è¨€è¿›è¡Œå¼€å‘ï¼Œç„¶åå°†å…¶ç¼–è¯‘ä¸ºwasmæäº¤ç»™fluvioï¼Œå°±å…è®¸å¼€å‘è€…ç›´æ¥æ§åˆ¶æ•°æ®æµã€‚<br>ç›®å‰å®˜æ–¹æä¾›çš„ç±»å‹æœ‰<code>Filter</code>ã€<code>Map</code>ï¼Œ<code>FilterMap</code>ï¼Œ<code>ArrayMap</code>å’Œ<code>Aggregate</code>ï¼Œä¸è¿‡å®˜æ–¹è¿˜æä¾›äº†ä¸€ä¸ªHubï¼Œæ–¹ä¾¿å¼€å‘è€…è´¡çŒ®è‡ªå·±çš„SmartModuleså’Œä¸‹è½½æ‰€éœ€çš„éå®˜æ–¹SmartModules</p><p>å®˜æ–¹ä¹Ÿæä¾›äº†ä¸€äº›Demoï¼Œéƒ½æ¯”è¾ƒç®€å•ï¼Œæ„Ÿå…´è¶£çš„å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹ã€‚</p><!-- https://www.infinyon.com/blog/2021/08/smartmodule-aggregates/https://www.infinyon.com/blog/2021/08/smartmodule-map-use-cases/https://www.infinyon.com/blog/2021/06/smartmodule-filters/--><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>è¿™ä¸¤ä¸ªå®æ—¶æ¡†æ¶éƒ½æ˜¯åŸºäºæ¶ˆæ¯é˜Ÿåˆ—ä¹‹ä¸Šçš„ï¼Œéƒ½æ˜¯é€šè¿‡<code>wasm</code>å°†æ•°æ®å¤„ç†åŠŸèƒ½å¼€å‘ç»™å¼€å‘è€…ï¼Œå…¶åŠŸèƒ½æœ‰ç‚¹åƒPlusarï¼Œåªä¸è¿‡Plusaræ˜¯ç”¨javaè¯­è¨€å¼€å‘çš„ï¼Œå…¶æ•°æ®å¤„ç†èƒ½åŠ›å¹¶æ²¡æœ‰ä½¿ç”¨<code>wasm</code>ï¼Œè€Œæ˜¯ä½¿ç”¨çš„æ˜¯åŸç”Ÿjavaè¯­è¨€ï¼Œä¸ªäººæ„Ÿè§‰å¯èƒ½æ˜¯å› ä¸ºjavaè¯­è¨€å—ä¼—æ¯”è¾ƒå¹¿å§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Realtime, BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Wasm </tag>
            
            <tag> Redpanda </tag>
            
            <tag> InfinyOn </tag>
            
            <tag> Pulsar </tag>
            
            <tag> Realtime </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>scratchè‡ªå®šä¹‰æ‰©å±•</title>
      <link href="/scratch-extensions-demo.html"/>
      <url>/scratch-extensions-demo.html</url>
      
        <content type="html"><![CDATA[<p>ä»Šæ—¥æƒ³æä¸€æscratchï¼Œä½¿ç”¨è¿‡ç¨‹ä¸­å‘ç°å®˜æ–¹ç»™çš„æ‰©å±•ç»„ä»¶ä¸­æœ‰äº›åœ¨å›½å†…ç”¨ä¸äº†ï¼Œæ‰€ä»¥å°±æƒ³æŠŠè¿™ä¸ªé—®é¢˜ç»™ä¿®å¤ä¸‹ï¼Œæ–¹ä¾¿å›½å†…ç”¨æˆ·ä½¿ç”¨ã€‚</p><p>åœ¨ä¿®å¤è¿™ä¸ªé—®é¢˜ä¹‹å‰ï¼Œç°ç†Ÿæ‚‰ä¸‹scratchï¼Œä»¥åŠå¦‚ä½•è‡ªå®šä¹‰æ‰©å±•ã€‚</p><span id="more"></span><h2 id="scratch"><a href="#scratch" class="headerlink" title="scratch"></a>scratch</h2><p>scratchæ˜¯MITå¼€æºçš„å°‘å„¿ç¼–ç¨‹å·¥å…·ï¼Œæä¾›å¯è§†åŒ–çš„ï¼Œç§¯æœ¨å¼ç¼–ç¨‹ï¼Œé™ä½å­¦ä¹ é—¨æ§›ï¼Œä¸°å¯Œåˆ›ä½œå½¢å¼ã€‚<br>æˆ‘ä½¿ç”¨çš„æ˜¯scratch3.0ï¼Œå®ƒæ˜¯ç”±å¤šä¸ªæ¨¡å—ç»„æˆçš„ï¼Œä¸æœ¬ç¯‡æ–‡ç« æ¶‰åŠæ¯”è¾ƒç´§å¯†çš„æ˜¯<code>scratch-gui</code>å’Œ<code>scratch-vm</code>ï¼Œå…¶ä¸­<code>scratch-gui</code>æä¾›äº†å¯è§†åŒ–çš„æ“ä½œç•Œé¢ï¼Œ<code>scratch-vm</code>æ˜¯æä¾›äº†è¿è¡Œç¯å¢ƒå’Œæ‰©å±•æ¨¡å—ã€‚</p><h2 id="è‡ªå®šä¹‰æ‰©å±•æ’ä»¶"><a href="#è‡ªå®šä¹‰æ‰©å±•æ’ä»¶" class="headerlink" title="è‡ªå®šä¹‰æ‰©å±•æ’ä»¶"></a>è‡ªå®šä¹‰æ‰©å±•æ’ä»¶</h2><h3 id="scratch-vmä¸­çš„æ”¹åŠ¨"><a href="#scratch-vmä¸­çš„æ”¹åŠ¨" class="headerlink" title="scratch-vmä¸­çš„æ”¹åŠ¨"></a>scratch-vmä¸­çš„æ”¹åŠ¨</h3><p>æ‰©å±•æ’ä»¶çš„å…·ä½“å®ç°åœ¨<code>scratch-vm</code>æ¨¡å—ä¸­çš„<code>src/extensions</code>ï¼Œå½“å‰ç›®å½•ä¸­å·²æœ‰ä¸€äº›å®˜æ–¹é›†æˆçš„æ’ä»¶ï¼Œæ¯”å¦‚ç¿»è¯‘ã€ä¹é«˜äº’è”ç›¸å…³çš„æ’ä»¶ï¼Œæ¯ä¸ªæ‰©å±•ä¸­éƒ½æœ‰ä¸ª<code>index.js</code>æ–‡ä»¶ï¼Œè¿™ä¸ªæ–‡ä»¶å°±æ˜¯è¯¥æ‰©å±•çš„ä¸»è¦å®ç°å…¥å£ã€‚</p><p>è‡ªå®šä¹‰æ‰©å±•ä¸­å¯ä»¥ä½¿ç”¨çš„ç§¯æœ¨å—æ‰€åœ¨<code>getInfo()</code>æ–¹æ³•ä¸­å®šä¹‰çš„ï¼Œçœ‹ä¸‹ç¿»è¯‘æ‰©å±•ä¸­<code>getInfo()</code>æ–¹æ³•ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">getInfo () &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="attr">id</span>: <span class="string">&#x27;translate&#x27;</span>,</span><br><span class="line">        <span class="attr">name</span>: formatMessage(&#123;</span><br><span class="line">            <span class="attr">id</span>: <span class="string">&#x27;translate.categoryName&#x27;</span>,</span><br><span class="line">            <span class="attr">default</span>: <span class="string">&#x27;Translate&#x27;</span>,</span><br><span class="line">            <span class="attr">description</span>: <span class="string">&#x27;Name of extension that adds translate blocks&#x27;</span></span><br><span class="line">        &#125;),</span><br><span class="line">        <span class="attr">blockIconURI</span>: blockIconURI,</span><br><span class="line">        <span class="attr">menuIconURI</span>: menuIconURI,</span><br><span class="line">        <span class="attr">blocks</span>: [</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">opcode</span>: <span class="string">&#x27;getTranslate&#x27;</span>,</span><br><span class="line">                <span class="attr">text</span>: formatMessage(&#123;</span><br><span class="line">                    <span class="attr">id</span>: <span class="string">&#x27;translate.translateBlock&#x27;</span>,</span><br><span class="line">                    <span class="attr">default</span>: <span class="string">&#x27;translate [WORDS] to [LANGUAGE]&#x27;</span>,</span><br><span class="line">                    <span class="attr">description</span>: <span class="string">&#x27;translate some text to a different language&#x27;</span></span><br><span class="line">                &#125;),</span><br><span class="line">                <span class="attr">blockType</span>: BlockType.REPORTER,</span><br><span class="line">                <span class="attr">arguments</span>: &#123;</span><br><span class="line">                    <span class="attr">WORDS</span>: &#123;</span><br><span class="line">                        <span class="attr">type</span>: ArgumentType.STRING,</span><br><span class="line">                        <span class="attr">defaultValue</span>: formatMessage(&#123;</span><br><span class="line">                            <span class="attr">id</span>: <span class="string">&#x27;translate.defaultTextToTranslate&#x27;</span>,</span><br><span class="line">                            <span class="attr">default</span>: <span class="string">&#x27;hello&#x27;</span>,</span><br><span class="line">                            <span class="attr">description</span>: <span class="string">&#x27;hello: the default text to translate&#x27;</span></span><br><span class="line">                        &#125;)</span><br><span class="line">                    &#125;,</span><br><span class="line">                    <span class="attr">LANGUAGE</span>: &#123;</span><br><span class="line">                        <span class="attr">type</span>: ArgumentType.STRING,</span><br><span class="line">                        <span class="attr">menu</span>: <span class="string">&#x27;languages&#x27;</span>,</span><br><span class="line">                        <span class="attr">defaultValue</span>: <span class="built_in">this</span>._randomLanguageCode</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="attr">opcode</span>: <span class="string">&#x27;getViewerLanguage&#x27;</span>,</span><br><span class="line">                <span class="attr">text</span>: formatMessage(&#123;</span><br><span class="line">                    <span class="attr">id</span>: <span class="string">&#x27;translate.viewerLanguage&#x27;</span>,</span><br><span class="line">                    <span class="attr">default</span>: <span class="string">&#x27;language&#x27;</span>,</span><br><span class="line">                    <span class="attr">description</span>: <span class="string">&#x27;the languge of the project viewer&#x27;</span></span><br><span class="line">                &#125;),</span><br><span class="line">                <span class="attr">blockType</span>: BlockType.REPORTER,</span><br><span class="line">                <span class="attr">arguments</span>: &#123;&#125;</span><br><span class="line">            &#125;</span><br><span class="line">        ],</span><br><span class="line">        ...</span><br><span class="line">    &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­<code>blocks</code>å¯¹åº”çš„å€¼å°±æ˜¯ç§¯æœ¨å—ç±»å‹ï¼Œ<code>opcode</code>æ˜¯å…·ä½“æŸä¸ªç§¯æœ¨å—çš„å®ç°å†…å®¹ï¼Œå¦‚æœè¦ä¿®æ”¹ç§¯æœ¨å—çš„åŠŸèƒ½å°±ä¿®æ”¹æ­¤æ–¹æ³•å°±å¯ä»¥ã€‚</p><p>è‡ªå®šä¹‰æ‰©å±•çš„åŠŸèƒ½åœ¨æ­¤å®ç°ä¹‹åï¼Œè¿˜éœ€è¦åœ¨<code>src/extension-support/extension-manager.js</code>ä¸­æ³¨å†Œï¼Œè¿™æ ·åœ¨ç¼–è¯‘çš„æ—¶å€™ï¼Œå°†å…¶è‡ªå®šä¹‰æ‰©å±•è¿›è¡Œç¼–è¯‘ï¼Œå·²æ³¨å†Œçš„æ‰©å±•å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> builtinExtensions = &#123;</span><br><span class="line">    <span class="comment">// This is an example that isn&#x27;t loaded with the other core blocks,</span></span><br><span class="line">    <span class="comment">// but serves as a reference for loading core blocks as extensions.</span></span><br><span class="line">    <span class="attr">coreExample</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../blocks/scratch3_core_example&#x27;</span>),</span><br><span class="line">    <span class="comment">// These are the non-core built-in extensions.</span></span><br><span class="line">    <span class="attr">pen</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_pen&#x27;</span>),</span><br><span class="line">    <span class="attr">wedo2</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_wedo2&#x27;</span>),</span><br><span class="line">    <span class="attr">music</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_music&#x27;</span>),</span><br><span class="line">    <span class="attr">microbit</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_microbit&#x27;</span>),</span><br><span class="line">    <span class="attr">text2speech</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_text2speech&#x27;</span>),</span><br><span class="line">    <span class="attr">translate</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_translate&#x27;</span>),</span><br><span class="line">    <span class="attr">videoSensing</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_video_sensing&#x27;</span>),</span><br><span class="line">    <span class="attr">ev3</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_ev3&#x27;</span>),</span><br><span class="line">    <span class="attr">makeymakey</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_makeymakey&#x27;</span>),</span><br><span class="line">    <span class="attr">boost</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_boost&#x27;</span>),</span><br><span class="line">    <span class="attr">gdxfor</span>: <span class="function">() =&gt;</span> <span class="built_in">require</span>(<span class="string">&#x27;../extensions/scratch3_gdx_for&#x27;</span>),</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h3 id="scratch-guiä¸­çš„æ”¹åŠ¨"><a href="#scratch-guiä¸­çš„æ”¹åŠ¨" class="headerlink" title="scratch-guiä¸­çš„æ”¹åŠ¨"></a>scratch-guiä¸­çš„æ”¹åŠ¨</h3><p>scratch-vmä¿®æ”¹ç»“æŸä¹‹åï¼Œè¿˜éœ€è¦åœ¨<code>scratch-gui</code>ä¸­å¯¼å…¥è¯¥æ‰©å±•çš„ä¸€äº›ä¿¡æ¯ä¸å…¥å£ï¼Œä¿®æ”¹<code>/src/lib/libraries/extensions/index.jsx</code>æ–‡ä»¶ï¼Œ<br>é¦–å…ˆå¯¼å…¥è‡ªå®šä¹‰æ‰©å±•æ˜¾ç¤ºå›¾æ ‡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> translateIconURL <span class="keyword">from</span> <span class="string">&#x27;./translate/translate.png&#x27;</span>;</span><br><span class="line"><span class="keyword">import</span> translateInsetIconURL <span class="keyword">from</span> <span class="string">&#x27;./translate/translate-small.png&#x27;</span>;</span><br></pre></td></tr></table></figure><p>å…¶æ¬¡åœ¨<code>export default </code>ä»£ç å—ä¸­å¢åŠ è‡ªå®šä¹‰æ‰©å±•çš„ä¸€äº›æè¿°ä¿¡æ¯ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å…¶ä¸­çš„<code>extensionId</code>çš„å€¼éœ€è¦ä¸<code>scratch-vm</code>ä¸­<code>builtinExtensions</code>çš„å€¼å¯¹åº”ã€‚</p><figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="attr">name</span>: (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">FormattedMessage</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">defaultMessage</span>=<span class="string">&quot;Translate&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">description</span>=<span class="string">&quot;Name for the Translate extension&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">id</span>=<span class="string">&quot;gui.extension.translate.name&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        /&gt;</span></span></span><br><span class="line">    ),</span><br><span class="line">    <span class="attr">extensionId</span>: <span class="string">&#x27;translate&#x27;</span>,</span><br><span class="line">    <span class="attr">collaborator</span>: <span class="string">&#x27;YuanbaLab&#x27;</span>,</span><br><span class="line">    <span class="attr">iconURL</span>: translateIconURL,</span><br><span class="line">    <span class="attr">insetIconURL</span>: translateInsetIconURL,</span><br><span class="line">    <span class="attr">description</span>: (</span><br><span class="line">        <span class="xml"><span class="tag">&lt;<span class="name">FormattedMessage</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">defaultMessage</span>=<span class="string">&quot;Translate text into many languages.&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">description</span>=<span class="string">&quot;Description for the Translate extension&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">            <span class="attr">id</span>=<span class="string">&quot;gui.extension.translate.description&quot;</span></span></span></span><br><span class="line"><span class="tag"><span class="xml">        /&gt;</span></span></span><br><span class="line">    ),</span><br><span class="line">    <span class="attr">featured</span>: <span class="literal">true</span>,</span><br><span class="line">    <span class="attr">internetConnectionRequired</span>: <span class="literal">true</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¼–è¯‘è°ƒè¯•"><a href="#ç¼–è¯‘è°ƒè¯•" class="headerlink" title="ç¼–è¯‘è°ƒè¯•"></a>ç¼–è¯‘è°ƒè¯•</h3><p>ç¼–è¯‘è°ƒè¯•éœ€è¦å…·å¤‡node.jsç¯å¢ƒï¼Œå®‰è£…<code>npm install -g webpack</code>å’Œ<code>npm install -g webpack-dev-server</code>ã€‚<br>è¿›å…¥<code>scratch-vm</code>é¡¹ç›®ç›®å½•ä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm link</span><br><span class="line">npm run watch</span><br></pre></td></tr></table></figure><p>ç„¶åå†å¼€ä¸€ä¸ªç»ˆç«¯ï¼Œè¿›å…¥<code>scratch-gui</code>ç›®å½•ä¸­ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">npm install</span><br><span class="line">npm link scratch-vm </span><br><span class="line">npm start</span><br></pre></td></tr></table></figure><p>æ²¡æœ‰ä»»ä½•é”™è¯¯ä¿¡æ¯ä¹‹åï¼Œå°±å¯ä»¥åœ¨<code>http://127.0.0.1:8601/</code>åœ°å€ä½¿ç”¨scratch3.0äº†ã€‚</p><h2 id="ç¼–è¯‘æˆæ¡Œé¢ç¨‹åº"><a href="#ç¼–è¯‘æˆæ¡Œé¢ç¨‹åº" class="headerlink" title="ç¼–è¯‘æˆæ¡Œé¢ç¨‹åº"></a>ç¼–è¯‘æˆæ¡Œé¢ç¨‹åº</h2><p>git clone <a href="mailto:&#103;&#x69;&#116;&#x40;&#103;&#105;&#x74;&#x68;&#117;&#98;&#46;&#99;&#111;&#x6d;">&#103;&#x69;&#116;&#x40;&#103;&#105;&#x74;&#x68;&#117;&#98;&#46;&#99;&#111;&#x6d;</a>:hunshenshi/scratch-desktop.git</p><p>cd scratch-gui<br>npm install<br>npm link</p><p>cd scratch-desktop<br>npm install<br>npm link scratch-gui<br>npm run dist</p><p>electron æŠ¥é”™<br>è¿›å…¥ electronç›®å½•ï¼Œæ‰§è¡Œnode install.js</p><p>Cannot find module â€˜autoprefixerâ€™â€<br>npm install â€“save autoprefixer@^9.0.1</p><p>å°† æœ¬åœ°scratch-vmå’Œscratch-gui cpåˆ°desktopä¸­   or     npm link scratch-vm scratch-blocks<br>npm run clean &amp;&amp; npm run compile &amp;&amp; npm run doBuild â€“ â€“mode=dev</p><p>npm run dist # ç¼–è¯‘åçš„å®‰è£…åŒ…Scratch Desktop-3.8.0.AppImageå’Œscratch-desktop_3.8.0_amd64.snapä¿å­˜åœ¨scratch-desktop/dist/æ–‡ä»¶å¤¹ä¸­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> kidsCode </category>
          
      </categories>
      
      
        <tags>
            
            <tag> scratch </tag>
            
            <tag> æ‰©å±• </tag>
            
            <tag> kidsCode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>metabaseå¯¼å…¥IDEè°ƒè¯•</title>
      <link href="/metabase-import-ide.html"/>
      <url>/metabase-import-ide.html</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘åœ¨è°ƒç ”BIæŠ¥è¡¨ç›¸å…³çš„å·¥å…·ï¼Œæœ€åå†³å®šæ·±å…¥è°ƒç ”ä¸‹metabaseï¼Œäºæ˜¯å°±æœ‰äº†è¿™ç¯‡æ–‡ç« ã€‚</p><p>ä¹‹æ‰€ä»¥é€‰æ‹©metabaseæ˜¯å› ä¸ºä¸€ä¸‹å‡ ç‚¹ï¼š</p><ol><li>ä½é—¨æ§›ï¼Œå¯¹æ— sqlåŸºç¡€çš„äººå‘˜å‹å¥½</li><li>åˆ†æåŠŸèƒ½è¾ƒå…¨ï¼Œæ”¯æŒjoin</li><li>å›¾è¡¨åŠŸèƒ½OK</li><li>éƒ¨ç½²æ–¹ä¾¿<br>å¯¹äºæˆ‘æ¥è¯´ï¼Œå”¯ä¸€ä¸è¶³çš„æ˜¯å®ƒæ˜¯ç”±clojureå¼€å‘çš„ï¼ŒäºŒå¼€æˆæœ¬æœ‰ç‚¹é«˜ï¼Œè¿™æ‰æ˜¯è¿™ç¯‡æ–‡ç« çš„è¯ç”Ÿçš„çœŸæ­£åŸå› ï¼Œå› ä¸ºå¯¼å…¥IDEç¼–è¯‘æˆåŠŸå°±ç”¨äº†å¥½å‡ å¤©ã€‚        </li></ol><span id="more"></span><h2 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h2><p>metabaseå‰ç«¯ä¾èµ–nodeï¼Œåç«¯ä»¥æ¥jdkå’Œclojureã€‚</p><blockquote><p>æˆ‘æ˜¯åœ¨macç¯å¢ƒä¸‹çš„ï¼Œä¸‹é¢çš„å‘½ä»¤éƒ½æ˜¯åŸºäºmacçš„ã€‚</p></blockquote><p>1ã€å®‰è£…node<br>ä¹‹å‰åœ¨ç”µè„‘ä¸Šè£…è¿‡nodeï¼Œä½¿ç”¨tarå®‰è£…çš„ï¼Œåªæ˜¯ç‰ˆæœ¬æ¯”è¾ƒè€ï¼Œäºæ˜¯ç”¨taråŒ…å‡çº§äº†nodeï¼Œç‰ˆæœ¬å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">âœ cnpm -v</span><br><span class="line">cnpm@7.1.0 </span><br><span class="line">npm@6.14.15 </span><br><span class="line">node@16.13.0 </span><br><span class="line">npminstall@5.2.2 </span><br></pre></td></tr></table></figure><p>2ã€å®‰è£…yarn<br>nodeå®‰è£…å¥½ä¹‹åï¼Œå†å®‰è£…yarnï¼Œå®‰è£…æ—¶è¦é€‰æ‹©å…¨å±€å®‰è£…ï¼Œä½¿ç”¨å‘½ä»¤<br><code>npm install --global yarn</code></p><p>3ã€å®‰è£…jdk<br>jdkçš„å®‰è£…åªå¼ºè°ƒä¸€ç‚¹ï¼Œ<strong>ä¸€å®šè¦jdk11ã€jdk11ã€jdk11</strong></p><p>4ã€å®‰è£…clojure<br>åˆ©ç”¨brewå®‰è£…<br><code>brew install clojure/tools/clojure</code></p><blockquote><p>ç”±äºClojureä¹Ÿä¾èµ–mavenï¼Œé»˜è®¤çš„mavenæºåœ¨å›½å†…ç»å¸¸æ— æ³•è®¿é—®ï¼Œæ‰€ä»¥éœ€è¦æ›¿æ¢mavenæº</p></blockquote><p>åœ¨Clojureçš„å®‰è£…ç›®å½•ä¸­æ‰¾åˆ°<code>deps.edn</code>ï¼Œä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">:mvn/repos &#123;</span><br><span class="line">  &quot;central&quot; &#123;:url &quot;http://maven.aliyun.com/nexus/content/repositories/central/&quot;&#125; </span><br><span class="line">  &quot;clojars&quot; &#123;:url &quot;https://repo.clojars.org/&quot;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å‘½ä»¤è¡Œè¾“å…¥<code>clj</code> æˆ–è€… <code>clojure</code>ï¼Œå³å¯è¿›å…¥äº¤äº’ç•Œé¢ã€‚</p><p>5ã€IDEå¼€å‘ç¯å¢ƒè®¾ç½®<br>æˆ‘ä½¿ç”¨çš„æ˜¯intellij ideaï¼Œå®‰è£…æ’ä»¶<code>cursive</code>å³å¯ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯cursiveä¸ä¸€äº›æ’ä»¶æœ‰å†²çªï¼Œè€Œä¸”å¯¹IDEçš„ç‰ˆæœ¬ä¹Ÿæœ‰è¦æ±‚ã€‚(å¯ä»¥è¯´æ˜¯ä¸ºäº†æè¿™å¥—ç¯å¢ƒï¼Œæˆ‘æŠŠæˆ‘çš„è€å¤è‘£å¼€å‘ç¯å¢ƒå…¨éƒ½å‡çº§äº†ä¸€ä¸‹ã€‚)</p><blockquote><p><code>cursive</code>æ’ä»¶ä¸La Clojureã€ clojure-kitã€ Leiningenå†²çªï¼Œéœ€è¦IDEä¸º2018.x, 2019.x, 2020.1 and the 2020.2</p></blockquote><h2 id="æœ¬åœ°ç¼–è¯‘"><a href="#æœ¬åœ°ç¼–è¯‘" class="headerlink" title="æœ¬åœ°ç¼–è¯‘"></a>æœ¬åœ°ç¼–è¯‘</h2><p>1ã€å‡†å¤‡æºç <br>ä»githubä¸Šcloneæœ€æ–°çš„ä»£ç <code>git clone git@github.com:metabase/metabase.git</code><br>cloneä¸‹æ¥çš„ä»£ç é»˜è®¤ä¸Šmasteråˆ†æ”¯ï¼Œæˆ‘åˆ‡äº†ä¸‹åˆ†æ”¯ï¼Œåˆ‡åˆ°äº†æœ€æ–°çš„releaseç‰ˆæœ¬ï¼Œ<code>git checkout -b 1.41.2 v1.41.2</code></p><p>2ã€å¯¼å…¥IDE<br>é€‰æ‹©File -&gt; Open -&gt; åœ¨metabaseç›®å½•ä¸­é€‰æ‹©<code>deps.edn</code> -&gt; Open an Project<br>å‰©ä¸‹çš„å°±æ˜¯è‡ªåŠ¨åŠ è½½ä¾èµ–ã€‚</p><p>3ã€ç¼–è¯‘uberjar<br>åœ¨metabase_homeç›®å½•ä¸‹æ‰§è¡Œ<code>clojure -X:deps prep</code><br>æˆåŠŸä¹‹åæ‰§è¡Œ<code>cd modules/drivers &amp;&amp; clojure -X:deps prep</code></p><blockquote><p>ä»¥ä¸Šä¸¤ä¸ªå‘½ä»¤æ‰§è¡Œä¸€æ¬¡å°±è¡Œ</p></blockquote><p>å†æ¬¡åˆ°metabase_homeç›®å½•ä¸‹ï¼Œæ‰§è¡Œ<code>./bin/build</code>è¿›è¡Œç¼–è¯‘ï¼Œåœ¨<code>target/uberjar</code>ç›®å½•ä¸‹ä¼šå‡ºç°ä¸€ä¸ªjaråŒ…ï¼Œæœ€åæ‰§è¡Œ<code>java -jar metabase.jar</code>å³å¯å¯åŠ¨ã€‚</p><h2 id="æœ¬åœ°è°ƒè¯•"><a href="#æœ¬åœ°è°ƒè¯•" class="headerlink" title="æœ¬åœ°è°ƒè¯•"></a>æœ¬åœ°è°ƒè¯•</h2><p>åœ¨<code>deps.edn</code>ä¸­æ‰¾åˆ°ç¨‹åºçš„å…¥å£</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">:run</span><br><span class="line">&#123;:main-opts [&quot;-m&quot; &quot;metabase.core&quot;]</span><br><span class="line"> :jvm-opts  [&quot;-Dmb.run.mode=dev&quot;</span><br><span class="line">             &quot;-Djava.awt.headless=true&quot;                   ; prevent Java icon from randomly popping up in macOS dock</span><br><span class="line">             &quot;-Dmb.jetty.port=3000&quot;]&#125;</span><br></pre></td></tr></table></figure><p><code>main-opts</code>å°±æ˜¯ç¨‹åºçš„å…¥å£ï¼Œæ˜¯<code>metabase</code>åŒ…çš„<code>core</code>ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">;;; ------------------------------------------------ <span class="type">App</span> <span class="type">Entry</span> <span class="type">Point</span> -------------------------------------------------</span><br><span class="line"></span><br><span class="line">(defn -main</span><br><span class="line">  <span class="string">&quot;Launch Metabase in standalone mode.&quot;</span></span><br><span class="line">  [&amp; [cmd &amp; args]]</span><br><span class="line">  (maybe-enable-tracing)</span><br><span class="line">  (<span class="keyword">if</span> cmd</span><br><span class="line">    (run-cmd cmd args) ; run a command like `java -jar metabase.jar migrate release-locks` or `clojure -<span class="type">M</span>:run migrate release-locks`</span><br><span class="line">    (start-normally))) ; <span class="keyword">with</span> no command line args just start <span class="type">Metabase</span> normally</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åˆ°è¿™å°±å¯ä»¥è·Ÿè¯»è°ƒè¯•ä»£ç äº†ã€‚</p><h2 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h2><p>æ¥è§¦ä¸€ä¸ªæ–°äº‹ç‰©ï¼Œå…¶è¿‡ç¨‹æ²¡æœ‰ä¸€å¸†é£é¡ºçš„ï¼Œè¿™æ¬¡ä¹Ÿä¸ä¾‹å¤–ï¼Œè¿™é‡Œè®°å½•ä¸‹é‡åˆ°çš„é—®é¢˜åŠè§£å†³æ–¹æ¡ˆã€‚<br>1ã€<strong>æ–¹å‘æ€§é”™è¯¯</strong><br>åœ¨ç€æ‰‹æœ¬åœ°ç¼–è¯‘æ—¶åšäº†äº›è°ƒç ”å·¥ä½œï¼Œç½‘ä¸Šä¹Ÿæœ‰äº›ç›¸å…³æ•™ç¨‹ï¼Œä¸è¿‡è¿™äº›å¯¼å…¥IDEçš„æ•™ç¨‹éƒ½æ˜¯åŸºäº<code>Leiningen</code>çš„ï¼Œmetabaseä¹‹å‰æ˜¯åŸºäº<code>Leiningen</code>ï¼Œä½†æ˜¯åœ¨å‰æ®µæ—¶é—´ä»<code>Leiningen</code>åˆ‡åˆ°äº†<code>tools.deps</code>ï¼Œè¿™å°±å¯¼è‡´ç½‘ä¸Šæ‰€æœ‰çš„æ•™ç¨‹éƒ½è¿‡æ—¶äº†ã€‚å…·ä½“ä¿¡æ¯è§<a href="https://github.com/metabase/metabase/wiki/Migrating-from-Leiningen-to-tools.deps">å®˜æ–¹ä¿¡æ¯</a></p><p><code>Leiningen</code>å’Œ<code>tools.deps</code>çš„æ˜æ˜¾åŒºåˆ«æ˜¯ä»£ç ä¸­çš„<code>project.clj</code>æ–‡ä»¶å˜æˆäº†<code>deps.edn</code>æ–‡ä»¶(å½“åˆå‚»å‚»çš„ä»¥ä¸º<code>project.clj</code>ä¸­projectåªæ˜¯ä¸ªå˜é‡å‘¢ã€‚ã€‚ã€‚)</p><p>åæ¥æ„è¯†åˆ°<code>project.clj</code>å°±æ˜¯ä¸€ä¸ªæ–‡ä»¶æ—¶ï¼ŒæŸ¥çœ‹æºç çš„æäº¤è®°å½•å‘ç°äº†å…¶ä»<code>Leiningen</code>åˆ‡åˆ°äº†<code>tools.deps</code>ï¼Œæ‰€ä»¥IDEçš„æ’ä»¶éœ€è¦å˜ä¸º<code>cursive</code></p><p>2ã€ä½¿ç”¨Clojureæ—¶mavenæºæŠ¥UnknownHostException<br>å®‰è£…å®ŒClojureä¹‹åï¼ŒéªŒè¯æ˜¯å¦å¯ç”¨æ—¶ï¼Œåœ¨ç»ˆç«¯è¾“å…¥<code>clj</code>ï¼ŒæŠ¥<code>UnknownHostException: repo.maven.apache.org</code><br>ç¬¬ä¸€æ„Ÿè§‰å»ä¿®æ”¹æœ¬æœºçš„mavené…ç½®ï¼Œä¿®æ”¹ä¹‹åä¾ç„¶æŠ¥åŒæ ·çš„é”™ã€‚<br>å»Clojureçš„å®‰è£…ç›®å½•ä¸­å…³é”®å­—æ£€ç´¢<code>repo.maven.apache.org</code>ï¼Œå‘ç°åœ¨<code>deps.edn</code>ä¸­é…ç½®çš„ï¼Œæ”¹æˆå›½å†…çš„æºå³å¯ï¼Œå…·ä½“ä¿®æ”¹æ–¹å¼è§ä¸Šé¢çš„å®‰è£…æ­¥éª¤ã€‚</p><p>3ã€æœ¬åœ°ç¼–è¯‘æŠ¥<code>SSL_ERROR_SYSCALL in connection to github.com:443</code><br>æ˜¯å› ä¸ºgithubé€šè¿‡httpé“¾æ¥æ—¶éœ€è¦å®‰å…¨è®¤è¯ï¼Œæ‰€ä»¥æ‰§è¡Œ<code>git config --global http.sslVerify false</code>å…³é—­ï¼Œ(æœ‰æ—¶é—´å¥½ç”¨æœ‰æ—¶é—´ä¸å¥½ç”¨ï¼Œå¤šæ¬¡å‡ æ¬¡ï¼Œéšç¼˜å§)ã€‚</p><p>4ã€è¿è¡ŒjaråŒ…æŠ¥é”™ï¼Œé”™è¯¯å†…å®¹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2021-11-30 00:24:59,891 WARN servicelocator.DefaultPackageScanClassResolver :: Cannot search jar file &#x27;/Users/metabase/target/uberjar/metabase.jar&#x27; for classes due to an IOException: invalid code lengths set</span><br><span class="line">java.util.zip.ZipException: invalid code lengths set</span><br></pre></td></tr></table></figure><p>ç½‘ä¸Šå¹¶æ²¡æœ‰ä»€ä¹ˆè§£å†³æ–¹æ¡ˆï¼Œæƒ³åˆ°æˆ‘çš„ä»£ç æ‹‰çš„æ˜¯masteråˆ†æ”¯ï¼Œæ˜¯ä¸æ˜¯ä»£ç çš„é—®é¢˜ï¼Œäºæ˜¯åˆ‡åˆ°äº†æœ€æ–°çš„releaseç‰ˆæœ¬ï¼Œæ‰“åŒ…ä¹‹åä¾ç„¶æŠ¥é”™ã€‚<br>ä¸‹è½½äº†å®˜æ–¹releaseç‰ˆæœ¬çš„jaråŒ…ï¼Œåœ¨æœ¬åœ°æ­£å¸¸è¿è¡Œï¼Œæ’é™¤ä»£ç é—®é¢˜ï¼Œé‚£é—®é¢˜å°±å‡ºåœ¨ç¼–è¯‘ç¯å¢ƒä¸Šï¼Œæ­¤æ—¶æƒ³åˆ°<strong>æ–‡æ¡£ä¸Šè¦æ±‚jdkç‰ˆæœ¬ä¸º11</strong>ï¼Œå‡çº§jdkä¸º11ä¹‹åï¼Œå†æ¬¡æ‰“åŒ…è¿è¡ŒæˆåŠŸã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> metabase </tag>
            
            <tag> BI </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flink Connectorè°ƒç ”</title>
      <link href="/flink-connector-example.html"/>
      <url>/flink-connector-example.html</url>
      
        <content type="html"><![CDATA[<p>ä¸Šä¸€ç¯‡<a href="https://bigdatadecode.top/Flink-standlone-Flinkx.html">Flink standloneæ¨¡å¼ä¸‹Flinkxæµ‹è¯•</a>ä»‹ç»äº†ä½¿ç”¨FlinkxåŒæ­¥mysqlï¼Œä½†æ˜¯Flinkxåœ¨åŒæ­¥binlogæ—¥å¿—æ—¶ï¼Œä¸ªäººæ„Ÿè§‰æœ‰ç‚¹ä¸æ–¹ä¾¿ï¼Œæ‰€ä»¥å°±å¯¹æ¯”ä¸‹Flink Connectorã€‚</p><span id="more"></span><h2 id="Flink-standloneéƒ¨ç½²"><a href="#Flink-standloneéƒ¨ç½²" class="headerlink" title="Flink standloneéƒ¨ç½²"></a>Flink standloneéƒ¨ç½²</h2><p>éƒ¨ç½²æ¯”è¾ƒç®€å•ï¼Œå…·ä½“å¯ä»¥å‚è€ƒè¿™ç¯‡<a href="https://bigdatadecode.top/Flink-standlone-Flinkx.html">Flink standloneæ¨¡å¼ä¸‹Flinkxæµ‹è¯•</a></p><h2 id="å¯åŠ¨sql-client"><a href="#å¯åŠ¨sql-client" class="headerlink" title="å¯åŠ¨sql client"></a>å¯åŠ¨sql client</h2><p>ä¸»è¦æ˜¯ä¸ºäº†æµ‹è¯•ä¸‹sqlåŠŸèƒ½ï¼Œæ‰€ä»¥æˆ‘å°±ç®€å•é‡‡ç”¨äº†sql clientæ¨¡å¼ã€‚<br>åœ¨${Flink_HOME}ç›®å½•æ‰§è¡Œ<code>./bin/sql-client.sh embedded</code>å¯åŠ¨sql client</p><h2 id="mysqlå¼€å¯binlog"><a href="#mysqlå¼€å¯binlog" class="headerlink" title="mysqlå¼€å¯binlog"></a>mysqlå¼€å¯binlog</h2><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server_id=1  # ä¸åŒèŠ‚ç‚¹çš„server_idå¿…é¡»ä¸åŒ</span><br><span class="line">log_bin=/opt/data/mysql-data/mysql-bin  # binlogæ—¥å¿—ç›®å½•</span><br><span class="line">binlog_format=ROW   </span><br><span class="line">expire_logs_days=30</span><br></pre></td></tr></table></figure><p>é‡å¯mysqlæœåŠ¡ï¼Œæ‰§è¡Œ<code>show variables like &#39;%bin%&#39;;</code>æ£€æŸ¥æ˜¯å¦å·²ç»å¼€å¯æˆåŠŸã€‚</p><h2 id="Flink-sqlå®æ—¶åŒæ­¥mysql"><a href="#Flink-sqlå®æ—¶åŒæ­¥mysql" class="headerlink" title="Flink sqlå®æ—¶åŒæ­¥mysql"></a>Flink sqlå®æ—¶åŒæ­¥mysql</h2><p>åˆ›å»ºsourceè¡¨ï¼Œmysqlæ•°æ®æºè¡¨</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> source</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span>,</span><br><span class="line">    name        <span class="type">varchar</span>,</span><br><span class="line">    money       <span class="type">decimal</span>,</span><br><span class="line">    dateone     <span class="type">timestamp</span>,</span><br><span class="line">    age         <span class="type">bigint</span>,</span><br><span class="line">    datethree   <span class="type">timestamp</span>,</span><br><span class="line">    datesix     <span class="type">timestamp</span>,</span><br><span class="line">    phone       <span class="type">bigint</span>,</span><br><span class="line">    wechat      STRING,</span><br><span class="line">    income      <span class="type">decimal</span>,</span><br><span class="line">    birthday    <span class="type">timestamp</span>,</span><br><span class="line">    dtdate      <span class="type">date</span>,</span><br><span class="line">    dttime      <span class="type">time</span>,</span><br><span class="line">    today       <span class="type">date</span>,</span><br><span class="line">    timecurrent <span class="type">time</span>,</span><br><span class="line">    aboolean    <span class="type">boolean</span>,</span><br><span class="line">    adouble     <span class="keyword">double</span>,</span><br><span class="line">    afloat      <span class="type">float</span>,</span><br><span class="line">    achar       <span class="type">char</span>,</span><br><span class="line">    abinary     BYTES,</span><br><span class="line">    atinyint    tinyint</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">      <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;mysql-cdc&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;hostname&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;192.168.2.1&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;port&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;3306&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root@321&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;database-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;test&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;flink_type&#x27;</span></span><br><span class="line">      );</span><br></pre></td></tr></table></figure><p>åˆ›å»ºsinkè¡¨ï¼Œè¿™é‡Œä¸ºäº†é¡ºä¾¿æµ‹è¯•ä¸‹connectorè¿mysqlï¼Œæ‰€ä»¥sinkåˆ°mysqlä¸­ã€‚</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> mysql_sink</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span>,</span><br><span class="line">    name        <span class="type">varchar</span>,</span><br><span class="line">    money       <span class="type">decimal</span>,</span><br><span class="line">    dateone     <span class="type">timestamp</span>,</span><br><span class="line">    age         <span class="type">bigint</span>,</span><br><span class="line">    datethree   <span class="type">timestamp</span>,</span><br><span class="line">    datesix     <span class="type">timestamp</span>,</span><br><span class="line">    phone       <span class="type">bigint</span>,</span><br><span class="line">    wechat      STRING,</span><br><span class="line">    income      <span class="type">decimal</span>,</span><br><span class="line">    birthday    <span class="type">timestamp</span>,</span><br><span class="line">    dtdate      <span class="type">date</span>,</span><br><span class="line">    dttime      <span class="type">time</span>,</span><br><span class="line">    today       <span class="type">date</span>,</span><br><span class="line">    timecurrent <span class="type">time</span>,</span><br><span class="line">    aboolean    <span class="type">boolean</span>,</span><br><span class="line">    adouble     <span class="keyword">double</span>,</span><br><span class="line">    afloat      <span class="type">float</span>,</span><br><span class="line">    achar       <span class="type">char</span>,</span><br><span class="line">    abinary     BYTES,</span><br><span class="line">    atinyint    tinyint,</span><br><span class="line">    <span class="keyword">PRIMARY</span> KEY (id) <span class="keyword">NOT</span> ENFORCED <span class="comment">-- å¢é‡æ—¶ï¼Œå¿…é¡»æŒ‡å®šä¸»é”®</span></span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">      <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;driver&#x27;</span><span class="operator">=</span><span class="string">&#x27;com.mysql.jdbc.Driver&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;url&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc:mysql://192.168.2.1:3306/test?useUnicode=true&amp;characterEncoding=utf8&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;flink_type_cp&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root@321&#x27;</span></span><br><span class="line">      );</span><br></pre></td></tr></table></figure><p>é€šè¿‡sql insertåˆ°sinkè¡¨ä¸­ï¼Œ</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> mysql_sink</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> source u;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œå®Œè¿™ä¸ªè¯­å¥ä¹‹åï¼Œä»»åŠ¡ä¼šæäº¤åˆ°flinké›†ç¾¤ï¼Œåœ¨æºè¡¨ä¸­ä¿®æ”¹è¡¨å†…å®¹ä¹‹åï¼Œä¼šå®æ—¶åŒæ­¥åˆ°ç›®æ ‡è¡¨ä¸­ã€‚</p><p>å…·ä½“ä½¿ç”¨æ–¹å¼è¯·å‚è€ƒä»¥ä¸‹å†…å®¹<br><a href="https://ververica.github.io/flink-cdc-connectors/master/content/%E5%BF%AB%E9%80%9F%E4%B8%8A%E6%89%8B/mysql-postgres-tutorial-zh.html">Flink CDC</a><br><a href="https://ci.apache.org/projects/flink/flink-docs-master/zh/docs/connectors/table/jdbc/">Flink jdbc</a></p>]]></content>
      
      
      <categories>
          
          <category> Flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Flink </tag>
            
            <tag> Connector </tag>
            
            <tag> CDC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flink standloneæ¨¡å¼ä¸‹Flinkxæµ‹è¯•</title>
      <link href="/Flink-standlone-Flinkx.html"/>
      <url>/Flink-standlone-Flinkx.html</url>
      
        <content type="html"><![CDATA[<p>FlinkXæ˜¯ä¸€ä¸ªåŸºäºFlinkçš„æ‰¹æµç»Ÿä¸€çš„æ•°æ®åŒæ­¥å·¥å…·ï¼Œæ—¢å¯ä»¥é‡‡é›†é™æ€çš„æ•°æ®ï¼Œæ¯”å¦‚MySQLï¼ŒHDFSç­‰ï¼Œä¹Ÿå¯ä»¥é‡‡é›†å®æ—¶å˜åŒ–çš„æ•°æ®ï¼Œæ¯”å¦‚MySQL binlogï¼ŒKafkaç­‰ã€‚ åŒæ—¶ï¼ŒFlinkXä¹Ÿæ˜¯æ”¯æŒåŸç”ŸFlinkSqlæ‰€æœ‰è¯­æ³•å’Œç‰¹æ€§çš„è®¡ç®—æ¡†æ¶ï¼Œå…·ä½“ä½¿ç”¨æ–¹å¼å¯ä»¥å‚è€ƒ<a href="https://github.com/DTStack/flinkx">githubä¸Šçš„é¡¹ç›®ä»‹ç»</a></p><p>æœ¬ç¯‡è®°å½•ä¸‹åœ¨Flink standloneæ¨¡å¼ä¸‹ä½¿ç”¨FlinxåŒæ­¥mysqlæ•°æ®ã€‚</p><span id="more"></span><h2 id="Flinkéƒ¨ç½²standloneæ¨¡å¼"><a href="#Flinkéƒ¨ç½²standloneæ¨¡å¼" class="headerlink" title="Flinkéƒ¨ç½²standloneæ¨¡å¼"></a>Flinkéƒ¨ç½²standloneæ¨¡å¼</h2><p>ä¸‹è½½flink-1.12.2ç‰ˆæœ¬ï¼ˆå› ä¸ºflinkxä½¿ç”¨çš„æ˜¯1.12ç‰ˆæœ¬ï¼‰ï¼Œç®€å•é…ç½®ä¸‹å³å¯ã€‚ä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">vim masters</span><br><span class="line">127.0.0.1</span><br><span class="line"></span><br><span class="line">vim workers</span><br><span class="line">127.0.0.1</span><br><span class="line"></span><br><span class="line">vim flink-conf.yaml</span><br><span class="line">jobmanager.rpc.address: 127.0.0.1</span><br><span class="line">jobmanager.rpc.port: 6124 # 6123ç«¯å£å¯èƒ½ä¼šå†²çªï¼Œæ”¹æˆ6124</span><br><span class="line">jobmanager.memory.process.size: 5120m</span><br><span class="line">taskmanager.memory.process.size: 10240m</span><br><span class="line">taskmanager.numberOfTaskSlots: 2  </span><br><span class="line">parallelism.default: 1 </span><br><span class="line"></span><br><span class="line">bin/jobmanager.sh start</span><br><span class="line">bin/taskmanager.sh start # ä¹Ÿå¯ç›´æ¥æ‰§è¡Œbin/start-cluster.sh</span><br></pre></td></tr></table></figure><p>Flink standloneæ¨¡å¼éƒ¨ç½²æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œä¸‹é¢éƒ¨ç½²Flinkx</p><h2 id="ç¼–è¯‘Flinkx"><a href="#ç¼–è¯‘Flinkx" class="headerlink" title="ç¼–è¯‘Flinkx"></a>ç¼–è¯‘Flinkx</h2><p>ä»githubä¸Šä¸‹è½½äº†æœ€æ–°releaseç‰ˆæœ¬ï¼Œå‘ç°ç›®å½•ç»“æ„å’Œæ–‡æ¡£ä¸­çš„ä¸ä¸€æ ·ï¼Œæ‰€ä»¥å°±ä¸‹è½½äº†æºç è¿›è¡Œç¼–è¯‘ã€‚</p><p>ç”±äºflinkxæ”¯æŒçš„connectorè¾ƒå¤šï¼Œç¼–è¯‘æ—¶é—´è¾ƒé•¿ï¼Œè€Œä¸”æœ‰äº›jaråŒ…ä»“åº“ä¸­ä¹Ÿæ²¡æœ‰ï¼Œéœ€è¦ä¸€äº›é¢å¤–çš„æ“ä½œï¼Œæ‰€ä»¥æˆ‘æ³¨é‡Šäº†äº›connectorï¼Œå¯ä»¥åœ¨<code>flinkx/flinkx-connectors/pom.xml</code>æ–‡ä»¶ä¸­æ³¨é‡Šã€‚</p><p>ç¼–è¯‘å‘½ä»¤ä¸º</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mvn clean package -DskipTests </span><br></pre></td></tr></table></figure><p>ç¼–è¯‘ä¹‹åçš„ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">-rw-r--r--   1 test test    11K 10 21 11:26 LICENSE</span><br><span class="line">-rw-r--r--   1 test test   7.1K 10 21 11:26 README.md</span><br><span class="line">-rw-r--r--   1 test test   9.1K 10 21 11:26 README_CH.md</span><br><span class="line">drwxr-xr-x   5 test test   160B 11  3 13:02 bin</span><br><span class="line">drwxr-xr-x   3 test test    96B 10 21 14:36 build</span><br><span class="line">drwxr-xr-x   4 test test   128B 10 21 11:26 ci</span><br><span class="line">drwxr-xr-x  17 test test   544B 10 21 11:26 docs</span><br><span class="line">drwxr-xr-x   7 test test   224B 11  3 09:41 flinkx-clients</span><br><span class="line">drwxr-xr-x  41 test test   1.3K 10 22 16:25 flinkx-connectors</span><br><span class="line">drwxr-xr-x   7 test test   224B 11  3 09:39 flinkx-core</span><br><span class="line">drwxr-xr-x   6 test test   192B 10 22 16:10 flinkx-dirtydata-collectors</span><br><span class="line">drwxr-xr-x   6 test test   192B 11  3 09:40 flinkx-dist                    ## ç¼–è¯‘ä¹‹åçš„ç›®å½•</span><br><span class="line">drwxr-xr-x   6 test test   192B 11  3 09:41 flinkx-docker</span><br><span class="line">drwxr-xr-x   4 test test   128B 10 21 11:26 flinkx-examples</span><br><span class="line">drwxr-xr-x   4 test test   128B 10 22 16:10 flinkx-formats</span><br><span class="line">drwxr-xr-x   4 test test   128B 10 21 11:26 flinkx-local-test</span><br><span class="line">drwxr-xr-x   7 test test   224B 10 22 16:10 flinkx-metrics</span><br><span class="line">-rw-r--r--   1 test test   1.9K 10 22 16:10 flinkx-parent.iml</span><br><span class="line">drwxr-xr-x  12 test test   384B 10 21 11:26 jars</span><br><span class="line">drwxr-xr-x   3 test test    96B 10 22 16:31 lib</span><br><span class="line">-rw-r--r--   1 test test   627B 10 21 11:26 license.txt</span><br><span class="line">-rw-------   1 test test    98K 10 22 18:07 nohup.out</span><br><span class="line">-rw-r--r--   1 test test   6.7K 10 21 11:26 pom.xml</span><br></pre></td></tr></table></figure><h2 id="Flinkx-jsonæ¨¡å¼æ‰¹é‡åŒæ­¥mysqlè¡¨"><a href="#Flinkx-jsonæ¨¡å¼æ‰¹é‡åŒæ­¥mysqlè¡¨" class="headerlink" title="Flinkx jsonæ¨¡å¼æ‰¹é‡åŒæ­¥mysqlè¡¨"></a>Flinkx jsonæ¨¡å¼æ‰¹é‡åŒæ­¥mysqlè¡¨</h2><p>FlinkxåŒæ­¥mysqlè¡¨æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯jobï¼Œå¦ä¸€ç§æ˜¯sqlã€‚jobå½¢å¼éœ€è¦é…ç½®ä¸€ä¸ªjsonæ–‡ä»¶ï¼Œä¸»è¦æ˜¯éœ€è¦åŒæ­¥çš„åº“è¡¨ä¿¡æ¯ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;job&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;content&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;reader&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;mysqlreader&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;parameter&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;column&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;varchar&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;varchar&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;category&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;varchar&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;root@321&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;jdbcUrl&quot;</span>: [</span><br><span class="line">                  <span class="string">&quot;jdbc:mysql://192.168.0.1:3306/test?useSSL=false&quot;</span></span><br><span class="line">                ],</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: [</span><br><span class="line">                  <span class="string">&quot;t&quot;</span></span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">        <span class="attr">&quot;writer&quot;</span>: &#123;</span><br><span class="line">          <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;mysqlwriter&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;parameter&quot;</span>: &#123;</span><br><span class="line">            <span class="attr">&quot;username&quot;</span>: <span class="string">&quot;root&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;password&quot;</span>: <span class="string">&quot;root@321&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;connection&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;jdbcUrl&quot;</span>: <span class="string">&quot;jdbc:mysql://192.168.0.1:3306/test1?useSSL=false&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;table&quot;</span>: [</span><br><span class="line">                  <span class="string">&quot;t_1&quot;</span></span><br><span class="line">                ]</span><br><span class="line">              &#125;</span><br><span class="line">            ],</span><br><span class="line">            <span class="attr">&quot;writeMode&quot;</span>: <span class="string">&quot;insert&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;column&quot;</span>: [</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;id&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;varchar&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;name&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;varchar&quot;</span></span><br><span class="line">              &#125;,</span><br><span class="line">              &#123;</span><br><span class="line">                <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;category&quot;</span>,</span><br><span class="line">                <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;varchar&quot;</span></span><br><span class="line">              &#125;</span><br><span class="line">            ]</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    ],</span><br><span class="line">    <span class="attr">&quot;setting&quot;</span>: &#123;</span><br><span class="line">      <span class="attr">&quot;speed&quot;</span>: &#123;</span><br><span class="line">        <span class="attr">&quot;channel&quot;</span>: <span class="number">1</span>,</span><br><span class="line">        <span class="attr">&quot;bytes&quot;</span>: <span class="number">0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>åœ¨Flinxçš„homeç›®å½•ä¸­æ‰§è¡Œjobå¯åŠ¨å‘½ä»¤ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flinkx -mode standalone -jobType sync -job /$&#123;FLINKX_HOME&#125;/flinkx-examples/json/mysql/mysql_mysql_batch.json -flinkxDistDir flinkx-dist -flinkConfDir $FLINK_HOME/conf -confProp &quot;&#123;\&quot;flink.checkpoint.interval\&quot;:60000&#125;&quot;</span><br></pre></td></tr></table></figure><p>ä»»åŠ¡å¾ˆé¡ºåˆ©çš„æ‰§è¡Œç»“æŸï¼Œä¸‹é¢çœ‹ä½¿ç”¨sqlå¦‚ä½•åŒæ­¥mysqlè¡¨ã€‚</p><h2 id="Flinkx-sqlæ¨¡å¼åŒæ­¥mysqlè¡¨"><a href="#Flinkx-sqlæ¨¡å¼åŒæ­¥mysqlè¡¨" class="headerlink" title="Flinkx sqlæ¨¡å¼åŒæ­¥mysqlè¡¨"></a>Flinkx sqlæ¨¡å¼åŒæ­¥mysqlè¡¨</h2><p>åœ¨<code>flinkx-examples</code>ä¸‹é¢æœ‰å¾ˆå¤šä¾‹å­ï¼Œè¿™é‡Œæ‰§è¡Œä¸‹sqlå®æ—¶å¢é‡åŒæ­¥mysqlï¼Œsqlä¸ºï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> source</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span>,</span><br><span class="line">    name        <span class="type">varchar</span>,</span><br><span class="line">    money       <span class="type">decimal</span>,</span><br><span class="line">    dateone     <span class="type">timestamp</span>,</span><br><span class="line">    age         <span class="type">bigint</span>,</span><br><span class="line">    datethree   <span class="type">timestamp</span>,</span><br><span class="line">    datesix     <span class="type">timestamp</span>,</span><br><span class="line">    phone       <span class="type">bigint</span>,</span><br><span class="line">    wechat      STRING,</span><br><span class="line">    income      <span class="type">decimal</span>,</span><br><span class="line">    birthday    <span class="type">timestamp</span>,</span><br><span class="line">    dtdate      <span class="type">date</span>,</span><br><span class="line">    dttime      <span class="type">time</span>,</span><br><span class="line">    today       <span class="type">date</span>,</span><br><span class="line">    timecurrent <span class="type">time</span>,</span><br><span class="line">    aboolean    <span class="type">boolean</span>,</span><br><span class="line">    adouble     <span class="keyword">double</span>,</span><br><span class="line">    afloat      <span class="type">float</span>,</span><br><span class="line">    achar       <span class="type">char</span>,</span><br><span class="line">    abinary     BYTES,</span><br><span class="line">    atinyint    tinyint</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">      <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;mysql-x&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;url&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc:mysql://192.168.0.1:3306/test&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;table-name&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;flink_type&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span>,</span><br><span class="line">      <span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;Shujupingtai@321&#x27;</span></span><br><span class="line"></span><br><span class="line">      ,<span class="string">&#x27;scan.polling-interval&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;3000&#x27;</span> <span class="comment">--é—´éš”è½®è®­æ—¶é—´ã€‚éå¿…å¡«(ä¸å¡«ä¸ºç¦»çº¿ä»»åŠ¡)ï¼Œæ— é»˜è®¤</span></span><br><span class="line"></span><br><span class="line">      ,<span class="string">&#x27;scan.parallelism&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;1&#x27;</span> <span class="comment">-- å¹¶è¡Œåº¦</span></span><br><span class="line">      ,<span class="string">&#x27;scan.fetch-size&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;2&#x27;</span> <span class="comment">-- æ¯æ¬¡ä»æ•°æ®åº“ä¸­fetchå¤§å°ã€‚é»˜è®¤ï¼š1024æ¡</span></span><br><span class="line">      ,<span class="string">&#x27;scan.query-timeout&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;10&#x27;</span> <span class="comment">-- æ•°æ®åº“è¿æ¥è¶…æ—¶æ—¶é—´ã€‚é»˜è®¤ï¼šä¸è¶…æ—¶</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">-- ,&#x27;scan.partition.column&#x27; = &#x27;id&#x27; -- å¤šå¹¶è¡Œåº¦è¯»å–çš„åˆ‡åˆ†å­—æ®µï¼Œå¿…é¡»æ˜¯è¡¨ä¸­å­—æ®µã€‚æ— é»˜è®¤</span></span><br><span class="line">      <span class="comment">-- ,&#x27;scan.partition.strategy&#x27; = &#x27;range&#x27; -- æ•°æ®åˆ†ç‰‡ç­–ç•¥ã€‚é»˜è®¤ï¼šrangeï¼Œå¦‚æœå¹¶è¡Œåº¦å¤§äº1ï¼Œä¸”æ˜¯å¢é‡ä»»åŠ¡æˆ–è€…é—´éš”è½®è¯¢ï¼Œåˆ™ä¼šä½¿ç”¨modåˆ†ç‰‡</span></span><br><span class="line"></span><br><span class="line">      ,<span class="string">&#x27;scan.increment.column&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;id&#x27;</span> <span class="comment">-- å¢é‡å­—æ®µåç§°ï¼Œå¿…é¡»æ˜¯è¡¨ä¸­çš„å­—æ®µã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤</span></span><br><span class="line">      ,<span class="string">&#x27;scan.increment.column-type&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;int&#x27;</span>  <span class="comment">-- å¢é‡å­—æ®µç±»å‹ã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤</span></span><br><span class="line">      ,<span class="string">&#x27;scan.start-location&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;10&#x27;</span> <span class="comment">-- å¢é‡å­—æ®µå¼€å§‹ä½ç½®,å¦‚æœä¸æŒ‡å®šåˆ™å…ˆåŒæ­¥æ‰€æœ‰ï¼Œç„¶ååœ¨å¢é‡ã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤ã€‚å¦‚æœæ²¡é…ç½®scan.increment.columnï¼Œåˆ™ä¸ç”Ÿæ•ˆ</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--       ,&#x27;scan.restore.columnname&#x27; = &#x27;id&#x27; -- å¼€å¯äº†cpï¼Œä»»åŠ¡ä»sp/cpç»­è·‘å­—æ®µåç§°ã€‚å¦‚æœç»­è·‘ï¼Œåˆ™ä¼šè¦†ç›–scan.start-locationå¼€å§‹ä½ç½®ï¼Œä»ç»­è·‘ç‚¹å¼€å§‹ã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤</span></span><br><span class="line"><span class="comment">--       ,&#x27;scan.restore.columntype&#x27; = &#x27;int&#x27; -- å¼€å¯äº†cpï¼Œä»»åŠ¡ä»sp/cpç»­è·‘å­—æ®µç±»å‹ã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sink</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span>,</span><br><span class="line">    name        <span class="type">varchar</span>,</span><br><span class="line">    money       <span class="type">decimal</span>,</span><br><span class="line">    dateone     <span class="type">timestamp</span>,</span><br><span class="line">    age         <span class="type">bigint</span>,</span><br><span class="line">    datethree   <span class="type">timestamp</span>,</span><br><span class="line">    datesix     <span class="type">timestamp</span>,</span><br><span class="line">    phone       <span class="type">bigint</span>,</span><br><span class="line">    wechat      STRING,</span><br><span class="line">    income      <span class="type">decimal</span>,</span><br><span class="line">    birthday    <span class="type">timestamp</span>,</span><br><span class="line">    dtdate      <span class="type">date</span>,</span><br><span class="line">    dttime      <span class="type">time</span>,</span><br><span class="line">    today       <span class="type">date</span>,</span><br><span class="line">    timecurrent <span class="type">time</span>,</span><br><span class="line">    aboolean    <span class="type">boolean</span>,</span><br><span class="line">    adouble     <span class="keyword">double</span>,</span><br><span class="line">    afloat      <span class="type">float</span>,</span><br><span class="line">    achar       <span class="type">char</span>,</span><br><span class="line">    abinary     BYTES,</span><br><span class="line">    atinyint    tinyint</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">      <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;stream-x&#x27;</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> sink</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> source;</span><br></pre></td></tr></table></figure><p>åœ¨Flinxçš„homeç›®å½•ä¸­æ‰§è¡Œsqlæ‰§è¡Œå‘½ä»¤ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/finkx -mode standalone -jobType sql -job /$&#123;FLINKX_HOME&#125;/flinkx-examples/sql/mysql/mysql_source_realtime.sql -flinkxDistDir flinkx-dist -flinkConfDir /Users/hunhun/dev/flink/conf -confProp &quot;&#123;\&quot;flink.checkpoint.interval\&quot;:60000&#125;&quot;</span><br></pre></td></tr></table></figure><p>æäº¤ä¹‹åï¼Œæç¤ºjobå¤±è´¥ï¼ŒæŠ¥é”™ä¿¡æ¯ä¸ºæ‰¾ä¸åˆ°ç±»ï¼Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassNotFoundExceptionï¼šcom.dtstack.flinkx.metrics.prometheus.PrometheusReport</span><br></pre></td></tr></table></figure><p>å°†<code>flinkx-dist/metrics/prometheus</code>ç›®å½•ä¸‹çš„<code>flinkx-metrics-prometheus-master.jar</code>æ”¾åˆ°flinkçš„libç›®å½•ä¸‹ï¼Œé‡å¯flinké›†ç¾¤ï¼Œå†æ¬¡æäº¤åˆæç¤º<code>com.dtstack.flinkx.conf.MetricParam</code>ç±»æ‰¾ä¸åˆ°ï¼Œå°†<code>flinkx-core-master.jar</code>åŒ…æ”¾åˆ°flinkçš„libä¸‹ï¼Œé‡å¯ä¹‹åä¾ç„¶æŠ¥æ‰¾ä¸åˆ°ç±»ï¼Œåº”è¯¥æ˜¯ç±»åŠ è½½å†²çªäº†ã€‚</p><p>å†çœ‹æŠ¥é”™ä¿¡æ¯æ˜¯å°†<code>metrics</code>ä¸ŠæŠ¥åˆ°<code>prometheus</code>æ—¶ï¼Œæ‰¾ä¸åˆ°ç›¸å…³çš„ç±»ï¼Œé‚£ç¦æ­¢ä¸ŠæŠ¥å°±å¯ä»¥äº†ï¼Œè€Œä¸”æˆ‘ä¹Ÿæ²¡æœ‰é…ç½®ç›¸å…³çš„ä¿¡æ¯ï¼Œéš¾é“æ˜¯é»˜è®¤é…ç½®çš„ï¼Ÿè€Œä¸”jsonæ¨¡å¼ä¸‹å¹¶æ²¡æœ‰è§¦å‘è¿™ä¸ªé”™è¯¯ã€‚</p><p>äºæ˜¯å¯¹æ¯”ä¸‹sqlå’Œjsonè¿™ä¸¤ä¸ªä»»åŠ¡çš„åŒºåˆ«(<em>ä¸ºä»€ä¹ˆå¯¹æ¯”å‘¢ï¼Ÿæ˜¯å› ä¸ºæˆ‘æ²¡æœ‰æ‰¾åˆ°ç¦æ­¢metricsä¸ŠæŠ¥åˆ°prometheusçš„é…ç½®ã€‚ã€‚ã€‚</em>)ï¼Œå‘ç°sqlæ˜¯å¢é‡æ‹‰å–è¡¨ï¼Œäºæ˜¯å°†sqlä¸­çš„å¢é‡æ‹‰å–é…ç½®æ³¨é‡Šæ‰ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">--       ,&#x27;scan.polling-interval&#x27; = &#x27;3000&#x27; --é—´éš”è½®è®­æ—¶é—´ã€‚éå¿…å¡«(ä¸å¡«ä¸ºç¦»çº¿ä»»åŠ¡)ï¼Œæ— é»˜è®¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment">--       ,&#x27;scan.increment.column&#x27; = &#x27;id&#x27; -- å¢é‡å­—æ®µåç§°ï¼Œå¿…é¡»æ˜¯è¡¨ä¸­çš„å­—æ®µã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤</span></span><br><span class="line"><span class="comment">--       ,&#x27;scan.increment.column-type&#x27; = &#x27;int&#x27;  -- å¢é‡å­—æ®µç±»å‹ã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤</span></span><br><span class="line"><span class="comment">--       ,&#x27;scan.start-location&#x27; = &#x27;10&#x27; -- å¢é‡å­—æ®µå¼€å§‹ä½ç½®,å¦‚æœä¸æŒ‡å®šåˆ™å…ˆåŒæ­¥æ‰€æœ‰ï¼Œç„¶ååœ¨å¢é‡ã€‚éå¿…å¡«ï¼Œæ— é»˜è®¤ã€‚å¦‚æœæ²¡é…ç½®scan.increment.columnï¼Œåˆ™ä¸ç”Ÿæ•ˆ</span></span><br></pre></td></tr></table></figure><p>æ³¨é‡Šæ‰å†æ¬¡æäº¤ï¼Œä»»åŠ¡è¿è¡ŒæˆåŠŸäº†ã€‚</p><p>ç”±æ­¤æ¨æ–­å¹¶ä¸æ˜¯sqlé»˜è®¤ä¼šä¸ŠæŠ¥prometheusï¼Œè€Œæ˜¯å¢é‡æ‹‰å–æ—¶è§¦å‘äº†ä¸ŠæŠ¥çš„é€»è¾‘ï¼Œé‚£æ¥ä¸‹æ¥è·Ÿä¸‹ä»£ç ï¼Œçœ‹ä¸‹å…·ä½“é€»è¾‘æ˜¯ä»€ä¹ˆï¼Œæ˜¯å¦å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„é…ç½®é¡¹è¿›è¡Œè°ƒæ•´ã€‚</p><p>ä»é”™è¯¯æ—¥å¿—ä¸­å®šä½<code>BaseRichInputFormat</code>ç±»çš„<code>175</code>è¡Œé™„è¿‘ï¼Œçœ‹åˆ°å½“<code>useCustomReporter</code>ä¸ºtrueæ—¶ï¼Œä¼šè‡ªå®šä¹‰metricsä¸ŠæŠ¥é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (useCustomReporter()) &#123;</span><br><span class="line">    customReporter =</span><br><span class="line">            DataSyncFactoryUtil.discoverMetric(</span><br><span class="line">                    config, getRuntimeContext(), makeTaskFailedWhenReportFailed());</span><br><span class="line">    customReporter.open();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½†æ˜¯åœ¨<code>BaseRichInputFormat</code>ç±»ä¸­ï¼Œ<code>useCustomReporter</code>ä¸ºfalseï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** BaseRichInputFormat.class */</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">useCustomReporter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨è¿”å›trueï¼Œåº”è¯¥æ˜¯åœ¨å…¶å­ç±»ä¸­è¢«é‡å†™äº†ï¼Œå®šä½<code>JdbcInputFormat</code>å­ç±»ï¼Œå‘ç°<code>useCustomReporter</code>çš„å€¼ä¸<code>jdbcConf.isIncrement()</code>ç»‘å®šåœ¨ä¸€èµ·äº†ï¼Œå½“jobæ˜¯å¢é‡ä»»åŠ¡æ—¶ï¼Œåˆ™<code>useCustomReporter</code>ä¸ºtrueï¼Œè¿™ä¹Ÿè§£é‡Šäº†ä¸ºä»€ä¹ˆsqlçš„å¢é‡ä»»åŠ¡æŠ¥é”™ï¼Œè€Œæ‰¹é‡ä»»åŠ¡ä¸æŠ¥é”™ã€‚å…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">useCustomReporter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> jdbcConf.isIncrement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆæœ‰è¿™ä¸ªé€»è¾‘ï¼Œä¸å¤ªå¥½æ£æ‘©å…¶ç”¨é€”ï¼Œä¸è¿‡å°†å…¶æ”¹æˆfalseï¼Œä¸ä¼šå½±å“ä¸»æµç¨‹ï¼Œé‚å°†å…¶ä¿®æ”¹æˆå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">boolean</span> <span class="title">useCustomReporter</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="comment">//    return jdbcConf.isIncrement();</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆåˆ«ç€æ€¥ç¼–è¯‘æ‰“åŒ…è¿è¡Œï¼Œè¿˜æœ‰ä¸€å¤„éœ€è¦ä¿®æ”¹ï¼Œåœ¨<code>initMetric</code>æ–¹æ³•ä¸­çš„<code>customReporter</code>å¤„å¢åŠ åˆ¤æ–­é€»è¾‘ï¼Œå½“<code>customReporter</code>ä¸º<code>true</code>æ—¶ï¼Œè¿›è¡Œè®¾ç½®ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initMetric</span><span class="params">(InputSplit inputSplit)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!jdbcConf.isIncrement()) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å¢åŠ customReporterç›¸å…³çš„åˆ¤æ–­ï¼Œ</span></span><br><span class="line">    <span class="keyword">if</span> (useCustomReporter()) &#123;</span><br><span class="line">        customReporter.registerMetric(startLocationAccumulator, Metrics.START_LOCATION);</span><br><span class="line">        customReporter.registerMetric(endLocationAccumulator, Metrics.END_LOCATION);</span><br><span class="line">    &#125;</span><br><span class="line">    getRuntimeContext().addAccumulator(start, startLocationAccumulator);</span><br><span class="line">    getRuntimeContext().addAccumulator(end, endLocationAccumulator);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ¬¡å¯ä»¥æ‰“åŒ…ï¼Œæäº¤sqlä»»åŠ¡äº†ã€‚</p><h2 id="Flinkx-sqlæ¨¡å¼binlogåŒæ­¥mysqlè¡¨"><a href="#Flinkx-sqlæ¨¡å¼binlogåŒæ­¥mysqlè¡¨" class="headerlink" title="Flinkx sqlæ¨¡å¼binlogåŒæ­¥mysqlè¡¨"></a>Flinkx sqlæ¨¡å¼binlogåŒæ­¥mysqlè¡¨</h2><p>ä¸Šé¢çš„sqlå¢é‡åŒæ­¥mysqlè¡¨ï¼Œä»ä»»åŠ¡é…ç½®ä¸Šå¯ä»¥æ¨æ–­å…¶å¢é‡åŒæ­¥çš„é€»è¾‘æ˜¯å‘¨æœŸæ€§çš„æ‰§è¡Œsqlï¼Œé€šè¿‡æŸä¸ªå­—æ®µæ¥åˆ¤æ–­å“ªäº›æ˜¯å¢é‡æ•°æ®ï¼Œè¿™ç§æ¨¡å¼æœ‰ä¸ªæ˜æ˜¾çš„ç¼ºç‚¹å°±æ˜¯æ•°æ®çš„æ›´æ–°ä¸å¤Ÿå®æ—¶ã€‚<br>æˆ‘ä»¬å¯ä»¥é€šè¿‡è®¢é˜…mysqlçš„binlogæ–¹å¼(<strong>å‰ææ˜¯mysqlå¼€å¯binlogé…ç½®</strong>)ï¼Œå®æ—¶åŒæ­¥è¡¨çš„å˜åŒ–ã€‚å…¶ä»»åŠ¡é…ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> source</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span>,</span><br><span class="line">    name        <span class="type">varchar</span>,</span><br><span class="line">    money       <span class="type">decimal</span>,</span><br><span class="line">    dateone     <span class="type">timestamp</span>,</span><br><span class="line">    age         <span class="type">bigint</span>,</span><br><span class="line">    datethree   <span class="type">timestamp</span>,</span><br><span class="line">    datesix     <span class="type">timestamp</span>,</span><br><span class="line">    phone       <span class="type">bigint</span>,</span><br><span class="line">    wechat      STRING,</span><br><span class="line">    income      <span class="type">decimal</span>,</span><br><span class="line">    birthday    <span class="type">timestamp</span>,</span><br><span class="line">    dtdate      <span class="type">date</span>,</span><br><span class="line">    dttime      <span class="type">time</span>,</span><br><span class="line">    today       <span class="type">date</span>,</span><br><span class="line">    timecurrent <span class="type">time</span>,</span><br><span class="line">    aboolean    <span class="type">boolean</span>,</span><br><span class="line">    adouble     <span class="keyword">double</span>,</span><br><span class="line">    afloat      <span class="type">float</span>,</span><br><span class="line">    achar       <span class="type">char</span>,</span><br><span class="line">    abinary     BYTES,</span><br><span class="line">    atinyint    tinyint</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">      <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;binlog-x&#x27;</span></span><br><span class="line">      ,<span class="string">&#x27;username&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span></span><br><span class="line">      ,<span class="string">&#x27;password&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;root&#x27;</span></span><br><span class="line">      ,<span class="string">&#x27;cat&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;insert,delete,update&#x27;</span></span><br><span class="line">      ,<span class="string">&#x27;url&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;jdbc:mysql://localhost:3306/tudou?useSSL=false&#x27;</span></span><br><span class="line">      ,<span class="string">&#x27;host&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;localhost&#x27;</span>  <span class="comment">--  canal åœ°å€</span></span><br><span class="line">      ,<span class="string">&#x27;port&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;3306&#x27;</span></span><br><span class="line"><span class="comment">--   ,&#x27;journal-name&#x27; = &#x27;mysql-bin.000001&#x27;</span></span><br><span class="line">      ,<span class="string">&#x27;table&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;tudou.type&#x27;</span></span><br><span class="line">      ,<span class="string">&#x27;timestamp-format.standard&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;SQL&#x27;</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> sink</span><br><span class="line">(</span><br><span class="line">    id          <span class="type">int</span>,</span><br><span class="line">    name        <span class="type">varchar</span>,</span><br><span class="line">    money       <span class="type">decimal</span>,</span><br><span class="line">    dateone     <span class="type">timestamp</span>,</span><br><span class="line">    age         <span class="type">bigint</span>,</span><br><span class="line">    datethree   <span class="type">timestamp</span>,</span><br><span class="line">    datesix     <span class="type">timestamp</span>,</span><br><span class="line">    phone       <span class="type">bigint</span>,</span><br><span class="line">    wechat      STRING,</span><br><span class="line">    income      <span class="type">decimal</span>,</span><br><span class="line">    birthday    <span class="type">timestamp</span>,</span><br><span class="line">    dtdate      <span class="type">date</span>,</span><br><span class="line">    dttime      <span class="type">time</span>,</span><br><span class="line">    today       <span class="type">date</span>,</span><br><span class="line">    timecurrent <span class="type">time</span>,</span><br><span class="line">    aboolean    <span class="type">boolean</span>,</span><br><span class="line">    adouble     <span class="keyword">double</span>,</span><br><span class="line">    afloat      <span class="type">float</span>,</span><br><span class="line">    achar       <span class="type">char</span>,</span><br><span class="line">    abinary     BYTES,</span><br><span class="line">    atinyint    tinyint</span><br><span class="line">) <span class="keyword">WITH</span> (</span><br><span class="line">      <span class="string">&#x27;connector&#x27;</span> <span class="operator">=</span> <span class="string">&#x27;print&#x27;</span></span><br><span class="line">      );</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> sink</span><br><span class="line"><span class="keyword">select</span> <span class="operator">*</span></span><br><span class="line"><span class="keyword">from</span> source u;</span><br></pre></td></tr></table></figure><p>flinkxçš„binlogåŒæ­¥éœ€è¦ç»“åˆcanalï¼Œè¿™ç§æ–¹å¼ä¸ªäººæ„Ÿè§‰ä¸å¤ªæ–¹ä¾¿ï¼Œç»„ä»¶è¾ƒå¤šï¼Œè€Œä¸”æ‰©å±•æ€§ä¹Ÿè¾ƒå·®ï¼Œæ²¡å†è¿›è¡Œå°è¯•ï¼Œè€Œæ‰“ç®—ä½¿ç”¨<code>Flink CDC</code>åŠŸèƒ½è¿›è¡Œæµ‹è¯•ï¼Œéšåä¼šæœ‰ä¸€ç¯‡æ–‡ç« è¿›è¡Œä»‹ç»ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æµ‹è¯•ä½¿ç”¨äº†flinkxçš„jsonæ¨¡å¼å’Œsqlæ¨¡å¼å¯¹mysqlè¡¨è¿›è¡Œæ‰¹é‡å’Œå¢é‡åŒæ­¥ï¼Œflinkxè¿˜æ”¯æŒå¾ˆå¤šsourceï¼ŒåŠŸèƒ½æ¯”è¾ƒä¸°å¯Œï¼Œè€Œä¸”æ‰¹é‡åŒæ­¥ä¸ç®¡æ˜¯jsonæ¨¡å¼è¿˜æ˜¯sqlæ¨¡å¼é…ç½®éƒ½æ¯”è¾ƒæ–¹ä¾¿è€Œä¸”ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯å¦‚æœæƒ³è¦é€šè¿‡binlogåŒæ­¥mysqlçš„è¯ï¼Œå°±æ¯”è¾ƒéº»çƒ¦äº†ï¼Œéœ€è¦é…åˆcanalï¼Œä¸ªäººæ„Ÿè§‰ä¸å¤ªæ–¹ä¾¿ã€‚</p><p>å¦‚æœå¯¹æ•°æ®çš„å®æ—¶æ€§è¦æ±‚ä¸é«˜çš„è¯ï¼Œflinkxå¯ä»¥å¼€ç®±å³ç”¨ï¼Œè¿˜æ˜¯ä¸é”™çš„é€‰æ‹©ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Flink </tag>
            
            <tag> Flinkx </tag>
            
            <tag> Connector </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>openGaussæç®€ç‰ˆå®‰è£…ä½¿ç”¨</title>
      <link href="/openGauss-deploy.html"/>
      <url>/openGauss-deploy.html</url>
      
        <content type="html"><![CDATA[<p>openGaussæ˜¯GaussDBçš„å¼€æºç‰ˆï¼Œä»<a href="https://opengauss.org/zh/download.html">å®˜ç½‘</a>ä¸‹è½½å³å¯ã€‚</p><p>è¿™é‡Œåªæ˜¯ä¸ºäº†æµ‹è¯•ä¸€äº›åŸºæœ¬åŠŸèƒ½ï¼Œæ‰€ä»¥åªä¸‹è½½äº†æç®€ç‰ˆã€‚ä¸‹é¢è®°å½•ä¸‹å®‰è£…æ­¥éª¤å’Œé‡åˆ°çš„é—®é¢˜ã€‚</p><span id="more"></span><h2 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h2><p>GaussDBå®‰è£…ä¸èƒ½ç”¨rootç”¨æˆ·ï¼Œå…ˆæ–°å»ºä¸€ä¸ªä¸“ç”¨ç”¨æˆ·<code>gaussdb</code>ï¼Œæ‰§è¡Œå‘½ä»¤<code>groupadd gaussdb &amp;&amp; useradd -d /home/gaussdb -m gaussdb -g gaussdb</code><br>è§£å‹å®‰è£…åŒ…ï¼Œæ‰§è¡Œå‘½ä»¤<code>tar -jxvf openGauss-2.0.0-CentOS-64bit.tar.bz2 -C gaussdb-2.0.0</code><br>ç„¶åè¿›å…¥<code>simpleInstall</code>ç›®å½•ï¼Œæ‰§è¡Œ<code>sh install.sh -w xx</code>å‘½ä»¤è¿›è¡Œå®‰è£…ã€‚</p><p>å¦‚æœä¸Šè¿°æµç¨‹æ­£å¸¸ï¼Œåˆ™GaussDBå®‰è£…åˆæ­¥å®Œæˆã€‚ä½†æ˜¯æˆ‘æ²¡æœ‰è¿™ä¹ˆé¡ºåˆ©ï¼Œé‡åˆ°äº›é—®é¢˜ã€‚</p><h3 id="é—®é¢˜1"><a href="#é—®é¢˜1" class="headerlink" title="é—®é¢˜1"></a>é—®é¢˜1</h3><p>æ‰§è¡Œ<code>install.sh</code>å‘½ä»¤æ—¶ï¼ŒæŠ¥é”™<code>SEMMNI</code>å‚æ•°è®¾ç½®ä¸å¯¹ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š<br><code>On systemwide basis, the maximum number of SEMMNI is not correct. the current SEMMNI value is: 128. Please check it.</code></p><blockquote><p>è§£å†³<br>SEMMNIæ˜¯åœ¨<code>/proc/sys/kernel/sem</code>æ–‡ä»¶ä¸­é…ç½®çš„ï¼Œä¿®æ”¹ä¸‹å°±å¥½äº†ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¿®æ”¹æ–¹å¼ä¸èƒ½ç›´æ¥vimï¼Œéœ€è¦ç”¨echoå‘½ä»¤å†™å…¥ï¼Œå¦åˆ™ä¼šå†™å…¥ä¸æˆåŠŸã€‚<br>æ‰§è¡Œå‘½ä»¤<code>echo 250    32000    32    2048 &gt; /proc/sys/kernel/sem</code></p></blockquote><p>å®‰è£…æˆåŠŸä¹‹åï¼Œéœ€è¦å…ˆéªŒè¯ä¸‹èƒ½å¦æ­£å¸¸ä½¿ç”¨ï¼Œæ¯”è¾ƒå®‰è£…ä¸æŠ¥é”™å’Œèƒ½æ­£å¸¸ä½¿ç”¨æ˜¯ä¸¤å›äº‹ã€‚</p><p>æ‰§è¡Œ<code>gsql -d postgres -p 5432</code>ï¼Œå…¶ä¸­ç«¯å£<code>5432</code>æ˜¯é»˜è®¤ç«¯å£ï¼Œå…·ä½“ç«¯å£ä¿¡æ¯å¯ä»¥åœ¨<code>$&#123;GAUSSDB_HOME&#125;/data/single_node/postgresql.conf</code>ä¸­æŸ¥çœ‹ã€‚</p><p>åˆæŠ¥é”™äº†ã€‚ã€‚</p><h3 id="é—®é¢˜2"><a href="#é—®é¢˜2" class="headerlink" title="é—®é¢˜2"></a>é—®é¢˜2</h3><p>æ˜¯opensslçš„é—®é¢˜ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š<br><code>openssl: error while loading shared libraries: libssl.so.1.1: cannot open shared object file: No such file or directory</code></p><blockquote><p>è§£å†³<br>æ‰§è¡Œ<code>openssl version</code>æŸ¥çœ‹å½“å‰opensslçš„ç‰ˆæœ¬ï¼Œæˆ‘çš„ç‰ˆæœ¬æ˜¯1.0.2ï¼Œéœ€è¦å…ˆå°†opensslå‡çº§åˆ°1.1ï¼Œå¦‚æœè¿˜æŠ¥ä¸Šé¢çš„é”™ï¼Œåœ¨æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š</p></blockquote><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s /usr/local/lib64/libssl.so.1.1 /usr/lib64/libssl.so.1.1</span><br><span class="line">ln -s /usr/local/lib64/libcrypto.so.1.1 /usr/lib64/libcrypto.so.1.1</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé—®é¢˜è§£å†³å®Œå°±å¯ä»¥æ­£å¸¸ä½¿ç”¨äº†ï¼Œä¸€äº›å¸¸ç”¨å‘½ä»¤æœ‰<code>\c</code>åˆ‡æ¢æ•°æ®åº“ï¼Œ<code>\l</code>æŸ¥çœ‹æ•°æ®åº“ã€<code>\dt</code>æŸ¥çœ‹è¡¨ã€<code>\d tablename</code>æŸ¥çœ‹è¡¨ç»“æ„ã€‚</p><h2 id="è¿œç¨‹è¿æ¥"><a href="#è¿œç¨‹è¿æ¥" class="headerlink" title="è¿œç¨‹è¿æ¥"></a>è¿œç¨‹è¿æ¥</h2><p>ç®¡ç†å‘˜å¸å·æ— æ³•è¿›è¡Œè¿œç¨‹è¿æ¥ï¼Œæ–°å»ºä¸ªç”¨æˆ·ç”¨äºæµ‹è¯•è¿œç¨‹è¿æ¥åŠŸèƒ½ï¼Œæ–°å»ºç”¨æˆ·å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER test PASSWORD &#x27;Test@123&#x27;;</span><br><span class="line"><span class="meta">#</span><span class="bash"> å°† schoolåº“èµ‹æƒç»™<span class="built_in">test</span>ç”¨æˆ·</span></span><br><span class="line">GRANT ALL PRIVILEGES ON DATABASE school to test;</span><br><span class="line"><span class="meta">#</span><span class="bash"> æ›´æ”¹<span class="built_in">test</span>è§’è‰²</span></span><br><span class="line">ALTER ROLE test CREATEDB;</span><br><span class="line"><span class="meta">#</span><span class="bash"> èµ‹äºˆç”¨æˆ·æƒé™</span></span><br><span class="line">GRANT ALL PRIVILEGES To test;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–°å»ºçš„ç”¨æˆ·è¿æ¥æµ‹è¯•ï¼Œæ‰§è¡Œå‘½ä»¤<code>gsql -h xx.xx.xx.xx -d school -U test -p 5432 -r</code><br>æŠ¥é”™æ— æ³•è¿æ¥ï¼ŒæŠ¥æƒé™é”™è¯¯ï¼Œæ‰§è¡Œå‘½ä»¤<code>gs_guc set -N all -I all -h &quot;host all test 192.168.xx.xx/32 sha256&quot;</code>ï¼Œæ‚²å‚¬çš„æ˜¯åˆæŠ¥é”™äº†ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">realpath(/home/gaussdb/gaussdb-2.0.0/bin/cluster_static_config) failed : æ²¡æœ‰é‚£ä¸ªæ–‡ä»¶æˆ–ç›®å½•!</span><br><span class="line">The gs_guc run with the following arguments: [gs_guc -N all -I all -h host all jack 192.168.xx.xx/32 sha256 set ].</span><br><span class="line">gs_guc: malloc 0</span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥æ²¡æœ‰è¿™ä¸ªæ–‡ä»¶æ˜¯å› ä¸ºæç®€ç‰ˆä¸­å¾ˆå¤šå‘½ä»¤éƒ½æ²¡æœ‰ï¼Œæ¯”å¦‚<code>gs_om</code>ã€‚</p><p>æç®€ç‰ˆå°‘å¾ˆå¤šå‘½ä»¤æ–‡ä»¶æ€ä¹ˆè§£å†³ï¼Œæˆ‘åªèƒ½ä»æ–°å®‰è£…ä¸ªä¼ä¸šç‰ˆï¼Ÿå¥½éº»çƒ¦ã€‚çªç„¶æƒ³åˆ°åœ¨æœç´¢<code>gs_guc</code>è¿™ä¸ªå‘½ä»¤çš„æ—¶å€™ï¼Œå®ƒä¿®æ”¹çš„æ˜¯<code>pg_hba.conf</code>è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œæˆ‘æ˜¯ä¸æ˜¯å¯ä»¥ç»•è¿‡<code>gs_guc</code>å‘½ä»¤ç›´æ¥ä¿®æ”¹é…ç½®æ–‡ä»¶å°±å¯ä»¥è§£å†³ï¼Œç«‹é©¬å»å®è·µã€‚</p><p><code>pg_hba.conf</code>åœ¨<code>$&#123;GAUSSDB_HOME&#125;/data/single_node</code>ä¸­ï¼Œé€šè¿‡vimä¿®æ”¹ï¼Œå¢åŠ <code>host    all             all             192.168.xx.xx/32            sha256</code><br>ä¿®æ”¹å®Œä¹‹åé‡å¯ä¸‹æœåŠ¡å°±è¡Œï¼Œæç¬‘çš„äº‹æƒ…å‘ç”Ÿäº†ï¼Œé‡å¯æœåŠ¡éœ€è¦ç”¨åˆ°<code>gs_om</code>å‘½ä»¤ï¼Œå¯æ˜¯æ²¡æœ‰å’‹åŠã€‚ã€‚ã€‚</p><p>æç®€ç‰ˆæ˜¯é€šè¿‡æ‰§è¡Œ<code>install.sh</code>å‘½ä»¤è¿›è¡Œå®‰è£…å¯åŠ¨çš„ï¼Œé‚£ä¹ˆè¿™ä¸ªé‡Œé¢åº”è¯¥æœ‰å¯åŠ¨å‘½ä»¤ï¼Œæœç„¶å‘ç°äº†ï¼Œæç®€ç‰ˆçš„å¯åœå‘½ä»¤ä¸ºï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gs_ctl start -D /home/gaussdb/gaussdb-2.0.0/data/single_node -Z single_node</span><br><span class="line">gs_ctl stop -D /home/gaussdb/gaussdb-2.0.0/data/single_node -Z single_node</span><br></pre></td></tr></table></figure><p>ç»ˆäºæå®šäº†ï¼Œå¯ä»¥è¿œç¨‹è¿æ¥äº†ã€‚</p><h2 id="JDBCè¿æ¥æµ‹è¯•"><a href="#JDBCè¿æ¥æµ‹è¯•" class="headerlink" title="JDBCè¿æ¥æµ‹è¯•"></a>JDBCè¿æ¥æµ‹è¯•</h2><p>ä»£ç ç”¨å®˜æ–¹çš„å°±è¡Œï¼ŒåŠ ä¸ªä¾èµ–åŒ…ï¼Œå®˜æ–¹ä¹Ÿæä¾›äº†ã€‚<br>å…³é”®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// åˆ›å»ºæ•°æ®åº“è¿æ¥</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> Connection <span class="title">GetConnection</span><span class="params">(String username, String passwd)</span> </span>&#123;</span><br><span class="line">    String driver = <span class="string">&quot;org.postgresql.Driver&quot;</span>;</span><br><span class="line">    String sourceURL = <span class="string">&quot;jdbc:postgresql://192.168.xx.xx:5432/school?useUnicode=true&amp;characterEncoding=utf8&quot;</span>;</span><br><span class="line">    Connection conn = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åŠ è½½æ•°æ®åº“é©±åŠ¨ã€‚</span></span><br><span class="line">        Class.forName(driver).newInstance();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">//åˆ›å»ºæ•°æ®åº“è¿æ¥ã€‚</span></span><br><span class="line">        conn = DriverManager.getConnection(sourceURL, username, passwd);</span><br><span class="line">        System.out.println(<span class="string">&quot;Connection succeed!&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> conn;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><h2 id="å¹¸è¿ä¹‹æƒ³"><a href="#å¹¸è¿ä¹‹æƒ³" class="headerlink" title="å¹¸è¿ä¹‹æƒ³"></a>å¹¸è¿ä¹‹æƒ³</h2><p>æ•´ä¸ªå®‰è£…æµ‹è¯•è¿‡ç¨‹æ¯”è¾ƒåå·ä½†ä¹Ÿå¾ˆå¹¸è¿ï¼Œæ‰€é‡çš„é—®é¢˜éƒ½èƒ½æ¯”è¾ƒç®€å•ï¼Œæ¯”è¾ƒå®¹æ˜“æå®šã€‚</p><p>å®‰è£…ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°äº›é—®é¢˜ï¼Œæœ‰çš„é—®é¢˜æ¯”è¾ƒæ™®éå¯ä»¥é€šè¿‡æœç´¢å¼•æ“è§£å†³ï¼Œä½†æ˜¯æœ‰äº›é—®é¢˜æ¯”è¾ƒç‹¬ç‰¹ï¼Œæ— æ³•é€šè¿‡æœç´¢å¼•æ“è§£å†³ï¼Œæ­¤æ—¶å°±éœ€è¦æˆ‘ä»¬æœ‰è§£å†³é—®é¢˜çš„èƒ½åŠ›ï¼Œè¿™ä¸ªèƒ½åŠ›ä»ä½•è€Œæ¥ï¼Œæˆ‘è®¤ä¸ºèƒ½åŠ›æ˜¯ä»æ€è·¯ä¸­è€Œæ¥ï¼Œè€Œæ€è·¯åˆæ˜¯ä»ç»éªŒè§è¯†ä¸­è€Œæ¥ã€‚æ‰€ä»¥å‘¢è¿˜æ˜¯é‚£å¥è€è¯ï¼Œé‡åˆ°é—®é¢˜ä¸è¦æ…Œï¼Œè¦å¤šæƒ³æƒ³ï¼Œè¦è®°ä½ä¸€ç‚¹ï¼Œé—®é¢˜è‚¯å®šæ˜¯èƒ½è§£å†³çš„ï¼Œåªæ˜¯æœ‰çš„é—®é¢˜è§£å†³å®Œå°±æ²¡æœ‰äº†ï¼Œè€Œæœ‰çš„é—®é¢˜è§£å†³å®Œä¸€ä¸ªåˆä¼šå‡ºç°Nä¸ªã€‚</p><p>ä¹Ÿè®¸ç°åœ¨è¯´è¿™äº›éƒ½æ˜¯é£å‡‰è¯ï¼Œä½†ç°åœ¨æƒ³æƒ³å¦‚æœå½“æ—¶è§£å†³è¿œç¨‹è¿æ¥é—®é¢˜æ—¶ï¼Œæ²¡æœ‰å»å¤šæƒ³ä¸‹ï¼Œå¯èƒ½å°±ç›´æ¥æ›´æ¢ä¼ä¸šç‰ˆï¼Œç„¶åå®‰è£…éƒ¨ç½²ï¼Œé‡åˆ°æ–°çš„é—®é¢˜ç»§ç»­è§£å†³é—®é¢˜ã€‚<br>ä½†æ˜¯æˆ‘å¾ˆåº†å¹¸æˆ‘æ²¡æœ‰ç«‹é©¬å»æ›´æ¢ä¼ä¸šç‰ˆï¼Œè€Œæ˜¯å¤šæƒ³äº†ä¸€æ­¥ï¼Œå¹¶é ç€è‡ªå·±çš„ç»éªŒæŠŠé‡åˆ°çš„é—®é¢˜ç»™è§£å†³äº†ï¼ŒèŠ‚çœäº†ä¸€äº›æ—¶é—´ä¹Ÿå¢åŠ äº†è‡ªå·±ç‹¬ç«‹è§£å†³é—®é¢˜çš„ä¿¡å¿ƒã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> GaussDB </tag>
            
            <tag> deploy </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å§—å§—æ¥è¿Ÿçš„æœå®</title>
      <link href="/my-book.html"/>
      <url>/my-book.html</url>
      
        <content type="html"><![CDATA[<p>2021å¹´ä¹Ÿæ¥è¿‘ä¸€åŠäº†ï¼Œè¿‡å»çš„2020å¹´å¯¹è°éƒ½æ˜¯ä¸å¹³å‡¡çš„ä¸€å¹´ï¼Œå¯¹æˆ‘å°¤æ˜¯ã€‚<br>2020å¹´åœ¨å„ä½ç¼–è¾‘è€å¸ˆçš„å¸®åŠ©ä¸‹ï¼Œå¯¹ä¹¦è¿›è¡Œäº†å¾®è°ƒï¼Œç»ˆäºåœ¨2021å¹´è¦è·Ÿè¯»è€…è§é¢äº†ï¼Œè™½ç„¶æ•´ä¸ªæˆ˜çº¿ç”±äºç–«æƒ…åŸå› è¢«æ‹‰äº†å¾ˆé•¿ï¼Œä½†ç°åœ¨å¿ƒé‡Œä¾ç„¶å¾ˆæ¿€åŠ¨ã€‚</p><p>è¿™æ˜¯ä¸€æœ¬å…³äºHadoop 3çš„ä¹¦ï¼Œä¹¦çš„åå­—å«ã€ŠHadoop 3å®æˆ˜æŒ‡å—ã€‹</p><span id="more"></span><p>å…¶å®æœ¬ä¹¦æŒ‰åŸå…ˆçš„è®¡åˆ’æ˜¯æ‰“ç®—åœ¨2020å¹´è·Ÿå¤§å®¶è§é¢çš„ï¼Œå½“æ—¶å›½å†…å¹¶æ²¡æœ‰å…³äºHadoop 3çš„ç›¸å…³ä¹¦ç±ï¼Œè€Œå½“æ—¶æ­£åœ¨æä¸€äº›Hadoop 3çš„äº‹æƒ…ï¼Œæ‰€ä»¥æˆ‘å°±æ‰“ç®—æŠŠè‡ªå·±å¯¹Hadoop 3çš„ç†è§£ä»¥åŠå·¥ä½œä¹‹ååœ¨ä»äº‹Hadoopç›¸å…³å·¥ä½œæ—¶ç§¯ç´¯çš„ç»éªŒåˆ†äº«ç»™å¤§å®¶ï¼Œæ‰€ä»¥å°±æœ‰äº†è¿™æœ¬ä¹¦ï¼Œç”±äºæœ¬äººèƒ½åŠ›æœ‰é™ï¼Œä¹¦ä¸­éš¾å…ä¼šæœ‰ç†è§£ä¸åˆ°ä½çš„åœ°æ–¹ï¼Œè¯·å„ä½å¤§ä½¬å¸®å¿™æŒ‡æ­£ã€‚</p><p>æœ¬ä¹¦é•¿è¿™ä¸ªæ ·å­ï¼Œé¢„è®¡5æœˆä»½åœ¨å„å¤§ç”µå•†å¼€å”®ã€‚<br><img src="/blogimgs/my-book/book.png"></p><p>æœ¬ä¹¦ç›®å½•ï¼š<br>ç¬¬1ç«  Hadoop<br>    1.1 ç®€ä»‹<br>        1.1.1 Hadoop 1.0<br>        1.1.2 Hadoop 2.0<br>    1.2 Hadoop 3.0<br>    1.3 é˜…è¯» Hadoop æºç <br>        1.3.1 å•å…ƒæµ‹è¯•<br>        1.3.2 æ–­ç‚¹è°ƒè¯•ä»£ç <br>    1.4 å°ç»“<br>ç¬¬2ç«  HDFS<br>    2.1 HDFS ç®€ä»‹<br>    2.2 è§£æNameNodeä¸­çš„å…ƒæ•°æ®åŠå…¶å†…å­˜ç»“æ„<br>        2.2.1 è§£æNameNodeä¸­çš„å…ƒæ•°æ®<br>        2.2.2 è§£æNameNodeçš„å†…å­˜ç»“æ„<br>    2.3 è§£æNameNodeçš„HAåŠŸèƒ½<br>        2.3.1 åŸºäºQJMçš„HA<br>        2.3.2 æ•…éšœè½¬ç§»<br>        2.3.3 å¤šNameNodeæ¨¡å¼<br>    2.4 HDFS çš„ Federation<br>        2.4.1 åŸºäº viewfs çš„ Federation<br>        2.4.2 åŸºäºRouterçš„Federation<br>    2.5 çº åˆ ç <br>        2.5.1 çº åˆ ç çš„åŸç†<br>        2.5.2 HDFS EC<br>        2.5.3 HDFS EC çš„å®ç°<br>        2.5.4 å¯¹æ¯”HDFS ECç­–ç•¥ä¸ä¸‰å‰¯æœ¬ç­–ç•¥<br>    2.6 ä¸‹ä¸€ä»£å¯¹è±¡å­˜å‚¨ç³»ç»ŸOzone<br>        2.6.1 Ozone åˆä½“éªŒ<br>        2.6.2 Ozone æ¶æ„<br>    2.7 å°ç»“<br>ç¬¬3ç«  YARN<br>    3.1 YARN ç®€ä»‹<br>    3.2 è§£æResourceManagerçš„HAåŠŸèƒ½<br>        3.2.1 æ•…éšœè½¬ç§»<br>        3.2.2 æ•°æ®æ¢å¤<br>    3.3 YARN Federation<br>        3.3.1 æ¶æ„<br>        3.3.2 Router<br>        3.3.3 State Storeå’ŒPolicy Store<br>        3.3.4 AMRMProxy<br>        3.3.5 è·¨å­é›†ç¾¤è¿è¡Œ<br>    3.4 ä¸­å¤®è°ƒåº¦å™¨<br>        3.4.1 Capacity è°ƒåº¦å™¨<br>        3.4.2 Fair è°ƒåº¦å™¨<br>        3.4.3 è°ƒåº¦æ‰©å±•<br>    3.5 åˆ†å¸ƒå¼è°ƒåº¦å™¨<br>        3.5.1 åˆ†å¸ƒå¼è°ƒåº¦å™¨çš„æ¶æ„<br>        3.5.2 opportunistic container<br>    3.6 YARN Shared Cache<br>        3.6.1 èµ„æºæœ¬åœ°åŒ–<br>        3.6.2 Shared Cache çš„æ¶æ„<br>        3.6.3 Shared Cache å®ä¾‹<br>    3.7 å°ç»“<br>ç¬¬4ç«  Application on YARN<br>    4.1 MapReduce çš„ç®€ä»‹<br>    4.2 MapReduce çš„æºç åˆ†æ<br>        4.2.1 InputSplit<br>        4.2.2 ç¯å½¢ç¼“å†²åŒº<br>        4.2.3 æº¢å†™å’Œå½’å¹¶<br>        4.2.4 Shuffle<br>    4.3 MapReduce on YARN<br>        4.3.1 YARN çš„äº‹ä»¶æœºåˆ¶å’ŒçŠ¶æ€æœºæœºåˆ¶<br>        4.3.2 MR ApplicationMaster<br>    4.4 Application on YARN<br>    4.5 å°ç»“<br>ç¬¬5ç«  å®æˆ˜æŒ‡å—<br>    5.1 Hadoop 3.x çš„éƒ¨ç½²<br>        5.1.1 Hadoop 3.x HAçš„éƒ¨ç½²<br>        5.1.2 Hadoop 3.x Federation çš„éƒ¨ç½²<br>    5.2 Hadoop å‡çº§<br>        5.2.1 Hadoop 2.0 å‡çº§ä¸º Hadoop 3.0<br>        5.2.2 Hadoop 3.0 é™çº§ä¸º Hadoop 2.0<br>        5.2.3 å‡çº§/é™çº§ä¸­é‡åˆ°çš„é—®é¢˜<br>    5.3 äºŒæ¬¡å¼€å‘<br>        5.3.1 ä¸å…¶ä»–è‡ªç ”ç³»ç»Ÿèåˆ<br>        5.3.2 è‡ªèº«åŠŸèƒ½æ‰©å±•ä¹‹è‡ªåŠ¨è¯†åˆ«ä¿®å¤åçš„æ•°æ®ç›˜<br>        5.3.3 åˆå¹¶ç¤¾åŒº Patch<br>        5.3.4 æäº¤PullRequest<br>    5.4 å‘¨è¾¹ç³»ç»Ÿå¹³å°<br>        5.4.1 ä»»åŠ¡è°ƒåº¦å¹³å°<br>        5.4.2 ç›‘æ§å¹³å°<br>        5.4.3 é›†ç¾¤è¯Šæ–­åˆ†æå¹³å°<br>    5.5 å°ç»“</p><p>å¸Œæœ›å¤§å®¶å¤šå¤šæ”¯æŒï¼Œæœ‰ä»€ä¹ˆé—®é¢˜å¯ä»¥éšæ—¶æ‰¾æˆ‘æ²Ÿé€šã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> HDFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‘å¨ƒ-é˜²æ²‰è¿·App</title>
      <link href="/android-app-timeup.html"/>
      <url>/android-app-timeup.html</url>
      
        <content type="html"><![CDATA[<p>çŒ¿çˆ¸ï¼šå±å­©ï¼Œå·²ç»çœ‹äº†å¾ˆé•¿xxäº†ï¼Œè¯¥è®©çœ¼ç›ä¼‘æ¯ä¸‹äº†ã€‚<br>å±å­©ï¼šä¸æƒ…ä¸æ„¿çš„å…³äº†ï¼Œå»ç©åˆ«çš„ã€‚<br>å¾ˆå’Œè°æ˜¯ä¸æ˜¯ï¼Ÿå½“ä½ ä¸åœ¨å®¶çš„æ—¶å€™ï¼Œå±å­©å°±æ²¡è¿™ä¹ˆä¹–äº†ï¼Œæ˜¯ä¸æ˜¯ï¼Œè®¤åŒä¸ï¼Ÿ<br>è¿™æ—¶å°±éœ€è¦æœ‰ä¸€ä¸ªå¼ºåŠ¿çš„â€œäººâ€æ¥é˜»æ­¢ä»–ï¼Œè¿™ä¸ªå¯åˆ«å¥¢æœ›è€äººæ¥é˜»æ­¢ä»–ï¼Œäºæ˜¯åªèƒ½è®©â€œæœºå™¨äººâ€æ¥æäº†ã€‚</p><p>äºæ˜¯æäº†ä¸ªAppï¼Œåå­—å«<strong>å‘å¨ƒç¥å™¨</strong>ï¼ˆä¸çŸ¥é“è‹¥å¹²å¹´åï¼Œå±å­©çœ‹åˆ°è¿™ä¸ªæ–‡ç« å¿ƒé‡Œæ˜¯ä»€ä¹ˆæ»‹å‘³ã€‚ã€‚ã€‚ï¼‰ï¼ŒåŠŸèƒ½æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯ç›‘æ§æŒ‡å®šappçš„æ´»åŠ¨çŠ¶æ€ï¼Œå¦‚æœè¿ç»­è¿è¡Œä¸€æ®µæ—¶é—´ï¼Œå‘å¨ƒç¥å™¨å°±ä¼šè‡ªåŠ¨ä»åå°åˆ‡åˆ°å‰å°è¿›è¡Œå€’è®¡æ—¶ï¼Œå€’è®¡æ—¶ç»“æŸä¹‹åå¯ä»¥ç»§ç»­å¨±ä¹ã€‚</p><p>è¿™ä¸ªAppç›®å‰åªæ˜¯å¤„äºåŸå§‹ç¤¾ä¼šç‰ˆï¼Œå¸Œæœ›æœ‰èƒ½åŠ›çš„çŒ¿çˆ¸ä»¬åŠ å…¥ï¼Œæˆ‘ä»¬ä¸€èµ·å°†å…¶å®Œå–„ï¼Œå¸®åŠ©ä¸‹ä¸€ä»£å…»æˆä¸€ä¸ªå¥½çš„è‡ªå¾‹èƒ½åŠ›ï¼Œæ­¤Appå·²åœ¨githubä¸Šå¼€æºï¼Œæ¬¢è¿è´¡çŒ®ï¼Œé¡¹ç›®åœ°å€<a href="https://github.com/hunshenshi/timeup.git">https://github.com/hunshenshi/timeup.git</a></p><span id="more"></span><h2 id="è°ƒç ”â€“å‡†å¤‡å·¥ä½œ"><a href="#è°ƒç ”â€“å‡†å¤‡å·¥ä½œ" class="headerlink" title="è°ƒç ”â€“å‡†å¤‡å·¥ä½œ"></a>è°ƒç ”â€“å‡†å¤‡å·¥ä½œ</h2><p>æ‰¾äº†ä¸‹ç›®å‰å¸‚é¢å·²æœ‰çš„å·¥å…·å’Œä¸€äº›æ‰‹æœºè‡ªå¸¦çš„å¥åº·ä½¿ç”¨çš„åŠŸèƒ½ï¼Œä¸å¤ªæ»¡è¶³æˆ‘çš„éœ€æ±‚ï¼Œ<br>1ã€å¤§å¤šæ•°éƒ½æ˜¯é™åˆ¶æ¯å¤©ç´¯è®¡ä½¿ç”¨æ—¶é•¿ï¼Œè€Œæˆ‘å¸Œæœ›æ¯ä½¿ç”¨ä¸€æ®µæ—¶é—´å°±ä¼‘æ¯ä¸€ä¼šï¼Œè€Œä¸å…³æ³¨ç´¯è®¡æ—¶é•¿<br>2ã€ç”±äºå¸‚é¢ä¸Šéƒ½æ˜¯ä¸€äº›é¢å‘å¹¿å¤§ç”¨æˆ·çš„äº§å“ï¼Œè¾¾åˆ°æ—¶é•¿ä¹‹åä¼šæœ‰æç¤ºï¼Œè€Œä¸ä¼šæœ‰æ›´æ¿€çƒˆçš„è¡Œä¸ºã€‚è€Œæˆ‘çš„éœ€æ±‚å¼ºç¡¬ï¼Œå†å¼ºç¡¬ï¼ˆåæ­£ç”¨æˆ·åªæœ‰å®¶é•¿çš„å¨ƒï¼‰</p><blockquote><p>æˆ‘æƒ³è¦çš„åŠŸèƒ½ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å½“æ£€æµ‹åˆ°å‰å°è§†é¢‘ç±»çš„è½¯ä»¶è¿ç»­è¿è¡Œä¸€æ®µæ—¶é—´ä¹‹åï¼Œä¾ç„¶åœ¨è¿è¡Œï¼Œå°±å°†å…¶åˆ‡æ¢åˆ°åå°ï¼Œå¹¶å°†å€’è®¡æ—¶é¡µé¢åˆ‡æ¢è‡³å‰å°ï¼Œç­‰å¾…å€’è®¡æ—¶ç»“æŸã€‚éšåå†æ¬¡è¿›è¡Œä¸‹ä¸€è½®ç›‘æ§ï¼Œä¸ç›‘æ§ç´¯è®¡æ—¶é•¿ï¼Œåªç›‘æ§è¿ç»­ä½¿ç”¨æ—¶é•¿ï¼Œå¹¶ä¸”å¼ºåˆ¶åˆ‡æ¢Appã€‚</p></blockquote><p>æ²¡æœ‰ç°æˆçš„è½®å­é‚£å°±è‡ªå·±é€ ä¸€ä¸ªå§ï¼Œæ¢³ç†ä¸‹ä¼šç”¨åˆ°çš„æŠ€æœ¯ç‚¹ï¼š<br>1ã€Appä¿æ´»ï¼Œå› ä¸ºéœ€è¦å‘å¨ƒç¥å™¨é•¿æœŸå­˜æ´»äºåå°è¿›è¡Œç›‘æ§<br>2ã€å¦‚ä½•æ‹¿åˆ°æ­£åœ¨è¿è¡Œçš„app<br>3ã€å®šæ—¶æ‰§è¡Œï¼Œéœ€è¦å‘å¨ƒç¥å™¨å®šæœŸæ£€æµ‹å‰å°è¿è¡Œçš„appæ˜¯ä»€ä¹ˆ<br>4ã€åå°å”¤é†’ï¼Œéœ€è¦å‘å¨ƒç¥å™¨ä»åå°å”¤é†’åˆ°å‰å°è¿›è¡Œå€’è®¡æ—¶</p><p>çœ‹äº†äº›ç›¸å…³çš„æ–‡ç« ï¼Œæ„Ÿè§‰åŠŸèƒ½å¤§éƒ½å¯ä»¥å®ç°ï¼Œåªæ˜¯å®‰å“çš„ç‰ˆæœ¬å¤ªå¤šäº†ï¼Œå„ç§åŠŸèƒ½åœ¨å„ä¸ªç‰ˆæœ¬ä¸­å®ç°æ–¹å¼åˆä¸ä¸€æ ·ï¼Œåœ¨è¿™ç‰¹åˆ«åŒæƒ…æå®‰å“çš„æœ‹å‹ï¼ŒçœŸä¸å®¹æ˜“å‘€ã€‚ã€‚ã€‚</p><h2 id="ç¬¬ä¸€ä¸ªAndroid-Application"><a href="#ç¬¬ä¸€ä¸ªAndroid-Application" class="headerlink" title="ç¬¬ä¸€ä¸ªAndroid Application"></a>ç¬¬ä¸€ä¸ªAndroid Application</h2><p>å†³å®šè¦æäº†ï¼Œé‚£å°±å…ˆä»Hello Worldå¼€å§‹å§ï¼Œé¦–å…ˆä¸‹è½½ä¸ªAndroid Studioï¼Œç„¶åæ ¹æ®å‘å¯¼åˆ›å»ºä¸€ä¸ªandroidåº”ç”¨ï¼Œè¿™é‡Œè¯­è¨€æˆ‘é€‰çš„æ˜¯javaï¼Œä¸€è·¯ä¸‹æ¥å°±èƒ½è¿è¡Œä¸€ä¸ªdemo appäº†ã€‚å…·ä½“æ­¥éª¤å¦‚ä¸‹ï¼š<br><img src="/blogimgs/android-monitor/app01.png" alt="æ–°å»ºproject" title="æ–°å»ºproject"><br>æ–°å»ºprojectä¹‹åï¼Œè¿›å…¥é€‰æ‹©æ¨¡ç‰ˆé¡µé¢ï¼Œè¿™é‡Œæˆ‘é€‰çš„æ˜¯basicï¼Œä¸‹é¢è¿˜æœ‰å¾ˆå¤šæ¨¡ç‰ˆå¯ä»¥é€‰<br><img src="/blogimgs/android-monitor/app02.png" alt="é€‰æ‹©project" title="é€‰æ‹©project"><br>é€‰æ‹©ä¸‹ä¸€æ­¥ä¹‹åï¼Œå¡«å†™projectç›¸å…³çš„ä¿¡æ¯ï¼Œæ¯”å¦‚projectåå­—ï¼Œéœ€è¦çš„è¯­è¨€å’Œsdk<br><img src="/blogimgs/android-monitor/app03.png" alt="å¡«å†™projectä¿¡æ¯" title="å¡«å†™projectä¿¡æ¯"><br>ç‚¹å‡»Finishå°±ç»“æŸäº†ï¼Œç­‰å¾…IDEåŠ è½½ç¨‹åºå°±è¡Œäº†ã€‚</p><p>è¿™ä¸ªè¿‡ç¨‹å¯èƒ½ä¼šæ¯”è¾ƒæ…¢ï¼Œä¸»è¦æ˜¯gradle-5.6.4-all.zipä¸‹è½½æ…¢ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿…é›·ä¸‹è½½ï¼Œç„¶åæ”¾åˆ°æŒ‡å®šçš„ç›®å½•å°±OKäº†ã€‚</p><h2 id="Appä¿æ´»"><a href="#Appä¿æ´»" class="headerlink" title="Appä¿æ´»"></a>Appä¿æ´»</h2><p>Appä¿æ´»è¿™ä¸ªè¯é¢˜ï¼Œä¸æœä¸çŸ¥é“ï¼Œä¸€æœæ˜¯æ‰“å¼€çœ¼ç•Œå‘€ï¼Œå……åˆ†å±•ç°äº†ç¾¤ä¼—çš„æ™ºæ…§å‘€ã€‚ä»€ä¹ˆåŒActivityç›¸äº’å”¤é†’ã€æ’­æ”¾æ— å£°éŸ³é¢‘å„ç§å¥‡æ·«å·§æŠ€ã€‚<br>ä¸è¿‡æˆ‘è¿™é‡Œå°±è‡ªå·±ç”¨ï¼Œè¿™ä¹ˆå¤šçš„å¥‡æ·«å·§æŠ€æˆ‘æ˜¯ç”¨ä¸ä¸Šäº†ï¼ˆå°±ç®—éœ€è¦ç”¨ä¸Šæˆ‘ä¹Ÿæ²¡æœ‰é‚£ä¹ˆé«˜æ·±çš„åŠŸåŠ›ï¼‰ï¼Œè§„è§„çŸ©çŸ©çš„ç”³è¯·æƒé™å§ã€‚</p><p>å¸¸é©»åå°éœ€è¦ç”³è¯·ç”µæ± ç™½åå•æƒé™ï¼Œç½‘ä¸Šæœ‰å¾ˆå¤šä»£ç ç¤ºä¾‹ï¼Œç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(Settings.ACTION_REQUEST_IGNORE_BATTERY_OPTIMIZATIONS);</span><br><span class="line">context.startActivity(intent);</span><br></pre></td></tr></table></figure><h2 id="è·å–æ­£åœ¨è¿è¡Œçš„App"><a href="#è·å–æ­£åœ¨è¿è¡Œçš„App" class="headerlink" title="è·å–æ­£åœ¨è¿è¡Œçš„App"></a>è·å–æ­£åœ¨è¿è¡Œçš„App</h2><p>å¦‚ä½•é€šè¿‡ä»£ç æ‹¿åˆ°æ­£åœ¨å‰å°å±•ç¤ºçš„appï¼Œä¹Ÿæ˜¯å›°éš¾é‡é‡ï¼Œå¯¹äºä¸€æ— æ‰€çŸ¥çš„æˆ‘ä¾ç„¶æ˜¯å…ˆç½‘ä¸Šæœä¸€å †demoï¼Œç„¶åæµ‹è¯•ã€‚<br>æœç´ çš„ç»“æœå¤§ä½“åˆ†ä¸º3ç§ï¼Œä¸»è¦åˆ†å¸ƒåœ¨ä¸åŒçš„sdkç‰ˆæœ¬ä¸­ï¼Œå·²ç»è¿‡æ—¶çš„æœ‰<code>getRunningTasks</code>å’Œ<code>getRunningAppProcesses</code>ï¼Œåœ¨æ–°ç‰ˆsdkä¸­éƒ½æ™®éä½¿ç”¨<code>UsageStatsManager</code>ï¼Œä½¿ç”¨<code>UsageStatsManager</code>æ—¶éœ€è¦ç”³è¯·æƒé™ï¼Œè€Œä¸”é€šè¿‡å®ƒè·å–appçš„æ–¹æ³•ç½‘ä¸Šä¹Ÿæœ‰å¥½å‡ ç§ï¼Œæˆ‘å¯¹æ¯”äº†å‡ ç§ä½¿ç”¨çš„æ˜¯<code>queryUsageStats</code>æ–¹æ³•ï¼Œè¿˜å¯ä»¥ä½¿ç”¨<code>queryEvents</code>æ–¹æ³•ï¼Œä¸è¿‡æˆ‘æµ‹è¯•å‘ç°<code>queryEvents</code>çŠ¶æ€å˜æ›´æ²¡æœ‰<code>queryUsageStats</code>åŠæ—¶ã€‚ï¼ˆä¸è¦é—®æˆ‘ä¸ºä»€ä¹ˆæµ‹è¯•äº†è¿™ä¹ˆå¤šæ–¹æ³•ã€‚ã€‚ï¼‰</p><p>æ•´ä½“æ€è·¯æ˜¯é€šè¿‡<code>queryUsageStats</code>æŸ¥è¯¢ä¸€æ®µæ—¶é—´å†…çš„Appä½¿ç”¨ä¿¡æ¯ï¼Œç„¶åå¯¹Appçš„æœ€åæ›´æ–°æ—¶é—´è¿›è¡Œæ’åºï¼Œæ—¶é—´æœ€å¤§çš„å°±æ˜¯æ­£åœ¨å‰å°å±•ç¤ºçš„Appã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è·å–UsageStatsé›†åˆ</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;UsageStats&gt;  <span class="title">getUsageStatsList</span><span class="params">(Context context, <span class="keyword">long</span> startTime, <span class="keyword">long</span> endTime)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">        UsageStatsManager manager = (UsageStatsManager) context.getApplicationContext().getSystemService(Context.USAGE_STATS_SERVICE);</span><br><span class="line">        List&lt;UsageStats&gt;  usageStatses = manager.queryUsageStats(UsageStatsManager.INTERVAL_BEST, startTime, endTime);</span><br><span class="line">        <span class="keyword">if</span> (usageStatses == <span class="keyword">null</span> || usageStatses.size() == <span class="number">0</span>) &#123;<span class="comment">// æ²¡æœ‰æƒé™ï¼Œè·å–ä¸åˆ°æ•°æ®</span></span><br><span class="line">            Log.i(<span class="string">&quot;AppUtil getUsageStatsList &quot;</span>, <span class="string">&quot;no permission for UsageStatsManager&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> usageStatses;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å¯¹æœ€åæ›´æ–°æ—¶é—´è¿›è¡Œæ’åºè·å–å‰å°App</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> UsageStats <span class="title">getForegroundUsageStats</span><span class="params">(Context context, <span class="keyword">long</span> startTime, <span class="keyword">long</span> endTime)</span> </span>&#123;</span><br><span class="line">    UsageStats usageStatsResult = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">        List&lt;UsageStats&gt; usageStatses = getUsageStatsList(context, startTime, endTime);</span><br><span class="line">        <span class="keyword">if</span> (usageStatses == <span class="keyword">null</span> || usageStatses.isEmpty()) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (UsageStats usageStats : usageStatses) &#123;</span><br><span class="line">            <span class="comment">// é€šè¿‡åå°„è·å–Appçš„äº‹ä»¶ç±»å‹</span></span><br><span class="line">            <span class="keyword">int</span> lastEvent = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Field mLastEventField = UsageStats.class.getField(<span class="string">&quot;mLastEvent&quot;</span>);</span><br><span class="line">                mLastEventField.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">                lastEvent = mLastEventField.getInt(usageStats);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (NoSuchFieldException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (usageStatsResult == <span class="keyword">null</span> || usageStatsResult.getLastTimeUsed() &lt; usageStats.getLastTimeUsed()) &#123;</span><br><span class="line">                usageStatsResult = usageStats;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> usageStatsResult;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å®šæ—¶å‘¨æœŸæ‰§è¡Œä»»åŠ¡"><a href="#å®šæ—¶å‘¨æœŸæ‰§è¡Œä»»åŠ¡" class="headerlink" title="å®šæ—¶å‘¨æœŸæ‰§è¡Œä»»åŠ¡"></a>å®šæ—¶å‘¨æœŸæ‰§è¡Œä»»åŠ¡</h2><p>ç”±äºè¿™åªæ˜¯ä¸ªå‘å¨ƒçš„Appï¼Œæ‰€ä»¥è¿™é‡Œç›´æ¥ç®€å•ç²—æš´çš„ä½¿ç”¨å®šæ—¶ä»»åŠ¡æ¥checkå‰å°Appæ˜¯å¦ä¸ºæ‰€è¦ç›‘æ§çš„Appï¼Œè€Œæ²¡æœ‰ä½¿ç”¨å„ç§Triggerã€‚<br>Androidä¸­çš„å®šæ—¶ä»»åŠ¡ä¸»è¦æ˜¯<code>Timer</code>å’Œ<code>AlarmManager</code>ï¼Œæ¨èä½¿ç”¨<code>AlarmManager</code>ï¼Œè€Œä¸”ä¸éœ€è¦ç”³è¯·æƒé™ã€‚</p><p><code>AlarmManager</code>ç»“åˆ<code>Service</code>ä½¿ç”¨ï¼Œåœ¨é«˜ç‰ˆæœ¬çš„sdkä¸­ï¼Œ<code>AlarmManager</code>æ²¡æœ‰é‡å¤æ‰§è¡Œçš„åŠŸèƒ½ï¼Œéœ€è¦åœ¨<code>Service</code>å†æ¬¡è°ƒç”¨<code>AlarmManager</code>ä»è€Œèµ·åˆ°é‡å¤æ‰§è¡Œä»»åŠ¡çš„åŠŸèƒ½ã€‚è€Œä¸”åœ¨é«˜ç‰ˆä¸­ä¸ºäº†èŠ‚çœç”µé‡ä¹Ÿè¿›è¡Œäº†å¾ˆå¤šä¼˜åŒ–ï¼Œè¦æƒ³ç²¾å‡†å‡ºå‘å®šæ—¶å™¨éœ€è¦ä½¿ç”¨<code>setExactAndAllowWhileIdle</code>æ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">AlarmManager am = (AlarmManager) context.getSystemService(Context.ALARM_SERVICE);</span><br><span class="line"><span class="comment">// CheckServiceæ˜¯å®šæ—¶å™¨è§¦å‘ä¹‹åè¦å…·ä½“æ‰§è¡Œçš„ä»»åŠ¡é€»è¾‘</span></span><br><span class="line">Intent intent = <span class="keyword">new</span> Intent(context, CheckService.class);</span><br><span class="line">pendingIntent = PendingIntent.getService(context, <span class="number">0</span>, intent, <span class="number">0</span>);</span><br><span class="line"><span class="comment">// AlarmManager.ELAPSED_REALTIME_WAKEUPæ˜¯ä¸ºäº†èƒ½ä¸»åŠ¨å”¤é†’CPU</span></span><br><span class="line">am.setExactAndAllowWhileIdle(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">                    SystemClock.elapsedRealtime(), pendingIntent);</span><br><span class="line"></span><br><span class="line"><span class="comment">// åœ¨CheckServiceçš„onStartCommandæ–¹æ³•ä¸­æ‰§è¡Œå®šæ—¶ä»»åŠ¡é€»è¾‘ï¼Œå¹¶ä¸”æ‰§è¡Œå®Œä¹‹åç»§ç»­è®¾ç½®å®šæ—¶å™¨ï¼Œèµ·åˆ°é‡å¤æ‰§è¡Œçš„æ•ˆæœ</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CheckService</span> <span class="keyword">extends</span> <span class="title">Service</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">onStartCommand</span><span class="params">(Intent intent, <span class="keyword">int</span> flags, <span class="keyword">int</span> startId)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// checkå‰å°Appæ˜¯å¦ä¸ºéœ€è¦ç›‘æ§çš„Appï¼Œå¦‚æœæ˜¯æ‰§è¡Œç›¸åº”çš„æ“ä½œ</span></span><br><span class="line">        <span class="comment">// å†æ¬¡è°ƒç”¨å®šæ—¶å™¨</span></span><br><span class="line">        am.setExactAndAllowWhileIdle(AlarmManager.ELAPSED_REALTIME_WAKEUP,</span><br><span class="line">                    SystemClock.elapsedRealtime() + TIME_INTERVAL, pendingIntent);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ³¨æ„ä¸¤æ¬¡è°ƒç”¨å®šæ—¶å™¨çš„ä¸åŒï¼Œåœ¨<code>CheckService</code>ä¸­è°ƒç”¨æ—¶Triggerä¸º<code>SystemClock.elapsedRealtime() + TIME_INTERVAL</code>ï¼Œä»£è¡¨å»¶å<code>TIME_INTERVAL</code>ä¹‹åè§¦å‘ã€‚</p><h2 id="åå°å”¤é†’"><a href="#åå°å”¤é†’" class="headerlink" title="åå°å”¤é†’"></a>åå°å”¤é†’</h2><p>åå°å”¤é†’æ˜¯æŒ‡æ­£åœ¨åå°è¿è¡Œçš„Appç”±äºæŸç§åŸå› è¢«åˆ‡æ¢åˆ°å‰å°ã€‚</p><p>å¦‚æœæ˜¯åœ¨ä½ç‰ˆæœ¬çš„sdkä¸­å¯ä»¥ä½¿ç”¨<code>getRunningTasks</code>ï¼Œæ‹¿åˆ°å¯¹åº”packageçš„taskä¿¡æ¯ï¼Œå…¶ä¸­åŒ…æ‹¬taskIdï¼Œç„¶åè°ƒç”¨<code>moveTaskToFront</code>æ–¹æ³•å°†å…¶ä»»åŠ¡åˆ‡æ¢åˆ°å‰å°ï¼Œä½†æ˜¯<code>getRunningTasks</code>å·²è¢«æ ‡æ³¨ä¸ºè¿‡æ—¶çš„ï¼Œæ‰€ä»¥åœ¨ä¸Šé¢è·å–å‰å°Appæ—¶ä¹Ÿæ²¡ç”¨è¯¥æ–¹æ³•ã€‚</p><p>è¿™é‡Œä½¿ç”¨äº†æ–°å»ºActivityçš„æ–¹æ³•ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">toRunningForeground</span><span class="params">(String packageNameTarget)</span> </span>&#123;</span><br><span class="line">    PackageManager packageManager = getPackageManager();</span><br><span class="line"></span><br><span class="line">    Intent intent = packageManager.getLaunchIntentForPackage(packageNameTarget);</span><br><span class="line">    intent.addCategory(Intent.CATEGORY_LAUNCHER);</span><br><span class="line">    intent.setFlags(Intent.FLAG_ACTIVITY_RESET_TASK_IF_NEEDED | Intent.FLAG_ACTIVITY_NEW_TASK);</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**android.intent.action.MAINï¼šæ‰“å¼€å¦ä¸€ç¨‹åº</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    intent.setAction(<span class="string">&quot;android.intent.action.MAIN&quot;</span>);</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * FLAG_ACTIVITY_SINGLE_TOP:</span></span><br><span class="line"><span class="comment">     * å¦‚æœå½“å‰æ ˆé¡¶çš„activityå°±æ˜¯è¦å¯åŠ¨çš„activity,åˆ™ä¸ä¼šå†å¯åŠ¨ä¸€ä¸ªæ–°çš„activity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    intent.addFlags(Intent.FLAG_ACTIVITY_SINGLE_TOP);</span><br><span class="line">    activity.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¸©å‘å®å½•"><a href="#è¸©å‘å®å½•" class="headerlink" title="è¸©å‘å®å½•"></a>è¸©å‘å®å½•</h2><p>ä¸»è¦åŠŸèƒ½å¼€å‘å®Œæˆï¼Œå¹¶åœ¨IDEä¸­æ­£å¸¸è¿è¡Œï¼Œä¸‹é¢å°±è¦å®æœºæµ‹è¯•äº†ï¼Œå‰æ–¹å†°å†·çš„æ´ªæ°´è¿é¢æ‹æ¥ï¼ï¼ï¼</p><p>å°†Appå®‰è£…åˆ°å¹³æ¿ä¸Šä¹‹åï¼Œè¿›è¡Œæµ‹è¯•å‘ç°åº”è¯¥åˆ‡æ¢å€’è®¡æ—¶é¡µé¢æ—¶å¹¶æ²¡æœ‰æ­£å¸¸åˆ‡æ¢ï¼Œäºæ˜¯ä¸‹é¢å°±å¼€å§‹äº†å–ç»ä¹‹åï¼š</p><ol><li>sdkç‰ˆæœ¬ä¸å…¼å®¹<br>å› ä¸ºAndroid sdkå„ç‰ˆæœ¬æœ‰å¯èƒ½ä¸å…¼å®¹ï¼Œæ‰€ä»¥é¦–å…ˆæ€€ç–‘æ˜¯ä¸æ˜¯sdkçš„é—®é¢˜ï¼Œäºæ˜¯åœ¨IDEä¸­è®¾ç½®äº†å¯¹åº”ç‰ˆæœ¬ï¼Œå‘ç°ç¡®å®æ²¡æœ‰ç”Ÿæ•ˆï¼Œäºæ˜¯æœç´¢å¯¹åº”sdkåå°åˆ‡æ¢å‰å°çš„ç›¸å…³é—®é¢˜ï¼Œå‘ç°å¯èƒ½æ˜¯æƒé™é—®é¢˜ï¼Œsdk 29ä¹‹åé™åˆ¶äº†Appçš„ç›¸åº”æƒé™ï¼Œéœ€è¦ç”³è¯·æµ®çª—æƒé™ï¼Œç”³è¯·ä»£ç å¦‚ä¸‹ï¼š</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestOverlayPermission</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(Settings.ACTION_MANAGE_OVERLAY_PERMISSION);</span><br><span class="line">    context.startActivity(intent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ol start="2"><li><p>è·å–å½“å‰App<br>ç”³è¯·ç›¸åº”æƒé™ä¹‹åï¼Œåœ¨IDEä¸­å¯ä»¥æ­£å¸¸è¿è¡Œï¼Œå†æ¬¡éƒ¨ç½²åˆ°å¹³æ¿ä¸Šè¿›è¡Œæµ‹è¯•ï¼Œå‘ç°ä¾ç„¶æ²¡æœ‰ç”Ÿæ•ˆï¼Œç»§ç»­æ’æŸ¥ã€‚<br>åœ¨IDEä¸­å¤šæ¬¡æ’æŸ¥æ—¶å¶ç„¶å‘ç°è·å–å½“å‰Appæ—¶ï¼Œæœ‰æ¬¡æ‹¿åˆ°äº†<code>com.xx.android.launcher</code>ï¼Œä»¥ä¸ºæ˜¯è·å–å‰å°Appä¸å‡†ç¡®åŸå› é€ æˆçš„ï¼Œäºæ˜¯å°±ç”¨äº†å¥½å¤šç§æ–¹æ³•è¿›è¡Œæµ‹è¯•ï¼Œå‘ç°å§‹ç»ˆæœªç”Ÿæ•ˆã€‚ä½†æ˜¯åœ¨çœŸæœºæµ‹è¯•çš„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä¸€ä¸ªè§„å¾‹ï¼Œ<strong>åªè¦æ’ä¸Šusbï¼ŒAppå°±è¿è¡Œæ­£å¸¸</strong>ï¼Œåœ¨IDEä¸­æŸ¥çœ‹Appåœ¨å¹³æ¿ä¸Šçš„è¿è¡Œæ—¥å¿—ä¹Ÿæ­£å¸¸ï¼Œå¯æ˜¯æ‹”æ‰usbå°±ä¸ç”Ÿæ•ˆï¼Œä¹Ÿçœ‹ä¸åˆ°å½“æ—¶çš„æ—¥å¿—ï¼Œäºæ˜¯å°±æƒ³æ‰“å°äº›å…³é”®ä¿¡æ¯åœ¨å¹³æ¿ä¸ŠæŸ¥çœ‹è¿›è¡Œæ’æŸ¥é—®é¢˜ã€‚</p></li><li><p>çœŸæœºä¸ŠæŸ¥çœ‹è¿è¡Œæ—¥å¿—<br>çœ‹ä¸€äº›æ—¥å¿—æ•™ç¨‹å¥½å¤æ‚ï¼Œä¸“é—¨æä¸€ä¸‹çœŸçš„ä¸å€¼å¾—å‘€ï¼Œäºæ˜¯æƒ³åˆ°æ˜¯ä¸æ˜¯å¯ä»¥æŠŠå…³ç³»ä¿¡æ¯å†™åˆ°ä¸€ä¸ªå¯è¯»çš„æ–‡ä»¶é‡Œï¼Œäºæ˜¯å°†å…¶å†™å…¥ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeFile</span><span class="params">(Context context, String filename, String filecontent)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    FileOutputStream output = context.openFileOutput(filename, Context.MODE_APPEND);</span><br><span class="line">    output.write(filecontent.getBytes());</span><br><span class="line">    output.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ—¶åªä¼ å…¥æ–‡ä»¶åå°±è¡Œï¼Œé»˜è®¤å†™åˆ°<code>/data/data/app/com.xx/files</code>ç›®å½•ä¸‹ï¼Œå»å¹³æ¿ä¸Šæ‰¾è¿™ä¸ªç›®å½•ï¼Œå´æ²¡æœ‰æ‰¾åˆ°ã€‚ã€‚ã€‚ä¸è¿‡è¿ä¸Šusbå¯ä»¥åœ¨IDEçš„<code>Device File Explorer</code>ä¸­æ‰¾åˆ°ï¼Œäºæ˜¯å†æ¬¡çš„æµ‹è¯•æµç¨‹å°±æ˜¯æ‹”æ‰usbè¿›è¡Œæµ‹è¯•ï¼Œç„¶åè¿ä¸Šusbè¿›è¡Œæ–‡ä»¶æŸ¥çœ‹è¿è¡Œä¿¡æ¯ã€‚</p></li><li><p>æ€€ç–‘AlarmMangeråœ¨åå°ä¸ç”Ÿæ•ˆ<br>æŸ¥çœ‹Appå†™å…¥æ–‡ä»¶çš„ä¿¡æ¯ä¹‹åï¼Œå‘ç°å®šæ—¶å™¨åªæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨äº†ï¼Œéšåçš„å®šæ—¶å™¨å¹¶æœªè§¦å‘ã€‚<br>åœ¨ä½¿ç”¨<code>AlarmManger</code>æ—¶ä¹Ÿæ²¡æœ‰è¦æ±‚ç”³è¯·ä»€ä¹ˆæƒé™ï¼Œæœç´¢ä¹‹åä¹Ÿæ²¡æœ‰æ‰¾åˆ°ä»»ä½•çº¿ç´¢ï¼Œäºæ˜¯èµ„æºä¸€äº›ä¸“ä¸šäººå£«ï¼Œæœ‹å‹è¯´å¯èƒ½æ˜¯å®šæ—¶å™¨è§¦å‘é—´éš”æ—¶é—´å¤ªçŸ­ï¼Œç³»ç»Ÿç»™ä¼˜åŒ–äº†ï¼Œå¹¶é™„ä¸Šäº†æºç ä¸­çš„æ–¹æ³•æ³¨é‡Šï¼Œå¯ä¿¡åº¦å¾ˆé«˜å‘€ï¼Œæˆ‘ä¹Ÿå¾ˆå¼€å¿ƒï¼Œè¦æå®šäº†ï¼Œå¯æ˜¯ä¿®æ”¹å®‰è£…ä¹‹åä¾ç„¶æ˜¯æš´å‡»å‘€ã€‚</p></li></ol><p>æ­¤æ—¶çœŸçš„é™·å…¥äº†æ­»èƒ¡åŒï¼Œæ²¡æœ‰ä»»ä½•çº¿ç´¢ï¼Œä¸€è¿å¥½å‡ å¤©æ²¡æœ‰ä»»ä½•è¿›å±•ï¼Œå¶ç„¶åœ¨æ‰‹æœºä¸ŠæŸ¥çœ‹åº”ç”¨æƒé™çš„æ—¶å€™ï¼Œæƒ³åˆ°æ˜¯ä¸æ˜¯å¹³æ¿è‡ªåŠ¨å¯åœçš„åŸå› ï¼Œäºæ˜¯å°†Appçš„è‡ªåŠ¨ç®¡ç†åˆ‡æ¢ä¸ºæ‰‹åŠ¨ç®¡ç†ï¼Œå†æ¬¡è¿›è¡Œæµ‹è¯•ï¼Œç”Ÿæ•ˆäº†ã€‚</p><p>å¤ªè‰°è¾›äº†ï¼Œä¸ºäº†å‘ä¸ªå¨ƒå¤ªä¸å®¹æ˜“äº†ã€‚ã€‚ã€‚</p><p>è¿™ä¸ªAppç›®å‰åªæ˜¯å¤„äºåŸå§‹ç¤¾ä¼šç‰ˆï¼Œå¸Œæœ›æœ‰èƒ½åŠ›çš„çŒ¿çˆ¸ä»¬åŠ å…¥ï¼Œæˆ‘ä»¬ä¸€èµ·å°†å…¶å®Œå–„ï¼Œå¸®åŠ©ä¸‹ä¸€ä»£å…»æˆä¸€ä¸ªå¥½çš„è‡ªå¾‹èƒ½åŠ›ï¼Œæ­¤Appå·²åœ¨githubä¸Šå¼€æºï¼Œæ¬¢è¿è´¡çŒ®ï¼Œé¡¹ç›®åœ°å€<a href="https://github.com/hunshenshi/timeup.git">https://github.com/hunshenshi/timeup.git</a></p><h2 id="åè®°"><a href="#åè®°" class="headerlink" title="åè®°"></a>åè®°</h2><p>å…¶å®å†™è¿™ä¸ªAppå¹¶ä¸å®Œå…¨æ˜¯ä¸ºäº†å®Œå…¨é˜»æ­¢ä»–ç©å¹³æ¿ï¼Œåªæ˜¯ä¸ºäº†åŸ¹å…»ä»–è§£å†³é—®é¢˜ï¼Œå–„äºæ€è€ƒçš„èƒ½åŠ›ï¼Œè®©ä»–çŸ¥é“å¦‚ä½•å»è¾¾åˆ°è‡ªå·±çš„ç›®çš„ã€‚å› ä¸ºè¿™ä¸ªAppæœ¬èº«æ¯”è¾ƒç®€å•ï¼Œå¯èƒ½åªèƒ½é˜»æ­¢ä»–å‡ å¤©ï¼Œç„¶åä»–ä¼šå‘ç°è¿™ä¸ªAppçš„é€»è¾‘æ¼æ´ï¼Œç„¶åæˆ‘å†æƒ³åŠæ³•æŠŠè¿™ä¸ªæ¼æ´å µä¸Šï¼Œç»§ç»­ç­‰å¾…ä»–å‘ç°æ–°çš„æ¼æ´ï¼Œå¸Œæœ›åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­èƒ½åŸ¹å…»ä»–çš„å¥½å¥‡æ¬²ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> android </tag>
            
            <tag> app </tag>
            
            <tag> é˜²æ²‰è¿· </tag>
            
            <tag> ç”Ÿæ´» </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>elasticsearchè¿ç»´è¸©å‘</title>
      <link href="/elasticsearch-op.html"/>
      <url>/elasticsearch-op.html</url>
      
        <content type="html"><![CDATA[<p>æ¥è§¦ESä¹Ÿå°åŠå¹´äº†ï¼ŒESè™½ç„¶ä½¿ç”¨æ–¹ä¾¿ï¼Œè¿ç»´ç®€å•ä½†æ˜¯é›†ç¾¤è§„æ¨¡å’Œæ•°æ®é‡å¤§çš„è¯è¿ç»´ä¹Ÿå¾ˆå¤´ç–¼ï¼Œè¿™é‡Œæ¢³ç†ä¸‹è¿™åŠå¹´çš„è¿ç»´ç»éªŒã€‚</p><span id="more"></span><h2 id="ç£ç›˜å‘"><a href="#ç£ç›˜å‘" class="headerlink" title="ç£ç›˜å‘"></a>ç£ç›˜å‘</h2><p>é›†ç¾¤éšç€ä½¿ç”¨ï¼Œæ•°æ®ä¼šç§¯ç´¯è¶Šæ¥è¶Šå¤šï¼Œç£ç›˜æ¶ˆè€—ä¹Ÿä¼šè¶Šæ¥è¶Šå¤§ï¼Œæ­¤æ—¶ä¸ºäº†ä¿æŠ¤æŸä¸ªç£ç›˜è¢«å†™æ»¡ï¼Œéœ€è¦ç»™ç£ç›˜è®¾ç½®é˜ˆå€¼ï¼Œé…ç½®é¡¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># ç£ç›˜ä½¿ç”¨è¶…è¿‡æ­¤å€¼ï¼Œå°†ä¸å†æ¥å—shardçš„å‡è¡¡ï¼Œåªæ¥å—ä¸»shardçš„å†™å…¥</span></span><br><span class="line">cluster.routing.allocation.disk.watermark.low</span><br><span class="line"><span class="comment"># ç£ç›˜ä½¿ç”¨è¶…è¿‡æ­¤å€¼ï¼Œç£ç›˜ä¸Šçš„shardå¼€å§‹å‘å…¶ä»–ç£ç›˜è¿ç§»ï¼Œé‡Šæ”¾ç£ç›˜ç©ºé—´</span></span><br><span class="line">cluster.routing.allocation.disk.watermark.high</span><br><span class="line"><span class="comment"># ç£ç›˜ä½¿ç”¨è¶…è¿‡æ­¤å€¼ï¼ŒèŠ‚ç‚¹å°†ä¸å†æä¾›æœåŠ¡</span></span><br><span class="line">cluster.routing.allocation.disk.watermark.flood_stage</span><br></pre></td></tr></table></figure><p>é…ç½®é¡¹å€¼çš„é»˜è®¤å½¢å¼æ˜¯ç™¾åˆ†æ¯”ï¼Œä¹Ÿå¯ä»¥æ˜¯ç»å¯¹å€¼ã€‚<br>å¦‚æœé›†ç¾¤è¿›è¡Œäº†æ‰©å®¹ï¼Œå„ä¸ªæœºå™¨çš„ç£ç›˜å¤§å°ä¸ä¸€ï¼Œæ­¤æ—¶ä¾ç„¶ä½¿ç”¨ç™¾åˆ†æ¯”çš„è¯å¯¹ç£ç›˜å¤§æœºå™¨å°±ä¼šé€ æˆå­˜å‚¨ç©ºé—´æµªè´¹ï¼Œå°†ç™¾åˆ†æ¯”æ”¹ä¸ºç»å¯¹å€¼å¯ä»¥å……åˆ†ä½¿ç”¨å„ä¸ªä¸åŒå¤§å°çš„ç£ç›˜ã€‚</p><h2 id="shardé‡æ–°åˆ†é…"><a href="#shardé‡æ–°åˆ†é…" class="headerlink" title="shardé‡æ–°åˆ†é…"></a>shardé‡æ–°åˆ†é…</h2><p>é›†ç¾¤ä¸­æŸä¸ªDataNodeå®ä¾‹æŒ‚æ‰æˆ–è€…é›†ç¾¤ä¸­æŸä¸ªç£ç›˜çš„ä½¿ç”¨ç‡è¾¾åˆ°ä¸Šçº¿ï¼Œå°±éœ€è¦å¯¹shardè¿›è¡Œé‡æ–°åˆ†é…ï¼Œæœ‰å‡ ä¸ªé…ç½®é¡¹å¯ä»¥å¯¹å…¶è°ƒæ•´ï¼ŒåŠ å¿«åˆ†é…çš„é€Ÿåº¦ï¼Œé…ç½®é¡¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å®ä¾‹ç”¨æ¥æ§åˆ¶æ¥æ”¶å’Œåˆ†å‘shardçš„çº¿ç¨‹æ•°</span></span><br><span class="line">cluster.routing.allocation.node_concurrent_recoveries</span><br><span class="line"><span class="comment"># æ§åˆ¶ä»æœ¬åœ°æ¢å¤ä¸»åˆ†ç‰‡çš„çº¿ç¨‹æ•°</span></span><br><span class="line">cluster.routing.allocation.node_initial_primaries_recoveries</span><br></pre></td></tr></table></figure><p><code>node_concurrent_recoveries</code>ä¸å®œè®¾ç½®çš„å¤ªå¤§ï¼Œå¦‚æœé›†ç¾¤è§„æ¨¡æ²¡æœ‰è¶…è¿‡ç™¾å°ï¼Œè®¾ç½®ä¸ºDataNodeå®ä¾‹ä¸ªæ•°çš„ä¸€åŠå³å¯ã€‚<br><code>node_initial_primaries_recoveries</code>æ­¤å€¼å¯æ ¹æ®æœºå™¨é…ç½®è¿›è¡Œè®¾ç½®å³å¯ã€‚</p><h2 id="é‡å¯å‘"><a href="#é‡å¯å‘" class="headerlink" title="é‡å¯å‘"></a>é‡å¯å‘</h2><p>å½“é›†ç¾¤å®ä¾‹å®•æœºå‡ºç°é›ªå´©æ— æ³•æ¢å¤æ—¶ï¼Œéœ€è¦é‡å¯é›†ç¾¤è¿›è¡Œæ¢å¤ã€‚ä½†æ˜¯ç”±äºESé‡å¯ä¹‹åéœ€è¦åŠ è½½æ‰€æœ‰ç´¢å¼•çš„shardä¹‹åé›†ç¾¤æ‰å¯æ­£å¸¸ä½¿ç”¨ï¼Œè€ŒESä¼šè‡ªåŠ¨å¯¹ç´¢å¼•shardæ ¹æ®ç°æœ‰çš„é›†ç¾¤çŠ¶æ€å¯¹shardè¿›è¡Œé‡åˆ†é…ï¼Œè¿™ä¸ªåˆ†é…è¿‡ç¨‹æ˜¯æ¯”è¾ƒè€—æ—¶è€Œä¸”é’ˆå¯¹<strong>é›†ç¾¤é‡å¯</strong>çš„åœºæ™¯æ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼Œå› ä¸ºé›†ç¾¤åªæ˜¯é‡å¯ï¼Œshardå¹¶æ²¡æœ‰ä¸¢å¤±ã€‚<br>æ‰€ä»¥åœ¨é›†ç¾¤é‡å¯ä¹‹æ—¶å¯ä»¥å°†<code>cluster.routing.allocation.enable</code>è®¾ç½®ä¸ºnoneï¼Œç­‰æ‰€æœ‰çš„DataNodeå®ä¾‹å¯åŠ¨ä¹‹åå†å°†å…¶è®¾ç½®ä¸ºallã€‚</p><h2 id="å¤§æŸ¥è¯¢"><a href="#å¤§æŸ¥è¯¢" class="headerlink" title="å¤§æŸ¥è¯¢"></a>å¤§æŸ¥è¯¢</h2><p>æ•°æ®æŸ¥è¯¢é‡å¤§ï¼Œä¼šè§¦å‘ESçš„å†…å­˜ä¿æŠ¤æœºåˆ¶è¿›è¡Œç†”æ–­ï¼Œå¯ä»¥å¢åŠ å•ç‹¬çš„æŸ¥è¯¢å®¢æˆ·ç«¯ï¼Œå¹¶å¢åŠ å®¢æˆ·ç«¯å®ä¾‹çš„å†…å­˜ã€‚éšåè®¾ç½®é›†ç¾¤é…ç½®ï¼Œé…ç½®é¡¹ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># </span></span><br><span class="line">indices.breaker.total.limit</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">indices.breaker.fielddata.limit</span><br><span class="line"><span class="comment"># </span></span><br><span class="line">indices.breaker.request.limit</span><br></pre></td></tr></table></figure><h2 id="æ’æŸ¥é—®é¢˜å·¥å…·"><a href="#æ’æŸ¥é—®é¢˜å·¥å…·" class="headerlink" title="æ’æŸ¥é—®é¢˜å·¥å…·"></a>æ’æŸ¥é—®é¢˜å·¥å…·</h2><ul><li>é›†ç¾¤çŠ¶æ€å‘ç”Ÿå˜åŒ–<ul><li>ä½¿ç”¨å‘½ä»¤<code>ip:9200/_cluster/health?pretty</code>æŸ¥è¯¢é›†ç¾¤çŠ¶æ€ï¼Œå¦‚æœé›†ç¾¤çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œå¯ä»¥ä»ä¸­åˆ†æåŸå› </li></ul></li><li>èŠ‚ç‚¹æ­£å¸¸ï¼Œä½†æ˜¯é›†ç¾¤çŠ¶æ€ä¸æ˜¯green<ul><li>ä½¿ç”¨å‘½ä»¤<code>ip:9200/_cat/indices?v</code>ï¼Œæ­¤å‘½ä»¤ä¼šè¿”å›æ‰€æœ‰ç´¢å¼•çš„çŠ¶æ€ï¼Œæ‰¾åˆ°égreençš„ç´¢å¼•ï¼Œç„¶åå…·ä½“åˆ†æã€‚</li></ul></li><li>æŸ¥è¯¢åˆ†ç‰‡å¤±è´¥åŸå› <ul><li>å‘½ä»¤<code>ip:9200/_cluster/allocation/explain</code></li></ul></li><li>æŸ¥è¯¢ç´¢å¼•åˆ†ç‰‡çŠ¶æ€<ul><li>å‘½ä»¤<code>ip:9200/_cat/shards/index_name?v</code></li></ul></li></ul>]]></content>
      
      
      <categories>
          
          <category> bigdata </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> ElasticSearch </tag>
            
            <tag> è¿ç»´ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golangæŒ‡é’ˆ*å’Œå–å€&amp;å‚»å‚»åˆ†ä¸æ¸…æ¥š</title>
      <link href="/golang-point-address.html"/>
      <url>/golang-point-address.html</url>
      
        <content type="html"><![CDATA[<p>golangä¸­æœ‰æŒ‡é’ˆçš„æ¦‚å¿µï¼Œæœ‰æŒ‡é’ˆç›¸å¯¹çš„å°±æœ‰å–å€ï¼Œä½•æ—¶ä½¿ç”¨æŒ‡é’ˆä½•æ—¶ä½¿ç”¨å–å€å¯¹äºåˆšæ¥è§¦çš„åŒå­¦æ€»æ˜¯æœ‰ç‚¹å‚»å‚»åˆ†ä¸æ¸…æ¥šã€‚<br>æœ¬ç¯‡ä¸»è¦ä»‹ç»ä¸‹æŒ‡é’ˆå’Œå–å€çš„æ¦‚å¿µå’ŒåŒºåˆ«ã€‚</p><span id="more"></span><p>æŒ‡é’ˆç±»ä¼¼äºå˜é‡å’Œå¸¸é‡ï¼Œåœ¨ä½¿ç”¨æŒ‡é’ˆå‰ä½ éœ€è¦å£°æ˜æŒ‡é’ˆã€‚æŒ‡é’ˆå£°æ˜æ ¼å¼å¦‚ä¸‹ï¼š<code>var name *Type</code>ã€‚<br>æŒ‡é’ˆæ˜¯æŒ‡å‘ä¸€ä¸ª<strong>å€¼çš„å†…å­˜åœ°å€</strong>ï¼Œä¹Ÿå°±æ˜¯è¯´æŒ‡é’ˆå˜é‡å­˜æ”¾çš„æ˜¯æŸä¸ªå€¼æˆ–è€…å¯¹è±¡çš„<strong>å†…å­˜åœ°å€</strong>ï¼Œå³æŒ‡é’ˆå˜é‡å ç”¨å­—èŠ‚çš„å¤§å°ä¸æ‰€æŒ‡å‘çš„å€¼çš„å¤§å°æ— å…³ã€‚<em>å½“ä¸€ä¸ªæŒ‡é’ˆè¢«å®šä¹‰åæ²¡æœ‰åˆ†é…åˆ°ä»»ä½•å˜é‡æ—¶ï¼Œå®ƒçš„é»˜è®¤å€¼ä¸ºnilã€‚</em></p><p>æŒ‡é’ˆå˜é‡å­˜æ”¾çš„æ˜¯ä¸€ä¸ªå€¼çš„å†…å­˜åœ°å€ï¼Œé‚£å¦‚ä½•è·å–ä¸€ä¸ªå˜é‡çš„å†…å­˜åœ°å€å‘¢ï¼Ÿé‚£å°±éœ€è¦ä½¿ç”¨å–å€ç¬¦å·<code>&amp;</code>ã€‚<br>å°†ä¸€ä¸ªå€¼çš„å†…å­˜åœ°å€é€šè¿‡<code>&amp;</code>èµ‹å€¼ç»™äº†æŒ‡é’ˆï¼Œé‚£åˆåº”è¯¥å¦‚ä½•é€šè¿‡æŒ‡é’ˆæ¥è¯»å–å¯¹åº”çš„å€¼ï¼Ÿéœ€è¦ä½¿ç”¨ç¬¦å·<code>*</code>ï¼Œéœ€è¦ä¸æŒ‡é’ˆå£°æ˜æ—¶çš„<code>*</code>è¿›è¡ŒåŒºåˆ«ã€‚</p><p>çœ‹ä¸ªä»£ç æ„Ÿå—ä¸‹å§ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// å£°æ˜ä¸€ä¸ªæŒ‡é’ˆ</span></span><br><span class="line"><span class="keyword">var</span> addr *<span class="keyword">string</span></span><br><span class="line"><span class="keyword">var</span> house = <span class="string">&quot;Malibu Point 10880, 90265&quot;</span></span><br><span class="line"><span class="comment">// é€šè¿‡&amp;å°†ä¸€ä¸ªå˜é‡çš„å†…å­˜åœ°å€èµ‹å€¼ç»™æŒ‡é’ˆ</span></span><br><span class="line">addr = &amp;house</span><br><span class="line"><span class="comment">// é€šè¿‡*è·å–æŒ‡é’ˆä¸­å­˜å‚¨çš„åœ°å€å¯¹åº”çš„å€¼</span></span><br><span class="line">value := *addr</span><br><span class="line">fmt.Printf(<span class="string">&quot;addr type: %T\n&quot;</span>, addr)</span><br><span class="line"><span class="comment">// è¾“å‡ºæŒ‡é’ˆå­˜å‚¨çš„å†…å­˜åœ°å€ï¼Œä¹Ÿå°±æ˜¯houseçš„å†…å­˜åœ°å€</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;address: %p\n&quot;</span>, addr)</span><br><span class="line"><span class="comment">// è¾“å‡ºaddrè‡ªèº«çš„å†…å­˜åœ°å€</span></span><br><span class="line">fmt.Printf(<span class="string">&quot;address: %p\n&quot;</span>, &amp;addr)</span><br><span class="line">fmt.Printf(<span class="string">&quot;value type: %T\n&quot;</span>, value)</span><br><span class="line">fmt.Printf(<span class="string">&quot;value: %s\n&quot;</span>, value)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// addr type: *string</span></span><br><span class="line"><span class="comment">// address: 0xc000010200</span></span><br><span class="line"><span class="comment">// address: 0xc00000e028</span></span><br><span class="line"><span class="comment">// value type: string</span></span><br><span class="line"><span class="comment">// value: Malibu Point 10880, 90265</span></span><br></pre></td></tr></table></figure><p>ä»£ç å…ˆé€šè¿‡æŒ‡é’ˆå£°æ˜æ–¹å¼å£°æ˜äº†ä¸€ä¸ª<code>addr</code>æŒ‡é’ˆï¼Œåˆé€šè¿‡å–å€ç¬¦å·<code>&amp;</code>å°†houseçš„åœ°å€èµ‹å€¼ç»™<code>addr</code>ï¼Œç„¶ååˆé€šè¿‡<code>*</code>å°†æŒ‡é’ˆ<code>addr</code>å­˜å‚¨å†…å­˜åœ°å€å¯¹åº”çš„å€¼èµ‹å€¼ç»™æ™®é€šå˜é‡<code>value</code>ã€‚ç”±äºæŒ‡é’ˆ<code>addr</code>å˜é‡å­˜å‚¨çš„æ˜¯å˜é‡<code>house</code>çš„å†…å­˜åœ°å€ï¼Œæ‰€ä»¥è¾“å‡ºçš„<code>addr</code>çš„å€¼ä¸ºä¸€ä¸ªå†…å­˜åœ°å€ï¼Œè€Œåˆå› ä¸ºæŒ‡é’ˆ<code>addr</code>æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªå˜é‡ï¼Œä¹Ÿéœ€è¦ä¸€ä¸ªå†…å­˜å—æ¥å­˜å‚¨è‡ªå·±ï¼Œæ‰€ä»¥é€šè¿‡å–å€ç¬¦å·<code>&amp;</code>å¾—åˆ°çš„åœ°å€æ˜¯æŒ‡é’ˆå˜é‡çš„å†…å­˜åœ°å€ã€‚</p><p>åˆçœ‹ä¸Šé¢çš„ä»£ç ï¼Œå¯¹å…¶ä¸­çš„<code>*</code>å’Œ<code>&amp;</code>æ˜¯ä¸æ˜¯å‚»å‚»åˆ†ä¸æ¸…æ¥šã€‚<code>&amp;</code>åŠŸèƒ½æ¯”è¾ƒå•ä¸€ï¼Œå°±æ˜¯å–å€ï¼Œè·å–å˜é‡çš„å†…å­˜åœ°å€ã€‚<code>*</code>æœ‰<em>ä¸¤ç§å«ä¹‰</em>ï¼Œç¬¬ä¸€ç§æ˜¯åœ¨æŒ‡é’ˆå£°æ˜æ—¶è·Ÿåœ¨å˜é‡çš„åé¢ï¼Œç´§è·Ÿå˜é‡ç±»å‹ï¼Œä»£è¡¨è¯¥å˜é‡æ˜¯ä¸€ä¸ªæŒ‡é’ˆå˜é‡ï¼Œå¦‚æœä½¿ç”¨<code>%p</code>æ¥è¾“å‡ºçš„è¯ï¼Œå®ƒå°†æ˜¯ä¸€ä¸ª16è¿›åˆ¶æ•°ï¼Œç¬¬äºŒç§æ˜¯ç´§è·ŸæŒ‡é’ˆå˜é‡ï¼Œå‡ºç°åœ¨æŒ‡é’ˆå˜é‡çš„å‰é¢ï¼Œä»£è¡¨è·å–è¯¥æŒ‡é’ˆå­˜å‚¨å†…å­˜åœ°å€çš„å€¼ï¼Œä¸€èˆ¬æ˜¯ä¸€ä¸ªå’ŒæŒ‡é’ˆç±»å‹ä¸€è‡´çš„å˜é‡æˆ–è€…å¸¸é‡ã€‚åœ¨ä¸Šé¢çš„demoä»£ç ä¸­éƒ½æœ‰ä½“ç°ã€‚</p><blockquote><p>Tips<br>goä¸­ä½•æ—¶ä½¿ç”¨æŒ‡é’ˆï¼Ÿ</p></blockquote><ul><li>å½“ç»“æ„ä½“è¾ƒå¤§çš„æ—¶å€™ä½¿ç”¨æŒ‡é’ˆä¼šæ›´é«˜æ•ˆï¼Œå¯ä»¥é¿å…å†…å­˜æ‹·è´</li><li>å¦‚æœè¦ä¿®æ”¹ç»“æ„ä½“å†…éƒ¨çš„æ•°æ®æˆ–çŠ¶æ€å¿…é¡»ä½¿ç”¨æŒ‡é’ˆ</li><li>å¦‚æœæ–¹æ³•çš„receiveræ˜¯mapã€slice ã€channelç­‰å¼•ç”¨ç±»å‹ä¸è¦ä½¿ç”¨æŒ‡é’ˆ</li><li>å¦‚æœè¯¥å‡½æ•°éœ€è¦å°†ä¼ å…¥å˜é‡çš„ä¿®æ”¹çŠ¶æ€ä¼ é€’å‡ºå»ï¼Œå¯ä»¥ä½¿ç”¨æŒ‡é’ˆ</li></ul><!--åˆ‡ç‰‡sliceã€å­—å…¸mapã€ç®¡é“channelå¼•ç”¨ç±»å‹çš„ç‰¹ç‚¹æ˜¯ï¼šå˜é‡å­˜å‚¨çš„æ˜¯ä¸€ä¸ªåœ°å€ï¼Œè¿™ä¸ªåœ°å€å¯¹åº”çš„ç©ºé—´é‡Œæ‰æ˜¯çœŸæ­£å­˜å‚¨çš„å€¼ï¼Œå†…å­˜é€šå¸¸åœ¨å †ä¸­åˆ†é…golangä¸­åˆ°åº•æœ‰æ²¡æœ‰å¼•ç”¨ç±»å‹æŒ‰ç…§Golangçš„è¯´æ³•,Golangä¸­æ‰€æœ‰çš„ç±»å‹éƒ½æ˜¯å±äºå€¼ç±»å‹,ä½†æ˜¯æœ‰å‡ ä¸ªç±»å‹æ¯”è¾ƒç‰¹æ®Š,è¡¨ç°å‡ºå¼•ç”¨ç±»å‹çš„ç‰¹å¾go life, golang[å¤Ÿæµª]unsafeæ˜¯ä»€ä¹ˆå¼•ç”¨ç±»å‹ æ˜¯ä»€ä¹ˆï¼Œ å€¼ç±»å‹å¼•ç”¨ç±»å‹æ˜¯ä»€ä¹ˆï¼Ÿgolangä¸­æ˜¯å¦æœ‰å¼•ç”¨ç±»å‹ï¼ŸGoè¯­è¨€ä¸­æœ‰4ä¸ªç±»å‹æ¯”è¾ƒç‰¹åˆ«ï¼Œçœ‹èµ·æ¥åƒå¼•ç”¨ç±»å‹å¼•ç”¨ç±»å‹ ä¸ å¼•ç”¨è¯­ä¹‰å¼•ç”¨ï¼šå°±æ˜¯å˜é‡çš„ä¸€ä¸ªåˆ«åã€‚java å¼•ç”¨å˜é‡-->]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> golang </tag>
            
            <tag> æŒ‡é’ˆ </tag>
            
            <tag> å–å€ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golangéšæ³¢é€æµä¹‹cache2goçŸ¥è¯†ç‚¹è§£è¯»</title>
      <link href="/golang-cache2go-sec.html"/>
      <url>/golang-cache2go-sec.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/golang-cache2go-src.html">ä¸Šç¯‡</a>ä»‹ç»äº†cache2goçš„ä»£ç é€»è¾‘ï¼Œæ¢³ç†ä»£ç é€»è¾‘æ—¶ä¹Ÿèƒ½ä»ä¸­äº†è§£golangçš„ä¸€äº›è¯­æ³•ä»¥åŠä½¿ç”¨æŠ€å·§ï¼Œæœ¬ç¯‡é›†ä¸­å°†æºç ä¸­æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹æ¢³ç†ä¸‹ã€‚</p><span id="more"></span><h2 id="åŸºç¡€è¯­æ³•"><a href="#åŸºç¡€è¯­æ³•" class="headerlink" title="åŸºç¡€è¯­æ³•"></a>åŸºç¡€è¯­æ³•</h2><blockquote><p>ç»“æ„ä½“</p></blockquote><p>åœ¨mycachedapp.goæ–‡ä»¶ä¸­ï¼Œçœ‹åˆ°çš„ç¬¬ä¸€è¡Œæœ‰æ•ˆä»£ç æ˜¯<code>type myStruct struct</code>ï¼Œæ„Ÿè§‰æœ‰ç‚¹åƒCè¯­è¨€ä¸­çš„ç»“æ„ä½“ã€‚<br>è¿™ä¸ªè¯­å¥å—å®šä¹‰äº†ä¸€ä¸ªç»“æ„ä½“ï¼Œç»“æ„ä½“æ˜¯golangä¸­ä¸€ä¸ªæ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ç‚¹ï¼ŒåŠŸèƒ½ç±»ä¼¼äºJAVAä¸­çš„ç±»ã€‚</p><p>ä½¿ç”¨<code>type xName struct&#123;&#125;</code>å®šä¹‰ä¸€ä¸ªç»“æ„ä½“ï¼Œmycachedapp.goä¸­ç»“æ„ä½“ç›¸å…³çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> myStruct <span class="keyword">struct</span> &#123;</span><br><span class="line">text     <span class="keyword">string</span></span><br><span class="line">moreData []<span class="keyword">byte</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®åŠ›åŒ–myStructçš„å¯¹è±¡</span></span><br><span class="line">val := myStruct&#123;<span class="string">&quot;This is a test!&quot;</span>, []<span class="keyword">byte</span>&#123;&#125;&#125;</span><br></pre></td></tr></table></figure><!-- // åŒºåˆ«ï¼Œvalç›¸å½“äºä¸€ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªå¼•ç”¨ç±»å‹val := &myStruct{"This is a test!", []byte{}}--><p>ä¸Šè¿°ä»£ç å£°æ˜äº†ä¸€ä¸ªåå­—ä¸º<code>myStruct</code>çš„ç»“æ„ä½“ï¼Œå…¶æˆå‘˜å˜é‡ä¸º<code>string</code>ç±»å‹çš„<code>text</code>å’Œ<code>byte</code>ç±»å‹çš„æ•°ç»„<code>moreData</code>ã€‚<br>ç´§ç€è¿™åˆå§‹åŒ–äº†ä¸€ä¸ª<code>myStruct</code>å¯¹è±¡å¹¶åœ¨åˆå§‹åŒ–æ—¶å¯¹æˆå‘˜å˜é‡èµ‹å€¼ï¼Œé»˜è®¤æ˜¯æŒ‰ç…§å˜æˆå£°æ˜çš„é¡ºåºä¾æ¬¡èµ‹å€¼ï¼Œä¹Ÿå¯ä»¥æ˜¾ç¤ºçš„æŒ‡å®šå˜é‡è¿›è¡Œèµ‹å€¼ï¼Œä¾‹å¦‚<code>val := myStruct&#123;text: &quot;This xx&quot;&#125;</code>ï¼Œæœªèµ‹å€¼çš„ä¸ºç±»å‹çš„é»˜è®¤å€¼ï¼Œæœ‰ç‚¹ç±»ä¼¼pythonã€‚</p><p>ç»“æ„ä½“é™¤äº†å¯ä»¥å®šä¹‰è‡ªå·±çš„æˆå‘˜å˜é‡ï¼Œä¹Ÿå¯ä»¥å®šä¹‰æˆå‘˜æ–¹æ³•ã€‚æˆå‘˜å‘æ–¹æ³•çš„å®šä¹‰ä¸æ™®é€šå‡½æ•°çš„å®šä¹‰ç±»ä¼¼ï¼Œåªæ˜¯åœ¨å…³é”®å­—<code>func</code>å’Œå‡½æ•°åä¹‹é—´å¢åŠ äº†å‡½æ•°å½’å±å“ªä¸ªç»“æ„ä½“çš„ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®šä¹‰ä¸€ä¸ªç»“æ„ä½“</span></span><br><span class="line"><span class="keyword">type</span> Rect <span class="keyword">struct</span> &#123; </span><br><span class="line">x, y <span class="keyword">float64</span></span><br><span class="line">width, height <span class="keyword">float64</span> </span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// å®šä¹‰è¯¥ç»“æ„ä½“çš„æˆå‘˜æ–¹æ³•</span></span><br><span class="line"><span class="comment">// åœ¨å…³é”®å­—funcå’Œæ–¹æ³•åä¹‹é—´å¢åŠ æ–¹æ³•å½’å±çš„ç»“æ„ä½“</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(r *Rect)</span> <span class="title">Area</span><span class="params">()</span> <span class="title">float64</span></span> &#123; </span><br><span class="line"><span class="keyword">return</span> r.width * r.height</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯ç»“æ„ä½“è™½ç„¶ç±»ä¼¼å…¶ä»–è¯­è¨€ä¸­çš„ç±»ï¼Œä½†æ˜¯golangç»“æ„ä½“ä¸­å¹¶æ²¡æœ‰æ„é€ å‡½æ•°çš„æ¦‚å¿µï¼Œ<strong>å¯¹è±¡çš„åˆ›å»ºé€šå¸¸äº¤ç”±ä¸€ä¸ªå…¨å±€çš„åˆ›å»ºå‡½æ•°æ¥å®Œæˆ</strong>ï¼Œä»¥<code>NewXXX</code>æ¥å‘½åï¼Œè¡¨ç¤ºâ€æ„é€ å‡½æ•°â€ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å…¨å±€å‡½æ•°</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewRect</span><span class="params">(x, y, width, height <span class="keyword">float64</span>)</span> *<span class="title">Rect</span></span> &#123; </span><br><span class="line"><span class="keyword">return</span> &amp;Rect&#123;x, y, width, height&#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// é€šè¿‡&quot;æ„é€ å‡½æ•°&quot;åˆ›å»ºRect</span></span><br><span class="line">rect := NewRect(<span class="number">3.3</span>, <span class="number">4.4</span>, <span class="number">5.5</span>, <span class="number">6.6</span>)</span><br></pre></td></tr></table></figure><p>æ–°ç±»å‹å¯ä»¥åƒç»“æ„ä½“é‚£æ ·æ–°å»ºï¼Œä¹Ÿå¯ä»¥åŸºäºå·²æœ‰çš„ç±»å‹è¿›è¡Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç±»å‹ï¼Œè¯­æ³•ä¸º<code>type NewType Type</code>ï¼Œ<code>cachetable.go</code>æ–‡ä»¶ä¸­çš„<code>CacheItemPairList</code>å°±æ˜¯åŸºäºå·²æœ‰ç±»å‹è¿›è¡Œæ–°å»ºçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CacheItemPair <span class="keyword">struct</span> &#123;</span><br><span class="line">Key         <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">AccessCount <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CacheItemPairList []CacheItemPair</span><br></pre></td></tr></table></figure><p>ä¸åŸºäºå·²æœ‰ç±»å‹æ–°å»ºç±»å‹çš„å†™æ³•ç±»ä¼¼çš„æ˜¯<code>ç±»å‹åˆ«å</code>ï¼Œå…¶è¯­æ³•ä¸º<code>type alias = Type</code>ï¼Œæ³¨æ„è¿™é‡Œæ˜¯ç­‰å·ã€‚è€Œä¸”æ–°å»ºç±»å‹æ—¶Typeå·²ç»å‘ç”Ÿäº†å˜åŒ–ï¼Œè€Œåˆ«åçš„Typeå¹¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚</p><blockquote><p>æ•°ç»„ VS åˆ‡ç‰‡</p></blockquote><p>æ•°ç»„å‡ ä¹æ˜¯æ‰€æœ‰ç¼–ç¨‹è¯­è¨€ä¸­å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œæƒ³å¿…å¤§å®¶å¯¹å…¶ä¹Ÿæ¯”è¾ƒäº†è§£ï¼Œå¯ä»¥é€šè¿‡ç´¢å¼•å¿«é€Ÿè®¿é—®å…¶å€¼ã€‚æ•°ç»„çš„å£°æ˜æ–¹å¼ä¸º<code>var variable_name [SIZE] variable_type</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> x [<span class="number">32</span>]<span class="keyword">byte</span> =</span><br><span class="line"><span class="keyword">var</span> y [<span class="number">1000</span>]*<span class="keyword">float64</span> </span><br><span class="line"><span class="keyword">var</span> z [<span class="number">3</span>][<span class="number">5</span>]<span class="keyword">int</span> </span><br><span class="line"><span class="keyword">var</span> w [<span class="number">2</span>][<span class="number">2</span>][<span class="number">2</span>]<span class="keyword">float64</span></span><br><span class="line"><span class="keyword">var</span> a [<span class="number">10</span>]<span class="keyword">int</span> = [<span class="number">10</span>]<span class="keyword">int</span>&#123;&#125;</span><br><span class="line">arr := [...]<span class="keyword">int</span>&#123;<span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">4</span>,<span class="number">5</span>&#125; <span class="comment">// é•¿åº¦ä¸º5ï¼Œ...ä»£è¡¨è‡ªåŠ¨è®¡ç®—é•¿åº¦</span></span><br></pre></td></tr></table></figure><p>æ•°ç»„åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­æœ‰ä¸ªè¯Ÿç—…å°±æ˜¯é•¿åº¦åœ¨åˆå§‹åŒ–æ—¶éœ€è¦æŒ‡å®šï¼Œå¹¶ä¸”åç»­æ— æ³•æ”¹å˜ã€‚ä¸ºäº†è§£å†³æ­¤é—®é¢˜å„ç§è¯­è¨€éƒ½å¢åŠ å…¶å®ƒæ•°æ®ç»“æ„ï¼Œgolangä¸­å¢åŠ çš„æ˜¯åˆ‡ç‰‡(slice)ã€‚<br>åˆ‡ç‰‡æœ‰ä¸€ä¸ªåˆå§‹æ•°æ®é•¿åº¦ï¼Œä½¿ç”¨<code>len</code>å‡½æ•°è·å–ï¼Œè¿˜æœ‰ä¸€ä¸ªé¢„ç•™ç©ºé—´é•¿åº¦ï¼Œé¢„ç•™ç©ºé—´ç”¨å…‰ä¹‹åä¼šè‡ªåŠ¨æ‰©å®¹ï¼Œä½¿ç”¨<code>cap</code>å‡½æ•°è·å–é¢„ç•™ç©ºé—´é•¿åº¦ã€‚åˆ‡ç‰‡çš„åˆ›å»ºæœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯ç›´æ¥åˆ›å»ºï¼Œå¦ä¸€ç§æ˜¯æ ¹æ®æ•°ç»„åˆ›å»ºã€‚</p><ul><li>ç›´æ¥åˆ›å»ºéœ€è¦ä½¿ç”¨å…³é”®å­—<code>make</code>ï¼Œä»£ç ä¸º<code>var mySlice []int or mySlice1 := make([]int, 5)</code></li><li>æ ¹æ®æ•°ç»„åˆ›å»ºçš„è¯éœ€è¦å…ˆåˆ›å»ºä¸€ä¸ªæ•°æ®ï¼Œç„¶åå°†æ•°ç»„çš„å€¼èµ‹å€¼ç»™åˆ‡ç‰‡ï¼Œä»£ç ä¸º</li></ul><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> myArray [<span class="number">10</span>]<span class="keyword">int</span> = [<span class="number">10</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>, <span class="number">6</span>, <span class="number">7</span>, <span class="number">8</span>, <span class="number">9</span>, <span class="number">10</span>&#125; <span class="comment">// åŸºäºæ•°ç»„åˆ›å»ºä¸€ä¸ªæ•°ç»„åˆ‡ç‰‡</span></span><br><span class="line"><span class="keyword">var</span> mySlice []<span class="keyword">int</span> = myArray[:<span class="number">5</span>]</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line">mySlice := []<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>&#125; <span class="comment">// æ³¨æ„è¿™é‡Œä¸­æ‹¬å·ä¸­æ²¡æœ‰é•¿åº¦ï¼Œå¦‚æœæœ‰é•¿åº¦å°±å˜æˆæ•°ç»„çš„åˆ›å»ºäº†</span></span><br></pre></td></tr></table></figure><p>æ•°ç»„å’Œåˆ‡ç‰‡è¿˜æœ‰ä¸€ä¸ªåŒºåˆ«å°±æ˜¯<em>æ•°ç»„ä½œä¸ºå‚æ•°æˆ–è€…å˜é‡ä¹‹é—´èµ‹å€¼æ—¶ï¼Œæ˜¯å¤åˆ¶ä¸€ä»½ï¼Œç›¸äº’ä¹‹é—´ä¸å½±å“</em>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> a = [<span class="number">3</span>]<span class="keyword">int</span>&#123;<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>&#125; <span class="keyword">var</span> b = a</span><br><span class="line">b[<span class="number">1</span>]++</span><br><span class="line">fmt.Println(a, b) <span class="comment">// aå’Œbä¹‹é—´ä¸å—å½±å“ï¼Œprint [1 2 3] [1 3 3]</span></span><br></pre></td></tr></table></figure><p>ä½†æ˜¯<strong>åˆ‡ç‰‡å´å¯ä»¥åœ¨å‚æ•°ä¼ é€’ä¸­ï¼Œå°†ä¿®æ”¹çš„ç»“æœä½œç”¨åœ¨åŒä¸€ä»½æ•°æ®ä¸Š</strong>ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">slice1 := []<span class="keyword">int</span>&#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;</span><br><span class="line">fmt.Println(slice1)</span><br><span class="line">modify(slice1)</span><br><span class="line">fmt.Println(slice1) <span class="comment">// è¾“å‡º1,6,6</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modify</span><span class="params">(slice1 []<span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">fmt.Println(slice1)</span><br><span class="line">slice1[<span class="number">0</span>]=<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ‡ç‰‡sliceè¡¨ç°å‡ºæ¥çš„ç°è±¡æœ‰ç‚¹åƒå¼•ç”¨ç±»å‹ï¼Œä½†æ˜¯<strong>è¦åˆ‡è®°sliceå¹¶ä¸æ˜¯å¼•ç”¨ç±»å‹ï¼Œåªæ˜¯è¡¨ç°å‡ºæ¥å¼•ç”¨è¯­ä¹‰è€Œå·²</strong>ã€‚åœ¨<strong>golangä¸­å…¶å®åªæœ‰å€¼ä¼ é€’</strong>ï¼Œsliceè¡¨ç°å‡ºæ¥çš„å¼•ç”¨è¯­ä¹‰å…¶å®åªæ˜¯golangçš„ä¸€ä¸ªè¯­æ³•ç³–ï¼Œå…·ä½“çœ‹ä¸‹è¿™ä¸ªè¯­æ³•ç³–æ˜¯æ€ä¹ˆå®ç°çš„ã€‚<br>sliceçš„å£°æ˜å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> slice <span class="keyword">struct</span> &#123;</span><br><span class="line">array unsafe.Pointer</span><br><span class="line"><span class="built_in">len</span>   <span class="keyword">int</span></span><br><span class="line"><span class="built_in">cap</span>   <span class="keyword">int</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sliceç»“æ„ä½“æœ‰ä¸€ä¸ª<code>unsafe.Poiniter</code>çš„æŒ‡é’ˆï¼Œä»–æŒ‡å‘ä¸€ä¸ªæ•°ç»„ï¼Œå‰©ä¸‹ä¸¤ä¸ªå±æ€§ä¸€ä¸ªä»£è¡¨æ•°æ®çš„é•¿åº¦å¦ä¸€ä¸ªä»£è¡¨å®¹é‡ã€‚<br>å½“sliceè¿›è¡Œå˜é‡ä¼ é€’æˆ–è€…å‚æ•°ä¼ é€’æ—¶ï¼Œä¾ç„¶æ˜¯å°†å…¶å€¼æ‹·è´ä¸€ä»½ï¼Œæ­¤æ—¶<code>unsafe.Poiniter</code>ç±»å‹çš„æŒ‡é’ˆ<code>array</code>å°†å…¶å­˜å‚¨çš„<strong>æ•°ç»„åœ°å€</strong>ä¹Ÿæ‹·è´äº†ä¸€ä»½ï¼Œæ‰€ä»¥å¯¹ä¼ é€’ä¹‹åçš„å˜é‡è¿›è¡Œä¿®æ”¹ä¼šå½±å“åŸå§‹sliceçš„ç»“æœã€‚ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/golang-grammar/slice.png" alt="sliceå˜é‡" title="sliceå˜é‡"><br>å…¶ä¸­<code>[]int</code>æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œå­˜æ”¾sliceä¸­çš„æ•°æ®ï¼Œ<code>slice1</code>æ˜¯sliceçš„ä¸€ä¸ªå®ä¾‹ï¼Œ<code>slice1</code>å¯¹<code>slice2</code>è¿›è¡Œäº†èµ‹å€¼ã€‚èµ‹å€¼æ—¶è¿›è¡Œäº†å€¼ä¼ é€’ï¼Œå°†<code>slice1</code>ä¸­çš„æ•°æ®æ‹·è´äº†ä¸€ä»½ç»™<code>slice2</code>ï¼Œ<code>slice1</code>ä¸­çš„<code>array</code>æŒ‡é’ˆå°†å…¶å€¼ä¹Ÿå°±æ˜¯<code>[]int</code>çš„åœ°å€æ‹·è´äº†ä¸€ä»½ç»™<code>slice2</code>ä¸­çš„<code>array</code>æŒ‡é’ˆï¼Œè¿™å°±ç±»ä¼¼æŒ‡é’ˆçš„èµ‹å€¼ï¼Œæ‰€ä»¥å¯¹<code>slice2</code>çš„ä¿®æ”¹å¯ä»¥å½±å“åˆ°<code>slice1</code>ã€‚<br>å¦‚æœä¸æƒ³æ‹·è´ä¸€ä»½åˆ™å¯ä»¥ä½¿ç”¨æŒ‡é’ˆä¼ é€’ï¼Œç›´æ¥ä¼ é€’sliceçš„æŒ‡é’ˆï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">slice1 := []<span class="keyword">int</span>&#123;<span class="number">6</span>,<span class="number">6</span>,<span class="number">6</span>&#125;</span><br><span class="line">fmt.Println(slice1)</span><br><span class="line">modify(&amp;slice1)</span><br><span class="line">fmt.Println(slice1) <span class="comment">// è¾“å‡º1,6,6</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">modify</span><span class="params">(slice1 *[]<span class="keyword">int</span>)</span></span>&#123;</span><br><span class="line">fmt.Println(*slice1)</span><br><span class="line">(*slice1)[<span class="number">0</span>] =<span class="number">1</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åè®°ä½å…³é”®çš„ä¸€å¥è¯<strong>golangåªæœ‰å€¼ä¼ é€’</strong>ã€‚</p><h2 id="è¿›é˜¶"><a href="#è¿›é˜¶" class="headerlink" title="è¿›é˜¶"></a>è¿›é˜¶</h2><blockquote><p>Timer</p></blockquote><p>Timeræ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œåœ¨cache2goä¸­ç”¨æ¥å®šæ—¶æ£€æŸ¥ç¼“å­˜ä¸­å¯¹è±¡çš„è¿‡æœŸæ—¶é—´ã€‚åœ¨golangä¸­æœ‰ä¸¤ç§å®šæ—¶å™¨ï¼Œåˆ†åˆ«ä¸º<code>Timer</code>å’Œ<code>Ticker</code>ã€‚<code>Timer</code>åªè§¦å‘ä¸€æ¬¡ï¼Œå¦‚æœè¿˜éœ€ç»§ç»­è§¦å‘éœ€è¦ä½¿ç”¨Resetè¿›è¡Œé‡ç½®ï¼Œè€Œ<code>Ticker</code>æ˜¯é—´éš”ç‰¹å®šæ—¶é—´è§¦å‘ã€‚</p><p>Timerå¯ä»¥é€šè¿‡<code>NewTimer</code>åˆ›å»ºæˆ–è€…ä½¿ç”¨<code>AfterFunc</code>åˆ›å»ºã€‚ä½¿ç”¨<code>NewTimer</code>åˆ›å»ºæ—¶ï¼Œå½“Timeråˆ°æœŸæ—¶ï¼Œä¼šå°†å½“æ—¶çš„æ—¶é—´å‘é€ç»™channelã€‚<br>Timerç±»å‹å®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> Timer <span class="keyword">struct</span> &#123;</span><br><span class="line">    C &lt;-<span class="keyword">chan</span> Time     <span class="comment">// The channel on which the time is delivered.</span></span><br><span class="line">    r runtimeTimer</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„Cå°±æ˜¯ä¸Šæ–‡ä¸­ï¼Œè¯´çš„ä¼šå°†å½“å‰æ—¶é—´å‘é€çš„channelï¼Œ<code>NewTimer</code>åˆ›å»ºTimerçš„demoå¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timer := time.NewTimer(time.Second * <span class="number">3</span>)</span><br></pre></td></tr></table></figure><p>è¿™ç§å½¢å¼åˆ›å»ºçš„Timerï¼Œä½¿ç”¨æ—¶éœ€è¦ç›‘å¬channel Cä¸­çš„ä¿¡å·ï¼Œä½¿ç”¨demoå¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    d := time.Duration(time.Second*<span class="number">2</span>)</span><br><span class="line">    t := time.NewTimer(d)</span><br><span class="line">    <span class="keyword">defer</span> t.Stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">    <span class="comment">// ç­‰å¾…channel Cä¸­çš„ä¿¡å·</span></span><br><span class="line">        &lt;- t.C</span><br><span class="line"></span><br><span class="line">        fmt.Println(<span class="string">&quot;do someting...&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// é‡ç½®å®šæ—¶å™¨ï¼Œå› ä¸ºTimeræ˜¯ä¸€æ¬¡è§¦å‘</span></span><br><span class="line"><span class="comment">// Reset ä¼šå…ˆè°ƒç”¨ stopTimer å†è°ƒç”¨ startTimerï¼Œç±»ä¼¼äºåºŸå¼ƒä¹‹å‰çš„å®šæ—¶å™¨ï¼Œé‡æ–°å¯åŠ¨ä¸€ä¸ªå®šæ—¶å™¨</span></span><br><span class="line">t.Reset(time.Second*<span class="number">2</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>cache2goä¸­å¹¶æ²¡æœ‰ä½¿ç”¨è¿™ç§æ–¹å¼åˆ›å»ºTimerï¼Œè€Œæ˜¯ä½¿ç”¨äº†<code>AfterFunc</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">table.cleanupTimer = time.AfterFunc(smallestDuration, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> table.expirationCheck()</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>AfterFuncä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯æ—¶é—´å‚æ•°ï¼Œé—´éš”å¤šä¹…è§¦å‘ï¼Œç¬¬äºŒä¸ªæ˜¯æ‰§è¡Œé€»è¾‘ï¼Œä½¿ç”¨ä¸€ä¸ªå‡½æ•°ä½œä¸ºå‚æ•°ã€‚å½“Timerç»è¿‡smallestDurationé•¿æ—¶é—´ä¹‹åï¼Œä¼šæ‰§è¡Œåç¨‹<code>table.expirationCheck()</code>ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ä¸€æ¬¡è§¦å‘ï¼Œæ‰€ä»¥æ¯æ¬¡éƒ½éœ€è¦é€šè¿‡<code>AfterFunc</code>å†æ¬¡åˆ›å»ºä¸€ä¸ªTimerã€‚</p><p>å¦ä¸€ä¸ªå®šæ—¶å™¨æ˜¯Tickerï¼Œæ˜¯å‘¨æœŸæ€§çš„è§¦å‘ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯é™¤éç¨‹åºç»ˆæ­¢å¦åˆ™å®šæ—¶å™¨ä¼šä¸€ç›´è§¦å‘ï¼Œåœæ­¢æ—¶åº”è¯¥è°ƒç”¨<code>Ticker.Stop</code>æ¥é‡Šæ”¾ç›¸å…³èµ„æºã€‚Tickerä½¿ç”¨<code>NewTicker</code>åˆ›å»ºï¼Œdemoå¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">    t := time.NewTicker(<span class="number">2</span>*time.Second)</span><br><span class="line">    <span class="keyword">defer</span> t.Stop()</span><br><span class="line"></span><br><span class="line">    fmt.Println(time.Now())</span><br><span class="line">    time.Sleep(<span class="number">5</span>*time.Second)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> &#123;</span><br><span class="line">        <span class="keyword">select</span> &#123;</span><br><span class="line">        <span class="keyword">case</span> &lt;-t.C:</span><br><span class="line">            fmt.Println(time.Now())</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!-- éœ€è¦æ³¨æ„çš„æ˜¯golang timerå®šæ—¶å™¨æ˜¯ä¸èƒ½stopåœæ­¢çš„ï¼Œåªèƒ½åœ¨é€»è¾‘ä¸Šé€šè¿‡æ ‡ç¤ºä½æ¥é€€å‡ºå®šæ—¶ä»»åŠ¡ï¼Œ ä¸ºä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿ --><blockquote><p>goåç¨‹</p></blockquote><p>goå…³é”®å­—è¡¨ç¤ºåç¨‹goroutineï¼Œæ˜¯Goè¯­è¨€ä¸­çš„è½»é‡çº§çº¿ç¨‹å®ç°ï¼Œç”±Goè¿è¡Œæ—¶(runtime)ç®¡ç†ã€‚</p><p>åç¨‹æ˜¯å¯¹çº¿ç¨‹çš„ä¸€ç§è¡¥å……ï¼Œçº¿ç¨‹æ˜¯ç”±ç³»ç»Ÿå†…æ ¸ç®¡ç†çš„ï¼Œ<strong>çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢ä¼šè§¦å‘ç”¨æˆ·æ€åˆ°å†…æ ¸æ€çš„åˆ‡æ¢</strong>ï¼Œæ­¤æ—¶éœ€è¦ä¿å­˜ä¸€äº›ä¸Šä¸‹æ–‡ä¿¡æ¯ï¼Œæ¯”è¾ƒæ¶ˆè€—èµ„æºï¼Œè€Œä¸”çº¿ç¨‹å¤ªå¤šä¹Ÿä¼šè¾¾åˆ°çº¿ç¨‹ä¸Šé™çš„ç“¶é¢ˆã€‚<br>è€Œåç¨‹å®Œå…¨æ˜¯ç”±ç¨‹åºæ‰€æ§åˆ¶(ä¹Ÿå°±æ˜¯åœ¨ç”¨æˆ·æ€æ‰§è¡Œï¼Œæ‰€ä»¥ä¹Ÿå«<strong>ç”¨æˆ·æ€çº¿ç¨‹</strong>)ï¼Œæ˜¯åœ¨åº”ç”¨å±‚æ¨¡æ‹Ÿçº¿ç¨‹ï¼Œå› æ­¤é¿å…äº†ç”¨æˆ·æ€å’Œå†…æ ¸æ€çš„é¢‘ç¹åˆ‡æ¢ã€‚<br>ç¨‹åºæœ€ç»ˆæ˜¯è¦ç”±CPUåŠç›¸å…³å­˜å‚¨å™¨è¿›è¡Œæ‰§è¡Œï¼Œè€Œåç¨‹åœ¨ç”¨æˆ·æ€æ‰§è¡Œï¼Œä¸ç”±ç³»ç»Ÿå†…æ ¸è°ƒåº¦ï¼Œé‚£ä¹ˆä»–æ˜¯å¦‚ä½•è°ƒåº¦åˆ°CPUçš„ï¼Ÿåœ¨golangä¸­ï¼Œåç¨‹æ˜¯åŸºäºçº¿ç¨‹çš„ï¼Œå¹¶ä¸”å®ç°äº†ä¸€ä¸ªé€»è¾‘æµè°ƒåº¦(ä¹Ÿå°±æ˜¯åç¨‹è°ƒåº¦å™¨)ï¼Œå¯ä»¥åƒè°ƒåº¦çº¿ç¨‹é‚£æ ·åœ¨ç”¨æˆ·æ€ä¹Ÿèƒ½æ ¹æ®ä»£ç çš„æ‰§è¡ŒçŠ¶æ€è¿›è¡Œè°ƒåº¦åç¨‹ï¼Œ<em>æ›´å……åˆ†çš„åˆ©ç”¨å¹¶å‘çš„ä¼˜åŠ¿ï¼Œåˆé¿å…åå¤ç³»ç»Ÿè°ƒç”¨ï¼Œè¿˜æœ‰è¿›ç¨‹åˆ‡æ¢é€ æˆçš„å¼€é”€</em>ã€‚</p><p>æ›´é€šä¿—çš„è¯´<em>åç¨‹æ˜¯å­å‡½æ•°çš„ä¸€ä¸ªç‰¹ä¾‹</em>ï¼Œåœ¨çº¿ç¨‹ä¸­å‡½æ•°ä¹‹é—´çš„è°ƒç”¨åªéœ€è¦å°†å„è‡ªçš„æ‰§è¡ŒçŠ¶æ€å‹å…¥æ ˆä¸­å³å¯ï¼Œæ‰€ä»¥åç¨‹åˆ‡æ¢æ—¶ä¹Ÿæ˜¯å‹æ ˆæ“ä½œï¼Œæ¯”è¾ƒè½»é‡ã€‚</p><p>äº†è§£è¿‡åç¨‹ä¹‹åï¼Œå‘ç°åç¨‹ç¡®å®æ˜¯ä¸ªå¥½ä¸œè¥¿ï¼Œæ›´å¥½çš„æ˜¯golangä»ç¼–è¯‘å™¨å’Œè¯­è¨€åŸºç¡€åº“å¤šä¸ªå±‚é¢å¯¹åç¨‹åšäº†å®ç°ï¼Œä¾‹å¦‚golangå¯¹å„ç§ioå‡½æ•°è¿›è¡Œäº†å°è£…ï¼Œå†…éƒ¨è°ƒç”¨æ“ä½œç³»ç»Ÿçš„å¼‚æ­¥ioå‡½æ•°ï¼Œæ ¹æ®è¿™äº›å‡½æ•°è¿”å›çš„çŠ¶æ€å°†ç°æœ‰çš„æ‰§è¡Œåºåˆ—å‹æ ˆï¼Œè®©çº¿ç¨‹å»æ‹‰å¦ä¸€ä¸ªåç¨‹æ‰§è¡Œï¼Œæ˜¯ç›®å‰å„ç±»æœ‰åç¨‹æ¦‚å¿µçš„è¯­è¨€ä¸­å®ç°çš„æœ€å®Œæ•´å’Œæˆç†Ÿçš„ï¼Œæœ€é‡è¦çš„æ˜¯ä½¿ç”¨èµ·æ¥å¾ˆæ–¹ä¾¿ï¼Œåªéœ€åœ¨æ™®é€šå‡½æ•°ä¹‹å‰æ·»åŠ <code>go</code>å…³é”®å­—å³å¯ï¼Œä½¿å¼€å‘è€…æ›´å¤šçš„å…³æ³¨ä¸šåŠ¡é€»è¾‘çš„å®ç°ï¼Œæ›´å°‘çš„åœ¨è¿™äº›å…³é”®çš„åŸºç¡€æ„ä»¶ä¸Šè€—è´¹å¤ªå¤šç²¾åŠ›ã€‚</p><p>cache2goä¸­åªæœ‰ä¸€å¤„ä½¿ç”¨äº†åç¨‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">expirationCheck</span><span class="params">()</span></span> &#123;</span><br><span class="line">...</span><br><span class="line">table.cleanupTimer = time.AfterFunc(smallestDuration, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="keyword">go</span> table.expirationCheck()</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>go</code>å…³é”®å­—åŠ æ™®é€šå‡½æ•°ä»£è¡¨åç¨‹ï¼Œä¸åŒäºå‡½æ•°è°ƒç”¨ï¼Œä¸ä¼šç­‰å¾…è°ƒç”¨å‡½æ•°ç»“æŸï¼Œè€Œæ˜¯ç»§ç»­æ‰§è¡Œå‰©ä¸‹çš„ä»£ç ç‰‡æ®µï¼Œè¢«è°ƒç”¨çš„å‡½æ•°ä¼šåœ¨é€‚å½“çš„æ—¶é—´è¢«è°ƒåº¦ã€‚<em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœè¿™ä¸ªå‡½æ•°æœ‰è¿”å›å€¼ï¼Œé‚£ä¹ˆè¿™ä¸ª è¿”å›å€¼ä¼šè¢«ä¸¢å¼ƒã€‚</em></p><!--åç¨‹å°±æ˜¯åœ¨ç”¨æˆ·ç¨‹åºä¸­å®ç°äº†åä½œå¼ä»»åŠ¡è°ƒåº¦(å½“ä»»åŠ¡å¾—ä¸€ä¸ªåˆ°äº† CPU æ—¶é—´ï¼Œé™¤éå®ƒè‡ªå·±æ”¾å¼ƒä½¿ç”¨ CPU ï¼Œå¦åˆ™å°†å®Œå…¨éœ¸å  CPU)å¹¶å‘ ä¸€ä¸ªæ—¶é—´æ®µå†…ï¼Œå¤šä¸ªä»»åŠ¡äº¤æ›¿æ‰§è¡Œå¹¶è¡Œ åŒä¸€æ—¶åˆ»ï¼Œå¤šä¸ªä»»åŠ¡åŒæ—¶æ‰§è¡Œåç¨‹çš„ä¼˜åŠ¿ï¼šæœ€å¤§çš„ä¼˜åŠ¿å°±æ˜¯åç¨‹æé«˜çš„æ‰§è¡Œæ•ˆç‡ã€‚å› ä¸ºå­ç¨‹åºåˆ‡æ¢ä¸æ˜¯çº¿ç¨‹åˆ‡æ¢ï¼Œè€Œæ˜¯ç”±ç¨‹åºè‡ªèº«æ§åˆ¶ï¼Œå› æ­¤ï¼Œæ²¡æœ‰çº¿ç¨‹åˆ‡æ¢çš„å¼€é”€ï¼Œå’Œå¤šçº¿ç¨‹æ¯”ï¼Œçº¿ç¨‹æ•°é‡è¶Šå¤šï¼Œåç¨‹çš„æ€§èƒ½ä¼˜åŠ¿å°±è¶Šæ˜æ˜¾ã€‚ç¬¬äºŒå¤§ä¼˜åŠ¿å°±æ˜¯ä¸éœ€è¦å¤šçº¿ç¨‹çš„é”æœºåˆ¶ï¼Œå› ä¸ºåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œä¹Ÿä¸å­˜åœ¨åŒæ—¶å†™å˜é‡å†²çªï¼Œåœ¨åç¨‹ä¸­æ§åˆ¶å…±äº«èµ„æºä¸åŠ é”ï¼Œåªéœ€è¦åˆ¤æ–­çŠ¶æ€å°±å¥½äº†ï¼Œæ‰€ä»¥æ‰§è¡Œæ•ˆç‡æ¯”å¤šçº¿ç¨‹é«˜å¾ˆå¤šã€‚åç¨‹ä¹Ÿå¯ä»¥åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´åˆ‡æ¢ï¼Œ--><!--> å‡½æ•° func(key interface{}, args ...interface{})   å¯å˜å‚æ•°é•¿åº¦å‡½æ•°å˜é‡>test golangå­—ç¬¦ä¸²ï¼Œbyteæ•°ç»„ byteåŒºåˆ«## è¯­æ³•æŠ€å·§åŒ¿åå‡½æ•°åŒ¿åå±æ€§å‡½æ•°å‚æ•°res.Data().(*myStruct).text è¿™æ˜¯ä»€ä¹ˆç”¨æ³•ï¼Œå¼ºåˆ¶è½¬æ¢ç±»å‹ï¼Ÿ æ¥å£ç±»å‹å¼ºåˆ¶è½¬æ¢å£°æ˜å¤šä¸ªå˜é‡å¯ä»¥ç¼©å†™ï¼Œç”¨å°æ‹¬å·æ‹¬èµ·æ¥<figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">cache = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*CacheTable)</span><br><span class="line">mutex sync.RWMutex</span><br><span class="line">)</span><br></pre></td></tr></table></figure><p>map æ¥å£<br>t, ok := cache[table] åˆ¤æ–­æ˜¯å¦æœ‰å€¼</p><p>RLockä¸Lockçš„åŒºåˆ«<br>sync.WaitGroup<br>â€“&gt;</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> golang </tag>
            
            <tag> cache2go </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golangéšæ³¢é€æµä¹‹cache2goæºç è§£è¯»</title>
      <link href="/golang-cache2go-src.html"/>
      <url>/golang-cache2go-src.html</url>
      
        <content type="html"><![CDATA[<p>æƒ³å­¦ä¹ golangäº†ï¼Œå·¥ä½œä¸­åˆæ¥è§¦ä¸åˆ°ï¼ŒåŸºç¡€è¯­æ³•ä¸€çœ‹å…¨æ˜ç™½ï¼ŒçœŸåˆ°ç”¨çš„æ—¶å€™å´æ˜¯çªçœ¼çï¼Œæ€ä¹ˆåŠï¼Ÿ<br>å¯ä»¥æ‰¾ç®€å•çš„å¼€æºé¡¹ç›®ï¼Œçœ‹ä¸‹æºç ï¼Œçœ‹çœ‹è¿™äº›è¯­æ³•çš„å¸¸ç”¨æ–¹å¼ï¼Œå¹¶ä¸”ä¹Ÿå¯ä»¥è‡ªå·±å°è¯•ç€å»è‡ªå·±å®ç°ä¸‹ã€‚<br><a href="https://github.com/muesli/cache2go">cache2go</a>å°±æ˜¯ä¸€ä¸ªæ¯”è¾ƒç®€å•çš„é¡¹ç›®ï¼Œä¹Ÿæ˜¯åˆå­¦è€…å¿…æ’¸çš„é¡¹ç›®äº†å§ã€‚<br>æœ¬ç¯‡æ˜¯æˆ‘æ¢³ç†cache2goçš„å­¦ä¹ ç¬”è®°ã€‚</p><span id="more"></span><h2 id="cache2goæ¦‚è§ˆ"><a href="#cache2goæ¦‚è§ˆ" class="headerlink" title="cache2goæ¦‚è§ˆ"></a>cache2goæ¦‚è§ˆ</h2><p>cache2goæ˜¯ç”¨Goå®ç°çš„å¹¶å‘å®‰å…¨çš„ç¼“å­˜åº“ï¼Œä¸»è¦åŠŸèƒ½æœ‰ï¼š</p><ul><li>å¹¶å‘å®‰å…¨</li><li>ç¼“å­˜å‘½ä¸­æ¬¡æ•°</li><li>ç¼“å­˜è¿‡æœŸ</li></ul><p>é¡¹ç›®ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">xx/cache2go</span><br><span class="line">â”œâ”€â”€ LICENSE.txt</span><br><span class="line">â”œâ”€â”€ README.md</span><br><span class="line">â”œâ”€â”€ benchmark_test.go</span><br><span class="line">â”œâ”€â”€ cache.go</span><br><span class="line">â”œâ”€â”€ cache_test.go</span><br><span class="line">â”œâ”€â”€ cacheitem.go</span><br><span class="line">â”œâ”€â”€ cachetable.go</span><br><span class="line">â”œâ”€â”€ errors.go</span><br><span class="line">â””â”€â”€ examples</span><br><span class="line">    â”œâ”€â”€ callbacks</span><br><span class="line">    â”‚Â Â  â””â”€â”€ callbacks.go</span><br><span class="line">    â”œâ”€â”€ dataloader</span><br><span class="line">    â”‚Â Â  â””â”€â”€ dataloader.go</span><br><span class="line">    â””â”€â”€ mycachedapp</span><br><span class="line">        â””â”€â”€ mycachedapp.go</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼ŒåŠŸèƒ½ä»£ç ä¸€å…±ä¹Ÿå°±å››ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­ä¸€ä¸ªè¿˜æ˜¯ä¸ªerroræ–‡ä»¶ï¼Œé‡Œé¢åªå®šä¹‰äº†ä¸¤ä¸ªerrorç±»å‹ï¼Œå…¶æ ¸å¿ƒæ–‡ä»¶ä¹Ÿå°±ä¸‰ä¸ªã€‚<br>æ ¸å¿ƒä»£ç è™½ç„¶ä¸å¤šï¼Œä½†æ˜¯ä»”ç»†è¯»è¿™ä¸‰ä¸ªæ–‡ä»¶ï¼Œè¿˜æ˜¯å¯ä»¥ä»ä¸­å­¦ä¹ å¾ˆå¤šgolangè¯­æ³•å’ŒçŸ¥è¯†ç‚¹çš„ï¼Œæ¯”å¦‚lockã€goroutineã€åŒ¿åå‡½æ•°ç­‰ç­‰ã€‚</p><h2 id="å¼ºæ’¸ç°é£çƒŸç­"><a href="#å¼ºæ’¸ç°é£çƒŸç­" class="headerlink" title="å¼ºæ’¸ç°é£çƒŸç­"></a>å¼ºæ’¸ç°é£çƒŸç­</h2><p>å¯¹äºä¸€ä¸ªç¨‹åºå‘˜æ¥è¯´ï¼Œé˜…è¯»ä»£ç æ˜¯ä¸€é¡¹å¿…å¤‡çš„æŠ€èƒ½ï¼Œå› ä¸ºåœ¨å·¥ä½œä¸­è‚¯å®šä¼šé‡åˆ°å¼€å‘ç»´æŠ¤é—ç•™é¡¹ç›®çš„æƒ…å†µã€‚<br>é‚£ä¹ˆå¦‚ä½•å¿«é€Ÿé«˜æ•ˆçš„é˜…è¯»ä»£ç å‘¢ï¼Ÿä¿—è¯è¯´å¼ºæ’¸ç°é£çƒŸç­ï¼Œæ‰€ä»¥è‚¯å®šä¸èƒ½ä¸Šæ¥å°±ä¸€é¡¿æ“ä½œçŒ›å¦‚è™ã€‚<br>é’ˆå¯¹ä¸åŒå¼€å‘äººå‘˜å¼€å‘çš„é¡¹ç›®ä»¥åŠä¸åŒç±»å‹çš„é¡¹ç›®éœ€è¦æœ‰ä¸åŒçš„æ–¹æ³•ï¼Œè¿™é‡Œè°ˆä¸‹æˆ‘ä¸ªäººçš„å‡ ç‚¹çœ‹æ³•ï¼š<br>1ã€å…¬å¸å†…éƒ¨é¡¹ç›®å¯ç»“åˆå£å¤´æµä¼ æˆ–è€…wikiä»¥åŠé¡¹ç›®æœ¬èº«çš„æŠ€æœ¯æ¡†æ¶ï¼Œä»æŸä¸ªåŠŸèƒ½ç‚¹è¿›è¡Œåˆ‡å…¥<br>2ã€å¼€æºé¡¹ç›®æ™®éæœ‰è¾ƒä¸ºå®Œå–„çš„æ–‡æ¡£å’Œå•å…ƒæµ‹è¯•æˆ–è€…examplesï¼Œå¯ä»¥ä»æ–‡æ¡£å…¥æ‰‹äº†è§£åŠŸèƒ½åŠä½¿ç”¨æ–¹å¼ï¼Œç„¶åä»¥å•å…ƒæµ‹è¯•æˆ–è€…examplesä½œä¸ºä»£ç çš„åˆ‡å…¥ç‚¹ã€‚</p><p>cache2goæ˜¯ä¸€ä¸ªå¼€æºé¡¹ç›®ï¼Œé‡Œé¢æœ‰æµ‹è¯•ç›¸å…³çš„ä»£ç ï¼Œä¹Ÿæœ‰examplesï¼Œæ‰€ä»¥å…ˆä»examplesä»£ç å…¥æ‰‹ã€‚<br>examplesä¸­æœ‰ä¸‰ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºmycachedapp.goã€dataloader.goå’Œcallbacks.goï¼Œçœ‹åå­—åº”è¯¥å…ˆçœ‹mycachedapp.goè¿™ä¸ªæ–‡ä»¶ï¼Œå®ƒåº”è¯¥æ˜¯ç¼“å­˜çš„ä½¿ç”¨æ–¹å¼ã€‚</p><p>mycachedapp.goæ–‡ä»¶ä¸­ä»‹ç»äº†cacheçš„è¯»å†™å’Œåˆ ç­‰å¸¸ç”¨æ“ä½œï¼Œè§£æä¸‹å…³é”®ä»£ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å®åŠ›åŒ–ä¸€ä¸ªç¼“å­˜cacheï¼Œåå­—ä¸ºmyCahe</span></span><br><span class="line">cache := cache2go.Cache(<span class="string">&quot;myCache&quot;</span>)</span><br><span class="line"><span class="comment">// å‘ç¼“å­˜ä¸­åŠ å…¥å…ƒç´ ï¼Œkvæ ¼å¼ï¼Œç¬¬äºŒä¸ªå‚æ•°æ—¶keyçš„è¿‡æœŸæ—¶é—´ï¼Œ0ä»£è¡¨ç”¨ä¸è¿‡æœŸ</span></span><br><span class="line">cache.Add(<span class="string">&quot;someKey&quot;</span>, <span class="number">5</span>*time.Second, &amp;val)</span><br><span class="line"><span class="comment">// ç¼“å­˜ä¸­è¯»å–keyå¯¹åº”çš„å€¼</span></span><br><span class="line">res, err := cache.Value(<span class="string">&quot;someKey&quot;</span>)</span><br><span class="line"><span class="comment">// è®¾ç½®åˆ é™¤æŸä¸ªkeyæ—¶çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">cache.SetAboutToDeleteItemCallback(<span class="function"><span class="keyword">func</span><span class="params">(e *cache2go.CacheItem)</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Deleting:&quot;</span>, e.Key(), e.Data().(*myStruct).text, e.CreatedOn())</span><br><span class="line">&#125;)</span><br><span class="line"><span class="comment">// ä»ç¼“å­˜ä¸­åˆ é™¤æŸä¸ªkey</span></span><br><span class="line">cache.Delete(<span class="string">&quot;someKey&quot;</span>)</span><br><span class="line"><span class="comment">// æ¸…ç©ºç¼“å­˜</span></span><br><span class="line">cache.Flush()</span><br></pre></td></tr></table></figure><p>é€šè¯»mycachedapp.goä¹‹åï¼Œäº†è§£äº†cacheçš„åŸºæœ¬ç”¨æ³•ï¼Œä¸‹é¢æˆ‘ä»¬æ›´æ·±ä¸€æ­¥ï¼Œå»æ¢å¯»ä»–å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><h2 id="Cache"><a href="#Cache" class="headerlink" title="Cache"></a>Cache</h2><p>mycachedapp.goä¸­è°ƒç”¨<code>cache2go.Cache()</code>åˆå§‹åŒ–äº†ä¸€ä¸ªç¼“å­˜å®ä¾‹ï¼Œæ¥ç€è·Ÿè¿›è¿™ä¸ªæ–¹æ³•çœ‹ä¸‹å…·ä½“çš„ç»†èŠ‚ã€‚æ­¤æ–¹æ³•ä½äº<code>cache.go</code>æ–‡ä»¶ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> (</span><br><span class="line">cache = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">string</span>]*CacheTable)</span><br><span class="line">mutex sync.RWMutex</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Cache</span><span class="params">(table <span class="keyword">string</span>)</span> *<span class="title">CacheTable</span></span> &#123;</span><br><span class="line"><span class="comment">// RLockè¯»é”ï¼Œè¯»é”ä¹‹é—´å¯ä»¥å…±äº«ï¼ŒLockéœ€è¦ç­‰å¾…Rlocké‡Šæ”¾æ‰èƒ½å¾—åˆ°é”</span></span><br><span class="line">mutex.RLock()</span><br><span class="line"><span class="comment">// ä»map cacheä¸­è·å–tableå¯¹åº”çš„å€¼</span></span><br><span class="line">t, ok := cache[table]</span><br><span class="line">mutex.RUnlock()</span><br><span class="line">    <span class="comment">// okä¸ºtrueä»£è¡¨æœ‰å€¼ï¼Œfalseä»£è¡¨æ— å€¼</span></span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="comment">// äº’æ–¥é”</span></span><br><span class="line">mutex.Lock()</span><br><span class="line">t, ok = cache[table]</span><br><span class="line"><span class="comment">// Double check whether the table exists or not.</span></span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="comment">// åˆ›å»ºä¸€ä¸ªCacheTableå¯¹è±¡</span></span><br><span class="line">t = &amp;CacheTable&#123;</span><br><span class="line">name:  table,</span><br><span class="line">items: <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*CacheItem),</span><br><span class="line">&#125;</span><br><span class="line">cache[table] = t</span><br><span class="line">&#125;</span><br><span class="line">mutex.Unlock()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> t</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>cache.go</code>ä»£ç æ¯”è¾ƒç®€å•ï¼Œå…ˆå£°æ˜äº†ä¸¤ä¸ªå…¨å±€å˜é‡ï¼Œæ¥ç€å°±æ˜¯<code>Cache()</code>æ–¹æ³•ã€‚è¯¥æ–¹æ³•ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ ¹æ®ä¼ å…¥çš„å‚æ•°tableä»mapç±»å‹çš„cacheä¸­å–å‡ºå¯¹åº”çš„å€¼ï¼Œæœ‰å€¼åˆ™ç›´æ¥è¿”å›ï¼Œæ— å€¼åˆ™åˆ›å»ºä¸€ä¸ª<code>CacheTable</code>ç±»å‹çš„å¯¹è±¡ã€‚è¿™é‡Œä½¿ç”¨äº†<code>Double check</code>æœºåˆ¶æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚</p><h2 id="CacheTable"><a href="#CacheTable" class="headerlink" title="CacheTable"></a>CacheTable</h2><p>å…³é”®ç‚¹å°±åœ¨äº<code>CacheTable</code>ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹<code>CacheTable</code>çš„å…·ä½“å®ç°ã€‚</p><p><code>CacheTable</code>ä½äº<code>cachetable.go</code>æ–‡ä»¶ä¸­ï¼Œæ˜¯ä¸€ä¸ªç»“æ„ä½“ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CacheTable <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// åŒ¿åå±æ€§</span></span><br><span class="line">sync.RWMutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// The table&#x27;s name.</span></span><br><span class="line">name <span class="keyword">string</span></span><br><span class="line"><span class="comment">// All cached items.</span></span><br><span class="line">items <span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*CacheItem</span><br><span class="line"></span><br><span class="line"><span class="comment">// Timer responsible for triggering cleanup.</span></span><br><span class="line">cleanupTimer *time.Timer</span><br><span class="line"><span class="comment">// å½“å‰è®¡æ—¶å™¨æŒç»­æ—¶é—´</span></span><br><span class="line"><span class="comment">// Current timer duration.</span></span><br><span class="line">cleanupInterval time.Duration</span><br><span class="line"></span><br><span class="line"><span class="comment">// The logger used for this table.</span></span><br><span class="line">logger *log.Logger</span><br><span class="line"></span><br><span class="line"><span class="comment">// Callback method triggered when trying to load a non-existing key.</span></span><br><span class="line">loadData <span class="function"><span class="keyword">func</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, args ...<span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">CacheItem</span></span></span><br><span class="line"><span class="comment">// Callback method triggered when adding a new item to the cache.</span></span><br><span class="line"><span class="comment">// è§¦å‘å›è°ƒå‡½æ•°ï¼Œå›è°ƒå‡½æ•°å¯ä»¥ä¸æ­¢ä¸€ä¸ª</span></span><br><span class="line">addedItem []<span class="function"><span class="keyword">func</span><span class="params">(item *CacheItem)</span></span></span><br><span class="line"><span class="comment">// Callback method triggered before deleting an item from the cache.</span></span><br><span class="line">aboutToDeleteItem []<span class="function"><span class="keyword">func</span><span class="params">(item *CacheItem)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>CacheTable</code>çš„æˆå‘˜å˜é‡é‡ç‚¹ä»‹ç»ä¸‹<code>items</code>ã€<code>cleanupTimer</code>å’Œä¸€äº›ç”¨äºå›è°ƒå‡½æ•°çš„å‡½æ•°å˜é‡ï¼Œå…¶ä¸­<code>items</code>æ˜¯ä¸€ä¸ªmapï¼Œä»¥key/valueçš„å½¢å¼å­˜å‚¨å…·ä½“çš„ç¼“å­˜æ•°æ®ï¼›<code>cleanupTimer</code>æ˜¯ä¸€ä¸ªå®šæ—¶å™¨ï¼Œç”¨äºæ£€æŸ¥ç¼“å­˜å¯¹è±¡çš„è¿‡æœŸæ—¶é—´ï¼›å‰©ä¸‹çš„<code>loadDataã€addedItemå’ŒaboutToDeleteItem</code>ç”¨äºæŸäº›æ“ä½œçš„å›è°ƒå‡½æ•°ã€‚</p><p>æ¥ä¸‹æ¥çœ‹ä¸‹mycachedapp.goæ–‡ä»¶ä¸­å¯¹ç¼“å­˜ä½¿ç”¨ç›¸å…³çš„æ–¹æ³•ï¼Œå¢åŠ ç¼“å­˜çš„æ–¹æ³•Addï¼Œè¯»å–ç¼“å­˜ä¸­æ•°æ®çš„æ–¹æ³•Valueå’Œåˆ é™¤ç¼“å­˜ä¸­æ•°æ®çš„æ–¹æ³•Deleteï¼Œè¿™å‡ ä¸ªæ–¹æ³•çš„é¦–å­—æ¯éƒ½æ˜¯å¤§å†™ï¼Œä»£è¡¨æ–¹æ³•æ˜¯publicã€‚</p><blockquote><p>Add</p></blockquote><p>å…ˆçœ‹ä¸‹Addæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// keyæ˜¯ç¼“å­˜å¯¹è±¡çš„keyï¼Œdataæ˜¯ç¼“å­˜å¯¹è±¡çš„å€¼ï¼ŒlifeSpanæ˜¯å¯¹è±¡çš„è¿‡æœŸæ—¶é—´</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">Add</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, lifeSpan time.Duration, data <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">CacheItem</span></span> &#123;</span><br><span class="line"><span class="comment">// golangä¸­çš„â€œæ„é€ å‡½æ•°â€</span></span><br><span class="line">item := NewCacheItem(key, lifeSpan, data)</span><br><span class="line"><span class="comment">// å°†itemåŠ å…¥CacheTableä¸­ï¼Œè¿™é‡Œæ¶‰åŠåˆ°å¤šçº¿ç¨‹ï¼Œæ‰€ä»¥éœ€è¦åŠ é”</span></span><br><span class="line"><span class="comment">// é”çš„é‡Šæ”¾åœ¨addInternalæ–¹æ³•ä¸­ï¼Œæ˜¯å¯¹é”ç²’åº¦è¿›è¡Œçš„ä¼˜åŒ–</span></span><br><span class="line">table.Lock()</span><br><span class="line">table.addInternal(item)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> item</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Addæ–¹æ³•ä¼šæ ¹æ®ä¼ å…¥çš„å‚æ•°è°ƒç”¨<code>NewCacheItem</code>æ–¹æ³•æ„å»ºä¸€ä¸ªCacheItemå¯¹è±¡ï¼Œç”±äºgolangä¸­çš„ç»“æ„ä½“å¹¶æ²¡æœ‰æ„é€ å‡½æ•°çš„æ¦‚å¿µï¼Œå¯¹äºéœ€è¦æ„é€ å‡½æ•°çš„åœºæ™¯ï¼Œä¸€èˆ¬éƒ½ä¼šä½¿ç”¨<code>NewStructName()</code>çš„æ–¹å¼å£°æ˜ä¸€ä¸ªæ–¹æ³•ï¼Œä½œä¸ºç»“æ„ä½“çš„æ„é€ å‡½æ•°ä½¿ç”¨ã€‚NewCacheItemä½äºcacheitem.goä¸­ï¼Œä¼šåœ¨ä¸‹ä¸€èŠ‚ä»‹ç»ã€‚</p><p>itemåˆ›å»ºæˆåŠŸä¹‹åï¼Œéœ€è¦å°†å…¶åŠ å…¥åˆ°mapç±»å‹çš„itemsä¸­ï¼Œä»¥ä¾¿äºåç»­æ•°æ®çš„è¯»å–ã€‚ç”±äºæ­¤æ“ä½œæ¶‰åŠåˆ°è¯»å†™æ“ä½œï¼Œåœ¨å¤šçº¿ç¨‹ä¸‹éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ‰€ä»¥åœ¨è°ƒç”¨<code>addInternal</code>æ–¹æ³•ä¹‹å‰å…ˆè·å–é”ï¼Œä½†æ˜¯é‡Šæ”¾é”å¹¶æ²¡æœ‰åœ¨<code>addInternal</code>æ–¹æ³•æ‰§è¡Œç»“æŸå†é‡Šæ”¾ï¼Œè€Œæ˜¯åœ¨<code>addInternal</code>ä»£ç ä¸­å¯¹ç›¸åº”èµ„æºè¯»å†™ç»“æŸä¹‹åé‡Šæ”¾ï¼Œè¿™æ ·åšå‡å°‘äº†æŒæœ‰é”çš„æ—¶é—´ï¼Œæé«˜äº†å¹¶è¡Œåº¦ã€‚<code>addInternal</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">addInternal</span><span class="params">(item *CacheItem)</span></span> &#123;</span><br><span class="line"><span class="comment">// Careful: do not run this method unless the table-mutex is locked!</span></span><br><span class="line"><span class="comment">// It will unlock it for the caller before running the callbacks and checks</span></span><br><span class="line">table.log(<span class="string">&quot;Adding item with key&quot;</span>, item.key, <span class="string">&quot;and lifespan of&quot;</span>, item.lifeSpan, <span class="string">&quot;to table&quot;</span>, table.name)</span><br><span class="line"><span class="comment">// å°†æ•°æ®åŠ å…¥ç¼“å­˜ä¸­</span></span><br><span class="line">table.items[item.key] = item</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å€¼è¿›è¡Œæå‰ç¼“å­˜ï¼ŒåŠæ—¶é‡Šæ”¾é”</span></span><br><span class="line">expDur := table.cleanupInterval</span><br><span class="line"><span class="comment">// å¾—åˆ°Addçš„å›è°ƒå‡½æ•°åˆ—è¡¨</span></span><br><span class="line">addedItem := table.addedItem</span><br><span class="line"><span class="comment">// æœªæŒæœ‰é”ï¼Œè€Œç›´æ¥è¿›è¡Œé‡Šæ”¾æ—¶ï¼Œä¼šæŠ¥å¼‚å¸¸</span></span><br><span class="line">table.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trigger callback after adding an item to cache.</span></span><br><span class="line"><span class="keyword">if</span> addedItem != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, callback := <span class="keyword">range</span> addedItem &#123;</span><br><span class="line">callback(item)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// If we haven&#x27;t set up any expiration check timer or found a more imminent item.</span></span><br><span class="line"><span class="comment">// å¦‚æœitemçš„è¿‡æœŸæ—¶é—´å°äºä¸‹æ¬¡æ£€æŸ¥çš„æ—¶é—´é—´éš”ï¼Œåˆ™è§¦å‘è¿‡æœŸæ£€æŸ¥ï¼Œé‡ç½®è¿‡æœŸæ—¶é—´é—´éš”</span></span><br><span class="line"><span class="keyword">if</span> item.lifeSpan &gt; <span class="number">0</span> &amp;&amp; (expDur == <span class="number">0</span> || item.lifeSpan &lt; expDur) &#123;</span><br><span class="line">table.expirationCheck()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>addInternal</code>æ–¹æ³•æ‰ä¼šçœŸæ­£çš„å°†æ•°æ®æ·»åŠ åˆ°ç¼“å­˜ä¸­ï¼Œå¹¶ä¸”è°ƒç”¨ç›¸åº”çš„å›è°ƒå‡½æ•°ï¼Œå¹¶ä¸”è¿™é‡Œè¿˜ä¼šè§¦å‘è¿‡æœŸæ£€æŸ¥ã€‚<br>æ•°æ®çš„è¿‡æœŸæ£€æŸ¥ä½¿ç”¨äº†<code>Timer</code>çš„å®šæ—¶åŠŸèƒ½ï¼Œä½†æ˜¯ç»†å¿ƒçš„ç«¥é‹ä¼šå‘ç°<code>CacheTable</code>åœ¨åˆ›å»ºçš„æ—¶å€™å¹¶æ²¡æœ‰ç»™<code>Timer</code>è¿›è¡Œèµ‹å€¼ï¼Œ<code>Timer</code>æ˜¯é€šè¿‡ç¬¬ä¸€ä¸ªåŠ å…¥åˆ°ç¼“å­˜ä¸­çš„æ•°æ®æ¿€æ´»çš„ã€‚<br>è¿™æ ·å¥½å¤„æ˜¯ç¼“å­˜åˆå§‹åŒ–ä¹‹åï¼Œåœ¨æ·»åŠ æ•°æ®ä¹‹å‰ä¸ç”¨è®©<code>Timer</code>å»å®šæœŸæ‰§è¡Œä¸€äº›æ— æ„ä¹‰çš„æ“ä½œï¼Œè€Œä¸”åœ¨æ¯åŠ å…¥ä¸€ä¸ªæ•°æ®å°±è§¦å‘è¿‡æœŸæ£€æŸ¥æ›´èƒ½æ›´åŠæ—¶çš„è°ƒæ•´è¿›è¡Œè¿‡æœŸæ£€æŸ¥çš„æ—¶é—´ç‚¹ï¼Œ<strong>å› ä¸ºç¼“å­˜ä¸­æ•°æ®çš„è¿‡æœŸæ—¶é—´ä¸å®šï¼Œæ— æ³•è®¾ç½®ä¸€ä¸ªåˆç†çš„å®šæœŸæ—¶é—´å»å‘¨æœŸæ€§çš„æ‰§è¡Œï¼Œè€Œä¸”éå†ä¸€éæ‰€æœ‰æ•°æ®æ‰¾å‡ºæœ€å…ˆè¿‡æœŸçš„æ•°æ®ï¼Œå°†å…¶å‰©ä½™æ—¶é—´ä½œä¸ºä¸‹æ¬¡æ£€æŸ¥çš„æ—¶é—´é—´éš”</strong>ã€‚<br><code>expirationCheck</code>æ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">expirationCheck</span><span class="params">()</span></span> &#123;</span><br><span class="line">table.Lock()</span><br><span class="line"><span class="comment">// Timerå®šæ—¶åŠŸèƒ½çš„ä¸€ç§ç”¨æ³•ï¼Œç»“åˆä¸‹é¢å¯¹cleanupTimerçš„èµ‹å€¼æ–¹å¼å³å¯ç†è§£</span></span><br><span class="line"><span class="keyword">if</span> table.cleanupTimer != <span class="literal">nil</span> &#123;</span><br><span class="line">table.cleanupTimer.Stop()</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> table.cleanupInterval &gt; <span class="number">0</span> &#123;</span><br><span class="line">table.log(<span class="string">&quot;Expiration check triggered after&quot;</span>, table.cleanupInterval, <span class="string">&quot;for table&quot;</span>, table.name)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// cleanupInterval ä¸º0æ—¶ï¼Œä»£è¡¨æ²¡æœ‰å®šæ—¶å»æ‰§è¡Œè¿‡æœŸæ£€æŸ¥ä»»åŠ¡</span></span><br><span class="line">table.log(<span class="string">&quot;Expiration check installed for table&quot;</span>, table.name)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// To be more accurate with timers, we would need to update &#x27;now&#x27; on every</span></span><br><span class="line"><span class="comment">// loop iteration. Not sure it&#x27;s really efficient though.</span></span><br><span class="line">now := time.Now()</span><br><span class="line">smallestDuration := <span class="number">0</span> * time.Second</span><br><span class="line"><span class="comment">// éå†ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œæ‰¾å‡ºæœ€å…ˆè¿‡æœŸçš„æ—¶é—´å·®</span></span><br><span class="line"><span class="keyword">for</span> key, item := <span class="keyword">range</span> table.items &#123;</span><br><span class="line"><span class="comment">// Cache values so we don&#x27;t keep blocking the mutex.</span></span><br><span class="line">item.RLock()</span><br><span class="line">lifeSpan := item.lifeSpan</span><br><span class="line">accessedOn := item.accessedOn</span><br><span class="line">item.RUnlock()</span><br><span class="line"><span class="comment">// lifeSpanä¸º0ï¼Œä»£è¡¨ç”¨ä¸è¿‡æœŸ</span></span><br><span class="line"><span class="keyword">if</span> lifeSpan == <span class="number">0</span> &#123;</span><br><span class="line"><span class="keyword">continue</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> now.Sub(accessedOn) &gt;= lifeSpan &#123;</span><br><span class="line"><span class="comment">// è¿‡æœŸçš„åˆ™åˆ æ‰</span></span><br><span class="line">table.deleteInternal(key)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">// Find the item chronologically closest to its end-of-lifespan.</span></span><br><span class="line"><span class="comment">// è¿™ä¸ªåˆ†æ”¯ä¸­ lifeSpan-now.Sub(accessedOn) ä¸€å®šå¤§äº 0ï¼Œå¦‚æœå°äº0çš„è¯ï¼Œä¼šè¢«ifæ‹¦æˆª</span></span><br><span class="line"><span class="keyword">if</span> smallestDuration == <span class="number">0</span> || lifeSpan-now.Sub(accessedOn) &lt; smallestDuration &#123;</span><br><span class="line">smallestDuration = lifeSpan - now.Sub(accessedOn)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Setup the interval for the next cleanup run.</span></span><br><span class="line">table.cleanupInterval = smallestDuration</span><br><span class="line"><span class="comment">// smallestDuration &lt;= 0æ—¶ï¼Œä¸å†æ‰§è¡Œå®šæ—¶æ£€æŸ¥ä»»åŠ¡</span></span><br><span class="line"><span class="comment">// smallestDuration åªèƒ½ç­‰äºæˆ–è€…å¤§äº0</span></span><br><span class="line"><span class="keyword">if</span> smallestDuration &gt; <span class="number">0</span> &#123;</span><br><span class="line"><span class="comment">// smallestDurationå¤§äº0ï¼Œåˆ™è®¾ç½®å®šæ—¶æ‰§è¡Œä»»åŠ¡</span></span><br><span class="line">table.cleanupTimer = time.AfterFunc(smallestDuration, <span class="function"><span class="keyword">func</span><span class="params">()</span></span> &#123;</span><br><span class="line"><span class="comment">// åç¨‹</span></span><br><span class="line"><span class="keyword">go</span> table.expirationCheck()</span><br><span class="line">&#125;)</span><br><span class="line">&#125;</span><br><span class="line">table.Unlock()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Addç›¸å…³çš„ä»£ç å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œä¸‹é¢çœ‹ä¸‹Value</p><blockquote><p>Value</p></blockquote><p>Valueæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">Value</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, args ...<span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*CacheItem, error)</span></span> &#123;</span><br><span class="line">table.RLock()</span><br><span class="line">r, ok := table.items[key]</span><br><span class="line"><span class="comment">// ç¼“å­˜ä¸­æ²¡æœ‰å‘½ä¸­æ—¶åˆ°å›è°ƒå‡½æ•°</span></span><br><span class="line">loadData := table.loadData</span><br><span class="line">table.RUnlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> ok &#123;</span><br><span class="line"><span class="comment">// ç¼“å­˜ä¸­æœ‰æ•°æ®ï¼Œè°ƒç”¨CacheItemçš„KeepAliveæ›´æ–°è®¿é—®æ—¶é—´å’Œè®¿é—®æ¬¡æ•°</span></span><br><span class="line">r.KeepAlive()</span><br><span class="line"><span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å›è°ƒå‡½æ•°ä¸ä¸ºnullæ—¶ï¼Œæ‰§è¡Œå…·ä½“çš„å›è°ƒå‡½æ•°ï¼Œ</span></span><br><span class="line"><span class="comment">// argså‚æ•°æ˜¯ä¼ é€’ç»™å›è°ƒå‡½æ•°çš„</span></span><br><span class="line"><span class="keyword">if</span> loadData != <span class="literal">nil</span> &#123;</span><br><span class="line">item := loadData(key, args...)</span><br><span class="line"><span class="keyword">if</span> item != <span class="literal">nil</span> &#123;</span><br><span class="line">table.Add(key, item.lifeSpan, item.data)</span><br><span class="line"><span class="keyword">return</span> item, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰é”™è¯¯ç±»å‹</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ErrKeyNotFoundOrLoadable</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰é”™è¯¯ç±»å‹</span></span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ErrKeyNotFound</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨mycachedapp.goä¸­è°ƒç”¨çš„Valueæ–¹æ³•æ˜¯<code>cache.Value(&quot;someKey&quot;)</code>ï¼Œè€Œè¿™é‡Œçš„Valueå‡½æ•°å´æ˜¯ä¼ å…¥ä¸¤ä¸ªå‚æ•°ï¼Œè¿™é‡Œçš„ç¬¬äºŒä¸ªå‚æ•°æ˜¯å¯å˜é•¿åº¦çš„å‚æ•°ï¼Œé•¿åº¦å¯ä»¥ä¸º0ï¼Œæ‰€ä»¥å¯ä»¥ä¼ å¦‚ä¸€ä¸ªå‚æ•°ã€‚</p><blockquote><p>Delete</p></blockquote><p>Deleteæ–¹æ³•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">Delete</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*CacheItem, error)</span></span> &#123;</span><br><span class="line">table.Lock()</span><br><span class="line"><span class="comment">// åœ¨æ–¹æ³•æ‰§è¡Œå®Œä¹‹åï¼Œæ‰§è¡ŒUnlock</span></span><br><span class="line"><span class="keyword">defer</span> table.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> table.deleteInternal(key)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">deleteInternal</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span> <span class="params">(*CacheItem, error)</span></span> &#123;</span><br><span class="line"><span class="comment">// golangä»mapä¸­å–å€¼é¿å…nullå€¼çš„è¯­æ³•</span></span><br><span class="line">r, ok := table.items[key]</span><br><span class="line"><span class="keyword">if</span> !ok &#123;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">nil</span>, ErrKeyNotFound</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Cache value so we don&#x27;t keep blocking the mutex.</span></span><br><span class="line"><span class="comment">// åˆ é™¤æ•°æ®æ—¶çš„å›è°ƒå‡½æ•°</span></span><br><span class="line">aboutToDeleteItem := table.aboutToDeleteItem</span><br><span class="line">table.Unlock()</span><br><span class="line"></span><br><span class="line"><span class="comment">// Trigger callbacks before deleting an item from cache.</span></span><br><span class="line"><span class="keyword">if</span> aboutToDeleteItem != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, callback := <span class="keyword">range</span> aboutToDeleteItem &#123;</span><br><span class="line">callback(r)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r.RLock()</span><br><span class="line"><span class="comment">// è¿™é‡Œçš„deferæ˜¯åœ¨å‡½æ•°çš„æœ€åæ‰§è¡ŒRUnlockå§</span></span><br><span class="line"><span class="keyword">defer</span> r.RUnlock()</span><br><span class="line"><span class="comment">// ä¸ºä»€ä¹ˆä¸¤ä¸ªå›è°ƒå‡½æ•°</span></span><br><span class="line"><span class="keyword">if</span> r.aboutToExpire != <span class="literal">nil</span> &#123;</span><br><span class="line"><span class="keyword">for</span> _, callback := <span class="keyword">range</span> r.aboutToExpire &#123;</span><br><span class="line">callback(key)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">table.Lock()</span><br><span class="line">table.log(<span class="string">&quot;Deleting item with key&quot;</span>, key, <span class="string">&quot;created on&quot;</span>, r.createdOn, <span class="string">&quot;and hit&quot;</span>, r.accessCount, <span class="string">&quot;times from table&quot;</span>, table.name)</span><br><span class="line"><span class="comment">// mapçš„ç³»ç»Ÿå‡½æ•°è¿›è¡Œæ•°æ®åˆ é™¤</span></span><br><span class="line"><span class="built_in">delete</span>(table.items, key)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> r, <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Deleteæ–¹æ³•äºAddç±»ä¼¼ï¼Œéƒ½æ˜¯åœ¨å…¶å†…éƒ¨è°ƒç”¨äº†å¦ä¸€ä¸ªå†…éƒ¨å‡½æ•°ï¼Œå…·ä½“çš„é€»è¾‘åœ¨å…¶å†…éƒ¨å‡½æ•°ä¸­ï¼Œè¿™é‡Œæ˜¯<code>deleteInternal</code>æ–¹æ³•ã€‚ä»£ç å’Œè¯­æ³•éƒ½æ¯”è¾ƒç®€å•ï¼Œå°±ä¸è¿‡å¤šå±•å¼€äº†ã€‚<br>æ¥ä¸‹æ¥çœ‹ä¸‹å¦‚ä½•æ¸…ç©ºç¼“å­˜ï¼Œæ–¹æ³•æ˜¯<code>Flush</code>ã€‚</p><blockquote><p>Flush</p></blockquote><p>Flushæ–¹æ³•çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(table *CacheTable)</span> <span class="title">Flush</span><span class="params">()</span></span> &#123;</span><br><span class="line">table.Lock()</span><br><span class="line"><span class="keyword">defer</span> table.Unlock()</span><br><span class="line"></span><br><span class="line">table.log(<span class="string">&quot;Flushing table&quot;</span>, table.name)</span><br><span class="line"><span class="comment">// ç›´æ¥å°†ä¸€ä¸ªæ–°çš„mapèµ‹å€¼ç»™itemsï¼Œè€mapç­‰ç€è‡ªåŠ¨å›æ”¶</span></span><br><span class="line">table.items = <span class="built_in">make</span>(<span class="keyword">map</span>[<span class="keyword">interface</span>&#123;&#125;]*CacheItem)</span><br><span class="line">table.cleanupInterval = <span class="number">0</span></span><br><span class="line"><span class="keyword">if</span> table.cleanupTimer != <span class="literal">nil</span> &#123;</span><br><span class="line">table.cleanupTimer.Stop()</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»‹ç»åˆ°è¿™é‡Œï¼Œ<code>cachetable.go</code>ä¸­çš„ä»£ç å°±å‡ ä¹æ’¸å®Œäº†ï¼Œä¸è¿‡è¿˜æœ‰ä¸ªåŠŸèƒ½éœ€è¦æä¸‹ï¼Œå°±æ˜¯ç»Ÿè®¡ç¼“å­˜ä¸­è®¿é—®æ¬¡æ•°æœ€å¤šçš„æ•°æ®ï¼Œæ–¹æ³•åä¸º<code>MostAccessed</code>ï¼Œä»£ç ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé‡ç‚¹ä»‹ç»ä¸‹è¿™ä¸ªæ’åºåŠŸèƒ½ã€‚<br>æ’åºæ˜¯å…ˆå°†ç¼“å­˜ä¸­çš„æ•°æ®æ”¾å…¥åˆ‡ç‰‡ä¸­ï¼Œç„¶åè°ƒç”¨<code>sort.Sort</code>å¯¹åˆ‡ç‰‡è¿›è¡Œæ’åºï¼Œè°ƒç”¨<code>sort.Sort</code>æ—¶ï¼Œéœ€è¦ä¼ å…¥çš„é›†åˆæ˜¯å¯æ¯”ç±»å‹çš„ï¼Œè€Œä¸”è¿˜å¯ä»¥é‡å†™æ¯”è¾ƒå™¨ï¼Œç±»ä¼¼javaä¸­çš„ä½¿ç”¨æ–¹å¼ã€‚<br>ä»£ç ä¸­å…ˆå£°æ˜äº†ä¸€ä¸ª<code>CacheItemPair</code>ç»“æ„ä½“ï¼Œç”¨æ¥ä½œä¸ºæ¯”è¾ƒå¯¹è±¡ï¼Œåªå­˜å‚¨Keyå’Œè®¿é—®æ¬¡æ•°å…³é”®ä¿¡æ¯ï¼Œå‡å°‘å†…å­˜æ¶ˆè€—ï¼Œå…¶æ¬¡å£°æ˜ä¸€ä¸ªåˆ‡ç‰‡ç±»å‹çš„<code>CacheItemPairList</code>ï¼Œå¹¶å®ç°äº†å¯æ¯”çš„ç›¸å…³å‡½æ•°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CacheItemPair <span class="keyword">struct</span> &#123;</span><br><span class="line">Key         <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line">AccessCount <span class="keyword">int64</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">type</span> CacheItemPairList []CacheItemPair</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p CacheItemPairList)</span> <span class="title">Swap</span><span class="params">(i, j <span class="keyword">int</span>)</span></span>      &#123; p[i], p[j] = p[j], p[i] &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p CacheItemPairList)</span> <span class="title">Len</span><span class="params">()</span> <span class="title">int</span></span>           &#123; <span class="keyword">return</span> <span class="built_in">len</span>(p) &#125;</span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p CacheItemPairList)</span> <span class="title">Less</span><span class="params">(i, j <span class="keyword">int</span>)</span> <span class="title">bool</span></span> &#123; <span class="keyword">return</span> p[i].AccessCount &gt; p[j].AccessCount &#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤ï¼Œ<code>cachetable.go</code>çš„ç›¸å…³ä»£ç å°±ç®—ä»‹ç»å®Œäº†ï¼Œå‰©ä¸‹çš„å°±æ˜¯äº›å›è°ƒå‡½æ•°çš„è®¾ç½®ä»¥åŠä¸€äº›å¸¸è§„ç”¨æ³•ï¼Œæ¯”è¾ƒç®€å•ã€‚<br>äº†è§£äº†<code>cachetable.go</code>ç›¸å…³ä»£ç ä¹‹åï¼Œç¼“å­˜çš„å†…å­˜ç»“æ„å…¶å®ä¹Ÿå°±æ¸…æ¥šäº†ï¼Œä¹Ÿå°±å¯¹æ•´ä¸ªç¼“å­˜çš„æ¶æ„æœ‰äº†åˆæ­¥çš„äº†è§£ï¼Œå°±æ„Ÿè§‰å…¶å®å¾ˆç®€å•ï¼Œå…¶å†…å­˜ç»“æ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/cache2go-src/cache2go.png" alt="cache2goå†…å­˜ç»“æ„" title="cache2goå†…å­˜ç»“æ„"></p><h2 id="CacheItem"><a href="#CacheItem" class="headerlink" title="CacheItem"></a>CacheItem</h2><p>CacheTableäº†è§£ä¹‹åï¼Œå†æ¥çœ‹ä¸‹CacheItemï¼Œåœ¨è¯»CacheTableç›¸å…³ä»£ç çš„æ—¶å€™å…¶å®å·²ç»æ¶‰åŠåˆ°ä¸€äº›CacheItemç›¸å…³çš„ä»£ç ï¼Œä»ä¸­å¯ä»¥çœ‹å‡ºCacheItemä»£ç å¹¶ä¸å¤æ‚ï¼Œæ¯”è¾ƒç®€å•æ˜“æ‡‚ã€‚</p><p>CacheItemç›¸å…³çš„å±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">type</span> CacheItem <span class="keyword">struct</span> &#123;</span><br><span class="line"><span class="comment">// åŒ¿åå˜é‡</span></span><br><span class="line">sync.RWMutex</span><br><span class="line"></span><br><span class="line"><span class="comment">// The item&#x27;s key.</span></span><br><span class="line">key <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="comment">// The item&#x27;s data.</span></span><br><span class="line">data <span class="keyword">interface</span>&#123;&#125;</span><br><span class="line"><span class="comment">// How long will the item live in the cache when not being accessed/kept alive.</span></span><br><span class="line">lifeSpan time.Duration</span><br><span class="line"></span><br><span class="line"><span class="comment">// Creation timestamp.</span></span><br><span class="line">createdOn time.Time</span><br><span class="line"><span class="comment">// Last access timestamp.</span></span><br><span class="line">accessedOn time.Time</span><br><span class="line"><span class="comment">// How often the item was accessed.</span></span><br><span class="line">accessCount <span class="keyword">int64</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Callback method triggered right before removing the item from the cache</span></span><br><span class="line">aboutToExpire []<span class="function"><span class="keyword">func</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;)</span></span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨golangä¸­ï¼Œé’ˆå¯¹ç»“æ„ä½“å¹¶æ²¡æœ‰å¯¹è¡Œçš„<strong>æ„é€ å‡½æ•°</strong>ï¼Œä½†æ˜¯å¯¹äºä¹ æƒ¯ä½¿ç”¨æ„é€ å‡½æ•°çš„äººæ¥è¯´è¯¥æ€ä¹ˆåŠå‘¢ï¼Ÿäºæ˜¯æœ‰äº†ä¸€ç§çº¦å®šä¿—æˆçš„è¯­æ³•ï¼Œé‚£å°±æ˜¯å°†å‡½æ•°å‘½åä¸º<code>NewXXX</code>å½¢å¼ï¼Œä»¥æ­¤è¡¨ç¤ºè¯¥ç»“æ„ä½“çš„æ„é€ å‡½æ•°ï¼Œcacheitem.goä¸­å°±ç”¨åˆ°äº†è¿™ç§å‘½åæ–¹å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">NewCacheItem</span><span class="params">(key <span class="keyword">interface</span>&#123;&#125;, lifeSpan time.Duration, data <span class="keyword">interface</span>&#123;&#125;)</span> *<span class="title">CacheItem</span></span> &#123;</span><br><span class="line">t := time.Now()</span><br><span class="line"><span class="keyword">return</span> &amp;CacheItem&#123;</span><br><span class="line">key:           key,</span><br><span class="line">lifeSpan:      lifeSpan,</span><br><span class="line">createdOn:     t,</span><br><span class="line">accessedOn:    t,</span><br><span class="line">accessCount:   <span class="number">0</span>,</span><br><span class="line">aboutToExpire: <span class="literal">nil</span>,</span><br><span class="line">data:          data,</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç çœ‹åˆ°è¿™é‡Œåº”è¯¥å¯¹cache2goæ•´ä¸ªæºç éƒ½å·²äº†è§£äº†ï¼Œè€Œä¸”å¯¹golangä¹Ÿæœ‰äº†è¿›ä¸€æ­¥çš„ç†è§£å§ï¼Œåªæ˜¯å…¶ä¸­è¿˜æœ‰å¾ˆå¤šè¯­æ³•ä»¥åŠç”¨æ³•ä¸å¤ªç†Ÿæ‚‰ï¼Œéšåå¤šçœ‹å¤šå†™å°±OKäº†ï¼Œä¸‹ä¸€ç¯‡æˆ‘ä¼šæ ¹æ®è¿™ä¸ªé¡¹ç›®ä¸­æ¶‰åŠåˆ°çš„çŸ¥è¯†ç‚¹è¿›è¡Œæ¢³ç†æ‰©å±•ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> golang </tag>
            
            <tag> cache2go </tag>
            
            <tag> æºç  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flink windowè§£å¯†</title>
      <link href="/Flink-Window-Decode.html"/>
      <url>/Flink-Window-Decode.html</url>
      
        <content type="html"><![CDATA[<p>è¿‘å‡ å¹´æµå¤„ç†ç®€ç›´ç«çš„ä¸€å¡Œç³Šæ¶‚ï¼ŒFlinkä¹Ÿåœ¨é˜¿é‡Œçš„æ¨å¹¿ä¸‹é€æ¸æˆä¸ºä¸šç•Œä¸»æµï¼Œæ­£åœ¨é€æ­¥å–ä»£Stormå’ŒSpark Streamingã€‚<br>Flinkå¤©ç”Ÿå°±æ˜¯ä¸ºäº†å¤„ç†æµï¼Œè€Œä¸”ç›¸å¯¹äºå…¶ä»–æµå¤„ç†æ¡†æ¶é›†æˆäº†å¾ˆå¤šå®ç”¨åŠŸèƒ½ï¼Œæ¯”å¦‚çŠ¶æ€ç®¡ç†ï¼›Flinkè¿˜ä¸°å¯Œäº†windowçš„åŠŸèƒ½ï¼Œä½¿windowä¹Ÿæˆä¸ºäº†Flinkçš„ä¸€ä¸ªç‰¹è‰²ã€‚<br>æœ¬ç¯‡ä¸»è¦å¯¹windowä»å¤šç§è§’åº¦è¿›è¡Œè§£å¯†ï¼Œä¸»è¦åŒ…æ‹¬ï¼š</p><ul><li>ä½•ä¸ºwindow</li><li>å¦‚ä½•ä½¿ç”¨</li><li>å¦‚ä½•å®ç°</li><li>å„ç»„ä»¶åŸç†</li></ul><blockquote><p>åœ¨è§£å¯†windowä¹‹å‰ï¼Œç®€å•ä»‹ç»ä¸‹ä½•ä¸ºæµå¤„ç†ï¼Ÿ</p></blockquote><span id="more"></span><p>æµæ˜¯æŒ‡ä¸€ç§æºæºä¸æ–­çš„å½¢æ€ï¼Œæµå¤„ç†æ˜¯ä¸€ç§è¢«è®¾è®¡æ¥å¤„ç†æ— ç•Œæ•°æ®é›†çš„æ•°æ®å¤„ç†ç³»ç»Ÿå¼•æ“ï¼Œæ— ç•Œçš„æ•°æ®é›†æ˜¯æŒ‡æ²¡æœ‰è¾¹ç•Œï¼Œæ•°é‡ä¸Šæ˜¯æ— ç©·çš„ä¸€ç±»æ•°æ®é›†ã€‚<br>Flinkå°†æµå¤„ç†æ€»ç»“ä¸ºå››ä¸ªå•è¯ï¼š what where when how</p><ul><li><p>what â€“ What results are calculated(è®¡ç®—çš„ç»“æœæ˜¯ä»€ä¹ˆ)</p></li><li><p>where â€“ Where in event time are results calculated(åœ¨äº‹ä»¶æ—¶é—´ä¸­çš„å“ªä¸ªä½ç½®è®¡ç®—ç»“æœ)</p></li><li><p>when â€“ When in processing time are results materialized(åœ¨å¤„ç†æ—¶é—´ä¸­çš„å“ªä¸ªæ—¶åˆ»è§¦å‘è®¡ç®—ç»“æœ)</p></li><li><p>how â€“ How do refinements of results relate(å¦‚ä½•ä¿®æ­£ç»“æœ)</p></li></ul><!-- ä¸ºä»€ä¹ˆFlinkå¤©ç”Ÿå°±æ˜¯ç”¨æ¥å¤„ç†æµçš„ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ windowä¸ä¹Ÿç›¸å½“äºä¸€ä¸ªå¾®æ‰¹å—ï¼Ÿ --><blockquote><p>æ—¢ç„¶æµå¤„ç†æœ‰è¿™ä¹ˆå¤šçš„é—®é¢˜éœ€è¦è§£å†³ï¼Œé‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦è¿›è¡Œæµè®¡ç®—ï¼Ÿ</p></blockquote><ol><li>åœ¨å•†ä¸šç«äº‰ä¸­æåº¦æ¸´æœ›æ›´å¿«çš„æ•°æ®ï¼Œè€Œè½¬æ¢æˆæµè®¡ç®—åˆ™æ˜¯ä¸€ä¸ªå¥½çš„æ–¹æ³•æ¥é™ä½å»¶è¿Ÿã€‚</li><li>æµ·é‡çš„ã€æ— ç©·æ•°æ®é›†åœ¨ç°åœ¨çš„å•†ä¸šç¯å¢ƒé‡Œå˜çš„è¶Šæ¥è¶Šå¸¸è§ï¼Œè€Œç”¨ä¸“é—¨è®¾è®¡æ¥å¤„ç†è¿™æ ·æ•°æ®çš„ç³»ç»Ÿæ¥åº”å¯¹è¿™äº›æ•°æ®åˆ™æ›´ä¸ºå®¹æ˜“ã€‚</li><li>åœ¨æ•°æ®åˆ°è¾¾æ—¶å°±å¯¹ä»–ä»¬è¿›è¡Œå¤„ç†èƒ½å¤Ÿæ›´åŠ å¹³å‡åœ°æŠŠè´Ÿè½½è¿›è¡Œå‡è¡¡ï¼Œå–å¾—æ›´å¥½çš„ä¸€è‡´æ€§å’Œæ›´å¯é¢„æµ‹çš„è®¡ç®—èµ„æºæ¶ˆè€—ã€‚</li></ol><!--æµæ•°æ®ï¼Œwhen where what how ç‰¹ç‚¹ æ— ç•Œ    è®¡ç®—çš„ç»“æœæ˜¯ä»€ä¹ˆï¼ˆWhat results are calculatedï¼‰ï¼Ÿ é€šè¿‡transformationsæ“ä½œ transformationsæ˜¯ä»¥ä¸€ä¸ªæˆ–å¤šä¸ªstreamä½œä¸ºè¾“å…¥çš„æŸç§operation  æ•°æ®é›†ä¹‹é—´çš„è½¬æ¢    åœ¨äº‹ä»¶æ—¶é—´ä¸­çš„å“ªä¸ªä½ç½®è®¡ç®—ç»“æœï¼ˆWhere in event time are results calculatedï¼‰ï¼Ÿ ä½¿ç”¨çª—å£ï¼ˆwindowingï¼‰çš„æ¦‚å¿µ    åœ¨å¤„ç†æ—¶é—´ä¸­çš„å“ªä¸ªæ—¶åˆ»è§¦å‘è®¡ç®—ç»“æœï¼ˆWhen in processing time are results materializedï¼‰ï¼Ÿ ä½¿ç”¨triggers + watermarksè¿›è¡Œè§¦å‘è®¡ç®—    å¦‚ä½•ä¿®æ­£ç»“æœï¼ˆHow do refinements of results relateï¼‰ï¼Ÿé€šè¿‡accumulationçš„ç±»å‹ä¿®æ­£ç»“æœæ•°æ®--><h2 id="ä½•ä¸ºwindow"><a href="#ä½•ä¸ºwindow" class="headerlink" title="ä½•ä¸ºwindow"></a>ä½•ä¸ºwindow</h2><p>windowå›ç­”äº†whereè¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºåœ¨æµå¤„ç†åº”ç”¨ä¸­ï¼Œæ•°æ®æ˜¯è¿ç»­ä¸æ–­çš„ï¼Œæˆ‘ä»¬ä¸å¯èƒ½ç­‰åˆ°æ‰€æœ‰æ•°æ®éƒ½åˆ°äº†æ‰å¼€å§‹å¤„ç†ï¼Œå†µä¸”æˆ‘ä»¬ä¹Ÿæ— æ³•åˆ¤æ–­æ‰€æœ‰çš„æ•°æ®ä½•æ—¶èƒ½å®Œæ•´åˆ°æ¥ã€‚è€Œä¸”åœ¨å®é™…çš„ç¯å¢ƒä¸­ä¹Ÿéœ€è¦åšä¸€äº›èšåˆè®¡ç®—ï¼Œä¾‹å¦‚è®¡ç®—è¿‡å»5åˆ†é’ŸæŸä¸ªé¡µé¢çš„UVï¼Œè¿™å°±å¿…é¡»å®šä¹‰ä¸€ä¸ªçª—å£ï¼Œç”¨æ¥æ”¶é›†å¹¶è®¡ç®—è¿™5åˆ†é’Ÿå†…çš„æ•°æ®ã€‚æ‰€ä»¥windowå¾ˆå¥½çš„å›ç­”äº†whereè¿™ä¸ªé—®é¢˜ï¼Œä»–å†³å®šäº†æ•°æ®åœ¨å“ªé‡Œè¢«è®¡ç®—ã€‚</p><p>windowæ˜¯æ— é™æµä¸Šä¸€ç§æ ¸å¿ƒæœºåˆ¶ï¼Œå…¶æŒ‰ç…§æ—¶é—´è¾¹ç•Œå¯¹æ•°æ®æºè¿›è¡Œåˆ‡åˆ†ï¼Œåˆ‡åˆ†æ–¹å¼åˆ†ä¸ºå›ºå®šçª—å£ã€æ»‘åŠ¨çª—å£å’Œä¼šè¯çª—å£ä¸‰ç§ï¼ŒåŒæ—¶ï¼Œåœ¨å¯ä»¥åœ¨çª—å£å†…è¿›è¡Œèšåˆï¼Œä»è€ŒæŠŠæºæºä¸æ–­äº§ç”Ÿçš„æ•°æ®æ ¹æ®ä¸åŒçš„æ¡ä»¶åˆ’åˆ†æˆä¸€æ®µä¸€æ®µæœ‰è¾¹ç•Œçš„æ•°æ®åŒºé—´ï¼Œä½¿ç”¨æˆ·èƒ½å¤Ÿåˆ©ç”¨çª—å£åŠŸèƒ½å®ç°å¾ˆå¤šå¤æ‚çš„ç»Ÿè®¡åˆ†æéœ€æ±‚ã€‚å…·ä½“å®ç°æ—¶ï¼Œçª—å£åˆå¯ä»¥æ˜¯ä¸¥æ ¼æŒ‰ç…§æ—¶é—´æ¥é©±åŠ¨ï¼Œä¾‹å¦‚TimeWindowï¼›ä¹Ÿå¯ä»¥ç”±æ•°æ®é©±åŠ¨ï¼Œä¾‹å¦‚CountWindowã€‚åˆ‡åˆ†æ–¹å¼å¦‚å›¾<br><img src="/blogimgs/flink-window/windowing-chop.jpg" alt="windowåˆ‡åˆ†æ–¹å¼" title="windowåˆ‡åˆ†æ–¹å¼"></p><blockquote><p>å›ºå®šçª—å£(Fixed windows)</p></blockquote><p>å›ºå®šçª—å£æŒ‰ç…§å›ºå®šçš„é•¿åº¦è¿›è¡Œåˆ†ç‰‡ï¼Œè¿™ä¸ªå›ºå®šçš„é•¿åº¦å¯ä»¥æ—¶é—´ç»´åº¦ä¹Ÿå¯ä»¥æ˜¯æ•°æ®ç»´åº¦ã€‚å¦‚ä¸Šå›¾ä¸­çº¢è‰²çš„åˆ’åˆ†æ–¹å¼ï¼Œè¿™ä¸ªå›ºå®šçš„é•¿åº¦å¯ä»¥æ˜¯æ¯1åˆ†é’Ÿä¹Ÿå¯ä»¥æ˜¯æ¯100ä¸ªå…ƒç´ ã€‚<br>å›ºå®šçª—å£å…¸å‹åœ°ä¼šå¯¹æ‰€æœ‰çš„æ•°æ®é›†è¿›è¡Œç­‰ä»½åˆ’åˆ†ï¼Œä¹Ÿå«å¯¹é½çª—å£ã€‚åœ¨æŸäº›æƒ…å½¢ä¸‹ï¼Œå¯èƒ½ä¼šå¸Œæœ›å¯¹ä¸åŒçš„æ•°æ®å­é›†åº”ç”¨ä¸åŒçš„ç›¸ä½åç§»ï¼Œä»è€Œèƒ½è®©åˆ†ç‰‡çš„å®Œæ•´åº¦æ›´åŠ çš„å¹³å‡ã€‚è¿™æ—¶å°±ä¸å†æ˜¯å¯¹é½çª—å£ï¼Œè€Œæ˜¯éå¯¹é½çª—å£ã€‚</p><blockquote><p>æ»‘åŠ¨çª—å£(Sliding windows)</p></blockquote><p>æ»‘åŠ¨çª—å£æ˜¯å›ºå®šçª—å£çš„ä¸€ä¸ªæ›´ä¸€èˆ¬åŒ–çš„å½¢å¼ï¼Œæ»‘åŠ¨çª—å£ä¸€èˆ¬ä¼šå®šä¹‰ä¸¤ä¸ªå±æ€§ï¼Œå³çª—å£å¤§å°ï¼ˆæ—¶é—´é•¿çŸ­ï¼‰å’Œæ»‘åŠ¨æ—¶é—´ã€‚<strong>å¦‚æœæ»‘åŠ¨æ—¶é—´æ¯”çª—å£è¦å°ï¼Œåˆ™çª—å£ä¼šé‡å ï¼›å¦‚æœç›¸ç­‰ï¼Œè¿™å°±æ˜¯å›ºå®šçª—å£ï¼›å¦‚æœæ»‘åŠ¨æ—¶é—´æ¯”çª—å£å¤§ï¼Œå°±äº§ç”Ÿäº†ä¸€ç§ç‰¹æ®Šçš„æ•°æ®é‡‡æ ·ï¼Œä¹Ÿå°±æ˜¯æŒ‰æ—¶é—´åªçœ‹æ•°æ®é›†é‡Œçš„ä¸€éƒ¨åˆ†å­é›†çš„æ•°æ®ã€‚</strong>ç±»ä¼¼äºå›ºå®šçª—å£ï¼Œæ»‘åŠ¨çª—å£ä¸€èˆ¬ä¹Ÿæ˜¯å¯¹é½çš„ã€‚å‡ºäºæ€§èƒ½è€ƒè™‘ä¹Ÿä¼šåœ¨æŸäº›æƒ…å†µä¸‹æ˜¯éå¯¹é½çš„ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸Šå›¾ä¸­è“è‰²éƒ¨åˆ†ä¸ºäº†èƒ½è¡¨æ˜æ»‘åŠ¨çš„æ€§è´¨è€Œæ²¡æœ‰æŠŠæ¯ä¸ªçª—å£å¯¹åº”åˆ°æ‰€æœ‰çš„é”®ã€‚å®é™…æƒ…å†µé‡Œæ˜¯éƒ½è¦å¯¹åº”åˆ°çš„ã€‚</p><blockquote><p>ä¼šè¯çª—å£(Sessions)</p></blockquote><p>ä¼šè¯æ˜¯æŒ‡åœ¨ä¸æ´»è·ƒæ—¶é—´æ®µä¹‹é—´çš„ä¸€è¿ä¸²äº‹ä»¶ï¼Œè¿™ä¸ªä¸æ´»è·ƒæ—¶é—´ä¸€èˆ¬æ˜¯è®¾å®šçš„æ¯”è¶…æ—¶çš„æ—¶é—´è¦é•¿ï¼Œä¼šè¯çª—å£æ˜¯ä¸€ç§åŠ¨æ€çª—å£ã€‚<strong>ä¼šè¯å•å…ƒä¸€èˆ¬ç”¨æ¥åšç”¨æˆ·è¡Œä¸ºåˆ†æ</strong>ï¼Œå³è§‚å¯Ÿåœ¨ä¸€ä¸ªä¼šè¯å•å…ƒé‡Œç”¨æˆ·çš„ä¸€ç³»åˆ—äº‹ä»¶ã€‚ä¼šè¯å•å…ƒçš„é•¿åº¦ä¸€èˆ¬éƒ½æ²¡æ³•æå‰ç¡®å®šï¼Œå®Œå…¨å–å†³äºå®é™…æ•°æ®çš„æƒ…å†µã€‚ä¼šè¯å•å…ƒä¹Ÿæ˜¯éå¯¹é½çª—å£çš„ä¸€ä¸ªç»å…¸æ¡ˆä¾‹ï¼Œå› ä¸ºå®é™…æƒ…å†µä¸‹ï¼Œä¸åŒå­é›†æ•°æ®çš„ä¼šè¯å•å…ƒé•¿åº¦å‡ ä¹ä¸å¯èƒ½ä¸€è‡´åœ°å¯¹é½ã€‚</p><p>ä¸€èˆ¬è€Œè¨€ï¼Œwindowæ˜¯åœ¨æ— é™çš„æµä¸Šå®šä¹‰äº†ä¸€ä¸ªæœ‰é™çš„å…ƒç´ é›†åˆã€‚è¿™ä¸ªé›†åˆå¯ä»¥æ˜¯åŸºäºæ—¶é—´çš„ï¼Œå…ƒç´ ä¸ªæ•°çš„ï¼Œæ—¶é—´å’Œä¸ªæ•°ç»“åˆçš„ï¼Œä¼šè¯é—´éš™çš„ï¼Œæˆ–è€…æ˜¯è‡ªå®šä¹‰çš„ã€‚Flinkæä¾›äº†ç®€æ´çš„ç®—å­æ¥æ»¡è¶³å¸¸ç”¨çš„çª—å£æ“ä½œï¼ŒåŒæ—¶æä¾›äº†é€šç”¨çš„çª—å£æœºåˆ¶æ¥å…è®¸ç”¨æˆ·è‡ªå·±å®šä¹‰çª—å£åˆ†é…é€»è¾‘ã€‚ä¸‹é¢çœ‹ä¸‹Flinkå†…ç½®çš„çª—å£ã€‚</p><h2 id="Flinkæä¾›çš„å†…ç½®çª—å£ä½¿ç”¨åŠå…¶å®ç°"><a href="#Flinkæä¾›çš„å†…ç½®çª—å£ä½¿ç”¨åŠå…¶å®ç°" class="headerlink" title="Flinkæä¾›çš„å†…ç½®çª—å£ä½¿ç”¨åŠå…¶å®ç°"></a>Flinkæä¾›çš„å†…ç½®çª—å£ä½¿ç”¨åŠå…¶å®ç°</h2><p>Flinkå°†çª—å£çš„åˆ‡åˆ†è§„åˆ™åˆ†ä¸º3ç§ï¼Œ3ç§åˆ‡åˆ†è§„åˆ™Flinkéƒ½æœ‰å¯¹åº”å†…ç½®çª—å£å®ç°ï¼Œå†…ç½®çª—å£åŒ…æ‹¬æ»šåŠ¨æ—¶é—´çª—å£ã€æ»‘åŠ¨æ—¶é—´çª—å£ã€æ»šåŠ¨è®¡æ•°çª—å£ã€æ»‘åŠ¨è®¡æ•°çª—å£å’Œä¼šè¯çª—å£ã€‚è¿™é‡Œä¸ºäº†æ–¹ä¾¿å°†å†…ç½®çª—å£åˆ†ä¸º3ç±»è¿›è¡Œä»‹ç»ï¼Œä¾æ¬¡ä¸ºè®¡æ•°çª—å£countWindowã€æ—¶é—´çª—å£timeWindowå’Œä¼šè¯çª—å£sessionWindowã€‚</p><ul><li>è®¡æ•°çª—å£<br>è®¡æ•°çª—å£æ˜¯æ ¹æ®å…ƒç´ ä¸ªæ•°å¯¹æ•°æ®æµè¿›è¡Œåˆ†ç»„çš„ï¼Œåˆ†ä¸ºæ»šåŠ¨è®¡æ•°çª—å£å’Œæ»‘åŠ¨è®¡æ•°çª—å£ã€‚ä½¿ç”¨è®¡æ•°çª—å£æ—¶å…ˆå°†DataStreamè½¬æ¢ä¸ºKeyedStreamï¼Œç„¶åé€šè¿‡è°ƒç”¨countWindowå‡½æ•°è¿›è¡Œä½¿ç”¨ã€‚</li></ul><p>ä¾‹å¦‚éœ€è¦ç»Ÿè®¡æ¯100ä¸ªè®¢å•ä¸­çš„æ€»æ•°ï¼Œåˆ™ä½¿ç”¨æ»šåŠ¨è®¡æ•°çª—å£ï¼Œæ¯100ä¸ªå…ƒç´ æ»šåŠ¨ä¸€æ¬¡ï¼Œä»£ç å®ç°ä¸ºï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stream of (userId, buyCnts)</span></span><br><span class="line"><span class="keyword">val</span> buyCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> tumblingCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = buyCnts</span><br><span class="line">  .keyBy(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// æ»šåŠ¨è®¡æ•°çª—å£ï¼Œæ¯100ä¸ªå…ƒç´ æ»šåŠ¨ä¸€æ¬¡</span></span><br><span class="line">  .countWindow(<span class="number">100</span>)</span><br><span class="line">  .sum(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ä¸æ»šåŠ¨è®¡æ•°çª—å£ç›¸å¯¹çš„æ˜¯æ»‘åŠ¨è®¡æ•°çª—å£ï¼Œå¦‚æœè¦è®¡ç®—æ¯10ä¸ªå…ƒç´ è®¡ç®—ä¸€æ¬¡æœ€è¿‘100ä¸ªå…ƒç´ çš„æ€»å’Œï¼Œä½¿ç”¨æ»‘åŠ¨çª—å£ï¼Œçª—å£å¤§å°ä¸º100ï¼Œæ¯10ä¸ªå…ƒç´ æ»‘åŠ¨ä¸€æ¬¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> slidingCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = vehicleCnts</span><br><span class="line">  .keyBy(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// æ»‘åŠ¨è®¡æ•°çª—å£ï¼Œçª—å£å¤§å°ä¸º100ï¼Œæ¯10ä¸ªæ»‘åŠ¨ä¸€æ¬¡</span></span><br><span class="line">  .countWindow(<span class="number">100</span>, <span class="number">10</span>)</span><br><span class="line">  .sum(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨æ–¹å¼å¾ˆç®€å•ï¼Œè¿™é‡Œçœ‹ä¸‹countWindowçš„å…·ä½“æ˜¯å¦‚ä½•å®ç°çš„ï¼Œä¸¤ä¸ªcountWindowå‡½æ•°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ»šåŠ¨è®¡æ•°çª—å£</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowedStream&lt;T, KEY, GlobalWindow&gt; <span class="title">countWindow</span><span class="params">(<span class="keyword">long</span> size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> window(GlobalWindows.create()).trigger(PurgingTrigger.of(CountTrigger.of(size)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ»‘åŠ¨è®¡æ•°çª—å£</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowedStream&lt;T, KEY, GlobalWindow&gt; <span class="title">countWindow</span><span class="params">(<span class="keyword">long</span> size, <span class="keyword">long</span> slide)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> window(GlobalWindows.create())</span><br><span class="line">            .evictor(CountEvictor.of(size))</span><br><span class="line">            .trigger(CountTrigger.of(slide));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±countWindowçš„å®ç°å¯ä»¥çœ‹å‡ºwindowä¸°å¯Œçš„åŠŸèƒ½æ˜¯ç”±ä¸€äº›å…³é”®ç»„ä»¶ç»„åˆå®ç°çš„ï¼Œè¿™äº›ç»„ä»¶åŒ…æ‹¬evictorå’Œtriggerã€‚ä¸¤è€…ä½¿ç”¨çš„çª—å£åˆ†é…å™¨éƒ½æ˜¯<code>GlobalWindows</code>ï¼Œä¸¤è€…çš„åŒºåˆ«æ˜¯triggerï¼Œå› ä¸ºGlobalWindowsçš„é»˜è®¤triggeræ˜¯<code>NeverTrigger</code>ï¼Œæ„æ€æ˜¯ä¸è§¦å‘çª—å£è®¡ç®—ã€‚æ»šåŠ¨çª—å£çš„triggeræ˜¯å°†<code>CountTrigger</code>å°è£…æˆ<code>PurgingTrigger</code>ï¼Œæ ¹æ®çª—å£åˆ†é…çš„å…ƒç´ ä¸ªæ•°è¿›è¡Œè§¦å‘è®¡ç®—ï¼Œå¹¶ä¸”åœ¨è®¡ç®—ä¹‹åæ¸…é™¤çª—å£ä¸­çš„æ•°æ®ï¼Œä»è€Œè¾¾åˆ°æ»šåŠ¨çª—å£çš„æ•ˆæœã€‚æ»‘åŠ¨çª—å£çš„triggeråªæ˜¯ä¸€ä¸ªå•çº¯çš„<code>CountTrigger</code>ï¼Œæ ¹æ®æ»‘åŠ¨å…ƒç´ çš„ä¸ªæ•°è¿›è¡Œè®¡ç®—ï¼Œç”±äºcountWindowä½¿ç”¨çš„æ˜¯GlobalWindowsï¼Œåªæœ‰ä¸€å…±å…¨å±€çª—å£ï¼Œtriggerè§¦å‘è®¡ç®—æ—¶åˆåªæ˜¯å•çº¯çš„è®¡ç®—ç»“æœï¼Œå¹¶æœªåƒæ»šåŠ¨çª—å£é‚£æ ·æ¸…é™¤æ•°æ®ï¼Œæ‰€ä»¥æ»‘åŠ¨çª—å£ä¸­çš„æ•°æ®ä¼šè¶Šæ¥è¶Šå¤šï¼Œä¸ä»…æ€§èƒ½ä¸Šä¼šå—å½±å“ï¼Œè€Œä¸”æ•°æ®ä¹Ÿå¯èƒ½ä¼šè¢«é‡å¤è®¡ç®—ï¼Œè¿™é‡Œå¢åŠ äº†evictorå¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚</p><!-- è®¡æ•°çª—å£æ— è®ºæ˜¯æ»šåŠ¨è¿˜æ˜¯æ»‘åŠ¨çª—å£ï¼Œéƒ½åªæœ‰ä¸€ä¸ªçª—å£ï¼Œæ˜¯ä¸€ä¸ªå…¨å±€çª—å£ï¼Œä¸åƒæ—¶é—´çª—å£é‚£æ ·ï¼Œä¸€ä¸ªå…ƒç´ å¯ä»¥å½’å±å¤šä¸ªçª—å£ --><ul><li>æ—¶é—´çª—å£<br>æ—¶é—´çª—å£æ˜¯æ ¹æ®æ—¶é—´å¯¹æ•°æ®æµè¿›è¡Œåˆ†ç»„å¯¹ï¼Œä¹Ÿåˆ†ä¸ºæ»šåŠ¨æ—¶é—´çª—å£å’Œæ»‘åŠ¨æ—¶é—´çª—å£ã€‚æ—¶é—´çª—å£æŒ‰ç…§æ—¶é—´åˆ’åˆ†ï¼Œè¿™ä¸ªæ—¶é—´åœ¨Flinkä¸­æœ‰ä¸‰ç§æ¦‚å¿µï¼Œåˆ†åˆ«æ˜¯event time(äº‹ä»¶æ—¶é—´ï¼šäº‹ä»¶å‘ç”Ÿæ—¶çš„æ—¶é—´)ï¼Œingestion time(æ‘„å–æ—¶é—´ï¼šäº‹ä»¶è¿›å…¥æµå¤„ç†ç³»ç»Ÿçš„æ—¶é—´)ï¼Œprocessing time(å¤„ç†æ—¶é—´ï¼šæ¶ˆæ¯è¢«è®¡ç®—å¤„ç†çš„æ—¶é—´)ã€‚<strong>æ³¨ï¼šFlink ä¸­çª—å£æœºåˆ¶å’Œæ—¶é—´ç±»å‹æ˜¯å®Œå…¨è§£è€¦çš„ï¼Œä¹Ÿå°±æ˜¯è¯´å½“éœ€è¦æ”¹å˜æ—¶é—´ç±»å‹æ—¶ä¸éœ€è¦æ›´æ”¹çª—å£é€»è¾‘ç›¸å…³çš„ä»£ç ã€‚</strong></li></ul><p>ä¾‹å¦‚æˆ‘ä»¬éœ€è¦ç»Ÿè®¡æ¯ä¸€åˆ†é’Ÿä¸­ç”¨æˆ·è´­ä¹°çš„å•†å“çš„æ€»æ•°ï¼Œéœ€è¦å°†ç”¨æˆ·çš„è¡Œä¸ºäº‹ä»¶æŒ‰æ¯ä¸€åˆ†é’Ÿè¿›è¡Œåˆ‡åˆ†æ±‡æ€»ï¼Œè¿™ç§åˆ‡åˆ†è¢«ç§°ä¸ºæ»šåŠ¨æ—¶é—´çª—å£ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stream of (userId, buyCnt)</span></span><br><span class="line"><span class="keyword">val</span> buyCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = ...</span><br><span class="line"><span class="comment">// å°†DataStreamè½¬æ¢ä¸ºKeyedStreamï¼Œç„¶åå†ä½¿ç”¨çª—å£å‡½æ•°</span></span><br><span class="line"><span class="keyword">val</span> tumblingCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = buyCnts</span><br><span class="line">  .keyBy(<span class="number">0</span>) </span><br><span class="line">  <span class="comment">// çª—å£é•¿åº¦ä¸º1åˆ†é’Ÿçš„æ»šåŠ¨æ—¶é—´çª—å£</span></span><br><span class="line">  .timeWindow(<span class="type">Time</span>.minutes(<span class="number">1</span>))</span><br><span class="line">  .sum(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>çª—å£è®¡ç®—æ—¶ï¼Œå¯ä»¥é€‰æ‹©çª—å£åˆ‡åˆ†æ—¶ä½¿ç”¨çš„æ—¶é—´æ–¹å¼ï¼Œé»˜è®¤ä½¿ç”¨çš„æ˜¯processtimeï¼Œä½¿ç”¨<code>env.setStreamTimeCharacteristic(TimeCharacteristic.EventTime)</code>å¯¹æ—¶é—´æ–¹å¼è¿›è¡Œæ›´æ”¹ã€‚</p><p>æ—¶é—´çª—å£çš„å¦ä¸€ç§æ–¹å¼æ˜¯æ»‘åŠ¨æ—¶é—´çª—å£ï¼Œä¸»è¦ç”¨äºå¹³æ»‘åœ°è¿›è¡Œçª—å£èšåˆè®¡ç®—ã€‚å¦‚æœï¼Œéœ€è¦æ¯åˆ†é’Ÿç»Ÿè®¡ä¸‹æœ€è¿‘5åˆ†é’Ÿç”¨æˆ·è´­ä¹°çš„å•†å“æ€»æ•°ï¼Œå°±å¯ä»¥ä½¿ç”¨æ»‘åŠ¨æ—¶é—´çª—å£è¿›è¡Œè®¡ç®—ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> slidingCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = buyCnts</span><br><span class="line">  .keyBy(<span class="number">0</span>) </span><br><span class="line">  <span class="comment">// çª—å£é•¿åº¦ä¸º5åˆ†é’Ÿï¼Œæ¯1åˆ†é’Ÿæ»‘åŠ¨ä¸€æ¬¡</span></span><br><span class="line">  .timeWindow(<span class="type">Time</span>.minutes(<span class="number">5</span>), <span class="type">Time</span>.minutes(<span class="number">1</span>))</span><br><span class="line">  .sum(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>æ—¶é—´çª—å£ä½¿ç”¨æ—¶ä¾ç„¶å¾ˆç®€å•æ–¹ä¾¿ï¼Œå°†DataStreamæµè½¬æ¢ä¸ºKeyedStreamæµï¼Œè°ƒç”¨<code>timeWindow</code>è¿›è¡Œä½¿ç”¨ï¼Œä¼ å…¥ä¸€ä¸ªå‚æ•°ä»£è¡¨æ»šåŠ¨æ—¶é—´çª—å£ï¼Œä¼ å…¥ä¸¤ä¸ªå‚æ•°æ—¶ä»£è¡¨æ»‘åŠ¨æ—¶é—´çª—å£ï¼Œå…¶ä¸­ç¬¬ä¸€ä¸ªå‚æ•°ä»£è¡¨çª—å£çš„é•¿åº¦ï¼Œç¬¬äºŒä¸ªå‚æ•°ä»£è¡¨æ»‘åŠ¨çš„é•¿åº¦ã€‚å…¶å…·ä½“çš„å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ»šåŠ¨æ—¶é—´çª—å£</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowedStream&lt;T, KEY, TimeWindow&gt; <span class="title">timeWindow</span><span class="params">(Time size)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (environment.getStreamTimeCharacteristic() == TimeCharacteristic.ProcessingTime) &#123;</span><br><span class="line">        <span class="keyword">return</span> window(TumblingProcessingTimeWindows.of(size));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> window(TumblingEventTimeWindows.of(size));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æ»‘åŠ¨æ—¶é—´çª—å£</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> WindowedStream&lt;T, KEY, TimeWindow&gt; <span class="title">timeWindow</span><span class="params">(Time size, Time slide)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (environment.getStreamTimeCharacteristic() == TimeCharacteristic.ProcessingTime) &#123;</span><br><span class="line">        <span class="keyword">return</span> window(SlidingProcessingTimeWindows.of(size, slide));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> window(SlidingEventTimeWindows.of(size, slide));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>æ—¶é—´çª—å£çš„å®ç°æ¯”è®¡æ•°çª—å£è¾ƒå¤æ‚ï¼Œæ¯ç§çª—å£ç±»å‹æ ¹æ®ä¸åŒçš„æ—¶é—´è®¾ç½®éƒ½æœ‰ä¸“é—¨çš„å®ç°ï¼Œæ»šåŠ¨çª—å£çš„å®ç°æ˜¯<code>TumblingProcessingTimeWindows</code>å’Œ<code>TumblingEventTimeWindows</code>ï¼Œè€Œæ»‘åŠ¨çª—å£çš„å®ç°æ˜¯<code>SlidingProcessingTimeWindows</code>å’Œ<code>SlidingEventTimeWindows</code>ã€‚<code>TumblingProcessingTimeWindows</code>å’Œ<code>TumblingEventTimeWindows</code>çš„å®ç°é€»è¾‘ä¸€æ ·ï¼Œéƒ½æ˜¯æ ¹æ®å…ƒç´ çš„æ—¶é—´æŒ‡å®šä¸€ä¸ªæ—¶é—´çª—å£<code>TimeWindow</code>ï¼Œæ¯ä¸ªå…ƒç´ åªèƒ½å±äºä¸€ä¸ªçª—å£ï¼Œä¸åŒç‚¹åªæ˜¯è§¦å‘è®¡ç®—çš„triggerï¼Œæ ¹æ®è®¾ç½®çš„æ—¶é—´ç­–ç•¥æŒ‡å®šç›¸åº”çš„triggerï¼Œå…¶ä¸­<code>TumblingProcessingTimeWindows</code>çš„triggeræ˜¯<code>ProcessingTimeTrigger</code>ï¼Œ<code>TumblingEventTimeWindows</code>çš„triggeræ˜¯<code>EventTimeTrigger</code>ã€‚<code>SlidingProcessingTimeWindows</code>å’Œ<code>SlidingEventTimeWindows</code>åˆ’åˆ†çª—å£çš„é€»è¾‘è·Ÿ<code>TumblingProcessingTimeWindows</code>å’Œ<code>TumblingEventTimeWindows</code>ä¸€æ ·ï¼Œåªæ˜¯æ»‘åŠ¨çª—å£ä¸­ä¸€ä¸ªå…ƒç´ å¯ä»¥å½’å±å¤šä¸ªçª—å£ï¼Œæ‰€ä»¥è¿”å›çš„æ˜¯ä¸€ä¸ªçª—å£é›†åˆï¼Œè‡³äºè§¦å‘å™¨triggerå’Œæ»šåŠ¨çª—å£ä¸­çš„ä¸€æ ·ã€‚</p><ul><li>ä¼šè¯çª—å£<br>æ­¤å¤„çš„ä¼šè¯ç±»ä¼¼æµè§ˆé¡µé¢æ—¶æ‰€æŒ‡çš„ä¼šè¯ï¼Œä¼šè¯çª—å£å¹¶æ²¡æœ‰å›ºå®šæ—¶é—´é•¿åº¦ï¼Œè€Œæ˜¯æ ¹æ®äº‹ä»¶ä¹‹é—´çš„æ—¶é—´é—´éš”æ¥å†³å®šçš„ï¼Œå¦‚æœä¸¤ä¸ªäº‹ä»¶ä¹‹é—´çš„æ—¶é—´é—´éš”è¶…è¿‡é˜ˆå€¼ï¼Œåˆ™è¢«åˆ’åˆ†åˆ°ä¸åŒçš„çª—å£ä¸­ã€‚ä¾‹å¦‚ï¼Œéœ€è¦è®¡ç®—æ¯ä¸ªç”¨æˆ·åœ¨æ´»è·ƒæœŸé—´æ€»å…±è´­ä¹°çš„å•†å“æ•°é‡ï¼Œç”±äºæ¯ä¸ªç”¨æˆ·çš„æ´»è·ƒæ—¶é•¿ä¸å›ºå®šï¼Œä¸èƒ½ç»Ÿä¸€è®¾ç½®çª—å£æ—¶é•¿ï¼Œæ‰€ä»¥æ­¤æ—¶åº”è¯¥ä½¿ç”¨ä¼šè¯çª—å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Stream of (userId, buyCnts)</span></span><br><span class="line"><span class="keyword">val</span> buyCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = ...</span><br><span class="line"></span><br><span class="line"><span class="keyword">val</span> sessionCnts: <span class="type">DataStream</span>[(<span class="type">Int</span>, <span class="type">Int</span>)] = vehicleCnts</span><br><span class="line">  .keyBy(<span class="number">0</span>)</span><br><span class="line">  <span class="comment">// äº‹ä»¶ä¹‹é—´è¶…è¿‡30ç§’åˆ™åˆ’åˆ†æ–°çª—å£</span></span><br><span class="line">  .window(<span class="type">ProcessingTimeSessionWindows</span>.withGap(<span class="type">Time</span>.seconds(<span class="number">30</span>)))</span><br><span class="line">  .sum(<span class="number">1</span>)</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨ä¼šè¯çª—å£è°ƒç”¨<code>KeydeStream.window</code>æ–¹æ³•ï¼ŒåŒæ ·æ­¤æ–¹æ³•ä¹Ÿåœ¨<code>countWindow</code>å’Œ<code>timeWindow</code>ä¸­è¢«è°ƒç”¨ï¼Œå¹¶æ²¡æœ‰ä¸ºä¼šè¯çª—å£å°è£…å•ç‹¬çš„å‡½æ•°ï¼Œä½¿ç”¨æ—¶ä¼ å…¥å¯¹åº”æ—¶é—´çš„ä¼šè¯çª—å£åˆ†é…å™¨å³å¯ã€‚</p><!--æ»šåŠ¨çª—å£å…¶å®æ˜¯æ»‘åŠ¨çª—å£çš„ä¸€ç§ç‰¹æ®Šæƒ…å†µ--><!--å…¨å¤©UVæ—¥å¢UVè¿‡æ»¤æ¯5åˆ†é’Ÿæœªä¸‹å•çš„è®¢å•    æ»šåŠ¨çª—å£--><h2 id="çª—å£è¿›é˜¶"><a href="#çª—å£è¿›é˜¶" class="headerlink" title="çª—å£è¿›é˜¶"></a>çª—å£è¿›é˜¶</h2><p>å†…ç½®çª—å£ä½¿ç”¨æ¯”è¾ƒç®€å•ï¼Œ<code>WindowedStream</code>ä¹Ÿæä¾›äº†ä¸€äº›ç®€å•çš„è®¡ç®—å‡½æ•°ï¼Œä½†æ˜¯å¦‚æœè‡ªå®šä¹‰ä¸€äº›è®¡ç®—é€»è¾‘æ—¶å°±ç”¨åˆ°äº†çª—å£å‡½æ•°ã€‚<br>çª—å£å‡½æ•°åˆ†ä¸ºReduceFunctionã€AggregateFunctionã€FoldFunctionå’ŒProcessWindowFunctionã€‚å‰ä¸¤ä¸ªæ˜¯å¢é‡èšåˆå‡½æ•°ï¼Œæ€§èƒ½æ¯”è¾ƒé«˜æ•ˆï¼›ProcessWindowFunctionä¸­ä¼šåŒ…å«ä¸€ä¸ªè¿­ä»£å™¨ï¼Œè¿™ä¸ªè¿­ä»£å™¨ä¸­è®°å½•äº†çª—å£ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜åŒ…å«ä¸€äº›çª—å£çš„å…ƒä¿¡æ¯ã€‚æ¥ä¸‹æ¥çœ‹ä¸‹æ¯ä¸ªçª—å£å‡½æ•°å…·ä½“æ€ä¹ˆç”¨ã€‚</p><ul><li>ReduceFunction<br>å°†è¾“å…¥çš„ä¸¤ä¸ªå…ƒç´ è¿›è¡Œè®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªç›¸åŒç±»å‹çš„å…ƒç´ åšä¸ºè¾“å‡ºã€‚æ­¤å‡½æ•°æ˜¯å¢é‡çš„å¯¹çª—å£ä¸­çš„å…ƒç´ è¿›è¡Œè®¡ç®—ï¼Œç±»ä¼¼äºMRä¸­Reduceã€‚å…·ä½“ä½¿ç”¨ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Long&gt;&gt; input = ...;</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .reduce(<span class="keyword">new</span> ReduceFunction&lt;Tuple2&lt;String, Long&gt;&gt; &#123;</span><br><span class="line">      <span class="function"><span class="keyword">public</span> Tuple2&lt;String, Long&gt; <span class="title">reduce</span><span class="params">(Tuple2&lt;String, Long&gt; v1, Tuple2&lt;String, Long&gt; v2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(v1.f0, v1.f1 + v2.f1);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><ul><li>AggregateFunction<br>AggregateFunctionä¹Ÿæ˜¯ä¸€ä¸ªå¢é‡èšåˆçª—å£å‡½æ•°ï¼Œæ¯”ReduceFunctionæ›´åŠ é€šç”¨ï¼ŒåŒ…å«ä¸‰ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯çª—å£æµä¸­è¾“å…¥çš„å…ƒç´ ï¼Œç¬¬äºŒä¸ªæ˜¯ç´¯åŠ å™¨ï¼Œç¬¬ä¸‰ä¸ªå…ƒç´ æ˜¯è®¡ç®—ä¹‹åçš„è¾“å‡ºï¼Œç´¯åŠ å™¨å’Œè¾“å‡ºç»“æœçš„ç±»å‹éƒ½å¯ä»¥è‡ªå®šä¹‰ã€‚ä½¿ç”¨æ ·ä¾‹å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">AverageAggregate</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span> <span class="title">AggregateFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Long</span>&gt;, <span class="title">Tuple2</span>&lt;<span class="title">Long</span>, <span class="title">Long</span>&gt;, <span class="title">Double</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Tuple2&lt;Long, Long&gt; <span class="title">createAccumulator</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(<span class="number">0L</span>, <span class="number">0L</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Tuple2&lt;Long, Long&gt; <span class="title">add</span><span class="params">(Tuple2&lt;String, Long&gt; value, Tuple2&lt;Long, Long&gt; accumulator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(accumulator.f0 + value.f1, accumulator.f1 + <span class="number">1L</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Double <span class="title">getResult</span><span class="params">(Tuple2&lt;Long, Long&gt; accumulator)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> ((<span class="keyword">double</span>) accumulator.f0) / accumulator.f1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Tuple2&lt;Long, Long&gt; <span class="title">merge</span><span class="params">(Tuple2&lt;Long, Long&gt; a, Tuple2&lt;Long, Long&gt; b)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> Tuple2&lt;&gt;(a.f0 + b.f0, a.f1 + b.f1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DataStream&lt;Tuple2&lt;String, Long&gt;&gt; input = ...;</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .aggregate(<span class="keyword">new</span> AverageAggregate());</span><br></pre></td></tr></table></figure><ul><li>FoldFunction<br>çª—å£ä¸­çš„å…ƒç´ ä¸ç´¯åŠ å™¨è¿›è¡Œè®¡ç®—ï¼Œæ­¤æ—¶ç´¯åŠ å™¨æœ‰åˆå§‹å€¼ï¼Œå¹¶ä¸”è¾“å‡ºçš„ç»“æœç±»å‹å’Œç´¯åŠ å™¨ç›¸åŒã€‚æ­¤çª—å£å‡½æ•°ä¸èƒ½ç”¨åœ¨åˆå¹¶çª—å£ä¸­ï¼Œæ¯”å¦‚ä¼šè¯çª—å£ã€‚ä½¿ç”¨æ ·ä¾‹ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Long&gt;&gt; input = ...;</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">    .keyBy(&lt;key selector&gt;)</span><br><span class="line">    .window(&lt;window assigner&gt;)</span><br><span class="line">    .fold(<span class="string">&quot;&quot;</span>, <span class="keyword">new</span> FoldFunction&lt;Tuple2&lt;String, Long&gt;, String&gt;&gt; &#123;</span><br><span class="line">       <span class="function"><span class="keyword">public</span> String <span class="title">fold</span><span class="params">(String acc, Tuple2&lt;String, Long&gt; value)</span> </span>&#123;</span><br><span class="line">         <span class="keyword">return</span> acc + value.f1;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><ul><li>ProcessWindowFunction<br>ProcessWindowFunctionæœ€çµæ´»ï¼ŒåŒ…å«çš„ä¿¡æ¯ä¹Ÿè¾ƒå¤šï¼Œå¯ä»¥å¯¹æ•´ä¸ªçª—å£ä¸­çš„å…ƒç´ è¿›è¡Œè¿­ä»£è®¡ç®—ï¼Œè¿˜å¯ä»¥è®¿é—®çª—å£çš„ä¸€äº›å…ƒä¿¡æ¯ã€‚ä½†æ˜¯å•çº¯ä½¿ç”¨ProcessWindowFunctionæ—¶ï¼Œç”±äºè¦ç¼“å­˜çª—å£ä¸­çš„æ‰€æœ‰å…ƒç´ ï¼Œæ‰€ä»¥ä¼šæ¶ˆè€—ä¸€äº›èµ„æºã€‚ä½¿ç”¨æ ·ä¾‹ä»£ç å¦‚ä¸‹ï¼š</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;Tuple2&lt;String, Long&gt;&gt; input = ...;</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">  .keyBy(t -&gt; t.f0)</span><br><span class="line">  .timeWindow(Time.minutes(<span class="number">5</span>))</span><br><span class="line">  .process(<span class="keyword">new</span> MyProcessWindowFunction());</span><br><span class="line"></span><br><span class="line"><span class="comment">/* ... */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessWindowFunction</span> </span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>&lt;<span class="title">Tuple2</span>&lt;<span class="title">String</span>, <span class="title">Long</span>&gt;, <span class="title">String</span>, <span class="title">String</span>, <span class="title">TimeWindow</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String key, Context context, Iterable&lt;Tuple2&lt;String, Long&gt;&gt; input, Collector&lt;String&gt; out)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> count = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (Tuple2&lt;String, Long&gt; in: input) &#123;</span><br><span class="line">      count++;</span><br><span class="line">    &#125;</span><br><span class="line">    out.collect(<span class="string">&quot;Window: &quot;</span> + context.window() + <span class="string">&quot;count: &quot;</span> + count);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ProcessWindowFunctionä¸­è®°å½•çš„çª—å£ä¿¡æ¯åœ¨æŠ½è±¡ç±»Contextä¸­ï¼ŒProcessWindowFunctionæŠ½è±¡ç±»å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">ProcessWindowFunction</span>&lt;<span class="title">IN</span>, <span class="title">OUT</span>, <span class="title">KEY</span>, <span class="title">W</span> <span class="keyword">extends</span> <span class="title">Window</span>&gt; <span class="keyword">implements</span> <span class="title">Function</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            KEY key,</span></span></span><br><span class="line"><span class="params"><span class="function">            Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">            Iterable&lt;IN&gt; elements,</span></span></span><br><span class="line"><span class="params"><span class="function">            Collector&lt;OUT&gt; out)</span> <span class="keyword">throws</span> Exception</span>;</span><br><span class="line"></span><br><span class="line">       <span class="comment">/**</span></span><br><span class="line"><span class="comment">        * The context holding window metadata.</span></span><br><span class="line"><span class="comment">        */</span></span><br><span class="line">       <span class="keyword">public</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">Context</span> <span class="keyword">implements</span> <span class="title">java</span>.<span class="title">io</span>.<span class="title">Serializable</span> </span>&#123;</span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * Returns the window that is being evaluated.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> W <span class="title">window</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/** Returns the current processing time. */</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">currentProcessingTime</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/** Returns the current event-time watermark. */</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> <span class="keyword">long</span> <span class="title">currentWatermark</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * State accessor for per-key and per-window state.</span></span><br><span class="line"><span class="comment">            *</span></span><br><span class="line"><span class="comment">            * &lt;p&gt;&lt;b&gt;<span class="doctag">NOTE:</span>&lt;/b&gt;If you use per-window state you have to ensure that you clean it up</span></span><br><span class="line"><span class="comment">            * by implementing &#123;<span class="doctag">@link</span> ProcessWindowFunction#clear(Context)&#125;.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title">windowState</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">           <span class="comment">/**</span></span><br><span class="line"><span class="comment">            * State accessor for per-key global state.</span></span><br><span class="line"><span class="comment">            */</span></span><br><span class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> KeyedStateStore <span class="title">globalState</span><span class="params">()</span></span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶ProcessWindowFunctionæ¯”è¾ƒè€—èµ„æºï¼Œä½†æ˜¯åœ¨æœ‰äº›åœºæ™¯ä¸‹ä»–å¯ä»¥å’Œä¹‹å‰ä»‹ç»çš„å¢é‡èšåˆçª—å£å‡½æ•°ä¸€èµ·ä½¿ç”¨ï¼Œè¿™æ ·ä¸ä»…å¯ä»¥å°†å…ƒç´ è¿›è¡Œå¢é‡èšåˆå‡å°‘èµ„æºæ¶ˆè€—ï¼Œä¹Ÿå¯ä»¥è®¿é—®ProcessWindowFunctionä¸­è®°å½•çš„çª—å£å…ƒä¿¡æ¯ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯ReduceFunctionå’ŒProcessWindowFunctionç»“åˆä½¿ç”¨çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DataStream&lt;SensorReading&gt; input = ...;</span><br><span class="line"></span><br><span class="line">input</span><br><span class="line">  .keyBy(&lt;key selector&gt;)</span><br><span class="line">  .timeWindow(&lt;duration&gt;)</span><br><span class="line">  .reduce(<span class="keyword">new</span> MyReduceFunction(), <span class="keyword">new</span> MyProcessWindowFunction());</span><br><span class="line"></span><br><span class="line"><span class="comment">// Function definitions</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReduceFunction</span> <span class="keyword">implements</span> <span class="title">ReduceFunction</span>&lt;<span class="title">SensorReading</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> SensorReading <span class="title">reduce</span><span class="params">(SensorReading r1, SensorReading r2)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> r1.value() &gt; r2.value() ? r2 : r1;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyProcessWindowFunction</span></span></span><br><span class="line"><span class="class">    <span class="keyword">extends</span> <span class="title">ProcessWindowFunction</span>&lt;<span class="title">SensorReading</span>, <span class="title">Tuple2</span>&lt;<span class="title">Long</span>, <span class="title">SensorReading</span>&gt;, <span class="title">String</span>, <span class="title">TimeWindow</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(String key,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Context context,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Iterable&lt;SensorReading&gt; minReadings,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Collector&lt;Tuple2&lt;Long, SensorReading&gt;&gt; out)</span> </span>&#123;</span><br><span class="line">      SensorReading min = minReadings.iterator().next();</span><br><span class="line">      out.collect(<span class="keyword">new</span> Tuple2&lt;Long, SensorReading&gt;(context.window().getStart(), min));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çª—å£åº•å±‚å®ç°"><a href="#çª—å£åº•å±‚å®ç°" class="headerlink" title="çª—å£åº•å±‚å®ç°"></a>çª—å£åº•å±‚å®ç°</h2><p>çª—å£çš„å®ç°åŒ…å«ä¸‰ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«æ˜¯çª—å£åˆ†é…å™¨(WindowAssigner)ã€è§¦å‘å™¨(Trigger)å’Œé©±é€å™¨(Evictor)ã€‚å…¶ä¸­çª—å£åˆ†é…å™¨å†³å®šå…ƒç´ è¯¥åˆ†å‘åˆ°å“ªä¸ªçª—å£ï¼›è§¦å‘å™¨å†³å®šçª—å£ä¸­çš„å…ƒç´ ä½•æ—¶è®¡ç®—æˆ–è€…æ¸…é™¤è¯¥çª—å£ä¸­çš„å…ƒç´ ï¼Œæ¯ä¸ªçª—å£éƒ½æœ‰è‡ªå·±çš„triggerï¼›é©±é€å™¨ç±»ä¼¼è¿‡æ»¤å™¨ï¼Œæ ¹æ®ä¸€å®šè§„åˆ™å°†çª—å£ä¸­éƒ¨åˆ†æ•°æ®æ¸…é™¤æ‰ã€‚å°†è¿™ä¸‰ä¸ªç»„ä»¶çš„ä¸åŒå®ç°ç»„åˆåœ¨ä¸€èµ·ï¼Œå°±èƒ½å®ç°å„ç§çª—å£è®¡ç®—ã€‚</p><ul><li>çª—å£åˆ†é…å™¨(WindowAssigner)</li></ul><blockquote><p>å…ˆçœ‹ä¸‹æ ¸å¿ƒå‡½æ•°<br>assignWindows: å°†å¯¹åº”çš„å…ƒç´ åˆ†é…åˆ°æŒ‡å®šçš„çª—å£ä¸­<br>getDefaultTrigger: è·å–è¯¥çª—å£åˆ†é…å™¨é»˜è®¤æŒ‡å®šçš„Trigger<br>isEventTime: æ˜¯å¦åŸºäºevent timeå¯¹å…ƒç´ è¿›è¡Œåˆ†é…</p></blockquote><p>countWindowä¸­ç”¨çš„æ˜¯GlobalWindowï¼Œæ‰€ä»¥è¯¥åˆ†é…å™¨åªæ˜¯è¿”å›å½“å‰çª—å£å³å¯ã€‚<br>é‡ç‚¹çœ‹ä¸‹timeWindowçš„assignWindowsæ–¹æ³•ï¼Œè¿™é‡Œåªå…³æ³¨ä¸‹<code>SlidingEventTimeWindows</code>çš„<code>assignWindows</code>ï¼Œå› ä¸ºæ»šåŠ¨çª—å£çš„åˆ†é…é€»è¾‘å’Œæ»‘åŠ¨çª—å£ç±»ä¼¼ã€‚<code>SlidingEventTimeWindows.assignWindows</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Collection&lt;TimeWindow&gt; <span class="title">assignWindows</span><span class="params">(Object element, <span class="keyword">long</span> timestamp, WindowAssignerContext context)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (timestamp &gt; Long.MIN_VALUE) &#123;</span><br><span class="line">        <span class="comment">// è®¡ç®—çª—å£å¯ä»¥æœ‰å¤šå°‘ä¸ªæ»‘åŠ¨çª—å£</span></span><br><span class="line">        List&lt;TimeWindow&gt; windows = <span class="keyword">new</span> ArrayList&lt;&gt;((<span class="keyword">int</span>) (size / slide));</span><br><span class="line">        <span class="comment">// å½“å‰å…ƒç´ æ—¶é—´æ‰€åœ¨çš„æœ€è¿‘çª—å£çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">        <span class="keyword">long</span> lastStart = TimeWindow.getWindowStartWithOffset(timestamp, offset, slide);</span><br><span class="line">        <span class="comment">// ç”Ÿæˆè¯¥å…ƒç´ çš„çª—å£</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> start = lastStart;</span><br><span class="line">            start &gt; timestamp - size;</span><br><span class="line">            start -= slide) &#123;</span><br><span class="line">            <span class="comment">// çª—å£çš„åŒºé—´æ˜¯å‰é—­åå¼€</span></span><br><span class="line">            windows.add(<span class="keyword">new</span> TimeWindow(start, start + size));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> windows;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Record has Long.MIN_VALUE timestamp (= no timestamp marker). &quot;</span> +</span><br><span class="line">                <span class="string">&quot;Is the time characteristic set to &#x27;ProcessingTime&#x27;, or did you forget to call &quot;</span> +</span><br><span class="line">                <span class="string">&quot;&#x27;DataStream.assignTimestampsAndWatermarks(...)&#x27;?&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ ¸å¿ƒä»£ç é€»è¾‘åœ¨<code>TimeWindow.getWindowStartWithOffset</code>ä¸­ï¼Œä»£ç å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Method to get the window start for a timestamp.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> timestamp epoch millisecond to get the window start.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> offset The offset which window start would be shifted by.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> windowSize The size of the generated windows.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> window start</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * æ»‘åŠ¨çª—å£å’Œæ»šåŠ¨çª—å£éƒ½æ˜¯è°ƒç”¨è¿™ä¸ªå‡½æ•°è·å–çª—å£çš„èµ·å§‹ä½ç½®</span></span><br><span class="line"><span class="comment"> * æ»‘åŠ¨çª—å£ä¼ å…¥çš„windowSizeæ˜¯æ»‘åŠ¨çš„å¤§å°ï¼Œå¯¹äºæ»‘åŠ¨çª—å£æŒ‰ç…§slideæ»‘åŠ¨ï¼Œå…¶å®å¯ä»¥ç†è§£æˆé•¿åº¦ä¸ºslideçš„æ»šåŠ¨çª—å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getWindowStartWithOffset</span><span class="params">(<span class="keyword">long</span> timestamp, <span class="keyword">long</span> offset, <span class="keyword">long</span> windowSize)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// offset å¯ä»¥ç†è§£æˆæœ€å¼€å§‹åˆ°é‚£ä¸ªçª—å£çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="comment">// timestamp - offset ä¸º åˆ°æœ€å¼€å§‹é‚£ä¸ªçª—å£çš„è·ç¦»</span></span><br><span class="line">    <span class="comment">// (timestamp - offset + windowSize) % windowSize ç¦»æœ€è¿‘çª—å£çš„è·ç¦»ï¼Œç›¸å½“äºtimestamp - offset - windowSize - windowSize ...</span></span><br><span class="line">    <span class="comment">// timestamp - (timestamp - offset + windowSize) % windowSize åˆ™ä¸ºæœ€è¿‘çª—å£çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">    <span class="keyword">return</span> timestamp - (timestamp - offset + windowSize) % windowSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>è§¦å‘å™¨(Trigger)</li></ul><blockquote><p>å…ˆçœ‹ä¸‹æ ¸å¿ƒå‡½æ•°<br>onElement: å¤„ç†æ¯ä¸ªæ·»åŠ åˆ°çª—å£ä¸­çš„å…ƒç´ <br>onEventTime: TriggerContextä¸­æ³¨å†Œçš„event-time timerè¢«è§¦å‘æ—¶è°ƒç”¨<br>onProcessingTime: TriggerContextä¸­æ³¨å†Œçš„processing-time timerè¢«è§¦å‘æ—¶è°ƒç”¨<br>onMerge: windowè¢«mergeæ—¶è§¦å‘</p></blockquote><p>åœ¨WindowAssignerä¸­ï¼Œä¼šè°ƒç”¨getDefaultTriggerå¾—åˆ°è¯¥çª—å£çš„é»˜è®¤è§¦å‘å™¨ã€‚è¿™é‡Œçœ‹ä¸‹<code>SlidingEventTimeWindows</code>çš„é»˜è®¤triggerâ€“<code>EventTimeTrigger</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TriggerResult <span class="title">onElement</span><span class="params">(Object element, <span class="keyword">long</span> timestamp, TimeWindow window, TriggerContext ctx)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    <span class="comment">// element æ‰€åœ¨çš„ windowï¼ŒmaxTimestampä¸ºend-1</span></span><br><span class="line">    <span class="comment">// wartermarkæ˜¯å®šæœŸç”Ÿæˆçš„ï¼ŒmaxTimestampæ­£å¸¸åº”è¯¥æ˜¯å¤§äºwartermarkçš„</span></span><br><span class="line">    <span class="comment">// windowçš„maxTimestampæ˜¯ä¸å˜çš„ï¼Œwartermarkæ˜¯å‘¨æœŸæ€§å˜åŒ–çš„</span></span><br><span class="line">    <span class="comment">// åˆ™onElementä¸€èˆ¬ä¸ä¼šè§¦å‘FIRE</span></span><br><span class="line">    <span class="comment">// è¿Ÿåˆ°æ—¶ä¼šè§¦å‘</span></span><br><span class="line">    <span class="comment">// å‡å¦‚ä¸€ç›´æ²¡æœ‰è¿Ÿåˆ°çš„æ•°æ®åˆ°è¾¾æ˜¯ä¸æ˜¯å°±ä¸ä¼šåœ¨è¿™é‡Œè§¦å‘ï¼Œ</span></span><br><span class="line">    <span class="comment">// å‡å¦‚è¿Ÿåˆ°çš„æ•°æ®åˆ°è¾¾äº†ï¼Œä½†æ˜¯è¯¥çª—å£å·²ç»ç”±Timeè§¦å‘äº†FIREæ€ä¹ˆåŠï¼Ÿï¼Ÿ</span></span><br><span class="line">    <span class="comment">// è¿Ÿåˆ°å’Œä¹±åºçš„ç†è§£ï¼šè¿Ÿåˆ°ä¼šå†æ¬¡è§¦å‘windowè®¡ç®—ï¼Œä¹±åºæ˜¯windowç­‰å¾…ä¸€æ®µæ—¶é—´è¿›è¡Œè®¡ç®—ï¼Œåªè®¡ç®—ä¸€æ¬¡ã€‚</span></span><br><span class="line">    <span class="comment">// è¿Ÿåˆ°ä¼šè§¦å‘å¤šæ¬¡ï¼Œåªè¦åœ¨è§„å®šçš„æœ€å¤§è¿Ÿåˆ°æ—¶é—´å†…éƒ½ä¼šè§¦å‘è®¡ç®—</span></span><br><span class="line">    <span class="keyword">if</span> (window.maxTimestamp() &lt;= ctx.getCurrentWatermark()) &#123;</span><br><span class="line">        <span class="comment">// if the watermark is already past the window fire immediately</span></span><br><span class="line">        <span class="keyword">return</span> TriggerResult.FIRE;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ctx.registerEventTimeTimer(window.maxTimestamp());</span><br><span class="line">        <span class="keyword">return</span> TriggerResult.CONTINUE;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æœ€åä¸€ç§’ä¸­çš„ç¬¬ä¸€æ¡æ•°æ®è§¦å‘çª—å£è®¡ç®—ï¼Œé‚£è¿™ä¹‹åçš„æ•°æ®æ€ä¹ˆè®¡ç®—ï¼Ÿ</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> TriggerResult <span class="title">onEventTime</span><span class="params">(<span class="keyword">long</span> time, TimeWindow window, TriggerContext ctx)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> time == window.maxTimestamp() ?</span><br><span class="line">        TriggerResult.FIRE :</span><br><span class="line">        TriggerResult.CONTINUE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><!--ContinuousEventTimeTriggerï¼šæŒ‡å®šçš„ interval ä»¥åŠ event window çš„è¾¹ç•Œå°äºå½“å‰ watermark æ—¶è§¦å‘ onEventTime è®¡ç®—ContinuousProessingTimeTriggerï¼šæŒ‡å®šçš„ interval è§¦å‘ onProcessingTime è®¡ç®—CountTrigger: æŒ‡å®šçš„ maxCount è§¦å‘ï¼Œå‡ºå‘å maxCount æ¸…é›¶é‡æ–°ç´¯åŠ DeltaTrigger: æä¾› delta å‡½æ•°å’Œå†å² datapoint å­˜å‚¨ï¼Œæ¯ä¸ªå…ƒç´ æ¶ˆè´¹æ—¶è§¦å‘ delta å‡½æ•°è®¡ç®—EventTimeTriggerï¼ševent window çš„è¾¹ç•Œå°äºå½“å‰ watermark æ—¶è§¦å‘ onEventTime è®¡ç®—  æ˜¯å°äºè¿˜æ˜¯å¤§äºï¼Ÿï¼Ÿï¼ŸProessingTimeTriggerï¼ševent window çš„è¾¹ç•Œå°äºå½“å‰ watermark æ—¶è§¦å‘ onProcessingTime è®¡ç®—--><ul><li>é©±é€å™¨(Evictor)</li></ul><blockquote><p>å…ˆçœ‹ä¸‹æ ¸å¿ƒå‡½æ•°<br>evictBefore: åœ¨è§¦å‘çª—å£å‡½æ•°è®¡ç®—ä¹‹å‰å¯¹çª—å£ä¸­çš„å…ƒç´ è¿›è¡Œè¿‡æ»¤<br>evictAfter: åœ¨è§¦å‘çª—å£å‡½æ•°è®¡ç®—ä¹‹åå¯¹çª—å£ä¸­çš„å…ƒç´ è¿›è¡Œè¿‡æ»¤<br>evict: è¿‡æ»¤çª—å£ä¸­å…ƒç´ çš„å…·ä½“å®ç°ï¼Œåœ¨evictBeforeæˆ–è€…evictAfterå†…è°ƒç”¨</p></blockquote><p>å®Œæ•´çš„çª—å£è®¡ç®—æµç¨‹ï¼Œç»å†äº† Window Assigner -&gt; Trigger -&gt; Evictor -&gt; Evaluation Function çš„è¿‡ç¨‹ï¼Œæœ€ç»ˆè·å¾—ç»“æœã€‚</p><!--ä½•ä¸ºwindowï¼Œwindowç±»å‹ï¼Œå¦‚ä½•ä½¿ç”¨ä»¥åŠè‡ªå®šä¹‰ window functionå®ä¾‹ç”¨èµ·æ¥å¾ˆçˆ½ï¼Œä½†æ˜¯windowæ˜¯æ€ä¹ˆå®ç°çš„å‘¢ï¼Ÿå¦‚ä½•å®ç°ï¼Œå€ŸåŠ©trigger ev watermarktriggerè®¡æ—¶å™¨çš„ä½œç”¨ï¼Ÿåœ¨å“ªç”¨ï¼Ÿ å¦‚ä½•è§¦å‘ï¼Ÿ æ˜¯å®šæ—¶å™¨è¿˜æ˜¯watermark    triggerä¼šç”Ÿæˆçª—å£ï¼Œtriggerè®¡æ—¶å™¨åˆ°ä¹‹åè¿›è¡Œçª—å£functionè®¡ç®—è§¦å‘å™¨ï¼ˆTriggerï¼‰æä¾›äº†ä¸€ç§çµæ´»çš„æœºåˆ¶æ¥å†³å®šçª—å£çš„è®¡ç®—ç»“æœåœ¨ä»€ä¹ˆæ—¶å€™å¯¹å¤–è¾“å‡ºã€‚ç†è®ºä¸Šæ¥è¯´ï¼Œåªæœ‰ä¸¤ç§ç±»å‹çš„è§¦å‘å™¨ï¼Œå¤§éƒ¨åˆ†çš„åº”ç”¨éƒ½æ˜¯é€‰æ‹©å…¶ä¸€æˆ–ç»„åˆä½¿ç”¨ï¼šRepeated update triggersï¼šé‡å¤æ›´æ–°çª—å£çš„è®¡ç®—ç»“æœï¼Œæ›´æ–°å¯ä»¥æ˜¯ç”±æ–°æ¶ˆæ¯åˆ°è¾¾æ—¶è§¦å‘ï¼Œä¹Ÿå¯ä»¥æ˜¯æ¯ä¸ªä¸€æ®µæ—¶é—´ï¼ˆå¦‚1åˆ†é’Ÿï¼‰è¿›è¡Œè§¦å‘Completeness triggersï¼šåœ¨çª—å£ç»“æŸæ—¶è¿›è¡Œè§¦å‘ï¼Œè¿™æ˜¯æ›´ç¬¦åˆç›´è§‰çš„ä½¿ç”¨æ–¹æ³•ï¼Œä¹Ÿå’Œæ‰¹å¤„ç†æ¨¡å¼çš„è®¡ç®—ç»“æœç›¸å»åˆã€‚ä½†æ˜¯éœ€è¦ä¸€ç§æœºåˆ¶æ¥è¡¡é‡ä¸€ä¸ªçª—å£çš„æ‰€æœ‰æ¶ˆæ¯éƒ½å·²ç»è¢«æ­£ç¡®åœ°å¤„ç†äº†ã€‚ev åˆ©ç”¨çŠ¶æ€è¿›è¡Œè¿‡æ»¤watermark   Watermark æ˜¯ç”¨æ¥è¿½è¸ªä¸šåŠ¡äº‹ä»¶çš„æ¦‚å¿µï¼Œå¯ä»¥ç†è§£æˆ EventTime ä¸–ç•Œä¸­çš„æ—¶é’Ÿï¼Œç”¨æ¥æŒ‡ç¤ºå½“å‰å¤„ç†åˆ°ä»€ä¹ˆæ—¶åˆ»çš„æ•°æ®äº†    æ°´å°æ˜¯é’ˆå¯¹äº‹ä»¶æ—¶é—´çš„æ¦‚å¿µï¼Œæä¾›äº†ä¸€ç§äº‹ä»¶æ—¶é—´ç›¸å¯¹äºå¤„ç†æ—¶é—´æ˜¯ä¹±åºçš„ç³»ç»Ÿä¸­åˆç†æ¨æµ‹æ— ç•Œæ•°æ®é›†é‡Œæ•°æ®å®Œæ•´æ€§çš„å·¥å…·    ä½•ä¸ºwatermark    æœ‰ä½•ä½œç”¨    å¦‚ä½•ç”Ÿæˆ   è‡ªåŠ¨ç”Ÿæˆ setAutoWatermarkInterval    watermarkä¸triggerå¦‚ä½•ç›¸äº’ä½œç”¨    ä¸€ä¸ªçª—å£å¯ä»¥æœ‰å¤šä¸ªwatermarkï¼Œå¤šä¸ªwatermarkå¦‚ä½•è§¦å‘çª—å£çš„ï¼Œå½“å‰watermarkè§¦å‘ä¸Šä¸€ä¸ªçª—å£çš„è®¡ç®—ï¼Ÿï¼Ÿï¼Ÿ    å½“å‰ç³»ç»Ÿçš„ watermark ä¸ºæ—¶é—´ Tï¼Œé‚£ä¹ˆç³»ç»Ÿè®¤ä¸ºæ‰€æœ‰äº‹ä»¶æ—¶é—´å°äº T çš„æ¶ˆæ¯éƒ½å·²ç»åˆ°è¾¾ï¼Œå³ç³»ç»Ÿä»»åŠ¡å®ƒä¸ä¼šå†æ¥æ”¶åˆ°äº‹ä»¶æ—¶é—´å°äº T çš„æ¶ˆæ¯äº†å¤šæµä¹±åº    watermark å¤§çš„æ•°æ®ä¼šç¼“å­˜å—ï¼Ÿhttps://www.jianshu.com/p/b9b23a7cb880https://www.jianshu.com/p/c8c789ff5570window éƒ½æä¾›äº†window operator    åœ¨windowedStreamä¸­çš„windowFunctionæŒ‡å®šwindowOperatorç»¼åˆearly fireã€late fireã€æ°´å°æ—¶é—´ä¸çª—å£ç»“æŸæ—¶é—´ï¼Œç»¼åˆåˆ¤æ–­æ˜¯å¦è§¦å‘çª—å£å½“æœªæ¥æŸä¸ªwatermarkçš„æ—¶é—´æˆ³å¤§äºè¯¥triggerçš„æ³¨å†Œæ—¶é—´æ—¶ï¼Œå°±ä¼šè§¦å‘triggerï¼Œæ‰§è¡Œè¯¥triggeræ‰€åœ¨çš„window operatorçš„window processè¿›è¡Œè®¡ç®—ã€‚WindowOperator å®šä¹‰äº†window assigner, trigger, windowProcessFunction çš„æ‰§è¡Œé¡ºåºå¦‚ä½•ï¼Œå®ƒä»¬ä¹‹é—´çš„æ‰§è¡Œé€»è¾‘ç­‰triggerè¿‡æœŸè¿˜æ˜¯çª—å£è¿‡æœŸ watermarkè¿‡æœŸTimeræ€ä¹ˆè§¦å‘ï¼Ÿapplyï¼šè‡ªå®šä¹‰window functionprocessElementå¤„ç†æ•°æ®æµç¨‹ï¼šaã€ è·å–å½“å‰recordå…·æœ‰çš„äº‹ä»¶æ—¶é—´ï¼Œå¦‚æœæ˜¯Processing Timeæ¨¡å¼ï¼Œä»æ—¶é—´æœåŠ¡Serviceé‡Œé¢è·å–æ—¶é—´å³å¯bã€ä½¿ç”¨ä¸Šä¸€æ­¥è·å–çš„æ—¶é—´ï¼Œæ¥ç€è°ƒç”¨windowFunction.assignWindowç”Ÿæˆçª—å£ï¼Œå…¶å†…éƒ¨å®é™…ä¸Šæ˜¯è°ƒç”¨å„ç±»å‹çš„WindowAssignerç”Ÿæˆçª—å£ï¼ŒwindowFunctionæœ‰ä¸‰å¤§ç±»ï¼Œåˆ†åˆ«æ˜¯Panedï¼ˆæ»‘åŠ¨ï¼‰ã€Mergeï¼ˆä¼šè¯ï¼‰ã€Generalï¼ˆå‰ä¸¤ç§ä»¥å¤–çš„ï¼‰ï¼ŒWindowAssignerç±»å‹å¤§è‡´æœ‰5ç±»ï¼Œåˆ†åˆ«æ˜¯Tumblingï¼ˆç¿»è½¬ï¼‰ã€Slidingï¼ˆæ»‘åŠ¨ï¼‰ã€Sessionï¼ˆä¼šè¯ï¼‰ã€CountTumbling ã€CountSlideè¿™å‡ ç±»,æ ¹æ®è¾“å…¥çš„ä¸€æ¡æ•°æ®å’Œæ—¶é—´ï¼Œå¯ä»¥ç”Ÿæˆ1åˆ°å¤šä¸ªçª—å£cã€æ¥ä¸‹æ¥æ˜¯éå†æ¶‰åŠçš„çª—å£è¿›è¡Œèšåˆï¼ŒåŒ…æ‹¬ä»windowStateè·å–èšåˆå‰å€¼ã€ä½¿ç”¨å¥æŸ„è¿›è¡Œèšåˆã€æ›´æ–°çŠ¶æ€è‡³windowStateï¼Œå°†å½“å‰è½¬æ€dã€ä¸Šä¸€æ­¥èšåˆå®Œæˆåï¼Œå°±å¯ä»¥éå†çª—å£ï¼Œä½¿ç”¨TriggerContextï¼ˆå…¶å®å°±æ˜¯ä¸åŒç±»å‹çª—å£Triggerè§¦å‘å™¨çš„ä»£ç†ï¼‰ï¼Œç»¼åˆearly fireã€late fireã€æ°´å°æ—¶é—´ä¸çª—å£ç»“æŸæ—¶é—´ï¼Œç»¼åˆåˆ¤æ–­æ˜¯å¦è§¦å‘çª—å£å†™å‡ºeã€å¦‚æœTriggerContextåˆ¤æ–­å‡ºè§¦å‘æ¡ä»¶ä¸ºtrueï¼Œåˆ™è°ƒç”¨emitWindowResultå†™å‡ºï¼Œå…¶å†…éƒ¨æœ‰retractåˆ¤æ–­ï¼Œæ›´æ–°å½“å‰stateåŠprevious stateï¼Œå†™å‡ºæ•°æ®ç­‰æ“ä½œfã€å¦‚æœTriggerContextåˆ¤æ–­å‡ºè§¦å‘æ¡ä»¶ä¸ºfalseï¼Œåˆ™è§¦å‘éœ€è¦æ³¨å†ŒcleanupTimer,åˆ°è¾¾æŒ‡å®šæ—¶é—´åï¼Œè§¦å‘onEventTimeæˆ–onProcessingTimegã€onEventTimeæˆ–onProcessingTimeåŠŸèƒ½ååˆ†ç±»ä¼¼ï¼Œé¦–å…ˆä¼šè§¦å‘emitWindowResultæäº¤ç»“æœï¼Œå¦å¤–ä¼šåˆ¤æ–­çª—å£ç»“æŸæ—¶é—´+Latenesså’Œå½“å‰æ—¶é—´æ˜¯å¦ç›¸ç­‰ï¼Œç›¸ç­‰åˆ™è¡¨ç¤ºå¯ä»¥æ¸…é™¤çª—å£æ•°æ®ã€å½“å‰stateåŠprevious stateã€çª—å£å¯¹åº”triggerã€‚å…ƒç´ åœ¨streaming dataflowå¼•æ“ä¸­æµåŠ¨åˆ°WindowOperatoræ—¶ï¼Œä¼šè¢«åˆ†ä¸ºä¸¤æ‹¨ï¼Œåˆ†åˆ«æ˜¯æ™®é€šäº‹ä»¶å’Œæ°´å°ã€‚WatermarkAssignerOperator.advanceWatermark -> OperatorChain.emitWatermark -> operator.processWatermark-->]]></content>
      
      
      <categories>
          
          <category> Flink </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Flink </tag>
            
            <tag> window </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>golangæ–°æ‰‹å…¥é—¨</title>
      <link href="/golang-newbie.html"/>
      <url>/golang-newbie.html</url>
      
        <content type="html"><![CDATA[<h2 id="Goå¼€å‘ç¯å¢ƒé…ç½®"><a href="#Goå¼€å‘ç¯å¢ƒé…ç½®" class="headerlink" title="Goå¼€å‘ç¯å¢ƒé…ç½®"></a>Goå¼€å‘ç¯å¢ƒé…ç½®</h2><p>â€‹    é€‰æ‹©æ“ä½œç³»ç»Ÿå¯¹åº”çš„ç‰ˆæœ¬ï¼Œå¯ä»¥ç›´æ¥ä¸‹è½½å®‰è£…åŒ…è¿›è¡Œä¸€é”®å®‰è£…ï¼Œä¹Ÿå¯ä»¥ä¸‹è½½tar/zipåŒ…è¿›è¡Œè‡ªå®šä¹‰å®‰è£…ã€‚è‡ªå®šä¹‰å®‰è£…æ—¶éœ€è¦åœ¨ç¯å¢ƒå˜é‡ä¸­æŒ‡å®š<code>GOROOT</code>å’Œ<code>GOPATH</code>ï¼Œ<code>GOROOT</code>æ˜¯taråŒ…çš„è§£å‹ç›®å½•ï¼Œ<code>GOPATH</code>æ˜¯Goå·¥ç¨‹é¡¹ç›®ç›®å½•ï¼Œè¿™é‡Œä¸ä»…å­˜å‚¨è¿™è‡ªå·±å¼€å‘çš„é¡¹ç›®ä¹Ÿå­˜æ”¾ç€é¡¹ç›®æ‰€ä¾èµ–åŒ…çš„æºç åŠäºŒè¿›åˆ¶æ–‡ä»¶ã€‚</p><span id="more"></span><h2 id="Goé¡¹ç›®ç›®å½•"><a href="#Goé¡¹ç›®ç›®å½•" class="headerlink" title="Goé¡¹ç›®ç›®å½•"></a>Goé¡¹ç›®ç›®å½•</h2><p>â€‹    ä½¿ç”¨æŸç§ç¼–ç¨‹è¯­è¨€æˆ–è€…æŸä¸ªç¼–ç¨‹æ¡†æ¶å¼€å‘çš„é¡¹ç›®éƒ½æœ‰è‡ªå·±ç‰¹æœ‰çš„ç›®å½•ç»“æ„ï¼Œæ‰€ä»¥å­¦ä¹ ä¸€é—¨æ–°è¯­è¨€æˆ–è€…ç¼–ç¨‹æ¡†æ¶æ—¶è¦å…ˆç†Ÿæ‚‰å…¶é¡¹ç›®çš„å·¥ç¨‹ç›®å½•ç»“æ„ã€‚Goçš„å·¥ç¨‹ç›®å½•æ˜¯ä¸€ä¸ªå±‚çº§ç›®å½•ï¼Œç¬¬ä¸€å±‚æœ‰ä¸¤ä¸ªç›®å½•<code>bin</code>å’Œ<code>src</code>ä¸¤ä¸ªç›®å½•ï¼Œ<code>bin</code>æ–‡ä»¶ä¸­å­˜æ”¾çš„æ˜¯Goç¼–è¯‘ä¹‹åçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œ<code>src</code>æ–‡ä»¶å¤¹ä¸­å­˜æ”¾çš„éƒ½æ˜¯é¡¹ç›®æºæ–‡ä»¶ï¼Œé¡¹ç›®çš„ç›®å½•ç»“æ„å¯æ ¹æ®ä»£ç åŠŸèƒ½è¿›è¡Œåˆ’åˆ†ã€‚Goå·¥ç¨‹é¡¹ç›®ç»“æ„æ ·ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">bin/</span><br><span class="line">    hello                          <span class="comment"># command executable</span></span><br><span class="line">    outyet                         <span class="comment"># command executable</span></span><br><span class="line">src/</span><br><span class="line">    github.com/golang/example/</span><br><span class="line">        .git/                      <span class="comment"># Git repository metadata</span></span><br><span class="line">        hello/</span><br><span class="line">            hello.go               <span class="comment"># command source</span></span><br><span class="line">        outyet/</span><br><span class="line">            main.go                <span class="comment"># command source</span></span><br><span class="line">            main_test.go           <span class="comment"># test source</span></span><br><span class="line">        stringutil/</span><br><span class="line">            reverse.go             <span class="comment"># package source</span></span><br><span class="line">            reverse_test.go        <span class="comment"># test source</span></span><br><span class="line">    golang.org/x/image/</span><br><span class="line">        .git/                      <span class="comment"># Git repository metadata</span></span><br><span class="line">        bmp/</span><br><span class="line">            reader.go              <span class="comment"># package source</span></span><br><span class="line">            writer.go              <span class="comment"># package source</span></span><br><span class="line">    ... (many more repositories and packages omitted) ...</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„<code>src</code>ç›®å½•æœ‰ä¸¤ä¸ªGoé¡¹ç›®ï¼Œåˆ†åˆ«æ˜¯<code>example</code>å’Œ<code>image</code>ã€‚<code>example</code>ä¸­æœ‰ä¸‰ä¸ªæ–‡ä»¶å¤¹ï¼Œå…¶ä¸­<code>hello</code>å’Œ<code>outyet</code>åˆ†åˆ«åŒ…å«å¯æ‰§è¡Œå‘½ä»¤çš„æ–‡ä»¶ï¼Œ<code>stringutil</code>æ˜¯ä¸€ä¸ªå·¥å…·åŒ…ã€‚<code>image</code>ä¸­æ²¡æœ‰åŒ…å«å¯æ‰§è¡Œå‘½ä»¤çš„æ–‡ä»¶ï¼Œåªæœ‰ä¸€ä¸ªbmpçš„å·¥å…·åŒ…å’Œå…¶å®ƒå·¥å…·åŒ…ã€‚é€šè¿‡<code>go install</code>å‘½ä»¤ç¼–è¯‘<code>example</code>é¡¹ç›®ä¼š<code>bin</code>ç›®å½•ä¸­å¢åŠ ä¸¤ä¸ªå¯æ‰§è¡Œæ–‡ä»¶<code>hello</code>å’Œ<code>outyet</code></p><p>â€‹    Goçš„å·¥ç¨‹ç›®å½•å…¶å®å°±æ˜¯åœ¨ä¸Šä¸€èŠ‚ä¸­è®¾ç½®çš„<code>GOPATH</code>ï¼Œé»˜è®¤ç›®å½•åæ˜¯<code>go</code>ï¼Œä¼šå½“å‰ç”¨æˆ·homeç›®å½•ä¸‹åˆ›å»ºæ­¤æ–‡ä»¶å¤¹ï¼Œä¾‹å¦‚Linuxä¸º<code>$HOME/go</code>ï¼Œwinä¸º<code>C:\Users\YourName\go</code>ã€‚å¯ä»¥é€šè¿‡<code>export GOPATH=xx</code>è®¾ç½®ä»»æ„ç›®å½•ï¼Œä¸è¿‡ä¸èƒ½æ˜¯Goçš„å®‰è£…ç›®å½•ï¼Œä¹Ÿå°±æ˜¯<code>GOROOT</code>ã€‚</p><p>â€‹    Goæä¾›äº†<code>env</code>å‘½ä»¤ï¼Œå®ƒå¯ä»¥è¾“å‡ºç¯å¢ƒå˜é‡çš„å€¼ï¼Œä¾‹å¦‚æ‰§è¡Œå‘½ä»¤<code>go env GOPATH</code>ï¼Œå¦‚æœä¸ºäº†æ‰§è¡ŒGoç¼–è¯‘çš„å¯æ‰§è¡Œæ–‡ä»¶æ–¹ä¾¿ï¼Œå¯å°†<code>GOPATH</code>ç›®å½•æ·»åŠ åˆ°PATHç¯å¢ƒå˜é‡é‡Œï¼Œå¢åŠ <code>export PATH=$PATH:$(go env GOPATH)/bin</code></p><h2 id="Go-Go-Go"><a href="#Go-Go-Go" class="headerlink" title="Go Go Go!"></a>Go Go Go!</h2><p>â€‹    ç¯å¢ƒéƒ¨ç½²å¥½ï¼Œä¹Ÿç†Ÿæ‚‰äº†Goé¡¹ç›®çš„ç›®å½•ç»“æ„ï¼Œä¸‹é¢æ¥ä¸ª<code>Go Go Go!</code>æ‰¾ä¸‹Hello Worldçš„æ„Ÿè§‰ã€‚åœ¨<code>$GOPATH/src</code>ç›®å½•ä¸‹åˆ›å»ºé¡¹ç›®æ–‡ä»¶å¤¹go-testï¼Œç„¶ååœ¨æ­¤ç›®å½•æ–°å»ºä¸€ä¸ª<code>hello.go</code>çš„æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;fmt&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello, Go Go Go!&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœæ˜¯åœ¨IDEä¸­å¯ä»¥ç›´æ¥ç‚¹å‡»å³é”®æ‰§è¡Œï¼Œä¹Ÿå¯ä»¥åœ¨å‘½ä»¤è¡Œæ‰§è¡Œ<code>go run hello.go </code>æ‰§è¡Œã€‚Goå¯ä»¥ç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶æ‰§è¡Œè¿è¡Œï¼Œæ‰§è¡Œå‘½ä»¤<code>go install go-test</code>ï¼Œå…¶ä¸­go-testæ˜¯é¡¹ç›®ç›¸å¯¹äºGOPATHçš„ç›¸å¯¹è·¯å¾„ï¼Œä¹Ÿå¯ä»¥ç›´æ¥åœ¨go-testç›®å½•ä¸‹æ‰§è¡Œ<code>go install</code>ï¼Œæ­¤å‘½ä»¤æˆåŠŸä¹‹åä¼šåœ¨<code>$GOPATH/bin</code>ç›®å½•ä¸‹å¢åŠ ä¸€ä¸ª<code>go-test</code>çš„å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆå¦‚æœæ˜¯winï¼Œåˆ™æ˜¯<code>go-test.exe</code>ï¼‰ã€‚<code>go install</code>æ²¡æœ‰ä»»ä½•è¾“å‡ºä»£è¡¨æ‰§è¡ŒæˆåŠŸï¼Œæ‰§è¡Œå¼‚å¸¸æ—¶ä¼šæœ‰é”™è¯¯è¾“å‡ºï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">âœ  go-test go install</span><br><span class="line"><span class="comment"># go-test</span></span><br><span class="line">./t.go:3:6: main redeclared <span class="keyword">in</span> this block</span><br><span class="line">        previous declaration at ./hello.go:8:6</span><br></pre></td></tr></table></figure><p>æ‰§è¡ŒæˆåŠŸå¯ä»¥ç›´æ¥æ‰§è¡Œ<code>$GOPATH/bin/go-test</code>ã€‚</p><p>â€‹    Goå’Œå…¶å®ƒè¯­è¨€ç±»ä¼¼ï¼Œä¹Ÿéœ€è¦åœ¨æ–‡ä»¶å¼€å¤´å¼•å…¥ä¸€äº›åŒ…ï¼Œä½¿ç”¨å‘½ä»¤<code>import</code>ï¼Œä¾‹å¦‚<code>hello.go</code>ä¸­çš„<code>import &quot;fmt&quot;</code>ï¼Œ<code>fmt</code>æ˜¯Goè‡ªå¸¦çš„æ ‡å‡†ä¾èµ–åŒ…ï¼Œå¦‚æœè¦å¼•ç”¨å…¶å®ƒä¾èµ–åŒ…åˆ™éœ€è¦ä¾èµ–åŒ…åœ¨<code>$GOPATH</code>ä¸­çš„ç›¸å¯¹è·¯å¾„ï¼Œè¿™ä¸ªç›¸å¯¹è·¯å¾„æ˜¯æ¯ä¸ªä¾èµ–åŒ…çš„å”¯ä¸€æ ‡è¯†ã€‚</p><p>â€‹    ç”±äºGoè¯­è¨€å¤©ç”Ÿçš„å¼€æºç‰¹æ€§ï¼Œå¾ˆå¤šä¾èµ–åŒ…çš„å¼€æºä½œè€…éƒ½ä¹ æƒ¯ä½¿ç”¨GitHubæ¥ç®¡ç†è‡ªå·±çš„ä»£ç ï¼Œåœ¨importæ—¶å†™<code>github.com/user/pro</code>å³å¯ï¼Œè€Œä¸”è¿˜å¯ä»¥é€‰æ‹©ä¸åŒçš„ç‰ˆæœ¬ï¼Œæ–¹ä¾¿çš„å¾ˆã€‚æ‰€ä»¥æˆ‘ä»¬ä¹Ÿå¯ä»¥åœ¨<code>$GOPATH</code>ä¸­åˆ›å»ºè‡ªå·±çš„GitHubç›®å½•ï¼ˆå³ä½¿ä½ æ²¡æœ‰GitHubè´¦å·ï¼Œä½†ä¸ºäº†æ–¹ä¾¿ä½ æŸä¸€å¤©æƒ³æŠŠè‡ªå·±çš„ä»£ç å¼€æºå‡ºå»è®©æ›´å¤šçš„äººä½¿ç”¨ï¼‰ï¼Œå‡å¦‚Githubè´¦å·æ˜¯go-testï¼Œåˆ›å»ºç›®å½•<code>mkdir -p $GOPATH/src/github.com/go-test</code>ï¼Œç„¶åå°†ä¸Šé¢çš„<code>hello.go</code>ä»£ç ç§»åˆ°è¯¥ç›®å½•ä¸­ã€‚</p><p>â€‹    å¦‚æœåœ¨ä»£ç ä¸­å¼•å…¥äº†Githubä¸Šçš„ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…ï¼Œä½¿ç”¨<code>go get github.com/user/pro</code>ä¸‹è½½ä¾èµ–åˆ°æœ¬åœ°$GOPATHä¸­ï¼Œå¦‚ä½•å¼•å…¥è‡ªå·±å¼€å‘çš„ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…å‘¢æˆ–è€…å¦‚ä½•å¼€å‘ä¸€ä¸ªä¾èµ–åŒ…ã€‚</p><p>â€‹    å¼€å‘ä¸€ä¸ªä¾èµ–åŒ…é¦–å…ˆæƒ³ä¸€ä¸ªåŒ…åï¼Œè¿™ä¸ªåŒ…ååœ¨è‡ªå·±å¼€å‘çš„é¡¹ç›®ä¸­ä¸èƒ½é‡å¤ï¼Œå› ä¸ºGoå¯¼å…¥ç¬¬ä¸‰æ–¹ä¾èµ–æ—¶æ˜¯å¯¼å…¥åŒ…è·¯å¾„ã€‚è¿™é‡Œç»™<code>hello.go</code>å¢åŠ ä¸€ä¸ª<code>stringutil</code>çš„ä¾èµ–ï¼Œåˆ›å»ºç›®å½•<code>mkdir $GOPATH/src/github.com/go-test/stringutil</code>ï¼Œåœ¨æ­¤ç›®å½•ä¸­æ–°å»ºä¸€ä¸ª <code>reverse.go</code>çš„æ–‡ä»¶ï¼Œå¤åˆ¶å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Package stringutil contains utility functions for working with strings.</span></span><br><span class="line"><span class="keyword">package</span> stringutil</span><br><span class="line"></span><br><span class="line"><span class="comment">// Reverse returns its argument string reversed rune-wise left to right.</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">Reverse</span><span class="params">(s <span class="keyword">string</span>)</span> <span class="title">string</span></span> &#123;</span><br><span class="line">r := []<span class="keyword">rune</span>(s)</span><br><span class="line"><span class="keyword">for</span> i, j := <span class="number">0</span>, <span class="built_in">len</span>(r)<span class="number">-1</span>; i &lt; <span class="built_in">len</span>(r)/<span class="number">2</span>; i, j = i+<span class="number">1</span>, j<span class="number">-1</span> &#123;</span><br><span class="line">r[i], r[j] = r[j], r[i]</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="keyword">string</span>(r)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¾èµ–åŒ…ä½¿ç”¨ <code>go build</code>è¿›è¡Œç¼–è¯‘ï¼Œå‘½ä»¤æ‰§è¡Œä¹‹åä¸<code>go install</code>ä¸€æ ·ä¸ä¼šæ‰“å°ä»»ä½•ä¿¡æ¯ï¼Œä¸åŒçš„æ˜¯<code>go install</code>ä¼šåœ¨<code>$GOPATH/bin</code>ä¸­è¾“å‡ºä¸€ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œè€Œ <code>go build</code>æ²¡æœ‰ä»»ä½•è¾“å‡ºï¼Œåªæ˜¯å°†ç¼–è¯‘çš„ç»“æœæ”¾å…¥æœ¬åœ°build cacheä¸­ã€‚</p><p>â€‹    ä¾èµ–åŒ…ç¼–è¯‘æˆåŠŸä¹‹åå°±å¯ä»¥å¼•ç”¨äº†ï¼Œåœ¨ä¸Šè¿°çš„<code>hello.go</code>ä¸­æ·»åŠ ä¾èµ–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> main</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> (</span><br><span class="line"><span class="string">&quot;fmt&quot;</span></span><br><span class="line"><span class="string">&quot;github.com/go-test/stringutil&quot;</span></span><br><span class="line">)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">fmt.Println(<span class="string">&quot;Hello, Go Go Go!&quot;</span>)</span><br><span class="line">fmt.Println(stringutil.Reverse(<span class="string">&quot;!oG ,olleH&quot;</span>))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>go install</code>ï¼Œéšåå°±å¯ä»¥æ‰§è¡Œ<code>go-test</code>ã€‚</p><p>â€‹    å†™å®Œä¸Šé¢çš„ä»£ç ï¼Œæ­¤æ—¶å¯èƒ½æœ‰äº›ç–‘é—®ä¸ºä»€ä¹ˆ<code>hello.go</code>çš„packageæ˜¯<code>main</code>ï¼Œè€Œ <code>reverse.go</code>çš„packageæ˜¯<code>stringutil</code>ã€‚Goä»£ç çš„ç¬¬ä¸€è¡Œå¿…é¡»æ˜¯<code>package name</code>ï¼Œè¿™ä¸ªnameä¸€èˆ¬ä¸ºå½“å‰æ–‡ä»¶æ‰€åœ¨çš„ç›®å½•åï¼Œä¾‹å¦‚<code>reverse.go</code>åœ¨<code>stringutil</code>ç›®å½•ä¸­ï¼Œåˆ™ç¬¬ä¸€è¡Œä¸º<code>package stringutil</code>ï¼Œè¿™ä¸ªnameä¹Ÿæ˜¯ä¾èµ–æ­¤åŒ…æ—¶å¯¼å…¥è·¯å¾„çš„æœ€åä¸€ä¸ªç›®å½•ï¼Œå¦‚<code>hello.go</code>ä¸­è¦ä¾èµ–çš„æºç æ˜¯ <code>reverse.go</code>ï¼Œè€Œå®ƒåœ¨<code>stringutil</code>ç›®å½•ä¸­ï¼Œæ‰€ä»¥æ·»åŠ <code>import &quot;github.com/go-test/stringutil&quot;</code>ã€‚éœ€è¦æ³¨æ„çš„æ˜¯æŸä¸ªpackageä¸­çš„æ‰€æœ‰æ–‡ä»¶å¿…é¡»æœ‰ä¸€æ ·çš„nameï¼Œè€Œä¸”å¦‚æœåŒ…å«å¯æ‰§è¡Œå‘½ä»¤ï¼Œnameå¿…é¡»ä¸º<code>main</code>ï¼Œä¹Ÿå°±æ˜¯åƒ<code>hello.go</code>é‚£æ ·ï¼Œè€Œä¸”è¿˜å¾—åŒ…å«<code>func main()</code>ã€‚</p><!-- å¯æ‰§è¡Œæ–‡ä»¶çš„åå­—æ˜¯æ€ä¹ˆæ¥çš„ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ ç›®å½•å --><h2 id="Test"><a href="#Test" class="headerlink" title="Test"></a>Test</h2><p>â€‹    äº†è§£ä¸Šè¿°å†…å®¹å…¶å®å°±å¯ä»¥å»ç©Goäº†ï¼Œä½†æ˜¯åœ¨ç©çš„è¿‡ç¨‹ä¸­å¯èƒ½ä¼šé‡åˆ°ç»™æ–‡ä»¶èµ·åå­—æ—¶ä»¥ <code>_test.go</code>çš„é—®é¢˜ï¼Œåœ¨å…¶å®ƒè¯­è¨€ä¸­å¯¹æ–‡ä»¶åå­—çš„å†…å®¹å¹¶æ²¡æœ‰é™åˆ¶ï¼Œä½†åœ¨Goä¸­æœ‰é™åˆ¶ï¼Œå¦‚æœä»¥ <code>_test.go</code>ç»“å°¾åˆ™ä»£è¡¨è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•ç±»ã€‚</p><p>â€‹    Goæœ‰ä¸€ä¸ªè½»é‡çš„æµ‹è¯•æ¡†æ¶ï¼Œä½¿ç”¨æ—¶å¯¼å…¥ <code>testing</code>åŒ…ï¼Œæ‰§è¡Œ<code>go test</code> ã€‚ä½¿ç”¨æµ‹è¯•æ¡†æ¶æ—¶ï¼Œåˆ›å»ºä¸€ä¸ªä»¥<code>_test.go</code>ç»“å°¾æ–‡ä»¶ï¼Œæµ‹è¯•æŸä¸ªfuncçš„æ–¹æ³•åä¸º<code>func TestXXX(t *testing.T)</code>ï¼Œå¦‚æœè¿™ä¸ªæµ‹è¯•æ–¹æ³•è°ƒç”¨äº† <code>t.Error</code> æˆ–è€… <code>t.Fail</code>åˆ™è®¤ä¸ºæµ‹è¯•å¤±è´¥ã€‚ç»™ä¸Šè¿° <code>reverse.go</code>æ·»åŠ ä¸€ä¸ªæµ‹è¯•ç±»ï¼Œåœ¨stringutilæ–‡ä»¶ä¸­åˆ›å»º<code>reverse_test.go</code>ï¼Œå¤åˆ¶å¦‚ä¸‹ä»£ç ï¼š</p><figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> stringutil</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;testing&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">TestReverse</span><span class="params">(t *testing.T)</span></span> &#123;</span><br><span class="line">cases := []<span class="keyword">struct</span> &#123;</span><br><span class="line">in, want <span class="keyword">string</span></span><br><span class="line">&#125;&#123;</span><br><span class="line">&#123;<span class="string">&quot;Hello, world&quot;</span>, <span class="string">&quot;dlrow ,olleH&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;Hello, ä¸–ç•Œ&quot;</span>, <span class="string">&quot;ç•Œä¸– ,olleH&quot;</span>&#125;,</span><br><span class="line">&#123;<span class="string">&quot;&quot;</span>, <span class="string">&quot;&quot;</span>&#125;,</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">for</span> _, c := <span class="keyword">range</span> cases &#123;</span><br><span class="line">got := Reverse(c.in)</span><br><span class="line"><span class="keyword">if</span> got != c.want &#123;</span><br><span class="line">t.Errorf(<span class="string">&quot;Reverse(%q) == %q, want %q&quot;</span>, c.in, got, c.want)</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åæ‰§è¡Œ<code>go test github.com/go-test/stringutil</code>æˆ–è€…ç›´æ¥åœ¨stringutilç›®å½•ä¸­æ‰§è¡Œ<code>go test</code>ï¼Œæ‰§è¡ŒæˆåŠŸè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$ go <span class="built_in">test</span> github.com/go-test/stringutil</span><br><span class="line">ok  github.com/user/stringutil 0.165s</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> golang </category>
          
      </categories>
      
      
        <tags>
            
            <tag> go </tag>
            
            <tag> golang </tag>
            
            <tag> èœé¸Ÿ </tag>
            
            <tag> ç¯å¢ƒ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARN Capacity Scheduler</title>
      <link href="/%5B%E8%AF%91%5DYarn-capacity.html"/>
      <url>/%5B%E8%AF%91%5DYarn-capacity.html</url>
      
        <content type="html"><![CDATA[<p>è¿™æ˜¯ä¸€ç¯‡è¯‘æ–‡ï¼Œ<a href="https://hortonworks.com/blog/yarn-capacity-scheduler/">åŸæ–‡åœ°å€</a></p><p>ä¸»è¦ä»‹ç»äº†Capacity Schedulerç›¸å…³çš„å†…å®¹ã€‚</p><p>Capacity Scheduleråœ¨èµ„æºåˆ†é…æ—¶ä¸»è¦è€ƒè™‘ä¸¤ä¸ªä¸»è¦å±æ€§ï¼š<em>ç”¨æˆ·åå’Œåº”ç”¨ç¨‹åºID</em>ã€‚åœ¨æŒ‡å®šæœ€å°ç”¨æˆ·ç™¾åˆ†æ¯”å’Œç”¨æˆ·é™åˆ¶å› ç´ çš„é˜Ÿåˆ—ä¸­ï¼Œç”¨æˆ·ä¹‹é—´å…±äº«èµ„æºæ—¶ï¼Œå…³æ³¨çš„æ˜¯ç”¨æˆ·åæœ¬èº«ã€‚åœ¨é˜Ÿåˆ—ä¸­ï¼Œåº”ç”¨ç¨‹åºè·å–èµ„æºåˆ†é…ç”±å¶å­é˜Ÿåˆ—æ’åºç­–ç•¥é©±åŠ¨ï¼šFIFOæˆ–FAIRï¼Œå®ƒåªå…³å¿ƒåº”ç”¨ç¨‹åºè€Œä¸å…³å¿ƒå“ªä¸ªç”¨æˆ·æ­£åœ¨è¿è¡Œå®ƒã€‚åœ¨FIFOä¸­ï¼Œèµ„æºé¦–å…ˆè¢«åˆ†é…ç»™é˜Ÿåˆ—ä¸­æœ€å…ˆæäº¤çš„åº”ç”¨ç¨‹åºï¼Œå¹¶ä¸”åªæœ‰å½“å®ƒä¸å†éœ€è¦ä»»ä½•è¯·æ±‚æ—¶ï¼Œä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åºæ‰ä¼šè·å¾—åˆ†é…ã€‚å¯¹äºä½¿ç”¨æœ€å°‘èµ„æºçš„FAIRåº”ç”¨ç¨‹åºï¼Œé¦–å…ˆè¯¢é—®æ˜¯å¦å­˜åœ¨å¾…å¤„ç†çš„åˆ†é…ï¼Œå¦‚æœå­˜åœ¨åˆ™åˆ†é…ï¼Œåˆ™å¦‚æœä¸å­˜åœ¨ï¼Œåˆ™æ£€æŸ¥å…·æœ‰æœ€å°‘èµ„æºçš„ä¸‹ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼›è¿™æœ‰åŠ©äºä¸é€šå¸¸ä½¿ç”¨å®ƒä»¬çš„åº”ç”¨ç¨‹åºå¹³å‡å…±äº«é˜Ÿåˆ—ã€‚</p><span id="more"></span><h2 id="å®¹é‡å’Œåˆ†å±‚è®¾è®¡"><a href="#å®¹é‡å’Œåˆ†å±‚è®¾è®¡" class="headerlink" title="å®¹é‡å’Œåˆ†å±‚è®¾è®¡"></a>å®¹é‡å’Œåˆ†å±‚è®¾è®¡</h2><p>â€‹YARNå¯¹å…¶å¯åˆ†é…çš„èµ„æºå®šä¹‰äº†æœ€å°åˆ†é…é‡å’Œæœ€å¤§åˆ†é…é‡ï¼Œç›®å‰è¿™äº›èµ„æºåŒ…æ‹¬å†…å­˜å’Œå†…æ ¸ã€‚å¯è°ƒåº¦èµ„æºæ˜¯ç”±NodeManageæä¾›çš„ï¼Œæ¥è‡ªæ‰€æœ‰èŠ‚ç‚¹çš„èµ„æºèšåˆä¸ºå¯è¢«Capacityè°ƒåº¦çš„æ€»èµ„æºï¼Œæ€»èµ„æºç»„æˆrooté˜Ÿåˆ—ã€‚</p><p>â€‹Capacityè°ƒåº¦çš„åŸºç¡€è®¾ç½®æ˜¯å¦‚ä½•å¸ƒç½®é˜Ÿåˆ—ä»¥åŠä¸ºå®ƒä»¬åˆ†é…èµ„æºã€‚é˜Ÿåˆ—ä»¥åˆ†å±‚è®¾è®¡å¸ƒå±€ï¼Œæœ€é¡¶å±‚çš„çˆ¶èŠ‚ç‚¹æ˜¯é›†ç¾¤é˜Ÿåˆ—çš„â€œæ ¹â€ï¼Œå¯ä»¥ä»æ ¹åˆ†é…å­é˜Ÿåˆ—ï¼Œæˆ–è€…å¯ä»¥åœ¨è‡ªå·±é˜Ÿåˆ—çš„åŸºç¡€ä¸Šå†æ¬¡åˆ†é…å­é˜Ÿåˆ—ã€‚èµ„æºè¢«åˆ†é…ç»™è¿™äº›é˜Ÿåˆ—ï¼Œä½œä¸ºå±‚æ¬¡ç»“æ„ä¸­çˆ¶çº§èµ„æºçš„æœ€å°å’Œæœ€å¤§ç™¾åˆ†æ¯”ã€‚ æœ€å°å®¹é‡æ˜¯å¦‚æœç¾¤é›†ä¸Šçš„æ‰€æœ‰é˜Ÿåˆ—éƒ½å·²è¿è¡Œï¼Œå¹¶ä¸”é›†ç¾¤æ€»èµ„æºå·²ç”¨å®Œï¼Œæ­¤æ—¶å„é˜Ÿåˆ—åº”è¯¥å¯ä»¥ä½¿ç”¨çš„èµ„æºé‡ã€‚ æœ€å¤§å®¹é‡æ˜¯ç±»ä¼¼å¼¹æ€§çš„å®¹é‡ï¼Œå…è®¸é˜Ÿåˆ—åˆ©ç”¨ä¸ç”¨äºå¡«å……å…¶ä»–é˜Ÿåˆ—ä¸­çš„æœ€å°å®¹é‡éœ€æ±‚çš„èµ„æºã€‚<br><img src="/blogimgs/capacity/queue.png" alt="é˜Ÿåˆ—è®¾è®¡" title="é˜Ÿåˆ—è®¾è®¡"></p><h2 id="æœ€ä½ç”¨æˆ·ç™¾åˆ†æ¯”å’Œç”¨æˆ·é™åˆ¶å› ç´ "><a href="#æœ€ä½ç”¨æˆ·ç™¾åˆ†æ¯”å’Œç”¨æˆ·é™åˆ¶å› ç´ " class="headerlink" title="æœ€ä½ç”¨æˆ·ç™¾åˆ†æ¯”å’Œç”¨æˆ·é™åˆ¶å› ç´ "></a>æœ€ä½ç”¨æˆ·ç™¾åˆ†æ¯”å’Œç”¨æˆ·é™åˆ¶å› ç´ </h2><p>â€‹æœ€å°ç”¨æˆ·ç™¾åˆ†æ¯”å’Œç”¨æˆ·é™åˆ¶å› å­æ˜¯æ§åˆ¶å¦‚ä½•å°†æ­£åœ¨ä½¿ç”¨çš„é˜Ÿåˆ—ä¸­çš„èµ„æºåˆ†é…ç»™ä»–ä»¬çš„æ–¹æ³•ã€‚ æœ€å°ç”¨æˆ·ç™¾åˆ†æ¯”æ˜¯å•ä¸ªç”¨æˆ·åœ¨è¯·æ±‚æ—¶åº”è®¿é—®çš„æœ€å°èµ„æºé‡ç™¾åˆ†æ¯”ï¼Œæ˜¯ä¸€ä¸ªè½¯é™åˆ¶ã€‚ ä¾‹å¦‚ï¼Œ10ï¼…çš„æœ€å°ç”¨æˆ·ç™¾åˆ†æ¯”æ„å‘³ç€10ä¸ªç”¨æˆ·å°†è·å¾—10ï¼…; è¿™ä¸ªå€¼ä¸æ˜¯ç¡¬æ€§è§„å®šçš„ï¼Œå› ä¸ºå¦‚æœå…¶ä¸­ä¸€ä¸ªç”¨æˆ·è¦æ±‚æ›´å°‘ï¼Œæˆ‘ä»¬å¯èƒ½ä¼šå°†æ›´å¤šç”¨æˆ·æ”¾å…¥é˜Ÿåˆ—ã€‚</p><p>â€‹ç”¨æˆ·é™åˆ¶å› å­æ˜¯ä¸€ç§æ§åˆ¶å•ä¸ªç”¨æˆ·å¯ä»¥ä½¿ç”¨çš„æœ€å¤§èµ„æºé‡çš„æ–¹æ³•ã€‚ ç”¨æˆ·é™åˆ¶å› å­è®¾ç½®ä¸ºé˜Ÿåˆ—æœ€å°å®¹é‡çš„å€æ•°ã€‚å¦‚æœç”¨æˆ·é™åˆ¶å› å­ä¸º1è¡¨ç¤ºç”¨æˆ·å¯ä»¥ä½¿ç”¨é˜Ÿåˆ—çš„æ•´ä¸ªæœ€å°å®¹é‡ï¼Œ å¦‚æœç”¨æˆ·é™åˆ¶å› å­å¤§äº1ï¼Œåˆ™ç”¨æˆ·å¯èƒ½ä¼šå¢é•¿åˆ°æœ€å¤§å®¹é‡ï¼Œå¦‚æœè¯¥å€¼è®¾ç½®ä¸ºå°äº1ï¼Œä¾‹å¦‚0.5ï¼Œåˆ™ç”¨æˆ·åªèƒ½è·å¾—é˜Ÿåˆ—æœ€å°å®¹é‡çš„ä¸€åŠã€‚ å¦‚æœæ‚¨å¸Œæœ›ç”¨æˆ·èƒ½å¤Ÿå¢é•¿åˆ°é˜Ÿåˆ—è®¾ç½®çš„æœ€å¤§å®¹é‡ï¼Œåˆ™å¤§äº1çš„å€¼å°†å…è®¸ç”¨æˆ·å¤šæ¬¡è¶…è¿‡æœ€å°å®¹é‡ã€‚<br><img src="/blogimgs/capacity/user.png" alt="é™åˆ¶å› å­" title="é™åˆ¶å› å­"></p><p>â€‹æœ€åˆå¯èƒ½ä¸ç›´è§‚çš„å¸¸è§è®¾è®¡ç‚¹æ˜¯æŒ‰å·¥ä½œè´Ÿè½½è€Œä¸æ˜¯åº”ç”¨ç¨‹åºåˆ›å»ºé˜Ÿåˆ—ï¼Œç„¶åä½¿ç”¨ç”¨æˆ·é™åˆ¶å› å­æ¥é˜²æ­¢å•ä¸ªç”¨æˆ·<strong>é€šè¿‡ä½¿ç”¨å°äº1.0çš„å€¼å•ç‹¬æ¥ç®¡é˜Ÿåˆ—</strong>ã€‚ æ­¤æ¨¡å‹æ”¯æŒæ›´ç®€å•çš„æ“ä½œï¼Œä¸å…è®¸é€šè¿‡ä¸ºæ¯ä¸ªLoBåˆ›å»ºä¸€ä¸ªé˜Ÿåˆ—æ¥åˆ›å»ºé˜Ÿåˆ—ï¼Œè€Œæ˜¯é€šè¿‡æŒ‰å·¥ä½œè´Ÿè½½åˆ›å»ºé˜Ÿåˆ—æ¥åˆ›å»ºå¯é¢„æµ‹çš„é˜Ÿåˆ—è¡Œä¸ºã€‚ ä¸€æ—¦ç¾¤é›†å®Œå…¨ä½¿ç”¨å¹¶ä¸”åº”ç”¨ç¨‹åºæ’é˜Ÿç­‰å¾…è¿è¡Œæ—¶ï¼Œè¾ƒä½çš„ç”¨æˆ·é™åˆ¶å› ç´ å°†æ˜¯æ§åˆ¶ç§Ÿæˆ·ä¹‹é—´èµ„æºå…±äº«çš„å…³é”®ã€‚</p><p>â€‹æœ€åˆï¼Œç”±äºä½¿ç”¨è¾ƒå°çš„ç”¨æˆ·é™åˆ¶æ¥é™åˆ¶ç”¨æˆ·èµ„æºï¼Œè¿™å¯èƒ½æ— æ³•åœ¨å…¶Hadoopå¹³å°æ—…ç¨‹å¼€å§‹æ—¶æä¾›ç¾¤é›†åˆ©ç”¨ç‡ï¼Œæœ‰è®¸å¤šæ–¹æ³•ï¼Œä½†éœ€è¦è€ƒè™‘çš„æ˜¯ï¼Œæœ€åˆå…è®¸å•ä¸ªç§Ÿæˆ·æ¥ç®¡ä¸€ä¸ªå°é›†ç¾¤ï¼ˆæ¯”å¦‚10ä¸ªèŠ‚ç‚¹ï¼‰ï¼Œè¿™å¯èƒ½æ˜¯åˆç†çš„ï¼Œä½†æ˜¯å½“æ‰©å±•å¹³å°å ç”¨ç©ºé—´æ—¶ï¼Œé™ä½ç”¨æˆ·é™åˆ¶å› å­ï¼Œä»¥ä¾¿æ¯ä¸ªç§Ÿæˆ·ä¿ç•™ä¸æ·»åŠ æ–°èŠ‚ç‚¹ä¹‹å‰ç›¸åŒæ•°é‡çš„å¯åˆ†é…èµ„æºã€‚ è¿™å¯ä»¥è®©ç”¨æˆ·ä¿æŒæœ€åˆçš„ä½“éªŒï¼Œä½†æ˜¯æ— æ³•æ¥ç®¡æ•´ä¸ªé›†ç¾¤ï¼Œå› ä¸ºéšç€æ•´ä¸ªç¾¤é›†çš„å¢é•¿ï¼Œæ–°ç”¨æˆ·å¯ä»¥è½»æ¾è·å¾—åˆ†é…çš„å®¹é‡ï¼ŒåŒæ—¶ä¸ä¼šé™ä½åŸå§‹ç”¨æˆ·çš„ä½“éªŒã€‚</p><h2 id="é˜Ÿåˆ—è®¾è®¡"><a href="#é˜Ÿåˆ—è®¾è®¡" class="headerlink" title="é˜Ÿåˆ—è®¾è®¡"></a>é˜Ÿåˆ—è®¾è®¡</h2><p>â€‹é˜Ÿåˆ—è®¾è®¡æ—¶éœ€è¦è€ƒè™‘å¦‚ä¸‹ç›¸å…³åœºæ™¯ï¼š</p><ul><li><strong>å³æ—¶æŸ¥è¯¢</strong><br>ä¸»è¦æ˜¯äº›ä¸´æ—¶ç»Ÿè®¡éœ€æ±‚ï¼Œä»»åŠ¡çš„å‡ºç°æ²¡æœ‰è§„å¾‹ï¼Œä¸»è¦é›†ä¸­åœ¨å·¥ä½œæ—¶é—´ï¼Œç”±ç”¨æˆ·ä¸»åŠ¨è§¦å‘</li><li><strong>ç´§æ€¥éœ€æ±‚</strong><br>ä¸»è¦ç”¨äºå¤„ç†ä¸€äº›ç´§æ€¥éœ€æ±‚ï¼Œæ¯”å¦‚ç´§æ€¥è¡¥æ•°</li><li><strong>æœºå™¨å­¦ä¹ </strong><br>è¿™éƒ¨åˆ†éœ€æ±‚æ˜¯éœ€è¦å¤§é‡çš„èµ„æºå¹¶ä¸”å¯èƒ½ä¼šé•¿æ—¶é—´å ç”¨èµ„æºï¼Œä½†æ˜¯ç´§æ€¥åº¦å’Œè¿è¡Œæ—¶é•¿è¦æ±‚ä¸æ˜¯å¾ˆé«˜</li><li><strong>å®æ—¶è®¡ç®—</strong><br>è¿™éƒ¨åˆ†éœ€æ±‚æ˜¯é•¿æ—¶é—´è¿è¡Œå¹¶ä¸”æ²¡æœ‰æ˜ç¡®çš„ç»“æŸæ ‡è¯†ï¼Œå¯¹å®æ—¶è¦æ±‚è¾ƒé«˜ï¼Œä¸èƒ½å®¹å¿å»¶è¿Ÿï¼Œéœ€è¦ä¸¥æ ¼ä¿è¯èµ„æºä¸è¢«å…¶å®ƒéœ€æ±‚æŠ¢å </li><li><strong>æ‰¹å¤„ç†</strong><br>æ˜¯æŒ‡ä¸€äº›å¸¸è§„æ•°æ®ETLï¼Œä¸»è¦å…³æ³¨ä»»åŠ¡çš„ååé‡è€Œä¸æ˜¯å½“ä¸ªä»»åŠ¡æ˜¯å¦å»¶è¿Ÿ</li></ul><p>â€‹é˜Ÿåˆ—ä¸­èµ„æºä½¿ç”¨æ¨¡å‹å¯ä»¥è®¤ä¸ºæ˜¯ä¸€äº›containersåƒå¸¸é‡é‚£æ ·ä¸€ç›´å­˜åœ¨å’Œæ–°å¯åŠ¨çš„ã€‚ è¿™ç§ä½¿ç”¨æ¨¡å‹å¯¹äºå…·æœ‰è‰¯å¥½è¡Œä¸ºçš„é›†ç¾¤éå¸¸é‡è¦ï¼Œå› ä¸ºé˜Ÿåˆ—å¯ä»¥å¿«é€Ÿé‡æ–°å¹³è¡¡åˆ°å…¶æœ€å°å®¹é‡ï¼Œå¹¶å…¬å¹³åœ°å¹³è¡¡å…¶ç”¨æˆ·ä¹‹é—´çš„é˜Ÿåˆ—å®¹é‡ã€‚ ä¸å¥½çš„ä½¿ç”¨æ¨¡å¼æ˜¯é•¿æœŸå­˜åœ¨çš„å®¹å™¨ï¼Œèµ„æºä¸€ç›´åœ¨è¢«è‡ªå·±ä½¿ç”¨å¹¶ä¸”æ°¸è¿œä¸ä¼šé‡Šæ”¾ï¼Œè¿™æ ·å®ƒå¯ä»¥é˜»æ­¢èµ„æºçš„é€‚å½“é‡æ–°å¹³è¡¡ï¼Œåœ¨æŸäº›æƒ…å†µä¸‹å®ƒå¯ä»¥å®Œå…¨é˜»æ­¢å…¶ä»–åº”ç”¨ç¨‹åºå¯åŠ¨æˆ–å…¶ä»–é˜Ÿåˆ—æ¢å¤å…¶æœ€å°å®¹é‡ã€‚ å½“ä¸ä½¿ç”¨æŠ¢å æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—æ‰©å®¹å¼¹æ€§ç©ºé—´ä½†ä»ä¸é‡Šæ”¾å…¶å®¹å™¨ï¼Œåˆ™å¼¹æ€§ç©ºé—´æ°¸è¿œä¸ä¼šè¢«è¿”å›ç»™å…¶ä»–é˜Ÿåˆ—æ¥ä¿è¯ä»–ä»¬çš„æœ€å°å®¹é‡ã€‚ å¦‚æœåœ¨é˜Ÿåˆ—ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºå…·æœ‰é•¿æœŸå­˜åœ¨å®¹å™¨ï¼Œè¯·ç‰¹åˆ«æ³¨æ„å¹¶è€ƒè™‘ä½¿ç”¨è¯¸å¦‚ç”¨æˆ·é™åˆ¶å› å­ï¼ŒæŠ¢å æˆ–ç”šè‡³æ²¡æœ‰å¼¹æ€§å®¹é‡çš„ä¸“ç”¨é˜Ÿåˆ—ç­‰åŠŸèƒ½æ¥å‡è½»å…¶å¯¹å…¶ä»–ç”¨æˆ·çš„å½±å“çš„æ–¹æ³•ã€‚</p><h2 id="CAPACITYè°ƒåº¦ç‰¹æ€§"><a href="#CAPACITYè°ƒåº¦ç‰¹æ€§" class="headerlink" title="CAPACITYè°ƒåº¦ç‰¹æ€§"></a>CAPACITYè°ƒåº¦ç‰¹æ€§</h2><h3 id="CPUè°ƒåº¦"><a href="#CPUè°ƒåº¦" class="headerlink" title="CPUè°ƒåº¦"></a>CPUè°ƒåº¦</h3><p>â€‹é»˜è®¤æƒ…å†µä¸‹Capacityè°ƒåº¦ä¸æ”¯æŒCPUè°ƒåº¦ã€‚å¦‚æœå¼€å¯CPUè°ƒåº¦çš„è¯ï¼Œå¯èƒ½ä¼šé™ä½æ‰¹å¤„ç†ä»»åŠ¡çš„ååé‡ã€‚æ”¯æŒCPUè°ƒåº¦çš„ç®—æ³•æ˜¯Dominant Resource Fairness (DRF)ã€‚</p><p>â€‹CPUè°ƒåº¦ä¸»è¦åŒ…å«ä¸¤éƒ¨åˆ†ï¼š</p><ol><li>åˆ†é…å’Œæ”¾ç½®</li><li>å¼ºåˆ¶é™åˆ¶</li></ol><p>â€‹åªè¦å¼€å¯CPUè°ƒåº¦å³å¯è§£å†³åˆ†é…å’Œæ”¾ç½®é—®é¢˜ï¼Œè°ƒåº¦å™¨ä¼šä½¿ç”¨DRFç®—æ³•å’ŒVCores Node Managerçš„æ±‡æŠ¥ç»“æœã€‚ è¿™è§£å†³äº†ä¸€äº›æ–°é—®é¢˜ï¼Œä¾‹å¦‚ç”¨æˆ·ä½¿ç”¨1ä¸ªæˆ–2ä¸ªexecutorsæ¥è°ƒåº¦ä»–çš„Sparkåº”ç”¨ç¨‹åºï¼Œä½†æ˜¯æ¯ä¸ªexecutoråˆ†é…8ä¸ªcoreï¼Œç„¶åç”±äºå¯ç”¨å†…å­˜è¿‡å¤šè€Œç»§ç»­å‘è¿™ä¸ªèŠ‚ç‚¹åˆ†é…ä»»åŠ¡ï¼Œç”±äºcoreçš„é™åˆ¶å½±å“è¿™äº›ä»»åŠ¡çš„è¿è¡Œã€‚ é€šè¿‡å¯ç”¨ç®€å•çš„CPUè°ƒåº¦ï¼Œå¦‚æœæ­£åœ¨ä½¿ç”¨æ‰€æœ‰coreï¼Œåˆ™ä¸å†å°†å…¶ä»–ä»»åŠ¡åˆ†é…åˆ°è¯¥èŠ‚ç‚¹ä¸Šï¼Œå¹¶æ‰¾åˆ°ç¾¤é›†ä¸­å…¶å®ƒèŠ‚ç‚¹æ¥æ”¾ç½®ä»»åŠ¡ã€‚</p><p>â€‹è‡³äºå¼ºåˆ¶é™åˆ¶å¯ä»¥é€šè¿‡Cgroupæ¥è§£å†³ã€‚Cgroupå¯ä»¥è®©YARNç¡®ä¿åˆ†é…ç»™æŸä¸ªcontainerçš„vcoreä¸ªæ•°ä¸ä¼šè¶…è¿‡è¯·æ±‚çš„æ•°é‡ã€‚å¯ä»¥å¯ç”¨æœªä½¿ç”¨æ—¶å…±äº«vcoresï¼Œä¹Ÿå¯ä»¥ä»…ä¸¥æ ¼æ‰§è¡Œå·²å®‰æ’çš„å†…å®¹ã€‚ èŠ‚ç‚¹ç®¡ç†å™¨è¿˜å¯ä»¥é…ç½®ä¸ºæœåŠ¡å™¨ä¸Šå…è®¸æ‰€æœ‰ä»»åŠ¡æ€»å’Œçš„æœ€å¤§CPUä½¿ç”¨é‡ï¼Œè¿™æ ·å¯ä»¥ä¿è¯æ“ä½œç³»ç»Ÿçš„åŠŸèƒ½æ­£å¸¸ä½¿ç”¨coreã€‚</p><h3 id="æŠ¢å "><a href="#æŠ¢å " class="headerlink" title="æŠ¢å "></a>æŠ¢å </h3><p>â€‹å½“åº”ç”¨ç¨‹åºåœ¨é˜Ÿåˆ—Aä¸­ä½¿ç”¨äº†å¼¹æ€§å®¹é‡ï¼Œæ­¤æ—¶å¦ä¸€ä¸ªé˜Ÿåˆ—Bæäº¤äº†ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œé˜Ÿåˆ—Bçš„èµ„æºè¢«é˜Ÿåˆ—Açš„ä»»åŠ¡æŠ¢å…ˆä½¿ç”¨ä¸­ï¼Œæ­¤æ—¶æ­£å¸¸æƒ…å†µä¸‹é˜Ÿåˆ—Bä¸­çš„åº”ç”¨ç¨‹åºå¿…é¡»ç­‰å¾…é˜Ÿåˆ—Aä¸­çš„ä»»åŠ¡é‡Šæ”¾è‡ªç”±ä¹‹åæ‰èƒ½è¿è¡Œã€‚å¦‚æœå¼€å¯æŠ¢å åŠŸèƒ½ï¼Œå°±å¯ä»¥ç«‹é©¬å›æ”¶å…¶ä»–é˜Ÿåˆ—ä¸­çš„èµ„æºï¼Œä»¥ä¾¿æ»¡è¶³é˜Ÿåˆ—çš„æœ€å°å®¹é‡éœ€æ±‚ã€‚æŠ¢å åŠŸèƒ½å¹¶ä¸ä¼šå½»åº•æ€æ­»ä¸€ä¸ªåº”ç”¨ç¨‹åºï¼Œä¼˜å…ˆæŠ¢å mapä»»åŠ¡çš„èµ„æºï¼Œæœ€åæ‰æ˜¯reduceçš„èµ„æºï¼Œå› ä¸ºè¢«killæ‰çš„ä»»åŠ¡å¿…é¡»é‡æ–°è¿è¡Œï¼Œreduceæ¯”mapè¦é‡å¤æ›´å¤šçš„å·¥ä½œã€‚ ä»æ’åºçš„è§’åº¦æ¥çœ‹ï¼ŒæŠ¢å æ—¶ä¼˜å…ˆè€ƒè™‘æœ€æ–°çš„åº”ç”¨ç¨‹åºå’Œå¤§å¤šæ•°è¶…é¢è®¢é˜…çš„åº”ç”¨ç¨‹åºã€‚</p><p>â€‹æŠ¢å æœ‰äº›åŠŸèƒ½å¹¶ä¸èƒ½åƒç”¨æˆ·é¢„æœŸçš„é‚£æ ·å‘æŒ¥ä½œç”¨ã€‚<strong>æœ€å¸¸è§çš„è¡Œä¸ºæ˜¯è®¤ä¸ºé˜Ÿåˆ—å¯ä»¥åœ¨å…¶è‡ªèº«å†…éƒ¨æŠ¢å ä»¥å¹³è¡¡æ‰€æœ‰ç”¨æˆ·çš„èµ„æºã€‚ è¿™ç§å‡è®¾æ˜¯é”™è¯¯çš„ï¼Œå› ä¸ºæŠ¢å åªèƒ½åœ¨é˜Ÿåˆ—ä¹‹é—´</strong>ï¼Œåœ¨é˜Ÿåˆ—ä¸­ç”¨æˆ·ä¹‹é—´çš„èµ„æºå¹³è¡¡éœ€è¦æŸ¥çœ‹å…¶ä»–æ§åˆ¶æ–¹å¼ï¼Œä¾‹å¦‚ç”¨æˆ·é™åˆ¶å› å­å’Œé˜Ÿåˆ—FIFO / FAIRç­–ç•¥ã€‚</p><!--å¦ä¸€ä¸ªè¡Œä¸ºæ˜¯ï¼Œå¦‚æœèµ„æºä¸èƒ½æä¾›è¶³å¤Ÿçš„èµ„æºæ¥æ»¡è¶³å¦ä¸€ä¸ªèµ„æºåˆ†é…è¯·æ±‚ï¼Œåˆ™Preemptionä¸ä¼šæŠ¢å èµ„æºã€‚ è™½ç„¶å¯¹äºå…·æœ‰è¾ƒå¤§æœ€å¤§å®¹å™¨å¤§å°çš„å°å‹é›†ç¾¤è€Œè¨€ï¼Œå¤§å‹é›†ç¾¤é€šå¸¸ä¸ä¼šå‡ºç°é—®é¢˜ä½†æ˜¯Preemptionæœªé…ç½®ä¸ºå›æ”¶æœ€å¤§å¯èƒ½å®¹é‡çš„å®¹å™¨ï¼Œå› æ­¤æ ¹æœ¬ä¸ä¼šæ‰§è¡Œä»»ä½•æ“ä½œã€‚ ç”¨äºæ§åˆ¶æ­¤è¡Œä¸ºçš„ä¸»è¦å±æ€§æ˜¯æ¯è½®æ€»æŠ¢å ç‡å’Œè‡ªç„¶ç»ˆæ­¢å› å­ã€‚ æ¯è½®æ€»æŠ¢å ç‡æ˜¯ç¾¤é›†ä¸­å¯ä»¥ç«‹å³è¢«æŠ¢å çš„èµ„æºçš„ç™¾åˆ†æ¯”ï¼Œè‡ªç„¶ç»ˆæ­¢å› å­æ˜¯æ‰€è¯·æ±‚çš„æ€»ç¾¤é›†ï¼ˆ100ï¼…ï¼‰ä¸­èµ„æºçš„ç™¾åˆ†æ¯”å°†è¢«æŠ¢å åˆ°æ¯è½®æ€»æŠ¢å æ•°ã€‚--><h3 id="é˜Ÿåˆ—çš„æ’åºç­–ç•¥"><a href="#é˜Ÿåˆ—çš„æ’åºç­–ç•¥" class="headerlink" title="é˜Ÿåˆ—çš„æ’åºç­–ç•¥"></a>é˜Ÿåˆ—çš„æ’åºç­–ç•¥</h3><p>â€‹Capacityè°ƒåº¦ç›®å‰æ”¯æŒä¸¤ç§æ’åºç­–ç•¥ï¼šFIFOå’ŒFAIRã€‚é˜Ÿåˆ—é»˜è®¤ä½¿ç”¨çš„æ˜¯FIFOï¼Œä½†æ˜¯è¿™ä¸æ˜¯ç”¨æˆ·æ‰€å¸Œæœ›çš„æ’åºç­–ç•¥ã€‚åœ¨å¶å­é˜Ÿåˆ—ä¸­é…ç½®FIFOæˆ–è€…FAIRï¼Œå¯ä»¥åœ¨åº”ç”¨ç¨‹åºçš„ååé‡å’Œå…±äº«å…¬å¹³ä¹‹é—´åˆç†é€‰æ‹©ã€‚å…³äºæ’åºç­–ç•¥çš„ä¸€ä¸ªé‡è¦äº‹æƒ…æ˜¯ï¼Œæ’åºæ˜¯é’ˆå¯¹é˜Ÿåˆ—ä¸­çš„åº”ç”¨ç¨‹åºçº§åˆ«ï¼Œè€Œä¸å…³å¿ƒå“ªä¸ªç”¨æˆ·æ‹¥æœ‰åº”ç”¨ç¨‹åºã€‚</p><p>â€‹FIFOç­–ç•¥æ˜¯æŒ‰ç…§åº”ç”¨ç¨‹åºæäº¤çš„é¡ºåºæ¥æ’åºçš„ã€‚å¦‚æœåº”ç”¨ç¨‹åºæœ‰æœªå®Œæˆçš„èµ„æºè¯·æ±‚ï¼Œåˆ™ä¼šæ ¹æ®å…ˆåˆ°å…ˆå¾—çš„åŸåˆ™åˆ†é…ã€‚ è¿™æ ·åšçš„ç»“æœæ˜¯ï¼Œå¦‚æœåº”ç”¨ç¨‹åºæœ‰è¶³å¤Ÿçš„æœªå®Œæˆè¯·æ±‚ï¼Œå®ƒä»¬å°†åœ¨å®Œæˆä¹‹å‰å¤šæ¬¡è¯·æ±‚ï¼Œå¯èƒ½ä¼šä½¿ç”¨æ•´ä¸ªé˜Ÿåˆ—ï¼Œå®ƒä»¬å°†é˜»æ­¢å…¶ä»–åº”ç”¨ç¨‹åºå¯åŠ¨ã€‚ ç”¨æˆ·ç”šè‡³å¯ä»¥ä½¿ç”¨è‡ªå·±çš„åº”ç”¨ç¨‹åºå æ»¡æ•´ä¸ªé›†ç¾¤èµ„æºè€Œé˜»æ­¢å…¶å®ƒåº”ç”¨ç¨‹åºæäº¤ï¼Œæ­£æ˜¯è¿™ç§è¡Œä¸ºå¯¹ç”¨æˆ·æ¥è¯´æ˜¯æœ€ä¸å¯æ¥å—çš„ã€‚</p><p>â€‹ä½¿ç”¨FAIRç­–ç•¥èƒ½å¾ˆå®¹æ˜“çš„è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚åœ¨å­é˜Ÿåˆ—ä¸Šä½¿ç”¨FAIRç­–ç•¥æ—¶ï¼Œåº”é¦–å…ˆå¯¹åº”ç”¨ç¨‹åºå·²å ç”¨çš„èµ„æºé‡è¿›è¡Œè¯„ä¼°ï¼Œèµ„æºä½¿ç”¨æœ€å°‘çš„åº”ç”¨ç¨‹åºä¼šä¼˜å…ˆåˆ†é…è¯·æ±‚ã€‚ è¿™æ ·ï¼Œè¿›å…¥é˜Ÿåˆ—çš„æ²¡æœ‰è¿›è¡Œèµ„æºåˆ†é…çš„æ–°åº”ç”¨ç¨‹åºå°†é¦–å…ˆè¿›è¡Œèµ„æºåˆ†é…ã€‚ ä¸€æ—¦é˜Ÿåˆ—ä¸­çš„æ‰€æœ‰åº”ç”¨ç¨‹åºéƒ½å¾—åˆ°èµ„æºï¼Œè¿™æ ·å°±åœ¨ç”¨æˆ·ä¹‹é—´å¾—åˆ°å¹³è¡¡ã€‚</p><p>â€‹æœ€é‡è¦çš„æ˜¯ï¼Œåªæœ‰åœ¨é˜Ÿåˆ—ä¸­æœ‰è‰¯å¥½çš„èµ„æºäº¤äº’æ—¶æ‰ä¼šå‡ºç°æ­¤è¡Œä¸ºã€‚ç”±äºé˜Ÿåˆ—å†…éƒ¨ä¸å­˜åœ¨æŠ¢å èµ„æºï¼Œå› æ­¤æ— æ³•åœ¨é˜Ÿåˆ—ä¸­å¼ºåˆ¶é‡æ–°åˆ†é…èµ„æºï¼Œè€Œä¸”FAIRæ’åºç­–ç•¥ä»…æ¶‰åŠæ–°èµ„æºåˆ†é…è€Œéå½“å‰å·²ä½¿ç”¨èµ„æºçš„å†åˆ†é…ï¼›è¿™æ˜¯ä»€ä¹ˆæ„æ€ï¼Ÿ å¦‚æœé˜Ÿåˆ—ä¸­èµ„æºè¢«å½“å‰ä»»åŠ¡ä½¿ç”¨ä¸”ä»»åŠ¡æ°¸è¿œä¸ä¼šå®Œæˆæˆ–é•¿æ—¶é—´è¿è¡Œè€Œä¸å…è®¸åœ¨é˜Ÿåˆ—ä¸­å‘ç”Ÿå®¹å™¨ç»“æŸï¼Œé‚£ä¹ˆå°†ä¿ç•™èµ„æºå¹¶ä»ç„¶é˜»æ­¢åº”ç”¨ç¨‹åºæ‰§è¡Œã€‚</p><h3 id="é»˜è®¤é˜Ÿåˆ—æ˜ å°„"><a href="#é»˜è®¤é˜Ÿåˆ—æ˜ å°„" class="headerlink" title="é»˜è®¤é˜Ÿåˆ—æ˜ å°„"></a>é»˜è®¤é˜Ÿåˆ—æ˜ å°„</h3><p>â€‹é€šå¸¸æ˜¯åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šç”¨æˆ·æäº¤çš„é˜Ÿåˆ—ï¼ŒCapacityè°ƒåº¦å¯ä»¥ä½¿ç”¨<strong>é»˜è®¤é˜Ÿåˆ—æ˜ å°„</strong>é€šè¿‡ç”¨æˆ·åæˆ–è€…ç”¨æˆ·ç»„å°†ç”¨æˆ·è·¯ç”±åˆ°æŒ‡å®šçš„é˜Ÿåˆ—ã€‚ä½†æ˜¯éœ€è¦æ³¨æ„çš„æ˜¯é»˜è®¤é˜Ÿåˆ—çš„è·¯ç”±è§„åˆ™æ˜¯å“ªä¸ªè§„åˆ™å…ˆæ»¡è¶³å°±ä½¿ç”¨é‚£ä¸ªè§„åˆ™è¿›è¡Œè·¯ç”±ã€‚ä¹Ÿå°±æ˜¯è¯´å¦‚æœç»„ç”¨æˆ·æ˜ å°„è§„åˆ™åœ¨ç”¨æˆ·æ˜ å°„è§„åˆ™å‰é¢ï¼Œåˆ™å…ˆä½¿ç”¨ç»„ç”¨æˆ·æ˜ å°„è§„åˆ™å¯¹ç”¨æˆ·è¿›è¡Œè·¯ç”±ã€‚</p><h3 id="ä¼˜å…ˆçº§"><a href="#ä¼˜å…ˆçº§" class="headerlink" title="ä¼˜å…ˆçº§"></a>ä¼˜å…ˆçº§</h3><p>â€‹å½“èµ„æºåœ¨é˜Ÿåˆ—ä¹‹é—´åˆ†é…æ—¶ï¼Œ<strong>å…·æœ‰æœ€ä½ç›¸å¯¹å®¹é‡çš„é˜Ÿåˆ—é¦–å…ˆè·å¾—èµ„æº</strong>ã€‚å¦‚æœä½ æƒ³è®©æŸä¸ªé˜Ÿåˆ—æ€»æ˜¯æ¯”å…¶å®ƒé˜Ÿåˆ—ä¼˜å…ˆè·å¾—èµ„æºï¼Œé‚£ä¹ˆæœ€ç®€å•çš„æ–¹æ³•å°±æ˜¯æé«˜è¿™ä¸ªé˜Ÿåˆ—çš„ä¼˜å…ˆçº§ã€‚</p><p>â€‹åœ¨è¿™ä¸¤ä¸ªé˜Ÿåˆ—ä¹‹ä¸Šæä¾›äº†å¦‚ä½•ä½¿ç”¨æœªç»é˜Ÿåˆ—ä¼˜å…ˆçº§ä¿®æ”¹çš„ç›¸å¯¹å®¹é‡çš„ç¤ºä¾‹ã€‚åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå³ä½¿é˜Ÿåˆ—Aå°äºé˜Ÿåˆ—Bå¹¶ä¸”é˜Ÿåˆ—Bä½¿ç”¨æ›´å¤šç»å¯¹èµ„æºï¼Œä¹Ÿä¼šé€‰æ‹©ç»§ç»­æ¥æ”¶å®ƒä»¬ï¼Œå› ä¸ºå®ƒçš„ç›¸å¯¹å®¹é‡ä½äºé˜Ÿåˆ—Açš„ç›¸å¯¹å®¹é‡ã€‚å¦‚æœæ‰€éœ€è¡Œä¸ºéœ€è¦é˜Ÿåˆ—Aå§‹ç»ˆæ¥æ”¶èµ„æºåˆ†é…é¦–å…ˆï¼Œé˜Ÿåˆ—ä¼˜å…ˆçº§åº”è¯¥å¢åŠ åˆ°é«˜äºé˜Ÿåˆ—Bçš„ä¼˜å…ˆçº§ã€‚å½“åˆ†é…ä¼˜å…ˆçº§æ—¶ï¼Œæ›´é«˜çš„å€¼è¡¨ç¤ºæ›´é«˜çš„ä¼˜å…ˆçº§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> Capacity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Resource Localization in YARN</title>
      <link href="/YARN-Resource-Localization.html"/>
      <url>/YARN-Resource-Localization.html</url>
      
        <content type="html"><![CDATA[<p>ä¸€ä¸ªApplciationè¿è¡Œåœ¨YARNä¸Šçš„æµç¨‹ä¸ºï¼Œä»YARN Clientå‘ResourceManageræäº¤ä»»åŠ¡ï¼Œå°†Applciationæ‰€éœ€èµ„æºæäº¤åˆ°HDFSä¸­ï¼Œç„¶åResourceManagerå¯åŠ¨APPMasterï¼ŒAPPMasteré€šçŸ¥å„ä¸ªNodeManagerå¯åŠ¨containeræ‰§è¡Œå…·ä½“åˆ°è®¡ç®—ä»»åŠ¡ã€‚åœ¨å¯åŠ¨containerä¹‹å‰éœ€è¦ä»HDFSä¸Šä¸‹è½½è¯¥containeræ‰§è¡Œæ‰€ä¾èµ–çš„èµ„æºï¼Œè¿™äº›èµ„æºåŒ…æ‹¬jarã€ä¾èµ–çš„jaræˆ–è€…å…¶å®ƒæ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°±ç§°ä¸º<strong>èµ„æºæœ¬åœ°åŒ–</strong>(Resource Localization)ã€‚</p><p>æœ¬ç¯‡ä¸»è¦ä»‹ç»ä¸‹èµ„æºæœ¬åœ°åŒ–ç›¸å…³çš„å†…å®¹ã€‚</p><span id="more"></span><h2 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h2><p><strong>æœ¬åœ°åŒ–(Localization)</strong><br>æœ¬åœ°åŒ–æ˜¯æŒ‡å°†HDFSä¸Šçš„èµ„æºä¸‹è½½åˆ°æœ¬åœ°çš„<strong>è¿‡ç¨‹</strong>ã€‚å°†èµ„æºæœ¬åœ°åŒ–ï¼Œä½¿containerä¸ç”¨æ€»æ˜¯è®¿é—®HDFSä¸Šçš„æ•°æ®ï¼Œè€Œæ˜¯ç›´æ¥è®¿é—®æœ¬åœ°æ•°æ®ï¼Œæé«˜æ•ˆç‡ã€‚</p><p><strong>æœ¬åœ°èµ„æº(LocalResource)</strong><br>æœ¬åœ°èµ„æºæ˜¯æŒ‡containerè¿è¡Œæ—¶æ‰€éœ€è¦çš„èµ„æºï¼Œå¯ä»¥æ˜¯æŸä¸ªæ–‡ä»¶æˆ–è€…ä¾èµ–çš„libraryï¼Œè¿™äº›èµ„æºå­˜åœ¨HDFSä¸­ã€‚NodeManageråœ¨containerå¯åŠ¨ä¹‹å‰è´Ÿè´£å°†è¿™äº›èµ„æºè¿›è¡Œæœ¬åœ°åŒ–ã€‚å¯¹äºApplicationæ¥è¯´ï¼Œæœ¬åœ°èµ„æºæŒ‡ï¼š</p><ul><li>URL: éœ€è¦ä»HDFSä¸Šä¸‹è½½çš„æœ¬åœ°èµ„æºåœ°å€</li><li>Size: æœ¬åœ°èµ„æºçš„å¤§å°</li><li>timestamp: æœ¬åœ°èµ„æºåœ¨HDFSä¸Šåˆ›å»ºæ—¶çš„æ—¶é—´æˆ³</li><li>LocalResourceType: NodeManageræœ¬åœ°åŒ–èµ„æºæ—¶æŒ‡å®šçš„èµ„æºç±»å‹ï¼Œæœ‰FILEã€ARCHIVEå’ŒPATTERN</li><li>Pattern: ä»archiveä¸­è§£å‹å…·ä½“å†…å®¹æ—¶ä½¿ç”¨çš„è§„åˆ™åŒ¹é…æ–¹å¼(åªæœ‰LocalResourceTypeæ˜¯PATTERNæ—¶æ‰ç”Ÿæ•ˆ)ã€‚</li><li>LocalResourceVisibility: NodeManagerå°†èµ„æºæœ¬åœ°åŒ–ä¹‹åé’ˆå¯¹è¯¥Nodemanagerä¸Šå…¶å®ƒç”¨æˆ·å’ŒApplicationçš„å¯è§æ€§ã€‚å¯è§èŒƒå›´ä¸ºPUBLICã€PRIVATEå’ŒAPPLICATIONã€‚</li></ul><blockquote><p>NOTE: æœ¬åœ°èµ„æºå¹¶ä¸æ˜¯æŒ‡åœ¨æœ¬åœ°ç£ç›˜çš„èµ„æºï¼Œè€Œæ˜¯éœ€è¦ä»HDFSä¸‹è½½åˆ°æœ¬åœ°çš„èµ„æºã€‚</p></blockquote><p>é‚£ä¹ˆcontainerä¼šè¯·æ±‚ä»€ä¹ˆæ ·çš„èµ„æºè¿›è¡Œæœ¬åœ°åŒ–å‘¢ï¼Ÿå¯ä»¥æ˜¯ä»»æ„çš„æ–‡ä»¶ï¼Œä½†æ˜¯è¿™äº›æ–‡ä»¶å¯¹contianerå¿…é¡»æ˜¯åªè¯»çš„ã€‚<br>ä¸‹é¢ä¸¾å‡ ä¸ªæ¯”è¾ƒé€‚åˆåšæœ¬åœ°èµ„æºçš„å…¸å‹ä¾‹å­ï¼š</p><ol><li>containerå¯åŠ¨çš„æ—¶å€™éœ€è¦çš„ä»£ç åº“ï¼Œå¦‚jaræ–‡ä»¶</li><li>containerå¯åŠ¨æ—¶æ‰€éœ€è¦çš„configureæ–‡ä»¶</li><li>é™æ€çš„æ–‡ä»¶ç›®å½•</li></ol><p>ä¸€äº›åŠ¨æ€èµ„æºä¸é€‚åˆä½œä¸ºæœ¬åœ°èµ„æºï¼Œä¾‹å¦‚ï¼šcontaineréœ€è¦çš„èµ„æºæœ‰å¯èƒ½è¢«å…¶å®ƒç»„ä»¶è¿›è¡Œæ›´æ–°ï¼Œapplicationè‡ªå·±ä¼šç›´æ¥æ›´æ–°çš„æ–‡ä»¶æˆ–è€…applicationæƒ³è·Ÿå…¶å®ƒæœåŠ¡å…±äº«æ–‡ä»¶çš„å˜åŒ–æƒ…å†µçš„ã€‚</p><p><strong>ResourceLocalizationService</strong><br>ResourceLocalizationServiceæ˜¯NodeManagerå†…éƒ¨çš„ä¸€ä¸ªæœåŠ¡ï¼Œä¸»è¦è´Ÿè´£ä¸‹è½½å’Œç®¡ç†containeræ‰€éœ€çš„å„ç§èµ„æºã€‚ä¸‹è½½æ—¶ä¼šå¯¹æ‰€æœ‰å¯ç”¨çš„ç£ç›˜è¿›è¡Œè´Ÿè½½å‡è¡¡ï¼Œå¯¹ä¸‹è½½çš„èµ„æºä¼šä¸¥æ ¼æ§åˆ¶ä»–ä»¬çš„è®¿é—®æƒé™ã€‚</p><p><strong>DeletionService</strong><br>DeletionServiceä¹Ÿæ˜¯NodeManagerå†…éƒ¨çš„ä¸€ä¸ªæœåŠ¡ï¼Œä¸»è¦è´Ÿè´£åœ¨æ”¶åˆ°æŒ‡ä»¤ä¹‹ååˆ é™¤æœ¬åœ°ç›®å½•</p><p><strong>Localizer</strong><br>Localizerå®é™…ä¸Šæ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œç”¨äºèµ„æºæœ¬åœ°åŒ–ã€‚Localizeræœ‰ä¸¤ç§ç±»å‹ï¼Œä¸€ç§æ˜¯æŒ‡ç”¨ä¸ä¸‹è½½PUBLICè®¿é—®ç±»å‹èµ„æºçš„<em>PublicLocalizer</em>ï¼Œå¦ä¸€ç§æ˜¯ä¸‹è½½PRIVATEå’ŒAPPLICATIONè®¿é—®ç±»å‹çš„<em>ContainerLocalizers</em>ã€‚</p><p><strong>LocalCache</strong><br>LocalCacheæ˜¯NodeManagerç»´æŠ¤æ‰€æœ‰ä¸‹è½½åˆ°æœ¬åœ°çš„æ–‡ä»¶çš„local-cacheã€‚è¿™äº›èµ„æºé€šè¿‡ä¸‹è½½æ—¶æŒ‡å®šçš„HDFSåœ°å€æ¥å”¯ä¸€æ ‡è¯†ã€‚</p><h2 id="æ¦‚å¿µè¡¥å……"><a href="#æ¦‚å¿µè¡¥å……" class="headerlink" title="æ¦‚å¿µè¡¥å……"></a>æ¦‚å¿µè¡¥å……</h2><h3 id="LOCALRESOURCE-TIMESTAMPS"><a href="#LOCALRESOURCE-TIMESTAMPS" class="headerlink" title="LOCALRESOURCE TIMESTAMPS"></a>LOCALRESOURCE TIMESTAMPS</h3><p>timestampååº”äº†æœ¬åœ°èµ„æºçš„ä¸€ä¸ªç‰ˆæœ¬ï¼ŒNodeManageråœ¨ä¸‹è½½æœ¬åœ°èµ„æºæ—¶ä¼šæ£€æŸ¥timestampï¼Œè¿™æ ·Applicationåœ¨è¿è¡Œæ—¶çœ‹åˆ°çš„æ–‡ä»¶å†…å®¹éƒ½ä¸€æ ·ã€‚<br>åˆ©ç”¨timestampï¼ŒYARNèƒ½å‘ç°èµ„æºæ˜¯å¦å‘ç”Ÿè¿‡å˜åŒ–ï¼Œå¦‚æœå‘ç”Ÿå˜åŒ–å°†ä½¿containerå¤±è´¥é¿å…ä¸ä¸€è‡´å‘ç”Ÿã€‚å› ä¸ºåœ¨HDFSä¸Šçš„èµ„æºä¸€æ—¦è¢«NodeManageræœ¬åœ°åŒ–åˆ°æœ¬åœ°ç£ç›˜ï¼Œè¿™ä¸ªæ–‡ä»¶å°±ä¸å†ä¸æºæ–‡ä»¶æœ‰ä»»ä½•è”ç³»ï¼Œåªä¼šè®°å½•ä¸‹åŸæ¥çš„URLç”¨æ¥åœ¨æœ¬åœ°è¿›è¡Œå”¯ä¸€æ ‡è¯†ã€‚æ­¤æ—¶å³ä½¿æºæ–‡ä»¶å‘ç”Ÿå˜åŒ–ï¼ŒNodeManagerä¹Ÿä¸ä¼šè·Ÿè¸ªæ­¤å˜åŒ–å†æ¬¡ä¸‹è½½æ–‡ä»¶ã€‚</p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<em>å½“containerå¯åŠ¨æ—¶ï¼ŒApplicationMasterä¼šå‘è¿è¡Œcontainerçš„NodeManageræŒ‡å®šèµ„æºçš„timestampï¼ŒåŒæ ·å½“è¿è¡ŒApplicationMasterçš„containerå¯åŠ¨æ—¶ï¼Œä¹Ÿéœ€è¦èµ„æºçš„timestampï¼Œæ­¤æ—¶è¿™ä¸ªtimestampå°±éœ€è¦ç”±clientæŒ‡å®š</em>ã€‚ä»¥MapReduce on YARNä¸ºä¾‹ï¼ŒMapReduceçš„JobClientå†³å®šApplicationMasteréœ€è¦çš„èµ„æºçš„timestampï¼Œç„¶åç”±ApplicationMasterè‡ªå·±å†³å®šmapå’Œreduceæ‰€éœ€èµ„æºçš„timestampã€‚</p></blockquote><h3 id="LOCALRESOURCE-TYPES"><a href="#LOCALRESOURCE-TYPES" class="headerlink" title="LOCALRESOURCE TYPES"></a>LOCALRESOURCE TYPES</h3><p>ä¸Šä¸€èŠ‚ä¸­æåˆ°LocalResourceTypeä¸ºFILEã€ARCHIVEå’ŒPATTERNï¼Œä¸‹é¢ä»‹ç»ä¸‹ä¸‰ç§typeçš„å…·ä½“å«ä¹‰ã€‚<br>FILEç±»å‹æ˜¯æŒ‡æ™®é€šçš„æ–‡ä»¶ï¼Œæ–‡æœ¬ç±»å‹æˆ–è€…äºŒè¿›åˆ¶æ–‡ä»¶<br>ARCHIVEç±»å‹æ˜¯æŒ‡ä¸€äº›å¯ä»¥è¢«NodeManagerè‡ªåŠ¨è¯†åˆ«è§£å‹çš„å½’æ¡£æ–‡ä»¶ï¼Œæ¯”å¦‚jarsã€tarsã€tar.gzå’Œzip<br>PATTERNæ˜¯ARCHIVEå’ŒFILEçš„ä¸€ç§æ··åˆä½“ã€‚è¿™ç§ç±»å‹ä¸‹è½½åˆ°æœ¬åœ°çš„æºæ–‡ä»¶ä¼šä¿ç•™ï¼Œå¹¶ä¸”åœ¨æœ¬åœ°åŒ–æ—¶åªæœ‰è§£å‹çš„æ–‡ä»¶ä¼šç•™å­˜åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­ã€‚æºæ–‡ä»¶å’Œè§£å‹çš„æ–‡ä»¶åœ¨åŒä¸€ä¸ªç›®å½•ä¸­ã€‚å“ªäº›æ–‡ä»¶éœ€è¦ä»ARCHIVEä¸­æŠ½å–å‡ºæ¥ï¼Œå“ªäº›ä¸éœ€è¦è¿™äº›éƒ½æ˜¯ç”±patternå†³å®šçš„ã€‚ç›®å‰åªæœ‰jaræ”¯æŒPATTERNï¼Œå…¶å®ƒéƒ½è¢«è®¤ä¸ºæ­£å¸¸çš„ARCHIVEã€‚</p><h3 id="LOCALRESOURCE-VISIBILITES"><a href="#LOCALRESOURCE-VISIBILITES" class="headerlink" title="LOCALRESOURCE VISIBILITES"></a>LOCALRESOURCE VISIBILITES</h3><p>ä¸Šä¸€èŠ‚LocalResourceVisibilityä¸­æåˆ°æœ¬åœ°èµ„æºæœ‰ä¸‰ç§å¯è§æ€§ï¼Œåˆ†åˆ«ä¸ºPUBLICã€PRIVATEå’ŒAPPLICATIONã€‚å…¶ä¸­</p><p>PUBLICçš„è®¿é—®æƒé™æ˜¯æŒ‡<strong>ä»»ä½•ç”¨æˆ·çš„ä»»æ„Applicationçš„containeréƒ½å¯ä»¥è®¿é—®</strong>ã€‚å…¸å‹çš„PUBLICèµ„æºæ˜¯é‚£äº›åœ¨HDFSä¸Šå¯ä»¥è¢«ä»»ä½•äººè®¿é—®çš„æ–‡ä»¶ï¼Œå½“è¿™äº›èµ„æºè¢«æœ¬åœ°åŒ–ä¹‹åä¼šä¿ç•™ç›¸åŒçš„è®¿é—®æƒé™ã€‚<em>å¦‚æœä¸€ä¸ªèµ„æºæ˜¯PUBLICï¼Œå½“æœ‰container(containerå¯ä»¥æ˜¯å½“å‰Attemptï¼Œä¹Ÿå¯ä»¥æ˜¯å…¶å®ƒç”¨æˆ·çš„ä»»æ„Applicationä¸­çš„container)è¯·æ±‚ç›¸åŒçš„æœ¬åœ°èµ„æºæ—¶ï¼Œåªè¦æ­¤èµ„æºæ²¡æœ‰è¢«LocalCacheåˆ é™¤ï¼Œéƒ½å¯ä»¥ç›´æ¥ä»LocalCacheé‡Œç›´æ¥ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦å†æ¬¡ä¸‹è½½</em>ã€‚</p><p>PUBLICèµ„æºå­˜å‚¨åœ¨NodeManageræœ¬åœ°ç£ç›˜çš„<code>&lt;local-dir&gt;/filecache</code>ç›®å½•ä¸‹ï¼Œæ­¤ç›®å½•ä¸­çš„æ‰€æœ‰æ–‡ä»¶çš„owneræ˜¯NodeManagerè¿›ç¨‹å¯åŠ¨æ—¶çš„ç”¨æˆ·ï¼Œå¹¶ä¸”æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰è¯»æƒé™ï¼Œå› æ­¤è¿™äº›èµ„æºå¯ä»¥åœ¨æ­¤NodeManagerä¸Šè¿è¡Œçš„æ‰€æœ‰ç”¨æˆ·çš„containerå…±äº«ã€‚</p><p>PRIVATEæƒé™æœ¬åœ°èµ„æºåªèƒ½åœ¨<strong>å½“å‰èŠ‚ç‚¹ä¸Šç›¸åŒç”¨æˆ·çš„applicationä¹‹é—´å…±äº«</strong>ï¼Œè¿™äº›èµ„æºå­˜å‚¨åœ¨NodeManageræœ¬åœ°ç£ç›˜çš„<code>&lt;local-dir&gt;/usercache/$username/filecache</code>ç›®å½•ä¸‹ï¼Œè¿™äº›æ–‡ä»¶çš„owneræ˜¯å¯åŠ¨Applicationçš„userï¼Œå¹¶ä¸”å…¶å®ƒç”¨æˆ·æ²¡æœ‰è®¿é—®æƒé™ã€‚ç±»ä¼¼PUBLICï¼Œä¸€æ—¦èµ„æºæœ¬åœ°åŒ–ï¼Œæ‰€æœ‰çš„ç”¨æˆ·éƒ½æ²¡æœ‰å†™æƒé™ï¼Œå³ä½¿æ˜¯æäº¤ä»»åŠ¡çš„userã€‚è¿™æ ·æ˜¯ä¸ºäº†é¿å…æ¶æ„çš„containerå»ä¿®æ”¹æ–‡ä»¶ã€‚</p><p>APPLICATIONåªåœ¨<strong>å½“å‰èŠ‚ç‚¹ä¸ŠåŒä¸€ä¸ªapplicationçš„containerä¹‹é—´å…±äº«</strong>ã€‚è¿™äº›èµ„æºå­˜å‚¨åœ¨NodeManageræœ¬åœ°ç£ç›˜çš„<code>&lt;local-dir&gt;/usercache/$username/appcache/&lt;app-id&gt;/</code>ç›®å½•ä¸‹ï¼Œæ–‡ä»¶çš„owneræ˜¯Applicationçš„æäº¤è€…ï¼Œå¹¶ä¸”åªæœ‰è¯»æƒé™ã€‚</p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯LOCALRESOURCE VISIBILITIESä¸LOCALRESOURCE TIMESTAMPSç±»ä¼¼ï¼Œéƒ½æ˜¯ç”±ApplicationMasteræŒ‡å®šæœ¬åœ°èµ„æºçš„å¯è§æ€§ï¼ŒNodeManagerå¹¶ä¸ä¼šå¯¹èµ„æºçš„å¯è§æ€§åšä»»ä½•å†³å®šã€‚åŒæ ·å½“è¿è¡ŒApplicationMasterçš„containerå¯åŠ¨æ—¶ï¼Œä¹Ÿéœ€è¦èµ„æºçš„å¯è§æ€§ï¼Œæ­¤æ—¶è¿™ä¸ªå¯è§æ€§å°±éœ€è¦ç”±clientæŒ‡å®šã€‚ä»¥MapReduce on YARNä¸ºä¾‹ï¼ŒMapReduceçš„JobClientå†³å®šApplicationMasteréœ€è¦çš„èµ„æºçš„å¯è§æ€§ï¼Œç„¶åç”±ApplicationMasterè‡ªå·±å†³å®šmapå’Œreduceæ‰€éœ€èµ„æºçš„å¯è§æ€§ã€‚</p></blockquote><h4 id="æœ¬åœ°åŒ–æµç¨‹"><a href="#æœ¬åœ°åŒ–æµç¨‹" class="headerlink" title="æœ¬åœ°åŒ–æµç¨‹"></a>æœ¬åœ°åŒ–æµç¨‹</h4><p>PUBLICèµ„æºæœ¬åœ°åŒ–æ˜¯ç”±<code>PublicLocalizer</code>å®ç°çš„ï¼Œåœ¨NodeManagerè¿›ç¨‹ä¸­ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹æ± PublicLocalizersï¼Œå…¶ä¸ªæ•°æ˜¯ç”±<code>yarn.nodemanager.localizer.fetch.thread-count</code>å†³å®šï¼Œçº¿ç¨‹æ± çš„å¤§å°å†³å®šå¹¶è¡Œä¸‹è½½PUBLICèµ„æºçš„çº¿ç¨‹æœ€å¤§ä¸ªæ•°ã€‚å½“PublicLocalizeræœ¬åœ°åŒ–PUBLICèµ„æºæ—¶ï¼Œä¼šé€šè¿‡æ£€æŸ¥è¿™äº›èµ„æºåœ¨HDFSä¸Šçš„æƒé™æ¥ç¡®å®šæ‰€ç”³è¯·çš„èµ„æºç¡®å®ä¸ºPUBLICã€‚åªè¦æœ‰èµ„æºä¸ç¬¦åˆå°±æ‹’ç»æœ¬åœ°åŒ–ã€‚PublicLocalizerèƒ½å®‰å…¨çš„ä»HDFSä¸Šä¸‹è½½èµ„æºæ˜¯å‘ContainerLaunchContextä¼ é€’äº†è¯ä¹¦ã€‚ </p><p>PRIVATE/APPLICATONèµ„æºçš„æœ¬åœ°åŒ–æ˜¯ç”±<code>ContainerLocalizer</code>å®ç°çš„ï¼Œä¸åŒä¸PUBLICçš„<code>PublicLocalizer</code>å®ç°ã€‚<em>PublicLocalizeræ˜¯ç›´æ¥åœ¨NodeManagerä¸­å¯åŠ¨ä¸€ä¸ªçº¿ç¨‹æ± è¿›è¡Œæœ¬åœ°åŒ–ï¼Œè€ŒContainerLocalizerå‡ºäºå®‰å…¨é—®é¢˜ï¼Œå¹¶æ²¡æœ‰åœ¨NodeManagerè¿›ç¨‹ä¸­ç›´æ¥å®ç°ï¼Œè€Œæ˜¯åœ¨continerä¸­å®ç°çš„</em>ã€‚</p><p>PRIVATE/APPLICATONèµ„æºçš„æœ¬åœ°åŒ–æ˜¯ç”±<code>ContainerLocalizer</code>å®ç°ï¼Œè¿™æ˜¯ä¸€ä¸ªå•ç‹¬çš„è¿›ç¨‹ï¼Œè¿™ä¸ªè¿›ç¨‹ç”±<code>LocalizerRunner</code>çº¿ç¨‹ç®¡ç†ï¼Œ<em>LocalizerRunneræ˜¯NodeManagerä¸­çš„ä¸€ä¸ªçº¿ç¨‹</em>ï¼Œåªè¦æŸä¸ªcontaineræœ‰èµ„æºè¿˜æ²¡æœ‰ä¸‹è½½ï¼Œ<em>é‚£ä¹ˆæ­¤containerå°±ä¼šè§¦å‘ä¸€ä¸ªLocalizerRunner</em>ã€‚ä¸‹é¢çœ‹ä¸‹å…·ä½“çš„ç»†èŠ‚ï¼š</p><!--LocalResourcesTracker is a per-user or per-application object that tracks all the LocalResources for a given user or an application.--><p>å½“æŸä¸ªcontainerç¬¬ä¸€æ¬¡è¯·æ±‚PRIVATE/APPLICATIONç±»å‹çš„æœ¬åœ°èµ„æºæ—¶ï¼Œå¦‚æœæ²¡æœ‰åœ¨LocalResourcesTrackerä¸­æ‰¾åˆ°ï¼Œåˆ™åŠ å…¥pending-resourcesåˆ—è¡¨ã€‚éšåæ˜¯å¦éœ€è¦åˆ›å»ºLocalizerRunnerçº¿ç¨‹å–å†³äºæ˜¯å¦æœ‰å¿…è¦ä¸‹è½½èµ„æºï¼Œå¦‚æœéœ€è¦å°±å°†æœ¬åœ°èµ„æºåŠ å…¥<strong>LocalizerRunner</strong>ç»´æŠ¤çš„pending-resourcesåˆ—è¡¨ã€‚</p><p>NodeManageråœ¨å®‰å…¨æ¨¡å¼æ—¶ï¼Œæœ¬åœ°èµ„æºæœ¬åœ°åŒ–æ—¶éœ€è¦æ‰€ç”¨çš„useræ˜¯applicationçš„æäº¤ç”¨æˆ·è€Œä¸æ˜¯NodeManagerçš„å¯åŠ¨ç”¨æˆ·ã€‚å› æ­¤<strong>LocalizerRunnerä¼šä»¥applicationæäº¤è€…çš„èº«ä»½å¯åŠ¨LinuxContainerExecutor(LCE)è¿›ç¨‹ï¼Œç„¶åLCEä¼šæ‰§è¡ŒContainerLocalizerä¸‹è½½èµ„æº</strong>ã€‚<em>ContainerLocalizerå¯åŠ¨ä¹‹åä¼šä¸NodeManagerç»´æŒä¸€ä¸ªå¿ƒè·³</em>ï¼Œé€šè¿‡å¿ƒè·³ï¼ŒLocalizerRunnerç»™ContainerLocalizeråˆ†é…éœ€è¦ä¸‹è½½çš„èµ„æºæˆ–è€…åœæ­¢ContainerLocalizerè¿›ç¨‹ï¼Œè€ŒContainerLocalizerä¼šé€šçŸ¥LocalizerRunnerè‡ªå·±çš„ä¸‹è½½è¿›åº¦ã€‚å¦‚æœèµ„æºä¸‹è½½å¤±è´¥ï¼Œè¿™ä¸ªèµ„æºå°†ä¼šä»LocalResourcesTrackerä¸­ç§»é™¤ï¼Œå¹¶ä¸”containeræœ€ç»ˆä¹Ÿä¼šå¤±è´¥ã€‚å¦‚æœä¸‹è½½æˆåŠŸï¼ŒLocalizerRunnerä¼šé€šè¿‡å¿ƒè·³ç»™ContainerLocalizerå¦ä¸€ä¸ªèµ„æºè¿›è¡Œä¸‹è½½ï¼Œç›´åˆ°æ‰€æœ‰çš„èµ„æºéƒ½ä¸‹è½½å®Œã€‚</p><!--At present, each ContainerLocalizer doesnâ€™t support parallel download of mutliple PRIVATE/APPLICATION resources which we are trying to fix via YARN-574.Note that because of the above, the maximum parallelism that we can get at present is the number of containers requested for same user on same node manager at THAT point of time. This in the worst case is one when an ApplicationMaster itself is starting. So if AM needs any resources to be localized then today they will be downloaded serially before its container starts.--><h4 id="æœ¬åœ°èµ„æºçš„ç”Ÿå‘½å‘¨æœŸ"><a href="#æœ¬åœ°èµ„æºçš„ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="æœ¬åœ°èµ„æºçš„ç”Ÿå‘½å‘¨æœŸ"></a>æœ¬åœ°èµ„æºçš„ç”Ÿå‘½å‘¨æœŸ</h4><p>ç”±äºæœ¬åœ°èµ„æºçš„è®¿é—®æƒé™ä¸ä¸€æ ·ï¼Œåˆ™ä¸åŒçš„LocalResourceTypeåœ¨æœ¬åœ°ä¿ç•™çš„æ—¶é—´ä¹Ÿä¼šä¸ä¸€æ ·ã€‚</p><ul><li>PUBLICç”±äºæ˜¯åœ¨ä»»ä½•ç”¨æˆ·çš„ä»»æ„Applicationä¹‹é—´å…±äº«ï¼Œæ‰€ä»¥å¹¶ä¸ä¼šåœ¨æŸä¸ªcontaineræˆ–è€…applicationç»“æŸä¹‹åè¢«åˆ é™¤ï¼Œåªæœ‰åœ¨æœ¬åœ°ç›®å½•<local-dir>è¾¾åˆ°å­˜å‚¨é˜ˆå€¼æ—¶æ‰ä¼šè¢«åˆ é™¤ï¼Œè¿™ä¸ªé˜ˆå€¼ç”±<code>yarn.nodemanager.localizer.cache.target-size-mb</code>æ§åˆ¶ã€‚</li><li>PRIVATEå’ŒPUBLICçš„ç”Ÿå‘½å‘¨æœŸä¸€æ ·ã€‚</li><li>APPLICATIONä¼šåœ¨applicationç»“æŸä¹‹åç«‹å³åˆ é™¤ã€‚</li></ul><!--One thing of note is that for any given application, we may have multiple ApplicationAttempts and each attempt may start zero or more containers on a given node manager. When the first container belonging to an ApplicationAttempt starts, ResourceLocalizationService localizes files for that application as requested in the containerâ€™s launch context. If future containers request more such resources then they all will be localized. If one ApplicationAttempt finishes/fails and another is started, ResourceLocalizationService doesnâ€™t do anything w.r.t the previously localized resources. However when eventually the application finishes, ResourceManager communicates that information to NodeManagers which in turn clear the application LocalCache. In summary, APPLICATION LocalResources are truly application scoped and not ApplicationAttempt scoped.--><h4 id="æœ¬åœ°åŒ–ç›¸å…³çš„é…ç½®"><a href="#æœ¬åœ°åŒ–ç›¸å…³çš„é…ç½®" class="headerlink" title="æœ¬åœ°åŒ–ç›¸å…³çš„é…ç½®"></a>æœ¬åœ°åŒ–ç›¸å…³çš„é…ç½®</h4><p>åœ¨<code>yarn-site.xml</code>ä¸­æœ‰ä¸€äº›èµ„æºæœ¬åœ°åŒ–ç›¸å…³çš„é…ç½®ã€‚</p><ul><li><code>yarn.nodemanager.local-dirs</code>: èµ„æºæœ¬åœ°åŒ–æ—¶æ‰€åœ¨çš„æœ¬åœ°ç›®å½•ï¼Œå¯ä»¥æ˜¯ä»¥é€—å·åˆ†éš”çš„å¤šä¸ªç£ç›˜ç›®å½•ã€‚</li><li><code>yarn.nodemanager.local-cache.max-files-per-directory</code>: æ¯ä¸ªç›®å½•ä¸­æœ€å¤šæœ¬åœ°åŒ–æ–‡ä»¶çš„ä¸ªæ•°ï¼ŒPUBLIC / PRIVATE / APPLICATIONåˆ†åˆ«ç»Ÿè®¡ã€‚</li><li><code>yarn.nodemanager.localizer.address</code>: ResourceLocalizationServiceæœåŠ¡ç›‘å¬çš„RPCåœ°å€ï¼Œç”¨æ¥æ¥æ”¶ä¸åŒlocalizers</li><li><code>yarn.nodemanager.localizer.client.thread-count</code>: ResourceLocalizationServiceä¸­ç”¨æ¥å¤„ç†æ¥è‡ªlocalizersè¯·æ±‚çš„çº¿ç¨‹æ•°ã€‚é»˜è®¤æ˜¯5</li><li><code>yarn.nodemanager.localizer.fetch.thread-count</code>: æœ¬åœ°åŒ–PUBLICèµ„æºæ—¶PublicLocalizerçš„çº¿ç¨‹æ•°ã€‚é»˜è®¤æ˜¯4</li><li><code>yarn.nodemanager.delete.thread-count</code>: DeletionServiceä¸­åˆ é™¤æ–‡ä»¶çš„çº¿ç¨‹æ•°ï¼Œé»˜è®¤æ˜¯4ã€‚</li><li><code>yarn.nodemanager.localizer.cache.target-size-mb</code>: æœ¬åœ°åŒ–èµ„æºæ‰€å çš„æœ€å¤§ç£ç›˜ç©ºé—´ï¼Œå•ä½æ˜¯MBï¼Œæ¯”åŒ…æ‹¬APPLICATIONèµ„æºã€‚</li><li><code>yarn.nodemanager.localizer.cache.cleanup.interval-ms</code>: æ¯éš”å›ºå®šæ—¶é—´ï¼Œå»æ£€æŸ¥ä¸‹ç£ç›˜çš„ä½¿ç”¨é‡ã€‚åœ¨æ­¤é—´éš”ä¹‹åï¼Œå¦‚æœå­˜å‚¨çš„ç£ç›˜ç©ºé—´è¶…è¿‡äº†é…ç½®çš„é˜ˆå€¼ï¼Œä¼šåˆ é™¤æœªç”¨çš„èµ„æºã€‚</li></ul><blockquote><p>æœªä½¿ç”¨çš„èµ„æºæ˜¯æŒ‡æ²¡æœ‰è¢«æ­£åœ¨è¿è¡Œçš„containerå¼•ç”¨çš„èµ„æºã€‚æ¯æ¬¡containerè¯·æ±‚èµ„æºæ—¶ï¼Œcontainerä¼šè¢«åŠ å…¥åˆ°ä¸€ä¸ªèµ„æºå¼•ç”¨åˆ—è¡¨ä¸­ï¼Œç›´åˆ°containerç»“æŸä¹‹åæ‰ä¼šè¢«ç§»é™¤ã€‚æ‰€ä»¥å½“å¼•ç”¨æ•°ä¸º0æ—¶ï¼Œå¯ä»¥è¢«åˆ é™¤ã€‚</p></blockquote><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://zh.hortonworks.com/blog/management-of-application-dependencies-in-yarn/">Management of Application Dependencies in YARN</a><br><a href="https://zh.hortonworks.com/blog/resource-localization-in-yarn-deep-dive/">Resource Localization in YARN: Deep Dive</a></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> Localization </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Use protobuf to FSImage</title>
      <link href="/%5B%E8%AF%91%5DFSImage-protocol.html"/>
      <url>/%5B%E8%AF%91%5DFSImage-protocol.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡æ˜¯ä¸€ç¯‡è¯‘æ–‡ï¼Œä¸»è¦ä»‹ç»ä¸‹FSImageæ”¹è¿›ä¸ºprotobufçš„è®¾è®¡åŸç†ï¼Œ<a href="https://issues.apache.org/jira/secure/attachment/12626179/HDFS-5698-design.pdf">åŸæ–‡åœ°å€</a>ã€‚</p><span id="more"></span><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>ä¸ºäº†èƒ½ä»æ•…éšœä¸­å¿«é€Ÿæ¢å¤ï¼ŒHDFSä¼šå‘¨æœŸæ€§çš„å°†å†…å­˜ä¸­çš„namespaceåœ¨ç£ç›˜ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿä¸­è¿›è¡ŒæŒä¹…åŒ–ã€‚FSImageçš„æ€§èƒ½å’Œæ‰©å±•æ€§åœ¨ä¿è¯æ•°æ®çš„è€ç”¨æ€§å’Œå¯ç”¨æ€§ä¸Šè‡³å…³é‡è¦ã€‚éšç€è¶Šæ¥è¶Šå¤šçš„é«˜çº§åŠŸèƒ½è¢«å¼•å…¥HDFSä¸­ï¼ŒFSImageå·²ç»ä»ä¸€ä¸ªç®€å•çš„blobæ¼”å˜ä¸ºäº†ä¸€ä¸ªéœ€è¦å­˜å‚¨åœ¨ç£ç›˜çš„å¤æ‚çš„æ•°æ®ç»“æ„ã€‚FSImageæœ‰3ä¸ªæ–¹é¢éœ€è¦æ”¹è¿›ï¼š</p><ul><li>æ•ˆç‡<br>åœ¨ç”Ÿæˆç¯å¢ƒä¸­ï¼Œæˆ‘ä»¬è§‚å¯Ÿåˆ°æŒä¹…åŒ–åˆ°ç£ç›˜çš„FSImageå¤§å°èƒ½è¾¾åˆ°äºŒä¸‰åGBã€‚å› ä¸ºåŠ è½½å’Œåœæœºæ—¶ä¿å­˜FSImageæ˜¯NameNodeçš„å…³é”®ç¯èŠ‚ï¼Œå…¶æ•ˆç‡å¯¹ç¡®ä¿NameNodeæ“ä½œçš„å¯ç”¨æ€§éå¸¸é‡è¦ã€‚</li><li>å…¼å®¹æ€§<br>FSImageå°†éšç€HDFSçš„å„ç§åŠŸèƒ½çš„ä¸æ–­å‘å±•å’Œæ¼”å˜ã€‚FSImageçš„å®ç°å°†èƒ½å¤Ÿè¢«å„ç§ä¸åŒçš„ç‰ˆæœ¬æ‰€ä½¿ç”¨ï¼Œè¿™åœ¨æŸäº›åŠŸèƒ½ä¸‹éå¸¸é‡è¦ï¼Œæ¯”å¦‚æ»šåŠ¨å‡çº§ã€‚</li><li>äº’é€šæ€§<br>FSImageèƒ½è¢«ç¬¬ä¸‰æ–¹å·¥å…·è®¿é—®çš„éœ€æ±‚è¶Šæ¥è¶Šå¼ºçƒˆäº†ã€‚ä¾‹å¦‚æŸä¸ªå·¥å…·å¯ä»¥é€šè¿‡æ‰«æFSImageæ”¶é›†ä¸€äº›ç»Ÿè®¡ä¿¡æ¯ã€‚å› æ­¤FSImageåº”è¯¥æä¾›ä¸€ä¸ªä½¿ç¬¬ä¸‰æ–¹å·¥å…·èƒ½ä¸å…¶è¿›è¡Œäº¤äº’çš„æ¸…æ™°è§„èŒƒã€‚</li></ul><p>å½“å‰FSImageæ¨¡å—æœ‰å¤§çº¦2500è¡Œä»£ç ï¼Œä½†æ˜¯ç°åœ¨çš„è®¾è®¡ä¸å®ç°å¹¶ä¸èƒ½è§£å†³ä¸Šé¢çš„éœ€æ±‚ã€‚é¦–å…ˆï¼Œå¯¹äºå…¼å®¹æ€§è€Œè¨€ï¼Œå½“å‰ä»£ç ä¸­çš„ä¸€äº›å®ç°å¹¶ä¸ç†æƒ³ã€‚ä¾‹å¦‚æœ‰äº›å±æ€§æ¯”å¦‚inode IDså’Œblock IDsè¢«ç¼–ç ä¸ºäº†å›ºå®šé•¿åº¦çš„æ•´æ•°è€Œä¸æ˜¯å˜é•¿æ•´æ•°ã€‚</p><p>å…¶æ¬¡ï¼Œä»£ç ä¾èµ–ä¸åˆ†æ”¯ä¸Šçš„ä¸åŒå¸ƒå±€ç‰ˆæœ¬ä»¥ä¿æŒå‘åå…¼å®¹ã€‚åœ¨ä»£ç æ›´æ–°æ—¶åœ¨ä¿®æ”¹å’Œæµ‹è¯•ä¸Šéœ€è¦è€—è´¹å¾ˆå¤§çš„ç²¾åŠ›ã€‚ç„¶è€Œï¼Œè¿˜ä¸æ”¯æŒå‘å‰å…¼å®¹ï¼Œè¿™ä½¿NameNodeé™çº§å˜çš„å¾ˆå›°éš¾</p><p>å†æ¬¡ï¼ŒFSImageçš„æ ¼å¼ä»…ç”±ä»£ç çš„å…·ä½“å®ç°è€Œå†³å®šã€‚å¦‚æœæ²¡æœ‰æ­£å¼çš„FSImageè§„èŒƒï¼Œå¼€å‘äººå‘˜æ„å»ºç¬¬ä¸‰æ–¹å·¥å…·æ—¶ï¼Œåªèƒ½é€šè¿‡offline image vieweræ¥æ„å»ºï¼Œè¿™ç§æ–¹å¼æ—¶ä½æ•ˆçš„è€Œä¸”è¿˜å®¹æ˜“å‡ºé”™ã€‚</p><p>ä¸ºäº†è§£å†³ä¸Šé¢çš„æŒ‘æˆ˜ï¼Œæˆ‘ä»¬æè®®ä½¿ç”¨Googleçš„Protocol Buffersåè®®æ¥å®šä¹‰ä¸€ç§æ–°çš„FSImageæ ¼å¼ã€‚Protocol Buffersæ˜¯å¯æ‰©å±•çš„ï¼Œä¸è¯­è¨€æ— å…³çš„ï¼Œç”¨äºåºåˆ—åŒ–ç»“æ„æ•°æ®ã€‚Protobufèƒ½è§£å†³ä¸Šé¢çš„æŒ‘æˆ˜ã€‚é¦–å…ˆï¼ŒProtocolä½¿ç”¨ä¸€ä¸ªç¼–è¯‘å™¨ä¸ºåºåˆ—åŒ–å’Œååºåˆ—åŒ–ç”Ÿæˆé«˜æ•ˆçš„ä»£ç ã€‚å…¶æ¬¡ï¼Œå®ƒè¿˜æ”¯æŒå‘å‰å’Œå‘åå…¼å®¹ã€‚åºåˆ—åŒ–åçš„æ¯ä¸ªå±æ€§éƒ½åŒ…å«ä¸€ä¸ªå”¯ä¸€çš„æ ‡ç­¾ï¼Œå› æ­¤ååºåˆ—åŒ–çš„ä»£ç å¯ä»¥åŒæ—¶å¤„ç†æ–°åŠ çš„å­—æ®µå’Œç¼ºå¤±çš„å­—æ®µã€‚æœ€åï¼ŒProtocol Buffersçš„æºç ç›´æ¥å®šä¹‰äº†FSImageçš„æ ¼å¼ã€‚ç¬¬ä¸‰æ–¹å·¥å…·ä»…æ ¹æ®protocolæ–‡ä»¶å°±èƒ½çŸ¥é“FSImageçš„æ ¼å¼ã€‚</p><p><a href="https://issues.apache.org/jira/browse/HDFS-5698">HDFS-5698</a>æ˜¯å…³äºFSImageæ–°æ ¼å¼çš„issuesã€‚ä¸‹é¢çš„å†…å®¹ä»‹ç»äº†è®¾è®¡çš„ç»†èŠ‚ï¼Œæ–°æ ¼å¼çš„ä¸€äº›å®éªŒå‚æ•°ï¼Œæœªæ¥çš„æ–¹å‘å’Œç»“è®ºã€‚</p><h2 id="è®¾è®¡"><a href="#è®¾è®¡" class="headerlink" title="è®¾è®¡"></a>è®¾è®¡</h2><p>ä¸‹å›¾æ˜¯æ–°FSImageæ ¼å¼çš„EBNFè¯­æ³•æè¿°ã€‚æ•´ä¸ªFSImageåŒ…æ‹¬4éƒ¨åˆ†ï¼Œåˆ†åˆ«ä¸ºMAGICã€SECTIONã€FileSummaryå’ŒFileSummaryLengthï¼Œå…¶ä¸­SECTIONåŒ…å«Nä¸ªã€‚<br><img src="/blogimgs/fsimage-proto/EBNF.png" alt="FSImageæ ¼å¼" title="FSImageæ ¼å¼"></p><p>FSImageå°†æ•°æ®åˆ†æˆä¸åŒçš„éƒ¨åˆ†ã€‚æ¯éƒ¨åˆ†åœ¨æ•°æ®ä¸­éƒ½æ˜¯ç›¸äº’ç‹¬ç«‹çš„ã€‚å¼€å‘äººå‘˜å¯ä»¥æ·»åŠ æ–°çš„éƒ¨åˆ†æ¥æ‰©å±•FSImageã€‚</p><p>FileSummaryæ¨¡å—åŒ…å«4ä¸ªå±æ€§ï¼Œåˆ†åˆ«ä¸ºondiskVersionã€layoutVersionã€codecå’Œsectionsï¼Œå…¶ä¸­sectionsä¸­è®°å½•äº†æ¯ä¸ªsectionçš„åå­—ã€é•¿åº¦å’Œåç§»é‡ã€‚æ‰€æœ‰çš„sectionå¯ä»¥ä½¿ç”¨æŒ‡å®šçš„codecå¯¹å…¶è¿›è¡Œå‹ç¼©ã€‚æ¯ä¸ªsectionéƒ½æ˜¯å•ç‹¬å‹ç¼©çš„ï¼Œè€Œä¸”sectionä¸­è®°å½•çš„é•¿åº¦å’Œåç§»é‡éƒ½æ˜¯å‹ç¼©ä¹‹åçš„ï¼Œå› æ­¤å½“è¯»å–çš„æ—¶å€™å¯ä»¥ç›´æ¥é€šè¿‡å“åº”çš„åç§»é‡è€Œç›´æ¥å®šä½åˆ°æŸä¸ªsectionã€‚</p><p>å½“è§£æFSImageæ—¶ï¼Œå…ˆä»æ–‡ä»¶çš„æœ«å°¾è¯»å–4bytesï¼Œè¯»å–çš„4bytesæ•°æ®è®°å½•äº†FileSummaryæ¨¡å—çš„é•¿åº¦ï¼Œé€šè¿‡è§£æFileSummaryæ¨¡å—èƒ½å¾—åˆ°æ‰€æœ‰sectionçš„ä½ç½®ä¿¡æ¯ï¼Œè¿™æ ·è®¾è®¡å…è®¸å†™å…¥æ—¶æŒ‰é¡ºåºä¿ç•™FSImageã€‚</p><h3 id="åºåˆ—åŒ–inode"><a href="#åºåˆ—åŒ–inode" class="headerlink" title="åºåˆ—åŒ–inode"></a>åºåˆ—åŒ–inode</h3><p>FSImageå°†inodeåºåˆ—åŒ–ä¸ºä¸¤ç§sectionã€‚<code>INodeSection</code>è®°å½•äº†æ¯ä¸ªinode(<strong>åŒ…æ‹¬INodeFileå’ŒINodeDirectory</strong>)çš„ä¿¡æ¯ï¼Œ<code>INodeDirectorySection</code>è®°å½•äº†æ¯ä¸ªç›®å½•çš„å­inodesã€‚è¿™ç§å°†inodeså½“ä½œå›¾è€Œä¸æ˜¯æ ‘çš„è®¾è®¡æ¨¡å¼æœ‰ä¸¤ä¸ªä¼˜ç‚¹ï¼Œç¬¬ä¸€ä¸å®é™…çš„å›¾æ›´åŠ åŒ¹é…ï¼Œå› æ­¤å½“å¿«ç…§å­˜åœ¨æ—¶ï¼Œinodeä¸ç”¨å†å½¢æˆæ ‘ã€‚ä¸åŒçš„ç›®å½•èƒ½é€šè¿‡<code>INodeReference</code>å¯¹è±¡æŒ‡å‘åŒä¸€ä¸ªinodeã€‚ç¬¬äºŒå®ƒå°†ç»“æ„æ‰å¹³åŒ–ï¼Œä»è€Œä¸ºå¹¶è¡Œæ€§æä¾›äº†æœºä¼šã€‚æ¯ä¸ªinodeéƒ½ç‹¬ç«‹çš„å­˜å‚¨åœ¨FSImageä¸­ï¼Œå› æ­¤å¯ä»¥å¹¶è¡Œçš„è§£æå’Œæ„å»ºä¸åŒçš„inodesã€‚</p><p>åœ¨protobufçš„è§„èŒƒä¸­ï¼Œ<code>INodeSection</code>å¹¶ä¸åŒ…å«inodeåˆ—è¡¨ï¼Œè€Œæ˜¯åœ¨INodeSectionéšåçš„protobufæ¶ˆæ¯ä¸­éšå¼çš„æŒ‡å®šäº†inodeåˆ—è¡¨ã€‚è¿™æ ·åšçš„åŸå› æ—¶Protocol Buffersåœ¨ç”Ÿæˆä»£ç çš„æ—¶å€™éœ€è¦å°†æ‰€æœ‰çš„å±æ€§åŠ è½½åˆ°å†…å­˜ï¼Œç„¶è€Œinodesåˆ—è¡¨å¯èƒ½å¤ªå¤§è€Œä¸èƒ½åŠ è½½åˆ°å†…å­˜ã€‚æ–‡ä¸­çš„è¿™ç§è®¾è®¡å…è®¸FSImageä»¥é€’å¢çš„æ–¹å¼è§£æã€‚</p><p>ä»¤äººæƒŠè®¶çš„æ˜¯ï¼Œæˆ‘ä»¬çš„åˆå§‹åˆ†æç»“æœè¡¨æ˜åºåˆ—åŒ–æƒé™æ˜¯ä»£ç ä¸­çš„ç“¶é¢ˆã€‚æƒé™æ˜¯ä¸€ä¸ªå…ƒç»„ï¼ŒåŒ…å«ç”¨æˆ·åï¼Œç»„åå’Œè¡¨ç¤ºæƒé™ä½çš„16ä½æ•´æ•°ã€‚ç®€å•çš„è§£å†³æ–¹æ¡ˆæ˜¯ç›´æ¥åºåˆ—åŒ–ä¸¤ä¸ªåç§°å’Œ16ä½æ•´æ•°ã€‚ ä½†æ˜¯ï¼Œæˆ‘ä»¬å‘ç°FSImageä¸­çš„åç§°æ˜¯é«˜åº¦å†—ä½™çš„ï¼Œååºåˆ—åŒ–ä¸ºJavaçš„Stringå¯¹è±¡éœ€è¦å¤§é‡çš„CPUæ—¶é—´ã€‚ä¸ºäº†ä¼˜åŒ–æ­¤ç”¨ä¾‹ï¼ŒFSImageå°†åç§°æ˜ å°„ä¸º24ä½IDï¼Œä»¥ä¾¿å¯ä»¥ä½¿ç”¨64ä½æ•´æ•°è¡¨ç¤ºæƒé™ã€‚</p><h2 id="å®éªŒ"><a href="#å®éªŒ" class="headerlink" title="å®éªŒ"></a>å®éªŒ</h2><p>ä¸ºäº†è¯„ä¼°æ–°FSImageçš„æ€§èƒ½ï¼Œæˆ‘ä»¬æ¯”è¾ƒäº†æ–°æ—§æ ¼å¼çš„FSImageæ–‡ä»¶çš„å¤§å°ï¼Œå’ŒæŒä¹…åŒ–å’ŒåŠ è½½FSImageæ‰€éœ€è¦çš„æ—¶é—´ã€‚æˆ‘ä»¬å°†ç”Ÿäº§ä¸­ä½¿ç”¨çš„FSImageç¼©æ”¾åˆ°äº”ç§ä¸åŒçš„å°ºå¯¸ï¼Œä»¥è¯„ä¼°å…·æœ‰å„ç§å°ºåº¦é›†ç¾¤çš„æ€§èƒ½ã€‚æ‰€æœ‰çš„æµ‹è¯•éƒ½è¿è¡Œåœ¨ç›¸åŒçš„æœºå™¨ä¸Šã€‚</p><p>å›¾2æ¯”è¾ƒäº†æ–°æ—§FSImageçš„å¤§å°ã€‚FSImageéƒ½æ˜¯æœªå‹ç¼©çš„ã€‚ç”±å›¾ä¸­æ‰€çŸ¥æ–°æ ¼å¼çš„FSImageèƒ½å¤ŸèŠ‚çœ6-13%çš„ç£ç›˜ç©ºé—´ã€‚<br><img src="/blogimgs/fsimage-proto/fig2.png" alt="å›¾2" title="å›¾2"></p><p>å›¾3å±•ç¤ºäº†æ–°æ—§FSImageåŠ è½½å’ŒæŒä¹…åŒ–çš„å¤„ç†æ—¶é—´ï¼Œä¹Ÿéƒ½æ˜¯æœªå‹ç¼©çš„ã€‚æ–°FSImageæœ‰ç€è¾ƒå¥½çš„å†™æ€§èƒ½ã€‚<br><img src="/blogimgs/fsimage-proto/fig3.png" alt="å›¾3" title="å›¾3"></p><p>æ–°FSImageè¯»æ¯”æ—§FSImageæ‰€è€—çš„æ—¶é—´é•¿ï¼Œå¤§çº¦ä¸º1.5x-2.3xã€‚åˆ†æç»“æœè¡¨æ˜ï¼Œè§£æå­—èŠ‚å’Œæ„é€ ä¸ºprotocol buffersç”Ÿæˆçš„å¯¹è±¡å ç”¨å¤§éƒ¨åˆ†æ—¶é—´ã€‚ æ—§æ ¼å¼çš„ä»£ç è¯»å–æ•°æ®å¹¶ç›´æ¥æ„é€ HDFSä¸­ä½¿ç”¨çš„å¯¹è±¡ï¼Œè¿™ä¸ä¼šå—åˆ°è¿™ç§ç±»å‹çš„å¼€é”€çš„å½±å“ã€‚</p><h2 id="æœªæ¥å·¥ä½œ"><a href="#æœªæ¥å·¥ä½œ" class="headerlink" title="æœªæ¥å·¥ä½œ"></a>æœªæ¥å·¥ä½œ</h2><h3 id="å¹¶è¡ŒåŒ–"><a href="#å¹¶è¡ŒåŒ–" class="headerlink" title="å¹¶è¡ŒåŒ–"></a>å¹¶è¡ŒåŒ–</h3><p>æ–°FSImageçš„è®¾è®¡æ ¼å¼ä¸ºå¹¶è¡ŒåŠ è½½æä¾›äº†æœºä¼šã€‚æ–°çš„FSImageå•ç‹¬å­˜å‚¨æ¯ä¸ªinodeï¼Œå› æ­¤å¯ä»¥å¹¶è¡Œçš„è§£ææ•°æ®å’Œé‡æ„inodeã€‚åŒæ ·ï¼Œæ–°FSImageä¹Ÿå¯ä»¥å¹¶è¡Œçš„å¡«å……ä¸åŒç›®å½•çš„å­èŠ‚ç‚¹ã€‚</p><p>é‡å»ºBlockMapå ç”¨CPUæ—¶é—´çš„å¤§çº¦ä¸º20ï¼…ã€‚åœ¨æ–°çš„FSImageæ ¼å¼ä¸‹ï¼Œå¯ä»¥å°†BlockMapçš„å·¥ä½œè´Ÿè½½è½¬ç§»åˆ°å•ç‹¬çš„çº¿ç¨‹ä¸­ï¼Œä»è€Œéšè—å»¶è¿Ÿã€‚</p><h3 id="ç›´æ¥æ„å»ºå¯¹è±¡"><a href="#ç›´æ¥æ„å»ºå¯¹è±¡" class="headerlink" title="ç›´æ¥æ„å»ºå¯¹è±¡"></a>ç›´æ¥æ„å»ºå¯¹è±¡</h3><p>æ–°çš„FSImageéœ€è¦é¦–å…ˆé€šè¿‡Protocol Buffersç”Ÿæˆçš„å¯¹è±¡ï¼Œç„¶åæ ¹æ®ç”Ÿæˆçš„å¯¹è±¡æ„é€ HDFSä¸­ä½¿ç”¨çš„å¯¹è±¡ã€‚å®éªŒç»“æœæ˜¾ç¤ºæ„é€ ç”Ÿæˆçš„å¯¹è±¡éœ€è¦å¤§é‡æ—¶é—´ã€‚ å¯ä»¥æ‰‹åŠ¨è§£æProtocol Bufferså¹¶ç›´æ¥æ„é€ å¯¹è±¡ï¼Œä»è€Œæ¶ˆé™¤äº†å¼€é”€ã€‚</p><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><p>FSImageçš„æ€§èƒ½å’Œå¯é æ€§å¯¹äºæä¾›HDFSçš„è€ç”¨æ€§å’Œå¯ç”¨æ€§éå¸¸é‡è¦ã€‚æœ¬æ–‡æè¿°äº†ä¸€ç§åŸºäºProtocol Buffersçš„æ–°FSImageæ ¼å¼ã€‚æ–°æ ¼å¼æ»¡è¶³äº†FSImageçš„æ•ˆç‡ï¼Œå…¼å®¹æ€§å’Œäº’æ“ä½œæ€§è¦æ±‚ã€‚ æˆ‘ä»¬å¸Œæœ›æ–°æ ¼å¼å¯ä»¥ä¿ƒè¿›HDFSçš„åˆ›æ–°ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> FSImage </tag>
            
            <tag> protobuf </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ†å¸ƒå¼ä¸€è‡´æ€§åè®®</title>
      <link href="/Consistency-in-Distributed.html"/>
      <url>/Consistency-in-Distributed.html</url>
      
        <content type="html"><![CDATA[<p>åˆ†å¸ƒå¼ç³»ç»Ÿä¸­æœ‰ä¸ªè‘—åçš„åŸåˆ™CAPåŸåˆ™ï¼ŒCä¸ºConsistency(ä¸€è‡´æ€§)ã€Aä¸ºAvailability(å¯ç”¨æ€§)ã€Pä¸ºPartition tolerance(åˆ†åŒºå®¹é”™æ€§)ã€‚è¿™é‡Œä¸»è¦ä»‹ç»ä¸‹åˆ†å¸ƒå¼ç¯å¢ƒä¸‹å¦‚æœè¾¾åˆ°ä¸€è‡´æ€§ã€‚</p><p>è¯´åˆ°ä¸€è‡´æ€§ä¸å¾—ä¸è¯´ä¸‹ç»å…¸çš„æ‹œå åº­é—®é¢˜ã€‚</p><span id="more"></span><!--åˆ†å¸ƒå¼å…±è¯†ç®—æ³•æ˜¯åˆ†å¸ƒå¼ç³»ç»Ÿçš„æ ¸å¿ƒï¼Œå¸¸è§çš„æœ‰Paxosã€pbftã€bftã€raftã€powç­‰ã€‚åŒºå—é“¾ä¸­å¸¸è§çš„æ˜¯POWã€POSã€DPOSã€pbftç­‰ã€‚ å…¶ä¸­ï¼šPOWã€POSã€DPOSæ˜¯å¼€æ”¾å¼çš„å…±è¯†åè®®PBFTä¸ºåŠå¼€æ”¾å¼çš„å…±è¯†åè®®Paxosã€raftç­‰æ˜¯å°é—­å¼å…±è¯†åè®®åŒºåˆ«ï¼šå¼€æ”¾å¼ï¼Œæ— æ³•ç¡®åˆ‡çš„çŸ¥é“èŠ‚ç‚¹çš„å¤šå°‘åŠè¿æ¥çŠ¶æ€ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½æ˜¯æ¶æ„çš„ï¼Œä½†æ˜¯å¤§å¤šæ•°æ˜¯éæ¶æ„çš„åŠå¼€æ”¾å¼ï¼Œå¯ä»¥ç¡®å®šèŠ‚ç‚¹çš„å¤šå°‘åŠè¿æ¥çŠ¶æ€ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½æ˜¯æ¶æ„çš„ï¼Œä½†æ˜¯æœ‰æ»¡è¶³ä¸€å®šæ¡ä»¶çš„éæ¶æ„èŠ‚ç‚¹å°é—­å¼ï¼Œæ¯ä¸ªèŠ‚ç‚¹éƒ½æ˜¯éæ¶æ„çš„ï¼Œåªä¸è¿‡å¯èƒ½æ–­å¼€è¿æ¥æˆ–crashã€‚--><h2 id="æ‹œå åº­é—®é¢˜"><a href="#æ‹œå åº­é—®é¢˜" class="headerlink" title="æ‹œå åº­é—®é¢˜"></a>æ‹œå åº­é—®é¢˜</h2><p>è¯è¯´ä¸€ç»„æ‹œå åº­å°†å†›åˆ†åˆ«å„ç‡é¢†ä¸€æ”¯å†›é˜Ÿå…±åŒå›´å›°ä¸€åº§åŸå¸‚ã€‚ä¸ºäº†ç®€åŒ–é—®é¢˜ï¼Œå°†å„æ”¯å†›é˜Ÿçš„è¡ŒåŠ¨ç­–ç•¥é™å®šä¸ºè¿›æ”»æˆ–æ’¤ç¦»ä¸¤ç§ã€‚å› ä¸ºéƒ¨åˆ†å†›é˜Ÿè¿›æ”»éƒ¨åˆ†å†›é˜Ÿæ’¤ç¦»å¯èƒ½ä¼šé€ æˆç¾éš¾æ€§åæœï¼Œå› æ­¤å„ä½<em>å°†å†›å¿…é¡»é€šè¿‡æŠ•ç¥¨æ¥è¾¾æˆä¸€è‡´ç­–ç•¥ï¼Œå³æ‰€æœ‰å†›é˜Ÿä¸€èµ·è¿›æ”»æˆ–æ‰€æœ‰å†›é˜Ÿä¸€èµ·æ’¤ç¦»</em>ã€‚å› ä¸ºå„ä½å°†å†›åˆ†å¤„åŸå¸‚ä¸åŒæ–¹å‘ï¼Œä»–ä»¬<em>åªèƒ½é€šè¿‡ä¿¡ä½¿äº’ç›¸è”ç³»</em>ã€‚åœ¨æŠ•ç¥¨è¿‡ç¨‹ä¸­æ¯ä½å°†å†›éƒ½å°†è‡ªå·±æŠ•ç¥¨ç»™è¿›æ”»è¿˜æ˜¯æ’¤é€€çš„ä¿¡æ¯é€šè¿‡ä¿¡ä½¿åˆ†åˆ«é€šçŸ¥å…¶ä»–æ‰€æœ‰å°†å†›ï¼Œè¿™æ ·ä¸€æ¥æ¯ä½å°†å†›æ ¹æ®è‡ªå·±çš„æŠ•ç¥¨å’Œå…¶ä»–æ‰€æœ‰å°†å†›é€æ¥çš„ä¿¡æ¯å°±å¯ä»¥çŸ¥é“å…±åŒçš„æŠ•ç¥¨ç»“æœè€Œå†³å®šè¡ŒåŠ¨ç­–ç•¥ã€‚</p><p>ç³»ç»Ÿçš„é—®é¢˜åœ¨äºï¼Œ<strong>å°†å†›ä¸­å¯èƒ½å‡ºç°å›å¾’ï¼Œä»–ä»¬ä¸ä»…å¯èƒ½å‘è¾ƒä¸ºç³Ÿç³•çš„ç­–ç•¥æŠ•ç¥¨ï¼Œè¿˜å¯èƒ½é€‰æ‹©æ€§åœ°å‘é€æŠ•ç¥¨ä¿¡æ¯ã€‚å‡è®¾æœ‰9ä½å°†å†›æŠ•ç¥¨ï¼Œå…¶ä¸­1åå›å¾’ã€‚8åå¿ è¯šçš„å°†å†›ä¸­å‡ºç°äº†4äººæŠ•è¿›æ”»ï¼Œ4äººæŠ•æ’¤ç¦»çš„æƒ…å†µã€‚è¿™æ—¶å€™å›å¾’å¯èƒ½æ•…æ„ç»™4åæŠ•è¿›æ”»çš„å°†é¢†é€ä¿¡è¡¨ç¤ºæŠ•ç¥¨è¿›æ”»ï¼Œè€Œç»™4åæŠ•æ’¤ç¦»çš„å°†é¢†é€ä¿¡è¡¨ç¤ºæŠ•æ’¤ç¦»ã€‚è¿™æ ·ä¸€æ¥åœ¨4åæŠ•è¿›æ”»çš„å°†é¢†çœ‹æ¥ï¼ŒæŠ•ç¥¨ç»“æœæ˜¯5äººæŠ•è¿›æ”»ï¼Œä»è€Œå‘èµ·è¿›æ”»ï¼›è€Œåœ¨4åæŠ•æ’¤ç¦»çš„å°†å†›çœ‹æ¥åˆ™æ˜¯5äººæŠ•æ’¤ç¦»ã€‚è¿™æ ·å„æ”¯å†›é˜Ÿçš„ä¸€è‡´ååŒå°±é­åˆ°äº†ç ´å</strong>ã€‚</p><p>æ‹œå åº­é—®é¢˜å…¶å®æ˜¯æŒ‡åœ¨ä¸€ä¸ªå¯å¦¥åçš„é€šä¿¡ç½‘ç»œä¸­å®ç°åˆ†å¸ƒå¼åè®®çš„é—®é¢˜ï¼Œä¹Ÿå°±æ˜¯<em>åœ¨ä¸å¯é çš„ç¯å¢ƒä¸­å»ºç«‹ä¸€ä¸ªå¯é çš„ç³»ç»Ÿçš„é—®é¢˜</em>ã€‚</p><p>å‡å§‹é‚£äº›å¿ è¯šï¼ˆæˆ–æ˜¯æ²¡æœ‰å‡ºé”™ï¼‰çš„å°†å†›ä»ç„¶èƒ½é€šè¿‡å¤šæ•°å†³ç­–æ¥å†³å®šä»–ä»¬çš„æˆ˜ç•¥ï¼Œä¾¿ç§°è¾¾åˆ°äº†<strong>æ‹œå åº­å®¹é”™</strong>ã€‚</p><!--åœ¨ç‚¹å¯¹ç‚¹å¼æ•°å­—è´§å¸ç³»ç»Ÿæ¯”ç‰¹å¸é‡Œï¼Œæ¯”ç‰¹å¸ç½‘ç»œçš„è¿ä½œæ˜¯å¹³è¡Œçš„ï¼ˆparallelï¼‰ã€‚å„ç»“ç‚¹ä¸ç»ˆç«¯éƒ½è¿ç®—è‘—åŒºå—é“¾æ¥è¾¾æˆå·¥ä½œé‡è¯æ˜ï¼ˆPoWï¼‰ã€‚å·¥ä½œé‡è¯æ˜çš„é“¾æ¡æ˜¯è§£å†³æ¯”ç‰¹å¸ç³»ç»Ÿä¸­æ‹œå åº­é—®é¢˜çš„å…³é”®ï¼Œé¿å…æœ‰é—®é¢˜çš„ç»“ç‚¹ï¼ˆå³å‰æ–‡æåˆ°çš„â€œåå›çš„å°†å†›â€ï¼‰ç ´åæ•°å­—è´§å¸ç³»ç»Ÿé‡Œäº¤æ˜“å¸çš„æ­£ç¡®æ€§ï¼Œæ˜¯å¯¹æ•´ä¸ªç³»ç»Ÿçš„è¿è¡ŒçŠ¶æ€æœ‰ç€é‡è¦çš„æ„ä¹‰ã€‚æ¯”ç‰¹å¸ä½¿ç”¨ç»è¿‡å·¥ä½œé‡è¯æ˜åŒºå—é“¾æŠ€æœ¯è§£å†³äº†æ‹œå åº­å®¹é”™é—®é¢˜ã€‚ POWå¢åŠ äº†æå‡ºææ¡ˆçš„æˆæœ¬ï¼Œä¸æ˜¯ä»»æ„èŠ‚ç‚¹å¯ä»¥éšæ„æå‡ºææ¡ˆï¼Œåœ¨æºå¤´å‡å°‘äº†å¹²æ‰°ä¿¡æ¯--><h2 id="PBFT"><a href="#PBFT" class="headerlink" title="PBFT"></a>PBFT</h2><p>PBFTæ˜¯Practical Byzantine Fault Toleranceçš„ç¼©å†™ï¼Œæ„ä¸º<em>å®ç”¨æ‹œå åº­å®¹é”™ç®—æ³•</em>ï¼Œå¤æ‚åº¦è¿‡é«˜<code>O(N^2)</code>ã€‚PBFTæ˜¯ä¸€ç§<em>çŠ¶æ€æœºå‰¯æœ¬å¤åˆ¶ç®—æ³•</em>ï¼Œå³æœåŠ¡ä½œä¸ºçŠ¶æ€æœºè¿›è¡Œå»ºæ¨¡ï¼ŒçŠ¶æ€æœºåœ¨åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸åŒèŠ‚ç‚¹è¿›è¡Œå‰¯æœ¬å¤åˆ¶ã€‚æ¯ä¸ªçŠ¶æ€æœºçš„å‰¯æœ¬éƒ½ä¿å­˜äº†æœåŠ¡çš„çŠ¶æ€ï¼ŒåŒæ—¶ä¹Ÿå®ç°äº†æœåŠ¡çš„æ“ä½œã€‚</p><p>PBFTæ˜¯ä¸€ä¸ª<strong>ä¸‰é˜¶æ®µç®—æ³•</strong>ï¼Œåˆ†ä¸º<code>Pre-Prepare</code>ã€<code>Prepare</code>å’Œ<code>Commit</code>ã€‚<br>PBFTä¸­æœ‰å‡ ä¸ªæ¦‚å¿µéœ€è¦äº†è§£ä¸‹ï¼Œæ‰€æœ‰çš„èŠ‚ç‚¹ç§°ä¸º<code>å‰¯æœ¬</code>ï¼Œè¿™äº›å‰¯æœ¬æœ‰ä¸¤ä¸ªè§’è‰²ï¼Œåˆ†åˆ«ä¸ºä¸»èŠ‚ç‚¹(primary)å’Œå¤‡ä»½èŠ‚ç‚¹(backups)ï¼Œæ‰€æœ‰çš„å‰¯æœ¬åœ¨ä¸€ä¸ªè¢«ç§°ä¸º<code>è§†å›¾</code>(View)çš„è½®æ¢è¿‡ç¨‹ä¸­è¿ä½œã€‚<em>ä¸»èŠ‚ç‚¹å’Œå¤‡ä»½èŠ‚ç‚¹æ˜¯é’ˆå¯¹è§†å›¾è€Œè¨€ï¼Œè§†å›¾æ˜¯è¿ç»­ç¼–å·çš„æ•´æ•°</em>ã€‚åœ¨æŸä¸ªè§†å›¾ä¸­ï¼Œä»å‰¯æœ¬ä¸­é€‰å‡ºä¸€ä¸ªå‰¯æœ¬ä¸ºä¸»èŠ‚ç‚¹ï¼Œé€‰æ‹©ç®—æ³•ä¸º<code>p = v mod |R|</code>ï¼Œå…¶ä¸­væ˜¯è§†å›¾ç¼–å·ï¼Œ|R|ä¸ºå‰¯æœ¬ä¸ªæ•°ï¼Œpä¸ºå‰¯æœ¬ç¼–å·ï¼Œé™¤ä¸»èŠ‚ç‚¹ä¹‹å¤–æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ä¸ºå¤‡ä»½èŠ‚ç‚¹ã€‚å½“<strong>ä¸»èŠ‚ç‚¹å¤±æ•ˆ</strong>çš„æ—¶å€™å°±éœ€è¦å¯åŠ¨è§†å›¾æ›´æ¢è¿‡ç¨‹ã€‚</p><p>çŸ¥é“ä¸Šè¿°æ¦‚å¿µä¹‹åï¼Œæ¥çœ‹ä¸‹ç®—æ³•çš„å…·ä½“æµç¨‹ï¼š<br><img src="/blogimgs/PBFT-Paxos-Raft/pbft.png" alt="PBFT" title="PBFT"><br>å…¶ä¸­0ä¸ºä¸»èŠ‚ç‚¹ï¼Œ123ä¸ºå¤‡ä»½èŠ‚ç‚¹ï¼Œ3å®•æœºæ— æ³•å“åº”è¯·æ±‚</p><ol><li>ä¸»èŠ‚ç‚¹0æ¥æ”¶åˆ°å®¢æˆ·ç«¯Cå‘æ¥çš„è¯·æ±‚requestï¼Œç»™è¯·æ±‚åˆ†é…ä¸€ä¸ªåºåˆ—å·nï¼Œç„¶åå‘æ‰€æœ‰<strong>å¤‡ä»½èŠ‚ç‚¹</strong>ç¾¤å‘é¢„å‡†å¤‡æ¶ˆæ¯ï¼Œé¢„å‡†å¤‡æ¶ˆæ¯çš„æ ¼å¼ä¸º&lt;&lt;PRE-PREPARE,v,n,d&gt;,m&gt;ï¼Œè¿™é‡Œvæ˜¯è§†å›¾ç¼–å·ï¼Œmæ˜¯å®¢æˆ·ç«¯å‘é€çš„è¯·æ±‚æ¶ˆæ¯ï¼Œdæ˜¯è¯·æ±‚æ¶ˆæ¯mçš„æ‘˜è¦ã€‚</li><li>å¤‡ä»½èŠ‚ç‚¹æ”¶åˆ°ä¸»èŠ‚ç‚¹å¹¿æ’­çš„æ¶ˆæ¯ä¹‹åï¼Œcheckä¸‹è‡ªå·±æ˜¯å¦æ¥å—ï¼Œæ¥å—ä¹‹åå‘<strong>å…¶å®ƒå‰¯æœ¬</strong>è¿›è¡Œprepareå¹¿æ’­</li><li>æŸä¸ªå‰¯æœ¬åœ¨æ¥æ”¶åˆ°<code>2f</code>ä¸ªprepareä¿¡æ¯ä¹‹åï¼Œå‘<strong>å…¶å®ƒå‰¯æœ¬</strong>å¹¿æ’­commit<!--(*å¤‡ä»½èŠ‚ç‚¹çš„2fä¸­æœ‰ä¸€ä¸ªæ˜¯æœªå¹¿æ’­ç»™è‡ªå·±çš„prepareä¿¡æ¯*)--></li><li>æŸä¸ªå‰¯æœ¬åœ¨æ¥æ”¶åˆ°<code>2f+1</code>ä¸ªcommitä¿¡æ¯ä¹‹åï¼Œå‘å®¢æˆ·ç«¯Cå‘é€reply<!--ä¹‹æ‰€ä»¥è¿™é‡Œæ˜¯2f+1ï¼Œæ˜¯å› ä¸ºä¸»èŠ‚ç‚¹åŠ å…¥äº†å¹¿æ’­åºåˆ—--></li><li>å®¢æˆ·ç«¯Cåœ¨æ¥æ”¶åˆ°<code>f+1</code>ä¸ªç›¸åŒçš„replyä¹‹ååˆ™è¾¾æˆå…±è¯†<!--éœ€è¦æ³¨æ„çš„æ˜¯ä¸»èŠ‚ç‚¹æ²¡æœ‰æ”¶åˆ°pre-prepareå¹¿æ’­ï¼Œæ²¡æœ‰è‡ªå·±çš„prepareä¿¡æ¯ï¼Œä½†æ˜¯å¯ä»¥æ”¶åˆ°å¤‡ä»½èŠ‚ç‚¹çš„prepareä¿¡æ¯ï¼Œæ”¶åˆ°2fä¸ªä¹‹åå°±å¯ä»¥è¿›è¡Œå¹¿æ’­commitä¿¡æ¯--></li></ol><!--åŒæ‰€æœ‰çš„çŠ¶æ€æœºå‰¯æœ¬å¤åˆ¶æŠ€æœ¯ä¸€æ ·ï¼ŒPBFTå¯¹æ¯ä¸ªå‰¯æœ¬èŠ‚ç‚¹æå‡ºäº†ä¸¤ä¸ªé™å®šæ¡ä»¶ï¼šï¼ˆ1ï¼‰æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»æ˜¯ç¡®å®šæ€§çš„ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨ç»™å®šçŠ¶æ€å’Œå‚æ•°ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œæ“ä½œæ‰§è¡Œçš„ç»“æœå¿…é¡»ç›¸åŒï¼›ï¼ˆ2ï¼‰æ‰€æœ‰èŠ‚ç‚¹å¿…é¡»ä»ç›¸åŒçš„çŠ¶æ€å¼€å§‹æ‰§è¡Œã€‚åœ¨è¿™ä¸¤ä¸ªé™å®šæ¡ä»¶ä¸‹ï¼Œå³ä½¿å¤±æ•ˆçš„å‰¯æœ¬èŠ‚ç‚¹å­˜åœ¨ï¼ŒPBFTç®—æ³•å¯¹æ‰€æœ‰éå¤±æ•ˆå‰¯æœ¬èŠ‚ç‚¹çš„è¯·æ±‚æ‰§è¡Œæ€»é¡ºåºè¾¾æˆä¸€è‡´ï¼Œä»è€Œä¿è¯å®‰å…¨æ€§ã€‚--><p>æ‹œå åº­é—®é¢˜æ˜¯ä¸€ä¸ªç†è®ºæ€§çš„æ¨¡å‹ï¼Œè§£å†³èµ·æ¥æ¯”è¾ƒå›°éš¾ï¼Œå·¥ç¨‹å®è·µä¸Šå¯ä»¥å°†å…¶æ¨¡å‹çš„æŸäº›æ¡ä»¶è¿›è¡Œå‡è®¾ï¼Œè¿™æ ·å¯ä»¥è§£å†³ä¸€äº›ç‰¹å®šçš„é—®é¢˜ã€‚<br>å°†é›†ç¾¤ä¸­æ˜¯å¦å­˜åœ¨èƒŒå›è€…ä½œä¸ºä¸€ä¸ªå·²çŸ¥æ¡ä»¶æ¥å°†æ‹œå åº­é—®é¢˜ç»†åˆ†ä¸‹ï¼š</p><ol><li>å‡å¦‚é›†ç¾¤ä¸­å­˜åœ¨èƒŒå›è€…ï¼Œä¹Ÿå°±æ˜¯æœ‰ä¸€äº›ä¼ªé€ ä¿¡æ¯ï¼Œè¿™ç§æƒ…å†µç§°ä¸º<em>æ‹œå åº­é”™è¯¯</em>ï¼Œä¼ªé€ ä¿¡æ¯çš„èŠ‚ç‚¹ç§°ä¸ºæ‹œå åº­èŠ‚ç‚¹ã€‚å…¶ä¸€è‡´æ€§ç®—æ³•ä¸ºBFTï¼ˆByzantine Fault Toleranceï¼‰ï¼Œä¸Šæ–‡ä»‹ç»çš„PBFTå°±æ˜¯ä¸€ä¸ªæ‹œå åº­å®¹é”™ç®—æ³•ã€‚</li><li>å¦‚æœé›†ç¾¤ä¸­ä¸å­˜åœ¨èƒŒå›è€…ï¼Œéƒ½æ˜¯å¿ è¯šè€…ï¼Œåªæ˜¯è¿™äº›å¿ è¯šè€…ç”±äºæŸç§åŸå› æ— æ³•æ­£å¸¸å·¥ä½œï¼Œè¿™ç§æƒ…å†µç§°ä¸º<em>éæ‹œå åº­é”™è¯¯</em>ã€‚å…¶ä¸€è‡´æ€§ç®—æ³•ä¸ºCFTï¼ˆCrash Fault Toleranceï¼‰ã€‚</li></ol><p>ä¸‹é¢æˆ‘ä»¬å°±ä»‹ç»ä¸¤ä¸ªéæ‹œå åº­ä¸€è‡´æ€§ç®—æ³•<em>Paxos</em>å’Œ<em>Raft</em>ã€‚</p><h2 id="Paxos"><a href="#Paxos" class="headerlink" title="Paxos"></a>Paxos</h2><p>Paxosç®—æ³•ä¸ºéæ‹œå åº­ä¸€è‡´æ€§ç®—æ³•ï¼Œ<em>è¿è¡Œåœ¨å…è®¸å®•æœºæ•…éšœçš„å¼‚æ­¥ç³»ç»Ÿä¸­ï¼Œä¸è¦æ±‚å¯é çš„æ¶ˆæ¯ä¼ é€’ï¼Œå¯å®¹å¿æ¶ˆæ¯ä¸¢å¤±ã€å»¶è¿Ÿã€ä¹±åºä»¥åŠé‡å¤</em>ã€‚<strong>å®ƒåˆ©ç”¨å¤§å¤šæ•°æœºåˆ¶ä¿è¯äº†2F+1çš„å®¹é”™èƒ½åŠ›ï¼Œå³2F+1ä¸ªèŠ‚ç‚¹çš„ç³»ç»Ÿæœ€å¤šå…è®¸Fä¸ªèŠ‚ç‚¹åŒæ—¶å‡ºç°æ•…éšœ</strong>ã€‚</p><p>Paxosç®—æ³•ä¸­çš„è§’è‰²åˆ†ä¸ºProposerå’ŒAcceptorï¼ŒProposeræ˜¯ææ¡ˆè€…ï¼Œç”¨æ¥å‘èµ·ææ¡ˆï¼ˆProposalï¼‰ï¼ŒAcceptoræ˜¯å†³ç­–è€…ï¼Œç”¨æ¥æ¥æ”¶å’Œå“åº”Proposeræå‡ºçš„ææ¡ˆã€‚è¿™ä¸ªç®—æ³•çš„åœºæ™¯æ˜¯<strong>ä¸€ä¸ªæˆ–å¤šä¸ªæè®®è¿›ç¨‹ï¼ˆProposerï¼‰å¯ä»¥å‘èµ·ææ¡ˆï¼ˆProposalï¼‰ï¼Œéœ€è¦åœ¨æ‰€æœ‰ææ¡ˆä¸­é€‰å–æŸä¸€ä¸ªææ¡ˆï¼Œä½¿å…¶åœ¨æ‰€æœ‰è¿›ç¨‹ä¸­è¾¾æˆä¸€è‡´ã€‚ç³»ç»Ÿä¸­çš„å¤šæ•°æ´¾åŒæ—¶è®¤å¯è¯¥ææ¡ˆï¼Œå³è¾¾æˆäº†ä¸€è‡´ã€‚æœ€å¤šåªé’ˆå¯¹ä¸€ä¸ªç¡®å®šçš„ææ¡ˆè¾¾æˆä¸€è‡´ã€‚</strong></p><p>Paxosç®—æ³•æµç¨‹åˆ†ä¸ºä¸¤é˜¶æ®µï¼Œç¬¬ä¸€é˜¶æ®µä¸ºPrepareé˜¶æ®µï¼Œç¬¬äºŒé˜¶æ®µä¸ºCommité˜¶æ®µã€‚ä¸¤é˜¶æ®µæäº¤ç®—æ³•çš„æ€è·¯å¤§è‡´å¯ä»¥æ¦‚æ‹¬ä¸º<strong>å†³ç­–è€…å°†ææ¡ˆçš„ç»“æœé€šçŸ¥ææ¡ˆè€…ï¼Œå†ç”±ææ¡ˆè€…æ ¹æ®æ‰€æœ‰å†³ç­–è€…åé¦ˆçš„ç»“æœå†³å®šæ˜¯æäº¤æ“ä½œè¿˜æ˜¯ç»ˆæ­¢æ“ä½œ</strong>ã€‚</p><p>Paxosç®—æ³•å¤§è‡´æµç¨‹ä¸ºProposerè¯¢é—®Acceptors<strong>æ˜¯å¦å¯ä»¥å‘èµ·ææ¡ˆ</strong>ï¼ŒAcceptorså°†ç»“æœè¿”å›ç»™Proposer(ç¬¬ä¸€é˜¶æ®µ)ï¼Œå†ç”±Proposeræ ¹æ®Acceptorsåé¦ˆçš„<em>ç»“æœå†³å®šææ¡ˆå†…å®¹ä»¥åŠææ¡ˆæ˜¯æäº¤è¿˜æ˜¯ç»ˆæ­¢</em>(ç¬¬äºŒé˜¶æ®µ)ã€‚å…·ä½“æµç¨‹å¦‚ä¸‹ï¼š<br>ç¬¬ä¸€é˜¶æ®µPrepareé˜¶æ®µï¼š</p><ol><li>Proposeræå‡ºä¸€ä¸ªææ¡ˆæ—¶ï¼Œæ¯æ¬¡ææ¡ˆæ—¶éƒ½ç”Ÿæˆä¸€ä¸ªå…¨å±€å”¯ä¸€ä¸”é€’å¢çš„IDï¼Œå‘Acceptorså‘é€<em>PrepareRequest</em>è¯·æ±‚ï¼ŒPrepareRequestè¯·æ±‚<em>åªæºå¸¦ææ¡ˆID</em>ï¼Œè€Œ<em>æ— éœ€æºå¸¦ææ¡ˆå†…å®¹</em>ã€‚</li><li>Acceptorsæ”¶åˆ°Proposerçš„è¯·æ±‚åï¼Œåˆ¤æ–­<code>PrepareRequest</code>ä¸­çš„<strong>IDæ˜¯å¦å¤§äºAcceptorsè®°å½•çš„å€¼</strong>ï¼Œå¦‚æœå¤§äºåˆ™æ£€æŸ¥ä¸‹æ˜¯å¦æœ‰å·²ç»Acceptè¿‡çš„ææ¡ˆï¼Œ<em>æœ‰åˆ™è¿”å›ææ¡ˆä¸­IDæœ€å¤§çš„é‚£ä¸ªææ¡ˆçš„valueå’ŒIDï¼Œæ²¡æœ‰åˆ™è¿”å›ç©ºå€¼</em>ï¼Œå¦‚æœ<strong>å°äºAcceptorsè®°å½•çš„å€¼åˆ™ä¸å“åº”</strong>ã€‚<br>ç¬¬ä¸€é˜¶æ®µç»“æŸï¼Œå¼€å§‹ç¬¬äºŒé˜¶æ®µCommité˜¶æ®µï¼š</li><li>Proposeræ¥æ”¶åˆ°å¤šæ•°Acceptorsçš„<code>PrepareResponse</code>åº”ç­”ä¹‹åï¼Œ<strong>ä»åº”ç­”ä¸­é€‰æ‹©ææ¡ˆIDæœ€å¤§å¯¹åº”çš„valueä½œä¸ºæœ¬æ¬¡è¦å‘èµ·çš„ææ¡ˆ</strong>ã€‚ <em>å¦‚æœæ‰€æœ‰åº”ç­”çš„ææ¡ˆvalueå‡ä¸ºç©ºå€¼ï¼Œåˆ™å¯ä»¥è‡ªå·±éšæ„å†³å®šææ¡ˆvalue</em>ã€‚ç„¶åæºå¸¦å½“å‰IDï¼Œå‘æ‰€æœ‰Acceptorså‘é€<code>AccpetRequest</code>è¯·æ±‚ã€‚</li><li>Accpetorsæ”¶åˆ°<code>AccpetRequest</code>åï¼Œåˆ¤æ–­<code>AccpetRequest</code>ä¸­çš„<strong>IDæ˜¯å¦å¤§äºç­‰äºAcceptorsè®°å½•çš„å€¼</strong>ï¼Œæ˜¯åˆ™æŒä¹…åŒ–å½“å‰IDå’Œææ¡ˆå†…å®¹ï¼Œç„¶åè¿”å›ç»™Proposerå“åº”<code>AcceptResponse</code></li><li>Proposeræ”¶åˆ°å¤šæ•°Acceptorsçš„<code>AcceptResponse</code>åï¼Œå†³è®®å½¢æˆã€‚</li></ol><blockquote><p>æ•´ä¸ªæµç¨‹ä¸­Acceptorsçš„è¡Œä¸ºå¯ä»¥æ¦‚æ‹¬ä¸º<strong>ä¸¤ä¸ªæ‰¿è¯ºï¼Œä¸€ä¸ªåº”ç­”</strong>ã€‚<br>ä¸¤ä¸ªæ‰¿è¯ºï¼š</p></blockquote><ol><li>ä¸å†åº”ç­”PrepareRequestä¸­IDå°äºç­‰äºå½“å‰è¯·æ±‚PrepareRequestä¸­IDçš„è¯·æ±‚(æ˜¯å› ä¸ºå½“å‰PrepareRequestä¸­IDå·²ç»èµ‹å€¼ç»™minProposal)</li><li>ä¸å†åº”ç­”AcceptRequestä¸­IDå°äºå½“å‰è¯·æ±‚AcceptRequestä¸­IDçš„è¯·æ±‚(å› ä¸ºå½“å‰AcceptRequestä¸­IDæ˜¯ä¸Šæ¬¡PrepareRequestè¯·æ±‚ä¸­IDï¼Œæ‰€ä»¥ä¸å†åº”ç­”å°äºçš„ID)<br>ä¸€ä¸ªåº”ç­”ï¼š<br>ä¸è¿èƒŒä¹‹å‰ä½œå‡ºçš„æ‰¿è¯ºä¸‹ï¼Œè¿”å›è‡ªå·±å·²ç»Acceptè¿‡çš„ææ¡ˆä¸­IDæœ€å¤§çš„é‚£ä¸ªææ¡ˆçš„å†…å®¹ï¼Œå¦‚æœæ²¡æœ‰åˆ™è¿”å›ç©ºå€¼</li></ol><p>ç»“åˆä¸‹é¢çš„ä¼ªä»£ç èƒ½å¤Ÿæ›´åŠ æ·±åˆ»ç†è§£è¿™ä¸¤ä¸ªæ‰¿è¯ºä¸€ä¸ªåº”ç­”çš„å«ä¹‰<br><img src="/blogimgs/PBFT-Paxos-Raft/basic-paxos.jpg" alt="basic paxos" title="basic paxos"><br>ç®—æ³•é€»è¾‘ä¸ºï¼š</p><ol><li>è·å–ä¸€ä¸ªProposalID nï¼Œä¸ºäº†ä¿è¯ProposalIDå”¯ä¸€ï¼Œå¯é‡‡ç”¨æ—¶é—´æˆ³+ServerIDç”Ÿæˆï¼›</li><li>Proposerå‘æ‰€æœ‰Acceptorså¹¿æ’­Prepare(n)è¯·æ±‚ï¼›</li><li>Acceptoræ¯”è¾ƒnå’Œ<code>minProposal</code>ï¼Œå¦‚æœ<code>n&gt;minProposal</code>ï¼Œåˆ™<code>minProposal=n</code>ï¼Œå¹¶ä¸”å°†<code>acceptedProposal</code>å’Œ<code>acceptedValue</code>è¿”å›ï¼›</li><li>Proposeræ¥æ”¶åˆ°è¿‡åŠæ•°å›å¤åï¼Œå¦‚æœå‘ç°æœ‰<code>acceptedValue</code>è¿”å›ï¼Œå°†æ‰€æœ‰å›å¤ä¸­<em>acceptedProposalæœ€å¤§çš„acceptedValueä½œä¸ºæœ¬æ¬¡ææ¡ˆçš„value</em>ï¼Œå¦åˆ™å¯ä»¥ä»»æ„å†³å®šæœ¬æ¬¡ææ¡ˆçš„valueï¼›</li><li>åˆ°è¿™é‡Œå¯ä»¥è¿›å…¥ç¬¬äºŒé˜¶æ®µï¼Œå¹¿æ’­<code>Accept(n,value)</code> åˆ°æ‰€æœ‰èŠ‚ç‚¹ï¼›</li><li>Acceptoræ¯”è¾ƒnå’ŒminProposalï¼Œå¦‚æœ<code>n&gt;=minProposal</code>ï¼Œåˆ™<em>acceptedProposal=minProposal=nï¼ŒacceptedValue=valueï¼Œæœ¬åœ°æŒä¹…åŒ–å</em>ï¼Œè¿”å›ï¼›<em>å¦åˆ™ï¼Œè¿”å›minProposal</em>ã€‚</li><li>æè®®è€…æ¥æ”¶åˆ°è¿‡åŠæ•°è¯·æ±‚åï¼Œ<strong>å¦‚æœå‘ç°æœ‰è¿”å›å€¼result&gt;n</strong>ï¼Œè¡¨ç¤ºæœ‰æ›´æ–°çš„æè®®ï¼Œè·³è½¬åˆ°1ï¼›å¦åˆ™valueè¾¾æˆä¸€è‡´ã€‚</li></ol><!--ç¬¬ä¸€é˜¶æ®µï¼šè·å–epochè½®æ¬¡çš„è®¿é—®æƒå’Œå½“å‰varçš„å–å€¼ï¼Œæˆ‘ä»¬å¯ä»¥ç®€å•è·å–å½“å‰æ—¶é—´æˆ³ä¸ºepochï¼šé€šè¿‡Acceptor.prepare(epoch)ï¼Œè·å–epochè½®æ¬¡çš„è®¿é—®æƒå’Œå½“å‰varçš„å–å€¼ï¼›å¦‚æœä¸èƒ½è·å–ï¼Œè¿”å›<error>ã€‚ç¬¬äºŒé˜¶æ®µï¼šé‡‡ç”¨â€œåè€…è®¤åŒå‰è€…â€çš„åŸåˆ™æ‰§è¡Œã€‚å¦‚æœvarå–å€¼ä¸ºnullï¼Œåˆ™è‚¯å®šæ—§epochæ— æ³•ç”Ÿæˆç¡®å®šæ€§å–å€¼ï¼Œåˆ™é€šè¿‡Acceptor.accept(var, prepared_epoch, V)æäº¤æ•°æ®Vã€‚æˆåŠŸåè¿”å›<ok, V>ï¼›è‹¥acceptå¤±è´¥ï¼Œåˆ™è¯´æ˜è¢«æ›´æ–°çš„epochæŠ¢å æˆ–Acceptoræ•…éšœï¼Œè¿”å›<error>ã€‚å¦‚æœvarå–å€¼å­˜åœ¨ï¼Œåˆ™æ­¤å–å€¼è‚¯å®šæ˜¯ç¡®å®šæ€§å–å€¼ï¼Œæ­¤æ—¶è®¤åŒå®ƒä¸å†æ›´æ”¹ï¼Œç›´æ¥è¿”å›<ok, accepted_value>ã€‚--><!--ææ¡ˆç¼–å·æ€ä¹ˆå–å€¼ï¼Œé˜²æ­¢æ¶æ„å–å€¼JNæ˜¯å¦‚ä½•å†™ï¼Œå¦‚ä½•åŒæ­¥æ•°æ®çš„â€œæ´»é”â€çš„æ ¹æœ¬åŸå› åœ¨äºä¸¤ä¸ªproposeräº¤æ›¿ææ¡ˆï¼Œé¿å…â€œæ´»é”â€çš„æ–¹å¼ä¸ºï¼Œå¦‚æœä¸€ä¸ªproposeré€šè¿‡accpterè¿”å›çš„æ¶ˆæ¯çŸ¥é“æ­¤æ—¶æœ‰æ›´é«˜ç¼–å·çš„ææ¡ˆè¢«æå‡ºæ—¶ï¼Œè¯¥proposeré™é»˜ä¸€æ®µæ—¶é—´ï¼Œè€Œä¸æ˜¯é©¬ä¸Šæå‡ºæ›´é«˜çš„æ–¹æ¡ˆï¼Œé™é»˜æœŸé•¿çŸ­ä¸ºä¸€ä¸ªææ¡ˆä»æå‡ºåˆ°è¢«æ¥å—çš„å¤§æ¦‚æ—¶é—´é•¿åº¦å³å¯ï¼Œé™é»˜æœŸè¿‡åï¼Œproposeré‡æ–°ææ¡ˆã€‚ç³»ç»Ÿä¸­ä¹‹æ‰€ä»¥è¦æœ‰ä¸»proposerçš„åŸå› åœ¨äºï¼Œå¦‚æœæ¯æ¬¡æ•°æ®æ›´æ”¹éƒ½ç”¨paxosï¼Œé‚£å®åœ¨æ˜¯å¤ªæ…¢äº†ï¼Œè¿˜æ˜¯é€šè¿‡ä¸»èŠ‚ç‚¹ä¸‹å‘è¯·æ±‚è¿™æ ·æ¥çš„å¿«ï¼Œå› ä¸ºçœå»äº†ä¸å¿…è¦çš„paxosæ—¶é—´ã€‚æ‰€ä»¥é€‰æ‹©ä¸»proposerç”¨paxosç®—æ³•ï¼Œå› ä¸ºé€‰ä¸»çš„é¢‘ç‡è¦æ¯”æ›´æ”¹æ•°æ®é¢‘ç‡ä½å¤ªå¤šã€‚ä½†æ˜¯ä¸»proposeræŒ‚äº†å’‹æ•´ï¼Œæ•´ä¸ªé›†ç¾¤å°±ä¸€ç›´å¤„äºä¸å¯ç”¨çŠ¶æ€ï¼Œæ‰€ä»¥ä¸€èˆ¬éƒ½ç”¨ç§Ÿçº¦çš„æ–¹å¼ï¼Œå¦‚æœproposeræŒ‚äº†ï¼Œåˆ™ç§Ÿçº¦ä¼šè¿‡æœŸï¼Œå…¶å®ƒproposerå°±å¯ä»¥å†é‡æ–°é€‰ä¸»ï¼Œå¦‚æœä¸æŒ‚ï¼Œåˆ™ä¸»proposerè‡ªå·±ç»­ç§Ÿã€‚--><p>åŸå§‹çš„Paxosç®—æ³•(Basic Paxos)<em>åªèƒ½å¯¹ä¸€ä¸ªå€¼å½¢æˆå†³è®®</em>ï¼Œå†³è®®çš„å½¢æˆè‡³å°‘éœ€è¦ä¸¤æ¬¡ç½‘ç»œæ¥å›ï¼Œ*åœ¨é«˜å¹¶å‘æƒ…å†µä¸‹å¯èƒ½éœ€è¦æ›´å¤šçš„ç½‘ç»œæ¥å›ï¼Œæç«¯æƒ…å†µä¸‹ç”šè‡³å¯èƒ½å½¢æˆæ´»é”(æ´»é”â€“å¤šä¸ªProposeräº¤æ›¿å‘Acceptorsæäº¤PrepareRequestè¯·æ±‚ï¼Œåœ¨å‘é€AccpetRequestè¯·æ±‚æ—¶ï¼Œéƒ½å› ä¸ºIDå‘ç”Ÿæ›´æ–°ï¼ŒAcceptorsæ— æ³•æ¥å—AccpetRequestè¯·æ±‚ï¼Œè¿”å›IDï¼Œæ˜¯Proposerå†æ¬¡å‘Acceptorså‘é€PrepareRequestè¯·æ±‚ï¼Œå¦‚æ­¤åå¤ï¼Œæ— æ³•å½¢æˆå…±è¯†ã€‚)*ã€‚æ›´é‡è¦çš„æ˜¯å¦‚æœæƒ³è¿ç»­ç¡®å®šå¤šä¸ªå€¼<!--è¿™é‡Œä¸æ˜¯å¤ªæ‡‚ï¼Œæ ‡è®°ä¸‹ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ-->ï¼ŒBasic Paxosæ— æ³•ç¡®å®šäº†ã€‚å› æ­¤Basic Paxoså‡ ä¹åªæ˜¯ç”¨æ¥åšç†è®ºç ”ç©¶ï¼Œå¹¶ä¸ç›´æ¥åº”ç”¨åœ¨å®é™…å·¥ç¨‹ä¸­ã€‚</p><p>å®é™…åº”ç”¨ä¸­å‡ ä¹éƒ½éœ€è¦è¿ç»­ç¡®å®šå¤šä¸ªå€¼ï¼Œè€Œä¸”å¸Œæœ›èƒ½æœ‰æ›´é«˜çš„æ•ˆç‡ã€‚<code>Multi-Paxos</code>æ­£æ˜¯ä¸ºè§£å†³æ­¤é—®é¢˜è€Œæå‡ºã€‚Multi-PaxosåŸºäºBasic Paxosåšäº†ä¸¤ç‚¹æ”¹è¿›ï¼š</p><ol><li>é’ˆå¯¹æ¯ä¸€ä¸ªè¦ç¡®å®šçš„å€¼ï¼Œè¿è¡Œä¸€æ¬¡Paxosç®—æ³•å®ä¾‹ï¼ˆInstanceï¼‰ï¼Œå½¢æˆå†³è®®ã€‚æ¯ä¸€ä¸ªPaxoså®ä¾‹ä½¿ç”¨å”¯ä¸€çš„Instance IDæ ‡è¯†ã€‚</li><li>åœ¨æ‰€æœ‰Proposersä¸­é€‰ä¸¾ä¸€ä¸ªLeaderï¼Œç”±Leaderå”¯ä¸€çš„æäº¤ææ¡ˆç»™Acceptorsè¿›è¡Œè¡¨å†³ã€‚<em>ä»…æœ‰ä¸€ä¸ªLeaderè¿›è¡Œvalueæäº¤çš„æƒ…å†µä¸‹ï¼ŒPrepareé˜¶æ®µå°±å¯ä»¥è·³è¿‡ï¼Œä»è€Œå°†ä¸¤é˜¶æ®µå˜ä¸ºä¸€é˜¶æ®µï¼Œæé«˜æ•ˆç‡ã€‚</em>åŒæ—¶è¿™æ ·æ²¡æœ‰Proposerç«äº‰ï¼Œ<em>ä¹Ÿè§£å†³äº†æ´»é”é—®é¢˜</em>ã€‚</li></ol><!--Multi-Paxosé¦–å…ˆéœ€è¦é€‰ä¸¾Leaderï¼ŒLeaderçš„ç¡®å®šä¹Ÿæ˜¯ä¸€æ¬¡å†³è®®çš„å½¢æˆï¼Œæ‰€ä»¥å¯æ‰§è¡Œä¸€æ¬¡Basic Paxoså®ä¾‹æ¥é€‰ä¸¾å‡ºä¸€ä¸ªLeaderã€‚é€‰å‡ºLeaderä¹‹ååªèƒ½ç”±Leaderæäº¤Proposalï¼Œåœ¨Leaderå®•æœºä¹‹åæœåŠ¡ä¸´æ—¶ä¸å¯ç”¨ï¼Œéœ€è¦é‡æ–°é€‰ä¸¾Leaderç»§ç»­æœåŠ¡ã€‚åœ¨ç³»ç»Ÿä¸­ä»…æœ‰ä¸€ä¸ªLeaderè¿›è¡ŒProposalæäº¤çš„æƒ…å†µä¸‹ï¼ŒPrepareé˜¶æ®µå¯ä»¥è·³è¿‡ã€‚Multi-Paxosé€šè¿‡æ”¹å˜Prepareé˜¶æ®µçš„ä½œç”¨èŒƒå›´è‡³åé¢Leaderæäº¤çš„æ‰€æœ‰å®ä¾‹ï¼Œä»è€Œä½¿å¾—Leaderçš„è¿ç»­æäº¤åªéœ€è¦æ‰§è¡Œä¸€æ¬¡Prepareé˜¶æ®µï¼Œåç»­åªéœ€è¦æ‰§è¡ŒAccepté˜¶æ®µï¼Œå°†ä¸¤é˜¶æ®µå˜ä¸ºä¸€é˜¶æ®µï¼Œæé«˜äº†æ•ˆç‡ã€‚ä¸ºäº†åŒºåˆ†è¿ç»­æäº¤çš„å¤šä¸ªå®ä¾‹ï¼Œæ¯ä¸ªå®ä¾‹ä½¿ç”¨ä¸€ä¸ªInstance IDæ ‡è¯†ï¼ŒInstance IDç”±Leaderæœ¬åœ°é€’å¢ç”Ÿæˆå³å¯ã€‚Multi-Paxoså…è®¸æœ‰å¤šä¸ªè‡ªè®¤ä¸ºæ˜¯Leaderçš„èŠ‚ç‚¹å¹¶å‘æäº¤Proposalè€Œä¸å½±å“å…¶å®‰å…¨æ€§ï¼Œè¿™æ ·çš„åœºæ™¯å³é€€åŒ–ä¸ºBasic Paxosã€‚--><p>Paxosç¡®å®å¾ˆå¼ºå¤§ï¼Œè€Œä¸”ä¹Ÿå¯ä»¥åº”ç”¨äºå®é™…å·¥ç¨‹ä¸­ï¼Œä½†æ˜¯å…¶ç†è®ºçœŸçš„å¾ˆéš¾ç†è§£ï¼Œäºæ˜¯<em>Raftç®—æ³•</em>å‡ºç°äº†ï¼Œä»¥ç®€å•è‘—ç§°ï¼Œå¹¶åœ¨å·¥ä¸šä¸Šä¹Ÿå¾—åˆ°äº†å¹¿æ³›çš„ä½¿ç”¨ã€‚</p><h2 id="Raft"><a href="#Raft" class="headerlink" title="Raft"></a>Raft</h2><p>Raftä¹Ÿæ˜¯ä¸¤é˜¶æ®µæäº¤ç®—æ³•ï¼Œç±»ä¼¼äºMulti-Paxosã€‚ç®—æ³•ä¸­çš„è§’è‰²åˆ†ä¸ºLeaderã€Followerå’ŒCandidateï¼Œä½†æ˜¯<em>è¿™ä¸‰ç§è§’è‰²å¹¶ä¸æ˜¯åŒæ—¶å‡ºç°çš„ï¼Œæ­£å¸¸è¿è¡Œæ—¶åªæœ‰Leaderå’ŒFollower</em>ï¼Œcandidateåªä½œä¸ºé€‰ä¸¾leaderæ—¶çš„ä¸€ä¸ªä¸´æ—¶è§’è‰²å‡ºç°ã€‚</p><ul><li>Leader: æ¥å—å®¢æˆ·ç«¯è¯·æ±‚ï¼Œå¹¶å‘FolloweråŒæ­¥è¯·æ±‚æ—¥å¿—ï¼Œå½“æ—¥å¿—åŒæ­¥åˆ°å¤§å¤šæ•°èŠ‚ç‚¹ä¸Šåå‘Šè¯‰Followeræäº¤æ—¥å¿—ã€‚</li><li>Follower: æ¥å—å¹¶æŒä¹…åŒ–LeaderåŒæ­¥çš„æ—¥å¿—ï¼Œåœ¨Leaderå‘Šä¹‹æ—¥å¿—å¯ä»¥æäº¤ä¹‹åï¼Œæäº¤æ—¥å¿—ã€‚</li><li>Candidate: Leaderé€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶è§’è‰²ã€‚</li></ul><blockquote><p>ç³»ç»Ÿåœ¨åˆå§‹åŒ–æ—¶ï¼ŒåŒä¸ºFollowerï¼Œåœ¨election timeoutä¹‹å(å„èŠ‚ç‚¹åœ¨150-300msä¹‹é—´éšæœº)ï¼Œç”±Followerè½¬åŒ–ä¸ºCandidateè¿›è¡Œé€‰ä¸¾Leader</p></blockquote><!-- heartbeat timeout ä¹‹åFolloweræ„ŸçŸ¥åˆ°Leaderæ¶ˆå¤±ï¼Œè¿›è¡Œæ–°Leaderé€‰ä¸¾--><p>Raftç®—æ³•ä¸»è¦ç”¨äºç®¡ç†å¤šå‰¯æœ¬çŠ¶æ€æœºçš„æ—¥å¿—å¤åˆ¶ï¼Œå¹¶ä¸”å…¶<em>å°†ä¸€è‡´æ€§åˆ†è§£ä¸ºå¤šä¸ªå­é—®é¢˜</em>ï¼šLeaderé€‰ä¸¾(Leader election)ã€æ—¥å¿—åŒæ­¥(Log replication)ã€å®‰å…¨æ€§(Safety)ã€æ—¥å¿—å‹ç¼©(Log compaction)ã€æˆå‘˜å˜æ›´(Membership change)ç­‰ã€‚åŒæ—¶ï¼Œ<em>Raftç®—æ³•ä½¿ç”¨äº†æ›´å¼ºçš„å‡è®¾æ¥å‡å°‘äº†éœ€è¦è€ƒè™‘çš„çŠ¶æ€ï¼Œä½¿ä¹‹å˜çš„æ˜“äºç†è§£å’Œå®ç°</em>ã€‚Raftç®—æ³•æ”¯æŒæœ€å¤§çš„å®¹é”™æ•…éšœèŠ‚ç‚¹æ˜¯Fï¼Œé›†ç¾¤æ€»æ•°ä¸º2F+1ã€‚</p><p>ä¸ªäººæ„Ÿè§‰Raftç®—æ³•å­¦ä¹ çš„æœ€å¥½æ•™ç¨‹æ˜¯<a href="http://thesecretlivesofdata.com/raft/#home">http://thesecretlivesofdata.com/raft/#home</a>ï¼Œä¿—è¯è¯´ä¸€å›¾èƒœåƒè¨€ï¼Œæ›´ä½•å†µæ˜¯è¿˜æ˜¯ä¸ªåŠ¨å›¾ï¼Œè€ç‰›é€¼äº†ï¼Œä¿ç®¡ä½ çœ‹ä¸€éå°±æ‡‚äº†ã€‚ã€‚ã€‚è¿™é‡Œå°±ä¸å†è¿›è¡Œè¿‡å¤šçš„ä»‹ç»äº†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://zhuanlan.zhihu.com/p/31780743">https://zhuanlan.zhihu.com/p/31780743</a><br><a href="https://my.oschina.net/ittrueman/blog/1612492">https://my.oschina.net/ittrueman/blog/1612492</a><br><a href="http://thesecretlivesofdata.com/raft/#home">http://thesecretlivesofdata.com/raft/#home</a><br><a href="https://zhuanlan.zhihu.com/p/32052223">https://zhuanlan.zhihu.com/p/32052223</a></p>]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Kafka </tag>
            
            <tag> Zookeeper </tag>
            
            <tag> Paxos </tag>
            
            <tag> Raft </tag>
            
            <tag> BFT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cryptozombiesæºç è§£æäºŒ</title>
      <link href="/cryptozombies-src-parse-2.html"/>
      <url>/cryptozombies-src-parse-2.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/cryptozombies-src-parse.html">cryptozombiesæºç è§£æä¸€</a>ä¸­å¯¹ä»¥å¤ªåŠå¼€å‘ä¸­çš„<em>äº‹ä»¶</em>ä¸<em>åˆçº¦äº¤äº’</em>è¿›è¡Œäº†ä»‹ç»ï¼Œçœ‹è¿‡è¿™ç¯‡æ–‡ç« çš„åŒå­¦æˆ‘ç›¸ä¿¡å¯¹Dappå¼€å‘ä¹Ÿæœ‰äº†ä¸€ä¸ªåˆæ­¥çš„äº†è§£ï¼Œä¸‹é¢æˆ‘ä»¬ç»§ç»­å­¦ä¹ ä¸€äº›æ™ºèƒ½åˆçº¦å¼€å‘ä¸­ç‰¹æ€§ã€‚</p><span id="more"></span><h2 id="å¦‚ä½•å‡å°‘gas"><a href="#å¦‚ä½•å‡å°‘gas" class="headerlink" title="å¦‚ä½•å‡å°‘gas"></a>å¦‚ä½•å‡å°‘gas</h2><p>gasæ˜¯EVMä¸­ä»£ç æ‰§è¡Œæ‰€æ¶ˆè€—èµ„æºçš„è®¡é‡å•ä½ï¼Œgasæ˜¯éœ€è¦ç”¨ä»¥å¤ªå¸è´­ä¹°çš„ï¼Œç°åœ¨ä½ æ˜¯ä¸æ˜¯å·²ç»getåˆ°äº†ä¸ºä»€ä¹ˆè¦å‡å°‘gasäº†ï¼Œå˜¿å˜¿ã€‚ã€‚ã€‚</p><h3 id="ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„"><a href="#ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„" class="headerlink" title="ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„"></a>ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„</h3><p>è¿™é‡Œä»¥uintä¸ºä¾‹ï¼Œåœ¨Solidityä¸­é™¤äº†æœ‰åŸºæœ¬ç‰ˆçš„uintå¤–ï¼Œè¿˜æœ‰å…¶ä»–å˜ç§uintï¼šuint8ï¼Œuint16ï¼Œuint32ç­‰ã€‚é€šå¸¸æƒ…å†µä¸‹æˆ‘ä»¬ä¸ä¼šè€ƒè™‘ä½¿ç”¨uintå˜ç§ï¼Œ<em>å› ä¸ºæ— è®ºå¦‚ä½•å®šä¹‰ uintçš„å¤§å°ï¼ŒSolidityä¸ºå®ƒä¿ç•™256ä½çš„å­˜å‚¨ç©ºé—´</em>ã€‚ä¾‹å¦‚ï¼Œä½¿ç”¨uint8è€Œä¸ä½¿ç”¨uint(uint256)ï¼Œå¹¶ä¸ä¼šä¸ºä½ èŠ‚çœä»»ä½•gasï¼Œå› ä¸ºSolidityå§‹ç»ˆä¿ç•™äº†256çš„ç©ºé—´ã€‚</p><p>é‚£ä¹ˆä¸ºä»€ä¹ˆè¿˜è¦æœ‰å…¶ä»–uintçš„å˜ç§å‘¢ï¼Ÿ<strong>æ˜¯å› ä¸ºåœ¨structé‡Œï¼Œå¯ä»¥é€šè¿‡å£°æ˜å…·ä½“çš„uintå˜ç§æ¥èŠ‚çœå­˜å‚¨ç©ºé—´</strong>ã€‚<br>åœ¨structé‡Œï¼Œç›¸åŒç±»å‹çš„uintè¦ç´§é‚»ï¼Œä¾‹å¦‚uint8çš„å˜é‡è¦æ”¾åœ¨ä¸€èµ·ï¼Œuint16çš„è¦æ”¾åœ¨ä¸€èµ·ï¼Œè¿™æ ·å¯ä»¥å°†è¿™äº›uintæ‰“åŒ…åœ¨ä¸€èµ·ï¼Œä»è€Œå ç”¨è¾ƒå°‘çš„å­˜å‚¨ç©ºé—´ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">struct Zombie &#123;</span><br><span class="line">  string name;</span><br><span class="line">  uint dna;</span><br><span class="line">  uint32 level;</span><br><span class="line">  uint32 readyTime;</span><br><span class="line">  uint16 winCount;</span><br><span class="line">  uint16 lossCount;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ³¨æ„viewå’Œpureçš„ä½¿ç”¨åœºæ™¯"><a href="#æ³¨æ„viewå’Œpureçš„ä½¿ç”¨åœºæ™¯" class="headerlink" title="æ³¨æ„viewå’Œpureçš„ä½¿ç”¨åœºæ™¯"></a>æ³¨æ„viewå’Œpureçš„ä½¿ç”¨åœºæ™¯</h3><p>ä¹‹æ‰€ä»¥è¦æ³¨æ„viewå’Œpureçš„ä½¿ç”¨åœºæ™¯ï¼Œæ˜¯<strong>å› ä¸ºä»åˆçº¦å¤–éƒ¨è°ƒç”¨è¿™ä¸¤ä¸ªä¿®é¥°ç¬¦ä¿®é¥°çš„å‡½æ•°çš„æ—¶å€™ä¸èŠ±è´¹ä»»ä½•gas</strong>ï¼Œæ³¨æ„è¿™é‡Œè¯´çš„æ˜¯åœ¨åˆçº¦å¤–éƒ¨è°ƒç”¨ï¼Œ<strong>å®ƒä»¬åœ¨è¢«å†…éƒ¨å…¶ä»–å‡½æ•°è°ƒç”¨çš„æ—¶å€™å°†ä¼šè€—è´¹gas</strong><!--ï¼Œå› ä¸ºä¸€ä¸ªviewå‡½æ•°åœ¨å¦ä¸€ä¸ªå‡½æ•°çš„å†…éƒ¨è¢«è°ƒç”¨ï¼Œè€Œè°ƒç”¨å‡½æ•°ä¸viewå‡½æ•°çš„ä¸å±äºåŒä¸€ä¸ªåˆçº¦ï¼Œä¹Ÿä¼šäº§ç”Ÿè°ƒç”¨æˆæœ¬ã€‚è¿™æ˜¯å› ä¸ºå¦‚æœä¸»è°ƒå‡½æ•°åœ¨ä»¥å¤ªåŠåˆ›å»ºäº†ä¸€ä¸ªäº‹åŠ¡ï¼Œå®ƒä»ç„¶éœ€è¦é€ä¸ªèŠ‚ç‚¹å»éªŒè¯ã€‚æ‰€ä»¥æ ‡è®°ä¸ºviewçš„å‡½æ•°åªæœ‰åœ¨å¤–éƒ¨è°ƒç”¨æ—¶æ‰æ˜¯å…è´¹çš„-->ã€‚</p><p>ä¸‹é¢è§£é‡Šä¸‹ä¸ºä»€ä¹ˆviewå’Œpureä»åˆçº¦å¤–éƒ¨è°ƒç”¨ä¸éœ€è¦èŠ±è´¹gasã€‚<br>æ˜¯å› ä¸º<em>viewä¿®é¥°ç¬¦çš„æ„æ€æ˜¯ä¸ä¼šæ”¹å˜åŒºå—é“¾ä¸Šçš„ä»»ä½•æ•°æ®ï¼Œåªæ˜¯ä»åŒºå—é“¾ä¸Šè¯»å–æ•°æ®</em>ã€‚æ ‡è®°ä¸ºviewçš„å‡½æ•°ï¼Œæ„å‘³ç€å‘Šè¯‰web3.jsï¼Œè¿è¡Œè¿™ä¸ªå‡½æ•°åªéœ€è¦æŸ¥è¯¢ä½ çš„æœ¬åœ°ä»¥å¤ªåŠèŠ‚ç‚¹ï¼Œè€Œä¸éœ€è¦åœ¨åŒºå—é“¾ä¸Šåˆ›å»ºä¸€ä¸ªäº‹åŠ¡(äº‹åŠ¡éœ€è¦è¿è¡Œåœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šï¼Œå› æ­¤èŠ±è´¹gas)ã€‚<br>æ‰€ä»¥åœ¨æ‰€æœ‰èƒ½åªè¯»çš„å‡½æ•°ä¸Šæ ‡è®°ä¸Šè¡¨ç¤º<code>åªè¯»</code>çš„<code>external view</code>å£°æ˜ï¼Œå°±èƒ½ä¸ºä½ çš„ç©å®¶å‡å°‘åœ¨DAppä¸­gasç”¨é‡ã€‚</p><p>pureä¸viewç±»ä¼¼ï¼Œ<em>pureä¿®é¥°ç¬¦çš„æ„æ€æ˜¯ä¸ä½†ä¸ä¼šå¾€åŒºå—é“¾å†™æ•°æ®ï¼Œå®ƒç”šè‡³ä¸ä»åŒºå—é“¾è¯»å–æ•°æ®</em>ï¼Œæ‰€ä»¥pureä¹Ÿä¸ä¼šæ¶ˆè€—gasã€‚</p><h3 id="å°½å¯èƒ½çš„è§„é¿æ˜‚è´µçš„æ“ä½œ"><a href="#å°½å¯èƒ½çš„è§„é¿æ˜‚è´µçš„æ“ä½œ" class="headerlink" title="å°½å¯èƒ½çš„è§„é¿æ˜‚è´µçš„æ“ä½œ"></a>å°½å¯èƒ½çš„è§„é¿æ˜‚è´µçš„æ“ä½œ</h3><p><strong>Solidityä¸­ä½¿ç”¨storage(å­˜å‚¨)æ˜¯ç›¸å½“æ˜‚è´µçš„ï¼Œâ€å†™å…¥â€æ“ä½œå°¤å…¶è´µ</strong>ã€‚è¿™æ˜¯å› ä¸ºï¼Œæ— è®ºæ˜¯å†™å…¥è¿˜æ˜¯æ›´æ”¹ä¸€æ®µæ•°æ®ï¼Œè¿™éƒ½å°†æ°¸ä¹…æ€§åœ°å†™å…¥åŒºå—é“¾ã€‚â€æ°¸ä¹…æ€§â€å•Šï¼éœ€è¦åœ¨å…¨çƒæ•°åƒä¸ªèŠ‚ç‚¹çš„ç¡¬ç›˜ä¸Šå­˜å…¥è¿™äº›æ•°æ®ï¼Œéšç€åŒºå—é“¾çš„å¢é•¿ï¼Œæ‹·è´ä»½æ•°æ›´å¤šï¼Œå­˜å‚¨é‡ä¹Ÿå°±è¶Šå¤§ã€‚è¿™æ˜¯éœ€è¦æˆæœ¬çš„ï¼</p><p>æ‰€ä»¥åœ¨å¼€å‘ä¸­ï¼Œä¸ºäº†é™ä½æˆæœ¬ï¼Œä¸åˆ°ä¸‡ä¸å¾—å·²ï¼Œé¿å…å°†æ•°æ®å†™å…¥å­˜å‚¨ã€‚è™½ç„¶è¿™æ ·åšä¼šå¯¼è‡´æ•ˆç‡ä½ä¸‹ï¼Œä½†æ˜¯åœ¨æœ‰äº›åœºæ™¯ä¸‹è¿˜æ˜¯å¯å–çš„ã€‚</p><p>ä»£ç ä¸­æœ‰ä¸€ä¸ª<code>getZombiesByOwner</code>çš„å‡½æ•°ï¼ŒåŠŸèƒ½æ˜¯å¾—åˆ°æŸä¸ªç”¨æˆ·çš„åƒµå°¸å†›å›¢ï¼Œå¸¸è§„é€»è¾‘æ˜¯åœ¨<code>ZombieFactory</code>ä¸­å­˜å…¥<em>owner</em>ä¸<em>zombies</em>çš„æ˜ å°„<code>mapping (address =&gt; uint[]) public ownerToZombies</code>ï¼Œç„¶åæˆ‘ä»¬æ¯æ¬¡åˆ›å»ºæ–°åƒµå°¸æ—¶ï¼Œæ‰§è¡Œ<code>ownerToZombies[owner].push(zombieId)</code>å°†å…¶æ·»åŠ åˆ°ä¸»äººçš„åƒµå°¸æ•°ç»„ä¸­ã€‚è€Œ <code>getZombiesByOwner</code>å‡½æ•°ä¹Ÿéå¸¸ç®€å•ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getZombiesByOwner</span>(<span class="params">address _owner</span>) <span class="title">external</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint[]</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ownerToZombies[_owner];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯æ˜¯å¦‚æœæˆ‘ä»¬éœ€è¦ä¸€ä¸ªå‡½æ•°æ¥æŠŠä¸€å¤´åƒµå°¸è½¬ç§»åˆ°å¦ä¸€ä¸ªä¸»äººåä¸‹ï¼Œåˆä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ<br>è¿™ä¸ªâ€æ¢ä¸»â€å‡½æ•°è¦åšåˆ°ï¼š</p><ol><li>å°†åƒµå°¸pushåˆ°æ–°ä¸»äººçš„<code>ownerToZombies</code>æ˜ å°„ä¸­çš„æ•°ç»„ï¼Œ </li><li>ä»æ—§ä¸»çš„<code>ownerToZombies</code>æ•°ç»„ä¸­ç§»é™¤åƒµå°¸ï¼Œ </li><li>å°†æ—§ä¸»åƒµå°¸æ•°ç»„ä¸­â€æ¢ä¸»åƒµå°¸â€ä¹‹åçš„çš„æ¯å¤´åƒµå°¸éƒ½å¾€å‰æŒªä¸€ä½ï¼ŒæŠŠæŒªèµ°â€æ¢ä¸»åƒµå°¸â€åç•™ä¸‹çš„â€ç©ºæ§½â€å¡«ä¸Šï¼Œ </li><li>å°†æ•°ç»„é•¿åº¦å‡1ã€‚<br>ä½†æ˜¯<em>ç¬¬ä¸‰æ­¥å®åœ¨æ˜¯å¤ªè´µäº†</em>ï¼<em>å› ä¸ºæ¯æŒªåŠ¨ä¸€å¤´åƒµå°¸ï¼Œæˆ‘ä»¬éƒ½è¦æ‰§è¡Œä¸€æ¬¡å†™æ“ä½œ</em>ã€‚å¦‚æœä¸€ä¸ªä¸»äººæœ‰20å¤´åƒµå°¸ï¼Œè€Œç¬¬ä¸€å¤´è¢«æŒªèµ°äº†ï¼Œé‚£ä¸ºäº†ä¿æŒæ•°ç»„çš„é¡ºåºï¼Œæˆ‘ä»¬å¾—åš19ä¸ªå†™æ“ä½œã€‚<br>ç”±äº<em>å†™å…¥å­˜å‚¨æ˜¯Solidityä¸­æœ€è´¹gasçš„æ“ä½œä¹‹ä¸€</em>ï¼Œä½¿å¾—æ¢ä¸»å‡½æ•°çš„æ¯æ¬¡è°ƒç”¨éƒ½éå¸¸æ˜‚è´µã€‚æ›´ç³Ÿç³•çš„æ˜¯ï¼Œæ¯æ¬¡è°ƒç”¨çš„æ—¶å€™èŠ±è´¹çš„gaséƒ½ä¸åŒï¼å…·ä½“è¿˜å–å†³äºç”¨æˆ·åœ¨åŸä¸»å†›å›¢ä¸­çš„åƒµå°¸å¤´æ•°ï¼Œä»¥åŠç§»èµ°çš„åƒµå°¸æ‰€åœ¨çš„ä½ç½®ã€‚ä»¥è‡³äºç”¨æˆ·éƒ½ä¸çŸ¥é“åº”è¯¥æ”¯ä»˜å¤šå°‘gasã€‚</li></ol><blockquote><p>æ³¨æ„ï¼šå½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥æŠŠæ•°ç»„ä¸­æœ€åä¸€ä¸ªåƒµå°¸å¾€å‰æŒªæ¥å¡«è¡¥ç©ºæ§½ï¼Œå¹¶å°†æ•°ç»„é•¿åº¦å‡å°‘ä¸€ã€‚ä½†è¿™æ ·æ¯åšä¸€ç¬”äº¤æ˜“ï¼Œéƒ½ä¼šæ”¹å˜åƒµå°¸å†›å›¢çš„ç§©åºã€‚</p></blockquote><p>æ­¤æ—¶æˆ‘ä»¬å°±åº”è¯¥é¿å…è¿™ç§é«˜æ˜‚çš„æ“ä½œï¼Œä½¿ç”¨å¦ä¸€ç§æ–¹æ¡ˆæ¥è§£å†³ã€‚ä¸Šé¢æåˆ°viewä¿®é¥°çš„å‡½æ•°ä»å¤–éƒ¨è°ƒç”¨æ˜¯å…è´¹çš„ï¼Œè€Œä¸”æˆ‘ä»¬ä¹Ÿåªæ˜¯ä»åŒºå—é“¾ä¸­è¯»å–æ•°æ®ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥åœ¨<code>getZombiesByOwner</code>å‡½æ•°ä¸­ä¸€ä¸ªforå¾ªç¯éå†æ•´ä¸ªåƒµå°¸æ•°ç»„<code>zombies</code>ï¼ŒæŠŠå±äºæŸä¸ªä¸»äººçš„åƒµå°¸æŒ‘å‡ºæ¥æ„å»ºå‡ºåƒµå°¸æ•°ç»„ã€‚é‚£ä¹ˆæˆ‘ä»¬çš„transferå‡½æ•°å°†ä¼šä¾¿å®œå¾—å¤šï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦æŒªåŠ¨å­˜å‚¨é‡Œçš„åƒµå°¸æ•°ç»„é‡æ–°æ’åºï¼Œæ€»ä½“ä¸Šè¿™ä¸ªæ–¹æ³•ä¼šæ›´ä¾¿å®œï¼Œå°±æ˜¯æœ‰ç‚¹åå¸¸ã€‚</p><blockquote><p>åœ¨å¤§å¤šæ•°ç¼–ç¨‹è¯­è¨€ä¸­ï¼Œéå†å¤§æ•°æ®é›†åˆéƒ½æ˜¯æ˜‚è´µçš„ã€‚ä½†æ˜¯åœ¨Solidityä¸­ï¼Œä½¿ç”¨ä¸€ä¸ªæ ‡è®°äº†<code>external view</code>çš„å‡½æ•°ï¼Œéå†æ¯”storageè¦ä¾¿å®œå¤ªå¤šï¼Œå› ä¸ºviewå‡½æ•°ä¸ä¼šäº§ç”Ÿä»»ä½•èŠ±é”€ã€‚ ï¼ˆgaså¯æ˜¯çœŸé‡‘ç™½é“¶å•Šï¼ï¼‰ã€‚</p></blockquote><p>æœ€å<code>getZombiesByOwner</code>çš„å®ç°ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">function getZombiesByOwner(address _owner) external view returns(uint[]) &#123;</span><br><span class="line">  uint[] memory result = new uint[](ownerZombieCount[_owner]);</span><br><span class="line">  uint counter = 0;</span><br><span class="line">  for (uint i = 0; i &lt; zombies.length; i++) &#123;</span><br><span class="line">    if (zombieToOwner[i] == _owner) &#123;</span><br><span class="line">      result[counter] = i;</span><br><span class="line">      counter++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="éšæœºæ•°"><a href="#éšæœºæ•°" class="headerlink" title="éšæœºæ•°"></a>éšæœºæ•°</h2><p>ç›¸ä¿¡å¤§å®¶åœ¨æ—¥å¸¸å¼€å‘ä¸­å…ä¸äº†ç”¨éšæœºæ•°ï¼Œä½†æ˜¯åœ¨åŒºå—é“¾ä¸­å¦‚ä½•ä½¿ç”¨éšæœºæ•°å‘¢ï¼ŸåŒºå—é“¾ä¸­çš„éšæœºæ•°ä¸ä¼ ç»Ÿç¨‹åºä¸­çš„éšæœºæ•°ä¸ä¸€æ ·æ˜¯å› ä¸ºï¼ŒåŒºå—é“¾æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼æ‰§è¡Œç¯å¢ƒï¼Œå¹¶ä¸”ä¸ºäº†ä¸å¯ç¯¡æ”¹æ€§ï¼Œéœ€è¦nå°æœºå™¨åœ¨åŒä¸€æ—¶åˆ»çš„æ‰§è¡Œç»“æœæ˜¯ä¸€æ ·çš„ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨åŒä¸€æ—¶åˆ»éšæœºæ•°æ˜¯ä¸€æ ·çš„ã€‚</p><p>Solidityä¸­æœ€å¥½çš„éšæœºæ•°ç”Ÿæˆå™¨æ˜¯<code>keccak256</code>å“ˆå¸Œå‡½æ•°ã€‚<br>æˆ‘ä»¬å¯ä»¥è¿™æ ·æ¥ç”Ÿæˆä¸€äº›éšæœºæ•°ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ç”Ÿæˆä¸€ä¸ª0åˆ°100çš„éšæœºæ•°:</span></span><br><span class="line">uint randNonce = <span class="number">0</span>;</span><br><span class="line">uint random = uint(keccak256(now, msg.sender, randNonce)) % <span class="number">100</span>;</span><br><span class="line">randNonce++;</span><br><span class="line">uint random2 = uint(keccak256(now, msg.sender, randNonce)) % <span class="number">100</span>;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ–¹æ³•é¦–å…ˆæ‹¿åˆ°nowçš„æ—¶é—´æˆ³ã€msg.senderã€ä»¥åŠä¸€ä¸ªè‡ªå¢æ•°nonce(ä¸€ä¸ªä»…ä¼šè¢«ä½¿ç”¨ä¸€æ¬¡çš„æ•°ï¼Œè¿™æ ·æˆ‘ä»¬å°±ä¸ä¼šå¯¹ç›¸åŒçš„è¾“å…¥å€¼è°ƒç”¨ä¸€æ¬¡ä»¥ä¸Šå“ˆå¸Œå‡½æ•°äº†)ã€‚<br>ç„¶ååˆ©ç”¨<code>keccak</code>æŠŠè¾“å…¥çš„å€¼è½¬å˜ä¸ºä¸€ä¸ªå“ˆå¸Œå€¼, å†å°†å“ˆå¸Œå€¼è½¬æ¢ä¸ºuint, ç„¶ååˆ©ç”¨<code>%100</code>æ¥å–æœ€åä¸¤ä½, å°±ç”Ÿæˆäº†ä¸€ä¸ª0åˆ°100ä¹‹é—´éšæœºæ•°äº†ã€‚</p><blockquote><p>è¿™ä¸ªæ–¹æ³•å¾ˆå®¹æ˜“è¢«ä¸è¯šå®çš„èŠ‚ç‚¹æ”»å‡»</p></blockquote><p>ä¸è¯šå®èŠ‚ç‚¹æ˜¯åˆ©ç”¨éšæœºå‡½æ•°è¿›è¡Œæ”»å‡»çš„ï¼Œå‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªç¡¬å¸ç¿»è½¬åˆçº¦â€“æ­£é¢ä½ èµ¢åŒå€é’±ï¼Œåé¢ä½ è¾“æ‰æ‰€æœ‰çš„é’±ã€‚å‡å¦‚å®ƒä½¿ç”¨ä¸Šé¢çš„æ–¹æ³•æ¥å†³å®šæ˜¯æ­£é¢è¿˜æ˜¯åé¢(random&gt;=50ç®—æ­£é¢, random&lt;50ç®—åé¢)ã€‚<br>æ­¤æ—¶å¦‚æœæˆ‘æ­£è¿è¡Œä¸€ä¸ªèŠ‚ç‚¹ï¼Œæˆ‘å¯ä»¥åªå¯¹æˆ‘è‡ªå·±çš„èŠ‚ç‚¹å‘å¸ƒä¸€ä¸ªäº‹åŠ¡ï¼Œ<em>ä¸”ä¸åˆ†äº«å®ƒ</em>ã€‚æˆ‘å¯ä»¥è¿è¡Œç¡¬å¸ç¿»è½¬æ–¹æ³•æ¥å·çª¥æˆ‘çš„è¾“èµ¢ã€‚<br>å¦‚æœæˆ‘è¾“äº†ï¼Œæˆ‘å°±ä¸æŠŠè¿™ä¸ªäº‹åŠ¡åŒ…å«è¿›æˆ‘è¦è§£å†³çš„ä¸‹ä¸€ä¸ªåŒºå—ä¸­å»ã€‚æˆ‘å¯ä»¥ä¸€ç›´è¿è¡Œè¿™ä¸ªæ–¹æ³•ï¼Œç›´åˆ°æˆ‘èµ¢å¾—äº†ç¡¬å¸ç¿»è½¬å¹¶è§£å†³äº†ä¸‹ä¸€ä¸ªåŒºå—ï¼Œç„¶åè·åˆ©ã€‚</p><p>å½“ç„¶ï¼Œå› ä¸ºç½‘ç»œä¸Šæˆåƒä¸Šä¸‡çš„ä»¥å¤ªåŠèŠ‚ç‚¹éƒ½åœ¨ç«äº‰è§£å†³ä¸‹ä¸€ä¸ªåŒºå—ï¼Œæˆ‘èƒ½æˆåŠŸè§£å†³ä¸‹ä¸€ä¸ªåŒºå—çš„å‡ ç‡éå¸¸ä¹‹ä½ã€‚è¿™å°†èŠ±è´¹æˆ‘ä»¬å·¨å¤§çš„è®¡ç®—èµ„æºæ¥å¼€å‘è¿™ä¸ªè·åˆ©æ–¹æ³•ï¼Œä½†æ˜¯å¦‚æœå¥–åŠ±å¼‚å¸¸åœ°é«˜(æ¯”å¦‚æˆ‘å¯ä»¥åœ¨ç¡¬å¸ç¿»è½¬å‡½æ•°ä¸­èµ¢å¾—1ä¸ªäº¿)ï¼Œé‚£å°±å¾ˆå€¼å¾—å»æ”»å‡»äº†ã€‚</p><p>æ‰€ä»¥å°½ç®¡è¿™ä¸ªæ–¹æ³•åœ¨ä»¥å¤ªåŠä¸Šä¸å®‰å…¨ï¼Œåœ¨å®é™…ä¸­ï¼Œé™¤éæˆ‘ä»¬çš„éšæœºå‡½æ•°æœ‰ä¸€å¤§ç¬”é’±åœ¨ä¸Šé¢ï¼Œä½ æ¸¸æˆçš„ç”¨æˆ·ä¸€èˆ¬æ˜¯æ²¡æœ‰è¶³å¤Ÿçš„èµ„æºå»æ”»å‡»çš„ã€‚</p><p>å› æ­¤æˆ‘ä»¬å†³å®šæ¥å—è¿™ä¸ªä¸è¶³ä¹‹å¤„ï¼Œä½¿ç”¨è¿™ä¸ªç®€å•çš„éšæœºæ•°ç”Ÿæˆå‡½æ•°ã€‚ä½†æ˜¯è¦è°¨è®°å®ƒæ˜¯ä¸å®‰å…¨çš„ã€‚</p><!--åœ¨ä»¥å¤ªåŠä¸Šï¼Œå½“ä½ åœ¨ä¸€ä¸ªåˆçº¦ä¸Šè°ƒç”¨å‡½æ•°çš„æ—¶å€™ï¼Œä½ ä¼šæŠŠå®ƒå¹¿æ’­ç»™ä¸€ä¸ªèŠ‚ç‚¹æˆ–è€…åœ¨ç½‘ç»œä¸Šçš„transactionèŠ‚ç‚¹ä»¬ã€‚ç½‘ç»œä¸Šçš„èŠ‚ç‚¹å°†æ”¶é›†å¾ˆå¤šäº‹åŠ¡ï¼Œè¯•ç€æˆä¸ºç¬¬ä¸€ä¸ªè§£å†³è®¡ç®—å¯†é›†å‹æ•°å­¦é—®é¢˜çš„äººï¼Œä½œä¸º"å·¥ä½œè¯æ˜"ï¼Œç„¶åå°†"å·¥ä½œè¯æ˜"(Proof of Work, PoW)å’Œäº‹åŠ¡ä¸€èµ·ä½œä¸ºä¸€ä¸ªblockå‘å¸ƒåœ¨ç½‘ç»œä¸Šã€‚ä¸€æ—¦ä¸€ä¸ªèŠ‚ç‚¹è§£å†³äº†ä¸€ä¸ªPoW, å…¶ä»–èŠ‚ç‚¹å°±ä¼šåœæ­¢å°è¯•è§£å†³è¿™ä¸ªPoWï¼Œå¹¶éªŒè¯å…¶ä»–èŠ‚ç‚¹çš„äº‹åŠ¡åˆ—è¡¨æ˜¯æœ‰æ•ˆçš„ï¼Œç„¶åæ¥å—è¿™ä¸ªèŠ‚ç‚¹è½¬è€Œå°è¯•è§£å†³ä¸‹ä¸€ä¸ªèŠ‚ç‚¹ã€‚--><p>æ¸¸æˆä¸­çš„éšæœºå‡½æ•°åº”ç”¨åœ¨ä¸å…¶å®ƒåƒµå°¸æ‰“æ¶çš„åœºæ™¯ä¸Šï¼Œç”¨æ¥å†³å®šæ˜¯å¦å–èƒœï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiehelper.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieBattle is ZombieHelper &#123;</span><br><span class="line">  uint randNonce = <span class="number">0</span>;</span><br><span class="line">  uint attackVictoryProbability = <span class="number">70</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">randMod</span>(<span class="params">uint _modulus</span>) <span class="title">internal</span> <span class="title">returns</span>(<span class="params">uint</span>) </span>&#123;</span><br><span class="line">    randNonce++;</span><br><span class="line">    <span class="keyword">return</span> uint(keccak256(now, msg.sender, randNonce)) % _modulus;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">attack</span>(<span class="params">uint _zombieId, uint _targetId</span>) <span class="title">external</span> <span class="title">ownerOf</span>(<span class="params">_zombieId</span>) </span>&#123;</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    Zombie storage enemyZombie = zombies[_targetId];</span><br><span class="line">    uint rand = randMod(<span class="number">100</span>);</span><br><span class="line">    <span class="keyword">if</span> (rand &lt;= attackVictoryProbability) &#123;</span><br><span class="line">      myZombie.winCount++;</span><br><span class="line">      myZombie.level++;</span><br><span class="line">      enemyZombie.lossCount++;</span><br><span class="line">      feedAndMultiply(_zombieId, enemyZombie.dna, <span class="string">&quot;zombie&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      myZombie.lossCount++;</span><br><span class="line">      enemyZombie.winCount++;</span><br><span class="line">      _triggerCooldown(myZombie);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è®¢é˜…äº‹ä»¶"><a href="#è®¢é˜…äº‹ä»¶" class="headerlink" title="è®¢é˜…äº‹ä»¶"></a>è®¢é˜…äº‹ä»¶</h2><p>ä¸€ä¸ªå®Œæ•´å¯ç”¨çš„DAppé™¤äº†æ™ºèƒ½åˆçº¦å¿…ç„¶ä¹Ÿä¼šåŒ…æ‹¬å‰ç«¯åº”ç”¨ï¼Œè¿™æ ·æ‰èƒ½å¤Ÿæ›´æ–¹ä¾¿çš„è®©ç”¨æˆ·ä½¿ç”¨ï¼Œé‚£ä¹ˆå‰ç«¯åº”ç”¨å¦‚ä½•åŠæ—¶çš„æ„ŸçŸ¥åˆçº¦ä¸Šçš„å˜åŒ–å‘¢ï¼Ÿç­”æ¡ˆæ˜¯é€šè¿‡<em>è®¢é˜…äº‹ä»¶</em>ã€‚</p><p><a href="http://bigdatadecode.top/cryptozombies-src-parse.html">cryptozombiesæºç è§£æä¸€</a>ä¸­zombiefactory.solæœ‰ä¸ªäº‹ä»¶<code>NewZombie</code>ï¼Œæ¯æ¬¡æ–°å»ºä¸€ä¸ªåƒµå°¸ä¹‹åï¼Œéƒ½ä¼šè§¦å‘è¿™ä¸ªæ—¶é—´ï¼Œé‚£ä¹ˆæˆ‘ä»¬å¯ä»¥åœ¨å‰ç«¯ä¸­é€šè¿‡Web3.jsè®¢é˜…ä¸€ä¸ªäº‹ä»¶ï¼Œè¿™æ ·Web3æä¾›è€…å°±å¯ä»¥åœ¨æ¯æ¬¡äº‹ä»¶å‘ç”Ÿåè§¦å‘ä¸€äº›ä»£ç é€»è¾‘ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cryptoZombies.events.NewZombie()</span><br><span class="line">.on(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> zombie = event.returnValues;</span><br><span class="line">  <span class="built_in">console</span>.log(<span class="string">&quot;ä¸€ä¸ªæ–°åƒµå°¸è¯ç”Ÿäº†ï¼&quot;</span>, zombie.zombieId, zombie.name, zombie.dna);</span><br><span class="line">&#125;).on(<span class="string">&#x27;error&#x27;</span>, <span class="built_in">console</span>.error);</span><br></pre></td></tr></table></figure><p><code>NewZombie</code>äº‹ä»¶åœ¨æ¯ä¸ªæ–°å»ºåƒµå°¸çš„æ—¶å€™éƒ½ä¼šè°ƒç”¨ï¼Œè€Œä¸Šè¿°ä»£ç æ˜¯ç›‘å¬<code>NewZombie</code>çš„æ¯æ¬¡è§¦å‘ï¼Œæ‰€ä»¥æ— è®ºè°çš„åƒµå°¸æ–°å»ºæˆ‘éƒ½ä¼šæ”¶åˆ°ä¸€æ¬¡å¼¹çª—ä¿¡æ¯ï¼Œè¿™å¯¹æˆ‘å¯å¾ˆä¸å‹å¥½ï¼Œæˆ‘åªå…³å¿ƒæˆ‘å½“è‡ªå·±çš„åƒµå°¸å†›å›¢å¢åŠ æˆå‘˜æ—¶æé†’æˆ‘ï¼Œè¿™ä¸ªæ€ä¹ˆå®ç°å‘¢ï¼Ÿ</p><blockquote><p>indexedå…³é”®å­—å¯ç”¨äºè¿‡æ»¤event </p></blockquote><p>ä¸ºäº†ç­›é€‰ä»…å’Œå½“å‰ç”¨æˆ·ç›¸å…³çš„äº‹ä»¶ï¼ŒSolidityåˆçº¦å¿…é¡»ä½¿ç”¨<code>indexed</code>å…³é”®å­—ï¼Œå°±åƒæˆ‘ä»¬åœ¨ERC721å®ç°ä¸­çš„<code>Transfer</code>äº‹ä»¶ä¸­é‚£æ ·ï¼š<br><code>event Transfer(address indexed _from, address indexed _to, uint256 _tokenId);</code><br>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå› ä¸º_fromå’Œ_toéƒ½æ˜¯indexedï¼Œè¿™å°±æ„å‘³ç€æˆ‘ä»¬å¯ä»¥åœ¨å‰ç«¯äº‹ä»¶ç›‘å¬ä¸­è¿‡æ»¤äº‹ä»¶ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cryptoZombies.events.Transfer(&#123; <span class="attr">filter</span>: &#123; <span class="attr">_to</span>: userAccount &#125; &#125;)</span><br><span class="line">.on(<span class="string">&quot;data&quot;</span>, <span class="function"><span class="keyword">function</span>(<span class="params">event</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> data = event.returnValues;</span><br><span class="line">  <span class="comment">// å½“å‰ç”¨æˆ·æ›´æ–°äº†ä¸€ä¸ªåƒµå°¸ï¼æ›´æ–°ç•Œé¢æ¥æ˜¾ç¤º</span></span><br><span class="line">&#125;).on(<span class="string">&#x27;error&#x27;</span>, <span class="built_in">console</span>.error);</span><br></pre></td></tr></table></figure><p>çœ‹åˆ°äº†å§ï¼Œä½¿ç”¨<code>event</code>å’Œ<code>indexed</code>å­—æ®µå¯¹äºç›‘å¬åˆçº¦ä¸­çš„æ›´æ”¹å¹¶å°†å…¶<em>åæ˜ åˆ°DAppçš„å‰ç«¯ç•Œé¢ä¸­æ˜¯éå¸¸æœ‰ç”¨çš„åšæ³•</em>ã€‚</p><p>ä¹Ÿå¯ä»¥æŸ¥è¯¢è¿‡å»çš„äº‹ä»¶ï¼ŒæŸ¥è¯¢è¿‡å»äº‹ä»¶ä½¿ç”¨<code>getPastEvents</code>æ–¹æ³•ï¼Œä½¿ç”¨è¿‡æ»¤å™¨<code>fromBlock</code>å’Œ<code>toBlock</code>ç»™Solidityä¸€ä¸ªäº‹ä»¶æ—¥å¿—çš„æ—¶é—´èŒƒå›´(â€œblockâ€ åœ¨è¿™é‡Œä»£è¡¨ä»¥å¤ªåŠåŒºå—ç¼–å·)ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">cryptoZombies.getPastEvents(<span class="string">&quot;NewZombie&quot;</span>, &#123; <span class="attr">fromBlock</span>: <span class="number">0</span>, <span class="attr">toBlock</span>: <span class="string">&#x27;latest&#x27;</span> &#125;)</span><br><span class="line">.then(<span class="function"><span class="keyword">function</span>(<span class="params">events</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// events æ˜¯å¯ä»¥ç”¨æ¥éå†çš„ `event` å¯¹è±¡ </span></span><br><span class="line">  <span class="comment">// è¿™æ®µä»£ç å°†è¿”å›ç»™æˆ‘ä»¬ä»å¼€å§‹ä»¥æ¥åˆ›å»ºçš„åƒµå°¸åˆ—è¡¨</span></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>æœ‰äº›ç‰›é€¼çš„åŒå­¦çœ‹åˆ°è¿™é‡Œå¯èƒ½å°±æƒ³åˆ°äº†ä¸€ä¸ªéå¸¸æœ‰è¶£çš„ç”¨ä¾‹ï¼š<em>ç”¨äº‹ä»¶æ¥ä½œä¸ºä¸€ç§æ›´ä¾¿å®œçš„å­˜å‚¨</em>ã€‚ä½†æ˜¯è¿™é‡Œçš„çŸ­æ¿æ˜¯ï¼Œ<strong>äº‹ä»¶ä¸èƒ½ä»æ™ºèƒ½åˆçº¦æœ¬èº«è¯»å–</strong>ã€‚ä½†æ˜¯ï¼Œ<strong>å¦‚æœä½ æœ‰ä¸€äº›æ•°æ®éœ€è¦æ°¸ä¹…æ€§åœ°è®°å½•åœ¨åŒºå—é“¾ä¸­ä»¥ä¾¿å¯ä»¥åœ¨åº”ç”¨çš„å‰ç«¯ä¸­è¯»å–ï¼Œè¿™å°†æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ç”¨ä¾‹</strong>ã€‚è¿™äº›æ•°æ®ä¸ä¼šå½±å“æ™ºèƒ½åˆçº¦å‘å‰çš„çŠ¶æ€ã€‚</p><p>åƒµå°¸æ¸¸æˆä¸­å°±æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œ<em>ç”¨äº‹ä»¶æ¥ä½œä¸ºåƒµå°¸æˆ˜æ–—çš„å†å²çºªå½•</em>â€“æˆ‘ä»¬å¯ä»¥åœ¨æ¯æ¬¡åƒµå°¸æ”»å‡»åˆ«äººä»¥åŠæœ‰ä¸€æ–¹èƒœå‡ºçš„æ—¶å€™äº§ç”Ÿä¸€ä¸ªäº‹ä»¶ã€‚æ™ºèƒ½åˆçº¦ä¸éœ€è¦è¿™äº›æ•°æ®æ¥è®¡ç®—ä»»ä½•æ¥ä¸‹æ¥çš„äº‹æƒ…ï¼Œä½†æ˜¯è¿™å¯¹æˆ‘ä»¬åœ¨å‰ç«¯å‘ç”¨æˆ·å±•ç¤ºæ¥è¯´æ˜¯éå¸¸æœ‰ç”¨çš„ä¸œè¥¿ã€‚</p><p>ä¸Šé¢çš„ç¤ºä¾‹ä»£ç æ˜¯é’ˆå¯¹Web3.jsæœ€æ–°ç‰ˆ1.0çš„ï¼Œæ­¤ç‰ˆæœ¬ä½¿ç”¨äº†WebSocketsæ¥è®¢é˜…äº‹ä»¶ã€‚ä½†æ˜¯ï¼ŒMetaMaskå°šä¸”ä¸æ”¯æŒæœ€æ–°çš„äº‹ä»¶APIã€‚<br>æ‰€ä»¥ç°åœ¨æˆ‘ä»¬å¿…é¡»ä½¿ç”¨ä¸€ä¸ªå•ç‹¬Web3æä¾›è€…ï¼Œå®ƒé’ˆå¯¹äº‹ä»¶æä¾›äº†WebSocketsæ”¯æŒã€‚ æˆ‘ä»¬å¯ä»¥ç”¨Infuraæ¥åƒå®ä¾‹åŒ–ç¬¬äºŒä»½æ‹·è´ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> web3Infura = <span class="keyword">new</span> Web3(<span class="keyword">new</span> Web3.providers.WebsocketProvider(<span class="string">&quot;wss://mainnet.infura.io/ws&quot;</span>));</span><br><span class="line"><span class="keyword">var</span> czEvents = <span class="keyword">new</span> web3Infura.eth.Contract(cryptoZombiesABI, cryptoZombiesAddress);</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘ä»¬å°†ä½¿ç”¨<code>czEvents.events.Transfer</code>æ¥ç›‘å¬äº‹ä»¶ï¼Œè€Œä¸å†ä½¿ç”¨<code>cryptoZombies.events.Transfer</code>ã€‚</p><p>è¿™æ˜¯æˆ‘è·Ÿå®Œè¿™ä¸ªæ•™ç¨‹ä¹‹åçš„ä¸€äº›æ€»ç»“å§ï¼Œè¿˜æœ‰ä¸€äº›å†…å®¹æ²¡æœ‰æ€»ç»“ï¼Œéšåæœ‰æ—¶é—´å†æ€»ç»“ä¸‹ï¼Œé¡¹ç›®çš„æºä»£ç å¯ä»<a href="https://github.com/hunshenshi/cryptozombies">github</a>ä¸Šæµè§ˆã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Ethereum </tag>
            
            <tag> crypto </tag>
            
            <tag> cryptozombies </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>cryptozombiesæºç è§£æä¸€</title>
      <link href="/cryptozombies-src-parse.html"/>
      <url>/cryptozombies-src-parse.html</url>
      
        <content type="html"><![CDATA[<p>å­¦ä¹ åŒºå—é“¾çš„æœ‹å‹åº”è¯¥éƒ½äº†è§£å»å¹´åˆä¸€æ¬¾è¿·æ‹çŒ«çš„çˆ†æ¬¾æ¸¸æˆï¼Œä»–æ˜¯ä¸€æ¬¾åŸºäºä»¥å¤ªç½‘çš„Dappæ¸¸æˆã€‚æ­¤æ¸¸æˆå°†åŒºå—é“¾åº”ç”¨æ¨å‘äº†é«˜æ½®ï¼Œç½‘ä¸Šå„ç§è§£è¯»æ¥è¸µè€Œæ¥ã€‚<br>ä½†å¯¹äºå­¦ä¹ åŒºå—é“¾çš„æŠ€æœ¯äººå‘˜è‚¯å®šæƒ³ä»ä»£ç å±‚æ¬¡å­¦ä¹ ä¸‹ï¼Œæƒ³å€Ÿæ­¤æŒæ¡ä¸€äº›Dappå¼€å‘çš„æŠ€å·§ï¼Œæˆ‘ä¹Ÿæ˜¯è¿™ä¹ˆæƒ³çš„ï¼Œä½†æ˜¯ä¸å·§çš„æ˜¯æˆ‘çš„æ°´å¹³æœ‰é™(è™½ç„¶ä»£ç çœŸçš„å¾ˆç®€å•ï¼Œä»£ç é‡ä¹Ÿä¸å¤š)ï¼Œè¯»äº†ä¸€éæºç å‘ç°è„‘å­é‡Œæ²¡æœ‰ç•™ä¸‹ä»€ä¹ˆã€‚</p><p>äºæ˜¯å°±åœ¨ç½‘ä¸Šå„ç§æ‰¾èµ„æ–™ï¼Œæ— æ„ä¸­å‘ç°äº†<a href="https://cryptozombies.io/zh/course/">Loom Networkçš„ä¸€ä¸ªæ¸¸æˆæ•™ç¨‹cryptozombies</a>ï¼Œå°±å°è¯•äº†ä¸‹ï¼Œå‘ç°åœä¸ä¸‹æ¥ï¼Œå°±æŠŠ<em>Solidity æ•™ç¨‹: æ™ºèƒ½åˆçº¦åŸºç¡€æ•™ç¨‹</em>ç»™å­¦å®Œäº†ã€‚åœ¨å­¦ä¹ çš„è¿‡ç¨‹ä¸­å‘ç°å¾ˆå¤šçŸ¥è¯†ä¹Ÿåœ¨è¿·æ‹çŒ«çš„ä»£ç ä¸­å‡ºç°äº†ï¼Œç¬é—´æ„Ÿè§‰å¼€æœ—äº†å¾ˆå¤šã€‚</p><p>æ­¤ç¯‡åšå®¢ç®—æ˜¯å­¦å®Œè¯¾ç¨‹ä¹‹åçš„å›é¡¾å’Œæ€»ç»“å§ã€‚</p><span id="more"></span><h2 id="åƒµå°¸å·¥å‚"><a href="#åƒµå°¸å·¥å‚" class="headerlink" title="åƒµå°¸å·¥å‚"></a>åƒµå°¸å·¥å‚</h2><p>è¿™æ˜¯ä¸ªåƒµå°¸æ¸¸æˆï¼Œæ‰€ä»¥æ¸¸æˆçš„å¼€å§‹è‚¯å®šå¾—æœ‰ä¸ªåˆ›é€ åƒµå°¸çš„åœ°æ–¹ï¼Œè¿™é‡Œå°±æ˜¯ä»åƒµå°¸å·¥å‚å¼€å§‹çš„ã€‚å…ˆè´´ä¸‹ä»£ç ï¼Œç›¸ä¿¡æœ‰ç‚¹ä»£ç åŸºç¡€çš„åŒå­¦éƒ½å¯ä»¥çœ‹æ‡‚ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// zombiefactory.sol</span></span><br><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line">contract ZombieFactory &#123;</span><br><span class="line"></span><br><span class="line">    event NewZombie(uint zombieId, string name, uint dna);</span><br><span class="line"></span><br><span class="line">    uint dnaDigits = <span class="number">16</span>;</span><br><span class="line">    uint dnaModulus = <span class="number">10</span> ** dnaDigits;</span><br><span class="line"></span><br><span class="line">    struct Zombie &#123;</span><br><span class="line">        string name;</span><br><span class="line">        uint dna;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Zombie[] public zombies;</span><br><span class="line"></span><br><span class="line">    mapping (<span class="function"><span class="params">uint</span> =&gt;</span> address) public zombieToOwner;</span><br><span class="line">    mapping (<span class="function"><span class="params">address</span> =&gt;</span> uint) ownerZombieCount;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_createZombie</span>(<span class="params">string _name, uint _dna</span>) <span class="title">private</span> </span>&#123;</span><br><span class="line">        uint id = zombies.push(Zombie(_name, _dna)) - <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        zombieToOwner[id] = msg.sender;</span><br><span class="line">        ownerZombieCount[msg.sender]++;</span><br><span class="line">        NewZombie(id, _name, _dna);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">_generateRandomDna</span>(<span class="params">string _str</span>) <span class="title">private</span> <span class="title">view</span> <span class="title">returns</span> (<span class="params">uint</span>) </span>&#123;</span><br><span class="line">        uint rand = uint(keccak256(_str));</span><br><span class="line">        <span class="keyword">return</span> rand % dnaModulus;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">createRandomZombie</span>(<span class="params">string _name</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="built_in">require</span>(ownerZombieCount[msg.sender] == <span class="number">0</span>);</span><br><span class="line">        uint randDna = _generateRandomDna(_name);</span><br><span class="line">        _createZombie(_name, randDna);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­ä¸ªäººæ„Ÿè§‰éœ€è¦é‡ç‚¹æŒæ¡çš„åº”è¯¥æ˜¯<code>event</code>ï¼Œä½•ä¸ºeventå‘¢ï¼Ÿ<strong>eventæ˜¯åˆçº¦å’ŒåŒºå—é“¾é€šè®¯çš„ä¸€ç§æœºåˆ¶ï¼Œæœ€é‡è¦çš„æ˜¯ä½ çš„å‰ç«¯åº”ç”¨å¯ä»¥â€ç›‘å¬â€æŸäº›äº‹ä»¶ï¼Œå¹¶åšå‡ºååº”</strong>ã€‚<br><code>NewZombie</code>æ˜¯ä¸€ä¸ªeventï¼Œåœ¨<code>_createZombie</code>çš„<em>æœ€åä¸€è¡Œä»£ç </em>ä¸­è°ƒç”¨ï¼Œæˆ‘ä»¬ä»”ç»†è§‚å¯Ÿä¸‹<code>_createZombie</code>å‡½æ•°çš„é€»è¾‘ï¼Œæ–°å»ºäº†ä¸€ä¸ªZombieï¼Œå¹¶ä¸”pushåˆ°äº†zombiesçš„æ•°ç»„ä¸­ï¼Œä¹Ÿå¯¹ç›¸åº”çš„æ˜ å°„è¿›è¡Œçš„ä¿®æ”¹ï¼Œè‡³æ­¤æ–°å»ºzombieçš„é€»è¾‘å·²ç»å†™å®Œï¼Œé‚£ä¹ˆæœ€åä¸€è¡Œè°ƒç”¨<code>NewZombie</code>äº‹ä»¶æœ‰ä»€ä¹ˆç”¨å‘¢ï¼Ÿ<br>ä¹Ÿå°±æ˜¯è¯´è°ƒç”¨eventå¹¶ä¸æ˜¯ä¸šåŠ¡é€»è¾‘éœ€è¦ï¼Œè€Œæ˜¯æ¡†æ¶éœ€è¦ï¼Œæ˜¯ä¸ºäº†å‘Šè¯‰åŒºå—é“¾å»åšä¸€ä»¶äº‹ã€‚é‚£ä¹ˆå…·ä½“ä»€ä¹ˆäº‹å‘¢ï¼Ÿè¿™é‡Œå°±å¾—è¯´è¯´<strong>åŒºå—é“¾çš„æ—¥å¿—</strong>ã€‚<br>æ—¥å¿—åœ¨åŒºå—å±‚é¢ï¼Œå¯ä»¥ç”¨ä¸€ç§ç‰¹æ®Šçš„<em>å¯ç´¢å¼•çš„æ•°æ®ç»“æ„æ¥å­˜å‚¨æ•°æ®</em>ï¼Œæ‰€ä»¥è¯´æ—¥å¿—æ˜¯åŒºå—é“¾ä¸­å­˜å‚¨æ•°æ®çš„ï¼Œè€Œä¸”è¿˜æ˜¯<em>å¯ä»¥è¢«æ£€ç´¢</em>çš„ã€‚<strong>Solidityçš„eventå°±æ˜¯ç”¨æ—¥å¿—å®ç°çš„</strong>ã€‚<em>å½“eventè¢«è°ƒç”¨æ—¶ï¼Œä¼šè§¦å‘eventçš„å‚æ•°å­˜å‚¨åˆ°äº¤æ˜“çš„æ—¥å¿—ä¸­</em>ã€‚<br><code>NewZombie</code>äº‹ä»¶è¢«è°ƒç”¨çš„æ—¶å€™å°†æ–°å»ºzombieçš„idã€nameå’Œdnaä¿¡æ¯å­˜åœ¨äº†æ—¥å¿—ä¸­ï¼Œé€šè¿‡å‰ç«¯åº”ç”¨å°±å¯ä»¥å°†å…¶è¯»å‡ºã€‚</p><!--åˆçº¦åˆ›å»ºä¹‹åå°±æ— æ³•è®¿é—®æ—¥å¿—æ•° æ®ï¼Œä½†æ˜¯è¿™äº›æ•°æ®å¯ä»¥ä»åŒºå—é“¾å¤–é«˜æ•ˆçš„è®¿é—®ã€‚å› ä¸ºéƒ¨åˆ†æ—¥å¿—æ•°æ®è¢«å­˜å‚¨åœ¨å¸ƒéš†è¿‡æ»¤å™¨ï¼ˆBloom filter) ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥é«˜æ•ˆå¹¶ä¸”å®‰å…¨çš„æœç´¢æ—¥å¿—ï¼Œæ‰€ä»¥é‚£äº›æ²¡æœ‰ä¸‹è½½æ•´ä¸ªåŒºå—é“¾çš„ç½‘ç»œèŠ‚ç‚¹ï¼ˆè½»å®¢æˆ·ç«¯ï¼‰ä¹Ÿå¯ä»¥æ‰¾åˆ°è¿™äº›æ—¥å¿—ã€‚--><p>æœ€åçœ‹ä¸‹å®˜æ–¹ç»™å‡ºçš„å‰ç«¯åº”ç”¨è°ƒç”¨åˆçº¦çš„ä»£ç ï¼Œè¿™é‡Œä¹Ÿå±•ç¤ºäº†eventçš„å…·ä½“ç”¨æ³•</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ä¸‹é¢æ˜¯è°ƒç”¨åˆçº¦çš„æ–¹å¼:</span></span><br><span class="line"><span class="keyword">var</span> abi = <span class="comment">/* abiæ˜¯ç”±ç¼–è¯‘å™¨ç”Ÿæˆçš„ */</span></span><br><span class="line"><span class="keyword">var</span> ZombieFactoryContract = web3.eth.contract(abi)</span><br><span class="line"><span class="keyword">var</span> contractAddress = <span class="comment">/* å‘å¸ƒä¹‹ååœ¨ä»¥å¤ªåŠä¸Šç”Ÿæˆçš„åˆçº¦åœ°å€ */</span></span><br><span class="line"><span class="keyword">var</span> ZombieFactory = ZombieFactoryContract.at(contractAddress)</span><br><span class="line"><span class="comment">// `ZombieFactory` èƒ½è®¿é—®å…¬å…±çš„å‡½æ•°ä»¥åŠäº‹ä»¶</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// æŸä¸ªç›‘å¬æ–‡æœ¬è¾“å…¥çš„ç›‘å¬å™¨:</span></span><br><span class="line">$(<span class="string">&quot;#ourButton&quot;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">var</span> name = $(<span class="string">&quot;#nameInput&quot;</span>).val()</span><br><span class="line">  <span class="comment">//è°ƒç”¨åˆçº¦çš„ `createRandomZombie` å‡½æ•°:</span></span><br><span class="line">  ZombieFactory.createRandomZombie(name)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ç›‘å¬ `NewZombie` äº‹ä»¶, å¹¶ä¸”æ›´æ–°UI</span></span><br><span class="line"><span class="keyword">var</span> event = ZombieFactory.NewZombie(<span class="function"><span class="keyword">function</span>(<span class="params">error, result</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span></span><br><span class="line">  generateZombie(result.zombieId, result.name, result.dna)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// è·å– Zombie çš„ dna, æ›´æ–°å›¾åƒ</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">generateZombie</span>(<span class="params">id, name, dna</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> dnaStr = <span class="built_in">String</span>(dna)</span><br><span class="line">  <span class="comment">// å¦‚æœdnaå°‘äº16ä½,åœ¨å®ƒå‰é¢ç”¨0è¡¥ä¸Š</span></span><br><span class="line">  <span class="keyword">while</span> (dnaStr.length &lt; <span class="number">16</span>)</span><br><span class="line">    dnaStr = <span class="string">&quot;0&quot;</span> + dnaStr</span><br><span class="line"></span><br><span class="line">  <span class="keyword">let</span> zombieDetails = &#123;</span><br><span class="line">    <span class="comment">// å‰ä¸¤ä½æ•°æ„æˆå¤´éƒ¨.æˆ‘ä»¬å¯èƒ½æœ‰7ç§å¤´éƒ¨, æ‰€ä»¥ % 7</span></span><br><span class="line">    <span class="comment">// å¾—åˆ°çš„æ•°åœ¨0-6,å†åŠ ä¸Š1,æ•°çš„èŒƒå›´å˜æˆ1-7</span></span><br><span class="line">    <span class="comment">// é€šè¿‡è¿™æ ·è®¡ç®—ï¼š</span></span><br><span class="line">    <span class="attr">headChoice</span>: dnaStr.substring(<span class="number">0</span>, <span class="number">2</span>) % <span class="number">7</span> + <span class="number">1</span>ï¼Œ</span><br><span class="line">    <span class="comment">// æˆ‘ä»¬å¾—åˆ°çš„å›¾ç‰‡åç§°ä»head1.png åˆ° head7.png</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ¥ä¸‹æ¥çš„ä¸¤ä½æ•°æ„æˆçœ¼ç›, çœ¼ç›å˜åŒ–å°±å¯¹11å–æ¨¡:</span></span><br><span class="line">    <span class="attr">eyeChoice</span>: dnaStr.substring(<span class="number">2</span>, <span class="number">4</span>) % <span class="number">11</span> + <span class="number">1</span>,</span><br><span class="line">    <span class="comment">// å†æ¥ä¸‹æ¥çš„ä¸¤ä½æ•°æ„æˆè¡£æœï¼Œè¡£æœå˜åŒ–å°±å¯¹6å–æ¨¡:</span></span><br><span class="line">    <span class="attr">shirtChoice</span>: dnaStr.substring(<span class="number">4</span>, <span class="number">6</span>) % <span class="number">6</span> + <span class="number">1</span>,</span><br><span class="line">    <span class="comment">//æœ€å6ä½æ§åˆ¶é¢œè‰². ç”¨cssé€‰æ‹©å™¨: hue-rotateæ¥æ›´æ–°</span></span><br><span class="line">    <span class="comment">// å…¶å®è¿·æ‹çŒ«çš„å„ç§å½¢æ€ä¹Ÿæ˜¯ä»å®ƒçš„dnaä¸­åƒè¿™æ ·è§£æå‡ºæ¥çš„</span></span><br><span class="line">    <span class="comment">// 360åº¦:</span></span><br><span class="line">    <span class="attr">skinColorChoice</span>: <span class="built_in">parseInt</span>(dnaStr.substring(<span class="number">6</span>, <span class="number">8</span>) / <span class="number">100</span> * <span class="number">360</span>),</span><br><span class="line">    <span class="attr">eyeColorChoice</span>: <span class="built_in">parseInt</span>(dnaStr.substring(<span class="number">8</span>, <span class="number">10</span>) / <span class="number">100</span> * <span class="number">360</span>),</span><br><span class="line">    <span class="attr">clothesColorChoice</span>: <span class="built_in">parseInt</span>(dnaStr.substring(<span class="number">10</span>, <span class="number">12</span>) / <span class="number">100</span> * <span class="number">360</span>),</span><br><span class="line">    <span class="attr">zombieName</span>: name,</span><br><span class="line">    <span class="attr">zombieDescription</span>: <span class="string">&quot;A Level 1 CryptoZombie&quot;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> zombieDetails</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>msg.sender</p></blockquote><p>å¯¹äºä¸äº†è§£æ™ºèƒ½åˆçº¦å¼€å‘çš„åŒå­¦æ¥è¯´ï¼Œçœ‹åˆ°<code>msg.sender</code>è¿™ä¸ªå˜é‡çš„æ—¶å€™ï¼Œè‚¯å®šä¸€è„¸æ‡µé€¼ï¼Œè¿™ä¸ªä»å“ªæ¥çš„ã€‚ã€‚ã€‚å…¶å®<code>msg.sender</code>æ˜¯ä¸€ä¸ªå…¨å±€å˜é‡ï¼Œå°±åƒjavascriptä¸€æ ·ä¹Ÿæœ‰å¾ˆå¤šå…¨å±€å˜é‡ã€‚è¿™äº›å…¨å±€å˜é‡å¯ä»¥è¢«æ‰€æœ‰å‡½æ•°è°ƒç”¨ï¼Œå…¶ä¸­ä¸€ä¸ªå…¨å±€å˜é‡å°±æ˜¯<code>msg.sender</code>ï¼Œ<strong>å®ƒæŒ‡çš„æ˜¯å½“å‰è°ƒç”¨è€…ï¼ˆæˆ–æ™ºèƒ½åˆçº¦ï¼‰çš„address</strong>ã€‚    æ³¨æ„ï¼šåœ¨Solidityä¸­ï¼ŒåŠŸèƒ½æ‰§è¡Œå§‹ç»ˆéœ€è¦ä»å¤–éƒ¨è°ƒç”¨è€…å¼€å§‹ã€‚ <em>ä¸€ä¸ªåˆçº¦åªä¼šåœ¨åŒºå—é“¾ä¸Šä»€ä¹ˆä¹Ÿä¸åšï¼Œé™¤éæœ‰äººè°ƒç”¨å…¶ä¸­çš„å‡½æ•°</em>ã€‚æ‰€ä»¥msg.senderæ€»æ˜¯å­˜åœ¨çš„ã€‚</p><h2 id="ä¸å…¶å®ƒåˆçº¦äº¤äº’"><a href="#ä¸å…¶å®ƒåˆçº¦äº¤äº’" class="headerlink" title="ä¸å…¶å®ƒåˆçº¦äº¤äº’"></a>ä¸å…¶å®ƒåˆçº¦äº¤äº’</h2><p>ç”µå½±ä¸­çš„åƒµå°¸éƒ½æ˜¯æˆç¾¤ç»“é˜Ÿçš„å»æ’•å’¬å¼‚ç±»ï¼Œéœ€è¦å¯»æ‰¾é£Ÿç‰©ï¼Œé‚£ä¹ˆåˆšåˆšæ–°å»ºçš„åƒµå°¸ä¹Ÿéœ€è¦å»å¯»æ‰¾é£Ÿç‰©ï¼Œæ‰€ä»¥è¿™é‡Œä½œè€…å°†è¿·æ‹çŒ«ä½œä¸ºäº†åƒµå°¸çš„é£Ÿç‰©ï¼Œè¦æƒ³æ‹¿åˆ°è¿·æ‹çŒ«çš„ä¿¡æ¯å°±å¾—ä¸è¿·æ‹çŒ«äº¤äº’ï¼Œè¿™å°±æ˜¯æœ¬èŠ‚çš„é‡ç‚¹ï¼Œä¸å…¶ä»–åˆçº¦äº¤äº’ã€‚ç…§ä¾‹å…ˆè´´ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.19</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> <span class="string">&quot;./zombiefactory.sol&quot;</span>;</span><br><span class="line"></span><br><span class="line">contract KittyInterface &#123;</span><br><span class="line">  <span class="function">function <span class="title">getKitty</span><span class="params">(uint256 _id)</span> external view <span class="title">returns</span> <span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    bool isGestating,</span></span></span><br><span class="line"><span class="params"><span class="function">    bool isReady,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 cooldownIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 nextActionAt,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 siringWithId,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 birthTime,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 matronId,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 sireId,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 generation,</span></span></span><br><span class="line"><span class="params"><span class="function">    uint256 genes</span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract ZombieFeeding is ZombieFactory &#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// è¿·æ‹çŒ«åˆçº¦çš„åœ°å€</span></span><br><span class="line">  address ckAddress = <span class="number">0x06012c8cf97BEaD5deAe237070F9587f8E7A266d</span>;</span><br><span class="line">  <span class="comment">// å®ç°ç±»ï¼Œåªæ˜¯æ¥å£çš„å®ç°ç±»è¢«åˆ«äººå®ç°äº†ï¼Œå¹¶ä¸”å·²éƒ¨ç½²åœ¨çš„åŒºå—é“¾ä¸­</span></span><br><span class="line">  KittyInterface kittyContract = KittyInterface(ckAddress);</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">feedAndMultiply</span><span class="params">(uint _zombieId, uint _targetDna, string _species)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    require(msg.sender == zombieToOwner[_zombieId]);</span><br><span class="line">    Zombie storage myZombie = zombies[_zombieId];</span><br><span class="line">    _targetDna = _targetDna % dnaModulus;</span><br><span class="line">    uint newDna = (myZombie.dna + _targetDna) / <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå¢åŠ ä¸€ä¸ª if è¯­å¥</span></span><br><span class="line">    <span class="keyword">if</span> (keccak256(_species) == keccak256(<span class="string">&quot;kitty&quot;</span>)) &#123;</span><br><span class="line">      newDna = newDna - newDna % <span class="number">100</span> + <span class="number">99</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å­ç±»è®¿é—®çˆ¶ç±»çš„å†…éƒ¨æ–¹æ³•æ³¨æ„privateå’Œinternalçš„åŒºåˆ«</span></span><br><span class="line">    _createZombie(<span class="string">&quot;NoName&quot;</span>, newDna);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">function <span class="title">feedOnKitty</span><span class="params">(uint _zombieId, uint _kittyId)</span> <span class="keyword">public</span> </span>&#123;</span><br><span class="line">    uint kittyDna;</span><br><span class="line">    (,,,,,,,,,kittyDna) = kittyContract.getKitty(_kittyId);</span><br><span class="line">    feedAndMultiply(_zombieId, kittyDna, <span class="string">&quot;kitty&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»†å¿ƒçš„åŒå­¦åœ¨ä»£ç çš„å¼€å¤´å°±å‘ç°äº†solidityä¹Ÿå¯ä»¥åƒpythoné‚£ä¹ˆimportä¸€ä¸ªæ–‡ä»¶ï¼Œæ¥ç€æœ‰ä¸ª<code>ZombieFeeding</code>çš„åˆçº¦ï¼Œæ­¤åˆçº¦ç»§æ‰¿è‡ª<code>ZombieFactory</code>(ç»§æ‰¿çš„è¯­æ³•æ˜¯ä½¿ç”¨iså…³é”®å­—)ã€‚<br>è¿™é‡Œæ¼ä»‹ç»äº†ä¸€æ®µä»£ç ï¼Œé‚£å°±æ˜¯<code>KittyInterface</code>ï¼Œè¿™ä¸ªçœ‹ç€åƒä¸ªåˆçº¦ï¼Œä½†ä»”ç»†ä¸€çœ‹ä¸æ˜¯ï¼Œè¿™å°±æ˜¯solidityä¸­çš„æ¥å£ï¼Œæ˜¯ä¸æ˜¯æœ‰ç‚¹javaçš„æ„Ÿè§‰ï¼Œæœ‰ç±»åï¼Œæ–¹æ³•åï¼Œåªæ˜¯æ²¡æœ‰æ–¹æ³•å…·ä½“çš„å®ç°ã€‚</p><p><code>KittyInterface</code>åªå£°æ˜äº†è¿·æ‹çŒ«çš„getKittyå‡½æ•°ï¼Œå…¶å®è¿·æ‹çŒ«åˆçº¦é‡Œæœ‰å¾ˆå¤šå‡½æ•°ï¼Œè¿™é‡Œåªå£°æ˜ä½¿ç”¨åˆ°çš„å‡½æ•°ï¼Œå…¶å®ƒå‡½æ•°å¯ä»¥æŸ¥çœ‹<a href="">åˆçº¦åœ°å€</a>ã€‚ä½¿ç”¨è¿™ä¸ªæ¥å£ï¼Œåˆçº¦å°±çŸ¥é“å…¶ä»–åˆçº¦çš„å‡½æ•°æ˜¯æ€æ ·çš„ï¼Œåº”è¯¥å¦‚ä½•è°ƒç”¨ï¼Œä»¥åŠå¯æœŸå¾…ä»€ä¹ˆç±»å‹çš„è¿”å›å€¼ã€‚</p><p>ç°åœ¨æˆ‘ä»¬ä»javaè§’åº¦çœ‹ä¸‹æ¥å£å¦‚ä½•ä½¿ç”¨ã€‚åœ¨javaä¸­ï¼Œæˆ‘ä»¬å…ˆå†™ä¸€ä¸ªæ¥å£ç±»Iï¼Œå£°æ˜äº†ä¸ªæ–¹æ³•fã€‚ç„¶ååˆå†™äº†ä¸ªå®ç°ç±»Implï¼Œå¹¶å®Œæˆäº†fçš„å…·ä½“é€»è¾‘ã€‚æœ€åæœ‰ä¸ªç±»Oï¼Œè°ƒç”¨äº†fï¼Œæ‰€ä»¥åœ¨Oå†…æœ‰ä¸ªå¯¹è±¡Iï¼Œå¹¶ä¸”è¢«Implåˆå§‹åŒ–ã€‚ä¸Šé¢çš„ä»£ç æ˜¯ä¸æ˜¯ä¹Ÿæ˜¯è¿™ä¸ªå¥—è·¯ï¼Œåªä¸è¿‡<code>KittyInterface</code>çš„å®ç°ç±»è¢«è¿·æ‹çŒ«å†™å¥½äº†ï¼Œä¸åœ¨è¿™ä¸ªåƒµå°¸é¡¹ç›®ä¸­ã€‚</p><p>åˆ°ç›®å‰ä¸ºæ­¢ï¼Œæˆ‘ä»¬å·²ç»å†™ä¸¤ä¸ªåˆçº¦ä¸€ä¸ªæ¥å£ï¼Œæˆ‘ä»¬åªç”¨ç¼–è¯‘å’Œéƒ¨ç½²<code>ZombieFeeding</code>ï¼Œå°±å¯ä»¥å°†è¿™ä¸ªåˆçº¦éƒ¨ç½²åˆ°ä»¥å¤ªåŠäº†ã€‚æˆ‘ä»¬æœ€ç»ˆå®Œæˆçš„è¿™ä¸ªåˆçº¦ç»§æ‰¿è‡ª ZombieFactoryï¼Œå› æ­¤å®ƒå¯ä»¥è®¿é—®è‡ªå·±å’Œçˆ¶è¾ˆåˆçº¦ä¸­çš„æ‰€æœ‰<code>public</code>æ–¹æ³•ã€‚</p><p>è¯´åˆ°è®¿é—®æƒé™ä¸Šé¢<code>ZombieFactory</code>åˆ°ä»£ç æœ‰å¤„éœ€è¦æ”¹ä¸‹ï¼Œ<code>_createZombie</code>æ–¹æ³•æ˜¯<code>private</code>ï¼Œä½†æ˜¯åœ¨<code>ZombieFeeding</code>ä¸­è¢«è°ƒç”¨äº†ï¼Œæ­¤æ—¶ä¼šç¼–è¯‘é”™è¯¯ï¼Œå› ä¸º<em>private</em>æ„å‘³ç€å®ƒ<strong>åªèƒ½è¢«åˆçº¦å†…éƒ¨è°ƒç”¨</strong>ï¼›<em>internal</em>å°±åƒ<strong>privateä½†æ˜¯ä¹Ÿèƒ½è¢«ç»§æ‰¿çš„åˆçº¦è°ƒç”¨</strong>ï¼Œæ‰€ä»¥éœ€è¦å°†<code>ZombieFactory._createZombie</code>æ”¹ä¸º<code>internal</code>ã€‚(é¡ºä¾¿æä¸‹<em>external</em>åªèƒ½ä»åˆçº¦å¤–éƒ¨è°ƒç”¨ï¼›æœ€å<em>public</em> å¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è°ƒç”¨ï¼Œä¸ç®¡æ˜¯å†…éƒ¨è¿˜æ˜¯å¤–éƒ¨ã€‚)</p><p>æœ€åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªä¸æˆ‘ä»¬çš„åˆšéƒ¨ç½²çš„åˆçº¦è¿›è¡Œäº¤äº’çš„ä¾‹å­ï¼Œ è¿™ä¸ªä¾‹å­ä½¿ç”¨äº†<code>JavaScript</code>å’Œ<code>web3.js</code>ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> abi = <span class="comment">/* abi generated by the compiler */</span></span><br><span class="line"><span class="keyword">var</span> ZombieFeedingContract = web3.eth.contract(abi)</span><br><span class="line"><span class="keyword">var</span> contractAddress = <span class="comment">/* our contract address on Ethereum after deploying */</span></span><br><span class="line"><span class="keyword">var</span> ZombieFeeding = ZombieFeedingContract.at(contractAddress)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å‡è®¾æˆ‘ä»¬æœ‰æˆ‘ä»¬çš„åƒµå°¸IDå’Œè¦æ”»å‡»çš„çŒ«å’ªID</span></span><br><span class="line"><span class="keyword">let</span> zombieId = <span class="number">1</span>;</span><br><span class="line"><span class="keyword">let</span> kittyId = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// è¦æ‹¿åˆ°çŒ«å’ªçš„DNAï¼Œæˆ‘ä»¬éœ€è¦è°ƒç”¨å®ƒçš„APIã€‚è¿™äº›æ•°æ®ä¿å­˜åœ¨å®ƒä»¬çš„æœåŠ¡å™¨ä¸Šè€Œä¸æ˜¯åŒºå—é“¾ä¸Šã€‚</span></span><br><span class="line"><span class="comment">// å¦‚æœä¸€åˆ‡éƒ½åœ¨åŒºå—é“¾ä¸Šï¼Œæˆ‘ä»¬å°±ä¸ç”¨æ‹…å¿ƒå®ƒä»¬çš„æœåŠ¡å™¨æŒ‚äº†ï¼Œæˆ–è€…å®ƒä»¬ä¿®æ”¹äº†APIï¼Œ</span></span><br><span class="line"><span class="comment">// æˆ–è€…å› ä¸ºä¸å–œæ¬¢æˆ‘ä»¬çš„åƒµå°¸æ¸¸æˆè€Œå°æ€äº†æˆ‘ä»¬</span></span><br><span class="line"><span class="keyword">let</span> apiUrl = <span class="string">&quot;https://api.cryptokitties.co/kitties/&quot;</span> + kittyId</span><br><span class="line">$.get(apiUrl, <span class="function"><span class="keyword">function</span>(<span class="params">data</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> imgUrl = data.image_url</span><br><span class="line">  <span class="comment">// ä¸€äº›æ˜¾ç¤ºå›¾ç‰‡çš„ä»£ç </span></span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// å½“ç”¨æˆ·ç‚¹å‡»ä¸€åªçŒ«å’ªçš„æ—¶å€™:</span></span><br><span class="line">$(<span class="string">&quot;.kittyImage&quot;</span>).click(<span class="function"><span class="keyword">function</span>(<span class="params">e</span>) </span>&#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨æˆ‘ä»¬åˆçº¦çš„ `feedOnKitty` å‡½æ•°</span></span><br><span class="line">  ZombieFeeding.feedOnKitty(zombieId, kittyId)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// ä¾¦å¬æ¥è‡ªæˆ‘ä»¬åˆçº¦çš„æ–°åƒµå°¸äº‹ä»¶å¥½æ¥å¤„ç†</span></span><br><span class="line">ZombieFactory.NewZombie(<span class="function"><span class="keyword">function</span>(<span class="params">error, result</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (error) <span class="keyword">return</span></span><br><span class="line">  <span class="comment">// è¿™ä¸ªå‡½æ•°ç”¨æ¥æ˜¾ç¤ºåƒµå°¸:</span></span><br><span class="line">  generateZombie(result.zombieId, result.name, result.dna)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>åç»­å†…å®¹å°†åœ¨ä¸‹ä¸€ç¯‡ä¸­ç»§ç»­ä»‹ç»ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Ethereum </tag>
            
            <tag> crypto </tag>
            
            <tag> cryptozombies </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ozoneæ„Ÿæ‚Ÿ</title>
      <link href="/Ozone%E6%84%9F%E6%82%9F.html"/>
      <url>/Ozone%E6%84%9F%E6%82%9F.html</url>
      
        <content type="html"><![CDATA[<p>å‰é¢æåˆ°Ozoneçš„åŸåˆ›å›¢é˜Ÿå¯¹å¤§è§„æ¨¡Hadoopé›†ç¾¤è¿ç»´å’Œä¼˜åŒ–æœ‰ç€ä¸°å¯Œçš„ç»éªŒï¼Œæ‰€ä»¥Ozoneçš„è®¾è®¡ä¸­ä¹Ÿä½“ç°äº†å¾ˆå¤šHDFSçš„ä¼˜ç‚¹ï¼Œå¹¶å±è”½äº†ä¸€äº›HDFSçš„æ€§èƒ½ç“¶é¢ˆã€‚</p><p>HDFSç›®å‰çš„ç“¶é¢ˆä¸»è¦åœ¨NNä¸Šï¼ŒNNå†…å­˜ä¸­ç»´æŠ¤ç€ä¸¤ä¸ªå¤§å¯¹è±¡ï¼Œä¸€ä¸ªæ˜¯NameSpaceï¼Œå¦ä¸€ä¸ªæ˜¯BlocksMapï¼Œè¿™ä¸¤ä¸ªæ˜¯å¸¸é©»å†…å­˜è€Œä¸”éšç€é›†ç¾¤å­˜å‚¨çš„æ–‡ä»¶æ•°å’Œè§„æ¨¡æˆçº¿æ€§å¢é•¿ï¼Œè¿™å°±é€ æˆNNçš„å†…å­˜å æ¯”è¶Šæ¥è¶Šå¤§ï¼Œæˆä¸ºHDFSæ‰©å±•çš„ç“¶é¢ˆã€‚</p><p>é‚£ä¹ˆOzoneæ˜¯å¦‚ä½•è§£å†³è¿™äº›ç“¶é¢ˆå‘¢ï¼Ÿ</p><span id="more"></span> <blockquote><p>NameSpaceæ‰©å±•æ€§</p></blockquote><p>Ozoneä½¿ç”¨Ozone Managerçš„æœåŠ¡æ¥ç®¡ç†namespaceï¼Œå…¶å¹¶ä¸ä¼šæŠŠæ•´ä¸ªnamespaceå­˜å‚¨åœ¨ä¸€ä¸ªèŠ‚ç‚¹çš„å†…å­˜ä¸­ï¼Œè€Œæ˜¯åªå°†ä¸€äº›æ­£åœ¨ä½¿ç”¨çš„é›†åˆå­˜å‚¨åœ¨å†…å­˜ä¸­ã€‚(å› ä¸ºnamespaceå…·æœ‰æœ¬åœ°å¼•ç”¨æ€§ï¼Œæ‰€ä»¥å¯ä»¥è¿™ä¹ˆæ)<!-- The key insight is that the namespace has locality of reference so we can store just the working set in memory. --></p><blockquote><p>Block Mapæ‰©å±•æ€§</p></blockquote><p>è¿™éƒ¨åˆ†è§£å†³èµ·æ¥æ¯”è¾ƒéš¾ï¼Œå› ä¸ºå…¶ä¸åƒnamespaceä¸€æ ·å…·æœ‰æœ¬åœ°å¼•ç”¨æ€§ï¼Œå› ä¸ºblock mapæ˜¯dnå‘¨æœŸæ€§çš„æŠŠæ¯ä¸ªå—çš„ä¿¡æ¯æ±‡æŠ¥ç»™nnè€Œæ¥çš„ã€‚<em>Ozoneå°†æ­¤é—®é¢˜å§”æ‰˜ç»™åä¸ºHadoop Distributed DataStore(HDDS)çš„å…±äº«é€šç”¨å­˜å‚¨å±‚æ¥è§£å†³</em></p><p>æ¥ä¸‹æ¥ä¸»è¦è°ˆä¸‹Ozoneä¸­çš„containerï¼Œå…¨ç§°ä¸ºStorage Containerã€‚<em>Containerç±»ä¼¼äºHDFSä¸­blockçš„æ¦‚å¿µï¼Œéƒ½æ˜¯æœ€å°çš„å®¹é”™å•å…ƒï¼Œä½†Containerå¹¶ä¸æ˜¯æœ€å°çš„å†™å…¥å•å…ƒï¼ŒContainerä¸­åŒ…å«è‹¥å¹²ä¸ªblockï¼Œblockä¸ºæœ€å°çš„å†™å…¥å•å…ƒã€‚</em><br>æœ‰ç‚¹åƒåœ¨blockä¸ŠåˆåŠ äº†ä¸€å±‚ç´¢å¼•ï¼Œ<em>ç”±åŸæ¥çš„file-&gt;blockså˜ä¸ºfile-&gt;containers-&gt;blocks</em>ï¼Œè¿™æ ·blocks mapå°±ä¼šå°‘äº†ä¸€ä¸ªé‡çº§ï¼Œæ›´æ–¹ä¾¿ç»´æŠ¤ï¼Œè€Œä¸”Ozoneè¿˜ä¸ºContaineræä¾›äº†ä¸€ä¸ªä¸“é—¨çš„æœåŠ¡ç”¨ä¸ç®¡ç†ï¼Œè¿™ä¸ªæœåŠ¡æ˜¯Storage Container Manager(SCM)ã€‚(SCMä¸Containerä¸¤è€…çš„å…³ç³»æ˜¯Containerå¯¹å¤–æä¾›å—æœåŠ¡ï¼ŒSCMç”±åº•å±‚å­˜å‚¨å‘å¤–æä¾›æœåŠ¡ï¼Œå¯ä»¥æ”¯æŒä¸åŒçš„ä¸Šå±‚ç³»ç»Ÿã€‚)</p><p>ä¸Šé¢æåˆ°Containeræ˜¯æœ€å°çš„å®¹é”™å•å…ƒï¼Œæ˜¯å› ä¸ºOzoneæ˜¯æŠŠContaineråˆ©ç”¨Raftè¿›è¡Œ3å‰¯æœ¬è¾¾åˆ°å®¹é”™çš„æ•ˆæœï¼Œè¿™æ ·çš„è¯HDFSåŸå…ˆblockå‰¯æœ¬çš„ä»£ç å¯ä»¥å¤ç”¨ï¼ŒåŸºäºpipelineæ–¹å¼è¿›è¡Œå†™å…¥ã€‚</p><p>ä¸ªäººæ„Ÿè§‰å¦‚æœHDFS Federationæ˜¯HDFSçš„2.0æ—¶ä»£çš„è¯ï¼Œæˆ‘æ„Ÿè§‰Ozoneå°±æ˜¯HDFSçš„3.0æ—¶ä»£ï¼Œæ˜¯å¯¹HDFSçš„åˆä¸€æ¬¡æ‰©å±•ã€‚</p><!--https://issues.apache.org/jira/secure/attachment/12895963/HDFS%20Scalability%20and%20Ozone.pdfâ€-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Ozone </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hadoopå°æ–‡ä»¶åˆ©å™¨Ozoneè°ƒç ”</title>
      <link href="/Hadoop-Ozone.html"/>
      <url>/Hadoop-Ozone.html</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰ä¸€ç¯‡æ–‡ç« ä»‹ç»äº†åœ¨å°æ–‡ä»¶åˆå¹¶æ–¹é¢çš„ä¸€äº›å¿ƒå¾—ï¼Œ*æœ¬ç¯‡ä»‹ç»ä¸‹Hadoopè§£å†³å°æ–‡ä»¶çš„æœ€æ–°åˆ©å™¨Ozone(æœ¬ç¯‡åŸºäº0.3.0-alphaç‰ˆæœ¬)*ã€‚</p><h2 id="Ozoneè¯ç”Ÿçš„èƒŒæ™¯"><a href="#Ozoneè¯ç”Ÿçš„èƒŒæ™¯" class="headerlink" title="Ozoneè¯ç”Ÿçš„èƒŒæ™¯"></a>Ozoneè¯ç”Ÿçš„èƒŒæ™¯</h2><p>ä¼—æ‰€å‘¨çŸ¥ï¼ŒHDFSæ˜¯å¤§æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œå¹¶åœ¨ä¸šç•Œå¾—åˆ°äº†å¹¿æ³›çš„ä½¿ç”¨ã€‚ä½†æ˜¯æ— è®ºå¤§é›†ç¾¤è¿˜æ˜¯å°é›†ç¾¤å…¶æ‰©å±•æ€§éƒ½å—NNçš„é™åˆ¶ï¼Œ<em>è™½ç„¶HDFSå¯ä»¥é€šè¿‡Federationè¿›è¡Œæ‰©å±•ï¼Œä½†æ˜¯ä¾ç„¶æ·±å—å°æ–‡ä»¶å’Œ4äº¿ä¸ªæ–‡ä»¶çš„å›°æ‰°</em>ã€‚</p><p>äºæ˜¯åˆ†å¸ƒå¼key-valueå­˜å‚¨ç³»ç»ŸOzoneè¯ç”Ÿäº†ï¼ŒOzoneèƒ½å¤Ÿè½»æ¾ç®¡ç†å°æ–‡ä»¶å’Œå¤§æ–‡ä»¶ã€‚(HDFSæä¾›äº†ç±»ä¼¼POSIXçš„è¯­ä¹‰ï¼ŒOzoneçš„å¤–è§‚å’Œè¡Œä¸ºæ›´åƒä¸€ä¸ªObjectå­˜å‚¨ç³»ç»Ÿã€‚)</p><span id="more"></span><h2 id="Ozone"><a href="#Ozone" class="headerlink" title="Ozone"></a>Ozone</h2><p>Ozoneæ˜¯ä¸“é—¨ä¸ºHadoopè®¾è®¡çš„å¯æ‰©å±•çš„åˆ†å¸ƒå¼å¯¹è±¡å­˜å‚¨ç³»ç»Ÿã€‚Hadoopç”Ÿæ€ä¸­çš„å…¶å®ƒç»„ä»¶å¦‚Sparkã€Hiveå’ŒYarnä¸éœ€è¦ä»»ä½•ä¿®æ”¹å°±å¯ä»¥ç›´æ¥è¿è¡Œåœ¨Ozoneä¹‹ä¸Šã€‚<em>Ozoneçš„ä½¿ç”¨æ–¹å¼ä¹Ÿè¾ƒä¸ºä¸°å¯Œï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤è¡Œç›´æ¥ä½¿ç”¨ä¹Ÿæœ‰javaå®¢æˆ·ç«¯æ¥å£ï¼Œè€Œä¸”æ¥å£æ”¯æŒRPCå’ŒRESTã€‚</em></p><p>Ozoneç”±<em>volumesã€bucketså’ŒKeys</em>ç»„æˆï¼Œå…¶ä¸­<br>Volumesåªæœ‰ç®¡ç†å‘˜èƒ½å¤Ÿåˆ›å»ºå’Œåˆ é™¤ï¼Œç±»ä¼¼è´¦å·çš„æ¦‚å¿µï¼Œç®¡ç†å‘˜ä¸€èˆ¬éƒ½æ˜¯ç»™æŸä¸ªå›¢é˜Ÿæˆ–è€…ç»„ç»‡åˆ›å»ºä¸€ä¸ªVolumeã€‚<br>Bucketsæœ‰ç‚¹åƒç›®å½•ï¼Œ<em>ä¸è¿‡è¿™ä¸ªåªèƒ½æœ‰ä¸€å±‚ï¼Œå› ä¸ºBucketsä¸­ä¸èƒ½åŒ…å«å…¶å®ƒBuckets</em>ã€‚Bucketsæ˜¯åœ¨Volumeä¸‹ï¼Œä¸€ä¸ªVolumeå¯ä»¥åŒ…å«nä¸ªBucketsï¼Œ<em>ä½†æ˜¯Bucketsä¸‹é¢åªèƒ½æ˜¯Keys</em>ã€‚<br>Keyså°±æ˜¯å…·ä½“çš„å¯¹è±¡ï¼Œåœ¨Bucketsä¸­æ˜¯å”¯ä¸€çš„ï¼Œå…¶åå­—å¯ä»¥æ˜¯ä»»æ„å­—ç¬¦ä¸²ï¼Œå…¶å€¼å°±æ˜¯éœ€è¦å­˜å‚¨çš„æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å…·ä½“çš„æ–‡ä»¶ã€‚ç›®å‰ozoneå¯¹keyçš„å¤§å°æ²¡æœ‰é™åˆ¶ï¼Œbucketå¯ä»¥åŒ…å«nä¸ªkeysã€‚</p><blockquote><p>æœ‰ä¸ªå°ç–‘é—®â€“keyå°±æ˜¯å¯¹è±¡ï¼Œæ²¡æœ‰ç›®å½•çš„æ¦‚å¿µï¼Œé‚£ä¹ˆåŸhdfsæŸä¸ªç›®å½•ä¸‹çš„nä¸ªå°æ–‡ä»¶å¯¹åº”nä¸ªkeyï¼Ÿå¦‚ä½•ä¸€æ¬¡è¯»å–æ‰€æœ‰ç›¸å…³çš„keyå‘¢ï¼Ÿæ¯”å¦‚hiveåŠ è½½æŸä¸ªåˆ†åŒºå‘¢ï¼Ÿ</p></blockquote><h2 id="è®¾è®¡åŸåˆ™"><a href="#è®¾è®¡åŸåˆ™" class="headerlink" title="è®¾è®¡åŸåˆ™"></a>è®¾è®¡åŸåˆ™</h2><p>Ozoneæ˜¯ç”±ä¸€ç¾¤å¯¹å¤§è§„æ¨¡Hadoopé›†ç¾¤æœ‰ç€ä¸°å¯Œè¿ç»´å’Œç®¡ç†ç»éªŒçš„å·¥ç¨‹å¸ˆè®¾è®¡å¼€å‘çš„ï¼Œå› æ­¤HDFSåœ¨å®è·µä¸­çš„ä¼˜ç¼ºç‚¹æ·±åˆ»çš„å½±å“ç€Ozoneçš„è®¾è®¡å’Œä¼˜åŒ–ã€‚</p><ol><li>Strongly Consistent</li><li>Architectural Simplicity<br>å½“ç³»ç»Ÿå‡ºç°é—®é¢˜æ—¶ï¼Œä¸€ä¸ªç®€å•çš„æ¶æ„æ›´å®¹æ˜“å®šä½ï¼Œä¹Ÿå®¹æ˜“è°ƒè¯•ã€‚Ozoneå°½å¯èƒ½çš„å°†æ¶æ„è¿›è¡Œç®€å•åŒ–ï¼Œå³ä½¿ç‰ºç‰²æ‰ä¸€äº›å¯æ‰©å±•æ€§ï¼Œä½†æ˜¯åœ¨æ‰©å±•æ€§ä¸ŠOzoneå¹¶ä¸é€Šè‰²ã€‚Ozoneç›®å‰åœ¨å•ä¸ªé›†ç¾¤ä¸Šå¯ä»¥å­˜å‚¨10äº¿ä¸ªå¯¹è±¡ã€‚</li><li>Layered Architecture<br>ä¸ºäº†æé«˜Ozoneçš„æ‰©å±•æ€§ï¼ŒOzoneé‡‡ç”¨<em>åˆ†å±‚çš„æ–‡ä»¶ç³»ç»Ÿ</em>ã€‚Ozoneå°†<strong>namespace managementä¸å—å’ŒèŠ‚ç‚¹ç®¡ç†å±‚åˆ†å¼€</strong>ï¼Œå…è®¸ç”¨æˆ·åˆ†åˆ«å¯¹å…¶è¿›è¡Œæ‰©å±•ã€‚</li><li>Painless Recovery</li><li>Open Source in Apache</li><li>Interoperability with Hadoop Ecosystem<br>Ozoneå¯ä»¥è¢«ç°å­˜çš„Hadoopç”Ÿæ€å’Œç›¸å…³çš„åº”ç”¨(å¦‚ apache hiveã€apache spark å’Œä¼ ç»Ÿçš„ mapreduce)ä½¿ç”¨ï¼Œå› æ­¤Ozoneæ”¯æŒ:</li></ol><blockquote><p>Hadoop Compatible FileSystem API(ä¹Ÿå«OzoneFS) â€“ hiveã€sparkç­‰å¯ä»¥ä½¿ç”¨OzoneFS APIå°†Ozoneä½œä¸ºå­˜å‚¨å±‚ï¼Œè€Œä¸éœ€è¦åšä»»åŠ¡ä¿®æ”¹</p></blockquote><blockquote><p>Data Locality â€“ OzoneåƒHDFSé‚£æ ·å¯¹ä¸Šå±‚åº”ç”¨æ”¯æŒæ•°æ®æœ¬åœ°æ€§ã€‚</p></blockquote><blockquote><p>ä¸HDFSå¹¶è¡Œéƒ¨ç½² â€“ Ozoneå¯ä»¥éƒ¨ç½²åœ¨ç°æœ‰çš„Hadoopé›†ç¾¤ä¸­, å¹¶ä¸”å¯ä»¥ä¸HDFSå…±äº«å­˜å‚¨ç£ç›˜ã€‚</p></blockquote><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p>åœ¨æ¶æ„ä¸ŠOzoneç”±ä¸‰éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ä¸º<code>Ozone Manager</code>ã€<code>Storage Container Manager</code>å’Œ<code>Datanodes</code><!--ï¼Œåœ¨ç›®å‰çš„ç‰ˆæœ¬ä¸­è¿˜æœ‰ä¸€ä¸ªç»„ä»¶`Hadoop Distributed Data Store`-->ã€‚æ¶æ„å›¾å¦‚ä¸‹:<br><img src="/blogimgs/ozone%E8%B0%83%E7%A0%94/OzoneOverview.png" alt="OzoneOverview" title="OzoneOverview"></p><blockquote><p>Ozone Manager(OM) </p></blockquote><p>OzoneManageræ˜¯ä¸€ä¸ªserveræœåŠ¡ï¼Œ<em>ä¸»è¦è´Ÿè´£Ozoneçš„namespaceï¼Œè®°å½•æ‰€æœ‰çš„volume, bucketå’Œkeyæ“ä½œ</em>ã€‚<strong>æœ‰ç‚¹ç±»ä¼¼HDFSçš„namenode</strong><br>Ozoneç”±<em>volumesã€bucketså’ŒKeys</em>ç»„æˆï¼Œå…¶ä¸­æ¯ä¸ªvolumeæ˜¯ä¸€ä¸ªnamespaceçš„æ ¹èŠ‚ç‚¹(<em>ä¸HDFSä¸åŒï¼ŒHDFSåªæä¾›äº†ä¸€ä¸ªæ ¹èŠ‚ç‚¹</em>)ï¼Œæ‰€ä»¥<em>æ•´ä¸ªOzoneçš„namespaceæ˜¯ä¸€ä¸ªvolumesçš„é›†åˆæˆ–è€…æ˜¯ä¸€ä¸ªç”±ç±»ä¼¼HDFSé‚£æ ·çš„æ ‘èŠ‚ç‚¹ç»„æˆçš„æ£®æ—</em>ã€‚è¿™ä½¿å¾—OMå¯ä»¥è½»æ¾çš„æ‰©å±•ä¸ºå¤šä¸ªOM(æ­¤åŠŸèƒ½æ­£åœ¨å¼€å‘)ã€‚<br>OMä¸­ä¹Ÿå­˜å‚¨äº†Ozoneçš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ï¼Œè¿™äº›å…ƒæ•°æ®ä¿¡æ¯åŒ…æ‹¬volumesã€bucketså’Œkeysï¼Œ<em>åº•å±‚é€šè¿‡Ratisæ‰©å±•å…ƒæ•°æ®çš„å‰¯æœ¬æ•°æ¥å®ç°HA</em>ã€‚</p><blockquote><p>Storage Container Manager(SCM) </p></blockquote><p>ç±»ä¼¼HDFSä¸­çš„block managerï¼Œæ˜¯Ozoneä¸­ä¸€ä¸ªéå¸¸é‡è¦çš„ç»„ä»¶ï¼Œç”¨æ¥ç®¡ç†containerçš„ï¼Œ<em>ä¸ºOMæä¾›åŸºäºblockå’Œcontainerçš„æœåŠ¡</em>ã€‚<br><strong>containeræ˜¯ç”±ä¸€äº›blockç»„æˆçš„é›†åˆ</strong>ï¼Œè¿™äº›blockç›¸äº’ä¹‹é—´æ²¡æœ‰å…³ç³»ã€‚<br>SCMå’Œæ•°æ®èŠ‚ç‚¹ååŒå·¥ä½œä»¥ç»´æŠ¤ç¾¤é›†æ‰€éœ€çš„å¤åˆ¶çº§åˆ«</p><p>å…³äºSCMçš„ä½œç”¨é€šè¿‡ä¸€ä¸ªä½¿ç”¨å®ä¾‹æ¥è¯´æ˜ä¸‹ â€“ ç”±å®¢æˆ·ç«¯è°ƒç”¨<code>putKey(keyName, data, pipeline type, replication count)</code>å‘èµ·ä¸€ä¸ªputKeyæ“ä½œ</p><p><strong>å‚æ•°è¯´æ˜</strong><br>keyNameæ˜¯æŒ‡æ–‡ä»¶çš„åå­—ã€‚dataæ˜¯æŒ‡è¦å†™å…¥çš„æ•°æ®ã€‚pipeline typeæŒ‡blockçš„å‰¯æœ¬ç­–ç•¥ï¼ŒOzoneç›®å‰æ”¯æŒStand Aloneå’ŒRatisä¸¤ç§ç­–ç•¥ã€‚replication countæ˜¯æŒ‡blockæœ‰å¤šå°‘ä¸ªå‰¯æœ¬<br>ä¸€èˆ¬æƒ…å†µä¸‹pipeline typeå’Œreplication countä¸ç”¨æŒ‡å®šï¼Œç›´æ¥ä½¿ç”¨æ¨¡å¼çš„å°±è¡Œã€‚</p><p><em>æ•´ä¸ªæµç¨‹ä¸ºOMæ”¶åˆ°putKeyè¯·æ±‚ï¼Œå‘SCMå‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚ä¸€ä¸ªåŒ…å«ç‰¹å®šå±æ€§çš„pipelineå®ä¾‹ã€‚ä¾‹å¦‚å®¢æˆ·ç«¯è¦æ±‚Ratiså­˜å‚¨ç­–ç•¥å¹¶ä¸”å‰¯æœ¬æ•°æ˜¯3ï¼Œåˆ™OMè¯·æ±‚SCMè¿”å›ä¸€ä¸ªæ»¡è¶³æ­¤ç‰¹æ€§çš„datanode setã€‚å¦‚æœSCMèƒ½å¤Ÿå®ä¾‹åŒ–è¿™æ ·ä¸€ä¸ªpipeline(ä¹Ÿå°±æ˜¯ä¸€ä¸ªdatanode set)ï¼Œåˆ™å°†è¿™äº›dnè¿”å›ç»™OMã€‚OMåˆ™å­˜å‚¨è¿™äº›ä¿¡æ¯å¹¶å°†æ­¤ä¿¡æ¯åŒ…è£…æˆä¸€ä¸ªå…ƒç»„{BlockID, ContainerName, and Pipeline}ã€‚</em><strong>è¿™é‡Œä¹Ÿæœ‰ç‚¹ç±»ä¼¼HDFSå†™æµç¨‹</strong><br>å¦‚æœSCMå¹¶æ²¡æœ‰æ‰¾åˆ°ä¸€ç»„datanode setæ¥æ»¡è¶³clinetçš„è¦æ±‚ï¼Œ<strong>åˆ™SCMåˆ›å»ºä¸€ä¸ªé€»è¾‘ç®¡é“ï¼Œç„¶åè¿”å›å®ƒ</strong></p><p>ä»ä¸Šé¢çš„è°ƒç”¨è¿‡ç¨‹ä¸­å¯ä»¥çœ‹å‡ºOMä¸SCMçš„å…³ç³»ï¼ŒSCMä½œä¸ºblock managerã€‚å½“clientå‘OMè¯·æ±‚datanode setå†™æ•°æ®æ•°æ®æ—¶ï¼ŒOMéœ€è¦å‘SCMè¯·æ±‚blockã€‚blockä»SCMä»¥pipelineçš„å½¢å¼è¿”å›ï¼Œæ­¤æ—¶pipelineæ˜¯ç”±å‚ä¸blockå‰¯æœ¬çš„ä¸€ç»„datanodeã€‚</p><!-- So OM is dependent on SCM for reading and writing of Keys. However, OM is independent of SCM while doing metadata operations like ozone volume or bucket operations. --><p>SCMä¸»è¦ç”¨æ¥ç®¡ç†blocksã€containerså’Œpipelinesï¼Œä¸ºäº†è¿”å›æ­£å¸¸å¯ç”¨çš„pipelinesï¼ŒSCMå¿…é¡»æ‰¾åˆ°nodeçš„å¥åº·çŠ¶æ€ï¼Œæ‰€ä»¥SCMä¹Ÿä¼šç›‘å¬datanodeå‘æ¥çš„å¿ƒæ€ï¼Œæ‰®æ¼”ç€datanode managerçš„è§’è‰²ã€‚</p><p>SCMå†…éƒ¨ç»“æ„ä¸º:<br><img src="/blogimgs/ozone%E8%B0%83%E7%A0%94/SCMBlockDiagram.png" alt="SCM" title="SCM"></p><p>Blockï¼šblockæ•°æ®å—å¯¹è±¡ï¼ŒçœŸå®å­˜å‚¨æ•°æ®çš„å¯¹è±¡ï¼Œå¯ä»¥æ‹¥æœ‰å¤šä¸ªå‰¯æœ¬å—ã€‚<br>Containerï¼šåœ¨é€»è¾‘ä¸Šå­˜å‚¨çš„æ˜¯Blockå—å¯¹è±¡é›†åˆã€‚<br>Pipelineï¼šSCMå…è®¸2ç§Pipelineæ–¹å¼å®ç°å¤šå‰¯æœ¬ï¼šå•å‰¯æœ¬çš„Standalineæ¨¡å¼å’Œå¤šå‰¯æœ¬çš„Ratisæ–¹å¼ã€‚<br>Poolï¼šä¸€ç»„ç‰¹å®šçš„æ•°æ®èŠ‚ç‚¹ç§°ä¸ºä¸€ä¸ªpoolã€‚å°†èŠ‚ç‚¹æŒ‰poolåˆ†ç»„æ˜¯ä¸ºäº†æ–¹ä¾¿æ—¥å¸¸çš„ç»´æŠ¤å‡çº§æ“ä½œï¼Œä¹Ÿæ˜¯ä¸ºäº†æ‰©å±•æ€§çš„è€ƒè™‘ã€‚<br>Nodeï¼šç‰©ç†å­˜å‚¨æ•°æ®çš„åœ°æ–¹ã€‚</p><blockquote><p>Datanodes</p></blockquote><p>å¦‚æœæ˜¯åŸºäºHDFSéƒ¨ç½²çš„Ozoneä¹Ÿå°±æ˜¯Ozoneæ•°æ®èŠ‚ç‚¹åŠŸèƒ½ä»¥æ’ä»¶çš„åŠŸèƒ½è¿è¡Œåœ¨HDFSçš„datanodeä¸­ï¼Œåˆ™å°±æŒ‡HDFSçš„datanodeã€‚Ozoneä¹Ÿå¯ä»¥å•ç‹¬éƒ¨ç½²ï¼Œæ­¤æ—¶æŒ‡è¿è¡ŒOzoneæ•°æ®èŠ‚ç‚¹çš„å®ˆæŠ¤è¿›ç¨‹ã€‚<strong>DataNodeä¸­ä»¥ContaineråŸºæœ¬å­˜å‚¨å•å…ƒ</strong></p><blockquote><p>Ozone Client</p></blockquote><p>Ozone clientåœ¨Ozoneå†…éƒ¨æ˜¯ä¸€ä¸ªå¯¹å¤–å¼€æ”¾ä½¿ç”¨çš„æ¨¡å—ï¼Œæ¯”å¦‚è¯´Ozoneç›¸å…³çš„shellå‘½ä»¤ä¼šè§¦å‘åˆ°ozone clientï¼Œè¿™å°±æ˜¯å›¾ä¸­æ˜¾ç¤ºçš„Ozone Cliã€‚<br>Rest Handleræ˜¯ä¸€ä¸ªé’©å­ï¼Œèƒ½å¤Ÿåšåˆ°RPCå’ŒRestfulé€šä¿¡æ–¹å¼çš„ä¸€é”®åˆ‡æ¢ã€‚<em>Ozone clientèƒ½å¤Ÿæ”¯æŒ2ç§æ–¹å¼çš„é€šä¿¡ï¼šRPCæ–¹å¼å’ŒRestfulæ¥å£çš„æ–¹å¼ã€‚</em><br>Freonæ˜¯Ozoneå†…éƒ¨çš„æ€§èƒ½æµ‹è¯•å·¥å…·ã€‚</p><blockquote><p>OzoneFileSysyem</p></blockquote><p>Ozoneä¸ºäº†å…¼å®¹å…¶å®ƒæ¡†æ¶ä½“ç³»ï¼Œæ ¹æ®è‡ªèº«ç‹¬ç‰¹çš„æ•°æ®ç‰¹ç‚¹ï¼Œå®ç°äº†æ–‡ä»¶ç³»ç»Ÿæ¥å£ï¼Œç§°ä¸ºOzoneFileSystemã€‚è¿™æ ·çš„è¯ï¼Œç”¨æˆ·å¯ä»¥ä»¥é€šç”¨çš„æ–¹å¼æ¥ä½¿ç”¨Ozoneå†…éƒ¨çš„æ–‡ä»¶å¯¹è±¡ã€‚åœ¨ç¨‹åºä¸Šæ— éœ€åšå…¼å®¹æ€§çš„æ”¹åŠ¨ã€‚</p><blockquote><p>Hadoop Distributed Data Store</p></blockquote><p>ä¸Šé¢çš„æ¶æ„å›¾ä¸­åªå‰©ä¸‹Hadoop Distributed Data Storeæ²¡æœ‰ä»‹ç»äº†ï¼Œå…¶å®<em>Hadoop Distributed Data Store(HDDS)æ˜¯ç”±Containersã€Ratiså’ŒSCMç»„æˆçš„ï¼Œæ˜¯ä¸€ä¸ªæ²¡æœ‰å…¨å±€å‘½åç©ºé—´çš„åˆ†å¸ƒå¼å—å­˜å‚¨å±‚</em>ã€‚</p><p>DataNodes3ä¸ªç»„æˆä¸€ç»„ï¼Œæ¯ç»„éƒ½æ˜¯ä¸€ä¸ªRatiså‰¯æœ¬é“¾ï¼Œæ¯ä¸ªé“¾éƒ½å¯ä»¥æ‰“å¼€å¤šä¸ªcontainersè¿›è¡Œæ“ä½œã€‚</p><p>SCMå®šæœŸä»datanodeä¸Šæ¥å—æŠ¥å‘Šï¼Œé€šçŸ¥æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰“å¼€å’Œå…³é—­çš„å®¹å™¨å‰¯æœ¬ã€‚åŸºäºæ¯æ¬¡æŠ¥å‘Šçš„å†…å®¹åˆ¶å®šä¸€äº›å†³å®šï¼Œä¾‹å¦‚å¦‚ä½•åˆ†é…æ–°containerã€å…³é—­æ‰“å¼€çš„containerså’Œåœ¨ç£ç›˜/æ•°æ®ä¸¢å¤±æ—¶é‡æ–°å¤åˆ¶å°é—­å®¹å™¨ã€‚</p><p>SCM Clientså¯ä»¥å‘SCMè¯·æ±‚æ–°å—çš„åˆ†é…èŠ‚ç‚¹ï¼Œç„¶åå°†å—æ•°æ®å†™å…¥åˆ†é…çš„å®¹å™¨ä¸­ã€‚Clientsè¿˜å¯ä»¥è¯»å–open/closedçŠ¶æ€çš„å®¹å™¨ï¼Œå¹¶ä¸”å¯ä»¥åˆ é™¤å—ã€‚<em>å…³é”®çš„ä¸€ç‚¹æ˜¯, HDDS å¹¶ä¸å…³å¿ƒå•ä¸ªå®¹å™¨çš„å†…å®¹ã€‚å†…å®¹å®Œå…¨ç”±SCMç®¡ç†</em>ã€‚</p><p>HDDSç»†èŠ‚å›¾å¦‚ä¸‹:<br><img src="/blogimgs/ozone%E8%B0%83%E7%A0%94/HDDS.png" alt="HDDS" title="HDDS"></p><h2 id="éƒ¨ç½²åŠæµ‹è¯•"><a href="#éƒ¨ç½²åŠæµ‹è¯•" class="headerlink" title="éƒ¨ç½²åŠæµ‹è¯•"></a>éƒ¨ç½²åŠæµ‹è¯•</h2><p>Ozoneä¸HDFSç»“åˆçš„è¯éœ€è¦åŸºäºHadoop3.0ï¼Œæ‰€ä»¥éœ€è¦å…ˆéƒ¨ç½²Hadoop3.0ï¼Œå…·ä½“éƒ¨ç½²ç»†èŠ‚åœ¨æ­¤ç•¥å»ä¸è¡¨ã€‚</p><p>ä»å®˜æ–¹ä¸‹è½½Hadoop3.0å’ŒOzoneçš„å®‰è£…åŒ…(ç”±äºå®˜æ–¹buildçš„Hadoop3.0ä¸­å¹¶æ²¡æœ‰Ozoneç›¸å…³çš„å†…å®¹ï¼Œæ‰€ä»¥éœ€è¦å•ç‹¬ä¸‹è½½Ozoneçš„å®‰è£…åŒ…)ï¼Œå°†Ozoneçš„ç›¸å…³å†…å®¹å¤åˆ¶åˆ°Hadoopçš„homeç›®å½•ã€‚å‘½ä»¤å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨Ozoneçš„homeç›®å½•ä¸‹æ‰§è¡Œ</span></span><br><span class="line">cp libexec/ozone-config.sh /opt/soft/hadoop/libexec</span><br><span class="line">cp -r share/ozone /opt/soft/hadoop/share</span><br><span class="line">cp -r share/hadoop/ozoneplugin /opt/soft/hadoop/share/hadoop/</span><br></pre></td></tr></table></figure><p>åˆ©ç”¨Ozoneçš„å‘½ä»¤ç”Ÿæˆconfæ–‡ä»¶ï¼Œ<code>ozone genconf etc/hadoop</code>ï¼Œæ­¤å‘½ä»¤ä¼šç”Ÿæˆozone-site.xmlæ–‡ä»¶ï¼Œä¿®æ”¹é…ç½®ä¹‹åå¤åˆ¶åˆ°Hadoop3.0çš„confç›®å½•ä¸­ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; standalone=&quot;yes&quot;?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>ozone.enabled<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>true<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>OZONE, REQUIRED<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">      Status of the Ozone Object Storage service is enabled.</span><br><span class="line">      Set to true to enable Ozone.</span><br><span class="line">      Set to false to disable Ozone.</span><br><span class="line">      Unless this value is set to true, Ozone services will not be started in</span><br><span class="line">      the cluster.</span><br><span class="line"></span><br><span class="line">      Please note: By default ozone is disabled on a hadoop cluster.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>ozone.om.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>OM, REQUIRED<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">      The address of the Ozone OM service. This allows clients to discover</span><br><span class="line">      the address of the OM.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>ozone.metadata.dirs<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>/opt/hadoop/ozone<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>OZONE, OM, SCM, CONTAINER, REQUIRED, STORAGE<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">      Ozone metadata is shared among OM, which acts as the namespace</span><br><span class="line">      manager for ozone, SCM which acts as the block manager and data nodes</span><br><span class="line">      which maintain the name of the key(Key Name and BlockIDs). This</span><br><span class="line">      replicated and distributed metadata store is maintained under the</span><br><span class="line">      directory pointed by this key. Since metadata can be I/O intensive, at</span><br><span class="line">      least on OM and SCM we recommend having SSDs. If you have the luxury</span><br><span class="line">      of mapping this path to SSDs on all machines in the cluster, that will</span><br><span class="line">      be excellent.</span><br><span class="line"></span><br><span class="line">      If Ratis metadata directories are not specified, Ratis server will emit a</span><br><span class="line">      warning and use this path for storing its metadata too.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>ozone.scm.client.address<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>OZONE, SCM, REQUIRED<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">      The address of the Ozone SCM client service. This is a required setting.</span><br><span class="line"></span><br><span class="line">      It is a string in the host:port format. The port number is optional</span><br><span class="line">      and defaults to 9860.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">name</span>&gt;</span>ozone.scm.names<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">value</span>&gt;</span>localhost<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tag</span>&gt;</span>OZONE, REQUIRED<span class="tag">&lt;/<span class="name">tag</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">description</span>&gt;</span></span><br><span class="line">      The value of this property is a set of DNS | DNS:PORT | IP</span><br><span class="line">      Address | IP:PORT. Written as a comma separated string. e.g. scm1,</span><br><span class="line">      scm2:8020, 7.7.7.7:7777.</span><br><span class="line">      This property allows datanodes to discover where SCM is, so that</span><br><span class="line">      datanodes can send heartbeat to SCM.</span><br><span class="line">    <span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">name</span>&gt;</span>ozone.replication<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">value</span>&gt;</span>1<span class="tag">&lt;/<span class="name">value</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br></pre></td></tr></table></figure><blockquote><p>éœ€è¦å°†ozoneç›¸å…³çš„jarå¼•å…¥åˆ°classpathä¸­ï¼Œåœ¨user homeç›®å½•ä¸‹å¢åŠ .hadooprcæ–‡ä»¶</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim ~/.hadooprc</span><br><span class="line">HADOOP_CLASSPATH=/opt/soft/hadoop/share/hadoop/yarn/*.jar:/opt/soft/hadoop/share/hadoop/tools/*.jar:/opt/soft/hadoop/share/hadoop/ozoneplugin/*.jar:/opt/soft/hadoop/share/hadoop/ozone/*.jar:/opt/soft/hadoop/share/hadoop/mapreduce/*.jar:/opt/soft/hadoop/share/hadoop/hdfs/*.jar:/opt/soft/hadoop/share/hadoop/common/*.jar:/opt/soft/hadoop/share/hadoop/client/*.jar:/opt/soft/hadoop/share/hadoop/yarn/lib/*.jar:/opt/soft/hadoop/share/hadoop/tools/lib/*.jar:/opt/soft/hadoop/share/hadoop/ozoneplugin/lib/*.jar:/opt/soft/hadoop/share/hadoop/ozone/lib/*.jar:/opt/soft/hadoop/share/hadoop/mapreduce/lib/*.jar:/opt/soft/hadoop/share/hadoop/hdfs/lib/*.jar:/opt/soft/hadoop/share/hadoop/common/lib/*.jar:/opt/soft/hadoop/share/hadoop/client/lib/*.jar</span><br></pre></td></tr></table></figure><p>å¦‚æœå°†Ozoneè¿è¡Œåœ¨HDFSä¹‹ä¸Šçš„è¯ï¼Œéœ€è¦åœ¨hdfs-site.xmlä¸­æ·»åŠ å¦‚ä¸‹å†…å®¹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">   &lt;name&gt;dfs.datanode.plugins&lt;/name&gt;</span><br><span class="line">   &lt;value&gt;org.apache.hadoop.ozone.HddsDatanodeService&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±å¯ä»¥å¯åŠ¨ç›¸å…³çš„æœåŠ¡äº†ï¼Œé¦–å…ˆå¯åŠ¨namenodeå’Œdatanodeï¼Œå‘½ä»¤ä¸º<code>hdfs --daemon start namenode</code>å’Œ<code>hdfs --daemon start datanode</code><br>å…¶æ¬¡å¯åŠ¨scmå’Œomï¼Œ<em>è¦å…ˆå¯åŠ¨scmå†å¯åŠ¨omï¼Œè€Œä¸”åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨çš„æ—¶å€™è¦å…ˆåˆå§‹åŒ–</em>ï¼Œå‘½ä»¤å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ozone scm --init</span><br><span class="line">ozone --daemon start scm</span><br><span class="line">ozone om --init</span><br><span class="line">ozone --daemon start om</span><br></pre></td></tr></table></figure><p><em>ä¸€åˆ‡æ­£å¸¸å°±å¯ä»¥åœ¨OMçš„UIä¸ŠæŸ¥çœ‹ä¿¡æ¯ï¼ŒOMé»˜è®¤ç«¯å£ä¸Š9874ï¼Œåœ°å€ä¸º<a href="http://omserver:9874/">http://omserver:9874/</a></em></p><p>æˆ‘ä»¬å¯ä»¥è¿è¡Œä¸€äº›å‘½ä»¤æ¥æ„Ÿå—ä¸‹Ozoneï¼Œ<br>åˆ›å»ºä¸€ä¸ªvolumeå¹¶ä¸”æŸ¥çœ‹</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">ozone sh volume create --user=work /hive-ozone</span><br><span class="line"></span><br><span class="line">ozone sh volume list --user work</span><br><span class="line"><span class="attr">SLF4J</span>: Class path contains multiple SLF4J bindings.</span><br><span class="line"><span class="attr">SLF4J</span>: Found binding <span class="keyword">in</span> [jar:file:<span class="regexp">/opt/</span>soft/hadoop-<span class="number">3.2</span><span class="number">.0</span>/share/hadoop/common/lib/slf4j-log4j12-<span class="number">1.7</span><span class="number">.25</span>.jar!<span class="regexp">/org/</span>slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line"><span class="attr">SLF4J</span>: Found binding <span class="keyword">in</span> [jar:file:<span class="regexp">/opt/</span>soft/hadoop-<span class="number">3.2</span><span class="number">.0</span>/share/ozone/lib/slf4j-log4j12-<span class="number">1.7</span><span class="number">.25</span>.jar!<span class="regexp">/org/</span>slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line"><span class="attr">SLF4J</span>: Found binding <span class="keyword">in</span> [jar:file:<span class="regexp">/opt/</span>soft/hadoop-<span class="number">3.2</span><span class="number">.0</span>/share/hadoop/ozone/lib/slf4j-log4j12-<span class="number">1.7</span><span class="number">.25</span>.jar!<span class="regexp">/org/</span>slf4j/impl/StaticLoggerBinder.class]</span><br><span class="line"><span class="attr">SLF4J</span>: See http:<span class="comment">//www.slf4j.org/codes.html#multiple_bindings for an explanation.</span></span><br><span class="line">SLF4J: Actual binding is <span class="keyword">of</span> type [org.slf4j.impl.Log4jLoggerFactory]</span><br><span class="line"><span class="number">2019</span>-<span class="number">01</span>-<span class="number">29</span> <span class="number">15</span>:<span class="number">33</span>:<span class="number">52</span>,<span class="number">786</span> WARN util.NativeCodeLoader: Unable to load native-hadoop library <span class="keyword">for</span> your platform... using builtin-java classes where applicable</span><br><span class="line">[ &#123;</span><br><span class="line">  <span class="string">&quot;owner&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span> : <span class="string">&quot;work&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;quota&quot;</span> : &#123;</span><br><span class="line">    <span class="string">&quot;unit&quot;</span> : <span class="string">&quot;TB&quot;</span>,</span><br><span class="line">    <span class="string">&quot;size&quot;</span> : <span class="number">1048576</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">&quot;volumeName&quot;</span> : <span class="string">&quot;hive-ozone&quot;</span>,</span><br><span class="line">  <span class="string">&quot;createdOn&quot;</span> : <span class="string">&quot;æ˜ŸæœŸäºŒ, 29 ä¸€æœˆ 2019 07:32:27 GMT&quot;</span>,</span><br><span class="line">  <span class="string">&quot;createdBy&quot;</span> : <span class="string">&quot;work&quot;</span></span><br><span class="line">&#125; ]</span><br></pre></td></tr></table></figure><p>å†æ¥åˆ›å»ºä¸€ä¸ªbucketï¼Œ<code>ozone sh bucket create /hive-ozone/bucket-test</code></p><p>åˆ›å»ºå®Œvolumeå’Œbucketï¼Œå°±å¯ä»¥ä¸Šä¼ æ–‡ä»¶äº†ï¼Œä¹Ÿå°±æ˜¯åˆ›å»ºä¸€ä¸ªkeyï¼ŒOzoneå‘½ä»¤ä¸º<code>ozone sh key put /hive-ozone/bucket-test/hadoop.log logs/hadoop.log</code>ï¼Œ<br>ä¹Ÿå¯ä»¥åƒhdfs shellé‚£æ ·ä¸Šä¼ keyï¼Œå‘½ä»¤ä¸º<code>ozone fs -put logs/hadoop.log o3fs://bucket-test.hive-ozone/t.log</code></p><!--å„ç”¨æˆ·ä¹‹é—´å¦‚ä½•å…±äº«æ•°æ®Ozoneå¦‚ä½•è‡ªåŠ¨è¯†åˆ«å°æ–‡ä»¶ï¼Ÿ--><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://cwiki.apache.org/confluence/display/HADOOP/Building+Ozone">https://cwiki.apache.org/confluence/display/HADOOP/Building+Ozone</a><br><a href="https://hortonworks.com/blog/introducing-apache-hadoop-ozone-object-store-apache-hadoop/">https://hortonworks.com/blog/introducing-apache-hadoop-ozone-object-store-apache-hadoop/</a><br><a href="https://hortonworks.com/blog/apache-hadoop-ozone-object-store-overview/">https://hortonworks.com/blog/apache-hadoop-ozone-object-store-overview/</a><br><a href="https://hadoop.apache.org/ozone/docs/0.3.0-alpha/index.html">https://hadoop.apache.org/ozone/docs/0.3.0-alpha/index.html</a><br><a href="https://hortonworks.com/blog/apache-hadoop-ozone-object-store-architecture/">https://hortonworks.com/blog/apache-hadoop-ozone-object-store-architecture/</a><br><a href="https://blog.csdn.net/Androidlushangderen/article/details/78168479">https://blog.csdn.net/Androidlushangderen/article/details/78168479</a></p><!--To scale Ozone to billions of files, we needed to solve two bottlenecks that exist in HDFS.2.1. NAMESPACE SCALABILITYWe can no longer store the entire namespace in the memory of a single node. The key insight is that the namespace has locality of reference so we can store just the working set in memory. The namespace is managed by a service called the Ozone Manager.2.2. BLOCK MAP SCALABILITYThis is a harder problem to solve. Unlike the namespace, the block map does not have locality of reference since storage nodes (DataNodes) periodically send block reports about each block in the system. Ozone delegates this problem to a shared generic storage layer called Hadoop Distributed DataStore (HDDS).-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> å°æ–‡ä»¶ </tag>
            
            <tag> Ozone </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSå°æ–‡ä»¶åˆå¹¶å®æˆ˜</title>
      <link href="/HDFS-little-file-action.html"/>
      <url>/HDFS-little-file-action.html</url>
      
        <content type="html"><![CDATA[<p>HDFSæ˜¯ä¸€ä¸ªå¤§æ•°æ®å­˜å‚¨ç³»ç»Ÿï¼Œä¸»è¦é¢å‘çš„åœºæ™¯æ˜¯ä¸€æ¬¡å†™å…¥å¤šæ¬¡è¯»å–ï¼Œå¤§æ–‡ä»¶ã€‚ä½†æ˜¯åœ¨å®é™…ä½¿ç”¨è¿‡ç¨‹ä¸­ç”±äºå„ç§åŸå› é›†ç¾¤ä¸­æ€»æ˜¯å……æ–¥ç€å„ç§å°æ–‡ä»¶ï¼Œè€Œä¸”æ•°æ®æƒŠäººã€‚æ— è®ºç¤¾åŒºè¿˜æ˜¯å…¬å¸éƒ½åœ¨ç§¯æè§£å†³è¿™ä¸ªé—®é¢˜ã€‚(ä¸ºä»€ä¹ˆè¦è§£å†³å°æ–‡ä»¶ï¼Œè¿™ä¸ªé—®é¢˜æˆ‘æƒ³çœ‹åˆ°è¿™ç¯‡æ–‡ç« çš„äººåº”è¯¥éƒ½çŸ¥é“å•Š!)</p><p>æ— è®ºä½ æ€ä¹ˆä¼˜åŒ–é›†ç¾¤ï¼ŒæŒ‡å®šå„ç§è§„èŒƒï¼Œè®©ä¸šåŠ¡æ–¹ä¼˜åŒ–ç¨‹åºï¼Œå°æ–‡ä»¶æ€»æ˜¯æ— æ³•é¿å…çš„ã€‚</p><span id="more"></span><p>éƒ½è¯´è§£å†³ä¸€ä¸ªé—®é¢˜ï¼Œä¸èƒ½åªä»è¡¨é¢å»è§£å†³ï¼Œéœ€è¦ä»æ ¹ä¸Šå½»åº•è§£å†³ï¼Œéœ€è¦æ ¹æ®äº§ç”Ÿé—®é¢˜çš„nä¸ªåŸå› å»è§£å†³ï¼Œä½†æ˜¯è¿™ç§æ–¹å¼å¯¹ç›®å‰å°æ–‡ä»¶è¿™ä¸ªé—®é¢˜ä¸Šç¡®å®ä¸å¥½åŠã€‚å³ä½¿ä½ çŸ¥é“å°æ–‡ä»¶äº§ç”Ÿè¿‡å¤šçš„åŸå› å¾ˆå¤§ä¸€éƒ¨åˆ†å½’ç»“äºç”¨æˆ·çš„åº”ç”¨ç¨‹åº¦åœ¨æ‰§è¡Œçš„æ—¶å€™æ²¡æœ‰å¾ˆå¥½çš„é¢„ä¼°å†™å‡ºæ•°æ®é‡çš„è§„æ¨¡ï¼Œå¯¼è‡´å†™å‡ºè¿‡å¤šçš„å°æ–‡ä»¶ã€‚ä½ ä¾ç„¶æ— æ³•ä»æ ¹ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå› ä¸ºä½ è¦æƒ³ä»æ ¹ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜éœ€è¦ç”¨æˆ·å¯¹è‡ªå·±ç¨‹åºçš„é€»è¾‘å’Œæ•°æ®æœ‰è¾ƒé«˜çš„äº†è§£ï¼Œè€Œä¸”ç”¨æˆ·çš„æ°´å¹³ä¹Ÿå‚å·®ä¸é½ï¼Œ<em>æœ€æœ€é‡è¦çš„æ˜¯ç”¨æˆ·è®¤ä¸ºè¿™æ˜¯å°¼ç›å¹³å°è¯¥ä¼˜åŒ–çš„äº‹ï¼Œå¹²æ¯›æµªè´¹æˆ‘çš„æ—¶é—´ç»™ä½ æ</em>ã€‚æ‰€ä»¥ç§ç§åŸå› é€ æˆæ”¶ç›Šè¾ƒå°‘ã€‚</p><p>ä¸èƒ½ä»æ ¹ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œé‚£å°±åªèƒ½ä»é¢ä¸Šè§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚æ€ä¹ˆè§£å†³ï¼Ÿé‚£å°±æ˜¯å®šæœŸå¯¹å°æ–‡ä»¶è¿›è¡Œåˆå¹¶(æ˜¯ä¸æ˜¯æ¯”è¾ƒlowï¼Œå˜¿å˜¿)ã€‚</p><h2 id="åˆå¹¶æ–¹æ¡ˆ"><a href="#åˆå¹¶æ–¹æ¡ˆ" class="headerlink" title="åˆå¹¶æ–¹æ¡ˆ"></a>åˆå¹¶æ–¹æ¡ˆ</h2><ol><li>Hadoop Archives<br>å¾ˆæ—©æå‡ºçš„ä¸€ç§è§£å†³æ–¹æ¡ˆï¼ŒæŠŠå†å²æ•°æ®è¿›è¡Œå½’æ¡£ã€‚<em>ä¸ªäººæ„Ÿè§‰æ¯”è¾ƒé¸¡è‚‹ï¼Œä¸æ€ä¹ˆå¥½ç”¨</em>ã€‚</li><li>SequenceFile<br>SequenceFileæ˜¯hadoopçš„ä¸€ç§äºŒè¿›åˆ¶æ–‡ä»¶ï¼Œéšç€Hadoopçš„é—®ä¸–å°±å‡ºç°äº†ï¼Œå½“æ—¶ä¸»è¦ç”¨æ¥å­˜å‚¨ä¸€äº›mrçš„ä¸­é—´ç»“æœã€‚å› ä¸ºå…¶ä¹Ÿæ˜¯key/valueå½¢å¼å­˜å‚¨çš„ï¼Œæ‰€ä»¥ç°åœ¨ä¹Ÿæœ‰å¾ˆå¤šå…¬å¸ä½¿ç”¨SequenceFileæ¥å­˜å‚¨å°æ–‡ä»¶ï¼Œkeyæ˜¯æ–‡ä»¶åï¼Œvalueæ˜¯å†…å®¹ã€‚<em>è¿™ç§æ–¹å¼è¾ƒä¾èµ–ä½¿ç”¨çš„åœºæ™¯ï¼Œæ„Ÿè§‰ä¸æ˜¯ä¸€ä¸ªæ™®é€‚çš„è§£å†³æ–¹æ¡ˆ</em>ã€‚</li><li>ä¸šåŠ¡æ–¹ä¼˜åŒ–ä»£ç <br>ä¸šåŠ¡æ–¹åœ¨ä»£ç ä¸­æ ¹æ®æ•°æ®é‡æ§åˆ¶åˆ†åŒºçš„ä¸ªæ•°ï¼Œç›´æ¥ä»æºå¤´è§£å†³å°æ–‡ä»¶é—®é¢˜ã€‚<em>è¿™ç§æ–¹æ¡ˆå¤ªç†æƒ³ï¼Œè¿›åº¦æ— æ³•æŠŠæ§ï¼Œè€Œä¸”å°æ–‡ä»¶æ€»ä¼šåœ¨æ–°ä¸Šçº¿çš„ç¨‹åºä¸­å¤ç°</em></li><li>å¹³å°å®šæœŸåˆå¹¶<br>ç¼–å†™åˆå¹¶å°æ–‡ä»¶çš„å°å·¥å…·ï¼Œå¯¹é›†ç¾¤ä¸­å°æ–‡ä»¶topçš„ç›®å½•è¿›è¡Œå®šæœŸè‡ªåŠ¨åˆå¹¶ã€‚<em>å®ç°æ–¹å¼è¾ƒç®€å•ï¼Œè€Œä¸”å®¹æ˜“æŠŠæ§ï¼Œä¸»åŠ¨æƒåœ¨å¹³å°æ‰‹é‡Œ</em></li><li>é»‘ç§‘æŠ€<br>å®æ—¶å…³æ³¨ä¸šç•ŒåŠ¨æ€ï¼ŒæœŸå¾…ç¤¾åŒºæä¾›é»‘ç§‘æŠ€å®Œç¾è§£å†³å°æ–‡ä»¶é—®é¢˜ã€‚<em>ç›®å‰ç¤¾åŒºæä¾›äº†ä¸€ä¸ªOzoneå¯¹è±¡å­˜å‚¨ç³»ç»Ÿï¼Œè¿˜ä¸å¤ªå®Œå–„ï¼ŒæŒç»­å…³æ³¨ä¸­ï¼Œéšåå†™ä¸ªç®€å•çš„è°ƒç ”ç»“æœ</em>ã€‚</li></ol><h2 id="åˆå¹¶å®è·µ"><a href="#åˆå¹¶å®è·µ" class="headerlink" title="åˆå¹¶å®è·µ"></a>åˆå¹¶å®è·µ</h2><p>åˆ©ç”¨å·¥å…·åˆå¹¶å°æ–‡ä»¶æ—¶ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ä¸åŒæ–‡ä»¶ç±»å‹çš„åˆå¹¶æ–¹å¼ä¸ä¸€æ ·ï¼Œæ‰€ä»¥åœ¨åˆå¹¶ä¹‹å‰éœ€è¦çŸ¥é“æ–‡ä»¶çš„ç±»å‹ä»è€Œé€‰æ‹©åˆé€‚çš„æ–¹æ³•å»åˆå¹¶ã€‚</p><p>ç›®å‰å¹³å°ä¸­çš„æ–‡ä»¶ç±»å‹ä¸»è¦ä¸º3ä¸­ï¼Œåˆ†åˆ«ä¸ºæ™®é€šæ–‡æœ¬ã€lzoå‹ç¼©æ–‡ä»¶å’Œparquetåˆ—å­˜å‚¨æ–‡ä»¶ï¼Œæ‰€ä»¥è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹ä¹Ÿå°±æ˜¯è‡ªåŠ¨æ–‡ä»¶çš„ç¼–ç æ ¼å¼ã€‚</p><blockquote><p>è‡ªåŠ¨è¯†åˆ«æ–‡ä»¶ç±»å‹</p></blockquote><ol><li>æ ¹æ®å‹ç¼©æ ¼å¼ä¸­åºåˆ—åŒ–çš„ç‰¹æ®Šä¿¡æ¯è¯†åˆ«å‹ç¼©æ ¼å¼ï¼Œå¦‚parquetæ–‡ä»¶çš„å¤´ä¸ºâ€™PAR1â€™</li><li>æ ¹æ®æ–‡ä»¶çš„åç¼€åè¿›è¡Œè¯†åˆ«ï¼Œå¦‚lzoçš„æ–‡ä»¶éƒ½æœ‰åç¼€ </li></ol><p><strong>ä¸ªäººæ„Ÿè§‰è¯†åˆ«æ–‡ä»¶ç±»å‹æœ€å¥½çš„æ–¹æ³•æ˜¯é€šè¿‡åç¼€åï¼Œé€šè¿‡æ”¹Hadoopå’ŒHiveçš„ä»£ç ï¼Œå¯¹æ™®é€šæ–‡æœ¬å¢åŠ åç¼€.txtï¼Œparquetæ–‡ä»¶å¢åŠ åç¼€.parquet</strong>ï¼Œç›®å‰æš‚æ—¶ä½¿ç”¨çš„é€šè¿‡è¯»å–æ–‡ä»¶å¤´ä¿¡æ¯çš„æ–¹å¼æ¥è¯†åˆ«æ–‡ä»¶ç±»å‹ï¼Œåªæ‰€ä»¥æ²¡æœ‰ä½¿ç”¨å¢åŠ åç¼€çš„æ–¹å¼æ˜¯å› ä¸ºè¿™ç§æ–¹å¼éœ€è¦è¿›è¡Œè¾ƒå…¨é¢çš„æµ‹è¯•ï¼Œä¸ºäº†å¿«é€ŸéªŒè¯åˆå¹¶å°æ–‡ä»¶çš„å¯è¡Œæ€§é€‰æ‹©äº†è¯†åˆ«æ–‡ä»¶å¤´çš„æ–¹å¼ã€‚</p><blockquote><p>åˆå¹¶æ–¹å¼</p></blockquote><ol><li>æ™®é€šæ–‡æœ¬å’Œlzoæ–‡ä»¶åˆ©ç”¨<code>CombineFileInputFormat</code>å°†åŒä¸€ç›®å½•ä¸‹çš„å°æ–‡ä»¶åˆå¹¶è¯»å–ï¼Œç„¶åè°ƒç”¨<code>CombineTextInputFormat.setMaxInputSplitSize</code>æ ¹æ®è¯»å–æ–‡ä»¶çš„å¤§å°è¿›è¡Œåˆ‡åˆ†ï¼Œç„¶åç›´æ¥é€šè¿‡mapè¾“å‡ºï¼Œè¾¾åˆ°å°æ–‡ä»¶æ ¹æ®æœŸæœ›è¾“å‡ºæ–‡ä»¶çš„å¤§å°è¿›è¡Œåˆå¹¶çš„æ•ˆæœã€‚</li><li>parquetåˆ—å­˜å‚¨æ–‡ä»¶æœ‰ç‚¹ç‰¹æ®Šï¼Œç›®å‰æœ€å¥½çš„æ–¹æ³•æ˜¯ä½¿ç”¨spark apiè¿›è¡Œè¯»å–ï¼Œç„¶åé€šè¿‡<code>repartition</code>è¿›è¡Œåˆå¹¶ã€‚repartitionçš„ä¸ªæ•°å¯ä»¥é€šè¿‡è¾“å…¥æ–‡ä»¶çš„æ€»å¤§å°å’ŒæœŸæœ›è¾“å‡ºæ–‡ä»¶çš„å¤§å°è¿›è¡Œé¢„è®¡ç®—è€Œå¾—ã€‚</li></ol><p>è¿™æ ·åˆæœŸç”±å¹³å°ç»Ÿä¸€è¿›è¡Œåˆå¹¶(<em>è¿™é‡Œåˆå¹¶åªèƒ½å¯¹å†å²æ–‡ä»¶è¿›è¡Œåˆå¹¶</em>)ï¼Œéšåå¯ä»¥æ…¢æ…¢ç£ä¿ƒå„ä¸ªä¸šåŠ¡è¿›è¡Œä¼˜åŒ–ï¼Œå…ˆè§£å†³ç‡ƒçœ‰ä¹‹æ€¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> å°æ–‡ä»¶ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Merkle Patricia Tree(MPT)</title>
      <link href="/Merkle-Patricia-Tree.html"/>
      <url>/Merkle-Patricia-Tree.html</url>
      
        <content type="html"><![CDATA[<p>åŒºå—é“¾ä¸€ä¸ªé‡è¦çš„äº®ç‚¹å°±æ˜¯é˜²ç¯¡æ”¹ï¼Œé‚£ä¹ˆå®ƒæ˜¯æ€ä¹ˆåšåˆ°é˜²ç¯¡æ”¹çš„å‘¢ï¼Ÿå…¶ä¸­ä¸€ä¸ªé‡è¦çš„çŸ¥è¯†ç‚¹å°±æ˜¯Merkle Patricia Tree(MPT)ï¼Œæœ¬ç¯‡å°±æ¥è§£æä¸‹ä½•ä¸ºMPTã€‚</p><p>MPTæ˜¯ä¸€ç§åŠ å¯†è®¤è¯çš„æ•°æ®ç»“æ„ï¼Œå®ƒèåˆäº†Merkleæ ‘å’ŒPatricia Trieæ ‘(åŸºæ•°æ ‘/å‹ç¼©å‰ç¼€æ ‘)ä¸¤ç§æ•°æ®ç±»å‹çš„ä¼˜ç‚¹ã€‚</p><p>åˆ™åœ¨ä»‹ç»MPTæ ‘ä¹‹å‰å…ˆä»‹ç»ä¸‹Merkleæ ‘(é»˜å…‹å°”æ ‘)ã€Trieæ ‘(å‰ç¼€æ ‘)å’ŒPatricia Trie(åŸºæ•°æ ‘/å‹ç¼©å‰ç¼€æ ‘)ï¼Œä»‹ç»Trieæ ‘æ˜¯å› ä¸ºPatricia Trieæ˜¯åŸºäºTrieæ ‘è¡åŒ–æ¥çš„ã€‚</p><span id="more"></span><h2 id="Trieæ ‘"><a href="#Trieæ ‘" class="headerlink" title="Trieæ ‘"></a>Trieæ ‘</h2><p>Trieæ ‘åˆç§°å‰ç¼€æ ‘æˆ–å­—å…¸æ ‘ï¼Œæ˜¯ä¸€ç§æ£€ç´¢æ ‘ï¼Œä½¿ç”¨ä¸€ä¸ªæœ‰åºçš„æ ‘ç»“æ„å­˜å‚¨ä¸€ä¸ªåŠ¨æ€æ•°æ®é›†æˆ–è€…å…³è”æ•°ç»„ï¼Œå…¶ä¸­çš„é”®é€šå¸¸æ˜¯å­—ç¬¦ä¸²ã€‚ä¸äºŒå‰æŸ¥æ‰¾æ ‘ä¸åŒï¼Œé”®ä¸æ˜¯ç›´æ¥ä¿å­˜åœ¨èŠ‚ç‚¹ä¸­ï¼Œè€Œæ˜¯ç”±èŠ‚ç‚¹åœ¨æ ‘ä¸­çš„ä½ç½®å†³å®šã€‚ä¸€ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­å­™ç›¸å¯¹äºå½“å‰èŠ‚ç‚¹éƒ½æœ‰ç›¸åŒçš„å‰ç¼€ï¼Œè€Œæ ¹èŠ‚ç‚¹ä¸ºç©ºå­—ç¬¦ä¸²ã€‚ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œä¸æ˜¯æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½æœ‰å¯¹åº”çš„å€¼ï¼Œåªæœ‰å¶å­èŠ‚ç‚¹å’Œéƒ¨åˆ†å†…éƒ¨èŠ‚ç‚¹æ‰€å¯¹åº”çš„é”®æ‰æœ‰ç›¸å…³çš„å€¼ã€‚</p><p>Trieæ ‘ä¸­ï¼Œkeyæ˜¯ä»æ ‘æ ¹åˆ°å¯¹åº”valueå¾—çœŸå®çš„è·¯å¾„ã€‚å³ä»æ ¹èŠ‚ç‚¹å¼€å§‹ï¼Œkeyä¸­çš„æ¯ä¸ªå­—ç¬¦ä¼šæ ‡è¯†èµ°é‚£ä¸ªå­èŠ‚ç‚¹ä»è€Œåˆ°è¾¾ç›¸åº”valueã€‚Valueè¢«å­˜å‚¨åœ¨å¶å­èŠ‚ç‚¹ï¼Œæ˜¯æ¯æ¡è·¯å¾„çš„ç»ˆæ­¢ã€‚å‡å¦‚keyæ¥è‡ªä¸€ä¸ªåŒ…å«Nä¸ªå­—ç¬¦çš„å­—æ¯è¡¨ï¼Œé‚£ä¹ˆæ ‘ä¸­çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½å¯èƒ½ä¼šæœ‰å¤šè¾¾Nä¸ªå­©å­ï¼Œæ ‘çš„æœ€å¤§æ·±åº¦æ˜¯keyçš„æœ€å¤§é•¿åº¦ã€‚çœ‹ä¸ªä¾‹å­ç”»ä¸ªå›¾å°±äº†ç„¶äº†ã€‚<br>ä¾‹å­ï¼šå…³é”®å­—é›†åˆ{â€œaâ€, â€œtoâ€, â€œteaâ€, â€œtedâ€, â€œiâ€, â€œinâ€, â€œinnâ€}ï¼Œæ­¤é›†åˆè½¬ä¸ºTrieæ ‘ä¸º<br><img src="/blogimgs/MPT/trie.png" alt="tire" title="Trieæ ‘"></p><p>ä¸ç†æƒ³æƒ…å†µä¸‹ï¼Œæ•°æ®é›†ä¸­å­˜åœ¨ä¸€ä¸ªå¾ˆé•¿çš„keyï¼Œè€Œè¿™ä¸ªkeyä¸å…¶å®ƒkeyåˆæ²¡æœ‰å¤ªå¤šçš„å…¬å…±å‰ç¼€ï¼Œè¿™å°±é€ æˆæ•´ä¸ªæ ‘çš„æ·±åº¦ä¼šåŠ å¤§ï¼Œéœ€è¦å­˜å‚¨å¤šä¸ªèŠ‚ç‚¹ï¼Œå­˜å‚¨æ¯”è¾ƒç¨€ç–è€Œä¸”æä¸å¹³è¡¡ã€‚<br>ä¾‹å­ï¼šå…³é”®å­—é›†åˆ{â€œalgoriâ€, â€œtoâ€, â€œteaâ€, â€œtedâ€, â€œiâ€, â€œinâ€, â€œinnâ€}ï¼Œæ­¤é›†åˆè½¬ä¸ºTrieæ ‘ä¸º<br><img src="/blogimgs/MPT/trie1.png" alt="ç¨€ç–Trieæ ‘" title="ç¨€ç–Trieæ ‘"></p><h2 id="Patricia-Trieæ ‘"><a href="#Patricia-Trieæ ‘" class="headerlink" title="Patricia Trieæ ‘"></a>Patricia Trieæ ‘</h2><p>æ—¢ç„¶Trieæ ‘åœ¨æŸäº›æƒ…å†µä¸‹å­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡ä¸é«˜ï¼Œé‚£å°±ç»™å‹ç¼©ä¸‹ï¼Œç„¶åå°±å‡ºç°äº†Patricia Trieæ ‘ã€‚</p><p>Patricia Trieæ ‘æ˜¯ä¸€ç§ç©ºé—´ä½¿ç”¨ç‡ç»è¿‡ä¼˜åŒ–çš„Trieæ ‘ã€‚ä¸Trieæ ‘ä¸åŒçš„æ˜¯ï¼ŒPatricia Trie é‡Œå¦‚æœå­˜åœ¨ä¸€ä¸ªçˆ¶èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¿™ä¸ªçˆ¶èŠ‚ç‚¹å°†ä¸å…¶å­èŠ‚ç‚¹åˆå¹¶ã€‚è¿™æ ·å‹ç¼©å­˜å‚¨å¯ä»¥å‡å°‘Trieæ ‘ä¸­ä¸å¿…è¦çš„æ·±åº¦ï¼Œå¤§å¤§åŠ å¿«æœç´¢èŠ‚ç‚¹é€Ÿåº¦ã€‚<br>å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="/blogimgs/MPT/patricia.png" alt="Patricia Trieæ ‘" title="Patricia Trieæ ‘"></p><h2 id="Merkleæ ‘"><a href="#Merkleæ ‘" class="headerlink" title="Merkleæ ‘"></a>Merkleæ ‘</h2><p>Merkleæ ‘æ˜¯ç”±è®¡ç®—æœºç§‘å­¦å®¶Ralph Merkleåœ¨å¾ˆå¤šå¹´å‰æå‡ºçš„ï¼Œå¹¶ä»¥ä»–æœ¬äººçš„åå­—æ¥å‘½åï¼Œæ˜¯ä¸€ç§æ ‘å½¢æ•°æ®ç»“æ„ï¼Œå¯ä»¥æ˜¯äºŒå‰æ ‘ï¼Œä¹Ÿå¯ä»¥æ˜¯å¤šå‰æ ‘ã€‚<br>å®ƒç”±è‹¥å¹²å¶èŠ‚ç‚¹ã€ä¸­é—´èŠ‚ç‚¹å’Œä¸€ä¸ªæ ¹èŠ‚ç‚¹æ„æˆã€‚æœ€ä¸‹é¢çš„å¶èŠ‚ç‚¹åŒ…å«åŸºç¡€æ•°æ®ï¼Œæ¯ä¸ªä¸­é—´èŠ‚ç‚¹æ˜¯å®ƒå­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œæ ¹èŠ‚ç‚¹æ˜¯å®ƒçš„å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œä»£è¡¨äº†Merkleæ ‘çš„æ ¹éƒ¨ã€‚</p><p>ç”±äºMerkleæ ‘æ˜¯è‡ªåº•å‘ä¸Šæ„å»ºçš„ï¼Œè€Œä¸”é™¤å¶å­ç»“ç‚¹ä¹‹å¤–çš„å…¶å®ƒèŠ‚ç‚¹éƒ½æ˜¯å…¶å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œè¿™æ ·æ¯ä¸ªèŠ‚ç‚¹çš„å€¼å‘ç”Ÿå˜åŒ–éƒ½ä¼šä¸€å±‚ä¸€å±‚çš„å‘ä¸Šåæ˜ ï¼Œæœ€ç»ˆåœ¨æ ¹èŠ‚ç‚¹ä¸Šè¡¨ç°å‡ºæ¥ã€‚ä¹Ÿå°±æ˜¯è¯´åªè¦å¯¹æ¯”ä¸¤ä¸ªMerkleæ ‘çš„æ ¹èŠ‚ç‚¹æ˜¯å¦ç›¸ç­‰å°±èƒ½å¾—åˆ°ä¸¤ä»½æ•°æ®é›†æ˜¯å¦ä¸€æ ·ï¼Œè€Œä¸”è¿˜å¯ä»¥éªŒè¯Merkleæ ‘çš„æŸä¸ªåˆ†æ”¯ã€‚</p><p>æ¯”ç‰¹å¸ä½¿ç”¨Merkleæ ‘å­˜å‚¨ä¸€ä¸ªåŒºå—ä¸­çš„æ‰€æœ‰äº¤æ˜“ä¿¡æ¯ï¼Œä¸€æ˜¯ä¸ºäº†é˜²ç¯¡æ”¹ï¼Œå› ä¸ºæ•£åˆ—æ˜¯å‘ä¸Šçš„ï¼Œä¼ªé€ ä»»ä½•ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šå¼•èµ·ä¸Šå±‚èŠ‚ç‚¹çš„æ”¹åŠ¨ï¼Œæœ€ç»ˆå¯¼è‡´æ ¹èŠ‚ç‚¹çš„å˜åŒ–ã€‚äºŒæ˜¯ä¸ºäº†å…è®¸åŒºå—çš„æ•°æ®å¯ä»¥é›¶æ•£çš„ä¼ é€ï¼Œå³èŠ‚ç‚¹å¯ä»¥ä»ä¸€ä¸ªèŠ‚ç‚¹ä¸‹è½½åŒºå—å¤´ï¼Œä»å¦å¤–çš„æºä¸‹è½½ä¸å…¶ç›¸å…³çš„æ ‘çš„å…¶ä»–éƒ¨åˆ†ï¼Œè€Œä¾ç„¶èƒ½å¤Ÿç¡®è®¤æ‰€æœ‰çš„æ•°æ®éƒ½æ˜¯æ­£ç¡®çš„ã€‚</p><p>çœ‹ä¸‹å›¾çš„ä¾‹å­ï¼Œé¦–å…ˆå°†L1-L4å››ä¸ªå•å…ƒæ•°æ®æ•£åˆ—åŒ–ï¼Œç„¶åå°†æ•£åˆ—å€¼å­˜å‚¨è‡³ç›¸åº”çš„å¶å­èŠ‚ç‚¹ã€‚è¿™äº›èŠ‚ç‚¹æ˜¯Hash0-0, Hash0-1, Hash1-0, Hash1-1ï¼Œç„¶åå°†ç›¸é‚»ä¸¤ä¸ªèŠ‚ç‚¹çš„æ•£åˆ—å€¼åˆå¹¶æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œç„¶åè®¡ç®—è¿™ä¸ªå­—ç¬¦ä¸²çš„æ•£åˆ—ï¼Œå¾—åˆ°çš„å°±æ˜¯è¿™ä¸¤ä¸ªèŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹çš„æ•£åˆ—å€¼ã€‚<br><img src="/blogimgs/MPT/merkle.png" alt="merkleæ ‘" title="merkleæ ‘"></p><p>åœ¨æ¯”ç‰¹å¸ç½‘ç»œä¸­ï¼Œmerkleæ ‘è¢«ç”¨æ¥å½’çº³ä¸€ä¸ªåŒºå—ä¸­çš„æ‰€æœ‰äº¤æ˜“ï¼ŒåŒæ—¶ç”Ÿæˆæ•´ä¸ªäº¤æ˜“é›†åˆçš„æ•°å­—æŒ‡çº¹ã€‚æ­¤å¤–ï¼Œç”±äºmerkleæ ‘çš„å­˜åœ¨ï¼Œä½¿å¾—åœ¨æ¯”ç‰¹å¸è¿™ç§å…¬é“¾çš„åœºæ™¯ä¸‹ï¼Œæ‰©å±•ä¸€ç§â€œè½»èŠ‚ç‚¹â€å®ç°ç®€å•æ”¯ä»˜éªŒè¯å˜æˆå¯èƒ½ã€‚</p><p>çŸ¥é“äº†Merkleæ ‘åœ¨æ¯”ç‰¹å¸ä¸­çš„åº”ç”¨ï¼Œé‚£ä¹ˆä»–æ˜¯æ€ä¹ˆæ„æˆå‘¢ï¼Ÿç°åœ¨å°±ç®€å•çœ‹ä¸‹å…¶æ„æˆã€‚<em>å®ƒç”±ä¸€ç»„å¶èŠ‚ç‚¹ã€ä¸€ç»„ä¸­é—´èŠ‚ç‚¹å’Œä¸€ä¸ªæ ¹èŠ‚ç‚¹æ„æˆ</em>ã€‚æœ€ä¸‹é¢çš„å¶èŠ‚ç‚¹åŒ…å«åŸºç¡€æ•°æ®ï¼Œæ¯ä¸ªä¸­é—´èŠ‚ç‚¹æ˜¯å®ƒçš„å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œæ ¹èŠ‚ç‚¹æ˜¯å®ƒçš„å­èŠ‚ç‚¹çš„æ•£åˆ—ï¼Œä»£è¡¨äº†Merkleæ ‘çš„æ ¹éƒ¨ ã€‚</p><blockquote><p>Merkleæ ‘å…·æœ‰ä¸‹åˆ—ç‰¹æ€§:</p></blockquote><ol><li>æ¯ä¸ªæ•°æ®é›†å¯¹åº”ä¸€ä¸ªå”¯ä¸€åˆæ³•çš„æ ¹æ•£åˆ—å€¼ã€‚</li><li>å¾ˆå®¹æ˜“æ›´æ–°ã€æ·»åŠ æˆ–è€…åˆ é™¤æ ‘èŠ‚ç‚¹ï¼Œä»¥åŠç”Ÿæˆæ–°çš„æ ¹æ•£åˆ—å€¼ ã€‚ </li><li>ä¸æ”¹å˜æ ¹æ•£åˆ—å€¼çš„è¯å°±æ²¡æœ‰åŠæ³•ä¿®æ”¹æ ‘çš„ä»»ä½•éƒ¨åˆ†ï¼Œæ‰€ä»¥å¦‚æœæ ¹æ•£åˆ—å€¼è¢«åŒ…æ‹¬åœ¨ç­¾åçš„æ–‡æ¡£æˆ–æœ‰æ•ˆåŒºå—ä¸­ï¼Œå°±å¯ä»¥ä¿è¯è¿™æ£µæ ‘çš„æ­£ç¡®æ€§ã€‚</li><li>ä»»ä½•äººå¯ä»¥åªæä¾›ä¸€ä¸ªåˆ°ç‰¹å®šèŠ‚ç‚¹çš„åˆ†æ”¯ï¼Œå¹¶é€šè¿‡å¯†ç å­¦æ–¹æ³•è¯æ˜æ‹¥æœ‰å¯¹åº”å†…å®¹çš„èŠ‚ç‚¹ç¡®å®åœ¨æ ‘é‡Œ ã€‚</li></ol><h2 id="Merkle-Patricia-Tree"><a href="#Merkle-Patricia-Tree" class="headerlink" title="Merkle Patricia Tree"></a>Merkle Patricia Tree</h2><p>å¨å¨äº†é‚£ä¹ˆå¤šï¼Œæœ¬ç¯‡çš„ä¸»è§’ç»ˆäºå‡ºæ¥äº†ã€‚<br>Merkle Patricia Treeç»“åˆäº†Merkleæ ‘å’ŒPatriciaæ ‘çš„ç‰¹ç‚¹ï¼Œå¹¶é’ˆå¯¹ä»¥å¤ªåŠçš„ä½¿ç”¨åœºæ™¯è¿›è¡Œäº†ä¸€äº›æ”¹è¿›ã€‚</p><p>é¦–å…ˆï¼Œä¸ºäº†ä¿è¯æ ‘çš„åŠ å¯†å®‰å…¨ï¼Œ<em>æ¯ä¸ªèŠ‚ç‚¹é€šè¿‡å®ƒçš„æ•£åˆ—å€¼è¢«å¼•ç”¨</em>ï¼Œåˆ™æ ¹èŠ‚ç‚¹æ˜¯ä¸€å±‚ä¸€å±‚æ•£åˆ—å‘ä¸Šæ”¶æ•›è€Œå¾—ï¼Œè¢«ç§°ä¸ºæ•´æ£µæ ‘çš„åŠ å¯†ç­¾åï¼Œå¦‚æœä¸€æ£µç»™å®š Trieæ ‘çš„æ ¹æ•£åˆ—å€¼æ˜¯å…¬å¼€çš„ï¼Œé‚£ä¹ˆæ‰€æœ‰äººéƒ½å¯ä»¥æä¾›ä¸€ç§è¯æ˜ï¼Œå³é€šè¿‡æä¾›æ¯æ­¥å‘ä¸Šçš„è·¯å¾„è¯æ˜ç‰¹å®šçš„keyæ˜¯å¦å«æœ‰ç‰¹å®šçš„å€¼ã€‚<em>åœ¨å½“å‰çš„ä»¥å¤ªåŠç‰ˆæœ¬ä¸­ï¼ŒMPTå­˜å‚¨åœ¨LevelDBæ•°æ®åº“ä¸­</em>ã€‚</p><p>å…¶æ¬¡ï¼ŒMPTæ ‘å¼•äººäº†å¾ˆå¤šèŠ‚ç‚¹ç±»å‹æ¥æé«˜æ•ˆç‡ã€‚åŒ…æ‹¬ä»¥ä¸‹4ç§:</p><ol><li><p>ç©ºèŠ‚ç‚¹(NULL) â€“ represented as the empty string</p><blockquote><p>ç®€å•çš„è¡¨ç¤ºç©ºï¼Œåœ¨ä»£ç ä¸­æ˜¯ä¸€ä¸ªç©ºä¸²ã€‚</p></blockquote></li><li><p>å¶å­èŠ‚ç‚¹(leaf) â€“ a 2-item node [encodedPath, value]</p><blockquote><p>è¡¨ç¤ºä¸º[key,value]çš„ä¸€ä¸ªé”®å€¼å¯¹ï¼Œ<strong>å…¶ä¸­keyæ˜¯keyçš„ä¸€ç§ç‰¹æ®Šåå…­è¿›åˆ¶ç¼–ç (MPç¼–ç )ï¼Œ valueæ˜¯valueçš„RLPç¼–ç </strong>ã€‚</p></blockquote></li><li><p>åˆ†æ”¯èŠ‚ç‚¹(branch) â€“ a 17-item node [v0 â€¦ v15, vt]</p><blockquote><p>å› ä¸ºMPTæ ‘ä¸­çš„keyè¢«ç¼–ç æˆä¸€ç§ç‰¹æ®Šçš„16è¿›åˆ¶çš„è¡¨ç¤ºï¼Œå†åŠ ä¸Šæœ€åçš„valueï¼Œæ‰€ä»¥<strong>åˆ†æ”¯èŠ‚ç‚¹æ˜¯ä¸€ä¸ªé•¿åº¦ä¸º17çš„list</strong>ï¼Œå‰16ä¸ªå…ƒç´ å¯¹åº”ç€keyä¸­çš„16ä¸ªå¯èƒ½çš„åå…­è¿›åˆ¶å­—ç¬¦ï¼Œ<strong>å¦‚æœæœ‰ä¸€ä¸ª[key,value]å¯¹åœ¨è¿™ä¸ªåˆ†æ”¯èŠ‚ç‚¹ç»ˆæ­¢ï¼Œæœ€åä¸€ä¸ªå…ƒç´ ä»£è¡¨è¿™ä¸ªå€¼value</strong>ï¼Œå³åˆ†æ”¯èŠ‚ç‚¹æ—¢å¯ä»¥æ˜¯æœç´¢è·¯å¾„çš„ç»ˆæ­¢ä¹Ÿå¯ä»¥æ˜¯è·¯å¾„çš„ä¸­é—´èŠ‚ç‚¹ã€‚</p></blockquote></li><li><p>æ‰©å±•èŠ‚ç‚¹(extension) â€“ a 2-item node [encodedPath, key]<br>ä¹Ÿæ˜¯[keyï¼Œvalue]çš„ä¸€ä¸ªé”®å€¼å¯¹ï¼Œä½†æ˜¯è¿™é‡Œçš„valueæ˜¯å…¶ä»–èŠ‚ç‚¹çš„hashå€¼ï¼Œè¿™ä¸ªhashå¯ä»¥è¢«ç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­çš„èŠ‚ç‚¹ã€‚ä¹Ÿå°±æ˜¯è¯´é€šè¿‡hashé“¾æ¥åˆ°å…¶ä»–èŠ‚ç‚¹ã€‚</p></li></ol><p>ä¸‹é¢çœ‹ä¸ªä»¥å¤ªåŠä¸­MPTæ ‘çš„å®˜æ–¹ç¤ºä¾‹<br><img src="/blogimgs/MPT/e-mpt.png" alt="MPTå®ä¾‹" title="MPTå®ä¾‹"></p><h3 id="ç¤ºä¾‹"><a href="#ç¤ºä¾‹" class="headerlink" title="ç¤ºä¾‹"></a>ç¤ºä¾‹</h3><p>çœ‹åˆ°è¿™é‡Œä½ è‚¯å®šä¾ç„¶æ˜¯ä¸€è„¸æ‡µé€¼ï¼Œ(ä¸è¦é—®æˆ‘æˆ‘æ˜¯æ€ä¹ˆçŸ¥é“çš„ã€‚ã€‚ã€‚ã€‚)ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥æ ¹æ®ä¸€æ‰¹æ•°æ®æ„é€ ä¸€ä¸ªMPTæ ‘ï¼Œè¿™æ ·ä½ ä¼šç†è§£ä¸€äº›ã€‚<br>ä½†æ˜¯åœ¨è®²ä¾‹å­ä¹‹å‰ï¼Œè¿˜å¾—å…ˆä»‹ç»å‡ ç§ç¼–ç æ–¹å¼ï¼Œè¦ä¸çœ‹ä¾‹å­çš„æ—¶å€™å¯¹keyçš„å–å€¼ä¼šæ¯”è¾ƒæ‡µã€‚</p><h4 id="keyç¼–ç "><a href="#keyç¼–ç " class="headerlink" title="keyç¼–ç "></a>keyç¼–ç </h4><p>åœ¨ä»¥å¤ªåŠä¸­ï¼ŒMPTæ ‘çš„keyå€¼å…±æœ‰ä¸‰ç§ä¸åŒçš„ç¼–ç æ–¹å¼ï¼Œåˆ†åˆ«ä¸º:</p><ol><li>Rawç¼–ç (åŸç”Ÿçš„å­—ç¬¦)</li><li>Hexç¼–ç (æ‰©å±•çš„16è¿›åˆ¶ç¼–ç )</li><li>Hex-Prefixç¼–ç (16è¿›åˆ¶å‰ç¼€ç¼–ç )</li></ol><blockquote><p>Rawç¼–ç </p></blockquote><p>Rawç¼–ç å°±æ˜¯åŸç”Ÿçš„keyå€¼ï¼Œä¸åšä»»ä½•æ”¹å˜ã€‚è¿™ç§ç¼–ç æ–¹å¼çš„keyï¼Œæ˜¯MPTå¯¹å¤–æä¾›æ¥å£çš„é»˜è®¤ç¼–ç æ–¹å¼ã€‚<br>ä¾‹å¦‚keyä¸ºâ€dogâ€ï¼Œvalueä¸ºâ€puppyâ€çš„æ•°æ®é¡¹ï¼Œå…¶keyçš„Rawç¼–ç å°±æ˜¯[â€˜dâ€™, â€˜oâ€™, â€˜gâ€™]ï¼Œæ¢æˆASCIIè¡¨ç¤ºæ–¹å¼å°±æ˜¯[64, 6f, 67] : dog =&gt; â€˜puppyâ€™</p><blockquote><p>Hexç¼–ç </p></blockquote><p>Hexç¼–ç å°±æ˜¯æŠŠä¸€ä¸ª8ä½çš„å­—èŠ‚æ•°æ®æ ¹æ®é«˜4ä½å’Œä½4ä½æ‹†è§£ä¸ºä¸¤ä¸ª4ä½çš„æ•°å­—ï¼Œç„¶åä¸¤ä¸ªæ•°å­—çš„é«˜4ä½éƒ½è¡¥0ï¼Œæœ€åå°†è¡¥å®Œä¹‹åçš„ä¸¤ä¸ªå­—èŠ‚ç¼–ç ä¸º16è¿›åˆ¶ã€‚<br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯<em>keyå¯¹åº”çš„å€¼ä¸ºçœŸå®çš„æ•°æ®é¡¹</em>ï¼Œå³æ˜¯ä¸€ä¸ªæœ‰æ„ä¹‰çš„kvå¯¹ï¼Œæ¯”å¦‚dog-&gt;puppy(ä¹Ÿå°±æ˜¯å¶å­ç»“ç‚¹)ï¼Œè€Œä¸æ˜¯key-&gt;èŠ‚ç‚¹hash(ä¹Ÿå°±æ˜¯åˆ†æ”¯èŠ‚ç‚¹)ï¼Œåˆ™åœ¨æœ«å°¾æ·»åŠ ä¸€ä¸ªASCIIå€¼ä¸º16(åå…­è¿›åˆ¶ä¸º0x10)çš„å­—ç¬¦ä¸²ä½œä¸ºterminatorã€‚å¦‚æœæ˜¯<em>åˆ†æ”¯èŠ‚ç‚¹åˆ™ä¸åŠ ä»»ä½•å­—ç¬¦</em>ã€‚<br>ä¾‹å¦‚keyä¸ºâ€dogâ€ï¼Œvalueä¸ºâ€puppyâ€çš„æ•°æ®é¡¹ï¼Œå…¶keyä¸­d(100)çš„äºŒè¿›åˆ¶ç¼–ç ä¸º01100100ï¼Œæ‹†è§£ä¸ºä¸¤ä¸ª4ä½çš„æ•°å­—ä¸º0110å’Œ0100ï¼Œé«˜ä½è¡¥0ä¹‹åçš„äºŒè¿›åˆ¶ä¸º00000110å’Œ00000100ï¼Œ16è¿›åˆ¶ä¸º6å’Œ4ï¼Œä¾æ¬¡ç¼–ç oå’Œgã€‚åˆå› ä¸ºdogå¯¹åº”çš„valueæ˜¯çœŸå®çš„æ•°æ®é¡¹ï¼Œåˆ™åœ¨æœ«å°¾æ·»åŠ 16ã€‚æœ€åæœ€ç»ˆçš„Hexç¼–ç ä¸º[ 6, 4, 6, 15, 6, 7, 16 ] : dog =&gt; â€˜puppyâ€™</p><blockquote><p>Hex-Prefixç¼–ç </p></blockquote><p>é¦–å…ˆæ ¹æ®åå­—å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªå‰ç¼€ç¼–ç ï¼Œæ˜¯åœ¨åŸkeyçš„åŸºç¡€ä¸ŠåŠ ä¸Šä¸€äº›æ ‡è¯†ä½œä¸ºå‰ç¼€ï¼Œå…¶æ¬¡æˆ‘ä»¬çœ‹ä¸‹è¿™ç§ç¼–ç æ–¹å¼çš„ç›®çš„ï¼š</p><ol><li>åŒºåˆ†leafå’Œextension</li><li>æŠŠå¥‡æ•°è·¯å¾„å˜æˆå¶æ•°è·¯å¾„</li></ol><p>åˆ™è¿™ä¸ªå‰ç¼€çš„ç”Ÿæˆè‚¯å®šä¸leafã€extensionå’Œkeyçš„å¥‡å¶ç›¸å…³äº†ï¼Œä¸‹é¢çœ‹ä¸‹ç¼–ç æ­¥éª¤ä¸º:</p><ol><li>å…ˆæŒ‰Hexå¯¹keyè¿›è¡Œç¼–ç </li><li>keyçš„ç»“å°¾å¦‚æœæ˜¯0x10(ä¹Ÿå°±æ˜¯16)ï¼Œåˆ™å»æ‰è¿™ä¸ªç»ˆæ­¢ç¬¦</li><li>keyä¹‹å‰è¡¥ä¸€ä¸ªå››å…ƒç»„ï¼Œè¿™ä¸ªå››å…ƒç»„<em>ç¬¬0ä½åŒºåˆ†å¥‡å¶ä¿¡æ¯ï¼Œç¬¬1ä½åŒºåˆ†èŠ‚ç‚¹ç±»å‹</em>ï¼Œè¡¨æ ¼è¡¨ç¤ºå¦‚ä¸‹</li></ol><p>| node type | path length | prefix | hexchar |<br>|â€”â€”â€”â€“|â€”â€”â€”â€“|â€”â€”â€”|<br>| extension | even | 0000 | 0x0 |<br>| extension | odd | 0001 | 0x1 |<br>| leaf | even | 0010 | 0x2 |<br>| leaf | odd | 0011 | 0x3 |</p><ol start="4"><li><em>å¦‚æœè¾“å…¥keyçš„é•¿åº¦æ˜¯å¶æ•°</em>ï¼Œåˆ™åœ¨ä¹‹å‰çš„å››å…ƒç»„åå†æ·»åŠ ä¸€ä¸ªå››å…ƒç»„0x0</li><li>å°†åŸæ¥çš„keyå†…å®¹å‹ç¼©ï¼Œå°†åˆ†ç¦»çš„ä¸¤ä¸ªbyteä»¥é«˜å››ä½ä½å››ä½è¿›è¡Œåˆå¹¶</li></ol><blockquote><p>è¿™é‡Œæœ‰ä¸ªåè¯è§£é‡Šä¸‹ï¼Œå››å…ƒç»„æ˜¯å››ä¸ªbitä½çš„ç»„åˆ(ä¾‹å¦‚äºŒè¿›åˆ¶è¡¨è¾¾çš„0010å°±æ˜¯ä¸€ä¸ªå››å…ƒç»„)ï¼Œå…¶ä¸­Nibbleå°±æ˜¯ä¸€ä¸ªå››å…ƒç»„ï¼Œæ˜¯keyçš„åŸºæœ¬å•å…ƒã€‚</p></blockquote><p>ä¾‹å¦‚keyä¸ºâ€dogâ€ï¼Œvalueä¸ºâ€puppyâ€çš„æ•°æ®é¡¹ï¼Œåˆ™é¦–å…ˆå¯¹dogè¿›è¡ŒHexç¼–ç [ 6, 4, 6, 15, 6, 7, 16 ]ï¼Œç„¶åæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤è¿›è¡Œç¼–ç ï¼Œdogçš„Hexç¼–ç æœ«å°¾æ˜¯16ï¼Œå»æ‰ç»ˆæ­¢ç¬¦ä¸º[ 6, 4, 6, 15, 6, 7 ]ï¼Œå‡†å¤‡åœ¨keyå‰è¡¥å››å…ƒç»„ï¼Œdogä¸ºå¶å­èŠ‚ç‚¹å¹¶ä¸”ç¼–ç ä¹‹åçš„é•¿åº¦ä¸º6æ˜¯å¶æ•°ï¼Œæ‰€ä»¥å››å…ƒç»„ä¸º0010(0x2)ï¼Œæ­¤æ—¶åˆ°äº†ç¬¬4æ­¥ï¼Œkeyç¼–ç ä¹‹åçš„é•¿åº¦æ˜¯å¶æ•°ï¼Œåˆ™åœ¨<em>å‰ä¸€ä¸ªå››å…ƒç»„(0x2)ä¹‹åå†æ·»åŠ ä¸€ä¸ªå››å…ƒç»„0x0</em>ï¼Œæœ€ç»ˆçš„å‰ç¼€ä¸º0x20ã€‚æœ€åå°†åŸæ¥çš„keyå†…å®¹è¿›è¡Œé«˜ä½å››ä½åˆå¹¶ï¼Œæœ€ç»ˆçš„Hex-Prefixç¼–ç æ˜¯[ 0x20, 0x64, 0x6f, 0x67 ]</p><blockquote><p>ä»¥ä¸Šä¸‰ç§ç¼–ç æ–¹å¼çš„è½¬æ¢å…³ç³»ä¸ºï¼š</p></blockquote><p>Rawç¼–ç : åŸç”Ÿçš„keyç¼–ç ï¼Œæ˜¯MPTå¯¹å¤–æä¾›æ¥å£ä¸­ä½¿ç”¨çš„ç¼–ç æ–¹å¼ï¼Œå½“æ•°æ®é¡¹è¢«æ’å…¥åˆ°æ ‘ä¸­æ—¶ï¼ŒRawç¼–ç è¢«è½¬æ¢æˆHexç¼–ç <br>Hexç¼–ç : 16è¿›åˆ¶æ‰©å±•ç¼–ç ï¼Œç”¨äºå¯¹å†…å­˜ä¸­æ ‘èŠ‚ç‚¹keyè¿›è¡Œç¼–ç ï¼Œå½“æ ‘èŠ‚ç‚¹è¢«æŒä¹…åŒ–åˆ°æ•°æ®åº“æ—¶ï¼ŒHexç¼–ç è¢«è½¬æ¢æˆHPç¼–ç <br>HPç¼–ç : 16è¿›åˆ¶å‰ç¼€ç¼–ç ï¼Œç”¨äºå¯¹æ•°æ®åº“ä¸­æ ‘èŠ‚ç‚¹keyè¿›è¡Œç¼–ç ï¼Œå½“æ ‘èŠ‚ç‚¹è¢«åŠ è½½åˆ°å†…å­˜æ—¶ï¼ŒHPç¼–ç è¢«è½¬æ¢æˆHexç¼–ç </p><h4 id="æ„é€ è¿‡ç¨‹"><a href="#æ„é€ è¿‡ç¨‹" class="headerlink" title="æ„é€ è¿‡ç¨‹"></a>æ„é€ è¿‡ç¨‹</h4><p>æ¥ä¸‹æ¥æˆ‘ä»¬å°±å®é™…æ“ä½œä¸‹ï¼š<br>å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªæ ‘æœ‰è¿™æ ·ä¸€äº›kvå¯¹(â€˜dogâ€™, â€˜puppyâ€™), (â€˜horseâ€™, â€˜stallionâ€™), (â€˜doâ€™, â€˜verbâ€™), (â€˜dogeâ€™, â€˜coinâ€™)ã€‚<br>é¦–å…ˆï¼Œæˆ‘ä»¬å°†keyè½¬æˆHexç¼–ç ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 64 6f</span></span><br><span class="line">[ 6, 4, 6, 15, 16 ] : <span class="keyword">do</span> =&gt; <span class="string">&#x27;verb&#x27;</span></span><br><span class="line"><span class="comment">#64 6f 67</span></span><br><span class="line">[ 6, 4, 6, 15, 6, 7, 16 ] : dog =&gt; <span class="string">&#x27;puppy&#x27;</span></span><br><span class="line"><span class="comment">#64 6f 67 65</span></span><br><span class="line">[ 6, 4, 6, 15, 6, 7, 6, 5, 16 ] : doge =&gt; <span class="string">&#x27;coin&#x27;</span></span><br><span class="line"><span class="comment">#68 6f 72 73 65</span></span><br><span class="line">[ 6, 8, 6, 15, 7, 2, 7, 3, 6, 5, 16 ] : horse =&gt; <span class="string">&#x27;stallion&#x27;</span></span><br></pre></td></tr></table></figure><p>å…¶æ„é€ MPTæ ‘å¦‚å›¾ï¼š<br><img src="/blogimgs/MPT/mpt.png" alt="MPT" title="MPT"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">rootHash: [ &lt;16&gt;, hashA ]</span><br><span class="line">hashA:    [ &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, hashB, &lt;&gt;, &lt;&gt;, &lt;&gt;, hashC, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt; ]</span><br><span class="line">hashC:    [ &lt;20 6f 72 73 65&gt;, <span class="string">&#x27;stallion&#x27;</span> ]</span><br><span class="line">hashB:    [ &lt;00 6f&gt;, hashD ]</span><br><span class="line">hashD:    [ &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, hashE, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, <span class="string">&#x27;verb&#x27;</span> ]</span><br><span class="line">hashE:    [ &lt;17&gt;, hashF ]</span><br><span class="line">hashF:    [ &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, hashG, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, &lt;&gt;, <span class="string">&#x27;puppy&#x27;</span> ]</span><br><span class="line">hashG:    [ &lt;35&gt;, <span class="string">&#x27;coin&#x27;</span> ]</span><br></pre></td></tr></table></figure><!-- è‹¥å½“å‰èŠ‚ç‚¹ä¸ºåˆ†æ”¯èŠ‚ç‚¹ï¼Œè‹¥æœç´¢è·¯å¾„ä¸ºç©ºï¼Œåˆ™è¿”å›åˆ†æ”¯èŠ‚ç‚¹çš„å­˜å‚¨å†…å®¹ --><p>æ„é€ è¿‡ç¨‹ä¸º</p><ol><li>å‡è®¾æ’å…¥ç¬¬ä¸€ä¸ªkvå¯¹æ˜¯do-&gt;verbï¼Œkeyæ ¹æ®Hex-Prefixç¼–ç ä¸º[â€˜0x20â€™, â€˜0x64â€™, â€˜0x6fâ€™]ï¼ŒMPTæ ‘ä¸ºï¼š<br><img src="/blogimgs/MPT/leafA.png" alt="å¶å­ç»“ç‚¹" title="å¶å­ç»“ç‚¹"></li><li>æ¥ç€æ’å…¥ç¬¬äºŒä¸ªkvå¯¹dog-&gt;puppyï¼Œdogå’Œdoçš„å…¬å…±å‰ç¼€ä¸º[â€˜64â€™, â€˜6fâ€™]ï¼Œdoæ˜¯å¶å­ç»“ç‚¹Aï¼Œå°†<em>å¶å­ç»“ç‚¹æ›¿æ¢æˆæ‰©å±•èŠ‚ç‚¹A</em>ï¼Œå¹¶å°†æ–°keyä¸å¶å­èŠ‚ç‚¹Açš„å…¬å…±å‰ç¼€(646f)ä½œä¸ºæ‰©å±•èŠ‚ç‚¹çš„keyï¼Œ<em>æ‰©å±•èŠ‚ç‚¹çš„valueæ˜¯æ–°åˆ†æ”¯èŠ‚ç‚¹Bçš„hashå€¼</em>ï¼Œç„¶åå°†doå’Œdogå‰©ä½™çš„keyæ’å…¥åˆ°åˆ†æ”¯èŠ‚ç‚¹ä¸­ï¼Œç”±äºdoæ²¡æœ‰å‰©ä½™çš„keyï¼Œåˆ™å°†å¯¹åº”çš„valueå†™å…¥åˆ†æ”¯èŠ‚ç‚¹Bçš„valueä¸­ï¼Œdogå‰©ä½™çš„keyä¸º67ï¼Œåˆ™åˆ†æ”¯èŠ‚ç‚¹Bä¸­çš„è·¯å¾„ä¸º6ï¼ŒæŒ‡å‘å¶å­ç»“ç‚¹Cã€‚7ä¸ºdogå‰©ä¸‹çš„æœ€åä¸€ä¸ªkeyå€¼ï¼Œæ˜¯å¥‡æ•°å¶å­ç»“ç‚¹åˆ™å‰ç¼€ä¸º3ï¼Œæ‰€æœ‰æœ€ç»ˆçš„MPTæ ‘ä¸ºï¼š<br><img src="/blogimgs/MPT/two.png" alt="å¶å­ç»“ç‚¹æ’å…¥" title="å¶å­ç»“ç‚¹æ’å…¥"></li><li>å†æ’å…¥ç¬¬ä¸‰ä¸ªkvå¯¹doge-&gt;coinï¼ŒæŒ‰ç…§ä¸Šé¢çš„æ­¥éª¤ç”Ÿæˆçš„MPTæ ‘æ˜¯ï¼š<br><img src="/blogimgs/MPT/three.png"></li><li>æœ€åæ’å…¥ç¬¬å››ä¸ªkvå¯¹horse-&gt;stallionï¼Œhorseä¸å…¶å®ƒkeyçš„å…¬å…±å‰ç¼€åªæœ‰6ï¼Œåˆ™å°†æ‰©å±•èŠ‚ç‚¹Aæ–°å¢ä¸€ä¸ªåˆ†æ”¯èŠ‚ç‚¹Fä½œä¸ºå…¶å­©å­èŠ‚ç‚¹ï¼Œå°†æ–°keyä¸æ‰©å±•èŠ‚ç‚¹Açš„å…¬å…±å‰ç¼€6ä½œä¸ºæ‰©å±•èŠ‚ç‚¹Açš„keyï¼ŒAæ˜¯æ‰©å±•èŠ‚ç‚¹å¹¶ä¸”keyä¸ºå¥‡æ•°ï¼Œæ‰€ä»¥å‰ç¼€ä¸º1ï¼Œvalueä¸ºæ–°å¢åˆ†æ”¯èŠ‚ç‚¹Fçš„hashã€‚åŸæ‰©å±•èŠ‚ç‚¹Aå˜æˆæ–°æ‰©å±•èŠ‚ç‚¹ä¹‹åå‰©ä½™çš„keyï¼Œä¸æ–°keyå‰©ä¸‹çš„keyï¼Œæ’å…¥åˆ°åˆ†æ”¯èŠ‚ç‚¹Fä¸­ï¼Œåˆ†åˆ«æ”¾å…¥4å’Œ8ä¸­ï¼Œ4æŒ‡å‘æ–°çš„æ‰©å±•èŠ‚ç‚¹Gï¼Œ8æŒ‡å‘å¶å­èŠ‚ç‚¹Hã€‚æœ€ç»ˆçš„MPTæ ‘ä¸ºï¼š<br><img src="/blogimgs/MPT/four.png"></li></ol><!--å‰©ä½™çš„æœç´¢è·¯å¾„ä¸å½“å‰èŠ‚ç‚¹çš„keyä¸å®Œå…¨ä¸€è‡´ï¼Œåˆ™å°†å¶å­ï¼æ‰©å±•èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹æ›¿æ¢æˆåˆ†æ”¯èŠ‚ç‚¹ï¼Œå°†æ–°èŠ‚ç‚¹ä¸å½“å‰èŠ‚ç‚¹keyçš„å…±åŒå‰ç¼€ä½œä¸ºå½“å‰èŠ‚ç‚¹çš„keyï¼Œå°†æ–°èŠ‚ç‚¹ä¸å½“å‰èŠ‚ç‚¹çš„å­©å­èŠ‚ç‚¹ä½œä¸ºä¸¤ä¸ªå­©å­æ’å…¥åˆ°åˆ†æ”¯èŠ‚ç‚¹çš„å­©å­åˆ—è¡¨ä¸­ï¼ŒåŒæ—¶å½“å‰èŠ‚ç‚¹è½¬æ¢æˆäº†ä¸€ä¸ªæ‰©å±•èŠ‚ç‚¹ï¼ˆè‹¥æ–°èŠ‚ç‚¹ä¸å½“å‰èŠ‚ç‚¹æ²¡æœ‰å…±åŒå‰ç¼€ï¼Œåˆ™ç›´æ¥ç”¨ç”Ÿæˆçš„åˆ†æ”¯èŠ‚ç‚¹æ›¿æ¢å½“å‰èŠ‚ç‚¹ï¼‰ï¼›--><!--æ ‘çš„æ„é€ é€»è¾‘æ˜¯rootç»“ç‚¹ï¼Œè¦æ„é€ ä¸€ä¸ªæŒ‡å‘ä¸‹ä¸€ä¸ªç»“ç‚¹çš„kvèŠ‚ç‚¹ã€‚å…ˆå¯¹é”®ç¼–ç ï¼Œç”±äºå½“å‰èŠ‚ç‚¹ä¸æ˜¯ç»“æŸç»“ç‚¹ï¼Œå­˜å€¼çš„é”®ä¸ºå¥‡æ•°å­—ç¬¦æ•°ï¼Œæ‰€ä»¥å‰å¯¼å€¼ä¸º1ï¼Œåˆç”±äºå¥‡æ•°ä¸è¡¥ä½ï¼Œæœ€ç»ˆå­˜é”®ä¸º0x16ã€‚å®ƒæŒ‡å‘çš„æ˜¯ä¸€ä¸ªå…¨èŠ‚ç‚¹Aã€‚ä¸‹ä¸€å±‚çº§ï¼Œè¦ç¼–ç çš„æ˜¯då’Œhçš„ç¬¬äºŒä¸ªåŠå­—èŠ‚ï¼Œ4å’Œ6ã€‚æ‰€ä»¥åœ¨AèŠ‚ç‚¹çš„ç¬¬äº”ä¸ªä½ç½®ï¼ˆä»é›¶å¼€å§‹ï¼‰å’Œç¬¬ä¸ƒä¸ªä½ç½®ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°åˆ†åˆ«è¢«æŒ‡å‘åˆ°äº†Bå’ŒCä¸¤ä¸ªèŠ‚ç‚¹ã€‚å¯¹äºBèŠ‚ç‚¹å¾€ådoï¼Œdogï¼Œdogeæ¥è¯´ã€‚ä»–ä»¬ç´§æ¥ç€çš„éƒ½æ˜¯ä¸€ä¸ªç¼–ç ä¸º6fçš„oå­—ç¬¦ã€‚æ‰€ä»¥è¿™é‡Œï¼ŒBèŠ‚ç‚¹è¢«ç¼–ç ä¸ºæŒ‡å‘Dçš„kvç»“ç‚¹ï¼Œæ•°æ®æ˜¯æŒ‡å‘DèŠ‚ç‚¹çš„ã€‚å…¶ä¸­é”®å€¼å­˜6fï¼Œç”±äºæ˜¯æŒ‡å‘å¦ä¸€ä¸ªèŠ‚ç‚¹çš„kvèŠ‚ç‚¹ï¼Œä¸åŒ…å«ç»“æŸæ ‡è®°ï¼Œä¸”æ˜¯å¶æ•°ï¼Œéœ€è¦è¡¥ä½0ï¼Œå¾—åˆ°00ï¼Œæœ€ç»ˆçš„ç¼–ç ç»“æœæ˜¯006fã€‚åç»­èŠ‚ç‚¹ä¹Ÿä»¥æ­¤ç±»æ¨ã€‚--><h2 id="MPTåœ¨ä»¥å¤ªåŠä¸­çš„åº”ç”¨"><a href="#MPTåœ¨ä»¥å¤ªåŠä¸­çš„åº”ç”¨" class="headerlink" title="MPTåœ¨ä»¥å¤ªåŠä¸­çš„åº”ç”¨"></a>MPTåœ¨ä»¥å¤ªåŠä¸­çš„åº”ç”¨</h2><p>Merkleæ•°æ®ç»“æ„åœ¨åŒºå—é“¾é¢†åŸŸä¸­ä½¿ç”¨æ¯”è¾ƒå¹¿æ³›ï¼Œæ¯”ç‰¹å¸å’Œä»¥å¤ªåŠéƒ½æ˜¯ç”¨äº†Merkleæ ‘ï¼Œå…¶ä¸­ä»¥å¤ªåŠä¸­ä¿ç•™äº†ä¸‰é¢—MPTï¼Œåˆ†åˆ«æ˜¯<em>çŠ¶æ€æ ‘ã€äº¤æ˜“æ ‘å’Œæ”¶æ®æ ‘</em>ï¼Œè¿™ä¸‰ç§æ ‘å¯ä»¥å¸®åŠ©ä»¥å¤ªåŠå®¢æˆ·ç«¯åšä¸€äº›ç®€æ˜“çš„æŸ¥è¯¢ï¼Œå¦‚æŸ¥è¯¢æŸä¸ªè´¦æˆ·çš„ä½™é¢ã€æŸç¬”äº¤æ˜“æ˜¯å¦è¢«åŒ…å«åœ¨åŒºå—ä¸­ç­‰ã€‚</p><p>éœ€è¦æ³¨æ„çš„æ˜¯åœ¨ä»¥å¤ªåŠä¸­å¯¹MPTå†è¿›è¡Œäº†ä¸€æ¬¡å°è£…ï¼Œå¯¹*æ•°æ®é¡¹çš„keyè¿›è¡Œäº†ä¸€æ¬¡å“ˆå¸Œè®¡ç®—sha3(key)*ï¼Œvalueè¿›è¡Œäº†RLP(Recursive length prefix encoding,é€’å½’é•¿åº¦å‰ç¼€ç¼–ç )ç¼–ç ï¼Œæ•°æ®åº“ä¸­å­˜å‚¨é¢å¤–çš„sha3(key)ä¸keyä¹‹é—´çš„å¯¹åº”å…³ç³»ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://ethfans.org/toya/articles/588">https://ethfans.org/toya/articles/588</a><br><a href="https://ethfans.org/toya/articles/588">https://github.com/ethereum/wiki/wiki/Patricia-Tree</a><br><a href="https://stackoverflow.com/questions/14708134/what-is-the-difference-between-trie-and-radix-trie-data-structures">https://stackoverflow.com/questions/14708134/what-is-the-difference-between-trie-and-radix-trie-data-structures</a><br><a href="https://cs.stackexchange.com/questions/63048/what-is-the-difference-between-radix-trees-and-patricia-tries">https://cs.stackexchange.com/questions/63048/what-is-the-difference-between-radix-trees-and-patricia-tries</a></p>]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Ethereum </tag>
            
            <tag> MPT </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerå®¹å™¨logé‡‡é›†å®è·µ</title>
      <link href="/Docker-Log-Action.html"/>
      <url>/Docker-Log-Action.html</url>
      
        <content type="html"><![CDATA[<p>éšç€å®¹å™¨å’Œç¼–æ’æŠ€æœ¯æŒç»­å‘å±•ï¼Œå„ä¸ªå…¬å¸éƒ½å·²é™†ç»­åœ¨å®¹å™¨äº‘é¢†åŸŸæœ‰äº†ç›¸å…³å®è·µï¼Œè½¬è½¬ä¹Ÿä¸ä¾‹å¤–ï¼Œä¹Ÿåœ¨è¿›è¡Œä¸€äº›ç§¯ææ¢ç´¢ä¸å®è·µã€‚<br>æœ¬æ–‡ä»¥æ—¥å¿—é‡‡é›†ä¸ºåˆ‡å…¥ç‚¹ï¼Œä»‹ç»ä¸‹è½¬è½¬å®¹å™¨äº‘å¹³å°ä¸­çš„ä¸šåŠ¡æ—¥å¿—æ˜¯å¦‚ä½•è‡ªåŠ¨åŒ–é‡‡é›†çš„ã€‚</p><span id="more"></span><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨å¾®æœåŠ¡å’Œdockerå¤§ç«çš„å½“ä¸‹ï¼Œå„ä¸ªå…¬å¸éƒ½åœ¨ç§¯æä¸»æ¨å®¹å™¨åŒ–ï¼Œæœ€å¤§åŒ–çš„åˆ©ç”¨èµ„æºå¹¶å‡å°‘è¿ç»´æˆæœ¬ï¼Œå¸Œæœ›å„ä¸ªä¸šåŠ¡æ–¹èƒ½å°½æ—©æ¥å…¥äº‘å¹³å°ã€‚</p><p>è€Œåšä¸ºæ•°æ®å›¢é˜Ÿçš„æˆ‘ä»¬å´é‡åˆ°äº†ä¸€ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬çš„æ•°æ®æºç»å¤§å¤šæ•°éƒ½æ¥è‡ªäºä¸šåŠ¡ç¨‹åºçš„åŸ‹ç‚¹æ—¥å¿—ï¼Œå¦‚æœä¸šåŠ¡æ–¹è¿ç§»åˆ°äº‘å¹³å°ï¼ŒåŸ‹ç‚¹æ—¥å¿—å°†æ— æ³•é‡‡é›†ï¼Œæ‰€ä»¥æˆ‘ä»¬æ€¥éœ€ä¸€å¥—äº‘å¹³å°æ—¥å¿—é‡‡é›†æ–¹æ¡ˆã€‚</p><p>å…ˆçœ‹ä¸‹å®¹å™¨æ—¥å¿—é‡‡é›†ä¸ä¼ ç»Ÿæ—¥å¿—é‡‡é›†çš„åŒºåˆ«</p><h3 id="å®¹å™¨æ—¥å¿—é‡‡é›†ä¸ä¼ ç»Ÿæ—¥å¿—é‡‡é›†åŒºåˆ«"><a href="#å®¹å™¨æ—¥å¿—é‡‡é›†ä¸ä¼ ç»Ÿæ—¥å¿—é‡‡é›†åŒºåˆ«" class="headerlink" title="å®¹å™¨æ—¥å¿—é‡‡é›†ä¸ä¼ ç»Ÿæ—¥å¿—é‡‡é›†åŒºåˆ«"></a>å®¹å™¨æ—¥å¿—é‡‡é›†ä¸ä¼ ç»Ÿæ—¥å¿—é‡‡é›†åŒºåˆ«</h3><p>å®¹å™¨äº‘å¹³å°çš„æœ€å¤§çš„ç‰¹ç‚¹å°±æ˜¯èƒ½å¤Ÿæœ€å¤§åŒ–çš„åˆ©ç”¨èµ„æºï¼Œå¹¶ä¸”åˆ©ç”¨ç¼–æ’å·¥å…·å¯ä»¥åšåˆ°å¼¹æ€§ä¼¸ç¼©ï¼Œæ‰€ä»¥å®¹å™¨äº‘ä¸ä¼ ç»Ÿæ—¥å¿—é‡‡é›†çš„æœ€å¤§åŒºåˆ«æœ‰å¦‚ä¸‹ä¸¤ç‚¹ï¼š</p><ol><li>é‡‡é›†æ—¥å¿—çš„å®ä¾‹è¾ƒå¤šï¼Œä¸”æ•°æ®é‡è¾ƒå¤§ã€‚</li><li>é‡‡é›†æ—¥å¿—åˆ†å¸ƒä¸å›ºå®šï¼Œæ— æ³•åƒä¼ ç»Ÿæ—¥å¿—é‡‡é›†æ–¹æ¡ˆé‚£æ ·é…ç½®å›ºå®šçš„é‡‡é›†ç›®å½•ã€‚</li></ol><h2 id="è°ƒç ”"><a href="#è°ƒç ”" class="headerlink" title="è°ƒç ”"></a>è°ƒç ”</h2><ol><li>æœ€ç®€å•ç²—æš´çš„æ–¹æ³•å°±æ˜¯è®©ä¸šåŠ¡æ–¹å°†åŸ‹ç‚¹æ—¥å¿—ç›´æ¥æ‰“å…¥kafkaæˆ–è€…redisç­‰ä¸­é—´ä»¶ï¼Œè¿™ç§æ–¹å¼å¯¹ä¸šåŠ¡ä¾µå…¥æ€§è¾ƒå¤§ï¼Œæ— æ³•åšåˆ°å¯¹ä¸šåŠ¡æ— æ„ŸçŸ¥ï¼Œè¦<em>ä¿è¯æ—¥å¿—ä¼ è¾“çš„å¯é æ€§ä¹Ÿæ¯”è¾ƒå›°éš¾</em>ã€‚</li><li>ä½¿ç”¨å®¹å™¨æ¨èçš„æ–¹æ³•å°†æ—¥å¿—å†™åˆ°æ ‡å‡†è¾“å‡ºä¸­ï¼Œç„¶åä½¿ç”¨Docker Engineé‡‡é›†ã€‚è¿™ç§æ–¹å¼ä¹Ÿæ˜¯å¯¹ä¸šåŠ¡æ–¹æœ‰ä¸€å®šçš„ä¾µå…¥æ€§ã€‚</li><li>åœ¨æ¯ä¸ªå®¹å™¨å†…éƒ¨ç½²ä¸€ä¸ªæ—¥å¿—é‡‡é›†æœåŠ¡ï¼Œå¦‚flumeã€filebeatï¼Œé€šè¿‡é‡‡é›†å·¥å…·å°†æ—¥å¿—ä¼ è¾“åˆ°ä¸‹ä¸€ç¯èŠ‚ã€‚è¿™ç§æ–¹æ¡ˆå¯¹ä¸šåŠ¡æ–¹æ— æ„ŸçŸ¥ï¼Œä½†æ˜¯ä¾ç„¶å¯¹ä¸šåŠ¡ç¨‹åºæœ‰ä¸€å®šçš„ä¾µå…¥æ€§ï¼Œå› ä¸ºå­˜åœ¨é‡‡é›†ç¨‹åºå¼‚å¸¸å¯¼è‡´å®¹å™¨å´©æºƒçš„å¯èƒ½æ€§ï¼Œè€Œä¸”å®¹å™¨çš„å¯åŠ¨å’Œåœæ­¢æ˜¯ä¸€ä¸ªå¸¸æ€ï¼Œå¦‚æœé‡‡é›†æœ‰å»¶è¿Ÿçš„è¯ï¼Œå®¹å™¨åœæ­¢ä¹‹åå°†ä¼šä¸¢å¤±ä¸€éƒ¨åˆ†æ•°æ®ï¼Œæ‰€ä»¥è¿™ç§æ–¹æ¡ˆä¹Ÿä¸åˆç†ã€‚</li><li>å®¹å™¨åœ¨å¯åŠ¨æ—¶ï¼ŒæŒ‡å®šæ—¥å¿—çš„æŒ‚è½½ç›®å½•ï¼Œè¿™æ ·æ—¥å¿—å°±ä¿å­˜åˆ°äº†å®¿ä¸»æœºé‡Œï¼Œè€Œä¸”æ—¥å¿—ä¹Ÿå¯ä»¥åšåˆ°ä¸éšå®¹å™¨çš„æ¶ˆäº¡å’Œæ¶ˆå¤±ã€‚ä½†æ˜¯è¿™æ ·çš„è¯éœ€è¦ä¿è¯æŒ‚è½½ç›®å½•å”¯ä¸€ï¼Œè€Œä¸”æœ€è‡´å‘½çš„æ˜¯éœ€è¦æ ¹æ®å®¹å™¨çš„çŠ¶æ€æ›´æ–°å®¿ä¸»æœºä¸Šé‡‡é›†æœåŠ¡çš„é…ç½®æ–‡ä»¶ã€‚</li></ol><h2 id="æ¶æ„æ–¹æ¡ˆ"><a href="#æ¶æ„æ–¹æ¡ˆ" class="headerlink" title="æ¶æ„æ–¹æ¡ˆ"></a>æ¶æ„æ–¹æ¡ˆ</h2><p>è°ƒç ”ä¹‹åæˆ‘ä»¬å€¾å‘ä½¿ç”¨ç¬¬4ç§æ–¹æ³•ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šåˆ¶å®šçš„å®¹å™¨äº‘é‡‡é›†æ–¹æ¡ˆå¸Œæœ›èƒ½è§£å†³å¦‚ä¸‹é—®é¢˜ï¼š</p><ol><li>ä¸šåŠ¡æ— æ„ŸçŸ¥</li><li>èƒ½å¤Ÿé‡‡é›†å®¹å™¨å†…ä¸šåŠ¡æ—¥å¿—ï¼Œå¹¶ä¸”æ”¯æŒåŒä¸€å®¹å™¨å†…å¤šä»½æ—¥å¿—é‡‡é›†</li><li>æ–­ç‚¹ç»­ä¼ </li><li>ä»æ—¥å¿—ä¸­åŒºåˆ†æ¥æº</li><li>åŠ¨æ€å‘ç°</li><li>æ”¯æŒæ‰©å±•</li><li>æ—¥å¿—çµæ´»å½’æ¡£</li></ol><blockquote><p>æ•´ä¸ªèƒŒæ™¯è°ƒç ”ç»“æŸä¹‹åå‘ç°ä¸€ä¸ªå…³é”®ç‚¹ï¼Œé‚£å°±æ˜¯å¦‚ä½•åŠ¨æ€æ„ŸçŸ¥å®¹å™¨çš„å¯åœï¼Œä»è€Œå†³å®šé‡‡é›†å“ªäº›æ—¥å¿—ã€‚</p></blockquote><p>é˜¿é‡Œäº‘å¼€æºäº†ä¸€æ¬¾æ—¥å¿—é‡‡é›†å·¥å…·<a href="https://github.com/AliyunContainerService/log-pilot">log-pilot</a>ï¼Œæ­¤å·¥å…·æœ€å¤§çš„ç‰¹è‰²æ˜¯èƒ½å¤ŸåŠ¨æ€åœ°å‘ç°å’Œé‡‡é›†å®¹å™¨å†…éƒ¨çš„æ—¥å¿—æ–‡ä»¶ã€‚</p><h3 id="log-pilotæ¶æ„ä¸åŸç†"><a href="#log-pilotæ¶æ„ä¸åŸç†" class="headerlink" title="log-pilotæ¶æ„ä¸åŸç†"></a>log-pilotæ¶æ„ä¸åŸç†</h3><p>log-pilotæ˜¯ç”¨golangå¼€å‘çš„ï¼Œæœ¬èº«æ¶æ„æ¯”è¾ƒç®€å•ï¼Œä»£ç é‡ä¹Ÿä¸å¤§ï¼Œä¸»è¦åˆ†ä¸ºä¸‰éƒ¨åˆ†ï¼Œå…¶ä¸­ä¸€éƒ¨åˆ†å°±æ˜¯<em>å®¹å™¨äº‹ä»¶ç®¡ç†</em>ï¼Œå®ƒèƒ½å¤ŸåŠ¨æ€åœ°ç›‘å¬å®¹å™¨çš„äº‹ä»¶å˜åŒ–ï¼Œç„¶åä¾æ®å®¹å™¨çš„æ ‡ç­¾æ¥è¿›è¡Œè§£æï¼Œç”Ÿæˆæ—¥å¿—é‡‡é›†é…ç½®æ–‡ä»¶ï¼Œç„¶åäº¤ç”±é‡‡é›†æ’ä»¶æ¥è¿›è¡Œæ—¥å¿—é‡‡é›†ã€‚</p><p><img src="/blogimgs/dockerLogAction/log-pilot%E9%87%87%E9%9B%86%E6%B5%81.png" alt="log-piloté‡‡é›†æµå›¾" title="log-piloté‡‡é›†æµå›¾"><br>ç®€å•ä»‹ç»ä¸‹log-pilotæ—¥å¿—é‡‡é›†çš„æµç¨‹ï¼Œlog-pilotå®¹å™¨äº‹ä»¶ç®¡ç†æ¨¡å—ç›‘å¬åˆ°å®¹å™¨å¯åŠ¨ä¹‹åï¼Œä»å®¹å™¨çš„envä¸­è§£æç‰¹å®šæ ‡ç­¾ï¼Œç„¶åæ ¹æ®log-piloté…ç½®çš„é‡‡é›†æ’ä»¶é€šè¿‡é…ç½®æ–‡ä»¶ç®¡ç†ç”Ÿæˆå¯¹åº”çš„é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨é‡‡é›†å·¥å…·å¯¹æ—¥å¿—è¿›è¡Œé‡‡é›†ã€‚</p><p>log-pilotå¯¹é‡‡é›†åç«¯æ”¯æŒçš„ä¹Ÿæ¯”è¾ƒä¸°å¯Œï¼Œå…·ä½“å¦‚ä¸‹å›¾ï¼Œä¸è¿‡æˆ‘ä»¬ä¸ºäº†ä¸ç°æœ‰ä¼ ç»Ÿæ—¥å¿—é‡‡é›†æµç¨‹è¿›è¡Œå…¼å®¹ï¼Œæˆ‘ä»¬ä½¿ç”¨äº†fileæ¨¡å¼ï¼Œå³å°†æ—¥å¿—ä»å®¹å™¨å†…é‡‡é›†åˆ°å®¿ä¸»æœºï¼Œç„¶åå†è¿›è¡Œæ—¥å¿—æ”¶é›†ã€‚<br><img src="/blogimgs/dockerLogAction/%E9%87%87%E9%9B%86%E5%90%8E%E7%AB%AF.png" alt="log-piloté‡‡é›†åç«¯" title="log-piloté‡‡é›†åç«¯"></p><p>log-pilotä¹Ÿæ²¡æœ‰ä½¿ç”¨ç‰¹åˆ«å¤æ‚çš„æ¶æ„ï¼Œä½†æ˜¯åŠŸèƒ½è¿˜æ˜¯æ¯”è¾ƒå…¨çš„ï¼Œæˆ‘ä»¬ä½¿ç”¨ä¸»è¦åŠŸèƒ½æ˜¯æœåŠ¡å‘ç°å’ŒåŠ¨æ€æ›´æ–°é…ç½®çš„åŠŸèƒ½ï¼Œå…¶å®ƒåŠŸèƒ½è¿™é‡Œä¸å±•å¼€ï¼Œæœ‰å…´è¶£çš„å¯ä»¥å‚è€ƒ<a href="https://github.com/AliyunContainerService/log-pilot">githubä¸»é¡µ</a>ã€‚</p><h2 id="é‡‡é›†å®è·µ"><a href="#é‡‡é›†å®è·µ" class="headerlink" title="é‡‡é›†å®è·µ"></a>é‡‡é›†å®è·µ</h2><p>é€šè¿‡ä¸€äº›æµ‹è¯•å‘ç°æ­¤å·¥å…·èƒ½å¤Ÿæœ€å¤§åŒ–çš„æ»¡è¶³ç›®å‰çš„éœ€æ±‚ï¼Œåªéœ€è¦ä¸ç›®å‰å·²å­˜åœ¨çš„é‡‡é›†æµç¨‹å’Œæ—¥å¿—é‡‡é›†å·¥å•ç³»ç»Ÿè¿›è¡Œä¸‹å…¼å®¹å°±å¯ä»¥å¿«é€Ÿä¸Šçº¿ã€‚</p><h3 id="log-pilotéƒ¨ç½²"><a href="#log-pilotéƒ¨ç½²" class="headerlink" title="log-pilotéƒ¨ç½²"></a>log-pilotéƒ¨ç½²</h3><p>èµ·åˆæˆ‘ä»¬ä½¿ç”¨fluentdé‡‡é›†æ—¥å¿—ï¼Œé’ˆå¯¹fluentdçš„é…ç½®æ¨¡ç‰ˆå¹¶æ²¡æœ‰å¤ªå¤§çš„æ”¹åŠ¨ï¼Œåªæ˜¯è°ƒæ•´äº†ä¸€äº›å‚æ•°ï¼Œç›¸å…³æ”¹åŠ¨å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;buffer tag,time,docker_app,docker_service,docker_container&gt;</span><br><span class="line">  @<span class="built_in">type</span> <span class="variable">$&#123;FILE_BUFFER_TYPE:=file&#125;</span></span><br><span class="line">  path <span class="variable">$FILE_PATH</span>/.buffer</span><br><span class="line">  chunk_limit_size 8MB</span><br><span class="line">  chunk_limit_records 1000</span><br><span class="line">  flush_thread_count 20</span><br><span class="line">  flush_at_shutdown <span class="literal">true</span></span><br><span class="line">  timekey <span class="variable">$&#123;FILE_BUFFER_TIME_KEY:=1d&#125;</span></span><br><span class="line">  timekey_wait <span class="variable">$&#123;FILE_BUFFER_TIME_KEY_WAIT:=2m&#125;</span></span><br><span class="line">  timekey_use_utc <span class="variable">$&#123;FILE_BUFFER_TIME_KEY_USE_UTC:=false&#125;</span></span><br><span class="line">  $(bufferd_output)</span><br><span class="line">&lt;/buffer&gt;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªé…ç½®ä¸»è¦ç›®çš„æ˜¯å°½å¯èƒ½çš„å‡å°‘æ•°æ®å»¶è¿Ÿï¼Œå¹¶å®ç°æŒ‰ç…§æ—¶é—´å½’æ¡£æ—¥å¿—ã€‚ä½†æ˜¯ç”±äºfluentdæœ¬èº«çš„ä¸€äº›æœºåˆ¶å’Œä¸æˆ‘ä»¬ç°æœ‰é‡‡é›†æµç¨‹çš„èåˆæ€§ä¸é«˜ï¼Œåœ¨çº¿ä¸Šè¿è¡Œä¸€æ®µæ—¶é—´ä¹‹åæœ€ç»ˆæ”¾å¼ƒäº†è¯¥æ’ä»¶ï¼Œä½¿ç”¨flumeè¿›è¡Œé‡‡é›†(å…·ä½“å†…å®¹åœ¨ä¸‹ä¸€èŠ‚ä¼šä»‹ç»)ã€‚</p><p>æ›´å¤šfluentdç›¸å…³çš„å†…å®¹å¯ä»¥å‚è€ƒ<a href="https://docs.fluentd.org/v1.0/articles/buffer-section">å®˜ç½‘</a></p><p>log-pilotçš„éƒ¨ç½²æˆ‘ä»¬é‡‡ç”¨çš„æ˜¯æ¯å°å®¿ä¸»æœºä¸Šå¯åŠ¨ä¸€ä¸ªlog-pilotå®¹å™¨ï¼Œç”¨æ¥ç›‘å¬æ•´ä¸ªå®¿ä¸»æœºä¸Šæ‰€æœ‰çš„å®¹å™¨ã€‚</p><h3 id="å…³é”®åŠŸèƒ½ä»£ç è§£æ"><a href="#å…³é”®åŠŸèƒ½ä»£ç è§£æ" class="headerlink" title="å…³é”®åŠŸèƒ½ä»£ç è§£æ"></a>å…³é”®åŠŸèƒ½ä»£ç è§£æ</h3><p>ä¸Šæ–‡ä¸­æåˆ°æ¶æ„æ¯”è¾ƒç®€å•ï¼Œä¸€èµ·çœ‹ä¸‹å…³é”®åŠŸèƒ½çš„å®ç°ã€‚</p><ol><li>å®¹å™¨äº‹ä»¶ç®¡ç†</li></ol><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ—¶åˆ»ç›‘å¬</span></span><br><span class="line">msgs, errs := p.client().Events(ctx, options)</span><br><span class="line"><span class="keyword">for</span> &#123;</span><br><span class="line">  <span class="keyword">select</span> &#123;</span><br><span class="line">  <span class="keyword">case</span> msg := &lt;-msgs:</span><br><span class="line">    <span class="keyword">if</span> err := p.processEvent(msg); err != <span class="literal">nil</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="keyword">case</span> err := &lt;-errs:</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// äº‹ä»¶å¤„ç†function</span></span><br><span class="line"><span class="function"><span class="keyword">func</span> <span class="params">(p *Pilot)</span> <span class="title">processEvent</span><span class="params">(msg events.Message)</span> <span class="title">error</span></span> &#123;</span><br><span class="line">  containerId := msg.Actor.ID</span><br><span class="line">  ctx := context.Background()</span><br><span class="line">  <span class="keyword">switch</span> msg.Action &#123;</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;start&quot;</span>, <span class="string">&quot;restart&quot;</span>:</span><br><span class="line">    ...</span><br><span class="line">    containerJSON, err := p.client().ContainerInspect(ctx, containerId)</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> p.newContainer(&amp;containerJSON)</span><br><span class="line">  <span class="keyword">case</span> <span class="string">&quot;destroy&quot;</span>:</span><br><span class="line">    ...</span><br><span class="line">    err := p.delContainer(containerId)</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="literal">nil</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡è°ƒç”¨dockerçš„apiæ‹¿åˆ°äº‹ä»¶ä¿¡æ¯ï¼Œç„¶åæ•™ç”±<code>processEvent</code>è¿›è¡Œå¤„ç†ï¼Œè¿™é‡Œä¸»è¦ç›‘å¬<code>start</code>ã€<code>restart</code>å’Œ<code>destroy</code>äº‹ä»¶ã€‚<br>ç›‘å¬åˆ°<code>start</code>å’Œ<code>restart</code>äº‹ä»¶ä¹‹åï¼Œé€šè¿‡<code>inspect</code>æ‹¿åˆ°å®¹å™¨çš„ç›¸å…³ä¿¡æ¯ï¼Œç”±<code>newContainer</code>å»checkæ˜¯å¦ç”±æ—¥å¿—é‡‡é›†æ ‡è¯†ï¼Œç„¶åç”Ÿæˆå…·ä½“åˆ°é…ç½®æ–‡ä»¶ï¼Œè¿›è¡Œé‡‡é›†ã€‚</p><ol start="2"><li>ç”Ÿæˆé…ç½®æ–‡ä»¶<br>å„ä¸ªé‡‡é›†å·¥å…·çš„é…ç½®æ–‡ä»¶ç›¸å¯¹å›ºå®šï¼Œå…·æœ‰ä¸€å®šçš„è§„å¾‹æ€§ï¼Œå¯ä»¥æå‡ºä¸€ä¸ªç»Ÿä¸€çš„æ¨¡ç‰ˆï¼Œæ‰€ä»¥è¿™é‡Œä½¿ç”¨äº†<code>template</code>åŠŸèƒ½æ¥ç”Ÿæˆé…ç½®æ–‡ä»¶ï¼Œå…·ä½“ä»£ç ä¸åšå±•å¼€ï¼Œåªå±•ç¤ºä¸‹flumeçš„é…ç½®æ¨¡ç‰ˆï¼Œ<strong>è¿™ä¸ªæ¨¡ç‰ˆè§£å†³äº†k8sç¯å¢ƒä¸‹å®¹å™¨é‡å¯ä¹‹åæ—¥å¿—é‡å¤é‡‡é›†çš„é—®é¢˜</strong>ã€‚</li></ol><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;<span class="keyword">range</span> .configList&#125;&#125;</span><br><span class="line"></span><br><span class="line">a1.sources.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_source.<span class="keyword">type</span> = TAILDIR</span><br><span class="line">a1.sources.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_source.channels = &#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_channel</span><br><span class="line">a1.sources.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_source.positionFile = /flume/log_meta/source/&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;/&#123;&#123; .Name &#125;&#125;/taildir_position.json</span><br><span class="line">a1.sources.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_source.filegroups = f1</span><br><span class="line">a1.sources.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_source.filegroups.f1 = &#123;&#123; .HostDir &#125;&#125;/&#123;&#123; .File &#125;&#125;</span><br><span class="line"></span><br><span class="line">a1.channels.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_channel.<span class="keyword">type</span> = file</span><br><span class="line">a1.channels.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_channel.checkpointDir = /flume/log_meta/channel/&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;/&#123;&#123; .Name &#125;&#125;/checkpoint</span><br><span class="line">a1.channels.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_channel.dataDirs = /flume/log_meta/channel/&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;/&#123;&#123; .Name &#125;&#125;/buffer</span><br><span class="line"></span><br><span class="line">a1.sinks.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_sink.<span class="keyword">type</span> = file_roll</span><br><span class="line">a1.sinks.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_sink.channel = &#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_channel</span><br><span class="line">a1.sinks.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_sink.sink.directory = &#123;&#123; $.output &#125;&#125;/&#123;&#123; index $.container <span class="string">&quot;docker_container_subname&quot;</span> &#125;&#125;</span><br><span class="line">a1.sinks.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_sink.sink.rollInterval = <span class="number">3600000</span></span><br><span class="line">a1.sinks.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_sink.sink.pathManager.prefix = &#123;&#123; .Name &#125;&#125;</span><br><span class="line">a1.sinks.&#123;&#123;<span class="keyword">if</span> index $.container <span class="string">&quot;k8s_pod&quot;</span>&#125;&#125;&#123;&#123; index $.container <span class="string">&quot;k8s_pod&quot;</span> &#125;&#125;&#123;&#123;<span class="keyword">else</span>&#125;&#125;&#123;&#123; $.containerId &#125;&#125;&#123;&#123;end&#125;&#125;_&#123;&#123; .Name &#125;&#125;_sink.sink.pathManager.extension = log</span><br><span class="line"></span><br><span class="line">&#123;&#123;end&#125;&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªé¡¹ç›®ç”¨äº†å¾ˆå¤šgolangçš„ç‰¹æ€§ï¼Œæ¯”å¦‚channelã€åç¨‹ç­‰ç­‰ï¼Œè€Œä¸”ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œå¯¹ä¸€äº›golangå°ç™½ä¹Ÿæ¯”è¾ƒå‹å¥½ï¼Œå¯ä»¥ä½œä¸ºglangè¯­è¨€çš„å…¥é—¨é¡¹ç›®å¥½å¥½é’»ç ”ä¸‹ã€‚</p><h3 id="æ’é›·"><a href="#æ’é›·" class="headerlink" title="æ’é›·"></a>æ’é›·</h3><ol><li>æ—¶åŒºé—®é¢˜<br><code>timekey_use_utc</code>å‚æ•°ä¸ç”Ÿæ•ˆï¼Œæ€»æ˜¯æ…¢8å°æ—¶ï¼Œå‘ç°æ˜¯fluentdçš„bugï¼Œæ›´æ–°fluentdç‰ˆæœ¬åˆ°1.2.6è§£å†³ã€‚</li><li>æ•°æ®å»¶è¿Ÿ<br>éšç€ä¸šåŠ¡é‡çš„å¢é•¿ï¼Œé‡‡é›†å»¶è¿Ÿè¾ƒå¤§ï¼Œå‘ç°å¤§é‡çš„æ—¥å¿—åœ¨bufferä¸­æ— æ³•è¿›è¡Œå½’æ¡£ï¼Œå¢åŠ çº¿ç¨‹æ± <code>flush_thread_count</code>ä¸º20(æŒ‰ç…§ä¸€ä»½æ—¥å¿—ä¸€ä¸ªçº¿ç¨‹)ï¼Œå¹¶å¢åŠ <code>chunk_limit_size</code>å’Œ<code>chunk_limit_records</code>ï¼Œå»¶è¿Ÿå¾—åˆ°ç¼“è§£ï¼Œä½†æ˜¯é›¶ç‚¹ä¾ç„¶ä¼šæœ‰å»¶è¿Ÿã€‚</li><li>æ•°æ®é‡å¤é‡‡é›†<br>dockerä¸­éœ€è¦é‡‡é›†æ—¥å¿—çš„offsetè®°å½•åœ¨ä»¥containerIdå‘½åçš„ç›®å½•ä¸­ï¼Œä½†åœ¨k8sç¯å¢ƒä¸‹ï¼Œå®¹å™¨é‡å¯ä¹‹åï¼Œç”±äºå®¹å™¨æ‰€åœ¨çš„podæ²¡æœ‰æ¶ˆå¤±ï¼Œæ‰€ä»¥å®¹å™¨æ—¥å¿—çš„æŒ‚è½½ç›®å½•æ²¡æœ‰å‘ç”Ÿå˜åŒ–(ä¹Ÿå°±æ˜¯è¯´ä¹‹å‰äº§ç”Ÿçš„æ—¥å¿—è¿˜åœ¨)ï¼Œä½†æ˜¯å®¹å™¨çš„containerIdå‘ç”Ÿäº†å˜åŒ–ï¼Œå½“log-pilotå»é‡‡é›†é‡å¯ä¹‹åçš„å®¹å™¨æ—¶ï¼Œå‘ç°å¹¶æ²¡æœ‰è®°å½•offsetäºæ˜¯ä»æ–°é‡‡é›†ï¼Œäºæ˜¯å°±é€ æˆäº†æ—¥å¿—é‡å¤é‡‡é›†ã€‚</li></ol><h3 id="äºŒæ¬¡å¼€å‘ä¸ä¼˜åŒ–"><a href="#äºŒæ¬¡å¼€å‘ä¸ä¼˜åŒ–" class="headerlink" title="äºŒæ¬¡å¼€å‘ä¸ä¼˜åŒ–"></a>äºŒæ¬¡å¼€å‘ä¸ä¼˜åŒ–</h3><p>åœ¨è°ƒç ”æœŸé—´ï¼Œå‘ç°log-pilotå¹¶ä¸èƒ½å®Œå…¨æ»¡è¶³æˆ‘ä»¬çš„åœºæ™¯ï¼Œäºæ˜¯å¯¹log-pilotè¿›è¡Œäº†å®šåˆ¶åŒ–çš„å¼€å‘å’Œä¼˜åŒ–ã€‚</p><ol><li><p>æ‰©å±•åŠ¨æ€é…ç½®<br>é¦–å…ˆä¸ºäº†ä¸ç°æœ‰ä¼ ç»Ÿæ—¥å¿—é‡‡é›†æµç¨‹è¿›è¡Œå…¼å®¹ï¼Œæˆ‘ä»¬ä½¿ç”¨çš„é‡‡é›†åç«¯æ¨¡å¼æ˜¯fileï¼Œåˆ™å®¿ä¸»æœºä¸Šçš„åŸæœ‰é‡‡é›†æœåŠ¡ä¹Ÿéœ€è¦æ ¹æ®å®¹å™¨çš„å¯åœåŠ¨æ€çš„æ›´æ–°é…ç½®ï¼Œæ‰€ä»¥æˆ‘ä»¬é’ˆå¯¹è¿™ä¸ªéœ€æ±‚æˆ‘ä»¬å¯¹log-pilotè¿›è¡Œå®šåˆ¶å¼€å‘ï¼Œä½¿åŸæœ‰å¯¹é‡‡é›†æœåŠ¡èƒ½å¤ŸåŠ¨æ€çš„é‡‡é›†æ—¥å¿—ã€‚</p></li><li><p>æ—¥å¿—æ¼é‡‡<br>å…¶æ¬¡åœ¨çº¿ä¸Šè¿è¡ŒæœŸé—´å‘ç°fluentdæœ‰å»¶è¿Ÿï¼Œè€Œä¸”å¦‚æœé‡‡ç”¨æ—¶é—´å½’æ¡£æ—¥å¿—çš„è¯ï¼Œfluentdæ˜¯æŒ‰ç…§æ—¥å¿—è¿›å…¥bufferçš„æ—¶é—´è¿›è¡Œå½’æ¡£çš„ï¼Œè¿™å°±é€ æˆbufferä¸­æ•°æ®éœ€è¦ç«‹å³æ¶ˆè´¹åˆ°sinkä¸­è¿›è¡Œè§„æ¡£ï¼Œä»¥ä¾¿åç»­æµç¨‹è¿›è¡Œé‡‡é›†ï¼Œå¦‚æœæœ‰å»¶è¿Ÿå°†ä¼šé€ æˆæ•°æ®æ¼é‡‡ã€‚ä¸ºäº†å°½é‡å‡å°‘æ¼é‡‡äº‹ä»¶çš„å‘ç”Ÿï¼Œæˆ‘ä»¬æŒ‰ç…§å¤©æ¥å½’æ¡£æ—¥å¿—ã€‚ä½†æ˜¯éšåå‘ç°æœ‰çš„ä¸šåŠ¡æ—¥å¿—ç‰¹åˆ«åºå¤§ï¼Œå•ä¸ªèƒ½è¾¾åˆ°80G+ï¼Œè¿›è¡Œæ—¥å¸¸grepè¾ƒå›°éš¾ï¼Œè€Œä¸”åœ¨é›¶ç‚¹çš„æ—¶å€™ä¾ç„¶ä¼šæœ‰æ¼é‡‡çš„å¯èƒ½æ€§ã€‚äºæ˜¯å†³å®šè¦å¯¹log-pilotçš„æ’ä»¶è¿›è¡Œæ‰©å±•ï¼Œé‡‡ç”¨äº†æ¯”è¾ƒå¤§ä¼—çš„flumeï¼Œè€Œä¸”å›¢é˜Ÿå¯¹flumeä¹Ÿæœ‰ä¸€å®šçš„æŠ€æœ¯ç§¯ç´¯ã€‚</p></li><li><p>é‡å¤é‡‡é›†<br>å†³å®šå¢åŠ flumeä¹‹åï¼Œæˆ‘ä»¬å¯¹flumeä¹Ÿè¿›è¡Œäº†ä¸€äº›è°ƒæ•´ï¼Œæ¯”å¦‚æ”¯æŒä¸¥æ ¼æ„ä¹‰çš„æŒ‰ç…§æ—¶é—´è¿›è¡Œå½’æ¡£(æ­¤åŠŸèƒ½æ²¡æœ‰è´¡çŒ®ç»™ç¤¾åŒºï¼Œå› ä¸ºè¿™ä¸ªåŠŸèƒ½ç›¸å¯¹ä¸ªæ€§åŒ–)ã€‚ä½¿ç”¨çš„flumeç»„ä»¶ä¸º<code>Taildir Source</code>Â +Â <code>File Channel</code>Â +Â <code>File Roll Sink</code>ï¼Œé’ˆå¯¹<em>æ•°æ®é‡å¤é‡‡é›†</em>çš„é—®é¢˜ï¼Œæˆ‘ä»¬å°†ç›¸å…³çš„offsetæ”¾åœ¨äº†ä»¥podNameå‘½åçš„ç›®å½•ä¸­ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å®¹å™¨é‡å¯offsetä¸ä¼šä¸¢å¤±ã€‚</p></li></ol><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è™½ç„¶ç°åœ¨çœ‹ä¸‹æ•´ä¸ªæ–¹æ¡ˆå¹¶æ²¡æœ‰ä»€ä¹ˆéš¾ç‚¹ï¼Œä½†æ˜¯ä»è°ƒç ”åˆ°ä¸Šçº¿å†åˆ°åæ¥çš„æ”¹è¿›ï¼Œæ•´ä¸ªè¿‡ç¨‹è¿˜æ˜¯æ¯”è¾ƒæ›²æŠ˜çš„ã€‚é€šè¿‡å¯¹log-pilotå®šåˆ¶åŒ–å¼€å‘æˆ‘ä»¬å°†äº‘å¹³å°æ—¥å¿—é‡‡é›†æµç¨‹é›†æˆåˆ°äº†ä¼ ç»Ÿæ—¥å¿—é‡‡é›†æµç¨‹ä¸­ï¼Œå¯¹ä¸šåŠ¡æ–¹åšåˆ°æœ€å¤§çš„é€æ˜åŒ–ï¼Œæ•´ä¸ªé‡‡é›†æµç¨‹ä¾ç„¶æ˜¯ä¸šåŠ¡æ–¹å‘èµ·å·¥å•ï¼Œæˆ‘ä»¬è¿›è¡Œå®¡æ‰¹ç„¶åå°±æ˜¯è‡ªåŠ¨åŒ–çš„é‡‡é›†æµç¨‹ï¼Œä¸éœ€è¦ç”±äºå®¹å™¨çš„å¯åœè€Œè¦äººå·¥ä»‹å…¥ä¿®æ”¹é…ç½®ï¼Œæœ€å¤§åŒ–çš„é‡Šæ”¾äº†äººåŠ›æˆæœ¬ã€‚</p><p>æœ€åè¿˜æ˜¯è¦æ„Ÿè°¢é˜¿é‡Œäº‘å¼€æºäº†è¿™ä¹ˆæ£’çš„å·¥å…·ï¼Œè®©æˆ‘ä»¬å¾—ä»¥ç«™åœ¨å·¨äººçš„è‚©è†€ä¸Šçœ‹ä¸–ç•Œã€‚è½¬è½¬æœ¬ç€æ‹¥æŠ±å¼€æºï¼Œå›é¦ˆå¼€æºçš„ç†å¿µï¼Œå°†æˆ‘ä»¬é‡åˆ°çš„é—®é¢˜å’Œæ‰©å±•ä¹Ÿåé¦ˆåˆ°äº†ç¤¾åŒºï¼Œç›¸å…³PRè§é™„ä»¶ã€‚</p><h2 id="é™„ä»¶"><a href="#é™„ä»¶" class="headerlink" title="é™„ä»¶"></a>é™„ä»¶</h2><p><a href="https://issues.apache.org/jira/browse/FLUME-3306">FLUME-3306</a><br><a href="https://github.com/AliyunContainerService/log-pilot/pull/142">log-pilot#142</a><br><a href="https://github.com/AliyunContainerService/log-pilot/pull/155">log-pilot#155</a><br><a href="https://github.com/AliyunContainerService/log-pilot/pull/167">log-pilot#167</a></p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://yq.aliyun.com/articles/674327">å®¹å™¨æ—¥å¿—é‡‡é›†åˆ©å™¨Log-Pilot</a></p><!--ç°æœ‰é‡‡é›†å·¥å…·ç¼ºé™·ç¼ºä¹åŠ¨æ€é…ç½®çš„èƒ½åŠ›ç›®å‰çš„é‡‡é›†å·¥å…·éƒ½éœ€è¦æˆ‘ä»¬äº‹å…ˆæ‰‹åŠ¨é…ç½®å¥½æ—¥å¿—é‡‡é›†æ–¹å¼å’Œè·¯å¾„ç­‰ä¿¡æ¯ï¼Œç”±äºå®ƒæ— æ³•èƒ½å¤Ÿè‡ªåŠ¨æ„ŸçŸ¥åˆ°å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸå˜åŒ–æˆ–è€…åŠ¨æ€æ¼‚ç§»ï¼Œæ‰€ä»¥å®ƒæ— æ³•åŠ¨æ€åœ°å»é…ç½®ã€‚æ—¥å¿—é‡‡é›†é‡å¤æˆ–ä¸¢å¤±ç°æœ‰çš„ä¸€äº›é‡‡é›†å·¥å…·åŸºæœ¬ä¸Šæ˜¯é€šè¿‡ tail çš„æ–¹å¼æ¥è¿›è¡Œæ—¥å¿—é‡‡é›†çš„ï¼Œé‚£ä¹ˆè¿™é‡Œå°±å¯èƒ½å­˜åœ¨ä¸¤ä¸ªæ–¹é¢çš„é—®é¢˜ï¼šä¸€ä¸ªæ˜¯å¯èƒ½å¯¼è‡´æ—¥å¿—ä¸¢å¤±ï¼Œæ¯”å¦‚é‡‡é›†å·¥å…·åœ¨é‡å¯çš„è¿‡ç¨‹ä¸­ï¼Œè€Œåº”ç”¨ä¾ç„¶åœ¨å†™æ—¥å¿—ï¼Œé‚£ä¹ˆå°±æœ‰å¯èƒ½å¯¼è‡´è¿™ä¸ªçª—å£æœŸçš„æ—¥å¿—ä¸¢å¤±ï¼›è€Œå¯¹äºè¿™ç§æƒ…å†µä¸€èˆ¬ä¿å®ˆçš„åšæ³•å°±æ˜¯ï¼Œé»˜è®¤å¾€å‰å¤šé‡‡é›† 1M æ—¥å¿—æˆ– 2M çš„æ—¥å¿—ï¼Œé‚£ä¹ˆè¿™å°±åˆä¼šå¯èƒ½å¼•èµ·æ—¥å¿—é‡‡é›†é‡å¤çš„é—®é¢˜ã€‚æœªæ˜ç¡®æ ‡è®°æ—¥å¿—æºä¸€ä¸ªåº”ç”¨å¯èƒ½æœ‰å¾ˆå¤šä¸ªå®¹å™¨ï¼Œè¾“å‡ºçš„åº”ç”¨æ—¥å¿—ä¹Ÿæ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬å°†æ‰€æœ‰åº”ç”¨æ—¥å¿—æ”¶é›†åˆ°ç»Ÿä¸€æ—¥å¿—å­˜å‚¨åç«¯æ—¶ï¼Œåœ¨æœç´¢æ—¥å¿—çš„æ—¶å€™ï¼Œæˆ‘ä»¬å°±æ— æ³•æ˜ç¡®è¿™æ¡æ—¥å¿—å…·ä½“æ˜¯å“ªä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„å“ªä¸€ä¸ªåº”ç”¨å®¹å™¨äº§ç”Ÿçš„ã€‚-->]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Docker </tag>
            
            <tag> log </tag>
            
            <tag> log-pilot </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å‡½æ•°å¼ç¼–ç¨‹ä¹‹é—­åŒ…</title>
      <link href="/Func-Closure.html"/>
      <url>/Func-Closure.html</url>
      
        <content type="html"><![CDATA[<p><a href="https://zh.wikipedia.org/wiki/%E9%97%AD%E5%8C%85_(%E8%AE%A1%E7%AE%97%E6%9C%BA%E7%A7%91%E5%AD%A6)">ç»´åŸºç™¾ç§‘</a>ä¸­æ˜¯è¿™æ ·å®šä¹‰é—­åŒ…çš„ï¼š<br>åœ¨è®¡ç®—æœºç§‘å­¦ä¸­ï¼Œé—­åŒ…ï¼ˆè‹±è¯­ï¼šClosureï¼‰ï¼Œåˆç§°è¯æ³•é—­åŒ…ï¼ˆLexical Closureï¼‰æˆ–å‡½æ•°é—­åŒ…ï¼ˆfunction closuresï¼‰ï¼Œæ˜¯<strong>å¼•ç”¨äº†è‡ªç”±å˜é‡çš„å‡½æ•°</strong>ã€‚<em>è¿™ä¸ªè¢«å¼•ç”¨çš„è‡ªç”±å˜é‡å°†å’Œè¿™ä¸ªå‡½æ•°ä¸€åŒå­˜åœ¨ï¼Œå³ä½¿å·²ç»ç¦»å¼€äº†åˆ›é€ å®ƒçš„ç¯å¢ƒä¹Ÿä¸ä¾‹å¤–</em>ã€‚</p><p>è¿™é‡Œæœ‰ä¸¤ç‚¹éœ€è¦æŠŠæ¡ï¼Œ<strong>è‡ªç”±å˜é‡å’Œå‡½æ•°</strong>ã€‚åˆ™åˆ¤æ–­æ˜¯ä¸æ˜¯é—­åŒ…é¦–å…ˆåˆ¤æ–­æ˜¯ä¸æ˜¯å‡½æ•°ï¼Œå¦‚æœéƒ½ä¸æ˜¯å‡½æ•°é‚£ä¹ˆè‚¯å®šä¸æ˜¯é—­åŒ…ï¼Œæ˜¯å‡½æ•°å†ç»§ç»­åˆ¤æ–­æ˜¯å¦æœ‰è‡ªç”±å˜é‡ã€‚<br>è‡ªç”±å˜é‡å°±æ˜¯è¿™é‡Œçš„é‡ç‚¹äº†ã€‚ã€‚ã€‚</p><span id="more"></span><p>ä¸ªäººç®€å•ç²—æš´çš„å°†<em>è‡ªç”±å˜é‡</em>ç†è§£ä¸º<strong>å½“å‰å‡½æ•°å¼•ç”¨çš„å¤–éƒ¨å˜é‡</strong>ã€‚</p><p>è¿™é‡Œå…ˆä¸¾ä¸ªä¾‹å­ç®€å•æ„Ÿå—ä¸‹ï¼Œçœ‹ä¸ªgolangä»£ç ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">func</span> <span class="title">f</span><span class="params">(i <span class="keyword">int</span>)</span> <span class="title">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="function"><span class="keyword">func</span><span class="params">()</span> <span class="title">int</span></span> &#123;</span><br><span class="line">        i++</span><br><span class="line">        <span class="keyword">return</span> i</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fæ˜¯ä¸ªfunctionï¼Œæ­¤æ–¹æ³•æ˜¯è¿”å›ä¸€ä¸ªfunction(ç”±äºfè¿”å›çš„functionæ— æ³•åœ¨å¤–éƒ¨è®¿é—®ï¼Œæ²¡æœ‰å¿…è¦ç»™ä»–èµ·åå­—ï¼Œæ‰€ä»¥å°±ç›´æ¥è¿”å›ä¸€ä¸ªåŒ¿åå‡½æ•°)ã€‚<br>å…¶ä¸­å˜é‡iæ˜¯fçš„å‚æ•°ï¼Œæ˜¯fçš„å±€éƒ¨å˜é‡ï¼ŒåŒ¿åå‡½æ•°åœ¨fçš„å‘½åç©ºé—´å†…ï¼Œå¯ä»¥å¼•ç”¨å˜é‡iï¼Œè¿™ä¸ªåŒ¿åå‡½æ•°å°±æ˜¯ä¸€ä¸ªé—­åŒ…ã€‚</p><p>æˆ‘ä»¬æ ¹æ®é—­åŒ…çš„å®šä¹‰ç†è§£ä¸‹è¿™ä¸ªfçš„è¿”å›å€¼ã€‚</p><blockquote><p>å˜é‡iæ˜¯fçš„å±€éƒ¨å˜é‡ï¼Œæ­£å¸¸æƒ…å†µä¸‹fæ‰§è¡Œç»“æŸä¹‹åiä¼šè¢«å›æ”¶ï¼Œä¼šéšç€fçš„ç»“æŸè€Œæ¶ˆå¤±ã€‚ä½†æ˜¯è¿™é‡Œfè¿”å›çš„åŒ¿åå‡½æ•°å¼•ç”¨äº†iï¼Œè¿™ä¸ªiå°±ä½œä¸ºäº†è¿™ä¸ªåŒ¿åå‡½æ•°çš„å¤–éƒ¨å˜é‡ï¼Œä¹Ÿå°±æˆäº†ä¸€ä¸ªè‡ªç”±å˜é‡ï¼Œæ­¤è‡ªç”±å˜é‡ä¼šä¸åŒ¿åå‡½æ•°ä¸€åŒå­˜åœ¨ï¼Œå³ä½¿å·²ç»ç¦»å¼€äº†åˆ›é€ å®ƒçš„ç¯å¢ƒä¹Ÿä¸ä¾‹å¤–ï¼Œå½¢æˆäº†ä¸€ä¸ªå®ä½“ï¼Œä¹Ÿå°±æ˜¯é—­åŒ…ã€‚</p></blockquote><p>å†çœ‹ä¸ªä»£ç ï¼Œæˆ‘ä»¬æŠŠå®šä¹‰æ‰©å±•ä¸‹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight golang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">c1 := f(<span class="number">0</span>)</span><br><span class="line">c2 := f(<span class="number">0</span>)</span><br><span class="line">fmt.Println(c1())    <span class="comment">// reference to i, i = 0, return 1</span></span><br><span class="line">fmt.Println(c1())    <span class="comment">// reference to i, i = 1, return 2</span></span><br><span class="line">fmt.Println(c2())    <span class="comment">// reference to another i, i = 0, return 1</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä½ çœ‹è¿‡å…¶å®ƒå…³äºé—­åŒ…çš„èµ„æ–™ï¼Œä½ å¯èƒ½æœ‰è¿™ä¸ªå°è±¡ï¼Œ<em>é—­åŒ…è¿è¡Œæ—¶å¯ä»¥æœ‰å¤šä¸ªå®ä¾‹</em>ã€‚<br>æ ¹æ®ä¸Šé¢çš„ä»£ç è§£é‡Šä¸‹ï¼Œ<br>fæ˜¯ä¸€ä¸ªå‡½æ•°ï¼Œ<strong>å‡½æ•°æ˜¯ä¸€äº›å¯æ‰§è¡Œçš„ä»£ç ï¼Œè¿™äº›ä»£ç åœ¨å‡½æ•°è¢«å®šä¹‰åå°±ç¡®å®šäº†ï¼Œä¸ä¼šåœ¨æ‰§è¡Œæ—¶å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥ä¸€ä¸ªå‡½æ•°åªæœ‰ä¸€ä¸ªå®ä¾‹</strong>ã€‚f(0)è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œc1å’Œc2å¼•ç”¨çš„iæ˜¯f(0)ä¼ è¿›å»çš„0ï¼Œc1å’Œc2ç¬¬ä¸€æ¬¡æ‰§è¡Œæ—¶ï¼Œè‡ªç”±å˜é‡éƒ½ä¸º0ï¼Œæ‰§è¡Œç»“æŸåœ¨åŒ¿åå‡½æ•°å†…é€’å¢å˜ä¸º1ï¼Œå¼•ç”¨ç¯å¢ƒå‘ç”Ÿäº†å˜åŒ–ï¼Œç¬¬äºŒæ¬¡æ‰§è¡Œc1æ—¶ï¼Œé—­åŒ…ä¸­çš„å¼•ç”¨ç¯å¢ƒå·²ç»ç”±i=0å˜ä¸ºäº†i=1ï¼Œæ‰€ä»¥ç»è¿‡é€’å¢å˜ä¸ºäº†2ã€‚è¿™é‡Œä¸¤æ¬¡è°ƒç”¨c1å¾—åˆ°ä¸é€šçš„ç»“æœï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´é—­åŒ…åœ¨è¿è¡Œæ—¶ä¼šæ ¹æ®ä¸åŒçš„å¼•ç”¨ç¯å¢ƒäº§ç”Ÿä¸é€šçš„å®ä¾‹ã€‚</p><p>æ‰€è°“å¼•ç”¨ç¯å¢ƒæ˜¯æŒ‡åœ¨ç¨‹åºæ‰§è¡Œä¸­çš„æŸä¸ªç‚¹æ‰€å¤„äºæ´»è·ƒçŠ¶æ€çš„çº¦æŸæ‰€ç»„æˆçš„é›†åˆã€‚å…¶ä¸­çš„çº¦æŸæ˜¯æŒ‡ä¸€ä¸ªå˜é‡çš„åå­—å’Œå…¶æ‰€ä»£è¡¨çš„å¯¹è±¡ä¹‹é—´çš„è”ç³»ã€‚</p><!-- å˜é‡iæ˜¯å‡½æ•°fä¸­çš„å±€éƒ¨å˜é‡ï¼Œå‡è®¾è¿™ä¸ªå˜é‡æ˜¯åœ¨å‡½æ•°fçš„æ ˆä¸­åˆ†é…çš„ï¼Œæ˜¯ä¸å¯ä»¥çš„ã€‚å› ä¸ºå‡½æ•°fè¿”å›ä»¥åï¼Œå¯¹åº”çš„æ ˆå°±å¤±æ•ˆäº†ï¼Œfè¿”å›çš„é‚£ä¸ªå‡½æ•°ä¸­å˜é‡iå°±å¼•ç”¨ä¸€ä¸ªå¤±æ•ˆçš„ä½ç½®äº†ã€‚æ‰€ä»¥é—­åŒ…çš„ç¯å¢ƒä¸­å¼•ç”¨çš„å˜é‡ä¸èƒ½å¤Ÿåœ¨æ ˆä¸Šåˆ†é…ã€‚æ‰€ä»¥å°†iåˆ†é…åˆ°heapä¸Šï¼Œè¿™ä¹Ÿå°±æ˜¯è¯´é—­åŒ…å®¹æ˜“é€ æˆå†…å­˜æ³„æ¼--><!--## é—­åŒ…çš„ç”¨é€”ä¸€ä¸ªæ˜¾è€Œæ˜“è§çš„ç”¨é€”å°±æ˜¯--**ç®€åŒ–ä»£ç **ï¼Œå†è€…å°±æ˜¯å®¹æ˜“**æ¨¡å—åŒ–ï¼Œä»£ç èƒ½å¤Ÿé«˜åº¦å¤ç”¨**ï¼Œå‡å¦‚æœ‰è¿™æ ·ä¸€ä¸ªåœºæ™¯ï¼Œéœ€è¦å¯¹åˆ—è¡¨ä¸­çš„æ•°æ®è¿›è¡Œç´¯åŠ å’Œç´¯ç§¯æ—¶nums = [10,3,22,34,17]sum = 0nums.each{|n| sum += n}print sumé‚£ä¹ˆä¸ºä»€ä¹ˆè¦æŠŠå¼•ç”¨ç¯å¢ƒä¸å‡½æ•°ç»„åˆèµ·æ¥å‘¢ï¼Ÿè¿™ä¸»è¦æ˜¯å› ä¸ºåœ¨æ”¯æŒåµŒå¥—ä½œç”¨åŸŸçš„è¯­è¨€ä¸­ï¼Œæœ‰æ—¶ä¸èƒ½ç®€å•ç›´æ¥åœ°ç¡®å®šå‡½æ•°çš„å¼•ç”¨ç¯å¢ƒã€‚è€Œä¸”é—­åŒ…æ˜¯åªæœ‰è¢«è°ƒç”¨çš„æ—¶å€™æ‰ä¼šè¢«æ‰§è¡Œã€‚é—­åŒ…ä¸æ˜¯ç§æœ‰ï¼Œé—­çš„æ„æ€ä¸æ˜¯"å°é—­å†…éƒ¨çŠ¶æ€",è€Œæ˜¯"å°é—­å¤–éƒ¨çŠ¶æ€"ã€‚ä¸€ä¸ªå‡½æ•°å¦‚ä½•èƒ½å°é—­å¤–éƒ¨çŠ¶æ€å‘¢ï¼Ÿå½“å¤–éƒ¨çŠ¶æ€çš„scopeå¤±æ•ˆçš„æ—¶å€™ï¼Œè¿˜æœ‰ä¸€ä»½ç•™åœ¨å†…éƒ¨çŠ¶æ€é‡Œã€‚é—­åŒ…ï¼Œå¸¸æŒ‡æœ‰æƒè®¿é—®å…¶å¤–éƒ¨ä½œç”¨åŸŸä¸­å˜é‡å’Œå‚æ•°çš„å‡½æ•°[](https://www.zhihu.com/question/34210214)--><p><a href="https://tiancaiamao.gitbooks.io/go-internals/content/zh/03.6.html">å‚è€ƒ1</a><br><a href="https://www.ibm.com/developerworks/cn/linux/l-cn-closure/index.html">å‚è€ƒ2</a></p>]]></content>
      
      
      <categories>
          
          <category> Language </category>
          
      </categories>
      
      
        <tags>
            
            <tag> å‡½æ•°å¼ </tag>
            
            <tag> é—­åŒ… </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å…¨æ ˆVoting Dapp Demo</title>
      <link href="/Voting-Dapp-Demo.html"/>
      <url>/Voting-Dapp-Demo.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡å…¶å®ç®—æ˜¯ä¸€ç¯‡è¯‘æ–‡ï¼Œä½†ä¸æ˜¯ç›´è¯‘ï¼Œè€Œæ˜¯ç¥è¯‘ã€‚(æ„ä¼šä¸€ä¸‹å°±okäº†ã€‚ã€‚)<br><a href="https://medium.com/@mvmurthy/full-stack-hello-world-voting-ethereum-dapp-tutorial-part-1-40d2d0d807c2">åŸæ–‡åœ°å€</a></p><p><a href="http://bigdatadecode.top/Solidity_Voting%E8%A7%A3%E6%9E%90.html">ä¸Šä¸€ç¯‡</a>è¯¦ç»†ä»‹ç»äº†å®˜æ–¹Votingä¾‹å­ï¼Œ<br>æœ¬ç¯‡è¶çƒ­æ‰“é“ï¼Œä»‹ç»ä¸‹è¿™æ ·çš„ä¸€ä¸ªVotingåœ¨å®é™…ä¸­æ€ä¹ˆä½¿ç”¨ã€‚</p><span id="more"></span><p>æœ¬ç¯‡æ‰€è¦ä»‹ç»çš„æ˜¯ä¸€ä¸ªç®€å•çš„webåº”ç”¨ï¼Œé¦–å…ˆåˆå§‹åŒ–ä¸€æ‰¹å€™é€‰äººï¼Œç„¶åæ‰€æœ‰ç™»å½•é¡µé¢çš„äººéƒ½å¯ä»¥ä¸ºè¿™äº›å€™é€‰äººæŠ•ç¥¨ï¼Œå¹¶å±•ç¤ºæ¯ä¸ªå€™é€‰äººçš„å¾—ç¥¨æ•°ã€‚</p><p>å…ˆæ¥çœ‹ä¸‹æ•´ä¸ªApplicationçš„æ¶æ„å›¾ï¼š<br><img src="/blogimgs/VotingDappDemo/VotingApp.png" alt="Voting App" title="Voting App"></p><h2 id="éƒ¨ç½²å¼€å‘ç¯å¢ƒ"><a href="#éƒ¨ç½²å¼€å‘ç¯å¢ƒ" class="headerlink" title="éƒ¨ç½²å¼€å‘ç¯å¢ƒ"></a>éƒ¨ç½²å¼€å‘ç¯å¢ƒ</h2><p>å¼€å‘éƒ½ç¦»ä¸å¼€æµ‹è¯•ï¼Œæ›´ç¦»ä¸å¼€æµ‹è¯•ç¯å¢ƒï¼Œå°¤å…¶æ˜¯åŒºå—é“¾ç›¸å…³çš„å¼€å‘ï¼Œå¦‚æœç›´æ¥åœ¨å…¬ç½‘ä¸Šæµ‹è¯•ï¼Œé‚£æŸå¤±çš„å¯çœŸçš„æ˜¯çœŸé‡‘ç™½é“¶ã€‚<br>æ‰€ä»¥æˆ‘ä»¬å…ˆæä¸ªå¼€å‘ç¯å¢ƒï¼Œè¿™ä¸ªæµ‹è¯•ç¯å¢ƒæ¯”è¾ƒç®€å•ï¼Œä¹Ÿå®¹æ˜“å®‰è£…ã€‚å®ƒå°±æ˜¯ganacheï¼Œæ˜¯ä¸€ä¸ªåŸºäºå†…å­˜çš„åŒºå—é“¾æµ‹è¯•å·¥å…·ã€‚</p><!-- Ganache çš„å‰ èº«æ˜¯ testå©Cï¼Œç°åœ¨å·² ç»è¢«æ•´åˆ åˆ° Ganache é¡¹ç›® ä¸­ ã€‚ Ganache æ˜¯ä¸€ä¸ªæœ¬ åœ°å†…å­˜æ‰§è¡Œçš„è½»é‡çº§å®¢æˆ·ç«¯ï¼Œæœ‰è‰¯å¥½çš„äº¤äº’ç•Œé¢ --><p>ganacheæ˜¯nodejsçš„ä¸€ä¸ªæ¨¡å—ï¼Œå®‰è£…å‘½ä»¤ä¸º<code>cnpm install ganache-cli web3@0.20.2</code></p><blockquote><p>è¿™é‡Œä½¿ç”¨cnpmï¼Œæ˜¯å®‰è£…äº†æ·˜å®çš„nodejsæºï¼Œè®¿é—®å›½å¤–çš„å¤ªæ…¢</p></blockquote><p>æ‰§è¡Œ<code>node_modules/.bin/ganache-cli</code>å¼€å¯æµ‹è¯•åŒºå—é“¾ï¼Œæ­¤å‘½ä»¤ä¸ºé»˜è®¤ç”Ÿæˆ10æµ‹è¯•è´¦å·ï¼Œæ¯ä¸ªè´¦å·æœ‰100ETHï¼Œå¦‚ä¸‹ï¼š<br><img src="/blogimgs/VotingDappDemo/ganache-cli.png" alt="ganache-cli" title="ganache-cli"></p><h2 id="Votingåˆçº¦ä»£ç "><a href="#Votingåˆçº¦ä»£ç " class="headerlink" title="Votingåˆçº¦ä»£ç "></a>Votingåˆçº¦ä»£ç </h2><p>æ­¤ä»£ç ä¸<a href="http://bigdatadecode.top/Solidity_Voting%E8%A7%A3%E6%9E%90.html">ä¸Šä¸€ç¯‡</a>ä¸­çš„ä»£ç ä¸ä¸€æ ·ï¼Œæ²¡æœ‰é‚£ä¸ªå¤æ‚ï¼Œæœ¬ç¯‡é‡ç‚¹åœ¨æ•´ä¸ªå…¨æµç¨‹ï¼Œæœ‰å…´è¶£çš„æœ‹å‹å¯ä»¥æŠŠä¸Šä¸€ç¯‡çš„ä»£ç è¿ç§»åˆ°è¿™é‡Œã€‚</p><p>ä»£ç å†…å®¹å°±ä¸è¿‡å¤šçš„ç´¯èµ˜äº†ï¼Œè¯·çœ‹ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.25</span>;</span><br><span class="line"><span class="comment">// We have to specify what version of compiler this code will compile with</span></span><br><span class="line"></span><br><span class="line">contract Voting &#123;</span><br><span class="line">  <span class="comment">/* mapping field below is equivalent to an associative array or hash.</span></span><br><span class="line"><span class="comment">  The key of the mapping is candidate name stored as type bytes32 and value is</span></span><br><span class="line"><span class="comment">  an unsigned integer to store the vote count</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  mapping (<span class="function"><span class="params">bytes32</span> =&gt;</span> uint8) public votesReceived;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Solidity doesn&#x27;t let you pass in an array of strings in the constructor (yet).</span></span><br><span class="line"><span class="comment">  We will use an array of bytes32 instead to store the list of candidates</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"></span><br><span class="line">  bytes32[] public candidateList;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* This is the constructor which will be called once when you</span></span><br><span class="line"><span class="comment">  deploy the contract to the blockchain. When we deploy the contract,</span></span><br><span class="line"><span class="comment">  we will pass an array of candidates who will be contesting in the election</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line">  <span class="title">constructor</span>(<span class="params">bytes32[] candidateNames</span>) <span class="title">public</span> &#123;</span><br><span class="line">    candidateList = candidateNames;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This function returns the total votes a candidate has received so far</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">totalVotesFor</span>(<span class="params">bytes32 candidate</span>) <span class="title">view</span> <span class="title">public</span> <span class="title">returns</span> (<span class="params">uint8</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(validCandidate(candidate));</span><br><span class="line">    <span class="keyword">return</span> votesReceived[candidate];</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// This function increments the vote count for the specified candidate. This</span></span><br><span class="line">  <span class="comment">// is equivalent to casting a vote</span></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">voteForCandidate</span>(<span class="params">bytes32 candidate</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">    <span class="built_in">require</span>(validCandidate(candidate));</span><br><span class="line">    votesReceived[candidate] += <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">function</span> <span class="title">validCandidate</span>(<span class="params">bytes32 candidate</span>) <span class="title">view</span> <span class="title">public</span> <span class="title">returns</span> (<span class="params">bool</span>) </span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(uint i = <span class="number">0</span>; i &lt; candidateList.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (candidateList[i] == candidate) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æŠŠä¸Šé¢çš„ä»£ç å†™å…¥Voting.solæ–‡ä»¶ï¼Œç„¶åç¼–è¯‘åˆçº¦å¹¶éƒ¨ç½²åˆ°ganache blockchainä¸­ã€‚</p><h2 id="å‘½ä»¤è¡Œéƒ¨ç½²è°ƒç”¨åˆçº¦"><a href="#å‘½ä»¤è¡Œéƒ¨ç½²è°ƒç”¨åˆçº¦" class="headerlink" title="å‘½ä»¤è¡Œéƒ¨ç½²è°ƒç”¨åˆçº¦"></a>å‘½ä»¤è¡Œéƒ¨ç½²è°ƒç”¨åˆçº¦</h2><p>è¿™é‡Œæ˜¯åœ¨nodeå‘½ä»¤è¡Œä¸­ç¼–è¯‘åˆçº¦ä»£ç ï¼Œæ‰€ä»¥éœ€è¦å®‰è£…solcä¾èµ–åŒ…ï¼Œå‘½ä»¤<code>cnpm install solc</code></p><p>é¦–å…ˆåœ¨nodeå‘½ä»¤è¡Œä¸­åˆå§‹åŒ–<code>web3</code>å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">hadoop@ubuntu:~<span class="regexp">/blockchain/</span>ethereum/project/voting-app$ node</span><br><span class="line">&gt; Web3 = <span class="function"><span class="title">require</span>(<span class="params"><span class="string">&#x27;web3&#x27;</span></span>)</span></span><br><span class="line">&#123; [<span class="built_in">Function</span>: Web3]</span><br><span class="line">  <span class="attr">providers</span>:</span><br><span class="line">   &#123; <span class="attr">HttpProvider</span>: [<span class="built_in">Function</span>: HttpProvider],</span><br><span class="line">     <span class="attr">IpcProvider</span>: [<span class="built_in">Function</span>: IpcProvider] &#125; &#125;</span><br><span class="line">&gt; web3 = <span class="keyword">new</span> Web3(<span class="keyword">new</span> Web3.providers.HttpProvider(<span class="string">&quot;http://localhost:8545&quot;</span>));</span><br></pre></td></tr></table></figure><p>web3å¯¹è±¡åˆå§‹åŒ–ä¹‹åï¼Œå°±å¯ä»¥ä¸ganache blockchainçš„æµ‹è¯•ç¯å¢ƒè¿›è¡Œäº¤äº’ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤checkä¸‹æ˜¯å¦æˆåŠŸï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; web3.eth.accounts</span><br><span class="line">[ <span class="string">&#x27;0xc8d9d73906b06412f3768c5e09efe04704ac5f49&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0x6b0a0169df2e5e5c576ae92cbe1a173a12662e97&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0x0aef426a8dfc5627a6a16cd2118e2b10fdba9644&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0x11dc712466b7dd60af4ccc82bcb273853338337b&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0xc2c9f86b94d6e64dd60e8c1cf8f87355b7a05eb1&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0xf851f0b2a52024ceedee6d33d9331e6f628c4525&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0x06b0ab24104065384026f938a627c5183d477a47&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0xffcc3f6b4747e922b61fb49d9e1608a28c0523fd&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0x3847f4b5bc251da9bfc7050e51a8e33cae78080a&#x27;</span>,</span><br><span class="line">  <span class="string">&#x27;0x6c67bb1596e56cc5054296e4bf05a6e42d4fba04&#x27;</span> ]</span><br></pre></td></tr></table></figure><p>æˆåŠŸä¹‹åï¼Œå¼€å§‹ç¼–è¯‘åˆçº¦ã€‚è°ƒç”¨fsæ–¹æ³•ä»Voting.solæ–‡ä»¶ä¸­è¯»å–ä»£ç å¹¶ç¼–è¯‘ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; code = fs.readFileSync(<span class="string">&#x27;Voting.sol&#x27;</span>).toString()</span><br><span class="line">&gt; solc = <span class="built_in">require</span>(<span class="string">&#x27;solc&#x27;</span>)</span><br><span class="line">&gt; compiledCode = solc.compile(code)</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç è¿è¡ŒæˆåŠŸä¹‹åï¼ŒVotingåˆçº¦å°±ç®—ç¼–è¯‘æˆåŠŸäº†ã€‚å…¶ä¸­æœ‰ä¸¤ä¸ªå€¼æ¯”è¾ƒé‡è¦ï¼Œä¸€ä¸ªæ˜¯btyecodeå¦ä¸€ä¸ªæ˜¯ABIã€‚<br>é€šè¿‡<code>compiledCode.contracts[&#39;:Voting&#39;].bytecode</code>å¾—åˆ°åˆçº¦çš„bytecodeï¼Œæ­¤å€¼æ˜¯åˆçº¦ç¼–è¯‘ä¹‹åçš„äºŒè¿›åˆ¶ç ï¼Œå°†ä¼šéƒ¨ç½²åˆ°åŒºå—é“¾ä¸­ã€‚<br>é€šè¿‡<code>compiledCode.contracts[&#39;:Voting&#39;].interface</code>å¾—åˆ°åˆçº¦çš„ABIï¼Œæ­¤å€¼æ˜¯åœ¨åˆçº¦è°ƒç”¨ä¸­èµ·ä½œç”¨ï¼Œç”¨æ¥å‘Šè¯‰åˆçº¦ç”¨æˆ·å“ªäº›æ–¹æ³•å¯ä»¥ä½¿ç”¨ã€‚</p><p>ä¸‹é¢æˆ‘ä»¬å¼€å§‹éƒ¨ç½²å§ã€‚<br>ç¬¬ä¸€æ­¥ åˆ›å»ºåˆçº¦å¯¹è±¡ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&gt; abiDefinition = <span class="built_in">JSON</span>.parse(compiledCode.contracts[<span class="string">&#x27;:Voting&#x27;</span>].interface)</span><br><span class="line">&gt; VotingContract = web3.eth.contract(abiDefinition)</span><br><span class="line">&gt; byteCode = compiledCode.contracts[<span class="string">&#x27;:Voting&#x27;</span>].bytecode</span><br><span class="line">&gt; deployedContract = VotingContract.new([<span class="string">&#x27;Rama&#x27;</span>,<span class="string">&#x27;Nick&#x27;</span>,<span class="string">&#x27;Jose&#x27;</span>],&#123;<span class="attr">data</span>: byteCode, <span class="attr">from</span>: web3.eth.accounts[<span class="number">0</span>], <span class="attr">gas</span>: <span class="number">4700000</span>&#125;)</span><br><span class="line">&gt; deployedContract.address</span><br><span class="line">&gt; contractInstance = VotingContract.at(deployedContract.address)</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²åˆçº¦åˆ°åŒºå—é“¾çš„å…³é”®ä»£ç æ˜¯<code>VotingContract.new</code>ï¼Œä½†æ˜¯åœ¨éƒ¨ç½²åˆçº¦ä¹‹å‰ï¼Œè¦å…ˆå£°æ˜ä¸€ä¸ªåˆçº¦å¯¹è±¡<code>web3.eth.contract(abiDefinition)</code>ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯ABIã€‚<br><code>VotingContract.new</code>çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯åˆçº¦æ„é€ å‡½æ•°ä¼ å…¥çš„å€™é€‰è€…æ•°ç»„ï¼Œ<br>ç¬¬äºŒä¸ªå‡½æ•°æ˜¯ä¸€ä¸ªjsonï¼Œjsonä¸­dataæ˜¯åˆçº¦ç¼–è¯‘ä¹‹åçš„äºŒè¿›åˆ¶ç ï¼Œfromä»£è¡¨çš„æ˜¯åˆçº¦æ˜¯åˆè°éƒ¨ç½²çš„ï¼Œgaså°±ä»£è¡¨è¦æ¶ˆè€—å¤šå°‘é’±ã€‚</p><p>æ‰§è¡Œå®Œä¸Šè¿°ä»£ç ï¼Œå°±ä»£è¡¨ç€æˆ‘ä»¬å·²ç»éƒ¨ç½²äº†ä¸€ä¸ªåˆçº¦å®ä¾‹ï¼Œå¹¶ä¸”æˆ‘ä»¬å¯ä»¥ä¸åˆçº¦è¿›è¡Œäº¤äº’äº†ã€‚<br>äº¤äº’æ—¶æ˜¯ä½¿ç”¨<code>deployedContract.address</code>è¿›è¡ŒåŒºåˆ†ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ„Ÿå—ä¸‹ä¸åˆçº¦çš„äº¤äº’ã€‚</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&gt; contractInstance.totalVotesFor.call(<span class="string">&#x27;Rama&#x27;</span>)</span><br><span class="line">BigNumber &#123; <span class="attr">s</span>: <span class="number">1</span>, <span class="attr">e</span>: <span class="number">0</span>, <span class="attr">c</span>: [ <span class="number">0</span> ] &#125;</span><br><span class="line">&gt; contractInstance.voteForCandidate(<span class="string">&#x27;Rama&#x27;</span>, &#123;<span class="attr">from</span>: web3.eth.accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"><span class="string">&#x27;0x718a9b2bfdb301a838ab39d8926e5881ff6c0da775eb933f944203c3353b1cfa&#x27;</span></span><br><span class="line">&gt; contractInstance.voteForCandidate(<span class="string">&#x27;Rama&#x27;</span>, &#123;<span class="attr">from</span>: web3.eth.accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"><span class="string">&#x27;0x6c2e893552f316a4d37046baa2d030751db21bf7580559df5c051b10e71c0248&#x27;</span></span><br><span class="line">&gt; contractInstance.voteForCandidate(<span class="string">&#x27;Rama&#x27;</span>, &#123;<span class="attr">from</span>: web3.eth.accounts[<span class="number">0</span>]&#125;)</span><br><span class="line"><span class="string">&#x27;0xf211d536961f58fcca70d4b199bb814debdb445c3fff255eefb828008b0d9aa5&#x27;</span></span><br><span class="line">&gt; contractInstance.totalVotesFor.call(<span class="string">&#x27;Rama&#x27;</span>).toLocaleString()</span><br><span class="line"><span class="string">&#x27;3&#x27;</span></span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ç»™<em>Rama</em>æŠ•äº†3å¼ ç¥¨ï¼Œå¯ä»¥çœ‹åˆ°Ramaçš„ç¥¨æ•°ç¡®å®å¢åŠ äº†ï¼Œè€Œä¸”æ¯æ¬¡æŠ•ç¥¨éƒ½ä¼šè¿”å›ä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œè¿™ä¸ªå­—ç¬¦ä¸²æ˜¯transaction idã€‚</p><h2 id="webæ“ä½œåˆçº¦"><a href="#webæ“ä½œåˆçº¦" class="headerlink" title="webæ“ä½œåˆçº¦"></a>webæ“ä½œåˆçº¦</h2><p>ç°åœ¨æˆ‘ä»¬å†™ä¸ªç®€å•çš„htmlæ¥æŠŠæ•´ä¸ªä¸åˆçº¦äº¤äº’çš„æµç¨‹å¯è§†åŒ–ã€‚é¡µé¢åŒ…æ‹¬å€™é€‰è€…çš„åå­—å’Œç¥¨æ•°ï¼Œä»¥åŠæŠ•ç¥¨åŠŸèƒ½ã€‚<br>è¿™é‡Œæœ‰ä¸€ä¸ªindex.htmlå’Œä¸€ä¸ªindex.jsæ–‡ä»¶ï¼Œä»£ç åˆ†åˆ«å¦‚ä¸‹:</p><p>index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="meta-keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">title</span>&gt;</span>Hello World DApp<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&#x27;https://fonts.googleapis.com/css?family=Open+Sans:400,700&#x27;</span> <span class="attr">rel</span>=<span class="string">&#x27;stylesheet&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;text/css&#x27;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">link</span> <span class="attr">href</span>=<span class="string">&#x27;https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css&#x27;</span> <span class="attr">rel</span>=<span class="string">&#x27;stylesheet&#x27;</span> <span class="attr">type</span>=<span class="string">&#x27;text/css&#x27;</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span> <span class="attr">class</span>=<span class="string">&quot;container&quot;</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">h1</span>&gt;</span>A Simple Hello World Voting Application<span class="tag">&lt;/<span class="name">h1</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">&quot;table-responsive&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">table</span> <span class="attr">class</span>=<span class="string">&quot;table table-bordered&quot;</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">thead</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span>Candidate<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">th</span>&gt;</span>Votes<span class="tag">&lt;/<span class="name">th</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">thead</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;<span class="name">tbody</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span>Rama<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;candidate-1&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span>Nick<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;candidate-2&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">tr</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span>&gt;</span>Jose<span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">          <span class="tag">&lt;<span class="name">td</span> <span class="attr">id</span>=<span class="string">&quot;candidate-3&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">td</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">tr</span>&gt;</span></span><br><span class="line">      <span class="tag">&lt;/<span class="name">tbody</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">table</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">&quot;text&quot;</span> <span class="attr">id</span>=<span class="string">&quot;candidate&quot;</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">a</span> <span class="attr">href</span>=<span class="string">&quot;#&quot;</span> <span class="attr">onclick</span>=<span class="string">&quot;voteForCandidate()&quot;</span> <span class="attr">class</span>=<span class="string">&quot;btn btn-primary&quot;</span>&gt;</span>Vote<span class="tag">&lt;/<span class="name">a</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- å›½å†…è¿™æºå¯èƒ½è®¿é—®ä¸äº†ï¼Œæ¢æˆæœ¬åœ°çš„web3.jsæ–‡ä»¶ --&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- &lt;script src=&quot;https://cdn.rawgit.com/ethereum/web3.js/develop/dist/web3.js&quot;&gt;&lt;/script&gt; --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;https://code.jquery.com/jquery-3.1.1.slim.min.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./node_modules/web3/dist/web3.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">&quot;./index.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>index.js</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Web3 = <span class="built_in">require</span>(<span class="string">&#x27;web3&#x27;</span>);</span><br><span class="line">web3 = <span class="keyword">new</span> Web3(<span class="keyword">new</span> Web3.providers.HttpProvider(<span class="string">&quot;http://localhost:8545&quot;</span>));</span><br><span class="line">abi = <span class="built_in">JSON</span>.parse(<span class="string">&#x27;[&#123;&quot;constant&quot;:true,&quot;inputs&quot;:[&#123;&quot;name&quot;:&quot;candidate&quot;,&quot;type&quot;:&quot;bytes32&quot;&#125;],&quot;name&quot;:&quot;totalVotesFor&quot;,&quot;outputs&quot;:[&#123;&quot;name&quot;:&quot;&quot;,&quot;type&quot;:&quot;uint8&quot;&#125;],&quot;payable&quot;:false,&quot;stateMutability&quot;:&quot;view&quot;,&quot;type&quot;:&quot;function&quot;&#125;,&#123;&quot;constant&quot;:true,&quot;inputs&quot;:[&#123;&quot;name&quot;:&quot;candidate&quot;,&quot;type&quot;:&quot;bytes32&quot;&#125;],&quot;name&quot;:&quot;validCandidate&quot;,&quot;outputs&quot;:[&#123;&quot;name&quot;:&quot;&quot;,&quot;type&quot;:&quot;bool&quot;&#125;],&quot;payable&quot;:false,&quot;stateMutability&quot;:&quot;view&quot;,&quot;type&quot;:&quot;function&quot;&#125;,&#123;&quot;constant&quot;:true,&quot;inputs&quot;:[&#123;&quot;name&quot;:&quot;&quot;,&quot;type&quot;:&quot;bytes32&quot;&#125;],&quot;name&quot;:&quot;votesReceived&quot;,&quot;outputs&quot;:[&#123;&quot;name&quot;:&quot;&quot;,&quot;type&quot;:&quot;uint8&quot;&#125;],&quot;payable&quot;:false,&quot;stateMutability&quot;:&quot;view&quot;,&quot;type&quot;:&quot;function&quot;&#125;,&#123;&quot;constant&quot;:true,&quot;inputs&quot;:[&#123;&quot;name&quot;:&quot;&quot;,&quot;type&quot;:&quot;uint256&quot;&#125;],&quot;name&quot;:&quot;candidateList&quot;,&quot;outputs&quot;:[&#123;&quot;name&quot;:&quot;&quot;,&quot;type&quot;:&quot;bytes32&quot;&#125;],&quot;payable&quot;:false,&quot;stateMutability&quot;:&quot;view&quot;,&quot;type&quot;:&quot;function&quot;&#125;,&#123;&quot;constant&quot;:false,&quot;inputs&quot;:[&#123;&quot;name&quot;:&quot;candidate&quot;,&quot;type&quot;:&quot;bytes32&quot;&#125;],&quot;name&quot;:&quot;voteForCandidate&quot;,&quot;outputs&quot;:[],&quot;payable&quot;:false,&quot;stateMutability&quot;:&quot;nonpayable&quot;,&quot;type&quot;:&quot;function&quot;&#125;,&#123;&quot;inputs&quot;:[&#123;&quot;name&quot;:&quot;candidateNames&quot;,&quot;type&quot;:&quot;bytes32[]&quot;&#125;],&quot;payable&quot;:false,&quot;stateMutability&quot;:&quot;nonpayable&quot;,&quot;type&quot;:&quot;constructor&quot;&#125;]&#x27;</span>)</span><br><span class="line">VotingContract = web3.eth.contract(abi);</span><br><span class="line"><span class="comment">// In your nodejs console, execute contractInstance.address to get the address at which the contract is deployed and change the line below to use your deployed address</span></span><br><span class="line">contractInstance = VotingContract.at(<span class="string">&#x27;0xd018d4ed72e54fc3d66f254dfead8965577403dd&#x27;</span>);</span><br><span class="line">candidates = &#123;<span class="string">&quot;Rama&quot;</span>: <span class="string">&quot;candidate-1&quot;</span>, <span class="string">&quot;Nick&quot;</span>: <span class="string">&quot;candidate-2&quot;</span>, <span class="string">&quot;Jose&quot;</span>: <span class="string">&quot;candidate-3&quot;</span>&#125;</span><br><span class="line"><span class="keyword">var</span> account;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">voteForCandidate</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  candidateName = $(<span class="string">&quot;#candidate&quot;</span>).val();</span><br><span class="line">  contractInstance.voteForCandidate(candidateName, &#123;<span class="attr">from</span>: account&#125;, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">let</span> div_id = candidates[candidateName];</span><br><span class="line">    $(<span class="string">&quot;#&quot;</span> + div_id).html(contractInstance.totalVotesFor.call(candidateName).toString());</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$(<span class="built_in">document</span>).ready(<span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  web3.eth.getAccounts(<span class="function"><span class="keyword">function</span> (<span class="params">err, accs</span>) </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (err != <span class="literal">null</span>) &#123;</span><br><span class="line">        alert(<span class="string">&#x27;There was an error fetching your accounts.&#x27;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (accs.length === <span class="number">0</span>) &#123;</span><br><span class="line">        alert(<span class="string">&quot;Couldn&#x27;t get any accounts! Make sure your Ethereum client is configured correctly.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      account = accs[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">  candidateNames = <span class="built_in">Object</span>.keys(candidates);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">var</span> i = <span class="number">0</span>; i &lt; candidateNames.length; i++) &#123;</span><br><span class="line">    <span class="keyword">let</span> name = candidateNames[i];</span><br><span class="line">    <span class="keyword">let</span> val = contractInstance.totalVotesFor.call(name).toString()</span><br><span class="line">    $(<span class="string">&quot;#&quot;</span> + candidates[name]).html(val);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ³¨æ„ä¸‹index.jsæ–‡ä»¶ï¼Œè¿™é‡Œå±•ç¤ºäº†å¦‚ä½•ä½¿ç”¨ABIå’Œaddressä¸åˆçº¦è¿›è¡Œäº¤äº’ã€‚</p><p>ä»£ç æå¥½ä¹‹åï¼Œå®‰è£…ä¸€ä¸ªweb serverï¼Œè¿™é‡Œå®‰è£…http-serverï¼Œå‘½ä»¤<code>cnpm install -g http-server</code><br>å®‰è£…æˆåŠŸä¹‹åï¼Œåœ¨é¡¹ç›®ç›®å½•ä¸‹è¿è¡Œ<code>http-server</code>å¯åŠ¨ç¨‹åºï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Starting up http-server, serving ./</span><br><span class="line">Available on:</span><br><span class="line">  http://127.0.0.1:8080</span><br><span class="line">  http://192.168.234.138:8080</span><br><span class="line">Hit CTRL-C to stop the server</span><br></pre></td></tr></table></figure><p>è®¿é—®ä¸Šè¿°çš„ç½‘å€ï¼Œå¯è§å¦‚ä¸‹é¡µé¢ï¼š<br><img src="/blogimgs/VotingDappDemo/webDapp.png" alt="webé¡µé¢" title="webé¡µé¢"><br>åœ¨æ–‡æœ¬æ¡†ä¸­è¾“å…¥å€™é€‰äººçš„åå­—ï¼Œç„¶åç‚¹å‡»<strong>Vote</strong>æäº¤ï¼Œå°±å¯ä»¥åœ¨çœ‹è§å¯¹åº”å€™é€‰äººçš„ç¥¨æ•°åŠ 1ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä¸€ä¸ªå®Œæ•´çš„Dapp Demoç»“æŸäº†ï¼Œæ˜¯ä¸æ˜¯æ„Ÿè§‰ä¹Ÿæ²¡æœ‰æƒ³è±¡ä¸­çš„ç¥ç§˜ï¼Œä½†æˆ‘æƒ³è¯´è¿™åªæ˜¯ä¸Šå±‚çš„ä½¿ç”¨ï¼ŒçœŸæ­£ç¥ç§˜çš„ä¸œè¥¿æ˜¯åº•å±‚çš„æŠ€æœ¯æ”¯æ’‘ï¼Œæ…¢æ…¢æ¢ç§˜å§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Ethereum </tag>
            
            <tag> Solidity </tag>
            
            <tag> Dapp </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Applicationè¿è¡Œå¤±è´¥å¯¼è‡´RMä¸»å¤‡åˆ‡æ¢</title>
      <link href="/Application-fail-RM-change.html"/>
      <url>/Application-fail-RM-change.html</url>
      
        <content type="html"><![CDATA[<p>å…ˆè¯´æ•…éšœç°è±¡:<br>æŸå¤©æ”¶åˆ°RMä¸»å¤‡åˆ‡æ¢æŠ¥è­¦ï¼Œæ­£å¸¸åˆ‡æ¢å¹¶ä¸ä¼šæœ‰ä»€ä¹ˆå½±å“ï¼Œä½†æˆ‘å½“æ—¶è¿˜æ˜¯å‡ºäºè­¦è§‰æƒ³å»æœåŠ¡å™¨ä¸Šcheckä¸‹ä¸ºä»€ä¹ˆåˆ‡ï¼Œcheckçš„æ—¶å€™å‘ç°é›†ç¾¤æ— æ³•æäº¤ä»»åŠ¡ï¼Œæ‰€ä»¥çš„ä»»åŠ¡éƒ½è¢«æŒ‚èµ·äº†ã€‚<br>ç¬¬ä¸€ååº”æ˜¯åŸstandbyèŠ‚ç‚¹æœ‰é—®é¢˜ï¼Œäºæ˜¯æ‰‹åŠ¨åˆè§¦å‘äº†ä¸€æ¬¡åˆ‡æ¢ï¼Œä½†ä»»åŠ¡ä¾ç„¶æ— æ³•è¿è¡Œã€‚ä¸»å¤‡RMéƒ½é‡å¯è¿‡äº†ä½†é—®é¢˜ä¾ç„¶æ— æ³•è§£å†³ï¼Œé‚£åªèƒ½ä½¿ç”¨ç»ˆææ€æ‰‹é”äº†ï¼Œé‡å¯äº†æ•´ä¸ªyarné›†ç¾¤ã€‚<br>é›†ç¾¤é‡å¯ä¹‹åä»»åŠ¡æ¢å¤äº†ï¼Œå¿ƒé‡Œèˆ’äº†ä¸€å£æ°”ï¼Œå»æŸ¥RMçš„logå§ï¼Œçœ‹ä¸‹æ˜¯ä»€ä¹ˆåŸå› å¯¼è‡´äº†è¿™æ¬¡æ•…éšœï¼Œlogè¿˜æ²¡æœ‰ç»†çœ‹ï¼Œåªçœ‹åˆ°ä¸€äº›<code>KeeperErrorCode = ConnectionLoss</code>ï¼Œæ­¤æ—¶æ‚²å‰§å‘ç”Ÿäº†ï¼Œåˆæ”¶åˆ°äº†RMåˆ‡æ¢çš„æŠ¥è­¦ï¼Œä»»åŠ¡åˆè¢«æŒ‚èµ·äº†ã€‚ã€‚ã€‚</p><p>æ¯«æ— å¤´ç»ªï¼Œåªèƒ½å†æ¬¡é‡å¯é›†ç¾¤ï¼Œ<em>è¿™æ¬¡é‡ç‚¹å…³æ³¨äº†ä¸‹é›†ç¾¤ä¸Šè¿è¡Œä»»åŠ¡ï¼Œä¼°è®¡æ˜¯å“ªä¸ªä»»åŠ¡æŠŠé›†ç¾¤ç»™å¹²ç˜«äº†</em>ï¼Œè§‚å¯Ÿåˆ°æœ‰ä¸ªä»»åŠ¡è¿è¡Œå¤±è´¥çš„æ—¶å€™é›†ç¾¤å°±ä¼šè¢«ç˜«ï¼Œçœ‹äº†ä¸‹è¯¥ä»»åŠ¡çš„<strong>æŠ¥é”™ä¿¡æ¯ç‰¹åˆ«ç‰¹åˆ«çš„é•¿</strong>ï¼Œäºæ˜¯å‘Šè¯‰ä»»åŠ¡çš„è´Ÿè´£äººæš‚æ—¶æŠŠä»»åŠ¡åœæ‰ï¼Œè§‚å¯Ÿä¸‹é›†ç¾¤æ˜¯ä¸æ˜¯å› ä¸ºè¿™ä¸ªä»»åŠ¡å¯¼è‡´çš„ã€‚</p><p>è¯¥ä»»åŠ¡åœæ‰ä¹‹åé›†ç¾¤æ­£å¸¸è¿è¡Œäº†ä¸€æ®µæ—¶é—´ï¼Œåœ¨è¿™æ®µæ—¶é—´å†…åœ¨æŸ¥RMçš„logå¹¶æ²¡æœ‰å‘ç°å¤ªå¤šæœ‰ä»·å€¼çš„ä¸œè¥¿ï¼Œå…¨æ˜¯ä¸zkçš„è¿æ¥ä¸¢å¤±ï¼Œè¿æ¥ä¸¢å¤±ç¡®å®æ˜¯ä¼šè§¦å‘ä¸»å¤‡åˆ‡æ¢ï¼Œä½†å…³é”®æ˜¯ä¸ºä»€ä¹ˆè¿æ¥ä¼šä¸¢å¤±å‘¢ï¼Ÿæ²¡æœ‰å¤´ç»ªï¼Œåªå¥½å»zk serverç«¯çœ‹ä¸‹logï¼Œå‘ç°æŠ¥<code>2018-11-27 15:54:30,208 [myid:1] - WARN  [NIOServerCxn.Factory:0.0.0.0/0.0.0.0:2181:NIOServerCnxn@373] - Exception causing close of session 0x36753e378030000 due to java.io.IOException: Len error 8603591</code></p><span id="more"></span><p>å¯¹è¿™ä¸ªerrorè¿›è¡Œäº†æœç´¢ä¹‹åï¼Œæœ‰äººè¯´æ˜¯zkçš„ä¸€ä¸ªbugï¼Œåœ¨æŸä¸ªç‰ˆæœ¬ä¸­å·²ç»ä¿®å¤ï¼Œè€Œæˆ‘ç”¨çš„è¿™ä¸ªç‰ˆæœ¬æˆ‘çœ‹äº†ä¸‹ä»£ç ä¹Ÿå·²ç»ä¿®å¤äº†ï¼Œåæ¥æ‰‹é‡Œæœ‰å…¶å®ƒäº‹å†å¿™ï¼Œå°±åˆå¦ä¸€ä¸ªåŒäº‹è·Ÿè¿™ä¸ªæ•…éšœï¼Œè°ƒæ•´äº†ä¸ªzkçš„å‚æ•°<code>jute.maxbuffer</code>æå®šï¼Œè¿™ä¸ªå‚æ•°æ§åˆ¶ç€å†™å…¥nodeçš„æ•°æ®é‡ã€‚</p><blockquote><p>æ•´ä¸ªæ•…éšœçš„åŸå› æ˜¯appåœ¨å¤±è´¥çš„æ—¶å€™ä¼šå†™å…¥ä¸€äº›ä¿¡æ¯åˆ°zkï¼Œè¿™äº›ä¿¡æ¯è¶…è¿‡äº†zkçš„é»˜è®¤é…ç½®ï¼Œå¯¼è‡´å†™å¤±è´¥ï¼Œé“¾æ¥å°±ä¸¢å¤±äº†ï¼Œä¸»å¤‡å°±åˆ‡æ¢äº†ï¼Œåˆ‡æ¢æˆåŠŸä¹‹åä¾ç„¶å†å°è¯•å»å†™ï¼Œæ€»æ˜¯å†™å¤±è´¥ï¼Œæ‰€ä»¥æ•´ä¸ªé›†ç¾¤å°±è¢«å¡ä½äº†ã€‚</p></blockquote><h2 id="Root-Cause"><a href="#Root-Cause" class="headerlink" title="Root Cause"></a>Root Cause</h2><p>è¿™æ¬¡å¹¶æ²¡æœ‰ä»€ä¹ˆå…³é”®å­—å¯ä»¥è®©æˆ‘ä»¬è¿…é€Ÿæ‰¾åˆ°å…³é”®ä»£ç å¤„ï¼Œæ­¤æ—¶ä½ å¯¹æºç çš„ç†Ÿæ‚‰ç¨‹åº¦å°±èƒ½å¸®ä½ è¿…é€Ÿçš„å®šä½äº†ï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦ç†Ÿæ‚‰æºç çš„åŸå› ã€‚</p><p>æˆ‘ä»¬å…ˆæ¥æ¢³ç†ä¸‹æ•´ä¸ªæ•…éšœçš„å…¨æµç¨‹ï¼Œæµç¨‹å¦‚ä¸‹ï¼š<br><img src="/blogimgs/Application-RM-change/state.png" alt="æ•…éšœæµç¨‹" title="æ•…éšœæµç¨‹"></p><p>æ˜¯ä¸æ˜¯æœ‰ç‚¹ApplicationçŠ¶æ€æœºçš„æ ·å­ï¼Œé‚£æˆ‘ä»¬å°±ä»è¿™é‡Œå…¥æ‰‹ã€‚</p><p>ApplicationçŠ¶æ€æ˜¯ä»<code>RUNNING</code>çŠ¶æ€åˆäº‹ä»¶<code>ATTEMPT_FAILED</code>è§¦å‘ï¼Œå°†çŠ¶æ€è¿›è¡Œæ”¹å˜çš„ï¼Œçœ‹ä¸‹å¯¹åº”çŠ¶æ€è½¬åŒ–çš„å¤„ç†ç±»<code>AttemptFailedTransition</code>ã€‚<br>åœ¨<code>transition</code>æ–¹æ³•ä¸­æ‰¾åˆ°å…³é”®æ–¹æ³•<code>rememberTargetTransitionsAndStoreState</code>ï¼Œçœ‹ä¸‹ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">rememberTargetTransitionsAndStoreState</span><span class="params">(RMAppEvent event,</span></span></span><br><span class="line"><span class="params"><span class="function">    Object transitionToDo, RMAppState targetFinalState,</span></span></span><br><span class="line"><span class="params"><span class="function">    RMAppState stateToBeStored)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  String diags = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">  <span class="keyword">case</span> APP_REJECTED:</span><br><span class="line">  <span class="keyword">case</span> ATTEMPT_FINISHED:</span><br><span class="line">  <span class="keyword">case</span> ATTEMPT_KILLED:</span><br><span class="line">    diags = event.getDiagnosticMsg();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> ATTEMPT_FAILED:</span><br><span class="line">    RMAppFailedAttemptEvent failedEvent = (RMAppFailedAttemptEvent) event;</span><br><span class="line">    diags = getAppAttemptFailedDiagnostics(failedEvent);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//      add by sunzhiwei for zk jute.maxbuffer</span></span><br><span class="line">  <span class="keyword">if</span> (diags.length() &gt; zkMaxBuffer) &#123;</span><br><span class="line">    diags = diags.substring(<span class="number">0</span>, zkMaxBuffer);</span><br><span class="line">    LOG.warn(<span class="string">&quot;The diags is too long, so it needs to be intercepted : &quot;</span> + diags);</span><br><span class="line">  &#125;</span><br><span class="line">  ApplicationStateData appState =</span><br><span class="line">      ApplicationStateData.newInstance(<span class="keyword">this</span>.submitTime, <span class="keyword">this</span>.startTime,</span><br><span class="line">          <span class="keyword">this</span>.user, <span class="keyword">this</span>.submissionContext,</span><br><span class="line">          stateToBeStored, diags, <span class="keyword">this</span>.storedFinishTime);</span><br><span class="line">  <span class="keyword">this</span>.rmContext.getStateStore().updateApplicationState(appState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡ŒæŠŠdiagsè¿›è¡Œå°è£…ï¼Œé€šè¿‡<code>updateApplicationState</code>å°†appç›¸å…³çš„ä¿¡æ¯å†™å…¥zkä¸­ã€‚(ä¸å†™å…¥zkç›¸å…³çš„ä»£ç åœ¨<code>ZKRMStateStore.updateApplicationStateInternal</code>ä¸­)</p><p>çŸ¥é“äº†åŸå› å°±å¥½åŠäº†ï¼Œæˆ‘åœ¨è¿™é‡Œå°†diagsçš„é•¿åº¦è¿›è¡Œäº†æˆªå–ï¼Œå¹¶å°†å…¶æˆªå–çš„é•¿åº¦è¿›è¡Œäº†å¯é…ç½®åŒ–ã€‚<br>ä¹‹æ‰€ä»¥è¿™ä¹ˆæ”¹æ˜¯å› ä¸ºæˆ‘ä»¬ä¸èƒ½ä¸€å‘³çš„è°ƒæ•´zkçš„<code>jute.maxbuffer</code>å‚æ•°ï¼Œè¿™å§‹ç»ˆæ˜¯ä¸ªé›·ï¼Œæˆ‘ä»¬åº”è¯¥ä»æ ¹å¤„è§£å†³é—®é¢˜ã€‚</p><p>ç›®å‰æ­¤ä»£ç å·²æäº¤ç»™ç¤¾åŒºï¼Œjiraåœ°å€æ˜¯<a href="https://issues.apache.org/jira/browse/YARN-9065">YARN-9065</a></p><p>ä½†æ˜¯æäº¤åˆ°ç¤¾åŒºä¹‹åï¼Œç›¸å…³äººå‘˜åé¦ˆäº†å¦ä¸€ä¸ªpatchï¼Œä»–ä¿®å¤çš„æ–¹å¼æ¯”æˆ‘çš„æ–¹æ³•ä¼˜é›…ï¼Œæ„Ÿè§‰è‡ªå·±è¿˜æ˜¯å¤ªç®€å•ç²—æš´äº†ï¼Œå˜¿å˜¿ã€‚ã€‚ã€‚è´´ä¸‹jiraåœ°å€å¯ä»¥å‚è€ƒä¸‹<a href="https://issues.apache.org/jira/browse/YARN-6125">YARN-6125</a></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> ZK </tag>
            
            <tag> Len error </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Solidity Votingè§£æ</title>
      <link href="/Solidity_Voting%E8%A7%A3%E6%9E%90.html"/>
      <url>/Solidity_Voting%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘ä¸€ç›´åœ¨å­¦ä¹ BlockChainç›¸å…³çš„çŸ¥è¯†ï¼ŒEthereumç½‘ä¸Šä¹Ÿæ²¡æœ‰å¤ªå¥½çš„èµ„æ–™ï¼Œå°±å…ˆæ‹¿å®˜ç½‘çš„ä¸€äº›exampleå­¦ä¹ ä¸‹å§ã€‚</p><p>æœ¬ç¯‡è§£æä¸‹ä½¿ç”¨æ™ºèƒ½åˆçº¦ç¼–å†™çš„æŠ•ç¥¨åˆçº¦ã€‚</p><span id="more"></span><p>å…ˆçœ‹ä¸‹ä»£ç ï¼Œæ³¨é‡Šç»™çš„ä¹Ÿæ¯”è¾ƒæ¸…æ¥šï¼Œè™½ç„¶æ˜¯ä¸€é—¨æ–°çš„è¯­è¨€ï¼Œä½†è¯»æ‡‚åº”è¯¥æ²¡æœ‰ä»€ä¹ˆéš¾åº¦</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br></pre></td><td class="code"><pre><span class="line">pragma solidity ^<span class="number">0.4</span><span class="number">.22</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/// @title å§”æ‰˜æŠ•ç¥¨</span></span><br><span class="line">contract Ballot &#123;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå£°æ˜äº†ä¸€ä¸ªæ–°çš„å¤åˆç±»å‹ç”¨äºç¨åçš„å˜é‡</span></span><br><span class="line">    <span class="comment">// å®ƒç”¨æ¥è¡¨ç¤ºä¸€ä¸ªé€‰æ°‘</span></span><br><span class="line">    struct Voter &#123;</span><br><span class="line">        uint weight; <span class="comment">// è®¡ç¥¨çš„æƒé‡ï¼Œä¹Ÿå°±æ˜¯ç¥¨æ•°</span></span><br><span class="line">        bool voted;  <span class="comment">// è‹¥ä¸ºçœŸï¼Œä»£è¡¨è¯¥äººå·²æŠ•ç¥¨</span></span><br><span class="line">        address delegate; <span class="comment">// è¢«å§”æ‰˜äºº</span></span><br><span class="line">        uint vote;   <span class="comment">// æŠ•ç¥¨ææ¡ˆçš„ç´¢å¼•</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ææ¡ˆçš„ç±»å‹</span></span><br><span class="line">    struct Proposal &#123;</span><br><span class="line">        bytes32 name;   <span class="comment">// ç®€ç§°ï¼ˆæœ€é•¿32ä¸ªå­—èŠ‚ï¼‰</span></span><br><span class="line">        uint voteCount; <span class="comment">// å¾—ç¥¨æ•°</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    address public chairperson;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿™å£°æ˜äº†ä¸€ä¸ªçŠ¶æ€å˜é‡ï¼Œä¸ºæ¯ä¸ªå¯èƒ½çš„åœ°å€å­˜å‚¨ä¸€ä¸ª `Voter`ã€‚</span></span><br><span class="line">    <span class="comment">// æœ‰æƒåˆ©æŠ•ç¥¨çš„ç”¨æˆ·map</span></span><br><span class="line">    mapping(<span class="function"><span class="params">address</span> =&gt;</span> Voter) public voters;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸€ä¸ª `Proposal` ç»“æ„ç±»å‹çš„åŠ¨æ€æ•°ç»„</span></span><br><span class="line">    <span class="comment">// æŠ•ç¥¨ææ¡ˆæ•°ç»„</span></span><br><span class="line">    Proposal[] public proposals;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸º `proposalNames` ä¸­çš„æ¯ä¸ªææ¡ˆï¼Œåˆ›å»ºä¸€ä¸ªææ¡ˆå¯¹è±¡</span></span><br><span class="line">    <span class="comment">// åˆçº¦çš„æ„é€ å‡½æ•°ï¼Œç”¨constructoræ ‡è¯†</span></span><br><span class="line">    <span class="title">constructor</span>(<span class="params">bytes32[] proposalNames</span>) <span class="title">public</span> &#123;</span><br><span class="line">        <span class="comment">// åˆçº¦çš„æ„é€ è€…ä¸ºchairperson</span></span><br><span class="line">        chairperson = msg.sender;</span><br><span class="line">        <span class="comment">// èµ‹äºˆæŠ•ç¥¨çš„æƒåˆ©</span></span><br><span class="line">        voters[chairperson].weight = <span class="number">1</span>;</span><br><span class="line">        <span class="comment">//å¯¹äºæä¾›çš„æ¯ä¸ªææ¡ˆåç§°ï¼Œ</span></span><br><span class="line">        <span class="comment">//åˆ›å»ºä¸€ä¸ªæ–°çš„ Proposal å¯¹è±¡å¹¶æŠŠå®ƒæ·»åŠ åˆ°æ•°ç»„çš„æœ«å°¾ã€‚</span></span><br><span class="line">        <span class="keyword">for</span> (uint i = <span class="number">0</span>; i &lt; proposalNames.length; i++) &#123;</span><br><span class="line">            <span class="comment">// `Proposal(&#123;...&#125;)` åˆ›å»ºä¸€ä¸ªä¸´æ—¶ Proposal å¯¹è±¡ï¼Œ</span></span><br><span class="line">            <span class="comment">// `proposals.push(...)` å°†å…¶æ·»åŠ åˆ° `proposals` çš„æœ«å°¾</span></span><br><span class="line">            proposals.push(Proposal(&#123;</span><br><span class="line">                <span class="attr">name</span>: proposalNames[i],</span><br><span class="line">                <span class="attr">voteCount</span>: <span class="number">0</span></span><br><span class="line">            &#125;));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æˆæƒ `voter` æŠ•ç¥¨çš„æƒåˆ©</span></span><br><span class="line">    <span class="comment">// åªæœ‰ `chairperson` å¯ä»¥è°ƒç”¨è¯¥å‡½æ•°ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">giveRightToVote</span>(<span class="params">address voter</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">// è‹¥ `require` çš„ç¬¬ä¸€ä¸ªå‚æ•°çš„è®¡ç®—ç»“æœä¸º `false`ï¼Œ</span></span><br><span class="line">        <span class="comment">// åˆ™ç»ˆæ­¢æ‰§è¡Œï¼Œæ’¤é”€æ‰€æœ‰å¯¹çŠ¶æ€å’Œä»¥å¤ªå¸ä½™é¢çš„æ”¹åŠ¨ã€‚</span></span><br><span class="line">        <span class="comment">// åœ¨æ—§ç‰ˆçš„ EVM ä¸­è¿™æ›¾ç»ä¼šæ¶ˆè€—æ‰€æœ‰ gasï¼Œä½†ç°åœ¨ä¸ä¼šäº†ã€‚</span></span><br><span class="line">        <span class="comment">// ä½¿ç”¨ require æ¥æ£€æŸ¥å‡½æ•°æ˜¯å¦è¢«æ­£ç¡®åœ°è°ƒç”¨ï¼Œæ˜¯ä¸€ä¸ªå¥½ä¹ æƒ¯ã€‚</span></span><br><span class="line">        <span class="comment">// ä½ ä¹Ÿå¯ä»¥åœ¨ require çš„ç¬¬äºŒä¸ªå‚æ•°ä¸­æä¾›ä¸€ä¸ªå¯¹é”™è¯¯æƒ…å†µçš„è§£é‡Šã€‚</span></span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            msg.sender == chairperson,</span><br><span class="line">            <span class="string">&quot;Only chairperson can give right to vote.&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">require</span>(</span><br><span class="line">            !voters[voter].voted,</span><br><span class="line">            <span class="string">&quot;The voter already voted.&quot;</span></span><br><span class="line">        );</span><br><span class="line">        <span class="built_in">require</span>(voters[voter].weight == <span class="number">0</span>);</span><br><span class="line">        voters[voter].weight = <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// æŠŠä½ çš„æŠ•ç¥¨æƒåˆ©å§”æ‰˜ç»™ `to`ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">delegate</span>(<span class="params">address to</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        <span class="comment">// ä¼ å¼•ç”¨ (ä¸ºä»€ä¹ˆè¿™é‡Œä¼ çš„æ˜¯å¼•ç”¨ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ)</span></span><br><span class="line">        Voter storage sender = voters[msg.sender];</span><br><span class="line">        <span class="built_in">require</span>(!sender.voted, <span class="string">&quot;You already voted.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">require</span>(to != msg.sender, <span class="string">&quot;Self-delegation is disallowed.&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å§”æ‰˜æ˜¯å¯ä»¥ä¼ é€’çš„ï¼Œåªè¦è¢«å§”æ‰˜è€… `to` ä¹Ÿè®¾ç½®äº†å§”æ‰˜ã€‚</span></span><br><span class="line">        <span class="comment">// ä¸€èˆ¬æ¥è¯´ï¼Œè¿™ç§å¾ªç¯å§”æ‰˜æ˜¯å±é™©çš„ã€‚å› ä¸ºï¼Œå¦‚æœä¼ é€’çš„é“¾æ¡å¤ªé•¿ï¼Œ</span></span><br><span class="line">        <span class="comment">// åˆ™å¯èƒ½éœ€æ¶ˆè€—çš„gasè¦å¤šäºåŒºå—ä¸­å‰©ä½™çš„ï¼ˆå¤§äºåŒºå—è®¾ç½®çš„gasLimitï¼‰ï¼Œ</span></span><br><span class="line">        <span class="comment">// è¿™ç§æƒ…å†µä¸‹ï¼Œå§”æ‰˜ä¸ä¼šè¢«æ‰§è¡Œã€‚</span></span><br><span class="line">        <span class="comment">// è€Œåœ¨å¦ä¸€äº›æƒ…å†µä¸‹ï¼Œå¦‚æœå½¢æˆé—­ç¯ï¼Œåˆ™ä¼šè®©åˆçº¦å®Œå…¨å¡ä½ã€‚</span></span><br><span class="line">        <span class="comment">// Aå§”æ‰˜ç»™Bï¼ŒBçš„æƒåˆ©å·²ç»å§”æ‰˜äº†Cï¼Œé‚£Açš„æƒåˆ©ç›´æ¥å§”æ‰˜ç»™C</span></span><br><span class="line">        <span class="keyword">while</span> (voters[to].delegate != address(<span class="number">0</span>)) &#123;</span><br><span class="line">            to = voters[to].delegate;</span><br><span class="line">            <span class="comment">// ä¸å…è®¸é—­ç¯å§”æ‰˜</span></span><br><span class="line">            <span class="built_in">require</span>(to != msg.sender, <span class="string">&quot;Found loop in delegation.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// `sender` æ˜¯ä¸€ä¸ªå¼•ç”¨, ç›¸å½“äºå¯¹ `voters[msg.sender].voted` è¿›è¡Œä¿®æ”¹</span></span><br><span class="line">        sender.voted = <span class="literal">true</span>;</span><br><span class="line">        sender.delegate = to;</span><br><span class="line">        <span class="comment">// è¿™ä¹Ÿæ˜¯å¼•ç”¨ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">        Voter storage delegate_ = voters[to];</span><br><span class="line">        <span class="keyword">if</span> (delegate_.voted) &#123;</span><br><span class="line">            <span class="comment">// è‹¥è¢«å§”æ‰˜è€…å·²ç»æŠ•è¿‡ç¥¨äº†ï¼Œç›´æ¥å¢åŠ å¾—ç¥¨æ•°</span></span><br><span class="line">            proposals[delegate_.vote].voteCount += sender.weight;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// è‹¥è¢«å§”æ‰˜è€…è¿˜æ²¡æŠ•ç¥¨ï¼Œå¢åŠ å§”æ‰˜è€…çš„æƒé‡</span></span><br><span class="line">            delegate_.weight += sender.weight;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/// æŠŠä½ çš„ç¥¨(åŒ…æ‹¬å§”æ‰˜ç»™ä½ çš„ç¥¨)ï¼Œ</span></span><br><span class="line">    <span class="comment">/// æŠ•ç»™ææ¡ˆ `proposals[proposal].name`.</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">vote</span>(<span class="params">uint proposal</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        Voter storage sender = voters[msg.sender];</span><br><span class="line">        <span class="built_in">require</span>(!sender.voted, <span class="string">&quot;Already voted.&quot;</span>);</span><br><span class="line">        sender.voted = <span class="literal">true</span>;</span><br><span class="line">        sender.vote = proposal</span><br><span class="line">        <span class="comment">// å¦‚æœ `proposal` è¶…è¿‡äº†æ•°ç»„çš„èŒƒå›´ï¼Œåˆ™ä¼šè‡ªåŠ¨æŠ›å‡ºå¼‚å¸¸ï¼Œå¹¶æ¢å¤æ‰€æœ‰çš„æ”¹åŠ¨</span></span><br><span class="line">        proposals[proposal].voteCount += sender.weight;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»“åˆä¹‹å‰æ‰€æœ‰çš„æŠ•ç¥¨ï¼Œè®¡ç®—å‡ºæœ€ç»ˆèƒœå‡ºçš„ææ¡ˆ</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">winningProposal</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span></span></span><br><span class="line"><span class="function">            <span class="title">returns</span> (<span class="params">uint winningProposal_</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        uint winningVoteCount = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (uint p = <span class="number">0</span>; p &lt; proposals.length; p++) &#123;</span><br><span class="line">            <span class="keyword">if</span> (proposals[p].voteCount &gt; winningVoteCount) &#123;</span><br><span class="line">                winningVoteCount = proposals[p].voteCount;</span><br><span class="line">                winningProposal_ = p;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// è°ƒç”¨ winningProposal() å‡½æ•°ä»¥è·å–ææ¡ˆæ•°ç»„ä¸­è·èƒœè€…çš„ç´¢å¼•ï¼Œå¹¶ä»¥æ­¤è¿”å›è·èƒœè€…çš„åç§°</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">winnerName</span>(<span class="params"></span>) <span class="title">public</span> <span class="title">view</span></span></span><br><span class="line"><span class="function">            <span class="title">returns</span> (<span class="params">bytes32 winnerName_</span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        winnerName_ = proposals[winningProposal()].name;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆçº¦æµ‹è¯•å¯ä»¥åœ¨Solidity IDEä¸­æµ‹è¯•ï¼Œä¹Ÿå¯ä»¥åœ¨gethä¸­æ‰§è¡Œï¼Œå…ˆæ¥çœ‹ä¸ªç®€å•ä¸€ç‚¹çš„ï¼Œä½¿ç”¨remixåœ¨çº¿IDEè¿›è¡Œåˆçº¦éƒ¨ç½²ã€‚</p><h2 id="Remix-IDEè¿è¡Œåˆçº¦"><a href="#Remix-IDEè¿è¡Œåˆçº¦" class="headerlink" title="Remix IDEè¿è¡Œåˆçº¦"></a>Remix IDEè¿è¡Œåˆçº¦</h2><p>Remix IDEå¯ä»¥ä½¿ç”¨åœ¨çº¿çš„ï¼Œä¹Ÿå¯èƒ½æœ¬åœ°å®‰è£…ã€‚(åœ¨çº¿çš„IDEæœ‰æ—¶ä¼šæ¯”è¾ƒæ…¢ï¼Œæˆ‘å°±å®‰è£…äº†ä¸ªæœ¬åœ°çš„ï¼Œç»“æœå‘ç°æœ¬åœ°çš„ä¹Ÿæ¯”è¾ƒæ…¢ï¼Œä¸çŸ¥é“æ˜¯ä¸æ˜¯æˆ‘è™šæ‹Ÿæœºçš„é—®é¢˜ã€‚ã€‚ã€‚)</p><p>è¿™é‡Œå…ˆä½¿ç”¨åœ¨çº¿ç‰ˆçš„ï¼Œéšåå†™ä¸ªæœ¬åœ°å®‰è£…Remixçš„æ•™ç¨‹ã€‚</p><p>åœ¨<a href="https://remix.ethereum.org/">Remix IDE</a>çš„å·¦ä¸Šè§’æœ‰ä¸ªâ€+â€çš„å›¾æ ‡ï¼Œç‚¹å‡»æ–°å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œå°†ä¸Šè¿°ä»£ç copyè¿›å»ã€‚<br>æ–‡ä»¶åˆ›å»ºæˆåŠŸä¹‹åå°±æ˜¯é€‰æ‹©Solidityçš„ç‰ˆæœ¬ï¼Œç¼–è¯‘ä»£ç ï¼Œå¦‚å›¾ï¼š<br><img src="/blogimgs/SolidityVoting/compile.png" alt="ç¼–è¯‘åˆçº¦" title="ç¼–è¯‘åˆçº¦"></p><p>ç¼–è¯‘æˆåŠŸä¹‹åå°±æ˜¯éƒ¨ç½²åˆçº¦ï¼Œè¿™é‡Œç‚¹å‡»<code>Deploy</code>ä¹‹åä¼šå¸®ä½ å°†åˆçº¦éƒ¨ç½²åˆ°ä»¥å¤ªåŠçš„æµ‹è¯•ç¯å¢ƒä¸­ï¼Œéƒ¨ç½²æµç¨‹å¦‚å›¾ï¼š<br><img src="/blogimgs/SolidityVoting/deploy.png" alt="éƒ¨ç½²åˆçº¦" title="éƒ¨ç½²åˆçº¦"></p><blockquote><p>å› ä¸ºåˆçº¦çš„æ„é€ å‡½æ•°éœ€è¦è¾“å…¥å‚æ•°ï¼Œæ‰€ä»¥åœ¨deployçš„æ—¶å€™ï¼Œéœ€è¦ä¼ å…¥å‚æ•°ã€‚<br>è¿™é‡Œå‚æ•°æ˜¯ä¸€ä¸ªbytes32çš„æ•°ç»„ï¼Œåœ¨æœ‰çš„ç‰ˆæœ¬ä¸­stringå¯ä»¥è½¬æˆbytes32ï¼Œä½†åœ¨<code>0.4.22</code>ä¸­æ— æ³•ç›´æ¥è½¬ï¼Œ<br>æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è¦ç›´æ¥è¾“å…¥byte32çš„ä¸€ä¸ªæ•°ç»„<code>[&quot;0x616263&quot;, &quot;0x646566&quot;, &quot;0x676869&quot;]</code>ï¼Œ<br>è½¬åŒ–æˆå­—ç¬¦ä¸²ä¸º<code>[&quot;abc&quot;, &quot;def&quot;, &quot;ghi&quot;]</code></p></blockquote><p>åˆçº¦éƒ¨ç½²å¥½ä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨åˆçº¦çš„ä¸€äº›æ–¹æ³•äº†ï¼Œæ¯”å¦‚<em>vote</em>å’Œ<em>giveRightToVote</em><br>voteæ–¹æ³•éœ€è¦ä¼ å…¥çš„å‚æ•°æ˜¯uintï¼Œæ˜¯<code>proposals</code>æ•°ç»„çš„ç´¢å¼•ï¼Œè¿™é‡Œæ³¨æ„ä¸è¦è¶Šç•Œã€‚<br>giveRightToVoteæ–¹æ³•ä¼ å…¥çš„å‚æ•°æ˜¯addressï¼Œæ„æ€æ˜¯ç»™æŸä¸ªåœ°å€æˆæƒï¼Œä½¿å…¶èƒ½å¤Ÿè¿›è¡ŒæŠ•ç¥¨ï¼Œ<br>è¿™ä¸ªaddresså¯ä»¥åœ¨<em>Account</em>ä¸­é€‰æ‹©(remixä¼šé»˜è®¤åˆ›å»º5ä¸ªè´¦å·)ï¼Œå¦‚å›¾ï¼š<br><img src="/blogimgs/SolidityVoting/accounts.png" alt="è´¦å·" title="è´¦å·"><br>å°†é€‰æ‹©å¥½çš„addressç²˜è´´åˆ°å‚æ•°æ ä¸­è°ƒç”¨è¯¥æ–¹æ³•ç»™addressæˆæƒï¼Œ<br>ç„¶åä¾ç„¶åœ¨<em>Account</em>é€‰é¡¹ä¸­åˆ‡æ¢åˆ°è¯¥addressï¼Œå°±å¯ä»¥ä»¥è¯¥è´¦å·è¿›è¡Œæ“ä½œäº†ï¼Œæ¯”å¦‚è°ƒç”¨voteç»™æŸä¸ªææ¡ˆæŠ•ç¥¨ã€‚</p><p>å…¶å®ƒçš„æ–¹æ³•ä¹Ÿå¯ä»¥å°è¯•ç€è°ƒç”¨ä¸‹ï¼ŒåŠ æ·±å¯¹ä»£ç çš„ç†è§£ã€‚</p><p>è¿™æ˜¯ç”¨Remix IDEè¿›è¡Œæµ‹è¯•å¼€å‘ï¼Œè¿˜å¯ä»¥ä½¿ç”¨gethå‘½ä»¤è¡Œæ¨¡å¼è¿›è¡Œå¼€å‘æµ‹è¯•ï¼Œgethç›¸å¯¹äºRemix IDEå°±æ¯”è¾ƒç¹çï¼Œå…·ä½“æµç¨‹ä¸‹æ¬¡å†ç»­ã€‚ã€‚ã€‚</p><!--å°†æ­¤ä»£ç å†™å…¥`voting.sol`æ–‡ä»¶ä¸­ï¼Œç¼–è¯‘solæ–‡ä»¶ç”Ÿæˆ`bytecode`å’Œ`ABI`ï¼Œæ‰§è¡Œå‘½ä»¤å¦‚ä¸‹ï¼š1ã€`solc --bin voting.sol` ç”Ÿæˆbytecodeå¦‚ä¸‹ï¼š2ã€`solc --abi voting.sol` ç”ŸæˆABIå¦‚ä¸‹ï¼š## éƒ¨ç½²åˆçº¦### ä½¿ç”¨ABIç”Ÿæˆåˆçº¦å¯¹è±¡åœ¨gethä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤### ä½¿ç”¨åˆçº¦å¯¹è±¡éƒ¨ç½²åˆçº¦åœ¨gethä¸­æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤## è¿è¡Œåˆçº¦è¿è¡Œåˆçº¦ä¹‹å‰å…ˆç”Ÿæˆä¸€ä¸ªå—  æ³¨é‡Šæ‰çš„(ç”Ÿæˆå—æœ‰ä»€ä¹ˆç”¨å‘¢)ï¼Œæ‰§è¡ŒæŒ–çŸ¿å‘½ä»¤ï¼Œç”Ÿæˆæ–°å—ä¹‹ååœæ­¢æŒ–çŸ¿ã€‚ç®¡ç†å‘˜æ‰§è¡Œå…ˆè°ƒç”¨voter.constructor()ç»™æŠ•ç¥¨å¢åŠ ææ¡ˆvoter.giveRightToVote()ç»™é€‰æ°‘èµ‹æŠ•ç¥¨æƒvoter.winnerName()æŸ¥çœ‹æŠ•ç¥¨ç»“æœé€‰æ°‘æ‰§è¡Œvoter.vote()ç»™å–œæ¬¢çš„ææ¡ˆæŠ•ç¥¨voter.delegate()å§”æ‰˜åˆ«çš„é€‰æ°‘å¸®è‡ªå·±æŠ•ç¥¨-->]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Ethereum </tag>
            
            <tag> Solidity </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSä¸­atimeä¸mtimeè§£æ</title>
      <link href="/HDFS%E4%B8%ADatime%E5%92%8Cmtime.html"/>
      <url>/HDFS%E4%B8%ADatime%E5%92%8Cmtime.html</url>
      
        <content type="html"><![CDATA[<p>å…ˆæ¥äº†è§£ä¸‹Linuxä¸­atimeå’ŒmtimeåŒºåˆ«ï¼š<br>atimeï¼šaccess timeå³è®¿é—®æ—¶é—´<br>mtimeï¼šmodify timeå³ä¿®æ”¹æ—¶é—´ï¼Œè¿™é‡ŒæŒ‡æ–‡ä»¶å†…å®¹çš„ä¿®æ”¹ã€‚(ç»å¸¸å’Œatimeä¸mtimeä¸€èµ·è°ˆåˆ°çš„è¿˜æœ‰ctimeï¼Œè¿™é‡Œä¸å±•å¼€ï¼Œæœ‰å…´è¶£çš„å¯ä»¥goolge)</p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æœ‰çš„ç³»ç»Ÿå¯èƒ½ä¸ºäº†æ€§èƒ½ä¸Šçš„ä¼˜åŒ–ï¼Œatimeå¹¶ä¸æ˜¯å®æ—¶æ›´æ–°ï¼Œæ­¤æ—¶æŸ¥çœ‹atimeå¹¶æ²¡æœ‰å¾—åˆ°æƒ³è¦çš„æ•ˆæœã€‚</p></blockquote><span id="more"></span><p>Linux atimeä¿®æ”¹ç­–ç•¥ä¸mountæœ‰å…³ï¼Œå¯é€‰çš„å€¼æœ‰<code>noatime</code>ã€<code>relatime</code>å’Œ<code>strictatime</code>ã€‚</p><ul><li>noatime<br>atimeä¸ä¼šè¢«æ›´æ–°ï¼Œå³ä½¿ä¿®æ”¹äº†æ–‡ä»¶å†…å®¹</li><li>relatime</li></ul><ol><li>å¦‚æœä¸€ä¸ªæ–‡ä»¶çš„atimeæ¯”ctimeæˆ–mtimeæ›´æ—©ï¼Œæ­¤æ—¶ä½ å»è¯»å–äº†è¯¥æ–‡ä»¶ï¼Œatimeæ‰ä¼šè¢«æ›´æ–°ä¸ºå½“å‰æ—¶é—´ã€‚</li><li>atimeæ¯”ç°åœ¨æ—©ä¸€å¤©ï¼Œé‚£ä¹ˆatimeåœ¨æ–‡ä»¶è¯»å–æ—¶ä¼šè¢«æ›´æ–°</li></ol><ul><li>strictatime<br>atimeåœ¨æ–‡ä»¶æ¯æ¬¡è¢«è¯»å–æ—¶ï¼Œéƒ½èƒ½å¤Ÿè¢«æ›´æ–°</li></ul><h2 id="HDFSä¸­atimeå’Œmtime"><a href="#HDFSä¸­atimeå’Œmtime" class="headerlink" title="HDFSä¸­atimeå’Œmtime"></a>HDFSä¸­atimeå’Œmtime</h2><p>äº†è§£äº†Linuxä¸­çš„atimeä¸mtimeï¼Œæˆ‘ä»¬æ¥äº†è§£ä¸‹HDFSä¸­çš„è¿™ä¸¤ä¸ªå€¼çš„å˜åŒ–è§„åˆ™ã€‚</p><p>åœ¨çœ‹ä»£ç ä¹‹å‰ï¼Œå…ˆæƒ³ä¸‹atimeå’Œmtimeæœ‰å¯èƒ½åœ¨å“ªäº›åœ°æ–¹ä¼šä¿®æ”¹ï¼Œ</p><p>hdfsåº•å±‚apiå¯¹æ–‡ä»¶éƒ½æœ‰å“ªäº›æ“ä½œï¼Ÿæ— éå°±æ˜¯è¯»å†™ä¸¤ç§æ“ä½œï¼Œè¯»è‚¯å®šä¿®æ”¹çš„æ˜¯atimeï¼Œå†™ä¿®æ”¹çš„æ˜¯mtimeï¼Œæ˜¯å¦ä¿®æ”¹atimeè¿˜å¾—ç¡®è®¤ã€‚<br>è¿™é‡Œæˆ‘ä»¬è¿˜æ¼æ‰ä¸€ç§æ“ä½œï¼Œé‚£å°±æ˜¯mvã€‚</p><p>å…ˆæ¥çœ‹ä¸‹atime</p><h3 id="atime"><a href="#atime" class="headerlink" title="atime"></a>atime</h3><p>å»å¹´å†™è¿‡ä¸€ç¯‡æ–‡ç« [HDFS readè§£æ(ä¸€)ä¹‹Openæ–‡ä»¶æµ](<a href="http://bigdatadecode.top/HDFS">http://bigdatadecode.top/HDFS</a> readè§£æ.html)ä»‹ç»HDFSè¯»æ“ä½œæµç¨‹ï¼Œè¿™é‡Œå°±ä¸å†ç´¯èµ˜äº†ï¼Œç›´æ¥è´´å‡ºå…³é”®ä»£ç ã€‚(æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹)</p><blockquote><p>è¿™é‡Œè¿˜æ˜¯ç®€å•è¯´ä¸‹è¯»çš„æµç¨‹ï¼š<em>å®¢æˆ·ç«¯å‘NNå‘èµ·ä¸€ä¸ªè¯»è¯·æ±‚ï¼ŒNNå°†ç›¸å…³çš„blockä¿¡æ¯è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å†ä¸å¯¹åº”çš„DNå»ºç«‹è¿æ¥è¯»å–ä¿¡æ¯</em>ã€‚<br>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œå…ˆä¸NNäº¤äº’ç„¶åå†ä¸DNäº¤äº’ï¼Œé‚£ä¹ˆæ¯ä¸ªæ–‡ä»¶çš„atimeç›¸å…³å…ƒæ•°æ®ä¿¡æ¯éƒ½å­˜åœ¨NNä¸­ï¼Œé‚£ä¹ˆatimeç›¸å…³çš„ä¿®æ”¹ä¹Ÿè‚¯å®šå‘ç”Ÿåœ¨ä¸NNäº¤äº’çš„è¿™ä¸ªè¿‡ç¨‹ä¸­ã€‚</p></blockquote><p>ä»ä¹‹å‰çš„æ–‡ç« ä¸­å¯çŸ¥å…¥å£å‡½æ•°æ˜¯<code>FSNamesystem.getBlockLocations</code>ï¼Œå…³é”®ä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LocatedBlocks <span class="title">getBlockLocations</span><span class="params">(String clientMachine, String srcArg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">long</span> offset, <span class="keyword">long</span> length)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">if</span> (res.updateAccessTime()) &#123;</span><br><span class="line">    String src = srcArg;</span><br><span class="line">    writeLock();</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> now = now();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> INodesInPath iip = dir.resolvePath(pc, src);</span><br><span class="line">      src = iip.getPath();</span><br><span class="line">      INode inode = iip.getLastINode();</span><br><span class="line">      <span class="comment">// å†æ¬¡åˆ¤æ–­æ˜¯å¦å¯ä»¥æ›´æ–°atime</span></span><br><span class="line">      <span class="keyword">boolean</span> updateAccessTime = inode != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">          now &gt; inode.getAccessTime() + getAccessTimePrecision();</span><br><span class="line">      <span class="keyword">if</span> (!isInSafeMode() &amp;&amp; updateAccessTime) &#123;</span><br><span class="line">        <span class="comment">// è®¾ç½®atime</span></span><br><span class="line">        <span class="keyword">boolean</span> changed = FSDirAttrOp.setTimes(dir,</span><br><span class="line">            inode, -<span class="number">1</span>, now, <span class="keyword">false</span>, iip.getLatestSnapshotId());</span><br><span class="line">        <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">          getEditLog().logTimes(src, -<span class="number">1</span>, now);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Failed to update the access time of &quot;</span> + src, e);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      writeUnlock(operationName);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>res.updateAccessTime()</code>å†³å®šäº†æ˜¯å¦æ›´æ–°atimeï¼Œå…¶å€¼æ˜¯åœ¨<code>getBlockLocationsInt</code>ä¸­èµ‹å€¼çš„ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">boolean</span> updateAccessTime = isAccessTimeSupported() &amp;&amp; !isInSafeMode()</span><br><span class="line">        &amp;&amp; !iip.isSnapshot()</span><br><span class="line">        &amp;&amp; now &gt; inode.getAccessTime() + getAccessTimePrecision();</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å…³é”®çš„å› ç´ æ˜¯<code>isAccessTimeSupported()</code>å’Œ<code>getAccessTimePrecision()</code>ï¼Œè¿™ä¸ªä¸¤ä¸ªæ–¹æ³•éƒ½ä¸<code>accessTimePrecision</code>æœ‰å…³ï¼Œæ­¤å€¼æ˜¯ç”±<code>dfs.namenode.accesstime.precision</code>è®¾ç½®çš„ï¼Œé»˜è®¤æ˜¯3600000ã€‚<br>å½“æ­¤å€¼å¤§äº0ï¼Œ<code>isAccessTimeSupported()</code>è¿”å›trueï¼Œ<code>getAccessTimePrecision()</code>å¾—åˆ°çš„å€¼æ˜¯<code>dfs.namenode.accesstime.precision</code>çš„å€¼ã€‚</p><p>ä»ä¸Šè¿°ä»£ç ä¸­å¯ä»¥çœ‹å‡ºæ›´æ–°atimeçš„ä¸€ä¸ªæ¡ä»¶æ˜¯<strong>ä¸¤æ¬¡è¯»å–é—´éš”ç›¸éš”dfs.namenode.accesstime.precisionç§’ï¼Œé»˜è®¤æ˜¯1å°æ—¶ã€‚</strong></p><p>è¿™é‡Œé—ç•™ä¸¤ä¸ªé—®é¢˜<br>1ã€æ–°å»ºæ–‡ä»¶æ—¶atimeå¦‚ä½•èµ‹å€¼<br>2ã€ä¿®æ”¹æ–‡ä»¶å†…å®¹æ—¶atimeå¦‚ä½•èµ‹å€¼</p><p>å…³äºè¿™ä¸ªä¸¤ä¸ªé—®é¢˜æˆ‘åœ¨ä¸‹ä¸€èŠ‚åœ¨å†™æµç¨‹ä¸­è§£ç­”ã€‚è¯·ç»§ç»­å‘ä¸‹çœ‹</p><h3 id="mtime"><a href="#mtime" class="headerlink" title="mtime"></a>mtime</h3><p>åŒæ ·å»å¹´ä¹Ÿå†™è¿‡ä¸€ç¯‡å…³äºå†™çš„æ–‡ç« [HDFS writeè§£æ](<a href="http://bigdatadecode.top/HDFS">http://bigdatadecode.top/HDFS</a> writeè§£æ.html)ä»‹ç»HDFSè¯»æ“ä½œæµç¨‹ï¼Œè¿™é‡Œå°±ä¸å†ç´¯èµ˜äº†ï¼Œç›´æ¥è´´å‡ºå…³é”®ä»£ç ã€‚(æœ‰å…´è¶£çš„åŒå­¦å¯ä»¥è‡ªè¡ŒæŸ¥çœ‹)</p><p>å†™ç›¸å…³çš„æ“ä½œåŒ…æ‹¬createã€closeå’Œappend<br>å†™æ–‡ä»¶æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€ç§æ˜¯è°ƒç”¨<code>create(Path)</code>æ–¹æ³•ï¼Œå¦ä¸€ç§æ˜¯è°ƒç”¨<code>append(Path)</code>æ–¹æ³•</p><h3 id="create"><a href="#create" class="headerlink" title="create"></a>create</h3><p>é€šè¿‡è°ƒç”¨<code>create(Path)</code>ï¼Œæœ€ç»ˆä¼šè°ƒç”¨<code>FSDirectory.addFile</code>æ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­ä¼šnewä¸€ä¸ª<code>INodeFile</code>ï¼Œæ­¤æ—¶<em>ä¼šè®¾ç½®mtimeå’Œatimeä¸ºåŒä¸€ä¸ªå€¼</em>ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">INodesInPath <span class="title">addFile</span><span class="params">(INodesInPath existing, String localName, PermissionStatus</span></span></span><br><span class="line"><span class="params"><span class="function">    permissions, <span class="keyword">short</span> replication, <span class="keyword">long</span> preferredBlockSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    String clientName, String clientMachine)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> FileAlreadyExistsException, QuotaExceededException,</span></span><br><span class="line"><span class="function">    UnresolvedLinkException, SnapshotAccessControlException, AclException </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> modTime = now();</span><br><span class="line">  INodeFile newNode = newINodeFile(allocateNewInodeId(), permissions, modTime,</span><br><span class="line">      modTime, replication, preferredBlockSize);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å°±æœ‰å…³é—­ä¸€ä¸ªæ–‡ä»¶ï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹å…³é—­æ–‡ä»¶æ—¶atimeå’Œmtimeä¼šæœ‰ä»€ä¹ˆå˜åŒ–ã€‚</p><h3 id="close"><a href="#close" class="headerlink" title="close"></a>close</h3><p><code>closeFile()</code>åœ¨<code>finalizeINodeFileUnderConstruction</code>ä¸­è°ƒç”¨ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­ä¼šè®¾ç½®mtimeï¼Œçœ‹ä¸‹ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">finalizeINodeFileUnderConstruction</span><span class="params">(String src,</span></span></span><br><span class="line"><span class="params"><span class="function">    INodeFile pendingFile, <span class="keyword">int</span> latestSnapshot)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">...</span><br><span class="line">  pendingFile.toCompleteFile(now());</span><br><span class="line">...</span><br><span class="line">  closeFile(src, pendingFile);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// INodeFile.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> INodeFile <span class="title">toCompleteFile</span><span class="params">(<span class="keyword">long</span> mtime)</span> </span>&#123;</span><br><span class="line">  Preconditions.checkState(isUnderConstruction(),</span><br><span class="line">      <span class="string">&quot;file is no longer under construction&quot;</span>);</span><br><span class="line">  FileUnderConstructionFeature uc = getFileUnderConstructionFeature();</span><br><span class="line">  <span class="keyword">if</span> (uc != <span class="keyword">null</span>) &#123;</span><br><span class="line">    assertAllBlocksComplete();</span><br><span class="line">    removeFeature(uc);</span><br><span class="line">    <span class="keyword">this</span>.setModificationTime(mtime);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­å¯ä»¥çœ‹å‡ºï¼Œcloseæ–‡ä»¶æ—¶åªå¯¹mtimeè¿›è¡Œäº†ä¿®æ”¹ã€‚</p><h3 id="append"><a href="#append" class="headerlink" title="append"></a>append</h3><p>appendåªæ˜¯æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµï¼Œå¹¶ä¸ä¼šä¿®æ”¹mtimeæˆ–è€…atimeï¼Œåªæ˜¯åœ¨closeçš„æ—¶å€™ä¿®æ”¹mtime</p><!--  public final void setModificationTime(long modificationTime) {    referred.setModificationTime(modificationTime);  }  public final void setAccessTime(long accessTime) {    referred.setAccessTime(accessTime);  }  INodeWithAdditionalFields.modificationTime accessTime--><h2 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h2><blockquote><p>atime</p></blockquote><p>1ã€ä¸¤æ¬¡è¯»é—´éš”å¤§äºé»˜è®¤çš„1å°æ—¶æ—¶ï¼Œæ›´æ–°atimeã€‚é»˜è®¤é—´éš”é€šè¿‡<code>dfs.namenode.accesstime.precision</code>æ§åˆ¶ã€‚<br>2ã€æ–°å»ºä¸€ä¸ªæ–‡ä»¶æ—¶atimeèµ‹å€¼ä¸ºå½“å‰æ—¶é—´(<em>æ³¨æ„ï¼Œå½“å…³é—­ä¸€ä¸ªæ–‡ä»¶æ—¶atimeä¸ä¼šä¿®æ”¹</em>)</p><blockquote><p>mtime</p></blockquote><p>1ã€æ–°å»ºä¸€ä¸ªæ–‡ä»¶æ—¶mtimeèµ‹å€¼ä¸ºå½“å‰æ—¶é—´(åŒæ—¶ä¼šä¿®æ”¹atime)<br>2ã€å…³é—­ä¸€ä¸ªæ–‡ä»¶æ—¶mtimeèµ‹å€¼ä¸ºå½“å‰æ—¶é—´(æ­¤æ—¶å¹¶ä¸ä¼šä¿®æ”¹atime)</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> atime </tag>
            
            <tag> mtime </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARN Lost Nodeæ˜¾ç¤ºå¼‚å¸¸</title>
      <link href="/YARN-Lost-Node%E6%98%BE%E7%A4%BA%E5%BC%82%E5%B8%B8.html"/>
      <url>/YARN-Lost-Node%E6%98%BE%E7%A4%BA%E5%BC%82%E5%B8%B8.html</url>
      
        <content type="html"><![CDATA[<p>å…ˆè¯´ç°è±¡ï¼Œåœ¨yarnçš„webé¡µé¢ï¼ŒLost NodesæŒ‡æ ‡æ˜¾ç¤ºçš„æ•°æ®å¼‚å¸¸ï¼Œå¦‚ä¸‹ï¼š<br><img src="/blogimgs/lostnode/lostnode1.png"><br>æˆ‘çš„é›†ç¾¤ä¸€å…±æœ‰5å°èŠ‚ç‚¹ï¼Œè¿™é‡Œæ˜¾ç¤ºæœ‰ä¸€å°èŠ‚ç‚¹ä¸º<code>Lost Nodes</code>ï¼Œä½†ä¾ç„¶æœ‰5å°<code>Active Nodes</code>ï¼Œç»†å¿ƒè§‚å¯Ÿå‘ç°æˆ–æœ‰æŸä¸ªèŠ‚ç‚¹å³å­˜åœ¨Active Nodesä¸­ä¹Ÿå­˜åœ¨Lost Nodesä¸­ï¼Œåªæ˜¯ç«¯å£ä¸ä¸€æ ·ã€‚</p><p>è¿™ç§æƒ…å†µå¦‚ä½•è§£å†³å‘¢ï¼Ÿ<br>åœ¨<code>yarn-site.xml</code>ä¸­æ·»åŠ <code>yarn.nodemanager.address</code>é…ç½®é¡¹ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;property&gt;</span><br><span class="line">    &lt;name&gt;yarn.nodemanager.address&lt;/name&gt;</span><br><span class="line">    &lt;value&gt;<span class="variable">$&#123;yarn.nodemanager.hostname&#125;</span>:65033&lt;/value&gt;</span><br><span class="line">&lt;/property&gt;</span><br></pre></td></tr></table></figure><p>éœ€è¦é‡å¯é›†ç¾¤ï¼Œè®©å‚æ•°ç”Ÿæ•ˆã€‚</p><p>ç°åœ¨ä½ å¯ä»¥å»ä¿®æ”¹ä½ é›†ç¾¤çš„é…ç½®ï¼Œæ˜¯ä¸æ˜¯ç¬é—´å¿ƒæƒ…æ„‰å¿«äº†å¾ˆå¤šï¼Œé‚£æ˜¯ä¸æ˜¯å¯ä»¥ç»§ç»­è¯»ä¸‹å»ï¼Œçœ‹ä¸‹æˆ‘ä»¬å¦‚ä½•è§£å†³è¿™ç§é—®é¢˜ã€‚</p><span id="more"></span><h2 id="æœç´¢"><a href="#æœç´¢" class="headerlink" title="æœç´¢"></a>æœç´¢</h2><p>é¦–å…ˆåˆ©ç”¨æœç´¢å¼•æ“ï¼Œçœ‹ä¸‹æ˜¯å¦æœ‰æ²¡æœ‰å‰äººå¸®ä½ åŸ‹å‘ã€‚(å½“ä½ æœåˆ°è¿™ç¯‡blogï¼Œè¯´æ˜ä½ å·²ç»å…·æœ‰äº†è¿™ç§èƒ½åŠ›)</p><h2 id="é•‡å®š"><a href="#é•‡å®š" class="headerlink" title="é•‡å®š"></a>é•‡å®š</h2><p>æ²¡æœ‰å‰äººåŸ‹å‘ï¼Œæ€ä¹ˆåŠï¼Ÿæœ‰çš„åŒå­¦å°±æ…Œäº†ï¼Œè§£å†³ä¸äº†äº†ï¼Œæ€ä¹ˆåŠï¼Ÿå…ˆé‡å¯è§£å†³å§ã€‚ã€‚ã€‚<br>é‡å¯æ˜¯å¯ä»¥è§£å†³é‡åˆ°çš„é—®é¢˜ï¼Œä½†æˆ‘ä»¬ä¸èƒ½é‡åˆ°é—®é¢˜å°±é‡å¯ã€‚åœ¨é‡å¯ä¹‹å‰ï¼Œæˆ‘ä»¬ä¹Ÿè¦è¿›è¡Œä¸€äº›è¯„ä¼°ï¼Œè¯„ä¼°ä¸‹è¿™ä¸ªé—®é¢˜æ˜¯ä¸æ˜¯å¾ˆä¸¥é‡ï¼Œæ˜¯ä¸æ˜¯éœ€è¦ç«‹é©¬è§£å†³ã€‚</p><p>ç›®å‰æˆ‘ä»¬é‡åˆ°çš„è¿™ä¸ªé—®é¢˜å¾ˆæ˜æ˜¾ä¸æ˜¯é‚£ç§éœ€è¦ç«‹é©¬é‡å¯æœåŠ¡æ¥è§£å†³çš„é—®é¢˜ï¼Œé‚£æˆ‘ä»¬åº”è¯¥æ€ä¹ˆè§£å†³è¿™ä¸ªé—®é¢˜å‘¢ï¼Ÿæœ€å¥½çš„ç­”æ¡ˆå°±æ˜¯<strong>çœ‹æºç </strong>ã€‚</p><p>ä¸€ä¸ªé¡¹ç›®ä»£ç é‚£ä¹ˆå¤šï¼Œåœ¨ä½ ä¸ç†Ÿæ‚‰æ¯ä¸€è¡Œä»£ç çš„æ—¶å€™å¦‚ä½•å¿«é€Ÿå®šä½å…³é”®ä»£ç å¹¶æ‰¾åˆ°é—®é¢˜æ‰€åœ¨å‘¢ï¼Ÿ<br>æˆ‘è®¤ä¸ºå¾ˆç®€å•ï¼Œå°±ä¸¤æ­¥ï¼Œ<code>é¦–å…ˆå…¨æ–‡æ£€ç´¢æ‰¾åˆ°è¡¨è±¡ï¼Œç„¶åé€†å‘è·Ÿè¸ªä»£ç å¹¶æ‰¾åˆ°ç­”æ¡ˆ</code>ã€‚</p><h3 id="å®šä½å…³é”®ä»£ç å…¥å£"><a href="#å®šä½å…³é”®ä»£ç å…¥å£" class="headerlink" title="å®šä½å…³é”®ä»£ç å…¥å£"></a>å®šä½å…³é”®ä»£ç å…¥å£</h3><p>å…¨æ–‡æ£€ç´¢å…³é”®å­—<code>Lost Nodes</code>ï¼Œç»“æœå¦‚ä¸‹ï¼š<br><img src="/blogimgs/lostnode/find.png"><br>ä»ç»“æœä¸­æˆ‘ä»¬å¯ä»¥æ ¹æ®ç»éªŒå®šä½åˆ°å…³é”®å…¥å£åº”è¯¥åœ¨webappåŒ…ä¸­ï¼Œç‚¹å‡»è¿›<code>MetricsOverviewTable</code>ä¸­çš„ç›¸å…³ä»£ç ä½ç½®<br>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">th().<span class="variable">$class</span>(<span class="string">&quot;ui-state-default&quot;</span>)._(<span class="string">&quot;Lost Nodes&quot;</span>)._()</span><br><span class="line"></span><br><span class="line">// è¿™é‡Œåªæ˜¯ä¸€ä¸ªé¡µé¢æ ·å¼ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°èµ‹å€¼ï¼Œçœ‹ä¸‹ä¸Šä¸‹æ–‡æœ‰æ²¡æœ‰å–å€¼çš„ç›¸å…³ä»£ç </span><br><span class="line">// å‘ç°ä»£ç å¦‚ä¸‹</span><br><span class="line">td().a(url(<span class="string">&quot;nodes/lost&quot;</span>),String.valueOf(clusterMetrics.getLostNodes()))._()</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯æ‰¾åˆ°äº†ï¼Œ<code>clusterMetrics</code>æ˜¯ä¸€ä¸ª<code>ClusterMetricsInfo</code>çš„å¯¹è±¡ã€‚</p><p>ClusterMetricsInfoå­˜å‚¨äº†æ•´ä¸ªé›†ç¾¤çš„metricsä¿¡æ¯ï¼Œå…¶ä¸­æœ‰ä¸ªå±æ€§<code>lostNodes</code>ï¼Œç„¶åæ ¹æ®è¿™ä¸ªå±æ€§è·Ÿè¸ªåˆ°<code>ClusterMetrics.numLostNMs</code>ï¼Œè¯¥å±æ€§å­˜åœ¨ä¸‰ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Lost NMs</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getNumLostNMs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> numLostNMs.value();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incrNumLostNMs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  numLostNMs.incr();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">decrNumLostNMs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  numLostNMs.decr();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç è·Ÿåˆ°è¿™é‡Œï¼Œä½ å°±å¯ä»¥éšæ‰€æ¬²ä¸ºäº†ã€‚ã€‚ã€‚</p><p>LostNodeæ˜¾ç¤ºå¼‚å¸¸ï¼Œä¸æ˜¯å¢åŠ çš„æ—¶å€™æœ‰é—®é¢˜å°±æ˜¯å‡å°‘çš„æ—¶å€™æœ‰é—®é¢˜ï¼Œæ— éè¿™ä¸¤ç§æƒ…å†µï¼Œæˆ‘ä»¬å…ˆçœ‹ä¸‹incrçš„é€»è¾‘</p><h3 id="Lost-Node-incr"><a href="#Lost-Node-incr" class="headerlink" title="Lost Node incr"></a>Lost Node incr</h3><p>æ ¹æ®<code>incrNumLostNMs</code>æ–¹æ³•æˆ‘ä»¬åè·Ÿè¸ªåˆ°NMçš„çŠ¶æ€æœºç›¸å…³çš„ä»£ç ï¼Œè¿™é‡Œæˆ‘æŒ‰ç…§é¡ºåºçš„é€»è¾‘æ¥æ¢³ç†ä»£ç </p><p>å…ˆçœ‹ä¸‹ä¸€ä¸ªæ­£å¸¸RUNNINGçš„èŠ‚ç‚¹æ˜¯æ€ä¹ˆå˜ä¸ºLost NodeèŠ‚ç‚¹çš„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.addTransition(NodeState.RUNNING, NodeState.LOST,</span><br><span class="line">    RMNodeEventType.EXPIRE,</span><br><span class="line">    <span class="keyword">new</span> DeactivateNodeTransition(NodeState.LOST))</span><br></pre></td></tr></table></figure><p>NMçŠ¶æ€çš„å˜åŒ–æ˜¯ç”±<code>RMNodeEventType.EXPIRE</code>äº‹ä»¶è§¦å‘çš„ï¼ŒNM5åˆ†é’Ÿæ²¡æœ‰ä¸RMè¿›è¡Œå¿ƒè·³ä¼šè§¦å‘è¿™ä¸ªäº‹ä»¶ï¼Œè¿™ä¸ªæ—¶é—´æ˜¯åœ¨ä»£ç é‡Œå†™æ­»çš„<code>public static final int DEFAULT_EXPIRE = 5*60*1000;//5 mins</code>ã€‚</p><p>æˆ‘ä»¬çœ‹ä¸‹<code>DeactivateNodeTransition</code>è¿™ä¸ªhandleçš„å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(RMNodeImpl rmNode, RMNodeEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//check for UnknownNodeId</span></span><br><span class="line">  <span class="keyword">if</span> (rmNode.getNodeID().getPort() == -<span class="number">1</span>) &#123;</span><br><span class="line">    rmNode.updateMetricsForDeactivatedNode(rmNode.getState(), finalState);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// Deactivate the node</span></span><br><span class="line">  <span class="comment">// ä»RUNNINGä¸­ç§»é™¤å½“å‰èŠ‚ç‚¹</span></span><br><span class="line">  rmNode.context.getRMNodes().remove(rmNode.nodeId);</span><br><span class="line">  LOG.info(<span class="string">&quot;Deactivating Node &quot;</span> + rmNode.nodeId + <span class="string">&quot; as it is now &quot;</span></span><br><span class="line">      + finalState);</span><br><span class="line">  <span class="comment">// å°†å½“å‰èŠ‚ç‚¹æ”¾å…¥inactiveé˜Ÿåˆ—ä¸­</span></span><br><span class="line">  rmNode.context.getInactiveRMNodes().put(rmNode.nodeId.getHost(), rmNode);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Update the metrics</span></span><br><span class="line">  rmNode.updateMetricsForDeactivatedNode(initialState, finalState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>metricsä¿¡æ¯æ˜¯åœ¨<code>updateMetricsForDeactivatedNode</code>ä¸­å¢åŠ çš„ï¼ŒæŸ¥çœ‹å…¶å…·ä½“é€»è¾‘æ²¡æœ‰ä»€ä¹ˆå¼‚å¸¸é€»è¾‘ï¼Œå°±æ˜¯ç®€å•çš„æ ¹æ®å…·ä½“çš„çŠ¶æ€å¯¹å…¶è¿›è¡Œincrå’Œdecrã€‚<br>è¿™é‡Œæˆ‘ä»¬éœ€è¦æ³¨æ„åœ¨æ›´æ–°metricsä¹‹å‰çš„ä¸€ä¸ªputæ“ä½œï¼Œè¿™é‡Œå°†å½“å‰èŠ‚ç‚¹putåˆ°ä¸€ä¸ªinactiveé˜Ÿåˆ—ä¸­ï¼ŒLostNodeçš„å…·ä½“èŠ‚ç‚¹ä¿¡æ¯å­˜å‚¨åœ¨è¿™é‡Œï¼Œè¿™é‡Œä¼šä¸ä¼šæœ‰é—®é¢˜å‘¢ï¼Ÿ</p><p>inactiveæ˜¯<code>ConcurrentMap&lt;String, RMNode&gt; inactiveNodes = new ConcurrentHashMap&lt;String, RMNode&gt;()</code>æ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ï¼Œçœ‹ä¸‹è¿™é‡Œçš„kvåˆ°åº•å­˜çš„æ˜¯ä»€ä¹ˆï¼ŒæŸ¥å…¶æºç å¯ä»¥çœ‹å‡ºè¿™é‡Œkeyæ˜¯ä¸»æœºhostï¼Œä¸ä¸ç«¯å£ç»‘å®šï¼Œé‡å¯NMæ—¶å¯ä»¥ä»inactiveä¸­å–å‡ºå¯¹åº”çš„hostã€‚</p><p>incrçš„é€»è¾‘å¹¶æ²¡æœ‰å‘ç°ä»€ä¹ˆé—®é¢˜ï¼Œé‚£ç»§ç»­çœ‹ä¸‹decrç›¸å…³çš„ä»£ç </p><h3 id="Lost-Node-decr"><a href="#Lost-Node-decr" class="headerlink" title="Lost Node decr"></a>Lost Node decr</h3><p>æ ¹æ®<code>decrNumLostNMs</code>æ–¹æ³•æˆ‘ä»¬åè·Ÿè¸ªåˆ°NMåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šè§¦å‘è¿™éƒ¨åˆ†ä»£ç ï¼Œå¤§ä½“æµç¨‹æ˜¯<code>RMNodeEventType.STARTED</code>äº‹ä»¶è§¦å‘ï¼Œç”±<code>AddNodeTransition</code>è¿›è¡Œæ•è·å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// äº‹ä»¶è§¦å‘çŠ¶æ€è½¬æ¢</span></span><br><span class="line">.addTransition(NodeState.NEW, NodeState.RUNNING,</span><br><span class="line">    RMNodeEventType.STARTED, <span class="keyword">new</span> AddNodeTransition())</span><br><span class="line"></span><br><span class="line"><span class="comment">// AddNodeTransition.transition</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(RMNodeImpl rmNode, RMNodeEvent event)</span> </span>&#123;</span><br><span class="line">...</span><br><span class="line">  String host = rmNode.nodeId.getHost();</span><br><span class="line">  <span class="comment">// æ ¹æ®å½“å‰èŠ‚ç‚¹çš„hostä»inactiveä¸­ç§»é™¤è¯¥èŠ‚ç‚¹ä¿¡æ¯å¹¶è¿”å›ç›¸å…³ä¿¡æ¯</span></span><br><span class="line">  RMNode previousRMNode = rmNode.context.getInactiveRMNodes().remove(host);</span><br><span class="line">  <span class="comment">// previousRMNodeä¸ºnullï¼Œè¯´æ˜inactiveé˜Ÿåˆ—ä¸­æ²¡æœ‰è¯¥hostçš„ä¿¡æ¯ï¼Œ</span></span><br><span class="line">  <span class="comment">// å½“ä½œä¸€ä¸ªæ–°çš„èŠ‚ç‚¹è¿›è¡Œå¤„ç†ï¼ŒLost Nodesä¿¡æ¯ä¸å‘ç”Ÿå˜åŒ–</span></span><br><span class="line">  <span class="comment">// å¦‚æœpreviousRMNodeä¸ä¸ºnullï¼Œåˆ™æ›´æ–°Lost Nodesçš„ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">if</span> (previousRMNode != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (previousRMNode.getNodeID().getPort() != -<span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// Old node rejoining</span></span><br><span class="line">      rmNode.updateMetricsForRejoinedNode(previousRMNode.getState());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// An old excluded node rejoining</span></span><br><span class="line">      ClusterMetrics.getMetrics().decrDecommisionedNMs();</span><br><span class="line">      containers = updateNewNodeMetricsAndContainers(rmNode, startEvent);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// Increment activeNodes explicitly because this is a new node.</span></span><br><span class="line">    containers = updateNewNodeMetricsAndContainers(rmNode, startEvent);</span><br><span class="line">  &#125;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä¸Šé¢çš„ä»£ç å¾—çŸ¥ï¼Œæ–°å¯åŠ¨ä¸€ä¸ªèŠ‚ç‚¹å›å»inactiveé˜Ÿåˆ—ä¸­checkä¸‹æ˜¯å¦å­˜åœ¨ï¼Œå­˜åœ¨åˆ™æ›´æ–°ä¸‹Lost Nodesçš„metricsè®¡æ•°ä¿¡æ¯ï¼Œä¸å­˜åœ¨åˆ™ä¸æ›´æ–°Lost Nodes metricsçš„è®¡æ•°ä¿¡æ¯ã€‚</p><p>çœ‹åˆ°è¿™é‡Œæ˜¯ä¸æ˜¯æ„Ÿè§‰incrå’Œdecrçš„é€»è¾‘éƒ½æ­£å¸¸ï¼Œä¸å­˜åœ¨Lost Nodesçš„metricsæ›´æ–°å¼‚å¸¸çš„é—®é¢˜ï¼Œä½†æ˜¯æ ¹æ®æ•…éšœçš„æƒ³è±¡ä»”ç»†åˆ†æä¼šå‘ç°è‚¯å®šæ˜¯æ–°å¯åŠ¨çš„NMæ²¡æœ‰ä»Lost Nodesä¸­æ­£å¸¸å‡å°‘ï¼Œé‚£ä¹ˆä»€ä¹ˆæƒ…å†µä¼šä¸æ­£å¸¸å‘¢ï¼Ÿ</p><blockquote><p>æ–°å¯åŠ¨ä¸€ä¸ªèŠ‚ç‚¹éœ€è¦å»inactiveä¸­checkä¸‹å½“å‰èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œé‚£ä¹ˆå¦‚æœå½“å‰èŠ‚ç‚¹<strong>ä¹‹å‰å¯åŠ¨çš„ä¿¡æ¯</strong>è¿˜æ²¡æœ‰æ”¾å…¥inactiveé‚£è¿™æ¬¡æ–°å¯åŠ¨æ—¶å°±æ— æ³•checkæˆåŠŸï¼Œé‚£å°±å½“æˆä¸€ä¸ªæ–°çš„èŠ‚ç‚¹å¯åŠ¨äº†ã€‚å› ä¸ºä»incrçš„ä»£ç ä¸­åˆ†æå¯ä»¥å¾—çŸ¥NMåœ¨<code>RMNodeEventType.EXPIRE</code>äº‹ä»¶ä¹‹åæ‰ä¼šæ”¾å…¥inactiveä¸­ï¼Œè¿™ä¸ªäº‹ä»¶éœ€è¦è¶…æ—¶5åˆ†é’Ÿï¼Œè¿™ä¸ªæ—¶é—´å·®å°±å¯¼è‡´äº†Active Nodesä¸Lost Nodesæ€»æ•°ä¸é›†ç¾¤çš„è§„æ¨¡ä¸åŒ¹é…çš„åŸå› ï¼Œæˆ‘ä»¬éªŒè¯ä¸‹ï¼Œ<strong>æŠŠä¸€ä¸ªèŠ‚ç‚¹åœæ‰ç„¶åç«‹é©¬å¯åŠ¨ï¼Œä¼šå‘ç°Active Nodeså¢åŠ äº†ä¸€ä¸ªï¼Œå¾…5åˆ†é’Ÿä¹‹åï¼ŒLost Nodesä¸­å¢åŠ ä¸€ä¸ªï¼ŒActive Nodeså‡å°‘ä¸€ä¸ªï¼Œæ­¤æ—¶Active Nodesæ­£å¸¸ï¼Œä½†Lost Nodesæ˜¾ç¤ºå¼‚å¸¸ï¼Œä¸å¼€ç¯‡çš„ç°è±¡ä¸€è‡´</strong>ã€‚</p></blockquote><h3 id="è§£å†³é—®é¢˜"><a href="#è§£å†³é—®é¢˜" class="headerlink" title="è§£å†³é—®é¢˜"></a>è§£å†³é—®é¢˜</h3><p>æ˜ç™½äº†æ•…éšœå‡ºç°çš„åŸå› ï¼Œå°±ç¦»è§£å†³æ–¹æ¡ˆä¸è¿œäº†ã€‚è¿™ä¸ªæ˜¾ç¤ºå¼‚å¸¸å…¶å®æ˜¯å› ä¸ºæ¯ä¸ªNMå¯åŠ¨çš„æ—¶å€™ç«¯å£æ˜¯éšæœºçš„ï¼Œå¦‚æœæŸä¸ªNMåœæ­¢å’Œå¯åŠ¨é—´éš”æ—¶é—´è¾ƒçŸ­(å°äº5åˆ†é’Ÿ)ï¼Œ<em>åˆ™ä¹‹å‰å¯åŠ¨çš„NMè¿›ç¨‹åœ¨è¶…æ—¶ä¹‹åçŠ¶æ€è½¬æ¢ä¸ºLostçŠ¶æ€</em>ï¼Œä½†å½“å‰hostä¸Šçš„æ–°NMè¿›ç¨‹å·²ç»å¯åŠ¨ï¼Œæ— æ³•è§¦å‘Lostçš„æ›´æ–°æ“ä½œã€‚</p><p>å…³é”®ç¯èŠ‚å‡ºç°åœ¨<em>æ£€æŸ¥è¶…æ—¶</em>è¿™é‡Œï¼Œè¶…æ—¶æ˜¯é€šè¿‡NMä¸RMä¹‹é—´çš„å¿ƒè·³æ¥ç»´æŠ¤çš„ï¼Œå¿ƒè·³æ˜¯ç”±<code>host+port</code>æ¥è¯†åˆ«çš„ï¼ŒæŠŠNMå¯¹åº”çš„portå›ºå®šå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜äº†ã€‚</p><p>é‚£ä¹ˆæˆ‘ä»¬å°±æ‰¾ä¸‹è¿™ä¸ªç«¯å£æ˜¯åœ¨å“ªç”Ÿæˆçš„ã€‚</p><p>æˆ‘ä»¬ä»decrå¤„çš„ä»£ç ä½œä¸ºå…¥å£è¿›è¡Œåè·Ÿè¸ªã€‚<br><code>AddNodeTransition.transition</code>ä¸­inactiveçš„keyæ˜¯ä»<code>rmNode.nodeId.getHost()</code>ä¸­å¾—åˆ°çš„ï¼ŒrmNodeæ˜¯RMNodeImplç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸‹RMNodeImplä¸­nodeIdå±æ€§æ˜¯å¦‚ä½•èµ‹å€¼çš„ï¼Œå‘ç°æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼çš„ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">RMNodeImpl</span><span class="params">(NodeId nodeId, RMContext context, String hostName,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> cmPort, <span class="keyword">int</span> httpPort, Node node, Resource capability, String nodeManagerVersion)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.nodeId = nodeId;</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é‚£è¿™ä¸ªå¯¹è±¡åˆæ˜¯åœ¨å“ªå®ä¾‹åŒ–çš„å‘¢ï¼Ÿç»§ç»­è·Ÿè¸ªåˆ°<code>ResourceTrackerService.registerNodeManager</code>æ–¹æ³•ï¼Œå‘ç°portä¿¡æ¯æ˜¯ä»requestè¯·æ±‚ä¸­å–çš„ï¼Œrequestæ˜¯åœ¨<code>NodeStatusUpdaterImpl.registerWithRM</code>å®ä¾‹åŒ–ï¼Œè€Œå®ä¾‹åŒ–ä½¿ç”¨çš„nodeIdæ˜¯<code>NMContext</code>çš„ä¸€ä¸ªå±æ€§ä¸”é€šè¿‡<code>setNodeId</code>è¿›è¡Œèµ‹å€¼çš„ï¼Œè¿™ä¸ªèµ‹å€¼æ“ä½œå‘ç”Ÿåœ¨<code>ContainerManagerImpl.serviceStart</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="keyword">final</span> InetSocketAddress initialAddress = conf.getSocketAddr(</span><br><span class="line">      YarnConfiguration.NM_BIND_HOST,</span><br><span class="line">      YarnConfiguration.NM_ADDRESS,</span><br><span class="line">      YarnConfiguration.DEFAULT_NM_ADDRESS,</span><br><span class="line">      YarnConfiguration.DEFAULT_NM_PORT);</span><br><span class="line"> ...</span><br><span class="line">  <span class="comment">// setup node ID</span></span><br><span class="line">  InetSocketAddress connectAddress;</span><br><span class="line">  <span class="keyword">if</span> (delayedRpcServerStart) &#123;</span><br><span class="line">    connectAddress = NetUtils.getConnectAddress(initialAddress);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    server.start();</span><br><span class="line">    connectAddress = NetUtils.getConnectAddress(server);</span><br><span class="line">  &#125;</span><br><span class="line">  NodeId nodeId = buildNodeId(connectAddress, hostOverride);</span><br><span class="line">  ((NodeManager.NMContext)context).setNodeId(nodeId);</span><br><span class="line">...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä¸Šé¢çš„ä»£ç å‘ç”ŸnodeIdæ˜¯é€šè¿‡<code>connectAddress</code>å®ä¾‹åŒ–çš„ï¼Œè€Œ<code>connectAddress</code>åˆæ˜¯<code>initialAddress</code>å¾—åˆ°çš„ï¼ŒinitialAddresså°±æ˜¯æˆ‘ä»¬è¦æ‰¾çš„ç»ˆæç›®æ ‡ã€‚</p><p>è¿™é‡Œçš„ä¸»è¦æ˜¯ä¸¤ä¸ªå˜é‡<code>YarnConfiguration.NM_BIND_HOST</code>å’Œ<code>YarnConfiguration.NM_ADDRESS</code>å¯¹åº”çš„é…ç½®é¡¹æ˜¯<code>yarn.nodemanager.bind-host</code>å’Œ<code>yarn.nodemanager.address</code>ã€‚</p><p>æ˜¾è€Œæ˜“è§<code>yarn.nodemanager.address</code>çš„é»˜è®¤å€¼æ˜¯<code>$&#123;yarn.nodemanager.hostname&#125;:0</code>æ§åˆ¶äº†NMçš„ç«¯å£ï¼Œ<strong>åœ¨è¿™é‡ŒæŒ‡å®šç«¯å£æ¥å›ºå®šNMçš„å¿ƒè·³ç«¯å£ï¼Œåœ¨NMé‡å¯çš„æ—¶å€™å¯ä»¥ç»§ç»­ä¹‹å‰çš„å¿ƒè·³ç«¯å£ï¼Œæ¥é¿å…é‡å¯çš„æ—¶å€™å¯¼è‡´Lost Nodesæ˜¾ç¤ºå¼‚å¸¸</strong>ã€‚</p><h2 id="äº‹åè¯¸è‘›"><a href="#äº‹åè¯¸è‘›" class="headerlink" title="äº‹åè¯¸è‘›"></a>äº‹åè¯¸è‘›</h2><p>å…¶å®å¦‚æœä½ ç†Ÿæ‚‰Hadoopçš„çŠ¶æ€æœºçš„è¯ï¼Œå¾ˆå®¹æ˜“ç›´æ¥å®šä½åˆ°Lost Nodesçš„å˜åŒ–æ˜¯åœ¨NMçŠ¶æ€å˜åŒ–çš„æ—¶å€™è§¦å‘çš„ï¼Œè¿™å°±ç›´æ¥å®šä½åˆ°å…³é”®ç±»<code>RMNodeImpl</code></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> LostNode </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»¥å¤ªåŠæµ‹è¯•ç¯å¢ƒéƒ¨ç½²</title>
      <link href="/Ethereum-private-chain.html"/>
      <url>/Ethereum-private-chain.html</url>
      
        <content type="html"><![CDATA[<p>ä¸Šç¯‡ä»‹ç»äº†ä»¥å¤ªåŠå¼€å‘ç¯å¢ƒï¼Œæœ¬ç¯‡ä»‹ç»ä¸‹å¦‚ä½•ä½¿ç”¨ç§æœ‰é“¾ã€‚</p><span id="more"></span><p>ä½¿ç”¨ç§æœ‰é“¾ä¹‹å‰ï¼Œå…ˆè¦åˆ›å»ºåˆ›ä¸–å—genesisã€‚</p><h2 id="åˆå§‹åŒ–ç§æœ‰é“¾"><a href="#åˆå§‹åŒ–ç§æœ‰é“¾" class="headerlink" title="åˆå§‹åŒ–ç§æœ‰é“¾"></a>åˆå§‹åŒ–ç§æœ‰é“¾</h2><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line"> <span class="attr">&quot;nonce&quot;</span>: <span class="string">&quot;0x0000000000000042&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;0x0&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;parentHash&quot;</span>: <span class="string">&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;mixhash&quot;</span>: <span class="string">&quot;0x0000000000000000000000000000000000000000000000000000000000000000&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;extraData&quot;</span>: <span class="string">&quot;0x&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;gasLimit&quot;</span>: <span class="string">&quot;0x80000000&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;difficulty&quot;</span>: <span class="string">&quot;0x3&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;coinbase&quot;</span>: <span class="string">&quot;0x3333333333333333333333333333333333333333&quot;</span>,</span><br><span class="line"> <span class="attr">&quot;config&quot;</span>:&#123;</span><br><span class="line">    <span class="attr">&quot;chainId&quot;</span>: <span class="number">55</span>,</span><br><span class="line">    <span class="attr">&quot;homesteadBlock&quot;</span>: <span class="number">0</span>,</span><br><span class="line">    <span class="attr">&quot;eip155Block&quot;</span>: <span class="number">0</span></span><br><span class="line"> &#125;,</span><br><span class="line"> <span class="attr">&quot;alloc&quot;</span>: &#123;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†ä¸Šè¿°å†…å®¹å†™å…¥æ–‡ä»¶<code>genesis.json</code>ä¸­ï¼Œå­—æ®µçš„è§£é‡Šå¦‚ä¸‹:</p><p>nonceï¼š64ä½éšæœºæ•°ï¼Œç”¨äºæŒ–çŸ¿<br>timestampï¼šåˆ›ä¸–å—çš„æ—¶é—´æˆ³<br>parentHashï¼šä¸Šä¸€ä¸ªåŒºå—çš„hashå€¼ï¼Œå› ä¸ºæ˜¯åˆ›ä¸–å—ï¼Œæ‰€ä»¥è¿™ä¸ªå€¼æ˜¯0<br>mixhashï¼šä¸ nonce é…åˆç”¨äºæŒ–çŸ¿ï¼Œç”±ä¸Šä¸€ä¸ªåŒºå—çš„ä¸€éƒ¨åˆ†ç”Ÿæˆçš„ hashã€‚(<strong>è¿™ä¸ªåœ¨bitcoinä¸­æ²¡æœ‰ï¼Œå…·ä½“æ˜¯å¹²ä»€ä¹ˆç”¨çš„å‘¢ï¼Ÿï¼Ÿï¼Ÿ</strong>)<br>extraDataï¼šé™„åŠ ä¿¡æ¯ï¼Œä»»æ„å¡«å†™<br>gasLimit ï¼šå¯¹GASçš„æ¶ˆè€—æ€»é‡é™åˆ¶ï¼Œç”¨æ¥é™åˆ¶åŒºå—èƒ½åŒ…å«çš„äº¤æ˜“ä¿¡æ¯æ€»å’Œï¼Œå› ä¸ºæˆ‘ä»¬å°±æµ‹è¯•é“¾ï¼Œæ‰€ä»¥éšæ„å¡«å†™ã€‚<br>difficultyï¼šéš¾åº¦å€¼ï¼Œè¶Šå¤§è¶Šéš¾ (<strong>bitcoinæ˜¯éš¾åº¦å€¼è¶Šå°è¶Šéš¾ï¼Œæ³¨æ„ä¸‹ä¸åŒï¼ŒéšåæŠ½ç©ºçœ‹ä¸‹ä»¥å¤ªåŠçš„éš¾åº¦å€¼</strong>)<br>coinbaseï¼šçŸ¿å·¥è´¦å·ï¼Œç¬¬ä¸€ä¸ªåŒºå—æŒ–å‡ºåå°†ç»™è¿™ä¸ªçŸ¿å·¥è´¦å·å‘é€å¥–åŠ±çš„ä»¥å¤ªå¸ã€‚(<strong>æ„Ÿè§‰è²Œä¼¼æ²¡ç”¨ï¼Ÿï¼Ÿï¼Ÿä¹Ÿå¯èƒ½ä½¿ç”¨çš„æ–¹å¼ä¸å¯¹ï¼Œå¾…æµ‹</strong>)<br>allocï¼š é¢„è®¾è´¦å·ä»¥åŠè´¦å·çš„ä»¥å¤ªå¸æ•°é‡ï¼Œæµ‹è¯•é“¾æŒ–çŸ¿æ¯”è¾ƒå®¹æ˜“å¯ä»¥ä¸é…ç½®<br>chainId æŒ‡å®šäº†ç‹¬ç«‹çš„åŒºå—é“¾ç½‘ç»œ IDï¼Œä¸åŒ ID ç½‘ç»œçš„èŠ‚ç‚¹æ— æ³•äº’ç›¸è¿æ¥ã€‚</p><p>åˆ›å»ºäº†genesisæ–‡ä»¶ä¹‹åï¼Œåˆå§‹åŒ–ç§æœ‰é“¾ï¼Œå‘½ä»¤ä¸º<code>geth --datadir=data0 init genesis.json</code><br>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">hadoop@ubuntu:~/blockchain/ethereum$ geth --datadir data0 init genesis.json</span><br><span class="line">WARN [08-23|08:39:07.353] Sanitizing cache to Go<span class="string">&#x27;s GC limits       provided=1024 updated=662</span></span><br><span class="line"><span class="string">INFO [08-23|08:39:07.355] Maximum peer count                       ETH=25 LES=0 total=25</span></span><br><span class="line"><span class="string">INFO [08-23|08:39:07.357] Allocated cache and file handles         database=/home/hadoop/blockchain/ethereum/data0/geth/chaindata cache=16 handles=16</span></span><br><span class="line"><span class="string">INFO [08-23|08:39:07.400] Persisted trie from memory database      nodes=0 size=0.00B time=14.163Âµs gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B</span></span><br><span class="line"><span class="string">INFO [08-23|08:39:07.405] Successfully wrote genesis state         database=chaindata                                             hash=4a306eâ€¦543a63</span></span><br><span class="line"><span class="string">INFO [08-23|08:39:07.405] Allocated cache and file handles         database=/home/hadoop/blockchain/ethereum/data0/geth/lightchaindata cache=16 handles=16</span></span><br><span class="line"><span class="string">INFO [08-23|08:39:07.420] Persisted trie from memory database      nodes=0 size=0.00B time=3.02Âµs   gcnodes=0 gcsize=0.00B gctime=0s livenodes=1 livesize=0.00B</span></span><br><span class="line"><span class="string">INFO [08-23|08:39:07.420] Successfully wrote genesis state         database=lightchaindata                                             hash=4a306eâ€¦543a63</span></span><br></pre></td></tr></table></figure><p>å¦‚ä¸Šåˆ™åˆå§‹åŒ–æˆåŠŸï¼Œä¸‹é¢å¼€å§‹ä½¿ç”¨ç§æœ‰é“¾</p><h2 id="ä½¿ç”¨ç§æœ‰é“¾"><a href="#ä½¿ç”¨ç§æœ‰é“¾" class="headerlink" title="ä½¿ç”¨ç§æœ‰é“¾"></a>ä½¿ç”¨ç§æœ‰é“¾</h2><p>æ‰§è¡Œå‘½ä»¤<code>geth --datadir data0 --networkid 1108 console</code>è¿›å…¥gethçš„ç»ˆç«¯ï¼Œæ­¤æ—¶å°±å’Œä¸Šç¯‡çš„å¼€å‘ç¯å¢ƒä¸€æ ·äº†ï¼ŒåŒæ ·çš„æŒ–çŸ¿æµç¨‹æ¥ä¸€å¥—å°±okäº†ã€‚</p><!--geth --rpc --rpcaddr="0.0.0.0" --rpccorsdomain="*" --unlock '0' --password ~/Library/Ethereum/password   --nodiscover --maxpeers '5' --networkid '1234574' --datadir '~/Library/Ethereum'  consolgeth --identity "TestNode" --rpc --rpcport "8545" --datadir=/data0/eth-test --port "30303" --nodiscover console--><p>åˆ«çš„å‘½ä»¤ä¸ç´¯èµ˜äº†ï¼Œæœ‰éœ€è¦å¯ä»¥ç¿»ç¿»ä¹‹å‰çš„æ–‡ç« ï¼Œåªè®°å½•ä¸‹æ‰§è¡Œ<code>miner.start()</code>å‘½ä»¤ä¹‹åçš„è¾“å‡º</p><p>miner.start()ä¹‹åï¼Œå…ˆç”ŸæˆDAGï¼Œä¼šå±•ç¤ºè¿›åº¦ï¼Œè¾“å‡ºçš„å…³é”®å­—ä¸º<code>Generating DAG in progress</code><br>éšååœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼šä¼´éšå—çš„äº§ç”Ÿï¼Œè¾“å‡ºçš„å…³é”®å­—ä¸º<code>Successfully sealed new block</code><br>å…·ä½“è¾“å‡ºå¦‚ä¸‹:</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;</span><span class="bash"> miner.start(2)</span></span><br><span class="line">INFO [08-22|09:10:31.066] Updated mining threads                   threads=2</span><br><span class="line">INFO [08-22|09:10:31.067] Transaction pool price threshold updated price=18000000000</span><br><span class="line">null</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> INFO [08-22|09:10:31.109] Starting mining operation</span></span><br><span class="line">INFO [08-22|09:10:31.109] Commit new mining work                   number=1 txs=0 uncles=0 elapsed=118.785Âµs</span><br><span class="line">INFO [08-22|09:10:31.369] Generating DAG in progress               epoch=1 percentage=19 elapsed=2m3.630s</span><br><span class="line">INFO [08-22|09:10:37.935] Generating DAG in progress               epoch=1 percentage=20 elapsed=2m10.196s</span><br><span class="line">INFO [08-22|09:10:44.781] Generating DAG in progress               epoch=1 percentage=21 elapsed=2m17.043s</span><br><span class="line">INFO [08-22|09:10:52.263] Generating DAG in progress               epoch=1 percentage=22 elapsed=2m24.524s</span><br><span class="line">INFO [08-22|09:10:59.633] Generating DAG in progress               epoch=1 percentage=23 elapsed=2m31.895s</span><br><span class="line">INFO [08-22|09:11:06.632] Generating DAG in progress               epoch=1 percentage=24 elapsed=2m38.894s</span><br><span class="line">INFO [08-22|09:11:13.379] Generating DAG in progress               epoch=1 percentage=25 elapsed=2m45.641s</span><br><span class="line">INFO [08-22|09:11:20.101] Generating DAG in progress               epoch=1 percentage=26 elapsed=2m52.362s</span><br><span class="line">INFO [08-22|09:11:26.798] Generating DAG in progress               epoch=1 percentage=27 elapsed=2m59.059s</span><br><span class="line">INFO [08-22|09:11:34.509] Generating DAG in progress               epoch=1 percentage=28 elapsed=3m6.770s</span><br><span class="line">INFO [08-22|09:11:41.806] Generating DAG in progress               epoch=1 percentage=29 elapsed=3m14.068s</span><br><span class="line">INFO [08-22|09:11:49.068] Generating DAG in progress               epoch=1 percentage=30 elapsed=3m21.329s</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.accounts.INFO [08-22|09:11:56.419] Generating DAG <span class="keyword">in</span> progress               epoch=1 percentage=31 elapsed=3m28.680s</span></span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> eth.accounts</span></span><br><span class="line">[&quot;0x729ef979ace85837425a46055e9b7264c32c21e6&quot;, &quot;0xf5727a89f2b4dfb58ac199755823a22935fb9fbf&quot;]</span><br><span class="line"><span class="meta">&gt;</span><span class="bash"> INFO [08-22|09:12:03.486] Generating DAG <span class="keyword">in</span> progress               epoch=1 percentage=32 elapsed=3m35.747s</span></span><br><span class="line">INFO [08-22|09:12:10.594] Generating DAG in progress               epoch=1 percentage=33 elapsed=3m42.855s</span><br><span class="line">INFO [08-22|09:12:17.769] Generating DAG in progress               epoch=1 percentage=34 elapsed=3m50.031s</span><br><span class="line">INFO [08-22|09:12:24.648] Generating DAG in progress               epoch=1 percentage=35 elapsed=3m56.910s</span><br><span class="line">INFO [08-22|09:12:31.965] Generating DAG in progress               epoch=1 percentage=36 elapsed=4m4.226s</span><br><span class="line">INFO [08-22|09:12:38.996] Generating DAG in progress               epoch=1 percentage=37 elapsed=4m11.257s</span><br><span class="line">INFO [08-22|09:12:46.210] Generating DAG in progress               epoch=1 percentage=38 elapsed=4m18.472s</span><br><span class="line">INFO [08-22|09:12:52.898] Generating DAG in progress               epoch=1 percentage=39 elapsed=4m25.159s</span><br><span class="line">INFO [08-22|09:12:59.072] Generating DAG in progress               epoch=1 percentage=40 elapsed=4m31.333s</span><br><span class="line">INFO [08-22|09:13:03.176] Successfully sealed new block            number=1 hash=5b2050â€¦9754cd</span><br><span class="line">INFO [08-22|09:13:03.234] ğŸ”¨ mined potential block                  number=1 hash=5b2050â€¦9754cd</span><br><span class="line">INFO [08-22|09:13:03.237] Commit new mining work                   number=2 txs=0 uncles=0 elapsed=2.910ms</span><br><span class="line">INFO [08-22|09:13:06.398] Successfully sealed new block            number=2 hash=ecb729â€¦78a768</span><br><span class="line">INFO [08-22|09:13:06.399] ğŸ”¨ mined potential block                  number=2 hash=ecb729â€¦78a768</span><br><span class="line">INFO [08-22|09:13:06.399] Commit new mining work                   number=3 txs=0 uncles=0 elapsed=123.882Âµs</span><br><span class="line">INFO [08-22|09:13:07.162] Generating DAG in progress               epoch=1 percentage=41 elapsed=4m39.423s</span><br><span class="line">INFO [08-22|09:13:08.005] Successfully sealed new block            number=3 hash=265505â€¦2113c3</span><br><span class="line">INFO [08-22|09:13:08.005] ğŸ”¨ mined potential block                  number=3 hash=265505â€¦2113c3</span><br><span class="line">INFO [08-22|09:13:08.005] Commit new mining work                   number=4 txs=0 uncles=0 elapsed=93.513Âµs</span><br><span class="line">INFO [08-22|09:13:10.197] Successfully sealed new block            number=4 hash=07a7f2â€¦9c3877</span><br><span class="line">INFO [08-22|09:13:10.197] ğŸ”¨ mined potential block                  number=4 hash=07a7f2â€¦9c3877</span><br><span class="line">INFO [08-22|09:13:10.218] Commit new mining work                   number=5 txs=0 uncles=0 elapsed=118.561Âµs</span><br><span class="line">INFO [08-22|09:13:11.572] Successfully sealed new block            number=5 hash=80c62eâ€¦229bb9</span><br><span class="line">INFO [08-22|09:13:11.573] ğŸ”¨ mined potential block                  number=5 hash=80c62eâ€¦229bb9</span><br><span class="line">INFO [08-22|09:13:11.573] Commit new mining work                   number=6 txs=0 uncles=0 elapsed=134.57Âµs</span><br><span class="line">INFO [08-22|09:13:13.347] Generating DAG in progress               epoch=1 percentage=42 elapsed=4m45.609s</span><br><span class="line">INFO [08-22|09:13:19.373] Generating DAG in progress               epoch=1 percentage=43 elapsed=4m51.634s</span><br><span class="line">INFO [08-22|09:13:26.582] Generating DAG in progress               epoch=1 percentage=44 elapsed=4m58.844s</span><br><span class="line">INFO [08-22|09:13:30.189] Successfully sealed new block            number=6 hash=c8e518â€¦fbad3c</span><br><span class="line">INFO [08-22|09:13:30.190] ğŸ”— block reached canonical chain          number=1 hash=5b2050â€¦9754cd</span><br><span class="line">INFO [08-22|09:13:30.192] ğŸ”¨ mined potential block                  number=6 hash=c8e518â€¦fbad3c</span><br><span class="line">INFO [08-22|09:13:30.203] Commit new mining work                   number=7 txs=0 uncles=0 elapsed=152.206Âµs</span><br><span class="line">INFO [08-22|09:13:32.481] Generating DAG in progress               epoch=1 percentage=45 elapsed=5m4.743s</span><br><span class="line">INFO [08-22|09:13:34.301] Successfully sealed new block            number=7 hash=b286afâ€¦979418</span><br><span class="line">INFO [08-22|09:13:34.302] ğŸ”— block reached canonical chain          number=2 hash=ecb729â€¦78a768</span><br><span class="line">INFO [08-22|09:13:34.302] ğŸ”¨ mined potential block                  number=7 hash=b286afâ€¦979418</span><br><span class="line">INFO [08-22|09:13:34.302] Commit new mining work                   number=8 txs=0 uncles=0 elapsed=135.716Âµs</span><br><span class="line">INFO [08-22|09:13:35.776] Successfully sealed new block            number=8 hash=1496cdâ€¦e06258</span><br><span class="line">INFO [08-22|09:13:35.778] ğŸ”— block reached canonical chain          number=3 hash=265505â€¦2113c3</span><br><span class="line">INFO [08-22|09:13:35.778] ğŸ”¨ mined potential block                  number=8 hash=1496cdâ€¦e06258</span><br><span class="line">INFO [08-22|09:13:35.796] Commit new mining work                   number=9 txs=0 uncles=0 elapsed=905.496Âµs</span><br><span class="line">INFO [08-22|09:13:38.655] Generating DAG in progress               epoch=1 percentage=46 elapsed=5m10.916s</span><br><span class="line">INFO [08-22|09:13:40.374] Successfully sealed new block            number=9 hash=8d7fa0â€¦676de1</span><br><span class="line">INFO [08-22|09:13:40.375] ğŸ”— block reached canonical chain          number=4 hash=07a7f2â€¦9c3877</span><br><span class="line">INFO [08-22|09:13:40.375] ğŸ”¨ mined potential block                  number=9 hash=8d7fa0â€¦676de1</span><br><span class="line">INFO [08-22|09:13:40.386] Commit new mining work                   number=10 txs=0 uncles=0 elapsed=11.551ms</span><br><span class="line">INFO [08-22|09:13:44.547] Generating DAG in progress               epoch=1 percentage=47 elapsed=5m16.809s</span><br><span class="line">INFO [08-22|09:13:52.465] Generating DAG in progress               epoch=1 percentage=48 elapsed=5m24.726s</span><br><span class="line">INFO [08-22|09:13:52.692] Successfully sealed new block            number=10 hash=687e93â€¦116aa7</span><br><span class="line">INFO [08-22|09:13:52.693] ğŸ”— block reached canonical chain          number=5  hash=80c62eâ€¦229bb9</span><br><span class="line">INFO [08-22|09:13:52.693] ğŸ”¨ mined potential block                  number=10 hash=687e93â€¦116aa7</span><br><span class="line">INFO [08-22|09:13:52.693] Commit new mining work                   number=11 txs=0 uncles=0 elapsed=112.383Âµs</span><br><span class="line">INFO [08-22|09:13:55.432] Successfully sealed new block            number=11 hash=09a872â€¦2054a1</span><br><span class="line">INFO [08-22|09:13:55.432] ğŸ”— block reached canonical chain          number=6  hash=c8e518â€¦fbad3c</span><br><span class="line">INFO [08-22|09:13:55.432] ğŸ”¨ mined potential block                  number=11 hash=09a872â€¦2054a1</span><br><span class="line">INFO [08-22|09:13:55.432] Commit new mining work                   number=12 txs=0 uncles=0 elapsed=124.793Âµs</span><br><span class="line">INFO [08-22|09:13:57.145] Successfully sealed new block            number=12 hash=e9f8d3â€¦e1c6ee</span><br><span class="line">INFO [08-22|09:13:57.145] ğŸ”— block reached canonical chain          number=7  hash=b286afâ€¦979418</span><br><span class="line">INFO [08-22|09:13:57.145] ğŸ”¨ mined potential block                  number=12 hash=e9f8d3â€¦e1c6ee</span><br><span class="line">INFO [08-22|09:13:57.145] Commit new mining work                   number=13 txs=0 uncles=0 elapsed=111.673Âµs</span><br><span class="line">INFO [08-22|09:13:59.277] Generating DAG in progress               epoch=1 percentage=49 elapsed=5m31.538s</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Ethereum </tag>
            
            <tag> Test </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>ä»¥å¤ªåŠç¯å¢ƒéƒ¨ç½²</title>
      <link href="/Ethereum-deploy.html"/>
      <url>/Ethereum-deploy.html</url>
      
        <content type="html"><![CDATA[<p>ä»¥å¤ªåŠçš„ç¯å¢ƒå®¹æ˜“éƒ¨ç½²ï¼Œæ‰§è¡Œä¸€äº›å‘½ä»¤å°±OKäº†ã€‚<br>é‚£å°±å¼€å§‹æå§ã€‚ã€‚ã€‚</p><span id="more"></span><h2 id="ä»¥å¤ªåŠç¯å¢ƒéƒ¨ç½²"><a href="#ä»¥å¤ªåŠç¯å¢ƒéƒ¨ç½²" class="headerlink" title="ä»¥å¤ªåŠç¯å¢ƒéƒ¨ç½²"></a>ä»¥å¤ªåŠç¯å¢ƒéƒ¨ç½²</h2><p>åœ¨å®‰è£…ä»¥å¤ªåŠä¹‹å‰è¦å…ˆå®‰è£…ä¸‹goï¼Œgoçš„å®‰è£…ç±»ä¼¼jdkï¼Œä¸‹è½½taråŒ…ï¼Œè§£å‹ç„¶åé…ç½®ä¸‹ç¯å¢ƒå˜é‡ã€‚</p><p>å®‰è£…ä»¥å¤ªåŠï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sudo add-apt-repository -y ppa:ethereum/ethereum</span><br><span class="line">sudo add-apt-repository -y ppa:ethereum/ethereum-dev</span><br><span class="line">sudo add-apt-repository ppa:ethereum/ethereum-qt</span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># å®‰è£…ä»¥å¤ªåŠ</span></span><br><span class="line">sudo apt-get install ethereum</span><br><span class="line"><span class="comment"># å®‰è£…solcç¼–è¯‘å™¨</span></span><br><span class="line">sudo apt-get install cpp-ethereum  <span class="comment"># å¹¶æ²¡æœ‰solcå‘½ä»¤</span></span><br><span class="line">sudo apt-get install solc  <span class="comment"># å®‰è£…solcï¼Œè¿›è¡Œæœ¬åœ°ç¼–è¯‘åˆçº¦</span></span><br></pre></td></tr></table></figure><p>å®‰è£…ç»“æŸä¹‹åçš„ç‰ˆæœ¬æ˜¯<code>Geth/v1.8.13-stable-225171a4/linux-amd64/go1.10</code></p><h2 id="è®¤è¯†ä»¥å¤ªåŠ"><a href="#è®¤è¯†ä»¥å¤ªåŠ" class="headerlink" title="è®¤è¯†ä»¥å¤ªåŠ"></a>è®¤è¯†ä»¥å¤ªåŠ</h2><p>å®Œæˆä»¥ä¸Šæ“ä½œä¹‹åï¼Œå°±å¯ä»¥æ“ä½œä»¥å¤ªåŠäº†ï¼Œå¯ä»¥è¿›è¡ŒæŒ–çŸ¿äº†ã€‚è¿™é‡Œå…ˆæ¥ç†Ÿæ‚‰ä¸‹ä»¥å¤ªåŠçš„å®¢æˆ·ç«¯gethã€‚</p><p>gethçš„å…¨ç§°æ˜¯go-ethereum,æ˜¯ä¸€ä¸ªä»¥å¤ªåŠå®¢æˆ·ç«¯ï¼Œç”¨goè¯­è¨€ç¼–å†™ã€‚</p><p>è¿›å…¥gethå®¢æˆ·ç«¯æœ‰ä¸¤ç§æ¯”è¾ƒæ–¹å¼ï¼Œä¸€ç§æ˜¯<em>ä»¥å¼€å‘æ–¹å¼ç™»å½•</em>,å¦ä¸€ç§æ˜¯ä»¥<em>ç§é“¾æ–¹å¼ç™»å½•</em>ã€‚å…¶ä¸­ä»¥å¼€å‘æ–¹å¼ç™»å½•ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼Œæˆ‘ä»¬å…ˆæ¥ç®€å•çš„ã€‚</p><p>è¾“å…¥å‘½ä»¤<code>geth --dev --dev.period 1  console 2&gt;&gt; geth-log</code>(<strong>æ­¤å‘½ä»¤ï¼Œé»˜è®¤å°±ä¼šæŒ–çŸ¿ï¼Œæ‰§è¡Œminer.stop()åœæ­¢</strong>)è¿›å…¥å®¢æˆ·ç«¯ã€‚</p><p>æ‰§è¡Œä¸Šè¿°å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ç”Ÿæˆä¸€ä¸ªgeth-logçš„æ–‡ä»¶ï¼Œå¯åœ¨å…¶ä¸­æŸ¥çœ‹è¿è¡Œæƒ…å†µã€‚</p><h3 id="æŒ–çŸ¿"><a href="#æŒ–çŸ¿" class="headerlink" title="æŒ–çŸ¿"></a>æŒ–çŸ¿</h3><p>æˆ‘ä»¬æ¥è§¦åˆ°ä»¥å¤ªåŠæˆ–è€…æ¯”ç‰¹å¸çš„ç¬¬ä¸€æƒ³æ³•å°±æ˜¯ï¼Œè‡ªå·±åœ¨æµ‹è¯•ç¯å¢ƒæŒ–ä¸ªçŸ¿ï¼Œæ„Ÿå—ä¸‹ï¼Œå¯¹è¿™äº›è™šæ‹Ÿçš„ä¸œè¥¿æ¥ä¸ªç›´è§‚çš„è®¤è¯†ã€‚</p><p>åœ¨æŒ–çŸ¿ä¹‹å‰æˆ‘ä»¬å…ˆç†Ÿæ‚‰å‡ ä¸ªå¸¸ç”¨çš„å‘½ä»¤ï¼Œæ„Ÿå—ä¸‹gethã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">eth <span class="comment"># å…¨å±€ç¯å¢ƒå˜é‡</span></span><br><span class="line">eth.accounts <span class="comment"># æŸ¥çœ‹ç³»ç»Ÿå·²æœ‰çš„ç”¨æˆ·</span></span><br><span class="line">personal.newAccount(<span class="string">&#x27;bigdatadecode&#x27;</span>) <span class="comment"># æ–°å¢ç”¨æˆ·ï¼Œbigdatadecodeä¸ºå¯†ç </span></span><br><span class="line">personal.newAccount(<span class="string">&#x27;bigdatadecode.top&#x27;</span>) <span class="comment"># å¯ä»¥å¤šå»ºå‡ ä¸ªï¼Œè§‚å¯Ÿä¸‹æ•ˆæœ</span></span><br><span class="line">eth.accounts <span class="comment"># å»ºå®Œä¹‹åï¼Œå†æŸ¥çœ‹ç³»ç»Ÿå·²æœ‰çš„ç”¨æˆ·</span></span><br><span class="line"><span class="comment"># å¯¹ç”¨æˆ·èµ‹å€¼ï¼Œæ–¹ä¾¿ä½¿ç”¨</span></span><br><span class="line">user1 =  eth.accounts[0]</span><br><span class="line">user2 =  eth.accounts[1]</span><br><span class="line">eth.getBalance(user1) <span class="comment"># è´¦æˆ·ä½™é¢</span></span><br></pre></td></tr></table></figure><p>å‘ç°è¿™äº›è´¦æˆ·çš„ä½™é¢æ˜¯0ï¼Œé‚£ä¹ˆé‡ç‚¹å°±æ¥äº†ï¼Œå¼€å§‹æŒ–çŸ¿äº†ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">miner.start() <span class="comment"># å¼€å§‹æŒ–çŸ¿</span></span><br><span class="line">miner.stop() <span class="comment"># åœæ­¢æŒ–çŸ¿</span></span><br><span class="line">eth.getBalcance(user1) <span class="comment"># æŒ–çŸ¿ä¸€æ®µæ—¶é—´ï¼Œè§‚å¯Ÿä¸‹è´¦æˆ·ä½™é¢</span></span><br><span class="line">eth.sendTransaction(&#123;from:user1,to:user2,value:8&#125;) <span class="comment"># è½¬è´¦</span></span><br><span class="line">eth.getBalance(user2)  <span class="comment"># æ­¤æ—¶ä¸º0ï¼Œè¿˜æ²¡æœ‰è¢«ç¡®è®¤ï¼Œ éœ€é‡æ–°å¼€å¯æŒ–çŸ¿ï¼Œç„¶åå†æŸ¥çœ‹ä½™é¢ï¼Œæ­¤æ—¶ä¸º8</span></span><br><span class="line">web3.fromWei(eth.getBalance(eth.accounts[0]), <span class="string">&quot;ether&quot;</span>)</span><br><span class="line">personal.unlockAccount(user3, <span class="string">&#x27;bigdatadecode.top&#x27;</span>) <span class="comment"># è§£é”</span></span><br><span class="line">eth.blockNumber <span class="comment"># æŸ¥çœ‹åŒºå—é«˜åº¦</span></span><br><span class="line">eth.getBlock(8) <span class="comment"># å¾—åˆ°åŒºå—8çš„ä¿¡æ¯</span></span><br><span class="line"></span><br><span class="line">eth.coinbase  <span class="comment"># æŸ¥çœ‹coinbase</span></span><br><span class="line">miner.setEtherbase(eth.coinbase) <span class="comment"># è®¾ç½®minerè´¦å·</span></span><br><span class="line">eth.blockNumber <span class="comment"># æŸ¥çœ‹åŒºå—é«˜åº¦</span></span><br></pre></td></tr></table></figure><blockquote><p>Note: å¦‚æœä½ è¿›å…¥gethçš„å‘½ä»¤æ˜¯<code>geth --dev console 2&gt;&gt; geth-log</code>ï¼Œå½“æ‰§è¡Œ<code>miner.start()</code>æ—¶ï¼Œä¼šè¿”å›nullï¼Œ<br>åŸå› åœ¨äºgethç‰ˆæœ¬æ›´æ–°ä¹‹åï¼Œâ€“devæ¨¡å¼ä¸‹æ–°å¢äº†ä¸€ä¸ªå‚æ•°é¡¹ï¼ŒåŠ ä¸Š<code>--dev.period 1</code></p></blockquote><p><a href="https://blog.csdn.net/wo541075754/article/details/79260040">è¿”å›nullï¼Œè§£å†³æ–¹æ¡ˆåŸæ–‡</a></p><h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><p>ä¸Šä¸€èŠ‚æ“ä½œäº†æŒ–çŸ¿è½¬è´¦ç­‰æµç¨‹ï¼Œè¿™èŠ‚æ•´ä¸ªæ™ºèƒ½åˆçº¦çš„HelloWorldã€‚ç›´æ¥ä¸Šåˆçº¦ä»£ç ï¼š</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">contract Mortal &#123;</span><br><span class="line">    <span class="comment">/* Define variable owner of the type address */</span></span><br><span class="line">    address owner;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This function is executed at initialization and sets the owner of the contract */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Mortal</span>(<span class="params"></span>) </span>&#123; owner = msg.sender; &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Function to recover the funds on the contract */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">kill</span>(<span class="params"></span>) </span>&#123; <span class="keyword">if</span> (msg.sender == owner) selfdestruct(owner); &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">contract Greeter is Mortal &#123;</span><br><span class="line">    <span class="comment">/* Define variable greeting of the type string */</span></span><br><span class="line">    string greeting;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* This runs when the contract is executed */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">Greeter</span>(<span class="params">string _greeting</span>) <span class="title">public</span> </span>&#123;</span><br><span class="line">        greeting = _greeting;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Main function */</span></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">greet</span>(<span class="params"></span>) <span class="title">constant</span> <span class="title">returns</span> (<span class="params">string</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> greeting;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆçº¦greeteræ˜¯ä¸€ä¸ªç®€å•çš„æ™ºèƒ½åˆçº¦ï¼Œä½ å¯ä»¥ä½¿ç”¨è¿™ä¸ªåˆçº¦æ¥å’Œå…¶ä»–äººäº¤æµï¼Œå®ƒçš„å›å¤ä¼šåŒä½ çš„è¾“å…¥å®Œå…¨ä¸€æ ·ï¼Œå½“è¾“å…¥ä¸ºâ€œHello World!â€çš„æ—¶å€™ï¼Œåˆçº¦ä¹Ÿä¼šå›å¤â€œHello World!â€ã€‚</p><p>å°†ä¸Šè¿°ä»£ç å†™å…¥greeter.solä¸­ã€‚</p><h3 id="ç¼–è¯‘æ™ºèƒ½åˆçº¦"><a href="#ç¼–è¯‘æ™ºèƒ½åˆçº¦" class="headerlink" title="ç¼–è¯‘æ™ºèƒ½åˆçº¦"></a>ç¼–è¯‘æ™ºèƒ½åˆçº¦</h3><p>ç¼–è¯‘æ™ºèƒ½åˆçº¦å¯ä»¥ä½¿ç”¨<a href="https://ethereum.github.io/browser-solidity">Browser-Solidity</a>åœ¨çº¿ç¼–è¯‘ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨solcå‘½ä»¤æœ¬åœ°ç¼–è¯‘ï¼Œæ­¤å¤„ä½¿ç”¨solcå‘½ä»¤æœ¬åœ°ç¼–è¯‘ã€‚<br>1ã€ç”Ÿæˆbytecode<br>æ‰§è¡Œ<code>solc --bin greeter.sol</code>ç”Ÿæˆcodeï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">======= greeter.sol:Greeter =======</span><br><span class="line">Binary:</span><br><span class="line">608060405234801561001057600080fd5b5060405161039b38038061039b83398101806040528101908080518201929190505050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508060019080519060200190610089929190610090565b5050610135565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100d157805160ff19168380011785556100ff565b828001600101855582156100ff579182015b828111156100fe5782518255916020019190600101906100e3565b5b50905061010c9190610110565b5090565b61013291905b8082111561012e576000816000905550600101610116565b5090565b90565b610257806101446000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806341c0e1b514610051578063cfae321714610068575b600080fd5b34801561005d57600080fd5b506100666100f8565b005b34801561007457600080fd5b5061007d610189565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100bd5780820151818401526020810190506100a2565b50505050905090810190601f1680156100ea5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610187576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b565b606060018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102215780601f106101f657610100808354040283529160200191610221565b820191906000526020600020905b81548152906001019060200180831161020457829003601f168201915b50505050509050905600a165627a7a723058203f4430a961037d5e7c4870ac4cc8f97d329171e862ae297fd0046255bec602490029</span><br><span class="line"></span><br><span class="line">======= greeter.sol:Mortal =======</span><br><span class="line">Binary:</span><br><span class="line">608060405234801561001057600080fd5b50336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550610114806100606000396000f300608060405260043610603f576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806341c0e1b5146044575b600080fd5b348015604f57600080fd5b5060566058565b005b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16141560e6576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b5600a165627a7a723058206554007d7824c95b6473134490ff9f84381627c8c29d43da39ce468e740abeda0029</span><br></pre></td></tr></table></figure><p>2ã€ç”ŸæˆABI<br>æ‰§è¡Œ<code>solc --abi greeter.sol</code>ç”ŸæˆABIï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">======= greeter.sol:Greeter =======</span><br><span class="line">Contract JSON ABI</span><br><span class="line">[&#123;<span class="string">&quot;constant&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;kill&quot;</span>,<span class="string">&quot;outputs&quot;</span>:[],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;function&quot;</span>&#125;,&#123;<span class="string">&quot;constant&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;greet&quot;</span>,<span class="string">&quot;outputs&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;string&quot;</span>&#125;],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;view&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;function&quot;</span>&#125;,&#123;<span class="string">&quot;inputs&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;_greeting&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;string&quot;</span>&#125;],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;constructor&quot;</span>&#125;]</span><br><span class="line"></span><br><span class="line">======= greeter.sol:Mortal =======</span><br><span class="line">Contract JSON ABI</span><br><span class="line">[&#123;<span class="string">&quot;constant&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;kill&quot;</span>,<span class="string">&quot;outputs&quot;</span>:[],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;function&quot;</span>&#125;,&#123;<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;constructor&quot;</span>&#125;]</span><br></pre></td></tr></table></figure><blockquote><p>ABI(Application Binary Interface)å…¶å®å°±æ˜¯ä¸€ä¸ªæœ‰åºçš„ç”¨æˆ·æ‰‹å†Œï¼Œæè¿°äº†æ‰€æœ‰æ–¹æ³•çš„åå­—å’Œå¦‚ä½•è°ƒç”¨å®ƒä»¬</p></blockquote><!-- solc --combined-json abi,bin sample.sol > sample.json --><h3 id="è®¾ç½®å¸Œæœ›è¿”å›çš„å­—ç¬¦ä¸²"><a href="#è®¾ç½®å¸Œæœ›è¿”å›çš„å­—ç¬¦ä¸²" class="headerlink" title="è®¾ç½®å¸Œæœ›è¿”å›çš„å­—ç¬¦ä¸²"></a>è®¾ç½®å¸Œæœ›è¿”å›çš„å­—ç¬¦ä¸²</h3><p>è¿›å…¥gethå‘½ä»¤è¡Œï¼Œæ‰§è¡Œ<code>var _greeting = &quot;Hello World!&quot;</code></p><h3 id="éƒ¨ç½²åˆçº¦"><a href="#éƒ¨ç½²åˆçº¦" class="headerlink" title="éƒ¨ç½²åˆçº¦"></a>éƒ¨ç½²åˆçº¦</h3><p>1ã€ç”¨ABIæ¥åˆ›å»ºä¸€ä¸ªjavascriptç¯å¢ƒä¸­çš„åˆçº¦å¯¹è±¡</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> greeterContract = web3.eth.contract([&#123;<span class="string">&quot;constant&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;kill&quot;</span>,<span class="string">&quot;outputs&quot;</span>:[],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;function&quot;</span>&#125;,&#123;<span class="string">&quot;constant&quot;</span>:<span class="literal">true</span>,<span class="string">&quot;inputs&quot;</span>:[],<span class="string">&quot;name&quot;</span>:<span class="string">&quot;greet&quot;</span>,<span class="string">&quot;outputs&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;string&quot;</span>&#125;],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;view&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;function&quot;</span>&#125;,&#123;<span class="string">&quot;inputs&quot;</span>:[&#123;<span class="string">&quot;name&quot;</span>:<span class="string">&quot;_greeting&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;string&quot;</span>&#125;],<span class="string">&quot;payable&quot;</span>:<span class="literal">false</span>,<span class="string">&quot;stateMutability&quot;</span>:<span class="string">&quot;nonpayable&quot;</span>,<span class="string">&quot;type&quot;</span>:<span class="string">&quot;constructor&quot;</span>&#125;]);</span><br></pre></td></tr></table></figure><p>2ã€é€šè¿‡åˆçº¦å¯¹è±¡æ¥éƒ¨ç½²åˆçº¦</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> greeter = greeterContract.new(</span><br><span class="line">   _greeting,</span><br><span class="line">   &#123;</span><br><span class="line">     <span class="attr">from</span>: web3.eth.accounts[<span class="number">0</span>],</span><br><span class="line">     <span class="attr">data</span>: <span class="string">&#x27;0x608060405234801561001057600080fd5b5060405161039b38038061039b83398101806040528101908080518201929190505050336000806101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff1602179055508060019080519060200190610089929190610090565b5050610135565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f106100d157805160ff19168380011785556100ff565b828001600101855582156100ff579182015b828111156100fe5782518255916020019190600101906100e3565b5b50905061010c9190610110565b5090565b61013291905b8082111561012e576000816000905550600101610116565b5090565b90565b610257806101446000396000f30060806040526004361061004c576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff16806341c0e1b514610051578063cfae321714610068575b600080fd5b34801561005d57600080fd5b506100666100f8565b005b34801561007457600080fd5b5061007d610189565b6040518080602001828103825283818151815260200191508051906020019080838360005b838110156100bd5780820151818401526020810190506100a2565b50505050905090810190601f1680156100ea5780820380516001836020036101000a031916815260200191505b509250505060405180910390f35b6000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff161415610187576000809054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16ff5b565b606060018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156102215780601f106101f657610100808354040283529160200191610221565b820191906000526020600020905b81548152906001019060200180831161020457829003601f168201915b50505050509050905600a165627a7a723058203f4430a961037d5e7c4870ac4cc8f97d329171e862ae297fd0046255bec602490029&#x27;</span>,</span><br><span class="line">     <span class="attr">gas</span>: <span class="string">&#x27;4700000&#x27;</span></span><br><span class="line">   &#125;, <span class="function"><span class="keyword">function</span> (<span class="params">e, contract</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(e, contract);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">typeof</span> contract.address !== <span class="string">&#x27;undefined&#x27;</span>) &#123;</span><br><span class="line">         <span class="built_in">console</span>.log(<span class="string">&#x27;Contract mined! address: &#x27;</span> + contract.address + <span class="string">&#x27; transactionHash: &#x27;</span> + contract.transactionHash);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;)</span><br></pre></td></tr></table></figure><h3 id="æŒ–çŸ¿-1"><a href="#æŒ–çŸ¿-1" class="headerlink" title="æŒ–çŸ¿"></a>æŒ–çŸ¿</h3><p>1ã€æ‰§è¡Œ<code>miner.start(1)</code>å¼€å¯æŒ–çŸ¿<br>2ã€æœ‰å—äº§ç”Ÿä¹‹åï¼Œæ‰§è¡Œ<code>miner.stop()</code>åœæ­¢æŒ–çŸ¿</p><h3 id="è¿è¡Œåˆçº¦"><a href="#è¿è¡Œåˆçº¦" class="headerlink" title="è¿è¡Œåˆçº¦"></a>è¿è¡Œåˆçº¦</h3><p>æ‰§è¡Œå‘½ä»¤<code>greeter.greet();</code>ï¼Œæ­£å¸¸å‘½ä»¤è¡Œä¸Šä¼šå‡ºç°å¦‚ä¸‹è¿”å›ç»“æœ:<code>Hello World!</code></p><p>OKï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€ä¸ªæ™ºèƒ½åˆçº¦ç¨‹åº â€œHello World!â€ å·²ç»å®Œæˆäº†,ä½†æ˜¯ç›®å‰å®ƒåªæœ‰ä¸€ä¸ªèŠ‚ç‚¹!</p><h3 id="éƒ¨ç½²åœ¨å…¶å®ƒèŠ‚ç‚¹"><a href="#éƒ¨ç½²åœ¨å…¶å®ƒèŠ‚ç‚¹" class="headerlink" title="éƒ¨ç½²åœ¨å…¶å®ƒèŠ‚ç‚¹"></a>éƒ¨ç½²åœ¨å…¶å®ƒèŠ‚ç‚¹</h3><p>ä¸ºäº†ä½¿å¾—å…¶ä»–äººå¯ä»¥è¿è¡Œä½ çš„æ™ºèƒ½åˆçº¦ï¼Œä½ éœ€è¦ä¸¤ä¸ªä¿¡æ¯ï¼š</p><ol><li>æ™ºèƒ½åˆçº¦åœ°å€Address</li><li>æ™ºèƒ½åˆçº¦ABI</li></ol><p>ABIåœ¨ä¸Šæ–‡ä¸­å·²å¾—åˆ°ï¼Œæ™ºèƒ½åˆçº¦çš„åœ°å€å¯ä»¥æ‰§è¡Œ<code>greeter.address</code>å¾—åˆ°ã€‚</p><p>ç„¶åä½ å¯ä»¥å®ä¾‹åŒ–ä¸€ä¸ªJavaScriptå¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥ç”¨æ¥åœ¨ä»»æ„è”ç½‘æœºå™¨ä¸Šè°ƒç”¨è¯¥åˆçº¦ï¼Œæ­¤å¤„ABIå’ŒAddressæ˜¯ä¸Šè¿°ä»£ç è¿”å›å€¼ã€‚<br><code>var greeter = eth.contract(ABI).at(Address);</code></p><h3 id="è‡ªæ¯ç¨‹åº"><a href="#è‡ªæ¯ç¨‹åº" class="headerlink" title="è‡ªæ¯ç¨‹åº"></a>è‡ªæ¯ç¨‹åº</h3><p>ä¸€ä¸ªäº¤æ˜“éœ€è¦è¢«å‘é€åˆ°ç½‘ç»œéœ€è¦æ”¯ä»˜è´¹ç”¨ï¼Œè‡ªæ¯ç¨‹åºæ˜¯å¯¹ç½‘ç»œçš„è¡¥å……ï¼ŒèŠ±è´¹çš„è´¹ç”¨è¿œå°äºä¸€æ¬¡å¸¸ç”¨äº¤æ˜“ã€‚<br>ä½ å¯ä»¥é€šè¿‡ä»¥ä¸‹ä»£ç æ¥æ£€éªŒæ˜¯å¦æˆåŠŸï¼Œå¦‚æœè‡ªæ¯ç¨‹åºè¿è¡ŒæˆåŠŸä»¥ä¸‹ä»£ç ä¼šè¿”å›0ï¼š<br><code>greeter.kill.sendTransaction(&#123;from:eth.accounts[0]&#125;)</code></p><p>æˆ‘æ‰§è¡Œå®Œä¸Šè¿°å‘½ä»¤è¿”å›çš„è²Œä¼¼æ˜¯ä¸€ä¸ªåœ°å€ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; greeter.kill.sendTransaction(&#123;from:eth.accounts[0]&#125;)</span><br><span class="line"><span class="string">&quot;0x117d2066fae468a16077286573b0e3470b20e9ac5bb87291f7733dd453027441&quot;</span></span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å†æ¬¡æ‰§è¡Œ<code>greeter.greet();</code>ä¾ç„¶èƒ½è¿”å›<code>Hello World!</code>ï¼Œæˆ‘å†æ¬¡å¼€å¯æŒ–çŸ¿ï¼Œä¸€æ®µæ—¶é—´ååœæ­¢æŒ–çŸ¿ï¼Œå†æ‰§è¡Œ<code>greeter.greet();</code>ï¼ŒæŠ¥é”™</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&gt; greeter.greet()</span><br><span class="line"><span class="attr">Error</span>: <span class="keyword">new</span> BigNumber() not a base <span class="number">16</span> number:</span><br><span class="line">    at L (bignumber.js:<span class="number">3</span>:<span class="number">2876</span>)</span><br><span class="line">    at bignumber.js:<span class="number">3</span>:<span class="number">8435</span></span><br><span class="line">    at a (bignumber.js:<span class="number">3</span>:<span class="number">389</span>)</span><br><span class="line">    at web3.js:<span class="number">1110</span>:<span class="number">23</span></span><br><span class="line">    at web3.js:<span class="number">1634</span>:<span class="number">20</span></span><br><span class="line">    at web3.js:<span class="number">826</span>:<span class="number">16</span></span><br><span class="line">    at map (<span class="xml"><span class="tag">&lt;<span class="name">native</span> <span class="attr">code</span>&gt;</span>)</span></span><br><span class="line"><span class="xml">    at web3.js:825:12</span></span><br><span class="line"><span class="xml">    at web3.js:4080:18</span></span><br></pre></td></tr></table></figure><!--##æ˜¯å¦è®¾ç½®mineråœ°å€å¯åŠ¨èŠ‚ç‚¹æŒ–çŸ¿ä¹‹å‰ï¼Œéœ€è¦æŸ¥çœ‹å½“å‰èŠ‚ç‚¹ä¸­æ˜¯å¦å·²ç»å­˜åœ¨è´¦å·ï¼Œå¯æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å½“å‰èŠ‚ç‚¹ä¸‹é¢æ˜¯å¦æœ‰è´¦å·å­˜åœ¨ã€‚>personal.listAccounts["0xc040cbd8a189d36f580fa83c2ffe3a26fb3e6a7e", "0xe0d1de6c934049fe4847b64becff5885bdb83fa4"]å½“ç¡®è®¤è´¦æˆ·å·²ç»å­˜åœ¨æ—¶ï¼Œå¯ä»¥è®¾ç½®Etherbaseã€‚å…ˆæŸ¥çœ‹ä»¥ä¸‹coinbaseè´¦æˆ·ï¼š>eth.coinbase"0xc040cbd8a189d36f580fa83c2ffe3a26fb3e6a7e"é€šè¿‡ä¸Šé¢çš„å‘½ä»¤ï¼Œå¯ä»¥çœ‹åˆ°coinbaseçš„è´¦æˆ·åœ°å€ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æŸ¥çœ‹åœ°å€æŸ¥åˆ°ç¬¬ä¸€ä¸ªåœ°å€ã€‚æ‰§è¡Œè®¾ç½®mineråœ°å€ï¼š>miner.setEtherbase(eth.coinbase)trueä¹Ÿå¯ä»¥æ‰§è¡Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤è¿›è¡Œè®¾ç½®ï¼š>miner.setEtherbase(eth.accounts[0])trueç„¶åï¼Œå¯ä»¥å†æ‰§è¡ŒæŒ–çŸ¿å‘½ä»¤ï¼ŒæŸ¥çœ‹æ˜¯å¦é—®é¢˜æ˜¯å¦è§£å†³ã€‚èŠ‚ç‚¹è¯¯æŠ¥å¦å¤–ä¸€ç§æƒ…å†µå°±æ˜¯å…¶å®miner.start()å‘½ä»¤å·²ç»æ‰§è¡ŒæˆåŠŸï¼Œåªä¸è¿‡èŠ‚ç‚¹è¿”å›nullã€‚å¦‚æœæ˜¯devæ¨¡å¼ï¼Œå¯ä»¥ä½¿ç”¨eth.blockNumberæŸ¥çœ‹ä¸€ä¸‹åŒºå—é«˜åº¦æ˜¯å¦å¢åŠ ã€‚èŠ‚ç‚¹ç‰ˆæœ¬é—®é¢˜æœ¬äººå®‰è£…çš„geth-1.7.3ç‰ˆæœ¬çš„èŠ‚ç‚¹ï¼Œåœ¨devç¯å¢ƒä¸‹éªŒè¯å‘ç°ï¼Œå½“æ‰§è¡Œminer.start()æ—¶ï¼Œè¿”å›nullã€‚ä½†å…¶å®minerå·²ç»æ‰§è¡Œï¼Œåªä¸è¿‡å®ƒåœ¨ç­‰å¾…ä½ å‘é€äº¤æ˜“ä¹‹åæ‰ä¼šç”Ÿæˆæ–°çš„åŒºå—ã€‚ä¹Ÿå°±æ˜¯è¯´æ‰§è¡Œäº†miner.start(),å®ƒä¸€ç›´åœ¨ç­‰å¾…ï¼Œè¿™æ˜¯å‘é€ä¸€ç¬”äº¤æ˜“ï¼Œå†æŸ¥çœ‹åŒºå—é«˜åº¦å‘ç°å·²ç»å¢åŠ ä¸€å—ã€‚-->]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> Ethereum </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hadoop getå‘½ä»¤è¿”å›NullPointerException</title>
      <link href="/Hadoop_get_NullPointerException.html"/>
      <url>/Hadoop_get_NullPointerException.html</url>
      
        <content type="html"><![CDATA[<p>æ˜¨å¤©Hadoopçš„getå‘½ä»¤çªç„¶æ— æ³•ä½¿ç”¨ï¼Œè¿”å›NullPointerExceptionå¼‚å¸¸ï¼Œæ— æ³•ä»hdfs pullæ•°æ®ï¼Œå…¶å®ƒå‘½ä»¤æ­£å¸¸ï¼Œå¹¶ä¸”æœ€è¿‘ä¹Ÿæ— ä»»åŠ¡ä¿®æ”¹é…ç½®çš„æ“ä½œã€‚<br>è¿™ä¸‹æ‰æ€¥äº†ï¼Œæ‰æ€¥ä¹Ÿæ²¡ç”¨ï¼Œè¿˜æ˜¯æ»šå›å»çœ‹æ—¥å¿—å§ï¼Œåœ¨æ—¥å¿—ä¸­ä¹Ÿæ²¡å‘ç°ä»€ä¹ˆå…·ä½“çš„æŠ¥é”™ä¿¡æ¯ï¼Œåªå‘ç°NNçš„çŠ¶æ€å‘ç”Ÿäº†å˜åŒ–ï¼Œå˜æˆäº†standbyã€‚<br>ä½†æŒ‰ç…§ä»¥å¾€çš„ç»éªŒNNåˆ‡æ¢å¹¶ä¸ä¼šå¯¼è‡´Hadoopç›¸å…³å‘½ä»¤è¿”å›ç©ºæŒ‡é’ˆå¼‚å¸¸ï¼Œéš¾é“æ˜¯å½“åˆé…ç½®æœ‰ä»€ä¹ˆé—®é¢˜ï¼Ÿ<br>å…ˆæŠŠNNåˆ‡å›æ¥å§ï¼Œå…ˆä¿è¯çº¿ä¸Šä»»åŠ¡æ­£å¸¸è¿è¡Œå§ã€‚åˆ‡å›å›æ¥ä¹‹åä¸€åˆ‡æ­£å¸¸ï¼Œå‰©ä¸‹ä¸€è„¸æ‡µé€¼çš„æˆ‘ã€‚ã€‚ã€‚ã€‚</p><span id="more"></span><p>å…ˆè´´ä¸‹å¼‚å¸¸ç°è±¡ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">$ hadoop dfs -get /<span class="built_in">test</span>/test_1527672887521.sh .</span><br><span class="line">DEPRECATED: Use of this script to execute hdfs <span class="built_in">command</span> is deprecated.</span><br><span class="line">Instead use the hdfs <span class="built_in">command</span> <span class="keyword">for</span> it.</span><br><span class="line"></span><br><span class="line">get: java.lang.NullPointerException</span><br></pre></td></tr></table></figure><blockquote><p>é—®é¢˜æ¢å¤äº†ï¼Œé‚£å°±æ˜¯æ‰¾åˆ°é—®é¢˜çš„åŸå› ï¼Œè€Œå½»åº•è§£å†³åˆ°é—®é¢˜ã€‚é‚£å°±å¼€å§‹æå§ã€‚</p></blockquote><ol><li>é¦–å…ˆåœ¨æµ‹è¯•ç¯å¢ƒæµ‹è¯•ä¸‹NNåˆ‡æ¢ï¼Œä¼šä¸ä¼šå¯¼è‡´getå‘½ä»¤è¿”å›NullPointerExceptionï¼Œæ­¤é—®é¢˜æ²¡æœ‰åœ¨æµ‹è¯•ç¯å¢ƒå¤ç°ã€‚</li><li>æŠŠNN1ä¸Šçš„HadoopåŒ…æ‰“åŒ…é‡æ–°æ­å»ºäº†ä¸€å¥—Hadoopç¯å¢ƒï¼Œè¿›è¡Œæµ‹è¯•ï¼Œé—®é¢˜ä¾ç„¶æ²¡æœ‰å¤ç°</li><li>æŠŠçº¿ä¸ŠNNé‡å¯ä¹‹åï¼Œå†æ¬¡æ‰‹åŠ¨è§¦å‘åˆ‡æ¢ï¼Œä½¿ç”¨getå‘½ä»¤ä¾ç„¶è¿”å›NullPointerException</li><li>æŸ¥çœ‹ä¸‹NN2çš„log(<strong>ç»ˆäºæƒ³èµ·NN2çš„logäº†</strong>)ï¼Œå®šä½åˆ°å‘ç”Ÿæ•…éšœçš„æ—¶é—´ç‚¹ï¼Œæœä¸‹NullPointerExceptionï¼Œå‘ç°æŠ¥é”™ä¿¡æ¯ï¼Œå¦‚ä¸‹ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">18/07/31 11:53:32 WARN net.ScriptBasedMapping: Exception running <span class="variable">$&#123;HADOOP_HOME&#125;</span>/etc/hadoop/rack_awareness.py 127.0.0.1</span><br><span class="line">java.io.IOException: Cannot run program <span class="string">&quot;<span class="variable">$&#123;HADOOP_HOME&#125;</span>/etc/hadoop/rack_awareness.py&quot;</span> (<span class="keyword">in</span> directory <span class="string">&quot;<span class="variable">$&#123;HADOOP_HOME&#125;</span>&quot;</span>): error=13, Permission denied</span><br><span class="line">        at java.lang.ProcessBuilder.start(ProcessBuilder.java:1048)</span><br><span class="line">        at org.apache.hadoop.util.Shell.runCommand(Shell.java:526)</span><br><span class="line">        at org.apache.hadoop.util.Shell.run(Shell.java:482)</span><br><span class="line">        at org.apache.hadoop.util.Shell<span class="variable">$ShellCommandExecutor</span>.execute(Shell.java:776)</span><br><span class="line">        at org.apache.hadoop.net.ScriptBasedMapping<span class="variable">$RawScriptBasedMapping</span>.runResolveCommand(ScriptBasedMapping.java:251)</span><br><span class="line">        at org.apache.hadoop.net.ScriptBasedMapping<span class="variable">$RawScriptBasedMapping</span>.resolve(ScriptBasedMapping.java:188)</span><br><span class="line">        at org.apache.hadoop.net.CachedDNSToSwitchMapping.resolve(CachedDNSToSwitchMapping.java:119)</span><br><span class="line">        at org.apache.hadoop.hdfs.server.blockmanagement.DatanodeManager.resolveNetworkLocation(DatanodeManager.java:751)</span><br><span class="line">        at org.apache.hadoop.hdfs.server.blockmanagement.DatanodeManager.resolveNetworkLocation(DatanodeManager.java:731)</span><br><span class="line">        at org.apache.hadoop.hdfs.server.blockmanagement.DatanodeManager.resolveNetworkLocationWithFallBackToDefaultLocation(DatanodeManager.java:705)</span><br><span class="line">        at org.apache.hadoop.hdfs.server.blockmanagement.DatanodeManager.registerDatanode(DatanodeManager.java:958)</span><br><span class="line">        at org.apache.hadoop.hdfs.server.namenode.FSNamesystem.registerDatanode(FSNamesystem.java:4481)</span><br><span class="line">        at org.apache.hadoop.hdfs.server.namenode.NameNodeRpcServer.registerDatanode(NameNodeRpcServer.java:1286)</span><br><span class="line">        at org.apache.hadoop.hdfs.protocolPB.DatanodeProtocolServerSideTranslatorPB.registerDatanode(DatanodeProtocolServerSideTranslatorPB.java:96)</span><br><span class="line">        at org.apache.hadoop.hdfs.protocol.proto.DatanodeProtocolProtos$DatanodeProtocolService<span class="variable">$2</span>.callBlockingMethod(DatanodeProtocolProtos.java:28752)</span><br><span class="line">        at org.apache.hadoop.ipc.ProtobufRpcEngine$Server<span class="variable">$ProtoBufRpcInvoker</span>.call(ProtobufRpcEngine.java:616)</span><br><span class="line">        at org.apache.hadoop.ipc.RPC<span class="variable">$Server</span>.call(RPC.java:982)</span><br><span class="line">        at org.apache.hadoop.ipc.Server$Handler<span class="variable">$1</span>.run(Server.java:2217)</span><br><span class="line">        at org.apache.hadoop.ipc.Server$Handler<span class="variable">$1</span>.run(Server.java:2213)</span><br><span class="line">        at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">        at javax.security.auth.Subject.doAs(Subject.java:422)</span><br><span class="line">        at org.apache.hadoop.security.UserGroupInformation.doAs(UserGroupInformation.java:1754)</span><br><span class="line">        at org.apache.hadoop.ipc.Server<span class="variable">$Handler</span>.run(Server.java:2213)</span><br><span class="line">Caused by: java.io.IOException: error=13, Permission denied</span><br><span class="line">        at java.lang.UNIXProcess.forkAndExec(Native Method)</span><br><span class="line">        at java.lang.UNIXProcess.&lt;init&gt;(UNIXProcess.java:247)</span><br><span class="line">        at java.lang.ProcessImpl.start(ProcessImpl.java:134)</span><br><span class="line">        at java.lang.ProcessBuilder.start(ProcessBuilder.java:1029)</span><br><span class="line">        ... 22 more</span><br><span class="line">18/07/31 11:53:32 ERROR blockmanagement.DatanodeManager: The resolve call returned null!</span><br><span class="line">18/07/31 11:53:32 ERROR blockmanagement.DatanodeManager: Unresolved topology mapping. Using /default-rack <span class="keyword">for</span> host 127.0.0.1</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯å¾ˆæ¸…æ™°ï¼Œæœ‰æ²¡æœ‰</p><p>åŸæ¥æ˜¯NN2ä¸Šçš„æœºå™¨æ„ŸçŸ¥è„šæœ¬æ²¡æœ‰æ‰§è¡Œæƒé™ï¼ŒåŠ ä¸Šå¯æ‰§è¡Œæƒé™ä¹‹åï¼ŒNNåˆ‡æ¢ä¹‹åä¸€åˆ‡å‘½ä»¤æ­£å¸¸ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> get </tag>
            
            <tag> NullPointerException </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Dockerè¿›ç¨‹logå’Œåº”ç”¨logé‡‡é›†è°ƒç ”</title>
      <link href="/Docker_log_collect.html"/>
      <url>/Docker_log_collect.html</url>
      
        <content type="html"><![CDATA[<p>Dockerå®¹å™¨åŒ–å·²æ˜¯ä¸€ä¸ªç›¸å¯¹æˆç†Ÿçš„ç†å¿µï¼Œä½†æ˜¯åœ¨å®é™…ä½¿ç”¨ä¸­è¿˜æ˜¯æœ‰å¾ˆå¤šæŒ‘æˆ˜ï¼Œç›®å‰æˆ‘ä»¬é‡åˆ°çš„ä¸€ä¸ªé—®é¢˜æ˜¯<strong>Dockerä¸­çš„logå¦‚ä½•é‡‡é›†</strong>ã€‚<br>è¿™äº›logåŒ…æ‹¬Dockerå®¹å™¨è¿›ç¨‹æœ¬èº«çš„logå’Œå®¹å™¨å†…è¿è¡Œåº”ç”¨çš„ä¸šåŠ¡logï¼Œä¸¤ä»½logéƒ½æ¯”è¾ƒé‡è¦ï¼Œå°¤å…¶ä¸šåŠ¡logï¼Œå› ä¸ºä¸€äº›åŸ‹ç‚¹æ•°æ®å’Œç»Ÿè®¡æŒ‡æ ‡éƒ½åœ¨ä¸šåŠ¡logä¸­ä¹ŸåŒ…æ‹¬ä¸€äº›ç¨‹åºå¼‚å¸¸logã€‚</p><span id="more"></span><p>é’ˆå¯¹è¿™äº›logé‡‡é›†ï¼Œæˆ‘ä»¬é¢å¯¹çš„ä¸€äº›é—®é¢˜æœ‰ï¼š</p><ol><li>å®¹å™¨æ ‡å‡†è¾“å‡ºæ—¥å¿—é‡‡é›†</li><li>å®¹å™¨å†…ä¸šåŠ¡logé‡‡é›† (æ˜¯å¦è¦æ”¯æŒåŒæ—¶é‡‡é›†å¤šä¸ªæ–‡ä»¶æˆ–å¤šä¸ªä¸šåŠ¡log)</li><li>æ–­ç‚¹ç»­ä¼ </li><li>å¼‚å¸¸æ—¥å¿—åˆå¹¶ä¸æ‹¼æ¥ (è¦æƒ³åˆå¹¶å¼‚å¸¸æ—¥å¿—ï¼Œåˆ™æ—¥å¿—å¿…é¡»<em>æ ‡å‡†åŒ–</em>)</li><li>æ—¥å¿—é‡‡é›†çš„å®Œæ•´æ€§</li><li>æ—¥å¿—ä¹±åº</li><li>ä»æ—¥å¿—ä¸­åŒºåˆ†æ¥æº</li><li>æ”¯æŒçƒ­æ’æ‹”</li><li>å¯¹ä¸šåŠ¡çš„ä¾µå…¥æ€§</li><li>æ•…éšœé‡ä¼ </li></ol><blockquote><p>ç›®å‰ä¸»æµä¸¤ç§æ–¹æ¡ˆï¼Œä¸€ç§æ˜¯logåœ¨å®¹å™¨å†…é€šè¿‡é‡‡é›†å·¥å…·ç›´æ¥ä¼ è¾“ç»™logèšåˆæœåŠ¡ï¼Œå¦ä¸€ç§æ˜¯å°†å®¹å™¨å†…çš„logä¼ è¾“åˆ°å®¿ä¸»æœºï¼Œç„¶åå†é€šè¿‡æ—¥å¿—é‡‡é›†å·¥å…·è¿›è¡Œé‡‡é›†ã€‚</p></blockquote><h2 id="æ–¹æ¡ˆ1"><a href="#æ–¹æ¡ˆ1" class="headerlink" title="æ–¹æ¡ˆ1"></a>æ–¹æ¡ˆ1</h2><p>åœ¨å®¹å™¨å†…ç›´æ¥å°†logä¼ è¾“ç»™logèšåˆæœåŠ¡ï¼Œå¯ä»¥é€šè¿‡ä¸šåŠ¡æ–¹è°ƒæ•´ä¸šåŠ¡é€»è¾‘å°†æ—¥å¿—ç›´æ¥æ‰“å…¥kafkaæˆ–è€…redisç­‰ç¼“å­˜ç»„ä»¶ä¸­ï¼Œè¿™ç§æ–¹å¼å¯¹ä¸šåŠ¡ä¾µå…¥æ€§è¾ƒå¤§ï¼Œæ— æ³•åšåˆ°å¯¹ä¸šåŠ¡æ— æ„ŸçŸ¥ï¼Œä¹Ÿæ— æ³•è§£å†³dockerå®¹å™¨æœ¬èº«çš„logä¼ è¾“ã€‚<br>åœ¨å®¹å™¨å†…ç›´æ¥å°†logä¼ è¾“ç»™logèšåˆæœåŠ¡ä¹Ÿå¯ä»¥åšåˆ°å¯¹ä¸šåŠ¡æ— æ„ŸçŸ¥ï¼Œé‚£å°±æ˜¯åœ¨å®¹å™¨ä¸­éƒ¨ç½²ä¸€ä¸ªæ—¥å¿—é‡‡é›†æœåŠ¡ï¼Œå¦‚flumeï¼Œé€šè¿‡flumeå°†logé‡‡é›†åˆ°kafkaï¼Œè¿™æ ·è²Œä¼¼ç»“æœäº†é—®é¢˜ï¼Œå¯¹ä¸šåŠ¡æ— æ„ŸçŸ¥ï¼Œè€Œä¸”flumeåœ¨æ—¥å¿—é‡‡é›†é¢†åŸŸä¹Ÿæ¯”è¾ƒæˆç†Ÿã€‚<br>è¿™ç§æ–¹æ¡ˆçœ‹ä¼¼åˆç†ï¼Œä½†æ˜¯è¿™ç§æ–¹æ¡ˆä¾ç„¶ä¸ç¬¦åˆä¸Šç”Ÿäº§çš„æ¡ä»¶ã€‚å› ä¸ºå®¹å™¨çš„å¯åŠ¨å’Œåœæ­¢æ˜¯ä¸€ä¸ªå¸¸æ€ï¼Œå®¹å™¨åœ¨åœæ­¢ä¹‹åï¼Œå®¹å™¨å†…çš„logä¹Ÿå°†éšä¹‹æ¶ˆå¤±ï¼Œé‚£å°±å­˜åœ¨flumeé‡‡é›†æ—¥å¿—ä¸å®Œæ•´ï¼Œæˆ–è€…ç”±äºkafkaç­‰å—ç½‘ç»œæˆ–è€…å…¶å®ƒåŸå› å¯¼è‡´æ•°æ®æ²¡æœ‰å†™å…¥æˆåŠŸï¼Œè¿™å°±é€ æˆlogä¸¢å¤±ï¼Œè€Œä¸”è¿™ç§ä¸¢å¤±è¿˜æ˜¯æ°¸ä¹…æ€§çš„ä¸¢å¤±ï¼Œæ— æ³•è¿½å›çš„ä¸¢å¤±ï¼Œè¿™å¯¹ä¸€äº›æŒ‡æ ‡çš„ç»Ÿè®¡æ˜¯ä¸å…è®¸çš„ã€‚</p><h2 id="æ–¹æ¡ˆ2"><a href="#æ–¹æ¡ˆ2" class="headerlink" title="æ–¹æ¡ˆ2"></a>æ–¹æ¡ˆ2</h2><p>é’ˆå¯¹æ–¹æ¡ˆ1ä¸­çš„ç—›ç‚¹<em>é‡‡é›†ä¸å®Œæ•´æ•°æ®æ°¸ä¹…ä¸¢å¤±</em>å’Œ<em>ä¾èµ–kafkaç­‰æœåŠ¡çš„ç¨³å®šæ€§</em>ï¼Œæå‡ºæ˜¯å¦å¯ä»¥å°†å®¹å™¨ä¸­çš„logè½åœ°åˆ°å®¿ä¸»ç£ç›˜ï¼Œå®¹å™¨ä¸å®¿ä¸»ä¹‹é—´çš„ç½‘ç»œå»¶è¿Ÿå¯ä»¥å¿½ç•¥ä¹Ÿä¸ä¼šå—å¤–ç•Œç½‘ç»œçš„å½±å“ï¼Œè¿™æ ·åç»­æµç¨‹å°±è·Ÿä¼ ç»Ÿçš„æ—¥å¿—é‡‡é›†æœåŠ¡ä¸€æ ·äº†ã€‚</p><p>æœ‰äº†æ–¹å‘æŸ¥é˜…èµ„æ–™å°±æ–¹ä¾¿å¾ˆå¤šï¼Œé˜¿é‡Œå¼€æºäº†ä¸€æ¬¾æ—¥å¿—é‡‡é›†å·¥å…·<a href="https://github.com/AliyunContainerService/log-pilot/?spm=a2c4e.11153940.blogcont69382.19.65b278fcpbOK9h">log-pilot</a>ï¼Œæ­¤å·¥å…·æ”¯æŒå®¹å™¨æ ‡å‡†è¾“å‡ºå’Œä¸šåŠ¡logæ–‡ä»¶é‡‡é›†ï¼Œè¿˜å¯ä»¥è¡¨è¯†logæ¥æºï¼Œæ–¹ä¾¿åç»­å¯¹æ—¥å¿—è¿›è¡Œå½’æ¡£ã€‚</p><p>dockerå®¹å™¨æ—¥å¿—è¾“å‡ºçš„å·¥å…·å¾ˆå¤šï¼Œè€Œä¸”dockeræœ¬èº«ä¹Ÿæœ‰ä¸€äº›åŠŸèƒ½å¯ä»¥å®ç°ï¼Œå¦‚log driverï¼Œä½†æ˜¯è¿™äº›åªèƒ½å°†dockerå®¹å™¨çš„æ ‡å‡†è¾“å‡ºä¸é”™è¯¯è¾“å‡ºé‡‡é›†åˆ°å®¿ä¸»æœºä¸Šï¼Œè€Œæ— æ³•å°†ä¸šåŠ¡logæ–‡ä»¶ä¸­çš„å†…å®¹ä¹Ÿé‡‡é›†åˆ°å®¿ä¸»æœºï¼Œå¦‚æœéè¦ç”¨log driverä¹‹ç±»çš„å·¥å…·å°±å¾—è®©ä¸šåŠ¡æ–¹æ›´æ”¹logçš„è§„åˆ™ï¼Œè¿™æ ·å°±å¯¹ä¸šåŠ¡æœ‰ä¾µå…¥äº†ï¼Œæ‰€ä»¥æ„Ÿè§‰log-pilotè¿˜æ˜¯æ¯”è¾ƒç¬¦åˆé¢„æœŸçš„ï¼Œè™½ç„¶ä¸æ˜¯å¤ªå®Œç¾ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå®šåˆ¶å¼€å‘ã€‚</p><p>log-pilotæœ€ä¸»è¦çš„ä¸€ä¸ªå®šåˆ¶åŠŸèƒ½å°±æ˜¯å¯ä»¥æ”¯æŒ<strong>æ–­ç‚¹ç»­ä¼ </strong>å’Œ<strong>HA</strong>ï¼Œå…·ä½“çš„åŠŸèƒ½è¿˜éœ€è¿›ä¸€æ­¥çš„æµ‹è¯•ä½¿ç”¨ã€‚</p><p>å¯¹äº<em>å¼‚å¸¸æ—¥å¿—åˆå¹¶ä¸æ‹¼æ¥</em>çš„åŠŸèƒ½å¯ä»¥é€šè¿‡æ›´æ”¹flumeçš„sourceä»£ç å®ç°ï¼Œå› ä¸ºlog-pilotæ˜¯é¡ºåºçš„è¯»å–ä¸šåŠ¡logå¹¶ä¸”é¡ºåºçš„å†™å…¥å®¿ä¸»ç£ç›˜çš„æŸä¸ªæ–‡ä»¶ä¸­ï¼Œä¸ä¼šå‡ºç°ä¹±åºï¼Œæ‰€ä»¥æˆ‘ä»¬æŠŠæ—¥å¿—åˆå¹¶æ”¾åœ¨flumeç«¯è¿›è¡Œå¤„ç†ã€‚</p><h3 id="å­˜åœ¨çš„éšæ‚£"><a href="#å­˜åœ¨çš„éšæ‚£" class="headerlink" title="å­˜åœ¨çš„éšæ‚£"></a>å­˜åœ¨çš„éšæ‚£</h3><ol><li>flumeå¯¹é…ç½®æ–‡ä»¶çš„æ›´æ–°åœ¨å¤§æ•°æ®é‡çš„æƒ…å†µä¸‹ä¼šæ›´æ–°å¼‚å¸¸ï¼Œè¦å¯¹å…¶è¿›è¡Œè°ƒä¼˜</li><li>log-pilotæ–­ç‚¹ç»­ä¼ ä¸è¿Ÿå»¶</li><li>log-pilotéƒ¨ç½²æ–¹å¼ï¼Œdockerå®¹å™¨å†…è¿˜æ˜¯å®¿ä¸»æœº</li></ol>]]></content>
      
      
      <categories>
          
          <category> Docker </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Docker </tag>
            
            <tag> log </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>shellåµŒå¥—å˜é‡</title>
      <link href="/shell%E5%B5%8C%E5%A5%97%E5%8F%98%E9%87%8F.html"/>
      <url>/shell%E5%B5%8C%E5%A5%97%E5%8F%98%E9%87%8F.html</url>
      
        <content type="html"><![CDATA[<p>ä»Šå¤©åœ¨æ‰¹é‡ç”Ÿæˆå‘½ä»¤çš„æ—¶å€™ï¼Œéœ€è¦ä½¿ç”¨ä¸€ä¸ªç±»ä¼¼åµŒå¥—å˜é‡çš„ä¸œè¥¿ï¼Œ(æ³¨æ„è¿™ä¸ªåµŒå¥—å˜é‡ï¼Œä¸€å¼€å§‹å¹¶ä¸çŸ¥é“shellä¸­æœ‰è¿™ä¸ªä¸œä¸œ)</p><p>å…·ä½“åœºæ™¯æ˜¯è¿™æ ·çš„ï¼š</p><span id="more"></span><p>æœ‰ä¸€å †å‘½åæ¯”è¾ƒè§„åˆ™çš„å˜é‡ï¼Œä¾‹å¦‚conf_1ã€conf_2ã€conf_3â€¦<br>è¿™äº›å˜é‡éœ€è¦åœ¨ä¸€ä¸ªå¾ªç¯ä¸­æ ¹æ®å¾ªç¯çš„æ¬¡æ•°è¾“å‡ºï¼Œä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">conf_1=<span class="string">&#x27;conf1&#x27;</span></span><br><span class="line">conf_2=<span class="string">&#x27;conf2&#x27;</span></span><br><span class="line">conf_3=<span class="string">&#x27;conf3&#x27;</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..3&#125;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="comment"># æƒ³è¦çš„æ•ˆæœæ˜¯å½“i=1æ—¶ï¼Œecho $conf_1</span></span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$&#123;conf_<span class="variable">$&#123;i&#125;</span>&#125;</span></span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç ä¼šæŠ¥è¯­æ³•é”™è¯¯ã€‚</p><p>äºæ˜¯å°±å°´å°¬äº†ï¼Œè¿™è¦æ€ä¹ˆæï¼Œç¡¬ç¼–ç ï¼Ÿè¿™ä¸ç¬¦åˆå‰äººçš„æ€ç»´å‘€ï¼Œäºæ˜¯googleä¹‹ã€‚</p><p>æ—¢ç„¶è¦googleå°±è¦ç»™äººå®¶ä¸€ä¸ªå…³é”®è¯ï¼Œè¿™çœ‹æ•ˆæœæ˜¯å˜é‡é‡ŒåµŒå¥—äº†å˜é‡ï¼Œé‚£å…³é”®å­—å°±æ˜¯<code>åµŒå¥—å˜é‡</code>å§ã€‚<br>æœç„¶é¡ºåˆ©æœå‡ºç»“æœã€‚demoå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">title3=<span class="string">&#x27;æŸ¥æ‰¾å›ºä»¶ä¸­çš„â¼ä»¤â½‚ä»¶&#x27;</span></span><br><span class="line">i=3</span><br><span class="line">title=title<span class="variable">$&#123;i&#125;</span></span><br><span class="line"><span class="built_in">eval</span> temp=$(<span class="built_in">echo</span> \$<span class="variable">$title</span>)</span><br><span class="line"><span class="built_in">echo</span> <span class="variable">$temp</span></span><br></pre></td></tr></table></figure><p>é¡ºåˆ©ç»“æœé—®é¢˜ã€‚ã€‚ã€‚</p><p>æœçœŸæ˜¯åªæœ‰ä½ æƒ³ä¸åˆ°çš„ï¼Œæ²¡æœ‰å‰äººå®ç°ä¸äº†çš„ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://blog.csdn.net/u010801696/article/details/78847873">https://blog.csdn.net/u010801696/article/details/78847873</a></p>]]></content>
      
      
      <categories>
          
          <category> Tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
            <tag> Shell </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Ubuntuæ­å»ºBitcoinæºç é˜…è¯»ç¯å¢ƒ</title>
      <link href="/bitcoin%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83.html"/>
      <url>/bitcoin%E6%BA%90%E7%A0%81%E7%8E%AF%E5%A2%83.html</url>
      
        <content type="html"><![CDATA[<p>è¿™æ˜¯åŒºå—é“¾ç³»åˆ—çš„å¼€ç¯‡æ–‡ç« ï¼Œéšåä¼šé™†ç»­å†™ä¸€äº›blogã€‚<br>çœ‹äº†ä¸¤æœ¬åŒºå—é“¾çš„ä¹¦ï¼Œæœ‰äº†ä¸€äº›åˆæ­¥çš„äº†è§£ï¼Œæœ€è¿‘æ‰“ç®—å®è·µä¸‹ï¼Œå°±æƒ³ç€å…ˆå¼„ä¸ªè¯»ä»£ç çš„ç¯å¢ƒï¼Œæœ¬ä»¥ä¸ºæŒºç®€å•ä½†ä¹ŸæŠ˜è…¾äº†å¥½ä¹…ï¼Œæ‰€ä»¥å°±æ‰“ç®—å¤‡æ³¨ä¸‹ã€‚</p><blockquote><p>ä¸¤æœ¬åŒºå—é“¾ç›¸å…³çš„ä¹¦åˆ†åˆ«æ˜¯åŒºå—é“¾å¼€å‘æŒ‡å—å’Œç²¾é€šæ¯”ç‰¹å¸ï¼Œéšåä¼šå†™äº›è¯»åæ„Ÿ</p></blockquote><p>è™½ç„¶ç½‘ä¸Šä¹Ÿæœ‰å¾ˆå¤šç›¸å…³çš„æ–‡ç« ä½†å¤§éƒ½æ¯”è¾ƒç¬¼ç»Ÿæˆ–è€…è®°å½•çš„æ¯”è¾ƒå«ç³Šï¼Œå¯¼è‡´åƒæˆ‘è¿™æ ·çš„æ–°æ‰‹å¾—èŠ±å¤§é‡çš„æ—¶é—´å»æ‘¸ç´¢å»è¸©å‘ã€‚ä¸‹é¢å°±å¼€å§‹æµæ°´è´¦äº†ã€‚ã€‚ã€‚</p><span id="more"></span><h2 id="build-bitcoin"><a href="#build-bitcoin" class="headerlink" title="build bitcoin"></a>build bitcoin</h2><ul><li>ä»githubä¸Šcloneæºç ï¼Œ<code>git clone https://github.com/bitcoin/bitcoin.git</code></li><li>cloneåˆ°æœ¬åœ°çš„ä»£ç æ˜¯æœ€æ–°çš„ä»£ç ä¹Ÿå°±æ˜¯masteråˆ†æ”¯ä¸Šçš„ï¼Œå‰äººä¸€èˆ¬éƒ½æ¨èé˜…è¯»0.12ç‰ˆæœ¬çš„ä»£ç ï¼Œæ‰€ä»¥åœ¨buildä»£ç ä¹‹å‰è¦åˆ‡æ¢ä¸‹tagï¼Œå‘½ä»¤<code>git checkout v0.12.0</code></li></ul><blockquote><p>é€‰æ‹©tagä¸ºv0.12.0è¿›è¡Œbuildä¹‹åï¼Œåœ¨qtæ–‡ä»¶ä¸­å¹¶ä¸å‡ºä¼šå‡ºç°<strong>bitcoin-qt</strong>è¿™ä¸ªæ–‡ä»¶ï¼Œéšååˆ‡æ¢åˆ°branchä¸º<strong>remotes/origin/0.12</strong>çš„ç‰ˆæœ¬è¿›è¡ŒbuildæˆåŠŸå‡ºç°ï¼Œæ‰€ä»¥è¿™é‡Œåº”è¯¥åˆ‡æ¢çš„ä»£ç ç‰ˆæœ¬æ˜¯<code>git checkout remotes/origin/0.12</code></p></blockquote><ul><li>æŒ‰ç…§ä»£ç ç›®å½•docæ–‡ä»¶ä¸­buildç›¸å…³çš„æ–‡ä»¶(<em>build-*.md</em>)ä¸­ä»‹ç»çš„æ­¥éª¤è¿›è¡Œbuild</li></ul><blockquote><p>æˆ‘ç”¨çš„ç³»ç»Ÿæ˜¯ubuntu-14.04-desktop-amd64.iso</p></blockquote><p>æŒ‰ç…§build-unix.mdä¸­çš„æ­¥éª¤å»buildä»£ç ï¼Œbuildä¹‹å‰éœ€è¦å®‰è£…ä¸€äº›ä¾èµ–çš„è½¯ä»¶ï¼Œå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install build-essential libtool autotools-dev automake pkg-config libssl-dev libevent-dev bsdmainutils</span><br><span class="line"></span><br><span class="line">sudo apt-get install libboost-system-dev libboost-filesystem-dev libboost-chrono-dev libboost-program-options-dev libboost-test-dev libboost-thread-dev</span><br><span class="line"><span class="comment"># å¦‚æœä¸Šé¢å®‰è£…boostçš„å‘½ä»¤æ²¡æœ‰æˆåŠŸï¼Œåˆ™ä½¿ç”¨ä¸‹é¢çš„å‘½ä»¤è¿›è¡Œå®‰è£…</span></span><br><span class="line">sudo apt-get install libboost-all-dev</span><br><span class="line"></span><br><span class="line"><span class="comment"># ä¸‹é¢ä¸‰æ¡å‘½ä»¤æ˜¯å®‰è£…BerkeleyDBï¼Œwalletéœ€è¦ç”¨åˆ°</span></span><br><span class="line">sudo add-apt-repository ppa:bitcoin/bitcoin</span><br><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get install libdb4.8-dev libdb4.8++-dev</span><br><span class="line"></span><br><span class="line">sudo apt-get install libminiupnpc-dev</span><br><span class="line">sudo apt-get install libzmq3-dev</span><br><span class="line"></span><br><span class="line"><span class="comment">#æˆ‘å®‰è£…QTçš„å¤§ç‰ˆæœ¬æ˜¯4ï¼Œæ‰€ä»¥æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤(QTåé¢ä¼šè¿›è¡Œä»‹ç»)</span></span><br><span class="line">sudo apt-get install libqt4-dev libprotobuf-dev protobuf-compiler</span><br><span class="line"></span><br><span class="line">sudo apt-get install libqrencode-dev</span><br></pre></td></tr></table></figure><p>OKï¼Œä¾èµ–çš„libåŸºæœ¬å®‰è£…ç»“æŸäº†ï¼Œå¯ä»¥æ‰§è¡Œbuildå‘½ä»¤äº†</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># åœ¨bitcoinæºç æ ¹ç›®å½•ä¸‹</span></span><br><span class="line">./autogen.sh</span><br><span class="line">./configure <span class="comment"># autogen.sh æ‰§è¡ŒæˆåŠŸä¹‹åä¼šç”Ÿæˆæ­¤æ–‡ä»¶</span></span><br><span class="line">make        <span class="comment"># configure æ‰§è¡ŒæˆåŠŸä¹‹åï¼Œä¼šä¹˜è½¦MakeFileæ–‡ä»¶ï¼Œä¾›makeä½¿ç”¨</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°å‘½ä»¤ä¸å‡ºé”™å°±è¯´æ˜buildæˆåŠŸäº†ï¼Œå¯ä»¥è¿è¡Œä»£ç äº†ã€‚</p><blockquote><p>buildæˆåŠŸä¹‹åä¼šå‡ºç°6ä¸ªå¯æ‰§è¡Œæ–‡ä»¶ï¼Œåˆ†åˆ«ä¸ºbitcoin-cliã€bitcoindã€bitcoin-txã€bitcoin-qtå’Œä¸¤ä¸ªtestæ–‡ä»¶test_bitcoinã€test_bitcoin-qt</p></blockquote><p>æ­¤æ—¶ä½ å°±æƒ³å¦‚æœæœ‰ä¸ªIDEå°±å¥½äº†ï¼Œæˆ‘å°±å¯ä»¥Debugä»£ç äº†ã€‚é‚£æˆ‘ä»¬å°±å®‰è£…ä¸ªå§ï¼ŒIDEä¸€èˆ¬ç”¨QT Creatorï¼Œå› ä¸ºæ¯”ç‰¹å¸é’±åŒ…æ˜¯ç”¨è¿™ä¸ªå¼€å‘çš„ã€‚</p><h2 id="IDEè¸©å‘"><a href="#IDEè¸©å‘" class="headerlink" title="IDEè¸©å‘"></a>IDEè¸©å‘</h2><p>å…³äºQT Creatoræ¯”è¾ƒå‘ï¼Œå®Œå…¨æ˜¯ä¸€è„¸çš„æ‡µé€¼å‘€ï¼ŒåªçŸ¥é“è¿™ä¸ªæ˜¯è·¨å¹³å°çš„ï¼ŒLinuxä¸‹å¼€å‘c++ç”¨è¿™ä¸ªï¼Œè¿˜å¯ä»¥ç”¨æ¥å¼€å‘ç•Œé¢ã€‚ä¸€å¼€å§‹å®‰è£…äº†ä¸ª_4.6_ç‰ˆæœ¬çš„ï¼Œå°†bitcoinå¯¼å…¥åå°±ä¸çŸ¥é“è¦å¹²å•¥äº†ï¼Œäºæ˜¯å°±æƒ³ç€æ–°å»ºä¸ªc++çš„demoé¡¹ç›®ç†Ÿæ‚‰ä¸‹è¿™ä¸ªIDEå§ï¼Œå½“æˆ‘åœ¨åˆ›å»ºc++é¡¹ç›®çš„æ—¶å€™å°±çœŸçš„æ‡µé€¼äº†ï¼Œå®Œå…¨ä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œå…·ä½“å°±ä¸åœ¨è¿™ä¸¢äººäº†ã€‚</p><p>æ‡µé€¼å°±åªå¥½å„ç§googleäº†ï¼Œçœ‹åˆ°ä¸€ç¯‡æ–‡ç« è¯´QT Creatorè¦ç»“åˆQTæ¥ä½¿ç”¨ï¼ŒåŸæ¥QTå’ŒQT Creatorä¸æ˜¯ä¸€ä¸ªä¸œè¥¿ï¼Œæˆ‘ä¸€ç›´ä»¥ä¸ºQTæ˜¯QT Creatorçš„ç®€ç§°ã€‚ã€‚ã€‚ã€‚</p><p>ä¸‹è½½äº†<a href="http://download.qt.io/archive/qt/4.8/4.8.1/">QT 4.8.1 qt-everywhere-opensource-src-4.8.1.tar.gz</a>ï¼Œä¸è¿‡åœ¨Linuxä¸‹æ˜¯æºç åŒ…ï¼Œä¸æ˜¯å®‰è£…åŒ…ï¼Œå¾—éœ€è¦è¿›è¡Œç¼–è¯‘å®‰è£…ã€‚</p><p>è§£å‹è¿›å…¥ç›®å½•ä¹‹åæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make   <span class="comment"># æ¬¡è¿‡ç¨‹è¾ƒé•¿</span></span><br><span class="line">make install</span><br></pre></td></tr></table></figure><p>å®‰è£…æˆåŠŸä¹‹åéœ€è¦é…ç½®ç¯å¢ƒå˜é‡</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PATH=/usr/<span class="built_in">local</span>/Trolltech/Qt-%VERSION%/bin:<span class="variable">$PATH</span></span><br><span class="line"><span class="built_in">export</span> PATH</span><br></pre></td></tr></table></figure><p>QTå‡†å¤‡å°±ç»ªä¹‹åå†æ¬¡æ‰“å¼€QT Creatorè¿˜æ˜¯ä¸çŸ¥é“æ€ä¹ˆåˆ›å»ºc++ç¨‹åºï¼Œä¸çŸ¥é“æ€ä¹ˆè¿è¡Œï¼Œåˆæ˜¯ä¸€é€šgoogleï¼Œä¸€äº›æ–‡ç« ä¸­çš„IDEå’Œæˆ‘çš„ç•Œé¢æœ‰æ‰€ä¸åŒï¼ŒC++çš„æ•™ç¨‹ä¹Ÿæ¯”è¾ƒå°‘ã€‚</p><p>æœäº†å¾ˆå¤šæ–‡ç« è™½ç„¶æ²¡æœ‰æ˜ç¡®çš„æ•™ç¨‹å•å¯¹QT Creatoræœ‰äº†æ›´æ–°çš„è®¤è¯†ï¼Œå°±åªèƒ½ä½¿å‡ºæ€æ‰‹é”â€“æ¢IDEçš„ç‰ˆæœ¬ï¼Œä»æ–°ä¸‹è½½äº†ä¸ª<a href="https://download.qt.io/official_releases/qtcreator/2.8/2.8.1/">2.8</a>çš„ç‰ˆæœ¬ï¼Œå†æ¬¡æ‰“å¼€IDEï¼Œç¬é—´æ„Ÿè§‰æ˜¥å¤©æ¥äº†ï¼Œ2.8.1çš„ç•Œé¢æ˜¯è¿™æ ·çš„<br><img src="/blogimgs/bitcoin-ide/ide.png" title="ä¸»ç•Œé¢"></p><h2 id="C-Demo"><a href="#C-Demo" class="headerlink" title="C++ Demo"></a>C++ Demo</h2><p>æ–°å»ºé¡¹ç›®å’Œå¤§å¤šIDEæ­¥éª¤ç±»ä¼¼ï¼Œç‚¹å‡» File -&gt; New File or Projectï¼Œç„¶åå‡ºç°å¦‚ä¸‹é¡µé¢ï¼š<br><img src="/blogimgs/bitcoin-ide/c++1.png" title="é€‰æ‹©é¡¹ç›®ç±»å‹"><br>å®‰è£…å›¾ä¸­çš„é€‰é¡¹è¿›è¡Œé€‰æ‹©å°±okï¼Œæ¥ä¸‹æ¥è¿›è¡Œç¬¬äºŒæ­¥<br><img src="/blogimgs/bitcoin-ide/c++2.png" title="é€‰æ‹©é¡¹ç›®åœ°å€"><br>é€‰æ‹©é¡¹ç›®åç§°å’Œå­˜æ”¾çš„ç›®å½•ï¼Œç»§ç»­Next<br><img src="/blogimgs/bitcoin-ide/c++3.png" title="ç¼–è¯‘æ–‡ä»¶ç›®å½•"><br>è¿™é‡Œä¸èƒ½ä½¿ç”¨é»˜è®¤ç”Ÿæˆçš„ç›®å½•ï¼Œä¼šæœ‰é—®é¢˜ï¼Œéœ€è¦å°†ç›®å½•æ”¹æˆå¸¸è§„ç›®å½•åï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/blogimgs/bitcoin-ide/c++4.png"><br>ç»§ç»­Nextï¼Œè¿™é‡Œé€‰ä¸‹ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œéšæ€§æ¥å°±å¥½<br><img src="/blogimgs/bitcoin-ide/c++5.png" title="ç‰ˆæœ¬ç®¡ç†"><br>ç‚¹å‡»Finishï¼Œå°±å¯ä»¥è¿›å…¥é¡¹ç›®ç•Œé¢ï¼ŒæŸ¥çœ‹ç¼–è¾‘æ–°å»ºçš„é¡¹ç›®äº†ï¼š<br><img src="/blogimgs/bitcoin-ide/c++6.png" title="æŸ¥çœ‹ç¼–è¾‘é¡¹ç›®"><br>IDEé»˜è®¤ä¼šç”Ÿæˆä¸€ä¸ªHello Worldçš„æ–‡ä»¶ï¼Œç‚¹å‡»è¿è¡Œçœ‹ä¸‹æ•ˆæœ<br><img src="/blogimgs/bitcoin-ide/c++7.png" title="è¿è¡Œæ•ˆæœ"></p><h2 id="QT-Creatorè¿è¡ŒBitcoin"><a href="#QT-Creatorè¿è¡ŒBitcoin" class="headerlink" title="QT Creatorè¿è¡ŒBitcoin"></a>QT Creatorè¿è¡ŒBitcoin</h2><p>å°†bitcoinå¯¼å…¥IDEå¹¶è¿è¡Œbitcoiné’±åŒ…ã€‚<br>ç‚¹å‡» File -&gt; New File or Projectï¼Œé€‰æ‹©Import projectä¸­çš„Import Existing Projectï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/blogimgs/bitcoin-ide/import1.png" title="å¯¼å…¥bitcoin1"><br>ç‚¹å‡»Chooseï¼Œé€‰æ‹©æºç æ‰€åœ¨ç›®å½•ï¼Œæˆ‘çš„ç›®å½•ä¿¡æ¯å¦‚ä¸‹:<br><img src="/blogimgs/bitcoin-ide/import2.png" title="å¯¼å…¥bitcoin2"><br>ç»§ç»­Nextï¼Œé»˜è®¤Nextå°±å¥½ï¼Œç•Œé¢å¦‚å›¾:<br><img src="/blogimgs/bitcoin-ide/import3.png" title="å¯¼å…¥bitcoin3"><br>è¿˜æœ‰ä¸€æ­¥Summaryï¼Œä¸»è¦é€‰ä¸‹ç‰ˆæœ¬ç®¡ç†å·¥å…·ï¼Œç‚¹å‡»Finishå°±å¯¼å…¥æˆåŠŸäº†ã€‚</p><p>å¯¼å…¥æˆåŠŸä¹‹åï¼Œé¦–å…ˆè¿è¡Œä¸ªbitcoin-qtéªŒè¯ä¸‹ï¼Œ<br>ç‚¹å‡»IDEå·¦ä¾§çš„<em>Project</em>æŒ‰é’®ï¼Œåœ¨<em>Desktop</em>é€‰é¡¹ä¸­ç‚¹å‡»<em>run</em>æ ‡ç­¾ï¼Œå¦‚ä¸‹å›¾ï¼š<br><img src="/blogimgs/bitcoin-ide/run-qt.png" title="è¿è¡Œbitcoin-qt"><br>é…å¥½ä¹‹åç‚¹å‡»è¿è¡Œå°±ä¼šå‡ºç°é’±åŒ…é¡µé¢ï¼Œå¦‚å›¾:<br><img src="/blogimgs/bitcoin-ide/bitcoin-qt.png" title="è¿è¡Œbitcoin-qt.png"></p><h2 id="é™„åŠ "><a href="#é™„åŠ " class="headerlink" title="é™„åŠ "></a>é™„åŠ </h2><p>æœ‰äººæ¯”è¾ƒæ‚²å‚¬çš„è¯ï¼Œå¹¶æ²¡æœ‰é¡ºåˆ©æ‰§è¡ŒæˆåŠŸï¼Œå¯èƒ½Kitsæœ‰é—®é¢˜ï¼ŒKitsæ˜¯åœ¨_ç¼–è¾‘æ–‡ä»¶ç›®å½•_ä¸­é€‰æ‹©çš„_Desktop_ï¼Œæˆ‘çš„Desktopçš„é…ç½®å¦‚å›¾ï¼š<br><img src="/blogimgs/bitcoin-ide/desktop.png" title="Desktopé…ç½®"></p><blockquote><p>æœ€åç¥å¤§å®¶å…­ä¸€å¿«ä¹ã€‚ã€‚ã€‚ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> BlockChain </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BlockChain </tag>
            
            <tag> BitCoin </tag>
            
            <tag> Src </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSæƒé™</title>
      <link href="/HDFS%E6%9D%83%E9%99%90.html"/>
      <url>/HDFS%E6%9D%83%E9%99%90.html</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰å¯¹HDFSæ›´æˆ–è€…è¯´æ˜¯å¯¹Linuxä¸­æ–‡ä»¶çš„æƒé™æ²¡æœ‰è¿›è¡Œä¸€ä¸ªå®Œæ•´çš„å­¦ä¹ ï¼Œåªæ˜¯çŸ¥é“æœ‰æ‰€æœ‰è€…ã€æ‰€å±ç»„å’Œå…¶å®ƒæƒé™ï¼Œå…·ä½“åˆ°æŸä¸ªäººçš„æƒé™æœ‰è¯»(r)ã€å†™(w)å’Œå¯æ‰§è¡Œ(x)ã€‚<br>é‡åˆ°æ²¡æœ‰æƒé™çš„é—®é¢˜å°±<em>chmod</em>åŠ ä¸ªæƒé™ï¼ŒåŠ å®Œä¹‹åå¦‚æœè¿˜æœ‰é—®é¢˜å°±ç»™çˆ¶ç›®å½•ä¹ŸåŠ ä¸€æ ·çš„æƒé™ï¼Œå¦‚æœè¿˜ä¸è¡Œå°±ç»™777ã€‚<br>è¿™å…¶ä¸­åº”è¯¥ç»™ä»€ä¹ˆæƒé™ï¼Œç»™ä»€ä¹ˆæƒé™æœ€åˆé€‚éƒ½æ˜¯ä¸€å¤´é›¾æ°´ã€‚<br><strong>ä»Šå¤©å°±è¯´è¯´æ–‡ä»¶å’Œç›®å½•æƒé™çš„é‚£äº›äº‹</strong>ã€‚ã€‚ã€‚ã€‚</p><span id="more"></span><h2 id="HDFSåŸºäºLinuxçš„POSIX-model"><a href="#HDFSåŸºäºLinuxçš„POSIX-model" class="headerlink" title="HDFSåŸºäºLinuxçš„POSIX model"></a>HDFSåŸºäºLinuxçš„POSIX model</h2><blockquote><p>HDFSçš„æƒé™è™½ç„¶æ˜¯åŸºäºLinuxçš„POSIX modelï¼Œä½†æ˜¯HDFSä¸­å…¶å®å¹¶æ²¡æœ‰çœŸæ­£çš„ç”¨æˆ·å’Œç»„çš„æ¦‚å¿µï¼Œåªæ˜¯ä»ä¸»æœºä¸Šæ‹¿åˆ°ç”¨æˆ·çš„ä¿¡æ¯ç„¶åå¯¹å…¶å­˜å‚¨çš„æ–‡ä»¶æƒé™è¿›è¡Œæ£€æŸ¥ã€‚</p></blockquote><p>HDFSä¸­æ¯ä¸ªæ–‡ä»¶å’Œç›®å½•éƒ½æœ‰ä¸€ä¸ªownerå’Œgroupï¼Œå¹¶å¯¹ownerã€owneråŒä¸€ä¸ªç»„çš„userå’Œå…¶å®ƒuserçš„æƒé™è¿›è¡Œäº†åˆ†ç¦»ï¼Œæƒé™åˆ†ä¸º<em>rwx</em>ã€‚å¯¹äºæ–‡ä»¶æ¥è¯´ï¼Œæœ‰<em>r</em>æƒé™åˆ™å¯å¯¹æ­¤æ–‡ä»¶<em>å¯è¯»</em>ï¼Œæœ‰<em>w</em>æƒé™åˆ™å¯å¯¹æ–‡ä»¶è¿›è¡Œ<em>å†™å’Œè¿½åŠ </em>ï¼Œ<strong>xæƒé™å¯¹æ–‡ä»¶æ¥è¯´æ²¡æœ‰å®é™…çš„æ„ä¹‰</strong>ã€‚å¯¹äºç›®å½•æ¥è¯´ï¼Œæ‹¥æœ‰<em>r</em>æƒé™å¯ä»¥<em>æŸ¥çœ‹ç›®å½•ä¸­å†…å®¹</em>ï¼Œæ¯”å¦‚æ­¤ç›®å½•ä¸‹çš„æ–‡ä»¶æˆ–è€…å­ç›®å½•ï¼Œæ‹¥æœ‰<em>w</em>æƒé™å¯ä»¥åœ¨æ­¤ç›®å½•ä¸­<em>æ–°å»ºæˆ–è€…åˆ é™¤æ–‡ä»¶å’Œå­ç›®å½•ï¼Œä½†ä¸å¯ä»¥æ”¹å˜æ­¤ç›®å½•çš„åå­—ï¼Œå› ä¸ºæ”¹å˜æ­¤ç›®å½•çš„ä¿¡æ¯æ˜¯éœ€è¦å…¶ä¸Šå±‚ç›®å½•çš„å†™æƒé™</em>ï¼Œå¯¹äºç›®å½•æ¥è¯´ï¼Œä¸ªäººæ„Ÿè§‰æœ€é‡è¦çš„åº”è¯¥æ˜¯<em>x</em>æƒé™ï¼Œæ‹¥æœ‰<em>x</em>æƒé™ï¼Œæ‰å¯ä»¥è¿›å…¥å½“å‰ç›®å½•è¿›è¡Œå…¶å®ƒæ“ä½œã€‚</p><blockquote><p>å¦‚æœæ²¡æœ‰ç›®å½•çš„<em>x</em>æƒé™ï¼Œä½ æ‹¥æœ‰çš„å…¶å®ƒæƒé™å¹¶ä¸èƒ½å‘æŒ¥ç›¸åº”çš„ä½œç”¨ï¼Œå› ä¸º<em>rw</em>æƒé™éƒ½æ˜¯é’ˆå¯¹ç›®å½•ä¸­çš„å†…å®¹çš„ï¼Œå½“ä½ æ²¡æœ‰è¿›å…¥ç›®å½•çš„æƒé™æ—¶ï¼Œå…¶å®ƒæƒé™éƒ½æ˜¯è™šæ— ã€‚</p></blockquote><h3 id="sticky-bit"><a href="#sticky-bit" class="headerlink" title="sticky bit"></a>sticky bit</h3><p>HDFSä¸­è¿˜æœ‰ä¸€ä¸ªsticky bitï¼Œæ­¤åŠŸèƒ½åªé’ˆå¯¹ç›®å½•æœ‰æ•ˆï¼Œæ˜¯ä¸€ä¸ªé˜²åˆ é™¤ä½ã€‚é˜²æ­¢*é™¤ç®¡ç†å‘˜ã€ç›®å½•æˆ–è€…æ–‡ä»¶çš„æ‰€æœ‰è€…ä¹‹å¤–çš„å…¶å®ƒäºº(å³ä½¿å…¶å®ƒç”¨æˆ·å¯¹è¯¥æ–‡ä»¶å¤¹æœ‰rwxæƒé™)*å¯¹æ–‡ä»¶æˆ–è€…ç›®å½•è¿›è¡Œåˆ é™¤ã€‚<br>å‘½ä»¤å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#å³åœ¨ç¬¬ä¸€ä½æ·»åŠ æ•°å­—1</span></span><br><span class="line">hadoop fs -chmod 1777 /tmp</span><br><span class="line">hadoop fs -chmod 1777 /spark-history</span><br><span class="line">hadoop fs -chmod 1777 /user/hive/warehouse</span><br></pre></td></tr></table></figure><h2 id="HDFS-ACL"><a href="#HDFS-ACL" class="headerlink" title="HDFS ACL"></a>HDFS ACL</h2><p>HDFS ACL(Access Control Lists)æ˜¯å¯¹POSIX permissions modelçš„ä¸€ä¸ªè¡¥å……ã€‚ä¼ ç»Ÿçš„æƒé™æ˜¯é’ˆå¯¹ç”¨æˆ·å’Œç»„çš„ç»„ç»‡æ¶æ„æ¥è®¾ç½®çš„ï¼Œä½†å½“ä½ <em>åªæƒ³ç»™ç‰¹å®šçš„ç”¨æˆ·æˆ–è€…ç»„</em>(<strong>è€Œä¸æ˜¯åªé’ˆå¯¹æ–‡ä»¶çš„æ‰€æœ‰è€…å’Œæ‰€å±ç»„</strong>)æ¥å¼€æƒé™æ—¶ï¼Œæˆ‘ä»¬å°±å¯ä»¥ä½¿ç”¨ACLæ¥æ§åˆ¶ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼ŒHDFS ACLåŠŸèƒ½æ˜¯å…³é—­çš„ï¼Œå› ä¸ºå¼€å¯ACLä¹‹åï¼ŒNNä¸­ä¼šå¯¹å¼€å¯ACLçš„inodeå­˜å‚¨ä¸€ä»½é¢å¤–çš„æ•°æ®ï¼Œä¼šå¸¦æ¥é¢å¤–çš„å†…å­˜å¼€é”€ï¼Œå¦‚æœæœ‰éœ€è¦å¯ä»¥åœ¨<code>hdfs-site.xml</code>ä¸­è®¾ç½®<code>dfs.namenode.acls.enabled</code>ä¸ºtrueã€‚</p><blockquote><p>æ–°å»ºä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•æ—¶ï¼Œä¼šç»§æ‰¿çˆ¶ç›®å½•çš„ACLï¼Œä½†æ”¹å˜çˆ¶ç›®å½•çš„ACLæ—¶ï¼Œåœ¨æ­¤ç›®å½•ä¸­å·²ç»å­˜åœ¨çš„å†…å®¹ä¸ä¼šå‘ç”Ÿæ”¹å˜ã€‚</p></blockquote><p>ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•çš„ACLç”±ä¸€ç»„ACL entryç»„æˆã€‚æ¯ä¸ªEntryæ ‡è¯†ä¸€ä¸ªç”¨æˆ·æˆ–è€…ç»„çš„rwxæƒé™ï¼Œå¦‚ä¸‹ä¸€ä¸ªæ–‡ä»¶çš„ä¸€ä¸ªACLï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">user::rw-</span><br><span class="line">user:bruce:rwx                  <span class="comment">#effective:r--</span></span><br><span class="line">group::r-x                      <span class="comment">#effective:r--</span></span><br><span class="line">group:sales:rwx                 <span class="comment">#effective:r--</span></span><br><span class="line">mask::r--</span><br><span class="line">other::r--</span><br></pre></td></tr></table></figure><p>æ–‡ä»¶çš„æ‰€æœ‰è€…å…·æœ‰rwæƒé™ï¼Œæ‰€å±ç»„å…·æœ‰rxæƒé™ï¼Œå…¶å®ƒç”¨æˆ·å…·æœ‰ræƒé™ï¼Œä½†æ˜¯ç”¨æˆ·bruceå…·æœ‰è¯¥æ–‡ä»¶çš„rwxæƒé™ï¼Œsalesç»„ä¹Ÿå…·æœ‰è¯¥æ–‡ä»¶çš„rwxæƒé™ã€‚ä½†æ˜¯bruceå’Œsaleså°±çœŸçš„å…·æœ‰rwxæƒé™äº†ï¼Ÿè¿™é‡Œè¿˜æœ‰æœ€åä¸€é“é˜²çº¿<em>mask</em>ï¼Œmaskå†³å®šäº†ä¸€ä¸ªç”¨æˆ·æˆ–è€…ç»„èƒ½å¤Ÿå¾—åˆ°çš„æœ€å¤§çš„æƒé™ã€‚ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œbruceå’Œsalesçš„æƒé™ä¼šä¸maskçš„æƒé™è¿›è¡Œä¸è¿ç®—ï¼Œæœ€ç»ˆçš„ç»“æœæ‰æ˜¯bruceå’Œsalesçš„æƒé™ï¼Œä¹Ÿå°±æ˜¯æ³¨é‡Šä¸­çš„å†…å®¹ã€‚</p><h3 id="æƒé™æ£€æŸ¥æµç¨‹"><a href="#æƒé™æ£€æŸ¥æµç¨‹" class="headerlink" title="æƒé™æ£€æŸ¥æµç¨‹"></a>æƒé™æ£€æŸ¥æµç¨‹</h3><p>å½“ä¸€ä¸ªæ–‡ä»¶æœ‰ACLæ—¶ï¼Œæƒé™æ£€æŸ¥çš„æµç¨‹ä¸ºï¼š</p><ul><li>åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦ä¸ºowner</li><li>åˆ¤æ–­è¯¥ç”¨æˆ·æ˜¯å¦åŒ…å«åœ¨ACL entryçš„userä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™é€šè¿‡maskè¿‡æ»¤æƒé™</li><li>åˆ¤æ–­è¯¥ç”¨æˆ·çš„æ‰€å±ç»„æ˜¯å¦åŒ…å«åœ¨ç»„ä¸­ï¼ŒåŒ…å«åˆ™ä¹Ÿè¦é€šè¿‡maskæ¥è¿‡æ»¤æƒé™(å› ä¸ºåœ¨ä½¿ç”¨äº†ACLçš„æƒ…å†µä¸‹ï¼Œgroupçš„æƒé™æ˜¾ç¤ºçš„å°±æ˜¯å½“å‰çš„mask)</li><li>åˆ¤æ–­è¯¥ç”¨æˆ·çš„æ‰€å±ç»„æ˜¯å¦åŒ…å«åœ¨ACL entryçš„groupä¸­ï¼Œå¦‚æœåœ¨ï¼Œåˆ™é€šè¿‡maskæ¥è¿‡æ»¤æƒé™</li></ul><h3 id="ACLå‘½ä»¤"><a href="#ACLå‘½ä»¤" class="headerlink" title="ACLå‘½ä»¤"></a>ACLå‘½ä»¤</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># æ·»åŠ ç”¨æˆ·acl</span></span><br><span class="line">hdfs dfs -setfacl -m user:xx:rwx path</span><br><span class="line"><span class="comment"># åˆ é™¤ä¸€ä¸ªç”¨æˆ·çš„acl</span></span><br><span class="line">hdfs dfs -setfacl -x user:xx path</span><br><span class="line"><span class="comment"># åˆ é™¤æ‰€æœ‰çš„acl</span></span><br><span class="line">hdfs dfs -setfacl -d path</span><br><span class="line"><span class="comment"># æŸ¥çœ‹acl</span></span><br><span class="line">hdfs dfs -getfacl path</span><br></pre></td></tr></table></figure><blockquote><p>ç›®å½•æˆ–è€…æ–‡ä»¶æ·»åŠ äº†ACLä¹‹åï¼Œllå‘½ä»¤æŸ¥çœ‹ï¼Œä¼šæœ‰ä¸€ä¸ª<code>+</code>æ ‡è¯†</p></blockquote><h2 id="umask"><a href="#umask" class="headerlink" title="umask"></a>umask</h2><p>ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•æ–°å»ºä¹‹åå°±æœ‰ä¸€ä¸ªé»˜è®¤çš„æƒé™ï¼Œè¿™ä¸ªé»˜è®¤çš„æƒé™æ˜¯æ€ä¹ˆæ§åˆ¶çš„å‘¢ï¼Ÿæ˜¯ç”±<code>umask</code>æ§åˆ¶çš„ã€‚</p><p>æ–‡ä»¶åˆ›å»ºä¹‹åçš„é»˜è®¤æƒé™æ˜¯<code>0666 &amp; ^umask</code>ï¼Œç›®å½•åˆ›å»ºä¹‹åçš„é»˜è®¤æƒé™æ˜¯<code>0777 &amp; ^umask</code>ï¼Œumaskåœ¨<code>core-site.xml</code>ä¸­ç”±<code>fs.permissions.umask-mode</code>è®¾ç½®ï¼Œé»˜è®¤æ˜¯022ã€‚</p><h2 id="HDFS-å¼€å¯æƒé™"><a href="#HDFS-å¼€å¯æƒé™" class="headerlink" title="HDFS å¼€å¯æƒé™"></a>HDFS å¼€å¯æƒé™</h2><p>HDFSä¸­ä¸æƒé™ç›¸å…³çš„é…ç½®åœ¨<code>core-site.xml</code>å’Œ<code>hdfs-site.xml</code>ä¸­ã€‚</p><h3 id="core-site-xml"><a href="#core-site-xml" class="headerlink" title="core-site.xml"></a>core-site.xml</h3><p>core-siteä¸­ä¸»è¦æ˜¯è®¾ç½®umaskï¼Œç”±fs.permissions.umask-modeæ§åˆ¶ï¼Œé»˜è®¤æ˜¯022</p><h3 id="hdfs-site-xml"><a href="#hdfs-site-xml" class="headerlink" title="hdfs-site.xml"></a>hdfs-site.xml</h3><p>hfds-siteä¸­æ§åˆ¶ç€æƒé™çš„å¼€å¯ï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p><ul><li><p>dfs.permissions.enabled = true<br>æ˜¯å¦å¼€å¯æƒé™æ£€æŸ¥ï¼Œé»˜è®¤æ˜¯true</p></li><li><p>dfs.permissions.superusergroup = supergroup<br>è®¾ç½®hdfsç®¡ç†å‘˜çš„ç»„åç§°ï¼Œæ¨¡å¼åå­—æ˜¯<em>supergroup</em>ï¼Œä¸€èˆ¬æ”¹ä¸ºä¸ç®¡ç†å‘˜ç›¸åŒçš„åå­—ï¼Œå¦‚ç®¡ç†å‘˜æ˜¯hdfsï¼Œåˆ™æ”¹ä¸ºhdfs</p></li><li><p>dfs.namenode.acls.enabled = true<br>æ§åˆ¶ACLæ˜¯å¦å¼€å¯ï¼Œé»˜è®¤ä¸ºfalseã€‚</p></li></ul><blockquote><p>Tips<br>HDFSæƒé™è®¾ç½®æœ€å¥½æ˜¯ä»¥ä¼ ç»Ÿçš„æƒé™è¿›è¡Œæ§åˆ¶ï¼Œåªé’ˆå¯¹ä¸ªåˆ«æƒé™è¦æ±‚é«˜çš„æ–‡ä»¶è¿›è¡ŒACLæ§åˆ¶ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> ACL </tag>
            
            <tag> permission </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Zookeeper sessionè¿‡æœŸå’Œconnectionè¶…æ—¶</title>
      <link href="/Zookeeper%20session%E8%BF%87%E6%9C%9F%E5%92%8Cconnection%E8%B6%85%E6%97%B6.html"/>
      <url>/Zookeeper%20session%E8%BF%87%E6%9C%9F%E5%92%8Cconnection%E8%B6%85%E6%97%B6.html</url>
      
        <content type="html"><![CDATA[<p>é¦–å…ˆæ¥çœ‹ä¸€å¼ å®˜æ–¹çš„çŠ¶æ€è½¬æ¢å›¾ï¼š<br><img src="/blogimgs/zk_timeout/state_dia.jpg" alt="zkçŠ¶æ€å›¾" title="zkçŠ¶æ€å›¾"><br>é¦–å…ˆzkå®¢æˆ·ç«¯ä¼šåˆ›å»ºä¸€ä¸ªè¿æ¥è¯·æ±‚ï¼Œæ­¤æ—¶ä¼šåˆ›å»ºä¸€ä¸ªsessionï¼Œç”¨äºæ ‡è¯†æ­¤æ¬¡ä¸æœåŠ¡å™¨è¿›è¡Œè¿æ¥çš„ä¸€æ¬¡ç”Ÿå‘½å‘¨æœŸã€‚sessionåˆ›å»ºä¹‹åï¼Œå®¢æˆ·ç«¯çš„è¿æ¥çŠ¶æ€å˜ä¸ºconnectingï¼Œå½“ä¸æœåŠ¡å™¨å»ºç«‹æˆåŠŸä¹‹åå˜ä¸ºconnectedçŠ¶æ€ã€‚</p><span id="more"></span><p>ç”±ä¸Šé¢çš„çŠ¶æ€å›¾å¯ä»¥çœ‹å‡ºå®¢æˆ·ç«¯ä¼šæ¥å—åˆ°æœåŠ¡ç«¯è¿”å›çš„ä¸¤ä¸ªé”™è¯¯ç ï¼Œåˆ†åˆ«ä¸º<em>CONNECTION_LOSS</em>å’Œ<em>SESSION_EXPIRED</em>ï¼Œæ”¶åˆ°è¿™ä¸¤ä¸ªé”™è¯¯ç ï¼Œå®¢æˆ·ç«¯æ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿå…ˆçœ‹ä¸‹CONNECTION_LOSSã€‚</p><h2 id="CONNECTION-LOSS"><a href="#CONNECTION-LOSS" class="headerlink" title="CONNECTION_LOSS"></a>CONNECTION_LOSS</h2><p>å½“å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œä¼šè¿”å›CONNECTION_LOSSã€‚<strong>å½“å®¢æˆ·ç«¯æ”¶åˆ°æ­¤è¿”å›ç æ—¶ï¼Œå¹¶ä¸èƒ½ç›²ç›®çš„è®¤ä¸ºæ˜¯ç½‘ç»œè¿æ¥å¤±è´¥è¿˜æ˜¯æœåŠ¡ç«¯æŒ‚äº†</strong>ã€‚<br>å› ä¸ºè¿”å›CONNECTION_LOSSçš„æƒ…å†µå¯èƒ½æœ‰å¦‚ä¸‹å‡ ç§ï¼š</p><ul><li>å®¢æˆ·ç«¯åˆ›å»ºäº†ä¸€ä¸ªè¯·æ±‚ï¼Œå¹¶ä¸”æœåŠ¡ç«¯å·²æ­£å¸¸æ¥æ”¶åˆ°äº†è¯¥è¯·æ±‚ï¼Œåªæ˜¯åœ¨è¿”å›æ—¶å‘ç”Ÿäº†å¼‚å¸¸(å¯èƒ½æ˜¯ç½‘ç»œå¼‚å¸¸)</li><li>å®¢æˆ·ç«¯åˆ›å»ºäº†ä¸€ä¸ªè¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ ¹æœ¬æ²¡æœ‰æ”¶åˆ°(å¯èƒ½æ˜¯ç½‘ç»œä¹Ÿå¯èƒ½æ˜¯æœåŠ¡ç«¯æŒ‚äº†)</li></ul><p>å› æ­¤åœ¨å®¢æˆ·ç«¯æ”¶åˆ°è¿™æ ·çš„è¿”å›ç æ—¶ï¼Œä¸èƒ½æ–°å»ºä¸€ä¸ªsessionã€‚å‡å¦‚å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯Aæ­£å¸¸è¿æ¥æ—¶ï¼Œå‘ç”Ÿäº†å¼‚å¸¸ï¼Œæ­¤æ—¶åº”è¯¥å°è¯•ä¸æœåŠ¡ç«¯Bå»ºç«‹è¿æ¥ï¼Œå¦‚æœæ­¤æ—¶æ–°å»ºsessionå°±ä¼šå¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯Aå»ºç«‹çš„ä¸€äº›watcherä»€ä¹ˆçš„å°±ä¼šæ¶ˆå¤±ï¼Œå› ä¸ºzkæ˜¯ä»¥sessionæ¥æ ‡è¯†å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸçš„ã€‚</p><p>å½“å®¢æˆ·ç«¯æ”¶åˆ°è¿™æ ·çš„è¿”å›ç ä¹‹åï¼Œè¦åšçš„äº‹æ˜¯æ ¹æ®æœåŠ¡å™¨åˆ—è¡¨è¿›è¡Œé‡è¿ï¼Œå¦‚æœåœ¨sessionè¿‡æœŸä¹‹å‰ï¼Œè¿æ¥æˆåŠŸï¼Œåˆ™ä¼šè¯æ¢å¤ï¼Œä¹‹å‰åˆ›å»ºçš„watcherå’Œä¸´æ—¶èŠ‚ç‚¹ä»€ä¹ˆçš„éƒ½ä¾ç„¶å­˜åœ¨<!--å®¢æˆ·ç«¯ä¼šæ”¶åˆ°ä¸€ä¸ªSyncConnectionäº‹ä»¶-->ã€‚å¦‚æœåœ¨sessionè¿‡æœŸä¹‹åï¼Œåˆ™æ”¶åˆ°Session Expiredäº‹ä»¶ã€‚æ‰€ä»¥sessionè¶…æ—¶æ—¶é—´åº”è¯¥å¤§äºè¿æ¥è¶…æ—¶æ—¶é—´ã€‚</p><!-- The session timeout must be greater than the Zookeeper disconnect timeout and is recommended to be 3X that value to enable Zookeeper to retry transient disconnections. Setting a very short session timeout may result in frequent transitions between active and standby states during issues like network outages/GS pauses.--><!--Zookeeperçš„è¯»å†™æ“ä½œéƒ½æ˜¯åŸå­æ“ä½œï¼Œå› æ­¤å¯ä»¥ä¿è¯ä¸ä¼šéƒ¨åˆ†è¯»å–å’Œéƒ¨åˆ†å†™å…¥çš„æƒ…å†µï¼Œè¿™å°±ä¿è¯äº†æ•°æ®ä¸€è‡´æ€§ã€‚--><h2 id="SESSION-EXPIRED"><a href="#SESSION-EXPIRED" class="headerlink" title="SESSION_EXPIRED"></a>SESSION_EXPIRED</h2><p>å½“å®¢æˆ·ç«¯æ”¶åˆ°SESSION_EXPIREDè¿”å›ç æ—¶ï¼Œä¼šå…³é—­ä¸æœåŠ¡ç«¯çš„è¿æ¥ã€‚</p><p>å®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯ç¬¬ä¸€æ¬¡å»ºç«‹è¿æ¥æ—¶ï¼Œä¼šç”Ÿæˆä¸€ä¸ªsessionï¼Œåœ¨sessionè¶…æ—¶ä¹‹åå®¢æˆ·ç«¯ä¸æœåŠ¡ç«¯çš„è¿æ¥æ‰ä¼šè·Ÿæ¢sessionã€‚sessionæ˜¯å¦è¿‡æœŸæ˜¯ç”±æœåŠ¡ç«¯æ§åˆ¶çš„ã€‚</p><p>å½“zkæœåŠ¡ç«¯è¶…è¿‡ä¸€å®šçš„æ—¶é—´æ²¡æœ‰æ”¶åˆ°æ¥è‡ªzkå®¢æˆ·ç«¯çš„å¿ƒè·³ï¼Œ<strong>zkæœåŠ¡ç«¯å°±æŠŠè¿™ä¸ªsessionæ ‡è®°ä¸ºè¿‡æœŸï¼Œç„¶ååˆ é™¤è¿™ä¸ªsessionåˆ›å»ºçš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹ï¼Œå¹¶ä¸”é©¬ä¸Šé€šçŸ¥æ‰€æœ‰ç›‘å¬äº†è¿™äº›èŠ‚ç‚¹çš„å…¶ä»–session</strong>ã€‚æ­¤æ—¶ï¼Œå®¢æˆ·ç«¯ç”±äºå¤„äºæ–­å¼€è¿æ¥çš„çŠ¶æ€ï¼Œå¹¶ä¸çŸ¥é“å½“å‰sessionå·²ç»è¿‡æœŸï¼Œåªæœ‰åœ¨å®ƒä¸æœåŠ¡ç«¯é‡æ–°å»ºç«‹è¿æ¥ä¹‹åï¼Œæ‰ä¼šæ”¶åˆ°æœåŠ¡ç«¯å‘å‡ºçš„sessionè¿‡æœŸé€šçŸ¥ã€‚</p><p>è¿™ä¸ªæµç¨‹æ˜¯è¿™æ ·çš„ï¼š</p><ul><li>å®¢æˆ·ç«¯1ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶session1è¢«åˆ›å»ºï¼Œè¿æ¥æ­£å¸¸ï¼›å®¢æˆ·ç«¯2ä¸æœåŠ¡ç«¯å»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶session2è¢«åˆ›å»ºï¼Œè¿æ¥æ­£å¸¸(connectedçŠ¶æ€)</li><li>å®¢æˆ·ç«¯1ä¸æœåŠ¡ç«¯è¿æ¥å¼‚å¸¸ï¼Œå¹¶å°è¯•ä¸æœåŠ¡å™¨åˆ—è¡¨ä¸­çš„å…¶å®ƒæœåŠ¡ç«¯å»ºç«‹è¿æ¥(connectingçŠ¶æ€)</li><li>å°è¯•ä¸å…¶å®ƒæœåŠ¡ç«¯å»ºç«‹è¿æ¥çš„åŒæ—¶ï¼Œæ—¶é—´ä¹Ÿåœ¨ä¸€åˆ†ä¸€ç§’çš„æµé€ï¼Œè¶…è¿‡äº†session1çš„è¶…æ—¶æ—¶é—´</li><li>æœåŠ¡ç«¯æ£€æµ‹åˆ°session1å·²è¿‡è¶…æ—¶æ—¶é—´ï¼Œåˆ™é€šçŸ¥session2ï¼Œsession1å·²è¶…æ—¶ã€‚</li><li>ä¸€æ®µæ—¶é—´ä¹‹åï¼Œå¯èƒ½æ˜¯ç½‘ç»œæ¢å¤ä¹Ÿå¯èƒ½æ˜¯å®¢æˆ·ç«¯1ç¨‹åºæ¢å¤ï¼Œå·²æœåŠ¡ç«¯å»ºç«‹çš„è¿æ¥ï¼Œä½†ä¹‹å‰çš„session1å·²è¿‡æœŸï¼Œæ”¶åˆ°äº†æœåŠ¡ç«¯çš„è¿‡æœŸäº‹ä»¶ã€‚(closedçŠ¶æ€)</li><li>é‡æ–°åˆ›å»ºsessionå»ºç«‹è¿æ¥ã€‚</li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://wiki.apache.org/hadoop/ZooKeeper/FAQ#A2">https://wiki.apache.org/hadoop/ZooKeeper/FAQ#A2</a></p>]]></content>
      
      
      <categories>
          
          <category> Zookeeper </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Zookeeper </tag>
            
            <tag> session </tag>
            
            <tag> connection </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Druidè°ƒç ”</title>
      <link href="/Druid%E8%B0%83%E7%A0%94.html"/>
      <url>/Druid%E8%B0%83%E7%A0%94.html</url>
      
        <content type="html"><![CDATA[<p>DruidåˆæœŸæ˜¯ç”±metamarketsçš„æŠ€æœ¯äººå‘˜å¼€å‘ï¼Œç”¨äºå‘ä¹°å®¶ã€å–å®¶ã€å¹¿å‘Šä¸»è¿›è¡Œå¹¿å‘Šå±•ç¤ºçš„åº•å±‚å®æ—¶åˆ†æå¹³å°ï¼Œä¸ºOLAPçš„äº‹ä»¶æŸ¥è¯¢è€Œè®¾è®¡ã€‚ç›®å‰å·²å‘å±•æˆä¸€ä¸ªå¼€æºçš„å®æ—¶æ•°æ®åº“ã€‚</p><blockquote><p>æ—¶åºæ•°æ®åº“ï¼ˆTSDBï¼‰æ˜¯ä¸€ç§ç‰¹å®šç±»å‹çš„æ•°æ®åº“ï¼Œä¸»è¦ç”¨æ¥å­˜å‚¨æ—¶åºæ•°æ®ã€‚</p></blockquote><span id="more"></span><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p>Druidçš„æ¶æ„æ¯”è¾ƒçµæ´»ï¼Œæ˜¯ä¸€ä¸ªé›†ç¾¤æ¨¡å¼ï¼Œç”±å¤šä¸ªä¸åŒç±»å‹çš„èŠ‚ç‚¹ç»„æˆï¼Œå¹¶ä¸”å„ä¸ªèŠ‚ç‚¹ä¹Ÿèƒ½ç»„æˆè‡ªå·±çš„å°é›†ç¾¤ä»¥å¢åŠ å¯ç”¨æ€§å’Œæ‰©å±•æ€§ã€‚</p><p>Druidä¸­æ¯ç±»èŠ‚ç‚¹éƒ½åªå®Œæˆä¸€å°éƒ¨åˆ†äº‹æƒ…ï¼ŒèŠ‚ç‚¹åˆ†ç±»å¦‚ä¸‹ï¼š</p><ul><li>HistoricalèŠ‚ç‚¹<br>HistoricalèŠ‚ç‚¹æ˜¯Druidé›†ç¾¤çš„éª¨å¹²ï¼Œç”¨äºè´Ÿè´£å­˜å‚¨å’ŒæŸ¥è¯¢å†å²æ•°æ®ã€‚å®ƒä»Deep Storageä¸‹è½½segmentsåˆ°æœ¬åœ°ï¼Œå“åº”ä»brokerèŠ‚ç‚¹ä¸Šåˆ†å‘åˆ°æŸ¥è¯¢è¯·æ±‚ï¼Œå¹¶å°†ç»“æœæ•°æ®è¿”å›ç»™brokerèŠ‚ç‚¹ã€‚HistoricalèŠ‚ç‚¹é‡‡ç”¨shared nothingçš„æ¶æ„ï¼Œæ‰€ä»¥æ¯ä¸ªèŠ‚ç‚¹èƒ½å¤Ÿç‹¬è‡ªåŠ è½½segmentsã€åˆ é™¤segmentsã€ä»¥åŠä¸ºsegmentsæä¾›æŸ¥è¯¢æœåŠ¡ã€‚</li></ul><p><em>HistoricalèŠ‚ç‚¹ä¸Zookeeperè¿›è¡Œé€šä¿¡(HistoricalèŠ‚ç‚¹ä¹‹é—´å¹¶ä¸é€šä¿¡)ï¼Œå°†è¯¥èŠ‚ç‚¹ä¸Šå·²åŠ è½½çš„segmentså’Œæ­£åœ¨æä¾›æœåŠ¡çš„segmentsè®°å½•åœ¨zkä¸Šï¼Œzkä¼šé€šçŸ¥HistoricalèŠ‚ç‚¹è¿›è¡Œsegmentsçš„åŠ è½½å’Œåˆ é™¤</em>ã€‚</p><ul><li><p>BrokerèŠ‚ç‚¹<br>BrokerèŠ‚ç‚¹æ˜¯å®¢æˆ·ç«¯å’Œåº”ç”¨ç¨‹åºä»DruidæŸ¥è¯¢æ•°æ®çš„å…¥å£ã€‚BrokerèŠ‚ç‚¹è´Ÿè´£åˆ†å‘æŸ¥è¯¢ï¼Œå°†æŸ¥è¯¢è¯·æ±‚åˆ†å‘ç»™å®æ—¶èŠ‚ç‚¹å’Œå†å²èŠ‚ç‚¹ï¼Œä»¥åŠæ”¶é›†å’Œåˆå¹¶æ¥è‡ªå®æ—¶èŠ‚ç‚¹å’Œå†å²èŠ‚ç‚¹çš„ç»“æœã€‚<em>BrokerèŠ‚ç‚¹é€šè¿‡Zookeeperç¡®å®šsegmentsæ˜¯åœ¨å®æ—¶èŠ‚ç‚¹è¿˜æ˜¯å†å²èŠ‚ç‚¹å­˜æ´»</em>ã€‚</p></li><li><p>CoordinatorèŠ‚ç‚¹ </p></li><li><p>CoordinatorèŠ‚ç‚¹é€šè¿‡Metadata Storageå’Œzkç®¡ç†é›†ç¾¤ä¸­historicalèŠ‚ç‚¹ä¸Šçš„segments*ã€‚Coordinatorä»Metadata Storageä¸­è·å–segmentsçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ¥å†³å®šå“ªäº›segmentséœ€è¦åŠ è½½åˆ°å†å²èŠ‚ç‚¹é›†ç¾¤ä¸­ï¼Œåˆ©ç”¨zkåˆ¤æ–­å†å²èŠ‚ç‚¹é›†ç¾¤ä¸­æŸäº›èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ã€‚å½“Historicaléœ€è¦åŠ è½½æˆ–è€…åˆ é™¤ä¸€äº›segmentsæ—¶ä¼šåœ¨zkä¸Šåˆ›å»ºä¸€äº›entriesã€‚</p></li></ul><p><strong>Coordinatorä¸ä¸Historicalé€šä¿¡ï¼Œç›´æ¥ä¸zkè¿›è¡Œé€šä¿¡</strong></p><ul><li><p>RealtimeèŠ‚ç‚¹<br>å®æ—¶èŠ‚ç‚¹è´Ÿè´£åŠ è½½å®æ—¶çš„æ•°æ®åˆ°ç³»ç»Ÿä¸­ã€‚</p></li><li><p>Indexing ServiceèŠ‚ç‚¹<br>ç´¢å¼•æœåŠ¡èŠ‚ç‚¹ç”±å¤šä¸ªworkerç»„æˆçš„é›†ç¾¤ï¼Œè´Ÿè´£ä¸ºåŠ è½½æ‰¹é‡çš„å’Œå®æ—¶çš„æ•°æ®åˆ›å»ºç´¢å¼•ï¼Œå¹¶ä¸”å…è®¸å¯¹å·²ç»å­˜åœ¨çš„æ•°æ®è¿›è¡Œä¿®æ”¹ã€‚</p></li></ul><blockquote><p><strong>Real-timeå¤„ç†</strong>ç›®å‰å¯ä»¥<em>é€šè¿‡ç‹¬ç«‹çš„realtimeèŠ‚ç‚¹ï¼Œæˆ–è€…é€šè¿‡indexing serviceèŠ‚ç‚¹å®ç°</em>ï¼Œè¿™ä¸¤ç§æ–¹å¼éƒ½å¾ˆå¸¸è§ã€‚ Real-timeå¤„ç†åŒ…æ‹¬åŠ è½½æ•°æ®ã€åˆ›å»ºæ•°æ®ç´¢å¼•(åˆ›å»ºsegments)ã€ä»¥åŠäº¤æ¥segmentsç»™historicalèŠ‚ç‚¹ã€‚å®æ—¶å¤„ç†é€»è¾‘åŠ è½½ä¹‹åæ•°æ®ç«‹é©¬å¯æŸ¥ã€‚æ•°æ®äº¤æ¥çš„è¿‡ç¨‹ä¹Ÿæ˜¯å®‰å…¨çš„ï¼Œæ•°æ®åœ¨æ•´ä¸ªæµç¨‹ä¸­éƒ½ä¿æŒå¯æŸ¥ã€‚</p></blockquote><!-- RealtimeèŠ‚ç‚¹ å’Œ Indexing ServiceèŠ‚ç‚¹ çš„åŒºåˆ« http://dj1211.com/?p=702--><p>Druidé›†ç¾¤è¿˜ä¼šä¾èµ–ä¸€äº›å¤–éƒ¨ç»„ä»¶ï¼š</p><ul><li><p>Zookeeper<br>Zookeeperä¸»è¦ä½œç”¨æ˜¯å¸®åŠ©ç¾¤é›†æœåŠ¡å‘ç°å’Œç»´æŠ¤å½“å‰æ•°æ®çš„æ‹“æ‰‘ç»“æ„ï¼ŒDruidä¾èµ–Zookeeperæ¥ä¿è¯é›†ç¾¤å†…çš„ä¿¡æ¯ä¸€è‡´ã€‚</p></li><li><p>Metadata Storage<br>Druidä¾èµ–metadata storageå­˜å‚¨segmentsçš„å…ƒæ•°æ®å’Œé…ç½®ã€‚åˆ›å»ºsegmentsçš„æœåŠ¡åœ¨å…ƒæ•°æ®ä¸­è®°å½•ä¿¡æ¯ï¼Œcoordinatorç›‘å¬ç€å…ƒæ•°æ®ä»¥ä¾¿äº†è§£ä»€ä¹ˆæ—¶å€™éœ€è¦ä¸‹è½½æ–°æ•°æ®æˆ–è€…åˆ é™¤æ—§æ•°æ®ã€‚ å…ƒæ•°æ®çš„å­˜å‚¨ä¸æ¶‰åŠæŸ¥è¯¢çš„è·¯å¾„ã€‚<em>MySQLå’ŒPostgreSQLéå¸¸æœ‰åˆ©äºç”Ÿäº§ç¯å¢ƒä¸‹å…ƒæ•°æ®çš„å­˜å‚¨</em>ã€‚</p></li><li><p>Deep Storage<br>Deep storageæ˜¯segmentsçš„æ°¸ä¹…å¤‡ä»½ã€‚åˆ›å»ºsegmentsçš„æœåŠ¡(å®æ—¶æˆ–è€…ç¦»çº¿)ä¸Šä¼ segmentsåˆ°Deep storageï¼Œç„¶åhistoricalèŠ‚ç‚¹ä¸‹è½½ã€‚Deep storageä¸æ¶‰åŠæŸ¥è¯¢è·¯å¾„ã€‚ <em>S3å’ŒHDFSæ˜¯æ¯”è¾ƒæ¨èçš„deep storages</em>ã€‚</p></li></ul><p>Druidé›†ç¾¤æ•´ä½“æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/Druid/DruidArc.png" alt="Druidæ¶æ„å›¾" title="Druidæ¶æ„å›¾"><br>ä¸Šé¢Druidæ¶æ„å›¾ä¸­å±•ç¤ºäº†Druidé›†ç¾¤ä¸­å†…éƒ¨ç»„ä»¶å’Œå¤–éƒ¨ä¾èµ–ç»„ä»¶çš„æ•´ä½“æ¶æ„ï¼Œä¸‹é¢å†æ¥ä¸€å¼ å®˜æ–¹çš„æ¶æ„å›¾ï¼Œå’Œä¸Šé¢çš„æ¶æ„å›¾å¤§ä½“ä¸€æ ·ï¼Œæˆ‘æ„Ÿè§‰ä¸¤ä¸ªå›¾ç»“åˆèµ·æ¥çœ‹å°±æ¯”è¾ƒå®Œç¾äº†ã€‚å˜¿å˜¿ã€‚ã€‚<br><img src="/blogimgs/Druid/druid-manage-1.png" alt="Druidæ¶æ„å›¾-å®˜æ–¹" title="Druidæ¶æ„å›¾-å®˜æ–¹"></p><h3 id="ç‰¹ç‚¹"><a href="#ç‰¹ç‚¹" class="headerlink" title="ç‰¹ç‚¹"></a>ç‰¹ç‚¹</h3><blockquote><p>é«˜å¯ç”¨æ€§<br>ç”±äºDruidä½¿ç”¨çš„æ˜¯shared notingæ¶æ„ï¼Œæ‰€ä»¥å…¶å†…éƒ¨å¹¶æ— å•ç‚¹æ•…éšœï¼Œä¸åŒç±»å‹çš„èŠ‚ç‚¹å¤±è´¥ä¹Ÿä¸ä¼šå½±å“åˆ°å…¶ä»–ç±»å‹èŠ‚ç‚¹çš„æ­£å¸¸æœåŠ¡ã€‚ </p></blockquote><blockquote><p>å¯æ‰©å±•æ€§<br>Druidä¸­çš„æ¯ç±»èŠ‚ç‚¹éƒ½å¯éƒ¨ç½²ä¸ºé›†ç¾¤æ¨¡å¼ï¼Œä½¿Druidå¤„ç†èƒ½åŠ›èƒ½å¤Ÿæ°´å¹³æ‰©å±•ã€‚</p></blockquote><blockquote><p>äºšç§’çº§å“åº”<br>å®˜ç½‘è¯´10äº¿é‡çº§ä¸‹åšåˆ°äºšç§’å“åº”ï¼Œèƒ½å¤Ÿåšåˆ°å®æ—¶å¯¼å…¥ï¼Œå¯¼å…¥å³å¯æŸ¥è¯¢ã€‚</p></blockquote><blockquote><p>Roll-up<br>åœ¨æ•°æ®æ¥å…¥æ—¶å¯¹åŸå§‹æ•°æ®é€‰å®šä¸€ç³»åˆ—ç»´åº¦ä¹‹åè¿›è¡Œç¬¬ä¸€çº§èšåˆï¼Œå‡å°‘æ•°æ®é‡ï¼Œæé«˜æŸ¥è¯¢é€Ÿåº¦å’Œå‡å°‘å­˜å‚¨ç©ºé—´ã€‚</p></blockquote><h2 id="æ•°æ®æº"><a href="#æ•°æ®æº" class="headerlink" title="æ•°æ®æº"></a>æ•°æ®æº</h2><p>Druidæ•°æ®æºæ”¯æŒå¤šç§æ ¼å¼ï¼Œæ¯”å¦‚jsonã€csvæˆ–è€…æ˜¯ç”¨ç‰¹æ®Šå­—ç¬¦åˆ†å‰²çš„æ•°æ®ã€‚<br>æ•°æ®æ¥æºä¸»è¦åˆ†ä¸ºæ‰¹é‡æ•°æ®å’Œå®æ—¶æ•°æ®ã€‚æ¥å…¥æ–¹å¼ä¸»è¦æœ‰3ç§ï¼š</p><ul><li>ä»æ–‡ä»¶ä¸­æ‰¹é‡åŠ è½½ï¼Œæ•°æ®æ–‡ä»¶å¯ä»¥å­˜æ”¾åœ¨æœ¬åœ°ã€HDFSå’ŒS3ç­‰æ–‡ä»¶å­˜å‚¨ç³»ç»Ÿã€‚</li><li>å®æ—¶æ¨é€æ•°æ®ï¼Œæ˜¯ä½¿ç”¨<em>Tranquility</em>é€šè¿‡HTTPæ¨é€æ•°æ®åˆ°Druidã€‚Tranquilityæ˜¯ä¸€ä¸ªå•ç‹¬çš„å·¥å…·åŒ…ï¼Œå¹¶æ²¡æœ‰å’ŒDruidåšé›†æˆï¼Œéœ€è¦å•ç‹¬ä¸‹è½½ï¼ŒTranquilityå¯åŠ¨ä¸€ä¸ªserverè¿›ç¨‹ï¼Œé€šè¿‡HTTPå°†æ•°æ®å‘é€ç»™Druidï¼Œè€Œä¸éœ€è¦å¯åŠ¨ä¸€ä¸ªJVMä¹‹ç±»çš„è¿›ç¨‹ã€‚</li></ul><blockquote><p>Tranquilityæ˜¯ç”¨scalaç¼–å†™çš„ï¼Œä¸»è¦æ˜¯é€šè¿‡Druid indexing serviceæ¥å®æ—¶æŠ½å–æ•°æ®ï¼Œå¼¥è¡¥Druid indexing service APIçš„ä¸è¶³</p></blockquote><ul><li>å®æ—¶æ‹‰å–æ•°æ®ï¼Œæ˜¯ä½¿ç”¨<em>Firehose</em>ä¸è¦è¯»å–çš„æ•°æ®è¿›è¡Œè¿æ¥ï¼Œç„¶åRealtimeèŠ‚ç‚¹å®æ—¶ä»ä¸­æŠ½å–æ•°æ®ã€‚</li></ul><blockquote><p>Firehoseæ˜¯ä¸€ä¸ªå¯æ’æ‹”çš„ç»„ä»¶ï¼Œæ˜¯Druidä¸­çš„æ¶ˆè´¹å®æ—¶æ•°æ®æ¨¡å‹ï¼Œå¯ä»¥æœ‰ä¸åŒçš„å®ç°ï¼ŒDruidè‡ªå¸¦äº†ä¸€ä¸ªåŸºäºKafka High Level APIå®ç°çš„å¯¹äºKafkaçš„æ•°æ®æ¶ˆè´¹ï¼ˆdruid-kafka-eight Firehoseï¼‰</p></blockquote><p>æ•°æ®æ¥å…¥æ—¶éœ€è¦æ³¨æ„ä¸€ä¸‹å‡ ç‚¹ï¼š</p><ul><li>æ•°æ®é›†åº”è¯¥è¢«ä»€ä¹ˆè°ƒç”¨ï¼Ÿç”±â€dataSchemaâ€çš„â€dataSourceâ€å­—æ®µè®¾ç½®</li><li>æ•°æ®é›†ä½äºä»€ä¹ˆä½ç½®ï¼Ÿæ–‡ä»¶è·¯å¾„åœ¨â€inputSpecâ€çš„â€pathsâ€ã€‚å¦‚æœåŠ è½½å¤šä¸ªæ–‡ä»¶ï¼Œå°†å­—ç¬¦ä¸²ä»¥é€—å·åˆ†éš”ã€‚</li><li>ä»€ä¹ˆå­—æ®µä½œä¸ºæ—¶é—´æˆ³ï¼Ÿç”±â€timestampSpecâ€çš„â€columnâ€å­—æ®µè®¾ç½®ã€‚</li><li>ä»€ä¹ˆå­—æ®µä½œä¸ºç»´åº¦ï¼Ÿç”±â€dimensionsSpecâ€çš„â€dimensionsâ€å­—æ®µè®¾ç½®ã€‚</li><li>ä»€ä¹ˆå­—æ®µä½œä¸ºåº¦é‡ï¼Ÿç”±â€metricsSpecâ€æ§åˆ¶ã€‚</li><li>ä»€ä¹ˆæ—¶é—´èŒƒå›´ï¼ˆæ—¶é—´é—´éš”ï¼‰è¢«åŠ è½½ï¼Ÿç”±â€granularitySpecâ€çš„â€intervalsâ€å­—æ®µè®¾ç½®ã€‚</li></ul><h3 id="æ•°æ®æ ¼å¼"><a href="#æ•°æ®æ ¼å¼" class="headerlink" title="æ•°æ®æ ¼å¼"></a>æ•°æ®æ ¼å¼</h3><p>Druidçš„æ•°æ®é›†æœ‰ä¸‰éƒ¨åˆ†ç»„æˆã€‚åˆ†åˆ«ä¸º</p><ul><li><p>Timestampåˆ—: å°†timestampåŒºåˆ«å¼€æ˜¯å› ä¸ºDruidæ˜¯ä¸€ä¸ªæ—¶é—´åºåˆ—çš„olapå·¥å…·ï¼Œå…¶ä¸­çš„æŸ¥è¯¢éƒ½ä»¥æ—¶é—´ä¸ºä¸­å¿ƒã€‚</p></li><li><p>Dimensionåˆ—: Dimensionså¯¹åº”äº‹ä»¶çš„ç»´åº¦ï¼Œé€šå¸¸ç”¨äºç­›é€‰è¿‡æ»¤æ•°æ®ã€‚</p></li><li><p>Metricåˆ—: Metricsæ˜¯ç”¨äº<em>èšåˆå’Œè®¡ç®—çš„åˆ—</em>ã€‚åœ¨OLAPçš„æœ¯è¯­ä¸­ä¹Ÿè¢«å«åšmeasuresã€‚</p></li></ul><h3 id="æ•°æ®æºé…ç½®"><a href="#æ•°æ®æºé…ç½®" class="headerlink" title="æ•°æ®æºé…ç½®"></a>æ•°æ®æºé…ç½®</h3><p>æ¥å…¥æ•°æ®ä¸éœ€è¦ä»£ç çš„å¼€å‘ï¼Œåªéœ€è¦è¿›è¡Œä¸€äº›é…ç½®ã€‚<br>ä¸‹é¢çœ‹ä¸ªä»HDFSæ¥å…¥æ•°æ®çš„demoï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;index_hadoop&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;spec&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;dataSchema&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;dataSource&quot;</span> : <span class="string">&quot;wikipedia&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;parser&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;hadoopyString&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;parseSpec&quot;</span> : &#123;</span><br><span class="line">          <span class="attr">&quot;format&quot;</span> : <span class="string">&quot;json&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;timestampSpec&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;column&quot;</span> : <span class="string">&quot;timestamp&quot;</span>,</span><br><span class="line">            <span class="attr">&quot;format&quot;</span> : <span class="string">&quot;auto&quot;</span></span><br><span class="line">          &#125;,</span><br><span class="line">          <span class="attr">&quot;dimensionsSpec&quot;</span> : &#123;</span><br><span class="line">            <span class="attr">&quot;dimensions&quot;</span>: [<span class="string">&quot;page&quot;</span>,<span class="string">&quot;language&quot;</span>,<span class="string">&quot;user&quot;</span>,<span class="string">&quot;unpatrolled&quot;</span>,<span class="string">&quot;newPage&quot;</span>,<span class="string">&quot;robot&quot;</span>,<span class="string">&quot;anonymous&quot;</span>,<span class="string">&quot;namespace&quot;</span>,<span class="string">&quot;continent&quot;</span>,<span class="string">&quot;country&quot;</span>,<span class="string">&quot;region&quot;</span>,<span class="string">&quot;city&quot;</span>],</span><br><span class="line">            <span class="attr">&quot;dimensionExclusions&quot;</span> : [],</span><br><span class="line">            <span class="attr">&quot;spatialDimensions&quot;</span> : []</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="attr">&quot;metricsSpec&quot;</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;count&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;count&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;doubleSum&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;added&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fieldName&quot;</span> : <span class="string">&quot;added&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;doubleSum&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;deleted&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fieldName&quot;</span> : <span class="string">&quot;deleted&quot;</span></span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;doubleSum&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;name&quot;</span> : <span class="string">&quot;delta&quot;</span>,</span><br><span class="line">          <span class="attr">&quot;fieldName&quot;</span> : <span class="string">&quot;delta&quot;</span></span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="attr">&quot;granularitySpec&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;uniform&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;segmentGranularity&quot;</span> : <span class="string">&quot;DAY&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;queryGranularity&quot;</span> : <span class="string">&quot;NONE&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;intervals&quot;</span> : [ <span class="string">&quot;2013-08-31/2013-09-01&quot;</span> ]</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;ioConfig&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;hadoop&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;inputSpec&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;type&quot;</span> : <span class="string">&quot;static&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;paths&quot;</span> : <span class="string">&quot;/MyDirectory/example/wikipedia_data.json&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;tuningConfig&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;hadoop&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;hadoopDependencyCoordinates&quot;</span>: <span class="string">&quot;my_hadoop_version&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç®€å•è§£é‡Šä¸‹è¿™äº›é…ç½®é¡¹ï¼š<br>jsonä¸­æœ€å¤–å±‚æœ‰3ä¸ªkeyï¼Œåˆ†åˆ«ä¸ºtypeã€specå’ŒhadoopDependencyCoordinatesï¼Œå‰ä¸¤ä¸ªæ˜¯å¿…é¡»çš„ã€‚<br>å¦‚æœä»HDFSä¸­åŠ è½½æ•°æ®ï¼Œ<code>type</code>å§‹ç»ˆæ˜¯<code>index_hadoop</code>ï¼Œ<code>spec</code>çš„valueæ˜¯æ•°æ®çš„ä¸€äº›ä¿¡æ¯ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªjsonã€‚<br>spec valueå°±æ˜¯DataSchemaï¼Œç”±dataSchemaã€ioConfigå’ŒtuningConfigï¼Œå¦‚æœtuningConfigä¸è®¾ç½®å°†æä¾›é»˜è®¤å€¼ã€‚<br>dataSchemaæè¿°äº†æ•°æ®æºçš„å…·ä½“ä¿¡æ¯ï¼ŒåŒ…æ‹¬æ•°æ®çš„æ ¼å¼ã€Timestampã€ç»´åº¦å’Œåº¦é‡ã€‚<br>ioConfigæè¿°äº†æ•°æ®ä»ä½•è€Œæ¥ï¼Œå’Œæœ€ç»ˆå»å‘å“ªé‡Œã€‚</p><h2 id="æŸ¥è¯¢"><a href="#æŸ¥è¯¢" class="headerlink" title="æŸ¥è¯¢"></a>æŸ¥è¯¢</h2><p>Druidçš„æŸ¥è¯¢è¯­è¨€æ˜¯jsonï¼Œé€šè¿‡HTTP RESTæäº¤ç»™å¯æŸ¥è¯¢çš„èŠ‚ç‚¹(Broker, Historical, or Realtime)ã€‚å®˜æ–¹ç›®å‰æš‚ä¸æ”¯æŒsqlæŸ¥è¯¢ï¼Œæœ‰ç¬¬ä¸‰æ–¹çš„æ’ä»¶å¯ä»¥æ”¯æŒsqlï¼Œä½†æ”¯æŒåº¦ä¸æ˜¯å¤ªå®Œç¾ã€‚</p><p>Druidæ”¯æŒçš„æŸ¥è¯¢åŒ…æ‹¬èšåˆæŸ¥è¯¢ã€æœç´¢æŸ¥è¯¢(ç±»ä¼¼æ¨¡ç³ŠåŒ¹é…)å’Œé€‰æ‹©æŸ¥è¯¢ã€‚</p><p>ä¸‹é¢ç®€å•çœ‹å‡ ä¸ªjsonæŸ¥è¯¢è¯­å¥ã€‚</p><ul><li>èšåˆæŸ¥è¯¢jsonè¯­å¥<br>èšåˆæŸ¥è¯¢æ¯”è¾ƒå¤æ‚ï¼Œåˆåˆ†ä¸º3ä¸ªå°ç±»ï¼Œåˆ†åˆ«ä¸ºtimeseriesã€topNå’ŒgroupByã€‚<br>è¿™é‡Œå±•ç¤ºä¸€ä¸ªtimeseriesçš„jsonè¯­å¥ï¼š</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;queryType&quot;</span>: <span class="string">&quot;timeseries&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dataSource&quot;</span>: <span class="string">&quot;sample_datasource&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;granularity&quot;</span>: <span class="string">&quot;day&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;descending&quot;</span>: <span class="string">&quot;true&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;filter&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;and&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;selector&quot;</span>, <span class="attr">&quot;dimension&quot;</span>: <span class="string">&quot;sample_dimension1&quot;</span>, <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;sample_value1&quot;</span> &#125;,</span><br><span class="line">      &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;or&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;selector&quot;</span>, <span class="attr">&quot;dimension&quot;</span>: <span class="string">&quot;sample_dimension2&quot;</span>, <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;sample_value2&quot;</span> &#125;,</span><br><span class="line">          &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;selector&quot;</span>, <span class="attr">&quot;dimension&quot;</span>: <span class="string">&quot;sample_dimension3&quot;</span>, <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;sample_value3&quot;</span> &#125;</span><br><span class="line">        ]</span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;aggregations&quot;</span>: [</span><br><span class="line">    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;longSum&quot;</span>, <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;sample_name1&quot;</span>, <span class="attr">&quot;fieldName&quot;</span>: <span class="string">&quot;sample_fieldName1&quot;</span> &#125;,</span><br><span class="line">    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;doubleSum&quot;</span>, <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;sample_name2&quot;</span>, <span class="attr">&quot;fieldName&quot;</span>: <span class="string">&quot;sample_fieldName2&quot;</span> &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;postAggregations&quot;</span>: [</span><br><span class="line">    &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;arithmetic&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;sample_divide&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fn&quot;</span>: <span class="string">&quot;/&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;fields&quot;</span>: [</span><br><span class="line">        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;fieldAccess&quot;</span>, <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;sample_name1&quot;</span>, <span class="attr">&quot;fieldName&quot;</span>: <span class="string">&quot;sample_fieldName1&quot;</span> &#125;,</span><br><span class="line">        &#123; <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;fieldAccess&quot;</span>, <span class="attr">&quot;name&quot;</span>: <span class="string">&quot;sample_name2&quot;</span>, <span class="attr">&quot;fieldName&quot;</span>: <span class="string">&quot;sample_fieldName2&quot;</span> &#125;</span><br><span class="line">      ]</span><br><span class="line">    &#125;</span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;intervals&quot;</span>: [ <span class="string">&quot;2012-01-01T00:00:00.000/2012-01-03T00:00:00.000&quot;</span> ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>timeseriesæ˜¯æŒ‰ç…§æŸæ®µæ—¶é—´åŒºé—´ä½œä¸ºæ•°æ®æŸ¥è¯¢åŒºé—´çš„ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯2012-01-01åˆ°2012-01-03çš„æ•°æ®ï¼Œåˆ†åˆ«å¯¹sample_fieldName1å’Œsample_fieldName2è¿›è¡Œèšåˆï¼Œæœ€åä¸¤ä¸ªèšåˆæŒ‡æ ‡ç›¸é™¤ã€‚ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2012-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;result&quot;</span>: &#123; <span class="attr">&quot;sample_name1&quot;</span>: <span class="string">&quot;some_value&quot;</span>, <span class="attr">&quot;sample_name2&quot;</span>: <span class="string">&quot;some_value&quot;</span>, <span class="attr">&quot;sample_divide&quot;</span>: <span class="string">&quot;some_value&quot;</span> &#125; </span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2012-01-02T00:00:00.000Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;result&quot;</span>: &#123; <span class="attr">&quot;sample_name1&quot;</span>: <span class="string">&quot;some_value&quot;</span>, <span class="attr">&quot;sample_name2&quot;</span>: <span class="string">&quot;some_value&quot;</span>, <span class="attr">&quot;sample_divide&quot;</span>: <span class="string">&quot;some_value&quot;</span> &#125;</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>æœç´¢æŸ¥è¯¢jsonè¯­å¥</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;queryType&quot;</span>: <span class="string">&quot;search&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dataSource&quot;</span>: <span class="string">&quot;sample_datasource&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;granularity&quot;</span>: <span class="string">&quot;day&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;searchDimensions&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;dim1&quot;</span>,</span><br><span class="line">    <span class="string">&quot;dim2&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;query&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;insensitive_contains&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Ke&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;sort&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;type&quot;</span>: <span class="string">&quot;lexicographic&quot;</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">&quot;intervals&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;2013-01-01T00:00:00.000/2013-01-03T00:00:00.000&quot;</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>searchDimensionså®šä¹‰äº†è¦åœ¨å“ªäº›ç»´åº¦ä¸­è¿›è¡Œæœç´¢ï¼Œqueryå®šä¹‰äº†æœç´¢æ–¹å¼(æœ¬è¯­å¥ä¸­çš„æ„æ€æ˜¯åŒ…å«Keçš„ç»´åº¦å€¼)ï¼Œç»“æœä¸ºï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">[</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2012-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;result&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;dimension&quot;</span>: <span class="string">&quot;dim1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Ke$ha&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;dimension&quot;</span>: <span class="string">&quot;dim2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;Ke$haForPresident&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="attr">&quot;timestamp&quot;</span>: <span class="string">&quot;2012-01-02T00:00:00.000Z&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;result&quot;</span>: [</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;dimension&quot;</span>: <span class="string">&quot;dim1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;SomethingThatContainsKe&quot;</span></span><br><span class="line">      &#125;,</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="attr">&quot;dimension&quot;</span>: <span class="string">&quot;dim2&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;value&quot;</span>: <span class="string">&quot;SomethingElseThatContainsKe&quot;</span></span><br><span class="line">      &#125;</span><br><span class="line">    ]</span><br><span class="line">  &#125;</span><br><span class="line">]</span><br></pre></td></tr></table></figure><ul><li>é€‰æ‹©æŸ¥è¯¢jsonè¯­å¥</li></ul><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="attr">&quot;queryType&quot;</span>: <span class="string">&quot;select&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dataSource&quot;</span>: <span class="string">&quot;wikipedia&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;descending&quot;</span>: <span class="string">&quot;false&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;dimensions&quot;</span>:[],</span><br><span class="line">  <span class="attr">&quot;metrics&quot;</span>:[],</span><br><span class="line">  <span class="attr">&quot;granularity&quot;</span>: <span class="string">&quot;all&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;intervals&quot;</span>: [</span><br><span class="line">    <span class="string">&quot;2013-01-01/2013-01-02&quot;</span></span><br><span class="line">  ],</span><br><span class="line">  <span class="attr">&quot;pagingSpec&quot;</span>:&#123;<span class="attr">&quot;pagingIdentifiers&quot;</span>: &#123;&#125;, <span class="attr">&quot;threshold&quot;</span>:<span class="number">5</span>&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>selectæŸ¥è¯¢æ”¯æŒåˆ†é¡µæ˜¾ç¤ºï¼ŒpagingSpecå®šä¹‰äº†åˆ†é¡µçš„ä¿¡æ¯ï¼Œè¿™é‡Œåªæ˜¾ç¤ºå‰5ä¸ªï¼Œç»“æœæ˜¾ç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br></pre></td><td class="code"><pre><span class="line">[&#123;</span><br><span class="line">  <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2013-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">  <span class="attr">&quot;result&quot;</span> : &#123;</span><br><span class="line">    <span class="attr">&quot;pagingIdentifiers&quot;</span> : &#123;</span><br><span class="line">      <span class="attr">&quot;wikipedia_2012-12-29T00:00:00.000Z_2013-01-10T08:00:00.000Z_2013-01-10T08:13:47.830Z_v9&quot;</span> : <span class="number">4</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="attr">&quot;events&quot;</span> : [ &#123;</span><br><span class="line">      <span class="attr">&quot;segmentId&quot;</span> : <span class="string">&quot;wikipedia_editstream_2012-12-29T00:00:00.000Z_2013-01-10T08:00:00.000Z_2013-01-10T08:13:47.830Z_v9&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;offset&quot;</span> : <span class="number">0</span>,</span><br><span class="line">      <span class="attr">&quot;event&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2013-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;robot&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;namespace&quot;</span> : <span class="string">&quot;article&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;anonymous&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;unpatrolled&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;page&quot;</span> : <span class="string">&quot;11._korpus_(NOVJ)&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;language&quot;</span> : <span class="string">&quot;sl&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;newpage&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user&quot;</span> : <span class="string">&quot;EmausBot&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;added&quot;</span> : <span class="number">39.0</span>,</span><br><span class="line">        <span class="attr">&quot;delta&quot;</span> : <span class="number">39.0</span>,</span><br><span class="line">        <span class="attr">&quot;variation&quot;</span> : <span class="number">39.0</span>,</span><br><span class="line">        <span class="attr">&quot;deleted&quot;</span> : <span class="number">0.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">&quot;segmentId&quot;</span> : <span class="string">&quot;wikipedia_2012-12-29T00:00:00.000Z_2013-01-10T08:00:00.000Z_2013-01-10T08:13:47.830Z_v9&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;offset&quot;</span> : <span class="number">1</span>,</span><br><span class="line">      <span class="attr">&quot;event&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2013-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;robot&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;namespace&quot;</span> : <span class="string">&quot;article&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;anonymous&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;unpatrolled&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;page&quot;</span> : <span class="string">&quot;112_U.S._580&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;language&quot;</span> : <span class="string">&quot;en&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;newpage&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user&quot;</span> : <span class="string">&quot;MZMcBride&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;added&quot;</span> : <span class="number">70.0</span>,</span><br><span class="line">        <span class="attr">&quot;delta&quot;</span> : <span class="number">70.0</span>,</span><br><span class="line">        <span class="attr">&quot;variation&quot;</span> : <span class="number">70.0</span>,</span><br><span class="line">        <span class="attr">&quot;deleted&quot;</span> : <span class="number">0.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">&quot;segmentId&quot;</span> : <span class="string">&quot;wikipedia_2012-12-29T00:00:00.000Z_2013-01-10T08:00:00.000Z_2013-01-10T08:13:47.830Z_v9&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;offset&quot;</span> : <span class="number">2</span>,</span><br><span class="line">      <span class="attr">&quot;event&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2013-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;robot&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;namespace&quot;</span> : <span class="string">&quot;article&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;anonymous&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;unpatrolled&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;page&quot;</span> : <span class="string">&quot;113_U.S._243&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;language&quot;</span> : <span class="string">&quot;en&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;newpage&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user&quot;</span> : <span class="string">&quot;MZMcBride&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;added&quot;</span> : <span class="number">77.0</span>,</span><br><span class="line">        <span class="attr">&quot;delta&quot;</span> : <span class="number">77.0</span>,</span><br><span class="line">        <span class="attr">&quot;variation&quot;</span> : <span class="number">77.0</span>,</span><br><span class="line">        <span class="attr">&quot;deleted&quot;</span> : <span class="number">0.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">&quot;segmentId&quot;</span> : <span class="string">&quot;wikipedia_2012-12-29T00:00:00.000Z_2013-01-10T08:00:00.000Z_2013-01-10T08:13:47.830Z_v9&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;offset&quot;</span> : <span class="number">3</span>,</span><br><span class="line">      <span class="attr">&quot;event&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2013-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;robot&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;namespace&quot;</span> : <span class="string">&quot;article&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;anonymous&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;unpatrolled&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;page&quot;</span> : <span class="string">&quot;113_U.S._73&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;language&quot;</span> : <span class="string">&quot;en&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;newpage&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user&quot;</span> : <span class="string">&quot;MZMcBride&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;added&quot;</span> : <span class="number">70.0</span>,</span><br><span class="line">        <span class="attr">&quot;delta&quot;</span> : <span class="number">70.0</span>,</span><br><span class="line">        <span class="attr">&quot;variation&quot;</span> : <span class="number">70.0</span>,</span><br><span class="line">        <span class="attr">&quot;deleted&quot;</span> : <span class="number">0.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;, &#123;</span><br><span class="line">      <span class="attr">&quot;segmentId&quot;</span> : <span class="string">&quot;wikipedia_2012-12-29T00:00:00.000Z_2013-01-10T08:00:00.000Z_2013-01-10T08:13:47.830Z_v9&quot;</span>,</span><br><span class="line">      <span class="attr">&quot;offset&quot;</span> : <span class="number">4</span>,</span><br><span class="line">      <span class="attr">&quot;event&quot;</span> : &#123;</span><br><span class="line">        <span class="attr">&quot;timestamp&quot;</span> : <span class="string">&quot;2013-01-01T00:00:00.000Z&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;robot&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;namespace&quot;</span> : <span class="string">&quot;article&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;anonymous&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;unpatrolled&quot;</span> : <span class="string">&quot;0&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;page&quot;</span> : <span class="string">&quot;113_U.S._756&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;language&quot;</span> : <span class="string">&quot;en&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;newpage&quot;</span> : <span class="string">&quot;1&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;user&quot;</span> : <span class="string">&quot;MZMcBride&quot;</span>,</span><br><span class="line">        <span class="attr">&quot;count&quot;</span> : <span class="number">1.0</span>,</span><br><span class="line">        <span class="attr">&quot;added&quot;</span> : <span class="number">68.0</span>,</span><br><span class="line">        <span class="attr">&quot;delta&quot;</span> : <span class="number">68.0</span>,</span><br><span class="line">        <span class="attr">&quot;variation&quot;</span> : <span class="number">68.0</span>,</span><br><span class="line">        <span class="attr">&quot;deleted&quot;</span> : <span class="number">0.0</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125; ]</span><br><span class="line">  &#125;</span><br><span class="line">&#125; ]</span><br></pre></td></tr></table></figure><h2 id="æ•°æ®ç”Ÿå‘½å‘¨æœŸ"><a href="#æ•°æ®ç”Ÿå‘½å‘¨æœŸ" class="headerlink" title="æ•°æ®ç”Ÿå‘½å‘¨æœŸ"></a>æ•°æ®ç”Ÿå‘½å‘¨æœŸ</h2><p>å¦‚æœæ•°æ®æ¥æºäºKafkaï¼Œåˆ™RealtimeèŠ‚ç‚¹ä»kafkaæ¶ˆè´¹æ•°æ®ï¼Œå®æ—¶æ•°æ®åœ¨RealtimeèŠ‚ç‚¹ä¸­åˆ›å»ºç´¢å¼•ï¼Œå­˜å…¥èŠ‚ç‚¹å†…å­˜ï¼Œå†…å­˜æ•°æ®é‡è¶…è¿‡é˜ˆå€¼æ—¶(æˆ–è€…å®šæœŸ)æ—¶ï¼Œå°†å†…å­˜æ•°æ®å†™åˆ°å¤–å­˜å½¢æˆå¤–å­˜ç´¢å¼•ã€‚ å†…å­˜æ•°æ®åŠ ä¸Šå¤šä¸ªå¤–å­˜ç´¢å¼•ï¼Œ RealtimeèŠ‚ç‚¹ä»¥è¿™ç§æ–¹å¼æ”¯æŒäºšç§’çº§æ•°æ®å¯è§æ€§ã€‚<br>ä½†æ˜¯RealtimeèŠ‚ç‚¹çš„å®¹é‡å’ŒæŸ¥è¯¢èƒ½åŠ›æ˜¯æœ‰é™çš„ï¼Œ æ‰€ä»¥å®ƒä¼šå®šæœŸåˆå¹¶å¤šä¸ªå¤–å­˜ç´¢å¼•ç”Ÿæˆsegmentï¼Œ(segmentå¯¹åº”ä¸€æ®µæ—¶é—´èŒƒå›´å†…çš„è¿›å…¥druidçš„æ•°æ®)ã€‚segmentç”Ÿæˆä¹‹åé©¬ä¸Šè¢«ä¸Šä¼ åˆ°deep storageï¼Œå¾ˆå¿«å°±ä¼šæœ‰HistoricalèŠ‚ç‚¹ä¸‹è½½è¯¥segmentï¼Œå¹¶æ›¿ä»£RealtimeèŠ‚ç‚¹æä¾›æŸ¥è¯¢æœåŠ¡ã€‚<br>HistorcialèŠ‚ç‚¹ä»DeepStorageä¸‹è½½segmentä¹‹åï¼Œç”±CoordinatorèŠ‚ç‚¹é€šè¿‡Zookeeperæ¥é€šçŸ¥HistorcialèŠ‚ç‚¹åŠ è½½æˆ–è€…åˆ é™¤segmentã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Druid </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Druid </tag>
            
            <tag> è°ƒç ” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java Synchronizedå®ç°åŸç†</title>
      <link href="/JavaSynchronizedTheory.html"/>
      <url>/JavaSynchronizedTheory.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/Java%E5%90%8C%E6%AD%A5%E9%94%81%E8%A7%A3%E6%9E%90.html">ä¹‹å‰ä¸€ç¯‡æ–‡ç« </a>ä»‹ç»äº†Synchronizedçš„ç”¨æ³•ï¼Œæœ¬ç¯‡ä»å®ç°åŸç†ä¸Šæ›´è¿›ä¸€æ­¥äº†è§£ä¸‹ã€‚</p><p>æŸ¥çœ‹å¸¦æœ‰<em>Synchronizedè¯­å¥å—</em>çš„classæ–‡ä»¶å¯ä»¥çœ‹åˆ°åœ¨åŒæ­¥ä»£ç å—çš„èµ·å§‹ä½ç½®æ’å…¥äº†<code>moniterenter</code>æŒ‡ä»¤ï¼Œåœ¨åŒæ­¥ä»£ç å—ç»“æŸçš„ä½ç½®æ’å…¥äº†<code>monitorexit</code>æŒ‡ä»¤ã€‚(JVMéœ€è¦ä¿è¯æ¯ä¸€ä¸ªmonitorenteréƒ½æœ‰ä¸€ä¸ªmonitorexitä¸ä¹‹ç›¸å¯¹åº”ï¼Œä½†æ¯ä¸ªmonitorexitä¸ä¸€å®šéƒ½æœ‰ä¸€ä¸ªmonitorenter)<br>ä½†æ˜¯æŸ¥çœ‹åŒæ­¥æ–¹æ³•çš„classæ–‡ä»¶æ—¶ï¼ŒåŒæ­¥æ–¹æ³•å¹¶æ²¡æœ‰é€šè¿‡æŒ‡ä»¤monitorenterå’Œmonitorexitæ¥å®Œæˆï¼Œè€Œè¢«ç¿»è¯‘æˆæ™®é€šçš„æ–¹æ³•è°ƒç”¨å’Œè¿”å›æŒ‡ä»¤ï¼Œåªæ˜¯åœ¨å…¶<strong>å¸¸é‡æ± ä¸­å¤šäº†ACC_SYNCHRONIZEDæ ‡ç¤ºç¬¦</strong>ã€‚JVMå°±æ˜¯æ ¹æ®è¯¥æ ‡ç¤ºç¬¦æ¥å®ç°æ–¹æ³•çš„åŒæ­¥çš„ï¼šå½“æ–¹æ³•è°ƒç”¨æ—¶ï¼Œè°ƒç”¨æŒ‡ä»¤å°†ä¼šæ£€æŸ¥æ–¹æ³•çš„ ACC_SYNCHRONIZED è®¿é—®æ ‡å¿—æ˜¯å¦è¢«è®¾ç½®ï¼Œå¦‚æœè®¾ç½®äº†ï¼Œæ‰§è¡Œçº¿ç¨‹å°†å…ˆè·å–monitorï¼Œè·å–æˆåŠŸä¹‹åæ‰èƒ½æ‰§è¡Œæ–¹æ³•ä½“ï¼Œæ–¹æ³•æ‰§è¡Œå®Œåå†é‡Šæ”¾monitorã€‚åœ¨æ–¹æ³•æ‰§è¡ŒæœŸé—´ï¼Œå…¶ä»–ä»»ä½•çº¿ç¨‹éƒ½æ— æ³•å†è·å¾—åŒä¸€ä¸ªmonitorå¯¹è±¡ã€‚ <em>å…¶å®æœ¬è´¨ä¸Šæ²¡æœ‰åŒºåˆ«ï¼Œåªæ˜¯æ–¹æ³•çš„åŒæ­¥æ˜¯ä¸€ç§éšå¼çš„æ–¹å¼æ¥å®ç°ï¼Œæ— éœ€é€šè¿‡å­—èŠ‚ç æ¥å®Œæˆ</em>ã€‚</p><p>moniterenterå’ŒmoniterexitæŒ‡ä»¤æ˜¯é€šè¿‡monitorå¯¹è±¡å®ç°çš„ã€‚<br>Synchronizedçš„å®ç°ä¸ä»…ä¸monitorå¯¹è±¡æœ‰å…³ï¼Œè¿˜ä¸å¦ä¸€ä¸ªä¸œè¥¿å¯†åˆ‡ç›¸å…³ï¼Œé‚£å°±æ˜¯<strong>å¯¹è±¡å¤´</strong>ã€‚</p><span id="more"></span><p>ä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹ä¸‹Javaå¯¹è±¡å¤´å’Œmonitorå¯¹è±¡ä¸Synchronizedçš„å®ç°æœ‰ç€æ€æ ·çš„å…³ç³»ã€‚</p><p>JVMè§„èŒƒä¸­å¯¹monitorenterå’ŒmonitorexitæŒ‡ä»¤çš„æè¿°å¦‚ä¸‹ï¼š<br>monitorenter ï¼š<br>Each object is associated with a monitor. A monitor is locked if and only if it has an owner. The thread that executes monitorenter attempts to gain ownership of the monitor associated with objectref, as follows:<br>â€¢ If the entry count of the monitor associated with objectref is zero, the thread enters the monitor and sets its entry count to one. The thread is then the owner of the monitor.<br>â€¢ If the thread already owns the monitor associated with objectref, it reenters the monitor, incrementing its entry count.<br>â€¢ If another thread already owns the monitor associated with objectref, the thread blocks until the monitorâ€™s entry count is zero, then tries again to gain ownership.</p><p>è¿™æ®µè¯çš„å¤§æ¦‚æ„æ€ä¸ºï¼š<br>æ¯ä¸ªå¯¹è±¡éƒ½æœ‰ä¸€ä¸ªç›‘è§†å™¨é”(monitor)ä¸ä¹‹å¯¹åº”ã€‚å½“monitorè¢«å ç”¨æ—¶å°±ä¼šå¤„äºé”å®šçŠ¶æ€ï¼Œçº¿ç¨‹æ‰§è¡ŒmonitorenteræŒ‡ä»¤æ—¶å°è¯•è·å–monitorçš„æ‰€æœ‰æƒï¼Œè¿‡ç¨‹å¦‚ä¸‹ï¼š<br>1ã€å¦‚æœmonitorçš„è¿›å…¥æ•°ä¸º0ï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥monitorï¼Œç„¶åå°†è¿›å…¥æ•°è®¾ç½®ä¸º1ï¼Œè¯¥çº¿ç¨‹å³ä¸ºmonitorçš„æ‰€æœ‰è€…ã€‚<br>2ã€å¦‚æœçº¿ç¨‹å·²ç»å æœ‰è¯¥monitorï¼Œåªæ˜¯é‡æ–°è¿›å…¥ï¼Œåˆ™è¿›å…¥monitorçš„è¿›å…¥æ•°åŠ 1.<br>3.å¦‚æœå…¶ä»–çº¿ç¨‹å·²ç»å ç”¨äº†monitorï¼Œåˆ™è¯¥çº¿ç¨‹è¿›å…¥é˜»å¡çŠ¶æ€ï¼Œç›´åˆ°monitorçš„è¿›å…¥æ•°ä¸º0ï¼Œå†é‡æ–°å°è¯•è·å–monitorçš„æ‰€æœ‰æƒã€‚</p><p>monitorexitï¼šã€€<br>The thread that executes monitorexit must be the owner of the monitor associated with the instance referenced by objectref.<br>The thread decrements the entry count of the monitor associated with objectref. If as a result the value of the entry count is zero, the thread exits the monitor and is no longer its owner. Other threads that are blocking to enter the monitor are allowed to attempt to do so.</p><p>è¿™æ®µè¯çš„å¤§æ¦‚æ„æ€ä¸ºï¼š<br>æ‰§è¡Œmonitorexitçš„çº¿ç¨‹å¿…é¡»æ˜¯objectrefæ‰€å¯¹åº”çš„monitorçš„æ‰€æœ‰è€…ã€‚<br>æŒ‡ä»¤æ‰§è¡Œæ—¶ï¼Œmonitorçš„è¿›å…¥æ•°å‡1ï¼Œå¦‚æœå‡1åè¿›å…¥æ•°ä¸º0ï¼Œé‚£çº¿ç¨‹é€€å‡ºmonitorï¼Œä¸å†æ˜¯è¿™ä¸ªmonitorçš„æ‰€æœ‰è€…ã€‚å…¶ä»–è¢«è¿™ä¸ªmonitoré˜»å¡çš„çº¿ç¨‹å¯ä»¥å°è¯•å»è·å–è¿™ä¸ªmonitorçš„æ‰€æœ‰æƒã€‚ </p><ul><li>é€šè¿‡è¿™ä¸¤ä¸ªæŒ‡ä»¤æˆ‘ä»¬åº”è¯¥èƒ½å¾ˆæ¸…æ¥šçš„çœ‹å‡ºSynchronizedçš„å®ç°åŸç†ï¼Œ<strong>Synchronizedçš„è¯­ä¹‰åº•å±‚æ˜¯é€šè¿‡ä¸€ä¸ªmonitorçš„å¯¹è±¡æ¥å®Œæˆ</strong>ï¼Œå…¶å®wait/notifyç­‰æ–¹æ³•ä¹Ÿä¾èµ–äºmonitorå¯¹è±¡ï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆåªæœ‰åœ¨åŒæ­¥çš„å—æˆ–è€…æ–¹æ³•ä¸­æ‰èƒ½è°ƒç”¨wait/notifyç­‰æ–¹æ³•ï¼Œå¦åˆ™ä¼šæŠ›å‡ºjava.lang.IllegalMonitorStateExceptionçš„å¼‚å¸¸çš„åŸå› ã€‚</li></ul><h2 id="Javaå¯¹è±¡å¤´"><a href="#Javaå¯¹è±¡å¤´" class="headerlink" title="Javaå¯¹è±¡å¤´"></a>Javaå¯¹è±¡å¤´</h2><p>ä¸‹é¢é‡ç‚¹è¯´ä¸‹javaå¯¹è±¡å¤´ã€‚</p><blockquote><p>ä¼—æ‰€å‘¨çŸ¥Javaä¸­ä¸‡ç‰©çš†å¯¹è±¡ï¼Œé‚£å¯¹è±¡åœ¨å†…å­˜ä¸­æ˜¯æ€ä¹ˆå­˜å‚¨çš„å‘¢ï¼Ÿ</p></blockquote><p>æ¯ä¸ªå¯¹è±¡åˆ†ä¸ºä¸‰å—åŒºåŸŸ:<em>å¯¹è±¡å¤´ã€å®ä¾‹æ•°æ®å’Œå¯¹é½å¡«å……</em>ã€‚ </p><ul><li>å¯¹è±¡å¤´åŒ…å«ä¸¤éƒ¨åˆ†ï¼Œç¬¬ä¸€éƒ¨åˆ†æ˜¯Mark Wordï¼Œç”¨äºå­˜å‚¨å¯¹è±¡è‡ªèº«çš„è¿è¡Œæ—¶æ•°æ®ï¼Œå¦‚å“ˆå¸Œç ï¼ˆHashCodeï¼‰ã€GCåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€æ ‡å¿—ã€çº¿ç¨‹æŒæœ‰çš„é”ã€åå‘çº¿ç¨‹ IDã€åå‘æ—¶é—´æˆ³ç­‰ç­‰ï¼Œè¿™ä¸€éƒ¨åˆ†å ä¸€ä¸ªå­—èŠ‚ã€‚ç¬¬äºŒéƒ¨åˆ†æ˜¯Klass Pointerï¼ˆç±»å‹æŒ‡é’ˆï¼‰ï¼Œæ˜¯å¯¹è±¡æŒ‡å‘å®ƒçš„ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼Œ<em>è™šæ‹Ÿæœºé€šè¿‡è¿™ä¸ªæŒ‡é’ˆæ¥ç¡®å®šè¿™ä¸ªå¯¹è±¡æ˜¯å“ªä¸ªç±»çš„å®ä¾‹</em>ï¼Œè¿™éƒ¨åˆ†ä¹Ÿå ä¸€ä¸ªå­—èŠ‚ã€‚(<em>å¦‚æœå¯¹è±¡æ˜¯æ•°ç»„ç±»å‹çš„ï¼Œåˆ™éœ€è¦3ä¸ªå­—èŠ‚æ¥å­˜å‚¨å¯¹è±¡å¤´ï¼Œå› ä¸ºè¿˜éœ€è¦ä¸€ä¸ªå­—èŠ‚å­˜å‚¨æ•°ç»„çš„é•¿åº¦</em>)</li><li>å®ä¾‹æ•°æ®å­˜æ”¾çš„æ˜¯ç±»å±æ€§æ•°æ®ä¿¡æ¯ï¼ŒåŒ…æ‹¬çˆ¶ç±»çš„å±æ€§ä¿¡æ¯ï¼Œå¦‚æœæ˜¯æ•°ç»„çš„å®ä¾‹éƒ¨åˆ†è¿˜åŒ…æ‹¬æ•°ç»„çš„é•¿åº¦ï¼Œ<em>è¿™éƒ¨åˆ†å†…å­˜æŒ‰4å­—èŠ‚å¯¹é½</em>ã€‚</li><li>å¡«å……æ•°æ®æ˜¯å› ä¸ºè™šæ‹Ÿæœºè¦æ±‚å¯¹è±¡èµ·å§‹åœ°å€å¿…é¡»æ˜¯8å­—èŠ‚çš„æ•´æ•°å€ã€‚å¡«å……æ•°æ®ä¸æ˜¯å¿…é¡»å­˜åœ¨çš„ï¼Œä»…ä»…æ˜¯ä¸ºäº†å­—èŠ‚å¯¹é½ã€‚</li></ul><p>å¯¹è±¡å¤´ä¿¡æ¯æ˜¯ä¸å¯¹è±¡è‡ªèº«å®šä¹‰çš„æ•°æ®æ— å…³çš„é¢å¤–å­˜å‚¨æˆæœ¬ï¼Œè€ƒè™‘åˆ°è™šæ‹Ÿæœºçš„ç©ºé—´æ•ˆç‡ï¼ŒMark Wordè¢«è®¾è®¡æˆä¸€ä¸ªéå›ºå®šçš„æ•°æ®ç»“æ„ä»¥ä¾¿åœ¨æå°çš„ç©ºé—´å†…å­˜å‚¨å°½é‡å¤šçš„ä¿¡æ¯ï¼Œå®ƒä¼šæ ¹æ®å¯¹è±¡çš„çŠ¶æ€å¤ç”¨è‡ªå·±çš„å­˜å‚¨ç©ºé—´ã€‚ä¾‹å¦‚åœ¨32ä½çš„HotSpotè™šæ‹Ÿæœº ä¸­å¯¹è±¡æœªè¢«é”å®šçš„çŠ¶æ€ä¸‹ï¼ŒMark Wordçš„32ä¸ªBitsç©ºé—´ä¸­çš„25Bitsç”¨äºå­˜å‚¨å¯¹è±¡å“ˆå¸Œç (HashCode)ï¼Œ4Bitsç”¨äºå­˜å‚¨å¯¹è±¡åˆ†ä»£å¹´é¾„ï¼Œ2Bitsç”¨äºå­˜å‚¨é”æ ‡å¿— ä½ï¼Œ1Bitå›ºå®šä¸º0ï¼Œåœ¨å…¶ä»–çŠ¶æ€(è½»é‡çº§é”å®šã€é‡é‡çº§é”å®šã€GCæ ‡è®°ã€å¯åå‘)ä¸‹å¯¹è±¡çš„å­˜å‚¨å†…å®¹å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚<br><img src="/blogimgs/javaSynchronized/ObjectHead.png" alt="å¯¹è±¡å¤´å­˜å‚¨ç»“æ„" title="å¯¹è±¡å¤´å­˜å‚¨ç»“æ„"></p><p>Synchronizedé€šå¸¸è¢«ç§°ä¸ºé‡é‡çº§é”ï¼Œä½†æ˜¯1.6ä¹‹åå¯¹å…¶è¿›è¡Œä¼˜åŒ–ï¼Œ<em>æ–°å¢äº†è½»é‡çº§é”å’Œåå‘é”</em>ï¼Œè¿™é‡Œé‡ç‚¹è¯´ä¸‹é‡é‡çº§é”ï¼Œéšåå¯¹Synchronizedçš„ä¼˜åŒ–ç®€å•ä»‹ç»ä¸‹ã€‚</p><p>ä»å¯¹è±¡å¤´çš„å­˜å‚¨å†…å®¹å¯ä»¥çœ‹å‡º<strong>é”çš„çŠ¶æ€éƒ½ä¿å­˜åœ¨å¯¹è±¡å¤´</strong>ä¸­ï¼ŒSynchronizedä¹Ÿä¸ä¾‹å¤–ï¼Œå½“å…¶ä»è½»é‡çº§é”è†¨èƒ€ä¸ºé‡é‡çº§é”æ—¶ï¼Œé”æ ‡è¯†ä½ä¸º10ï¼Œå…¶ä¸­<em>æŒ‡é’ˆæŒ‡å‘çš„æ˜¯monitorå¯¹è±¡</em>(ä¹Ÿç§°ä¸ºç®¡ç¨‹æˆ–ç›‘è§†å™¨é”)çš„èµ·å§‹åœ°å€ã€‚</p><p>å…³äºSynchronizedçš„å®ç°åœ¨javaå¯¹è±¡å¤´é‡Œè¾ƒä¸ºç®€å•ï¼Œåªæ˜¯æ”¹å˜ä¸€ä¸‹æ ‡è¯†ä½ï¼Œå¹¶å°†æŒ‡é’ˆæŒ‡å‘monitorå¯¹è±¡çš„èµ·å§‹åœ°å€ï¼Œå…¶å®ç°çš„é‡ç‚¹æ˜¯monitorå¯¹è±¡ã€‚<br>ä¸‹é¢ä»‹ç»ä¸‹monitorå¯¹è±¡ã€‚</p><h2 id="Monitorå¯¹è±¡"><a href="#Monitorå¯¹è±¡" class="headerlink" title="Monitorå¯¹è±¡"></a>Monitorå¯¹è±¡</h2><p>ä»€ä¹ˆæ˜¯Monitorï¼Ÿæˆ‘ä»¬å¯ä»¥æŠŠå®ƒç†è§£ä¸ºä¸€ä¸ªåŒæ­¥å·¥å…·ï¼Œä¹Ÿå¯ä»¥æè¿°ä¸ºä¸€ç§åŒæ­¥æœºåˆ¶ï¼Œå®ƒé€šå¸¸è¢«æè¿°ä¸ºä¸€ä¸ªå¯¹è±¡ã€‚<br>åœ¨Javaè™šæ‹Ÿæœº(HotSpot)ä¸­ï¼Œmonitoræ˜¯ç”±ObjectMonitorå®ç°çš„ï¼Œå…¶ä¸»è¦æ•°æ®ç»“æ„å¦‚ä¸‹(ä½äºHotSpotè™šæ‹Ÿæœºæºç ObjectMonitor.hppæ–‡ä»¶ï¼ŒC++å®ç°çš„)<br>ObjectMonitorä¸­æœ‰å‡ ä¸ªå…³é”®å±æ€§ï¼Œ</p><ul><li>_countç”¨æ¥è®°å½•è¯¥çº¿ç¨‹è·å–é”çš„æ¬¡æ•°</li><li>_WaitSetå­˜æ”¾å¤„äºwaitçŠ¶æ€çš„çº¿ç¨‹é˜Ÿåˆ—</li><li>_EntryListå­˜æ”¾å¤„äºç­‰å¾…è·å–é”blockçŠ¶æ€çš„çº¿ç¨‹é˜Ÿåˆ—ï¼Œå³è¢«é˜»å¡çš„çº¿ç¨‹</li><li>_owneræŒ‡å‘æŒæœ‰ObjectMonitorå¯¹è±¡çš„çº¿ç¨‹</li></ul><p>å½“å¤šä¸ªçº¿ç¨‹åŒæ—¶è®¿é—®ä¸€æ®µåŒæ­¥ä»£ç æ—¶ï¼Œé¦–å…ˆä¼šè¿›å…¥<code>_EntryList</code>é˜Ÿåˆ—ä¸­ï¼Œå½“æŸä¸ªçº¿ç¨‹è·å–åˆ°å¯¹è±¡çš„monitoråè¿›å…¥_OwneråŒºåŸŸå¹¶æŠŠmonitorä¸­çš„<code>_owner</code>å˜é‡è®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ï¼ŒåŒæ—¶monitorä¸­çš„è®¡æ•°å™¨<code>_count</code>åŠ 1ï¼Œè‹¥çº¿ç¨‹è°ƒç”¨<code>wait()</code>æ–¹æ³•ï¼Œå°†é‡Šæ”¾å½“å‰æŒæœ‰çš„monitorï¼Œ<code>_owner</code>å˜é‡æ¢å¤ä¸ºnullï¼Œ<code>_count</code>è‡ªå‡1ï¼ŒåŒæ—¶è¯¥çº¿ç¨‹è¿›å…¥<code>_WaitSet</code>é›†åˆä¸­ç­‰å¾…è¢«å”¤é†’ã€‚è‹¥å½“å‰çº¿ç¨‹æ‰§è¡Œå®Œæ¯•ä¹Ÿå°†é‡Šæ”¾monitor(é”)å¹¶å¤ä½å˜é‡çš„å€¼ï¼Œä»¥ä¾¿å…¶ä»–çº¿ç¨‹è¿›å…¥è·å–monitor(é”)ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º<br><img src="/blogimgs/javaSynchronized/monitor.png" alt="Monitoré”å¯¹è±¡çŠ¶æ€è½¬æ¢" title="Monitoré”å¯¹è±¡çŠ¶æ€è½¬æ¢"></p><h2 id="Synchronizedä¼˜åŒ–"><a href="#Synchronizedä¼˜åŒ–" class="headerlink" title="Synchronizedä¼˜åŒ–"></a>Synchronizedä¼˜åŒ–</h2><p>æ—©æœŸï¼ŒSynchronizedå±äºé‡é‡çº§é”ï¼Œæ•ˆç‡ä½ä¸‹ï¼Œå› ä¸ºç›‘è§†å™¨é”(monitor)æ˜¯ä¾èµ–äºåº•å±‚çš„æ“ä½œç³»ç»Ÿçš„Mutex Lockæ¥å®ç°çš„ï¼Œè€Œ<em>æ“ä½œç³»ç»Ÿå®ç°çº¿ç¨‹ä¹‹é—´çš„åˆ‡æ¢æ—¶éœ€è¦ä»ç”¨æˆ·æ€è½¬æ¢åˆ°æ ¸å¿ƒæ€</em>ï¼Œ<strong>è¿™ä¸ªçŠ¶æ€ä¹‹é—´çš„è½¬æ¢éœ€è¦ç›¸å¯¹æ¯”è¾ƒé•¿çš„æ—¶é—´ï¼Œæ—¶é—´æˆæœ¬ç›¸å¯¹è¾ƒé«˜ï¼Œè¿™ä¹Ÿæ˜¯ä¸ºä»€ä¹ˆæ—©æœŸçš„synchronizedæ•ˆç‡ä½çš„åŸå› </strong>ã€‚åº†å¹¸çš„æ˜¯åœ¨Java 6ä¹‹åJavaå®˜æ–¹å¯¹ä»JVMå±‚é¢å¯¹synchronizedè¾ƒå¤§ä¼˜åŒ–ï¼Œæ‰€ä»¥ç°åœ¨çš„synchronizedé”æ•ˆç‡ä¹Ÿä¼˜åŒ–å¾—å¾ˆä¸é”™äº†ï¼ŒJava 6ä¹‹åï¼Œä¸ºäº†å‡å°‘è·å¾—é”å’Œé‡Šæ”¾é”æ‰€å¸¦æ¥çš„æ€§èƒ½æ¶ˆè€—ï¼Œå¼•å…¥äº†åå‘é”ã€è½»é‡çº§é”å’Œè‡ªæ—‹é”ç­‰æ¦‚å¿µï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°†ç®€å•äº†è§£ä¸€ä¸‹Javaå®˜æ–¹åœ¨JVMå±‚é¢å¯¹Synchronizedé”çš„ä¼˜åŒ–ã€‚</p><h3 id="åå‘é”"><a href="#åå‘é”" class="headerlink" title="åå‘é”"></a>åå‘é”</h3><p>å¼•å…¥åå‘é”çš„ä¸»è¦åŸå› æ˜¯ï¼Œ<em>ç»è¿‡ç ”ç©¶å‘ç°ï¼Œåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œé”ä¸ä»…ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰ï¼Œè€Œä¸”æ€»æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œå› æ­¤ä¸ºäº†å‡å°‘åŒä¸€çº¿ç¨‹è·å–é”(ä¼šæ¶‰åŠåˆ°ä¸€äº›CASæ“ä½œ,è€—æ—¶)çš„ä»£ä»·è€Œå¼•å…¥åå‘é”</em>ã€‚<br>å¼•å…¥çš„ä¸»è¦ç›®çš„æ˜¯ï¼Œ<em>ä¸ºäº†åœ¨æ— å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µä¸‹å°½é‡å‡å°‘ä¸å¿…è¦çš„è½»é‡çº§é”æ‰§è¡Œè·¯å¾„</em>ã€‚å› ä¸ºè½»é‡çº§é”çš„è·å–åŠé‡Šæ”¾ä¾èµ–å¤šæ¬¡CASåŸå­æŒ‡ä»¤ï¼Œ<em>è€Œåå‘é”åªéœ€è¦åœ¨ç½®æ¢ThreadIDçš„æ—¶å€™ä¾èµ–ä¸€æ¬¡CASåŸå­æŒ‡ä»¤</em>ï¼ˆç”±äºä¸€æ—¦å‡ºç°å¤šçº¿ç¨‹ç«äº‰çš„æƒ…å†µå°±å¿…é¡»æ’¤é”€åå‘é”ï¼Œæ‰€ä»¥åå‘é”çš„æ’¤é”€æ“ä½œçš„æ€§èƒ½æŸè€—å¿…é¡»å°äºèŠ‚çœä¸‹æ¥çš„CASåŸå­æŒ‡ä»¤çš„æ€§èƒ½æ¶ˆè€—ï¼‰ã€‚<br>åå‘é”çš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼Œå¦‚æœä¸€ä¸ªçº¿ç¨‹è·å¾—äº†é”ï¼Œé‚£ä¹ˆé”å°±è¿›å…¥åå‘æ¨¡å¼ï¼Œæ­¤æ—¶Mark Word çš„ç»“æ„ä¹Ÿå˜ä¸ºåå‘é”ç»“æ„ï¼Œå½“è¿™ä¸ªçº¿ç¨‹å†æ¬¡è¯·æ±‚é”æ—¶ï¼Œæ— éœ€å†åšä»»ä½•åŒæ­¥æ“ä½œï¼Œå³è·å–é”çš„è¿‡ç¨‹ï¼Œè¿™æ ·å°±çœå»äº†å¤§é‡æœ‰å…³é”ç”³è¯·çš„æ“ä½œï¼Œä»è€Œä¹Ÿå°±æå‡ç¨‹åºçš„æ€§èƒ½ã€‚æ‰€ä»¥ï¼Œå¯¹äºæ²¡æœ‰é”ç«äº‰çš„åœºåˆï¼Œåå‘é”æœ‰å¾ˆå¥½çš„ä¼˜åŒ–æ•ˆæœï¼Œæ¯•ç«Ÿææœ‰å¯èƒ½è¿ç»­å¤šæ¬¡æ˜¯åŒä¸€ä¸ªçº¿ç¨‹ç”³è¯·ç›¸åŒçš„é”ã€‚<br>ä½†æ˜¯å¯¹äºé”ç«äº‰æ¯”è¾ƒæ¿€çƒˆçš„åœºåˆï¼Œåå‘é”å°±å¤±æ•ˆäº†ï¼Œå› ä¸ºè¿™æ ·åœºåˆææœ‰å¯èƒ½æ¯æ¬¡ç”³è¯·é”çš„çº¿ç¨‹éƒ½æ˜¯ä¸ç›¸åŒçš„ï¼Œå› æ­¤è¿™ç§åœºåˆä¸‹ä¸åº”è¯¥ä½¿ç”¨åå‘é”ï¼Œå¦åˆ™ä¼šå¾—ä¸å¿å¤±ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œåå‘é”å¤±è´¥åï¼Œå¹¶ä¸ä¼šç«‹å³è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œè€Œæ˜¯å…ˆå‡çº§ä¸ºè½»é‡çº§é”ã€‚</p><p>å…¶æ‰§è¡Œæµç¨‹ä¸ºï¼š<br>è·å–é” </p><ol><li>æ£€æµ‹Mark Wordæ˜¯å¦ä¸ºå¯åå‘çŠ¶æ€ï¼Œå³æ˜¯å¦ä¸ºåå‘é”1ï¼Œé”æ ‡è¯†ä½ä¸º01ï¼› </li><li>è‹¥ä¸ºå¯åå‘çŠ¶æ€ï¼Œåˆ™æµ‹è¯•çº¿ç¨‹IDæ˜¯å¦ä¸ºå½“å‰çº¿ç¨‹IDï¼Œå¦‚æœæ˜¯ï¼Œåˆ™æ‰§è¡Œæ­¥éª¤(5)ï¼Œå¦åˆ™æ‰§è¡Œæ­¥éª¤(3)ï¼› </li><li>å¦‚æœçº¿ç¨‹IDä¸ä¸ºå½“å‰çº¿ç¨‹IDï¼Œåˆ™<strong>é€šè¿‡CASæ“ä½œç«äº‰é”</strong>ï¼Œç«äº‰æˆåŠŸï¼Œåˆ™å°†Mark Wordçš„çº¿ç¨‹IDæ›¿æ¢ä¸ºå½“å‰çº¿ç¨‹IDï¼Œå¦åˆ™æ‰§è¡Œçº¿ç¨‹(4)ï¼› </li><li>é€šè¿‡CASç«äº‰é”å¤±è´¥ï¼Œè¯æ˜å½“å‰å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰æƒ…å†µï¼Œå½“åˆ°è¾¾å…¨å±€å®‰å…¨ç‚¹ï¼Œè·å¾—åå‘é”çš„çº¿ç¨‹è¢«æŒ‚èµ·ï¼Œåå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œç„¶åè¢«é˜»å¡åœ¨å®‰å…¨ç‚¹çš„çº¿ç¨‹ç»§ç»­å¾€ä¸‹æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼› </li><li>æ‰§è¡ŒåŒæ­¥ä»£ç å—</li></ol><p>é‡Šæ”¾é”<br>åå‘é”çš„é‡Šæ”¾é‡‡ç”¨äº†ä¸€ç§åªæœ‰ç«äº‰æ‰ä¼šé‡Šæ”¾é”çš„æœºåˆ¶ï¼Œçº¿ç¨‹æ˜¯ä¸ä¼šä¸»åŠ¨å»é‡Šæ”¾åå‘é”ï¼Œéœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹æ¥ç«äº‰ã€‚åå‘é”çš„æ’¤é”€éœ€è¦ç­‰å¾…å…¨å±€å®‰å…¨ç‚¹ï¼ˆè¿™ä¸ªæ—¶é—´ç‚¹æ˜¯ä¸Šæ²¡æœ‰æ­£åœ¨æ‰§è¡Œçš„ä»£ç ï¼‰ã€‚å…¶æ­¥éª¤å¦‚ä¸‹ï¼š </p><ol><li>æš‚åœæ‹¥æœ‰åå‘é”çš„çº¿ç¨‹ï¼Œåˆ¤æ–­é”å¯¹è±¡çŸ³æ˜¯å¦è¿˜å¤„äºè¢«é”å®šçŠ¶æ€ï¼› </li><li>æ’¤é”€åå‘è‹ï¼Œæ¢å¤åˆ°æ— é”çŠ¶æ€(01)æˆ–è€…è½»é‡çº§é”çš„çŠ¶æ€ï¼›</li></ol><blockquote><p>é‚£ä¹ˆè½»é‡çº§é”å’Œåå‘é”çš„ä½¿ç”¨åœºæ™¯ä¸º<br>è½»é‡çº§é”æ˜¯ä¸ºäº†åœ¨<strong>çº¿ç¨‹äº¤æ›¿</strong>æ‰§è¡ŒåŒæ­¥å—æ—¶æé«˜æ€§èƒ½ï¼Œè€Œåå‘é”åˆ™æ˜¯åœ¨åªæœ‰ä¸€ä¸ªçº¿ç¨‹æ‰§è¡ŒåŒæ­¥å—æ—¶è¿›ä¸€æ­¥æé«˜æ€§èƒ½ã€‚</p></blockquote><h3 id="è½»é‡çº§é”"><a href="#è½»é‡çº§é”" class="headerlink" title="è½»é‡çº§é”"></a>è½»é‡çº§é”</h3><p>å¼•å…¥è½»é‡çº§é”çš„ä¸»è¦åŸå› æ˜¯ï¼Œ<em>å¯¹ç»å¤§éƒ¨åˆ†çš„é”ï¼Œåœ¨æ•´ä¸ªåŒæ­¥å‘¨æœŸå†…éƒ½ä¸å­˜åœ¨ç«äº‰</em>ï¼Œå¯èƒ½æ˜¯äº¤æ›¿è·å–é”ç„¶åæ‰§è¡Œã€‚(<strong>ä¸åå‘é”çš„åŒºåˆ«æ˜¯ï¼Œå¼•å…¥åå‘é”æ˜¯å‡è®¾åŒä¸€ä¸ªé”éƒ½æ˜¯ç”±åŒä¸€çº¿ç¨‹å¤šæ¬¡è·å¾—ï¼Œè€Œè½»é‡çº§é”æ˜¯å‡è®¾åŒä¸€ä¸ªé”æ˜¯ç”±nä¸ªçº¿ç¨‹äº¤æ›¿è·å¾—ï¼›ç›¸åŒç‚¹æ˜¯éƒ½æ˜¯å‡è®¾ä¸å­˜åœ¨å¤šçº¿ç¨‹ç«äº‰</strong>)<br>å¼•å…¥è½»é‡çº§é”çš„ä¸»è¦ç›®çš„æ˜¯ï¼Œåœ¨æ²¡æœ‰å¤šçº¿ç¨‹ç«äº‰çš„å‰æä¸‹ï¼Œ<em>å‡å°‘ä¼ ç»Ÿçš„é‡é‡çº§é”ä½¿ç”¨æ“ä½œç³»ç»Ÿäº’æ–¥é‡äº§ç”Ÿçš„æ€§èƒ½æ¶ˆè€—(å¤šæŒ‡æ—¶é—´æ¶ˆè€—)<em>ã€‚<br>è§¦å‘è½»é‡çº§é”çš„æ¡ä»¶æ˜¯</em>å½“å…³é—­åå‘é”åŠŸèƒ½æˆ–è€…å¤šä¸ªçº¿ç¨‹ç«äº‰åå‘é”å¯¼è‡´åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œåˆ™ä¼šå°è¯•è·å–è½»é‡çº§é”</em>ï¼Œæ­¤æ—¶Mark Wordçš„ç»“æ„ä¹Ÿå˜ä¸ºè½»é‡çº§é”çš„ç»“æ„ã€‚<strong>å¦‚æœå­˜åœ¨å¤šä¸ªçº¿ç¨‹åŒä¸€æ—¶é—´è®¿é—®åŒä¸€é”çš„åœºåˆï¼Œå°±ä¼šå¯¼è‡´è½»é‡çº§é”è†¨èƒ€ä¸ºé‡é‡çº§é”</strong>ã€‚</p><p>å…¶æ­¥éª¤å¦‚ä¸‹ï¼š<br>è·å–é” </p><ol><li>åˆ¤æ–­å½“å‰å¯¹è±¡æ˜¯å¦å¤„äºæ— é”çŠ¶æ€ï¼ˆhashcodeã€0ã€01ï¼‰ï¼Œè‹¥æ˜¯ï¼Œåˆ™JVMé¦–å…ˆå°†åœ¨å½“å‰çº¿ç¨‹çš„<em>æ ˆå¸§</em>ä¸­å»ºç«‹ä¸€ä¸ªåä¸ºé”è®°å½•ï¼ˆLock Recordï¼‰çš„ç©ºé—´ï¼Œç”¨äºå­˜å‚¨é”å¯¹è±¡ç›®å‰çš„Mark Wordçš„æ‹·è´ï¼ˆå®˜æ–¹æŠŠè¿™ä»½æ‹·è´åŠ äº†ä¸€ä¸ªDisplacedå‰ç¼€ï¼Œå³Displaced Mark Wordï¼‰ï¼›å¦åˆ™æ‰§è¡Œæ­¥éª¤ï¼ˆ3ï¼‰ï¼› </li><li>JVMåˆ©ç”¨CASæ“ä½œå°è¯•å°†å¯¹è±¡çš„Mark Wordæ›´æ–°ä¸ºæŒ‡å‘Lock Recordçš„æŒ‡é’ˆï¼Œå¦‚æœæˆåŠŸè¡¨ç¤ºç«äº‰åˆ°é”ï¼Œåˆ™å°†é”æ ‡å¿—ä½å˜æˆ00ï¼ˆè¡¨ç¤ºæ­¤å¯¹è±¡å¤„äºè½»é‡çº§é”çŠ¶æ€ï¼‰ï¼Œæ‰§è¡ŒåŒæ­¥æ“ä½œï¼›å¦‚æœå¤±è´¥åˆ™æ‰§è¡Œæ­¥éª¤ï¼ˆ3ï¼‰ï¼› </li><li>åˆ¤æ–­å½“å‰å¯¹è±¡çš„Mark Wordæ˜¯å¦æŒ‡å‘å½“å‰çº¿ç¨‹çš„æ ˆå¸§ï¼Œå¦‚æœæ˜¯åˆ™è¡¨ç¤ºå½“å‰çº¿ç¨‹å·²ç»æŒæœ‰å½“å‰å¯¹è±¡çš„é”ï¼Œåˆ™ç›´æ¥æ‰§è¡ŒåŒæ­¥ä»£ç å—ï¼›å¦åˆ™åªèƒ½è¯´æ˜è¯¥é”å¯¹è±¡å·²ç»è¢«å…¶ä»–çº¿ç¨‹æŠ¢å äº†ï¼Œè¿™æ—¶è½»é‡çº§é”éœ€è¦è†¨èƒ€ä¸ºé‡é‡çº§é”ï¼Œé”æ ‡å¿—ä½å˜æˆ10ï¼Œåé¢ç­‰å¾…çš„çº¿ç¨‹å°†ä¼šè¿›å…¥é˜»å¡çŠ¶æ€ï¼›</li></ol><p>é‡Šæ”¾é”<br>è½»é‡çº§é”çš„é‡Šæ”¾ä¹Ÿæ˜¯é€šè¿‡CASæ“ä½œæ¥è¿›è¡Œçš„ï¼Œä¸»è¦æ­¥éª¤å¦‚ä¸‹ï¼š </p><ol><li>å–å‡ºåœ¨è·å–è½»é‡çº§é”ä¿å­˜åœ¨Displaced Mark Wordä¸­çš„æ•°æ®ï¼› </li><li>ç”¨CASæ“ä½œå°†å–å‡ºçš„æ•°æ®æ›¿æ¢å½“å‰å¯¹è±¡çš„Mark Wordä¸­ï¼Œå¦‚æœæˆåŠŸï¼Œåˆ™è¯´æ˜é‡Šæ”¾é”æˆåŠŸï¼Œå¦åˆ™æ‰§è¡Œï¼ˆ3ï¼‰ï¼› </li><li>å¦‚æœCASæ“ä½œæ›¿æ¢å¤±è´¥ï¼Œè¯´æ˜æœ‰å…¶ä»–çº¿ç¨‹å°è¯•è·å–è¯¥é”ï¼Œåˆ™éœ€è¦åœ¨é‡Šæ”¾é”çš„åŒæ—¶éœ€è¦å”¤é†’è¢«æŒ‚èµ·çš„çº¿ç¨‹ã€‚</li></ol><h3 id="è‡ªæ—‹é”"><a href="#è‡ªæ—‹é”" class="headerlink" title="è‡ªæ—‹é”"></a>è‡ªæ—‹é”</h3><p>çº¿ç¨‹çš„é˜»å¡å’Œå”¤é†’éœ€è¦CPUä»ç”¨æˆ·æ€è½¬ä¸ºæ ¸å¿ƒæ€ï¼Œé¢‘ç¹çš„é˜»å¡å’Œå”¤é†’å¯¹CPUæ¥è¯´æ˜¯ä¸€ä»¶è´Ÿæ‹…å¾ˆé‡çš„å·¥ä½œï¼ŒåŠ¿å¿…ä¼šç»™ç³»ç»Ÿçš„å¹¶å‘æ€§èƒ½å¸¦æ¥å¾ˆå¤§çš„å‹åŠ›ã€‚åŒæ—¶æˆ‘ä»¬å‘ç°åœ¨è®¸å¤šåº”ç”¨ä¸Šé¢ï¼Œ<em>å¯¹è±¡é”çš„é”çŠ¶æ€åªä¼šæŒç»­å¾ˆçŸ­ä¸€æ®µæ—¶é—´ï¼Œä¸ºäº†è¿™ä¸€æ®µå¾ˆçŸ­çš„æ—¶é—´é¢‘ç¹åœ°é˜»å¡å’Œå”¤é†’çº¿ç¨‹æ˜¯éå¸¸ä¸å€¼å¾—çš„</em>ã€‚æ‰€ä»¥å¼•å…¥è‡ªæ—‹é”ã€‚<br>ä½•è°“è‡ªæ—‹é”ï¼Ÿ<br><em>æ‰€è°“è‡ªæ—‹é”ï¼Œå°±æ˜¯è®©è¯¥çº¿ç¨‹ç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œä¸ä¼šè¢«ç«‹å³æŒ‚èµ·ï¼Œçœ‹æŒæœ‰é”çš„çº¿ç¨‹æ˜¯å¦ä¼šå¾ˆå¿«é‡Šæ”¾é”ã€‚æ€ä¹ˆç­‰å¾…å‘¢ï¼Ÿæ‰§è¡Œä¸€æ®µæ— æ„ä¹‰çš„å¾ªç¯å³å¯ï¼ˆè‡ªæ—‹ï¼‰</em>ã€‚<br>è‡ªæ—‹ç­‰å¾…ä¸èƒ½æ›¿ä»£é˜»å¡ï¼Œè™½ç„¶å®ƒå¯ä»¥é¿å…çº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„å¼€é”€ï¼Œä½†æ˜¯å®ƒå ç”¨äº†å¤„ç†å™¨çš„æ—¶é—´ã€‚å¦‚æœæŒæœ‰é”çš„çº¿ç¨‹å¾ˆå¿«å°±é‡Šæ”¾äº†é”ï¼Œé‚£ä¹ˆè‡ªæ—‹çš„æ•ˆç‡å°±éå¸¸å¥½ï¼Œåä¹‹ï¼Œè‡ªæ—‹çš„çº¿ç¨‹å°±ä¼šç™½ç™½æ¶ˆè€—æ‰å¤„ç†çš„èµ„æºï¼Œå®ƒä¸ä¼šåšä»»ä½•æœ‰æ„ä¹‰çš„å·¥ä½œï¼Œè¿™æ ·åè€Œä¼šå¸¦æ¥æ€§èƒ½ä¸Šçš„æµªè´¹ã€‚æ‰€ä»¥è¯´ï¼Œè‡ªæ—‹ç­‰å¾…çš„æ—¶é—´ï¼ˆè‡ªæ—‹çš„æ¬¡æ•°ï¼‰å¿…é¡»è¦æœ‰ä¸€ä¸ªé™åº¦ï¼Œå¦‚æœè‡ªæ—‹è¶…è¿‡äº†å®šä¹‰çš„æ—¶é—´ä»ç„¶æ²¡æœ‰è·å–åˆ°é”ï¼Œåˆ™åº”è¯¥è¢«æŒ‚èµ·ã€‚<br>è‡ªæ—‹é”åœ¨JDK 1.4.2ä¸­å¼•å…¥ï¼Œé»˜è®¤å…³é—­ï¼Œä½†æ˜¯å¯ä»¥ä½¿ç”¨-XX:+UseSpinningå¼€å¼€å¯ï¼Œåœ¨JDK1.6ä¸­é»˜è®¤å¼€å¯ã€‚åŒæ—¶è‡ªæ—‹çš„é»˜è®¤æ¬¡æ•°ä¸º10æ¬¡ï¼Œå¯ä»¥é€šè¿‡å‚æ•°-XX:PreBlockSpinæ¥è°ƒæ•´ï¼›<br>å¦‚æœé€šè¿‡å‚æ•°-XX:preBlockSpinæ¥è°ƒæ•´è‡ªæ—‹é”çš„è‡ªæ—‹æ¬¡æ•°ï¼Œä¼šå¸¦æ¥è¯¸å¤šä¸ä¾¿ã€‚å‡å¦‚æˆ‘å°†å‚æ•°è°ƒæ•´ä¸º10ï¼Œä½†æ˜¯å¾ˆå¤šçº¿ç¨‹éƒ½æ˜¯ç­‰ä½ åˆšåˆšé€€å‡ºè‡ªæ—‹çš„æ—¶å€™å°±é‡Šæ”¾äº†é”ï¼ˆå‡å¦‚ä½ å†å¤šè‡ªæ—‹ä¸€ä¸¤æ¬¡å°±å¯ä»¥è·å–é”ï¼‰ï¼Œä½ æ˜¯ä¸æ˜¯å¾ˆå°´å°¬ã€‚äºæ˜¯JDK1.6å¼•å…¥<em>è‡ªé€‚åº”çš„è‡ªæ—‹é”</em>ï¼Œè®©è™šæ‹Ÿæœºä¼šå˜å¾—è¶Šæ¥è¶Šèªæ˜ã€‚</p><p>JDK 1.6å¼•å…¥äº†æ›´åŠ èªæ˜çš„è‡ªæ—‹é”ï¼Œå³è‡ªé€‚åº”è‡ªæ—‹é”ã€‚æ‰€è°“è‡ªé€‚åº”å°±æ„å‘³ç€è‡ªæ—‹çš„æ¬¡æ•°ä¸å†æ˜¯å›ºå®šçš„ï¼Œå®ƒæ˜¯ç”±å‰ä¸€æ¬¡åœ¨åŒä¸€ä¸ªé”ä¸Šçš„è‡ªæ—‹æ—¶é—´åŠé”çš„æ‹¥æœ‰è€…çš„çŠ¶æ€æ¥å†³å®šã€‚å®ƒæ€ä¹ˆåšå‘¢ï¼Ÿ<em>çº¿ç¨‹å¦‚æœè‡ªæ—‹æˆåŠŸäº†ï¼Œé‚£ä¹ˆä¸‹æ¬¡è‡ªæ—‹çš„æ¬¡æ•°ä¼šæ›´åŠ å¤š</em>ï¼Œå› ä¸ºè™šæ‹Ÿæœºè®¤ä¸ºæ—¢ç„¶ä¸Šæ¬¡æˆåŠŸäº†ï¼Œé‚£ä¹ˆæ­¤æ¬¡è‡ªæ—‹ä¹Ÿå¾ˆæœ‰å¯èƒ½ä¼šå†æ¬¡æˆåŠŸï¼Œé‚£ä¹ˆå®ƒå°±ä¼šå…è®¸è‡ªæ—‹ç­‰å¾…æŒç»­çš„æ¬¡æ•°æ›´å¤šã€‚åä¹‹ï¼Œ<em>å¦‚æœå¯¹äºæŸä¸ªé”ï¼Œå¾ˆå°‘æœ‰è‡ªæ—‹èƒ½å¤ŸæˆåŠŸçš„ï¼Œé‚£ä¹ˆåœ¨ä»¥åè¦æˆ–è€…è¿™ä¸ªé”çš„æ—¶å€™è‡ªæ—‹çš„æ¬¡æ•°ä¼šå‡å°‘ç”šè‡³çœç•¥æ‰è‡ªæ—‹è¿‡ç¨‹ï¼Œä»¥å…æµªè´¹å¤„ç†å™¨èµ„æº</em>ã€‚ </p><p><em>è½»é‡çº§é”å¤±è´¥åï¼Œè™šæ‹Ÿæœºä¸ºäº†é¿å…çº¿ç¨‹çœŸå®åœ°åœ¨æ“ä½œç³»ç»Ÿå±‚é¢æŒ‚èµ·ï¼Œè¿˜ä¼šè¿›è¡Œä¸€é¡¹ç§°ä¸ºè‡ªæ—‹é”çš„ä¼˜åŒ–æ‰‹æ®µ</em>ã€‚å¦‚æœè‡ªæ—‹ä¹‹åä¾ç„¶æ²¡æœ‰è·å–åˆ°é”ï¼Œä¹Ÿå°±åªèƒ½å‡çº§ä¸ºé‡é‡çº§é”äº†ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://blog.csdn.net/javazejian/article/details/72828483">http://blog.csdn.net/javazejian/article/details/72828483</a><br><a href="http://blog.csdn.net/chenssy/article/details/54883355">http://blog.csdn.net/chenssy/article/details/54883355</a></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> synchronized </tag>
            
            <tag> åŸç† </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gitå¸¸ç”¨å‘½ä»¤</title>
      <link href="/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html"/>
      <url>/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4.html</url>
      
        <content type="html"><![CDATA[<p>*æŸ¥çœ‹ç”¨æˆ·åå’Œé‚®ç®±<br><code>git config user.name</code><br><code>git config user.email</code></p><ul><li><p>é¦–å…ˆæ˜¯é…ç½®å¸å·ä¿¡æ¯<br><code>git config --global user.name xxx</code><br><code>git config --global user.email xxx@bigdatadecode.top</code></p></li><li><p>æŸ¥çœ‹é…ç½®çš„ä¿¡æ¯ <code>git config --list</code></p></li><li><p>ç¦æ­¢è‡ªåŠ¨æ¢è¡Œè½¬æ¢ <code>git config --global core.autocrlf input</code></p></li><li><p>æŸ¥çœ‹è¿œç¨‹åˆ†æ”¯  <code>git branch -a</code></p></li><li><p>æŸ¥çœ‹æœ¬åœ°åˆ†æ”¯  <code>git branch</code></p></li><li><p>åˆ›å»ºæœ¬åœ°åˆ†æ”¯å¹¶åˆ‡æ¢ <code>git checkout -b dev</code>ï¼Œä¹Ÿå¯ä½¿ç”¨<code>git branch dev</code>å’Œ<code>git checkout dev</code>è¿™ä¸¤æ¡å‘½ä»¤</p></li><li><p>å°†æœ¬åœ°åˆ†æ”¯æ¨é€åˆ°è¿œç¨‹ <code>git push origin dev:dev</code> ï¼Œç¬¬ä¸€ä¸ªdevæ˜¯æœ¬åœ°çš„åˆ†æ”¯åå­—ï¼Œç¬¬äºŒä¸ªdevæ˜¯è¿œç¨‹åˆ†æ”¯çš„åå­—ï¼Œè¿œç¨‹åˆ†æ”¯åå­—å¯ä»¥ä¸å­˜åœ¨ï¼Œä¼šè‡ªåŠ¨åˆ›å»º</p></li><li><p>æ‹‰å–è¿œç¨‹åˆ†æ”¯ <code>git pull origin dev</code></p></li><li><p>åˆå¹¶è¿œç¨‹åˆ†æ”¯ï¼Œ å…ˆåˆ›å»ºä¸€ä¸ªä¸è¿œç¨‹åˆ†æ”¯åŒåçš„æœ¬åœ°åˆ†æ”¯<code>git checkout -b test</code>ï¼Œæ‰§è¡Œåˆå¹¶å‘½ä»¤<code>git merge dev</code>(æ­¤æ—¶çš„å½“å‰åˆ†æ”¯æ˜¯testï¼Œå°†devåˆå¹¶åˆ°teståˆ†æ”¯)ï¼Œç„¶åpushåˆ°è¿œç¨‹<code>git push origin test</code></p></li><li><p>æŸ¥çœ‹tag <code>git tag</code></p></li><li><p>åˆ‡æ¢tag <code>git checkout tagName # ç±»ä¼¼branch</code> </p></li></ul><span id="more"></span><h2 id="addæ—¶æ’é™¤ä¸ªåˆ«æ–‡ä»¶"><a href="#addæ—¶æ’é™¤ä¸ªåˆ«æ–‡ä»¶" class="headerlink" title="addæ—¶æ’é™¤ä¸ªåˆ«æ–‡ä»¶"></a>addæ—¶æ’é™¤ä¸ªåˆ«æ–‡ä»¶</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git add -u</span><br><span class="line">git reset -- main/dontcheckmein.txt</span><br></pre></td></tr></table></figure><h2 id="å¼€å‘æœ¬åœ°åˆ†æ”¯åŒæ­¥åˆ°è¿œç¨‹dev"><a href="#å¼€å‘æœ¬åœ°åˆ†æ”¯åŒæ­¥åˆ°è¿œç¨‹dev" class="headerlink" title="å¼€å‘æœ¬åœ°åˆ†æ”¯åŒæ­¥åˆ°è¿œç¨‹dev"></a>å¼€å‘æœ¬åœ°åˆ†æ”¯åŒæ­¥åˆ°è¿œç¨‹dev</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># å…ˆå°†è¿œç¨‹devåŒæ­¥åˆ°æœ¬åœ°å¼€å‘åˆ†æ”¯ test</span></span><br><span class="line">git pull origin dev</span><br><span class="line"><span class="comment"># å¼€å‘ç»“æŸä¹‹åå°†æœ¬åœ°åˆ†æ”¯æäº¤åˆ°è¿œç¨‹teståˆ†æ”¯</span></span><br><span class="line">git add --all</span><br><span class="line">git commit</span><br><span class="line">git push origin <span class="built_in">test</span></span><br><span class="line"><span class="comment"># å°†è¿œç¨‹teståˆ†æ”¯åˆå¹¶åˆ°devåˆ†æ”¯</span></span><br><span class="line">git checkout dev</span><br><span class="line">git merge <span class="built_in">test</span></span><br><span class="line">git push origin dev</span><br></pre></td></tr></table></figure><h2 id="æœ¬åœ°ä¸è¿œç¨‹ä»£ç å†²çª"><a href="#æœ¬åœ°ä¸è¿œç¨‹ä»£ç å†²çª" class="headerlink" title="æœ¬åœ°ä¸è¿œç¨‹ä»£ç å†²çª"></a>æœ¬åœ°ä¸è¿œç¨‹ä»£ç å†²çª</h2><p>å½“ä½ pullè¿œç¨‹ä»£ç æ—¶ï¼Œå¯èƒ½å‘ç”Ÿå†²çªï¼ŒæŠ¥é”™å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">error: Your <span class="built_in">local</span> changes to the following files would be overwritten by merge:  </span><br><span class="line">...</span><br><span class="line">Please, commit your changes or stash them before you can merge.  </span><br><span class="line">Aborting</span><br></pre></td></tr></table></figure><p>æç¤ºä½¿ç”¨stashå‘½ä»¤ï¼Œå…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git stash  <span class="comment"># å¤‡ä»½å½“å‰çš„å·¥ä½œåŒºçš„å†…å®¹åˆ°gitæ ˆä¸­</span></span><br><span class="line">git pull   <span class="comment"># æ‹‰å–gitä»“åº“ä¸­æœ€æ–°çš„ä»£ç </span></span><br><span class="line">git stash pop  <span class="comment"># å°†ä½ ä¿å­˜åœ¨gitæ ˆä¸­çš„ä»£ç ä¸ä»gitä»“åº“ä¸­æ‹‰å–çš„ä»£ç è¿›è¡Œmerge</span></span><br><span class="line">git diff -w filePath <span class="comment"># ç”¨diffæŸ¥çœ‹å“ªäº›æ–‡ä»¶è¿›è¡Œmergeï¼Œå»ç›¸åº”çš„æ–‡ä»¶ä¸­è§£å†³å†²çª</span></span><br><span class="line"><span class="comment"># è¿›å…¥å†²çªçš„æ–‡ä»¶ï¼Œè¿›è¡Œä»£ç ä¿®æ”¹</span></span><br><span class="line"><span class="comment"># ä¿®æ”¹ç»“æŸä¹‹åï¼Œå°†å½“å‰çš„ä»£ç pushåˆ°gitä»“åº“</span></span><br><span class="line"><span class="comment"># å°†stashä¸­çš„å¤‡ä»½æ¸…ç©º</span></span><br><span class="line">git stash clear</span><br></pre></td></tr></table></figure><h2 id="pushæ—¶å‘ç°è¿œç¨‹ä»“åº“å·²æ›´æ–°"><a href="#pushæ—¶å‘ç°è¿œç¨‹ä»“åº“å·²æ›´æ–°" class="headerlink" title="pushæ—¶å‘ç°è¿œç¨‹ä»“åº“å·²æ›´æ–°"></a>pushæ—¶å‘ç°è¿œç¨‹ä»“åº“å·²æ›´æ–°</h2><p>æ‰§è¡Œ<code>git push</code>æŠ¥é”™ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"> ! [rejected]        main -&gt; main (fetch first)</span><br><span class="line">error: æ— æ³•æ¨é€ä¸€äº›å¼•ç”¨åˆ° <span class="string">&#x27;github.com:xxx/xxx.git&#x27;</span></span><br><span class="line">æç¤ºï¼šæ›´æ–°è¢«æ‹’ç»ï¼Œå› ä¸ºè¿œç¨‹ä»“åº“åŒ…å«æ‚¨æœ¬åœ°å°šä¸å­˜åœ¨çš„æäº¤ã€‚è¿™é€šå¸¸æ˜¯å› ä¸ºå¦å¤–</span><br><span class="line">æç¤ºï¼šä¸€ä¸ªä»“åº“å·²å‘è¯¥å¼•ç”¨è¿›è¡Œäº†æ¨é€ã€‚å†æ¬¡æ¨é€å‰ï¼Œæ‚¨å¯èƒ½éœ€è¦å…ˆæ•´åˆè¿œç¨‹å˜æ›´</span><br><span class="line">æç¤ºï¼šï¼ˆå¦‚ <span class="string">&#x27;git pull ...&#x27;</span>ï¼‰ã€‚</span><br><span class="line">æç¤ºï¼šè¯¦è§ <span class="string">&#x27;git push --help&#x27;</span> ä¸­çš„ <span class="string">&#x27;Note about fast-forwards&#x27;</span> å°èŠ‚ã€‚</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>git pull</code>æ‹‰å–æœ€æ–°ä»£ç ï¼Œæç¤º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">   3e24ca6..cdb884c  main       -&gt; origin/main</span><br><span class="line">æç¤ºï¼šæ‚¨æœ‰åç¦»çš„åˆ†æ”¯ï¼Œéœ€è¦æŒ‡å®šå¦‚ä½•è°ƒå’Œå®ƒä»¬ã€‚æ‚¨å¯ä»¥åœ¨æ‰§è¡Œä¸‹ä¸€æ¬¡</span><br><span class="line">æç¤ºï¼špull æ“ä½œä¹‹å‰æ‰§è¡Œä¸‹é¢ä¸€æ¡å‘½ä»¤æ¥æŠ‘åˆ¶æœ¬æ¶ˆæ¯ï¼š</span><br><span class="line">æç¤ºï¼š</span><br><span class="line">æç¤ºï¼š  git config pull.rebase <span class="literal">false</span>  <span class="comment"># åˆå¹¶</span></span><br><span class="line">æç¤ºï¼š  git config pull.rebase <span class="literal">true</span>   <span class="comment"># å˜åŸº</span></span><br><span class="line">æç¤ºï¼š  git config pull.ff only       <span class="comment"># ä»…å¿«è¿›</span></span><br><span class="line">æç¤ºï¼š</span><br><span class="line">æç¤ºï¼šæ‚¨å¯ä»¥å°† <span class="string">&quot;git config&quot;</span> æ›¿æ¢ä¸º <span class="string">&quot;git config --global&quot;</span> ä»¥ä¾¿ä¸ºæ‰€æœ‰ä»“åº“è®¾ç½®</span><br><span class="line">æç¤ºï¼šç¼ºçœçš„é…ç½®é¡¹ã€‚æ‚¨ä¹Ÿå¯ä»¥åœ¨æ¯æ¬¡æ‰§è¡Œ pull å‘½ä»¤æ—¶æ·»åŠ  --rebaseã€--no-rebaseï¼Œ</span><br><span class="line">æç¤ºï¼šæˆ–è€… --ff-only å‚æ•°è¦†ç›–ç¼ºçœè®¾ç½®ã€‚</span><br><span class="line">fatal: éœ€è¦æŒ‡å®šå¦‚ä½•è°ƒå’Œåç¦»çš„åˆ†æ”¯ã€‚</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œ<code>git pull --no-rebase</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Merge made by the <span class="string">&#x27;ort&#x27;</span> strategy.</span><br><span class="line"> Makefile   | 2 +-</span><br><span class="line"> dockerfile | 1 +</span><br><span class="line"> frontend   | 2 +-</span><br><span class="line"> 3 files changed, 3 insertions(+), 2 deletions(-)</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦å­˜åœ¨å†²çªï¼Œå¦‚æœä¸å­˜åœ¨å†æ¬¡æ‰§è¡Œ<code>git push</code>è¿›è¡Œæäº¤</p><h2 id="æŸ¥çœ‹stash"><a href="#æŸ¥çœ‹stash" class="headerlink" title="æŸ¥çœ‹stash"></a>æŸ¥çœ‹stash</h2><p>æŸ¥çœ‹stashç‰ˆæœ¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git stash list</span><br><span class="line">stash@&#123;0&#125;: WIP on main: 912ab09 xz</span><br><span class="line">stash@&#123;1&#125;: WIP on main: 912ab09 xx</span><br></pre></td></tr></table></figure><p>æŸ¥çœ‹stashæŸä¸ªç‰ˆæœ¬çš„å†…å®¹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash show -p stash@&#123;1&#125;</span><br></pre></td></tr></table></figure><p>æå‡ºæŸä¸ªç‰ˆæœ¬</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">git stash pop stash@&#123;0&#125;</span><br></pre></td></tr></table></figure><p>ä¹Ÿå¯ä½¿ç”¨<code>git stash apply n</code>ï¼ŒåŒºåˆ«æ˜¯popä¼šåˆ é™¤stashä¸­çš„å†…å®¹ï¼Œè€Œapplyåˆ™ä¸ä¼šã€‚</p><h2 id="åˆ‡æ¢åˆ°tag"><a href="#åˆ‡æ¢åˆ°tag" class="headerlink" title="åˆ‡æ¢åˆ°tag"></a>åˆ‡æ¢åˆ°tag</h2><p><code>git checkout -b branch_name tag_name</code></p><h2 id="ç‰ˆæœ¬å›æ»š"><a href="#ç‰ˆæœ¬å›æ»š" class="headerlink" title="ç‰ˆæœ¬å›æ»š"></a>ç‰ˆæœ¬å›æ»š</h2><p>åœ¨è§£å†³å†²çªçš„è¿‡ç¨‹ä¸­ï¼Œæˆ–è€…å…¶å®ƒåŸå› å¯èƒ½éœ€è¦å°†ç‰ˆæœ¬è¿›è¡Œå›æ»šï¼Œå›æ»šåˆ°ä¹‹å‰çš„æŸä¸ªç‰ˆæœ¬ï¼Œæ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">log</span>  <span class="comment"># æŸ¥çœ‹æäº¤æäº¤å†å²è®°å½•    </span></span><br><span class="line"><span class="comment"># (æ­¤æ—¶å°±å¯ä»¥çœ‹å‡ºæ¯æ¬¡pushä»£ç æ—¶éƒ½è¦å†™å¤‡æ³¨ï¼Œè¦ä¸ä¸çŸ¥é“å›æ»šåˆ°å“ªä¸ªç‰ˆæœ¬)</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># å¦‚æœå«Œè¾“å‡ºä¿¡æ¯å¤ªå¤šï¼Œçœ‹å¾—çœ¼èŠ±ç¼­ä¹±çš„ï¼Œå¯ä»¥è¯•è¯•åŠ ä¸Š--pretty=onelineå‚æ•°</span></span><br><span class="line">git <span class="built_in">log</span> --pretty=oneline </span><br><span class="line"></span><br><span class="line"><span class="comment"># å›æ»šç‰ˆæœ¬</span></span><br><span class="line">git reset --hard HEAD^   <span class="comment"># or git reset --hard HEAD~1</span></span><br></pre></td></tr></table></figure><p>å¦‚æœè¦å›æ»šçš„ç‰ˆæœ¬å’Œå½“å‰ç‰ˆæœ¬éš”çš„ç‰ˆæœ¬è¾ƒå¤šï¼Œå¯ä»¥ä½¿ç”¨<code>git reset --hard HEAD~num</code>ï¼Œå…¶ä¸­numæ˜¯å›æ»šçš„ç‰ˆæœ¬ä¸æœ€æ–°ç‰ˆæœ¬çš„<code>å·®å€¼+1</code></p><p>å¦‚æœæ­¤æ—¶åˆæƒ³å›åˆ°æœªæ¥çš„æŸä¸ªç‰ˆæœ¬ï¼Œåˆ™å¯ä»¥ä»ä¹‹å‰çš„è®°å½•ä¸­æ‰¾åˆ°æœªæ¥ç‰ˆæœ¬çš„å¯¹åº”çš„<code>commit id</code>ï¼Œä½¿ç”¨<code>git reset --hard xxx</code>ï¼Œç‰ˆæœ¬å·æ²¡å¿…è¦å†™å…¨ï¼Œå‰å‡ ä½å°±å¯ä»¥äº†ï¼ŒGitä¼šè‡ªåŠ¨å»æ‰¾ï¼Œä½†åæ­£éƒ½æ˜¯å¤åˆ¶ï¼Œä¸ºä»€ä¹ˆä¸å¤åˆ¶å…¨å‘¢ã€‚</p><h2 id="gitignore-æ–‡ä»¶çš„é…ç½®"><a href="#gitignore-æ–‡ä»¶çš„é…ç½®" class="headerlink" title=".gitignore æ–‡ä»¶çš„é…ç½®"></a>.gitignore æ–‡ä»¶çš„é…ç½®</h2><p>æˆ‘ç”¨intellijå¼€å‘ï¼Œintellijçš„é¡¹ç›®ä¸­ä¼šæœ‰ä¸ª.ideaæ–‡ä»¶å¤¹ï¼Œå…¶å†…çš„å†…å®¹å’Œå…¶ä»–äººçš„å†…å®¹ä¸ä¸€æ ·ï¼Œè¿˜æœ‰ä¸€äº›é…ç½®æ–‡ä»¶ä¼šä¸ä¸€æ ·ï¼Œæ‰€ä»¥å°±æƒ³æŠŠè¿™äº›ç»™å¿½ç•¥æ‰ã€‚</p><p>åœ¨é¡¹ç›®ä¸­åˆ›å»º.gitignoreï¼Œå…¶å†…çš„å†…å®¹å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">/target/</span><br><span class="line"></span><br><span class="line"><span class="comment"># ignore .idea</span></span><br><span class="line">.idea/*</span><br><span class="line"></span><br><span class="line"><span class="comment"># ignore .gitignore</span></span><br><span class="line"><span class="comment"># å¦‚æœ.gitignoreæ–‡ä»¶æ²¡æœ‰è¢«å¿½ç•¥çš„è¯ï¼Œåœ¨gitå‘½ä»¤è¡Œä¸­æ‰§è¡Œ</span></span><br><span class="line"><span class="comment"># git update-index --assume-unchanged (PATH/FILE)åœ¨PATH/FILEå¤„è¾“å…¥è¦å¿½ç•¥çš„æ–‡ä»¶</span></span><br><span class="line">/.gitignore</span><br><span class="line"></span><br><span class="line"><span class="comment"># æœ¬åœ°å¿½ç•¥æ–‡ä»¶</span></span><br><span class="line">src/main/resources/config/jdbc.properties</span><br></pre></td></tr></table></figure><p>.gitignoreé…ç½®å®Œä¹‹åï¼Œå‘gitä»“åº“pushä»£ç æ—¶ï¼Œ.ideaä¸­çš„æ–‡ä»¶å¯èƒ½ä¼šå‘ç”Ÿå†²çªï¼Œåˆ™å°†æœ¬åœ°.ideaçš„å†…å®¹ä»gitç¼“å­˜ä¸­åˆ é™¤ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git rm --cached &lt;æ–‡ä»¶å&gt; åˆ é™¤æ–‡ä»¶çš„ç¼“å­˜</span><br><span class="line">git rm --cached -r &lt;ç›®å½•å&gt; åˆ é™¤ç›®å½•ä¸‹çš„æ‰€æœ‰æ–‡ä»¶çš„ç¼“å­˜</span><br></pre></td></tr></table></figure><p>ç„¶åå°†ä»£ç è¿›è¡Œæäº¤</p><h2 id="forkåˆ†æ”¯åŒæ­¥æºåˆ†æ”¯"><a href="#forkåˆ†æ”¯åŒæ­¥æºåˆ†æ”¯" class="headerlink" title="forkåˆ†æ”¯åŒæ­¥æºåˆ†æ”¯"></a>forkåˆ†æ”¯åŒæ­¥æºåˆ†æ”¯</h2><ol><li>Clone your fork:<br>git clone <a href="mailto:&#x67;&#x69;&#x74;&#64;&#x67;&#x69;&#116;&#104;&#117;&#x62;&#46;&#99;&#111;&#109;">&#x67;&#x69;&#x74;&#64;&#x67;&#x69;&#116;&#104;&#117;&#x62;&#46;&#99;&#111;&#109;</a>:YOUR-USERNAME/YOUR-FORKED-REPO.git</li><li>Add remote from original repository in your forked repository:<br>cd into/cloned/fork-repo<br>git remote add upstream git://github.com/ORIGINAL-DEV-USERNAME/REPO-YOU-FORKED-FROM.git<br>git fetch upstream</li><li>Updating your fork from original repo to keep up with their changes:<br>git pull upstream master</li></ol><h2 id="error-è§£å†³"><a href="#error-è§£å†³" class="headerlink" title="error è§£å†³"></a>error è§£å†³</h2><p>å‡ºç°Non-fast-forwardæ—¶ï¼Œå¯ä»¥å¼ºåˆ¶æäº¤<code>git push -f</code></p><ul><li>Pull is not possible because you have unmerged files.(æˆ–è€…åœ¨è¿›è¡Œå…¶å®ƒæ“ä½œæ—¶ï¼Œæç¤ºxx have unmerged files.ï¼‰<br>åº”è¯¥æ˜¯å› ä¸ºlocalæ–‡ä»¶å†²çªäº†ï¼Œè§£å†³æ–¹æ³•æœ‰ä¸¤ç§ï¼š</li></ul><ol><li>pullä¼šä½¿ç”¨git mergeå¯¼è‡´å†²çªï¼Œéœ€è¦å°†å†²çªçš„æ–‡ä»¶resolveæ‰ï¼Œç„¶åæ‰§è¡Œ<code>git add -u</code>, æœ€å<code>git commit</code>ä¹‹åæ‰èƒ½æˆåŠŸpullã€‚</li><li>å¦‚æœæƒ³æ”¾å¼ƒæœ¬åœ°çš„æ–‡ä»¶ä¿®æ”¹ï¼Œå¯ä»¥ä½¿ç”¨<code>git reset --hard FETCH_HEAD</code>ï¼ŒFETCH_HEADè¡¨ç¤ºä¸Šä¸€æ¬¡æˆåŠŸgit pullä¹‹åå½¢æˆçš„commitç‚¹ã€‚ç„¶ågit pullã€‚</li></ol><h2 id="clone-hadoop"><a href="#clone-hadoop" class="headerlink" title="clone hadoop"></a>clone hadoop</h2><p>git clone <a href="mailto:&#103;&#105;&#116;&#64;&#103;&#x69;&#116;&#104;&#117;&#x62;&#x2e;&#x63;&#111;&#x6d;">&#103;&#105;&#116;&#64;&#103;&#x69;&#116;&#104;&#117;&#x62;&#x2e;&#x63;&#111;&#x6d;</a>:hunshenshi/hadoop.git<br>git remote add upstream <a href="mailto:&#x67;&#x69;&#x74;&#x40;&#103;&#105;&#x74;&#104;&#x75;&#98;&#x2e;&#x63;&#x6f;&#x6d;">&#x67;&#x69;&#x74;&#x40;&#103;&#105;&#x74;&#104;&#x75;&#98;&#x2e;&#x63;&#x6f;&#x6d;</a>:apache/hadoop.git</p><p>å¦‚æœè¦æäº¤patchï¼Œå…ˆåŒæ­¥åŸHadoopä»“åº“ä»£ç </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git checkout trunk</span><br><span class="line">git pull upstream trunk</span><br><span class="line">git push origin trunk    <span class="comment"># æœ¬åœ°å’Œä»“åº“åŒæ­¥ä»£ç </span></span><br></pre></td></tr></table></figure><p>ç„¶ååˆ›å»ºåˆ†æ”¯è¿›è¡Œæäº¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">git checkout -b HDFS-14361</span><br><span class="line">git add hadoop-hdfs-project/hadoop-hdfs/src/main/java/org/apache/hadoop/hdfs/server/namenode/ha/StandbyCheckpointer.java</span><br><span class="line">git commit -m <span class="string">&#x27;HDFS-14361:SNN will always upload fsimage&#x27;</span></span><br><span class="line">git push origin HDFS-14361</span><br></pre></td></tr></table></figure><p>æœ€ååœ¨githubä¸Šæäº¤PRï¼ˆ<strong>PRçš„æ—¶å€™æ³¨æ„çœ‹ä¸‹å½“å‰åˆ†æ”¯æ˜¯å¦ä¸ºtrunkåˆ†æ”¯</strong>ï¼‰</p><p>å¦‚æœå‡ºç°â€œThis branch is X commits aheadâ€<br>åœ¨trunkåˆ†æ”¯æ‹‰å–åŸåˆ†æ”¯ä»£ç ï¼Œç„¶åè¿›è¡Œå¼ºåˆ¶æäº¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">git pull upstream trunk</span><br><span class="line">git push --force-with-lease</span><br></pre></td></tr></table></figure><!--git pull --rebase upstream trunk   or   git reset --hard HEAD~2git push --force-with-lease origin master-->]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> git </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹ApplicationMasteræ¶æ„</title>
      <link href="/YARNSrcApplicationMasterArch.html"/>
      <url>/YARNSrcApplicationMasterArch.html</url>
      
        <content type="html"><![CDATA[<p>å‰é¢å‡ ç¯‡å…³äºApplicationMasterçš„æ–‡ç« ï¼ŒæŠŠApplicationMasterä¸RMä¹‹å‰çš„ç›¸å…³çš„æµç¨‹å·²æ¢³ç†å®Œæ¯•äº†(<em>ApplicationMasterä¸NMä¹‹å‰çš„æµç¨‹éšåæ¢³ç†</em>)ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªå…³é”®ç±»ApplicationMaster(ä»¥MRAppMasterä¸ºä¾‹)ã€AMLivelinessMonitorã€ApplicationMasterLauncherå’ŒApplicationMasterServiceï¼Œæœ¬ç¯‡é‡ç‚¹ä»‹ç»ä¸‹è¿™4ä¸ªç±»ä¹‹é—´çš„å…³ç³»ã€‚</p><span id="more"></span><p>å…ˆçœ‹ä¸‹è¿™4ä¸ªç±»ä¹‹é—´çš„æ•´ä½“æ¶æ„å›¾ï¼š<br><img src="/blogimgs/appmaster/amArch.png" alt="ApplicationMasteræ¶æ„å›¾" title="ApplicationMasteræ¶æ„å›¾"></p><p>ç®€å•æè¿°ä¸‹æ•´ä¸ªæµç¨‹ï¼š</p><ul><li><p>é¦–å…ˆclientå‘RMæäº¤ä¸€ä¸ªapplicationè¯·æ±‚ï¼ŒRMåˆ›å»ºä¸€ä¸ªapplicationï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªappattemptï¼ŒåæœŸçš„è°ƒåº¦å’Œä»»åŠ¡çš„æ‹†è§£éƒ½æ˜¯å¯¹è¿™ä¸ªappattemptè¿›è¡Œçš„ã€‚éšç€appattemptçš„çŠ¶æ€å˜åŒ–ï¼Œä¼šè§¦å‘<code>AMLauncherEventType.LAUNCH</code>äº‹ä»¶ç±»å‹çš„äº‹ä»¶ï¼Œç”±<code>ApplicationMasterLauncher.handle</code>è¿›è¡Œå¤„ç†ï¼Œé€šè¿‡RPCè°ƒç”¨<code>containerMgrProxy.startContainers</code>æ¥å¯åŠ¨ä¸€ä¸ªApplicationMasterã€‚</p></li><li><p>ApplicationMasterå¯åŠ¨æˆåŠŸä¹‹åï¼Œè¿”å›åˆ°<code>AMLauncher.run</code>ä¸­ä¼šè§¦å‘<code>RMAppAttemptEventType.LAUNCHED</code>äº‹ä»¶ç±»å‹çš„äº‹ä»¶ï¼Œå‘<code>AMLivelinessMonitor</code>ä¸­æ³¨å†Œamã€‚</p></li><li><p>ä»¥MRAppMasterä¸ºä¾‹ï¼Œå½“ApplicationMasterå¯åŠ¨æ—¶ä¼šå¯åŠ¨<code>MRAppMaster</code>è¿™ä¸ªæœåŠ¡ï¼ŒMRAppMasterå¯åŠ¨çš„æ—¶å€™ä¼šå‘<code>ApplicationMasterService</code>æ³¨å†Œã€‚</p></li><li><p>ç„¶åå¼€å¯ä¸€ä¸ªå¿ƒè·³çº¿ç¨‹ï¼Œç”±æ­¤çº¿ç¨‹å‘¨æœŸæ€§çš„å‘é€å¿ƒè·³ï¼Œå¿ƒè·³ä¸­åŒ…å«æ‰€éœ€containerçš„è¯·æ±‚åˆ—è¡¨å’Œæ‰€è¦é‡Šæ”¾çš„containerçš„åˆ—è¡¨ï¼Œé€šè¿‡RPCè°ƒç”¨<code>ApplicationMasterService.allocate</code>æ¥è·å–èµ„æºï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¼šå‘<code>AMLivelinessMonitor</code>å‘é€pingï¼Œæ›´æ–°åœ¨<code>AMLivelinessMonitor</code>ä¸­è®°å½•çš„ç”Ÿå‘½æ—¶é’Ÿã€‚ </p></li><li><p>å½“jobç»“æŸä¹‹åï¼Œè°ƒç”¨<code>ApplicationMaster.finish</code>ï¼Œé€šè¿‡RPCæœ€ç»ˆè°ƒç”¨<code>ApplicationMasterService.finishApplicationMaster</code>ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¾ç„¶ä¼šå‘<code>AMLivelinessMonitor</code>å‘é€pingï¼Œæ›´æ–°åœ¨<code>AMLivelinessMonitor</code>ä¸­è®°å½•çš„ç”Ÿå‘½æ—¶é’Ÿã€‚</p></li></ul><p>ä¸‹é¢æ¦‚æ‹¬ä¸‹å„ä¸ªç±»çš„ä¸»è¦ä½œç”¨ï¼š</p><blockquote><p>ApplicationMasterLauncher</p></blockquote><p>ApplicationMasterLauncherç»§æ‰¿äº†AbstractServiceå®ç°äº†EventHandleræ¥å£ï¼Œä½¿å…¶å³æ˜¯ä¸€ä¸ªæœåŠ¡ä¹Ÿæ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ã€‚<br>ApplicationMasterLauncheråªå¤„ç†ä¸¤ç±»äº‹ä»¶ï¼Œä¸€ä¸ªæ˜¯å¯åŠ¨AMçš„<code>LAUNCH</code>å’Œæ¸…ç†AMçš„<code>CLEANUP</code>è¯·æ±‚ï¼Œè¿™ä¸¤ç±»äº‹ä»¶è¢«æ”¾å…¥ä¸€ä¸ªäº‹ä»¶é˜Ÿåˆ—ä¸­ï¼Œç”±<em>ApplicationMasterLauncherä½œä¸ºæœåŠ¡æ—¶ï¼Œå¯åŠ¨ä¸€ä¸ªlauncherHandlingThreadçº¿ç¨‹å°†äº‹ä»¶å–å‡ºæ”¾å…¥çº¿ç¨‹æ± ä¸­å¤„ç†</em>ã€‚<br>å¦‚æœApplicationMasterLauncheræ”¶åˆ°äº†<code>LAUNCH</code>ç±»å‹çš„äº‹ä»¶ï¼Œå®ƒä¼šä¸å¯¹åº”çš„NodeManageré€šä¿¡ï¼Œè¦æ±‚å®ƒå¯åŠ¨ApplicationMasterã€‚æ•´ä¸ªè¿‡ç¨‹åœ¨<a href="http://bigdatadecode.top/YARNSrcApplicationMasterStart.html">è¿™ç¯‡æ–‡ç« </a>ä¸­è¯¦ç»†ä»‹ç»äº†ä¸‹ï¼Œè¿™é‡Œç®€å•å›é¡¾ä¸‹ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªContainerManageråè®®çš„Clientï¼Œç„¶åå‘å¯¹åº”çš„NodeManagerå‘èµ·è¿æ¥è¯·æ±‚ï¼Œæ¥ç€å°†å¯åŠ¨AMæ‰€éœ€çš„å„ç§ä¿¡æ¯ï¼ŒåŒ…æ‹¬å‘½ä»¤ï¼ŒJaråŒ…ã€ç¯å¢ƒå˜é‡ç­‰ä¿¡æ¯ï¼Œå°è£…æˆä¸€ä¸ªStartContainerRequestå¯¹è±¡ï¼Œç„¶åé€šè¿‡RPCå‡½æ•°ContainerManager.startContainer()å‘é€ç»™å¯¹åº”çš„NMã€‚<br>å¦‚æœApplicationMasterLauncheræ”¶åˆ°äº†<code>CLEANUP</code>ç±»å‹çš„äº‹ä»¶ï¼Œå®ƒä¼šä¸å¯¹åº”çš„NodeManageré€šä¿¡ï¼Œè¦æ±‚å®ƒæ€æ­»ApplicationMasterã€‚æ•´ä¸ªè¿‡ç¨‹ä¸å¯åŠ¨AMçš„è¿‡ç¨‹ç±»ä¼¼ã€‚</p><blockquote><p>AMLivelinessMonitor</p></blockquote><p><em>AMLivelinessMonitorä¸»è¦ç”¨æ¥ç›‘æ§amçš„ç”Ÿå‘½çŠ¶æ€</em>ï¼Œå¦‚æœAMé•¿æ—¶é—´æ²¡æœ‰å¿ƒè·³ä¿¡æ¯æ›´æ–°ï¼ŒRMå°±ä¼šé€šçŸ¥NodeManageræŠŠAMç§»é™¤ã€‚appattemptåœ¨å¯åŠ¨çš„æ—¶å€™ä¼šå‘å…¶æ³¨å†Œamä¿¡æ¯ï¼Œç„¶åAMLivelinessMonitorä¼šå‘¨æœŸæ€§éå†æ‰€æœ‰ApplicationMasterï¼Œå¦‚æœä¸€ä¸ªApplicationMasteråœ¨ä¸€å®šæ—¶é—´ï¼ˆå¯é€šè¿‡å‚æ•°yarn.am.liveness-monitor.expiry-interval-msé…ç½®ï¼Œé»˜è®¤ä¸º10minï¼‰å†…æœªæ±‡æŠ¥å¿ƒè·³ä¿¡æ¯ï¼Œåˆ™è®¤ä¸ºå®ƒæ­»æ‰äº†ï¼Œå®ƒä¸Šé¢æ‰€æœ‰æ­£åœ¨è¿è¡Œçš„Containerå°†è¢«ç½®ä¸ºè¿è¡Œå¤±è´¥ï¼ˆRMä¸ä¼šé‡æ–°æ‰§è¡Œè¿™äº›Containerï¼Œå®ƒåªä¼šé€šè¿‡å¿ƒè·³æœºåˆ¶å‘Šè¯‰å¯¹åº”çš„AMï¼Œç”±AMå†³å®šæ˜¯å¦é‡æ–°æ‰§è¡Œï¼Œå¦‚æœéœ€è¦ï¼Œåˆ™AMé‡æ–°å‘RMç”³è¯·èµ„æºï¼‰ï¼ŒAMæœ¬èº«ä¼šè¢«é‡æ–°åˆ†é…åˆ°å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹ä¸Šï¼ˆç®¡ç†å‘˜å¯é€šè¿‡å‚æ•°yarn.resourcemanager.am.max-retriesæŒ‡å®šæ¯ä¸ªApplicationMasterçš„å°è¯•æ¬¡æ•°ï¼Œé»˜è®¤æ˜¯1æ¬¡ï¼‰æ‰§è¡Œã€‚</p><blockquote><p>ApplicationMasterService</p></blockquote><p>ApplicationMasterServiceè´Ÿè´£å¤„ç†æ¥è‡ªApplicationMasterçš„è¯·æ±‚ï¼Œä¸»è¦åŒ…æ‹¬ä¸‰ç§è¯·æ±‚ï¼šæ³¨å†Œã€å¿ƒè·³å’Œæ¸…ç†ï¼Œè¿™éƒ¨åˆ†å†…å®¹åœ¨<a href="http://bigdatadecode.top/YARNSrcRMContainerAllocator.html">è¿™ç¯‡æ–‡ç« </a>ä¸­è¯¦ç»†ä»‹ç»äº†ä¸‹ï¼Œè¿™é‡Œç®€å•å›é¡¾ä¸‹ï¼Œå…¶ä¸­ï¼Œæ³¨å†Œæ˜¯ApplicationMasterå¯åŠ¨æ—¶å‘ç”Ÿçš„è¡Œä¸ºï¼Œè¯·æ±‚åŒ…ä¸­åŒ…å«AMæ‰€åœ¨èŠ‚ç‚¹ï¼ŒRPCç«¯å£å·å’Œtracking URLç­‰ä¿¡æ¯ï¼›å¿ƒè·³æ˜¯å‘¨æœŸæ€§è¡Œä¸ºï¼ŒåŒ…å«è¯·æ±‚èµ„æºçš„ç±»å‹æè¿°ã€å¾…é‡Šæ”¾çš„Containeråˆ—è¡¨ç­‰ï¼Œè€ŒAMSåˆ™ä¸ºä¹‹è¿”å›æ–°åˆ†é…çš„Containerã€å·²å®Œæˆçš„Containerç­‰ä¿¡æ¯ï¼›æ¸…ç†æ˜¯åº”ç”¨ç¨‹åºè¿è¡Œç»“æŸæ—¶å‘ç”Ÿçš„è¡Œä¸ºï¼ŒApplicationMasterå‘RMå‘é€æ¸…ç†åº”ç”¨ç¨‹åºçš„è¯·æ±‚ï¼Œä»¥å›æ”¶èµ„æºå’Œæ¸…ç†å„ç§æ•°æ®ç»“æ„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> ApplicationMaster </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹RMContainerAllocator</title>
      <link href="/YARNSrcRMContainerAllocator.html"/>
      <url>/YARNSrcRMContainerAllocator.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/YarnSrcMRCreateContainerRequest.html">ä¸Šä¸€ç¯‡</a>æåˆ°RMContainerAllocatoræ—¢æ˜¯ä¸€ä¸ªserviceä¹Ÿæ˜¯ä¸€ä¸ªeventHandleï¼Œå¹¶ä¸”ç®€å•ä»‹ç»äº†ä¸‹ä½œä¸ºeventHandleçš„åŠŸèƒ½ï¼Œç°åœ¨æ¥ä»‹ç»ä¸‹ä½œä¸ºserviceæœåŠ¡çš„åŠŸèƒ½ã€‚</p><span id="more"></span><p>RMContainerAllocatorç»§æ‰¿RMContainerRequestorç±»ï¼ŒRMContainerRequestoråˆç»§æ‰¿è‡ªRMCommunicatorï¼ŒRMCommunicatorç±»åœ¨ä»£ç ä¸­çš„æ³¨é‡Šæ˜¯<code>Registers/unregisters to RM and sends heartbeats to RM.</code></p><p>RMContainerAllocatoræ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œåœ¨MRAppMaster.serviceInitä¸­æ·»åŠ åˆ°MRAppMasterä¸­ï¼Œå¹¶ä¸”åœ¨serviceStartä¸­å¯åŠ¨è¯¥æœåŠ¡ï¼Œå¯åŠ¨æ—¶é¦–å…ˆè°ƒç”¨initï¼Œç„¶åè°ƒç”¨startã€‚<br>RMContainerAllocator.serviceInitä¸»è¦æ˜¯ä¸€äº›å±æ€§å€¼çš„è®¾ç½®ï¼Œé‡ç‚¹çœ‹ä¸‹serviceStartæ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">// new ä¸€ä¸ªçº¿ç¨‹ä»eventQueueä¸­takeäº‹ä»¶è¿›è¡Œå¤„ç†</span></span><br><span class="line">  <span class="keyword">this</span>.eventHandlingThread = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ContainerAllocatorEvent event;</span><br><span class="line">      <span class="keyword">while</span> (!stopped.get() &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          event = RMContainerAllocator.<span class="keyword">this</span>.eventQueue.take();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          handleEvent(event);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          ...</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.eventHandlingThread.start();</span><br><span class="line">  <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„serviceStartï¼Œé‡ç‚¹å…³æ³¨</span></span><br><span class="line">  <span class="keyword">super</span>.serviceStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceStartä¸­å¯åŠ¨äº†ä¸€ä¸ªeventHandlingThreadçº¿ç¨‹ï¼Œç”¨äºå¤„ç†eventQueueä¸­çš„äº‹ä»¶ï¼Œæ­¤æ—¶çœ‹RMContainerAllocatorç±»çš„ä¸»è¦åŠŸèƒ½æ˜¯eventHandleï¼Œæ¥ç€ç»§ç»­çœ‹å®ƒè°ƒç”¨çš„çˆ¶ç±»<code>super.serviceStart()</code>ï¼Œè¯¥çˆ¶ç±»æ˜¯<code>RMCommunicator</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">// scheduleræ˜¯ApplicationMasterProtocolç±»å‹</span></span><br><span class="line">  scheduler= createSchedulerProxy();</span><br><span class="line">  JobID id = TypeConverter.fromYarn(<span class="keyword">this</span>.applicationId);</span><br><span class="line">  JobId jobId = TypeConverter.toYarn(id);</span><br><span class="line">  job = context.getJob(jobId);</span><br><span class="line">  <span class="comment">// amæ³¨å†Œ</span></span><br><span class="line">  register();</span><br><span class="line">  <span class="comment">// å¯åŠ¨ä¸€ä¸ªå¿ƒè·³çº¿ç¨‹</span></span><br><span class="line">  startAllocatorThread();</span><br><span class="line">  <span class="keyword">super</span>.serviceStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ä¸ªé‡è¦æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>register</code>å’Œ<code>startAllocatorThread</code>ï¼Œå…¶å®RMContainerAllocatorä½œä¸ºserviceçš„ä¸»è¦åŠŸèƒ½å°±æ˜¯<em>æ³¨å†Œ</em>å’Œ<em>å¿ƒè·³</em>ã€‚</p><h2 id="æ³¨å†Œ"><a href="#æ³¨å†Œ" class="headerlink" title="æ³¨å†Œ"></a>æ³¨å†Œ</h2><p>registeræ˜¯å‘rmæ³¨å†Œæ­¤mrçš„amï¼ŒstartAllocatorThreadæ˜¯å¯åŠ¨amäºrmä¹‹é—´å¿ƒè·³çš„çº¿ç¨‹ã€‚registerä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//Register</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    RegisterApplicationMasterRequest request =</span><br><span class="line">      recordFactory.newRecordInstance(RegisterApplicationMasterRequest.class);</span><br><span class="line">    ...</span><br><span class="line">    RegisterApplicationMasterResponse response =</span><br><span class="line">      scheduler.registerApplicationMaster(request);</span><br><span class="line">    isApplicationMasterRegistered = <span class="keyword">true</span>;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception are) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Exception while registering&quot;</span>, are);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(are);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>registeræ˜¯å‘<code>ApplicationMasterService</code>æ³¨å†ŒamæœåŠ¡ï¼Œé€šè¿‡rpcåè®®<code>ApplicationMasterProtocol</code>è°ƒç”¨<code>ApplicationMasterService.registerApplicationMaster</code>å‘ApplicationMasterServiceè¿›è¡Œæ³¨å†Œï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RegisterApplicationMasterResponse <span class="title">registerApplicationMaster</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    RegisterApplicationMasterRequest request)</span> <span class="keyword">throws</span> YarnException,</span></span><br><span class="line"><span class="function">    IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Allow only one thread in AM to do registerApp at a time.</span></span><br><span class="line">  <span class="keyword">synchronized</span> (lock) &#123;</span><br><span class="line">    AllocateResponse lastResponse = lock.getAllocateResponse();</span><br><span class="line">    <span class="comment">// hasApplicationMasterRegisteredä¸­æœ‰ä¸ªåŒé‡æ ¡éªŒé”</span></span><br><span class="line">    <span class="comment">// responseId&gt;=0æ˜¯åˆ¤æ–­æ˜¯å¦æ³¨å†Œçš„ä¸€ä¸ªæ¡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span> (hasApplicationMasterRegistered(applicationAttemptId)) &#123;</span><br><span class="line">     ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‘AMLivelinessMonitoræ›´æ–°amå­˜æ´»æ—¶é—´</span></span><br><span class="line">    <span class="keyword">this</span>.amLivelinessMonitor.receivedPing(applicationAttemptId);</span><br><span class="line">    <span class="comment">// Setting the response id to 0 to identify if the</span></span><br><span class="line">    <span class="comment">// application master is register for the respective attemptid</span></span><br><span class="line">    <span class="comment">// æœªæ³¨å†Œæ—¶ä¸º-1ï¼Œåˆ¤æ–­æ˜¯å¦æ³¨å†Œçš„ä¸€ä¸ªæ ‡å‡†æ—¶&gt;=0</span></span><br><span class="line">    <span class="comment">// responseIdä»0å¼€å§‹ï¼Œæ³¨å†Œæ—¶ä¸º0</span></span><br><span class="line">    lastResponse.setResponseId(<span class="number">0</span>);</span><br><span class="line">    lock.setAllocateResponse(lastResponse);</span><br><span class="line">    LOG.info(<span class="string">&quot;AM registration &quot;</span> + applicationAttemptId);</span><br><span class="line">    <span class="comment">// ç”±å¼‚æ­¥è°ƒåº¦å™¨å‘å‡ºRMAppAttemptEventType.REGISTEREDäº‹ä»¶</span></span><br><span class="line">    <span class="keyword">this</span>.rmContext</span><br><span class="line">      .getDispatcher()</span><br><span class="line">      .getEventHandler()</span><br><span class="line">      .handle(</span><br><span class="line">        <span class="keyword">new</span> RMAppAttemptRegistrationEvent(applicationAttemptId, request</span><br><span class="line">          .getHost(), request.getRpcPort(), request.getTrackingUrl()));</span><br><span class="line">    RMAuditLogger.logSuccess(app.getUser(), AuditConstants.REGISTER_AM,</span><br><span class="line">      <span class="string">&quot;ApplicationMasterService&quot;</span>, appID, applicationAttemptId);</span><br><span class="line">    <span class="comment">// æ„é€ response</span></span><br><span class="line">    <span class="comment">// Pick up min/max resource from scheduler...</span></span><br><span class="line">    RegisterApplicationMasterResponse response = recordFactory</span><br><span class="line">        .newRecordInstance(RegisterApplicationMasterResponse.class);</span><br><span class="line">    ...</span><br><span class="line">    response.setSchedulerResourceTypes(rScheduler</span><br><span class="line">      .getSchedulingResourceTypes());</span><br><span class="line">    <span class="keyword">return</span> response;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>amå‘ApplicationMasterServiceæ³¨å†Œæ—¶registerApplicationMasteræ–¹æ³•æ˜¯éç°åœºå®‰å…¨çš„ï¼Œåˆ™æ³¨å†Œæ—¶éœ€è¦è·å–AllocateResponseLockå¯¹è±¡é”ï¼Œå…¶æ³¨å†Œçš„æµç¨‹æ˜¯<em>æ›´æ–°amåœ¨AMLivelinessMonitorä¸­çš„ç”Ÿå‘½æ—¶é’Ÿ</em>ï¼Œè®¾ç½®responseIdä¸º0ï¼Œç„¶åæ„é€ ä¸€ä¸ªRMAppAttemptEventType.REGISTEREDäº‹ä»¶ç±»å‹çš„äº‹ä»¶ï¼Œç”±å¼‚æ­¥è°ƒåº¦å™¨åˆ†å‘ç»™ç›¸åº”çš„Eventhandleå¤„ç†ã€‚<br>æ­¤æ—¶æ³¨å†Œè¿‡ç¨‹ç»“æŸï¼Œæ„å»ºä¸€ä¸ªresponseè¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h2 id="å¿ƒè·³"><a href="#å¿ƒè·³" class="headerlink" title="å¿ƒè·³"></a>å¿ƒè·³</h2><p>amæ³¨å†Œç»“æŸä¹‹åï¼Œå›åˆ°<code>RMCommunicator.serviceStart</code>ä¸­ï¼Œæ‰§è¡Œ<code>startAllocatorThread</code>å¯åŠ¨ä¸€ä¸ªå¿ƒè·³çº¿ç¨‹ï¼Œå‘¨æœŸæ€§çš„å‘<code>ApplicationMasterService</code>è¿›è¡Œå¿ƒè·³ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startAllocatorThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  allocatorThread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (!stopped.get() &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// å¿ƒè·³é—´éš”</span></span><br><span class="line">          Thread.sleep(rmPollInterval);</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// è°ƒç”¨RMContainerAllocator.heartbeat</span></span><br><span class="line">            heartbeat();</span><br><span class="line">          &#125; <span class="keyword">catch</span> (YarnRuntimeException e) &#123;</span><br><span class="line">            ...</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          lastHeartbeatTime = context.getClock().getTime();</span><br><span class="line">          <span class="comment">// æ¯æ¬¡å¿ƒè·³éƒ½è°ƒç”¨è¿™ä¸ªï¼Œå¹²ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">          executeHeartbeatCallbacks();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  allocatorThread.setName(<span class="string">&quot;RMCommunicator Allocator&quot;</span>);</span><br><span class="line">  allocatorThread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ï¼Œå°†çº¿ç¨‹å‘½åä¸º<em>RMCommunicator Allocator</em>ï¼Œæ¯éš”rmPollIntervalæ—¶é—´ï¼Œæ‰§è¡Œä¸€æ¬¡<code>heartbeat</code>ã€‚æ­¤æ–‡ä¸­RMCommunicatoræŠ½è±¡ç±»çš„å­ç±»æ˜¯RMContainerAllocatorï¼Œåˆ™heartbeatçš„å®ç°æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">heartbeat</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  scheduleStats.updateAndLogIfChanged(<span class="string">&quot;Before Scheduling: &quot;</span>);</span><br><span class="line">  <span class="comment">// å…³é”®æ–¹æ³•ï¼Œä¼šè¿œç¨‹è°ƒç”¨Scheduler.allocatedæ–¹æ³•å¯¹èµ„æºè¿›è¡Œallocate</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œåªæ˜¯ç”³è¯·åˆ°èµ„æºï¼Œä½†èµ„æºå¹¶æ²¡æœ‰äºtaskç»‘å®šï¼Œä¹Ÿå°±æ˜¯è¯´èµ„æºå¹¶æ²¡æœ‰åˆ†é…ç»™task</span></span><br><span class="line">  List&lt;Container&gt; allocatedContainers = getResources();</span><br><span class="line">  <span class="keyword">if</span> (allocatedContainers != <span class="keyword">null</span> &amp;&amp; allocatedContainers.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// å°†èµ„æºåˆ†é…ç»™task</span></span><br><span class="line">    scheduledRequests.assign(allocatedContainers);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å¦‚æœtaskçš„è¿›åº¦å‘ç”Ÿå˜åŒ–å¹¶ä¸”å‰©ä½™çš„mapä¸ªå¤§äº0ï¼Œåˆ™è§¦å‘æ˜¯å¦è°ƒåº¦reduceåˆ¤æ–­</span></span><br><span class="line">  <span class="keyword">if</span> ((lastCompletedTasks != completedTasks) ||</span><br><span class="line">        (scheduledRequests.maps.size() &gt; <span class="number">0</span>)) &#123;</span><br><span class="line">    lastCompletedTasks = completedTasks;</span><br><span class="line">    recalculateReduceSchedule = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (recalculateReduceSchedule) &#123;</span><br><span class="line">    preemptReducesIfNeeded();</span><br><span class="line">    <span class="comment">// æ˜¯å¦è¦è°ƒåº¦reduce</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œè¦å…³æ³¨mapreduce.job.reduce.slowstart.completedmaps</span></span><br><span class="line">    <span class="comment">// å’Œyarn.app.mapreduce.am.job.reduce.rampup.limit</span></span><br><span class="line">    scheduleReduces(</span><br><span class="line">        getJob().getTotalMaps(), completedMaps,</span><br><span class="line">        scheduledRequests.maps.size(), scheduledRequests.reduces.size(), </span><br><span class="line">        assignedRequests.maps.size(), assignedRequests.reduces.size(),</span><br><span class="line">        mapResourceRequest, reduceResourceRequest,</span><br><span class="line">        pendingReduces.size(), </span><br><span class="line">        maxReduceRampupLimit, reduceSlowStart);</span><br><span class="line">    recalculateReduceSchedule = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  scheduleStats.updateAndLogIfChanged(<span class="string">&quot;After Scheduling: &quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>heartbeatä¸»è¦ç”¨äºamå’Œrmä¹‹é—´å‘¨æœŸæ€§çš„é€šä¿¡ï¼Œä»¥å‘ŠçŸ¥rmæ­¤amæ˜¯å¦å­˜æ´»ï¼Œä½†heartbeatä¸­ä¸æ­¢åªæ˜¯ç”Ÿå‘½å¿ƒè·³ï¼Œåœ¨å‘é€çš„requestä¸­åŒ…å«<em>è¯·æ±‚èµ„æºçš„åˆ—è¡¨ask</em>å’Œ<em>éœ€è¦é‡Šæ”¾çš„èµ„æºåˆ—è¡¨release</em>ï¼Œè¿”å›çš„responseåŒ…å«äº†<em>allocatedçš„èµ„æº</em>å’Œ*å·²ç»å®Œæˆçš„container(æ˜¯ç”±ä¸Šæ¬¡è¯·æ±‚ä¸­releaseåˆ—è¡¨ä¸­å¾—åˆ°çš„)*ã€‚<br>è¿”å›çš„containerèµ„æºæ­¤æ—¶å¹¶æ²¡æœ‰åˆ†é…ç»™taskï¼Œè€Œæ˜¯é€šè¿‡<code>scheduledRequests.assign</code>å°†containerèµ„æºåˆ†é…ç»™å…·ä½“çš„taskã€‚<br>heartbeatä¸­é€šè¿‡<code>getResources()</code>é€šè¿‡Schedulerè·å–é›†ç¾¤èµ„æºï¼ŒæŸ¥çœ‹ä¸‹getResourcesçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;Container&gt; <span class="title">getResources</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å‘é€requestï¼Œè¿œç¨‹è°ƒç”¨Scheduler.allocatedåˆ†é…èµ„æº</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    response = makeRemoteRequest();</span><br><span class="line">    <span class="comment">// Reset retry count if no exception occurred.</span></span><br><span class="line">    retrystartTime = System.currentTimeMillis();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ApplicationAttemptNotFoundException e ) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  List&lt;Container&gt; newContainers = response.getAllocatedContainers();</span><br><span class="line">  <span class="comment">// Setting NMTokens</span></span><br><span class="line">  <span class="comment">// Setting AMRMToken</span></span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  List&lt;ContainerStatus&gt; finishedContainers = response.getCompletedContainersStatuses();</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Called on each allocation. Will know about newly blacklisted/added hosts.</span></span><br><span class="line">  computeIgnoreBlacklisting();</span><br><span class="line">  <span class="comment">// è®©response.getUpdatedNodes()è¿›è¡Œreportï¼ŒæŸ¥çœ‹æ˜¯å¦ä¸ºä¸ç¨³å®šçŠ¶æ€ï¼Œ</span></span><br><span class="line">  <span class="comment">// æ›´æ–°unusableNodesï¼Œå°†è¿™äº›èŠ‚ç‚¹ä¸Šçš„task killæ‰</span></span><br><span class="line">  handleUpdatedNodes(response);</span><br><span class="line">  <span class="comment">// å¯¹å¿ƒè·³å“åº”ä¸­å¾—åˆ°çš„finishContainerè¿›è¡Œå¤„ç†</span></span><br><span class="line">  <span class="keyword">for</span> (ContainerStatus cont : finishedContainers) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Received completed container &quot;</span> + cont.getContainerId());</span><br><span class="line">    TaskAttemptId attemptID = assignedRequests.get(cont.getContainerId());</span><br><span class="line">    <span class="keyword">if</span> (attemptID == <span class="keyword">null</span>) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Container complete event for unknown container id &quot;</span></span><br><span class="line">          + cont.getContainerId());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      pendingRelease.remove(cont.getContainerId());</span><br><span class="line">      assignedRequests.remove(attemptID);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// send the container completed event to Task attempt</span></span><br><span class="line">      eventHandler.handle(createContainerFinishedEvent(cont, attemptID));</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Send the diagnostics</span></span><br><span class="line">      String diagnostics = StringInterner.weakIntern(cont.getDiagnostics());</span><br><span class="line">      eventHandler.handle(<span class="keyword">new</span> TaskAttemptDiagnosticsUpdateEvent(attemptID,</span><br><span class="line">          diagnostics));</span><br><span class="line">    &#125;      </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> newContainers;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€çœ‹getResourcesè¿™ä¸ªåå­—å°±çŸ¥é“è¿™é‡Œä¼šæœ‰ä¸ªè¿œç¨‹rpcè°ƒç”¨ä»rmå¤„è·å–èµ„æºï¼Œæ–¹æ³•ä¸º<code>makeRemoteRequest</code>ï¼Œå…·ä½“ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> AllocateResponse <span class="title">makeRemoteRequest</span><span class="params">()</span> <span class="keyword">throws</span> YarnException,</span></span><br><span class="line"><span class="function">    IOException </span>&#123;</span><br><span class="line">  ResourceBlacklistRequest blacklistRequest =</span><br><span class="line">      ResourceBlacklistRequest.newInstance(<span class="keyword">new</span> ArrayList&lt;String&gt;(blacklistAdditions),</span><br><span class="line">          <span class="keyword">new</span> ArrayList&lt;String&gt;(blacklistRemovals));</span><br><span class="line">  <span class="comment">// ask é€šè¿‡ scheduledRequests.addMap  addResourceRequest æ›´æ–°</span></span><br><span class="line">  <span class="comment">// è¯·æ±‚ä¸­åŒ…æ‹¬ ask &amp; release é›†åˆ</span></span><br><span class="line">  AllocateRequest allocateRequest =</span><br><span class="line">      AllocateRequest.newInstance(lastResponseID,</span><br><span class="line">        <span class="keyword">super</span>.getApplicationProgress(), <span class="keyword">new</span> ArrayList&lt;ResourceRequest&gt;(ask),</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;ContainerId&gt;(release), blacklistRequest);</span><br><span class="line">  <span class="comment">// è°ƒåº¦å™¨åˆ†é…èµ„æº   scheduler.allocate (ApplicationMasterProtocol)</span></span><br><span class="line">  <span class="comment">// åœ¨allocateä¸­ä¼šæ›´æ–°AMLivelinessMonitorä¸­çš„æ—¶é—´</span></span><br><span class="line">  AllocateResponse allocateResponse = scheduler.allocate(allocateRequest);</span><br><span class="line">  lastResponseID = allocateResponse.getResponseId();</span><br><span class="line">  availableResources = allocateResponse.getAvailableResources();</span><br><span class="line">  lastClusterNmCount = clusterNmCount;</span><br><span class="line">  clusterNmCount = allocateResponse.getNumClusterNodes(); </span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> allocateResponse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>makeRemoteRequeståˆ©ç”¨askå’Œreleaseåˆ—è¡¨ä»¥åŠblackListæ„å»ºä¸€ä¸ª<code>AllocateRequest</code>å¯¹è±¡ï¼Œç”¨äºå‘ApplicationMasterServiceè¯·æ±‚åˆ†é…èµ„æºã€‚<br>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯askä¸­çš„æ‰€æœ‰è¯·æ±‚å’Œreleaseåˆ—è¡¨ä¸­containerä¼šåœ¨æ¯æ¬¡å¿ƒè·³æ—¶å‘é€ç»™ApplicationMasterServiceï¼Œç„¶åæ­¤æ—¶ä»ApplicationMasterServiceè¿”å›çš„responseä¸­åŒ…å«çš„å·²åˆ†é…çš„containerä¿¡æ¯å¹¶æ²¡æœ‰æ­¤æ¬¡askä¸­çš„è¯·æ±‚ä¿¡æ¯ï¼Œè€Œæ˜¯åœ¨æ­¤æ¬¡å¿ƒè·³ä¹‹å‰å‘é€ç»™ApplicationMasterServiceçš„containerè¯·æ±‚å¯¹åº”çš„èµ„æºã€‚</p><p>makeRemoteRequestè¿”å›ApplicationMasterServiceçš„responseï¼Œresponseä¸­åŒ…æ‹¬å“åº”idã€å½“å‰é›†ç¾¤å¯ç”¨çš„èµ„æºå’Œé›†ç¾¤çš„èŠ‚ç‚¹ä¸ªæ•°ï¼Œè¿˜æœ‰<em>æœ€å…³é”®çš„åˆ†é…çš„containeråˆ—è¡¨ä»¥åŠfinishContaineråˆ—è¡¨</em>ã€‚<br>åœ¨<code>getResources</code>ä¸­æ‹¿åˆ°<code>newContainers</code>å’Œ<code>finishedContainers</code>ï¼Œå¯¹newContainersè®¾ç½®ä¸€äº›Tokensï¼Œéå†finishedContainersï¼Œä»<code>assignedRequests</code>å°†finishedContainerç§»é™¤ï¼Œå¹¶è§¦å‘ä¸€ä¸ª<code>TaskAttemptEvent</code>äº‹ä»¶ã€‚<br>åœ¨getResourcesä¸­åªå¯¹finishedContainersè¿›è¡Œäº†å¤„ç†ï¼Œå¯¹æ–°å¾—åˆ°çš„containerèµ„æºå¹¶æ²¡æœ‰åˆ†é…ç»™å…·ä½“çš„taskã€‚ä»getResourceæ–¹æ³•è¿”å›åˆ°<code>heartbeat</code>ä¸­ï¼Œè°ƒç”¨<code>scheduledRequests.assign(allocatedContainers)</code>ç»™taskåˆ†é…èµ„æºã€‚å…·ä½“ä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assign</span><span class="params">(List&lt;Container&gt; allocatedContainers)</span> </span>&#123;</span><br><span class="line">  Iterator&lt;Container&gt; it = allocatedContainers.iterator();</span><br><span class="line">  LOG.info(<span class="string">&quot;Got allocated containers &quot;</span> + allocatedContainers.size());</span><br><span class="line">  containersAllocated += allocatedContainers.size();</span><br><span class="line">  <span class="comment">// å¯¹allocatedContainersè¿›è¡Œè¿‡æ»¤ï¼Œå°†ä¸èƒ½åˆ†é…çš„èµ„æºç§»é™¤</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// åˆ†é…èµ„æºç»™task</span></span><br><span class="line">  assignContainers(allocatedContainers);</span><br><span class="line">  <span class="comment">// å°†å‰©ä½™æœªåˆ†é…çš„èµ„æºé‡Šæ”¾æ‰</span></span><br><span class="line">  <span class="comment">// release container if we could not assign it </span></span><br><span class="line">  it = allocatedContainers.iterator();</span><br><span class="line">  <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">    Container allocated = it.next();</span><br><span class="line">    LOG.info(<span class="string">&quot;Releasing unassigned and invalid container &quot;</span> </span><br><span class="line">        + allocated + <span class="string">&quot;. RM may have assignment issues&quot;</span>);</span><br><span class="line">    containerNotAssigned(allocated);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>assignåœ¨åˆ†é…èµ„æºä¹‹å‰ä¼šå…ˆè¿‡æ»¤ä¸‹allocatedContainersåˆ—è¡¨ä¸­çš„èµ„æºï¼Œå¯¹äºæ— æ³•æ»¡è¶³requestçš„containerå’Œåœ¨é»‘åå•ä¸­çš„containerä»åˆ—è¡¨ä¸­ç§»é™¤ï¼Œå¯¹è¿‡æ»¤è¿‡çš„<code>allocatedContainers</code>è°ƒç”¨<code>assignContainers</code>è¿›è¡Œåˆ†é…ï¼Œæœ€åå¯¹æ²¡æœ‰åˆ†é…çš„å‰©ä½™containerè¿›è¡Œé‡Šæ”¾ã€‚assignContainersä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assignContainers</span><span class="params">(List&lt;Container&gt; allocatedContainers)</span> </span>&#123;</span><br><span class="line">  Iterator&lt;Container&gt; it = allocatedContainers.iterator();</span><br><span class="line">  <span class="keyword">while</span> (it.hasNext()) &#123;</span><br><span class="line">    Container allocated = it.next();</span><br><span class="line">    <span class="comment">// æ— æœ¬åœ°æ€§è¦æ±‚çš„task å¦‚ reduceå’Œfail map task</span></span><br><span class="line">    ContainerRequest assigned = assignWithoutLocality(allocated);</span><br><span class="line">    <span class="keyword">if</span> (assigned != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å°†containeråˆ†é…ç»™task attemptï¼Œ</span></span><br><span class="line">      <span class="comment">// è§¦å‘TaskAttemptEventType.TA_ASSIGNEDäº‹ä»¶ç±»å‹</span></span><br><span class="line">      containerAssigned(allocated, assigned);</span><br><span class="line">      it.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ†é…map</span></span><br><span class="line">  assignMapsWithLocality(allocatedContainers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†é…containeræ—¶ï¼Œå…ˆå¯¹allocatedContainersè¿›è¡Œéå†ï¼Œéå†ä¸­å¯¹<em>ä¸éœ€è¦æœ¬åœ°æ€§</em>çš„containerè¿›è¡Œåˆ†é…ï¼Œ(ä¸éœ€è¦æœ¬åœ°æ€§çš„containerä¸º<em>å¤±è´¥ä¹‹åé‡è·‘çš„mapå’Œreduce</em>)ï¼Œéå†ç»“æŸä¹‹åè°ƒç”¨<code>assignMapsWithLocality</code>å°†å‰©ä½™çš„containeråˆ†é…ç»™mapã€‚<br>è¿™é‡Œå¯ä»¥çœ‹å‡ºå¤±è´¥ä¹‹åé‡è·‘çš„mapå’Œreduceçš„è¿è¡Œä¼˜å…ˆçº§æ¯”mapçš„è¿è¡Œä¼˜å…ˆçº§é«˜ï¼Œé˜²æ­¢é›†ç¾¤ä¸­çš„jobéƒ½åœ¨ç­‰å¾…reduceèµ„æºï¼Œè€Œæ— æ³•ä½¿jobç»“æŸé‡Šæ”¾èµ„æºã€‚</p><p>çœ‹ä¸‹assignMapsWithLocalityæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">assignMapsWithLocality</span><span class="params">(List&lt;Container&gt; allocatedContainers)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// try to assign to all nodes first to match node local</span></span><br><span class="line">  Iterator&lt;Container&gt; it = allocatedContainers.iterator();</span><br><span class="line">  <span class="comment">// æ•°æ®æœ¬åœ°æ€§</span></span><br><span class="line">  <span class="keyword">while</span>(it.hasNext() &amp;&amp; maps.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    Container allocated = it.next();        </span><br><span class="line">    Priority priority = allocated.getPriority();</span><br><span class="line">    <span class="keyword">assert</span> PRIORITY_MAP.equals(priority);</span><br><span class="line">    <span class="comment">// &quot;if (maps.containsKey(tId))&quot; below should be almost always true.</span></span><br><span class="line">    <span class="comment">// hence this while loop would almost always have O(1) complexity</span></span><br><span class="line">    String host = allocated.getNodeId().getHost();</span><br><span class="line">    <span class="comment">// å–å‡ºæ”¹hostå¯¹åº”çš„attemptåˆ—è¡¨</span></span><br><span class="line">    LinkedList&lt;TaskAttemptId&gt; list = mapsHostMapping.get(host);</span><br><span class="line">    <span class="keyword">while</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      ...</span><br><span class="line">      TaskAttemptId tId = list.removeFirst();</span><br><span class="line">      <span class="comment">// å¦‚æœtIdåœ¨å¾…æ‰§è¡Œçš„mapé›†åˆä¸­ï¼Œåˆ™å»å¤„å¯¹åº”çš„requestè¿›è¡Œåˆ†é…èµ„æº</span></span><br><span class="line">      <span class="keyword">if</span> (maps.containsKey(tId)) &#123;</span><br><span class="line">        ContainerRequest assigned = maps.remove(tId);</span><br><span class="line">        <span class="comment">// æ— è®ºmapè¿˜æ˜¯reduceéƒ½æ˜¯è°ƒç”¨æ¬¡æ–¹æ³•</span></span><br><span class="line">        containerAssigned(allocated, assigned);</span><br><span class="line">        it.remove();</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// try to match all rack local</span></span><br><span class="line">  it = allocatedContainers.iterator();</span><br><span class="line">  <span class="keyword">while</span>(it.hasNext() &amp;&amp; maps.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// &quot;if (maps.containsKey(tId))&quot; below should be almost always true.</span></span><br><span class="line">    <span class="comment">// hence this while loop would almost always have O(1) complexity</span></span><br><span class="line">    String host = allocated.getNodeId().getHost();</span><br><span class="line">    String rack = RackResolver.resolve(host).getNetworkLocation();</span><br><span class="line">    LinkedList&lt;TaskAttemptId&gt; list = mapsRackMapping.get(rack);</span><br><span class="line">    <span class="keyword">while</span> (list != <span class="keyword">null</span> &amp;&amp; list.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      TaskAttemptId tId = list.removeFirst();</span><br><span class="line">      <span class="keyword">if</span> (maps.containsKey(tId)) &#123;</span><br><span class="line">        ContainerRequest assigned = maps.remove(tId);</span><br><span class="line">        containerAssigned(allocated, assigned);</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// assign remaining</span></span><br><span class="line">  it = allocatedContainers.iterator();</span><br><span class="line">  <span class="keyword">while</span>(it.hasNext() &amp;&amp; maps.size() &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    Container allocated = it.next();</span><br><span class="line">    Priority priority = allocated.getPriority();</span><br><span class="line">    <span class="keyword">assert</span> PRIORITY_MAP.equals(priority);</span><br><span class="line">    TaskAttemptId tId = maps.keySet().iterator().next();</span><br><span class="line">    ContainerRequest assigned = maps.remove(tId);</span><br><span class="line">    containerAssigned(allocated, assigned);</span><br><span class="line">    it.remove();</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>assignMapsWithLocalityå…ˆå¯¹allocatedContainersåˆ—è¡¨éå†ä¸€è¾¹ï¼Œå°†containerèµ„æºè¿›è¡Œhostæœ¬åœ°æ€§åˆ†é…ï¼Œhostæœ¬åœ°æ€§æ˜¯æŒ‡containeræ‰€åœ¨çš„èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰container requestï¼Œå¦‚æœæœ‰åˆ™å°†requestä»mapsä¸­å–å‡ºï¼Œè°ƒç”¨<code>containerAssigned</code>è¿›è¡Œèµ„æºåˆ†é…ã€‚<br>hostæœ¬åœ°æ€§åˆ†é…å®Œä¹‹åï¼Œå†æ¬¡éå†allocatedContainersåˆ—è¡¨ï¼Œå°†å‰©ä¸‹çš„containeré’ˆå¯¹rackæœ¬åœ°æ€§è¿›è¡Œåˆ†é…ï¼Œæ­¤æ¬¡éå†ç»“æŸä¹‹åï¼Œè¿˜éœ€è¿›è¡Œä¸€æ¬¡éå†ï¼Œå¯¹å‰©ä¸‹çš„containerè¿›è¡Œä¸è€ƒè™‘æœ¬åœ°æ€§çš„åˆ†é…ã€‚</p><p>containeråˆ†é…ç»™mapè¿˜æ˜¯reduceéƒ½æ˜¯è°ƒç”¨<code>containerAssigned</code>ï¼Œçœ‹ä¸‹å…·ä½“ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">containerAssigned</span><span class="params">(Container allocated, </span></span></span><br><span class="line"><span class="params"><span class="function">                                ContainerRequest assigned)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Update resource requests</span></span><br><span class="line">  decContainerReq(assigned);</span><br><span class="line">  <span class="comment">// è§¦å‘TaskAttemptEventType.TA_ASSIGNEDäº‹ä»¶ç±»å‹</span></span><br><span class="line">  <span class="comment">// send the container-assigned event to task attempt</span></span><br><span class="line">  eventHandler.handle(<span class="keyword">new</span> TaskAttemptContainerAssignedEvent(</span><br><span class="line">      assigned.attemptID, allocated, applicationACLs));</span><br><span class="line">  <span class="comment">// å°†containeræ”¾å…¥å·²åˆ†é…çš„é›†åˆä¸­</span></span><br><span class="line">  assignedRequests.add(allocated, assigned.attemptID);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬ç¯‡ä¸»è¦ä»‹ç»äº†RMContainerAllocatorä½œä¸ºä¸€ä¸ªserviceæ—¶çš„ç›¸å…³é€»è¾‘ï¼Œè¿™éƒ¨åˆ†é€»è¾‘å¤§éƒ¨åˆ†æ˜¯åœ¨<code>RMContainerRequestor</code>ä¸­å®ç°çš„ï¼Œè€ŒRMContainerRequestoråˆç»§æ‰¿è‡ª<code>RMCommunicator</code>ã€‚</p><p>RMContainerAllocatorä½œä¸ºserviceæ—¶çš„ä¸»è¦åŠŸèƒ½ä¸º<strong>æ³¨å†Œ</strong>å’Œ<strong>å¿ƒè·³</strong>ã€‚<br>æ³¨å†Œæ—¶ç”±AMå‘<code>ApplicationMasterService</code>å‘å‡ºè¯·æ±‚ï¼Œåœ¨æ³¨å†Œçš„åŒæ—¶ä¼šæ›´æ–°ä¸‹<code>AMLivelinessMonitor</code>ä¸­çš„å­˜æ´»æ—¶é—´ï¼Œå¹¶è§¦å‘RMAppAttemptEventType.REGISTEREDäº‹ä»¶ç±»å‹çš„äº‹ä»¶ï¼Œç”±å¼‚æ­¥è°ƒåº¦å™¨åˆ†å‘ç»™ç›¸åº”çš„Eventhandleå¤„ç†ã€‚<br>æ³¨å†Œæ¯”è¾ƒç®€å•ï¼Œå¿ƒè·³åˆ™æœ‰ä¸€ä¸ªä¸“é—¨çš„çº¿ç¨‹è¿›è¡Œå‘¨æœŸæ€§çš„æ‰§è¡Œã€‚<br>å¿ƒè·³ä¸æ­¢åªæ˜¯ç”¨æ¥å‘Šè¯‰rmæ­¤amæ˜¯å¦å­˜æ´»ï¼Œæ›´é‡è¦çš„æ˜¯åœ¨å¿ƒè·³ä¸­ä¼šå‘rmå‘é€ç”³è¯·containerçš„è¯·æ±‚ï¼Œå¹¶å°†æ¥æ”¶åˆ°çš„containeråˆ†é…ç»™taskã€‚<em>amå‘é€çš„ç”³è¯·containerè¯·æ±‚å¯ä»¥è®¤ä¸ºæ˜¯å¼‚æ­¥çš„ï¼Œå› ä¸ºä¸€æ¬¡å¿ƒè·³è¿‡ç¨‹ä¸­çš„å‘é€å½“å‰æ‰€éœ€çš„containerèµ„æºï¼Œç„¶åæ¥æ”¶åˆ°çš„containerå“åº”æ˜¯ä¹‹å‰å¿ƒè·³ä¸­å‘é€çš„containerè¯·æ±‚ï¼Œè€Œä¸æ˜¯æ­¤æ¬¡å¿ƒè·³ä¸­å‘é€çš„containerè¯·æ±‚å¯¹åº”çš„å“åº”ï¼Œæ­¤æ¬¡å¿ƒè·³ä¸­æ‰€éœ€çš„containeréœ€åœ¨ä¸‹æ¬¡å¿ƒè·³æˆ–è€…ä¸‹ä¸‹æ¬¡å¿ƒè·³ä¸­æ‰èƒ½å¾—åˆ°å“åº”</em>ã€‚</p><p>ç»“åˆå‰é¢å‡ ç¯‡å…³äºApplicationMasterçš„æ–‡ç« ï¼Œç›®å‰å·²ç»æŠŠApplicationMasterä¸RMä¹‹å‰çš„ç›¸å…³çš„æµç¨‹å·²æ¢³ç†å®Œæ¯•äº†(<em>ApplicationMasterä¸NMä¹‹å‰çš„æµç¨‹éšåæ¢³ç†</em>)ï¼Œå…¶ä¸­æœ‰å‡ ä¸ªå…³é”®ç±»ApplicationMasterã€AMLivelinessMonitorã€ApplicationMasterLauncherå’ŒApplicationMasterServiceï¼Œä¸‹é¢å°†ä¼šæœ‰ä¸€ç¯‡æ–‡ç« ç»¼åˆä»‹ç»ä¸‹è¿™4ä¸ªç±»ä¹‹é—´çš„å…³ç³»ã€‚</p><!--AMLivelinessMonitorä¸­çš„ç”Ÿå‘½æ—¶é’Ÿæ˜¯ä¸æ˜¯å°±æ˜¯å¿ƒè·³æ—¶é—´ï¼Œ lastHeartbeatTime æ˜¯ä»€ä¹ˆmapsHostMapping maps reduces ä¹‹é—´çš„å…³ç³»hostä¸Šæœ‰å¤šå°‘ä¸ªcontainerè¯·æ±‚ï¼Œç”±addMapæ›´æ–°mapså­˜æ”¾attemptIDä¸requestæ˜ å°„ï¼Œå¾…æ‰§è¡Œçš„mapé›†åˆ-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> MRAppMaster </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹MRåˆ›å»ºcontainerè¯·æ±‚</title>
      <link href="/YarnSrcMRCreateContainerRequest.html"/>
      <url>/YarnSrcMRCreateContainerRequest.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/YARNSrcMRAppMasterStart.html">ä¸Šä¸€ç¯‡</a>ä»‹ç»äº†MRAppMasterå¯åŠ¨æ—¶çš„ä¸€äº›æµç¨‹ã€‚å½“MRAppMasterå¯åŠ¨æˆåŠŸä¹‹åï¼Œjobçš„çŠ¶æ€å·²ç”±INITEDå˜ä¸ºSETUPï¼Œå¹¶ä¸”åœ¨<code>StartTransition.transition</code>ä¸­æ„å»ºäº†<code>CommitterEventType.JOB_SETUP</code>äº‹ä»¶ç±»å‹ï¼Œç”±<code>CommitterEventHandler.handle</code>è¿›è¡Œå¤„ç†ã€‚</p><blockquote><p>CommitterEventType.JOB_SETUPäº‹ä»¶ç±»å‹çš„å¤„ç†å™¨åœ¨MRAppMasterä¸­ä½œä¸ºä¸€ä¸ªæœåŠ¡æ·»åŠ åˆ°MRAppMasteræœåŠ¡ä¸­ã€‚</p></blockquote><span id="more"></span><p>æ¥çœ‹ä¸‹å…·ä½“çš„æµç¨‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StartTransition.transition æ„å»ºCommitterEventType.JOB_SETUPäº‹ä»¶ç±»å‹å¯¹è±¡</span></span><br><span class="line">job.eventHandler.handle(<span class="keyword">new</span> CommitterJobSetupEvent(job.jobId, job.jobContext));</span><br><span class="line"></span><br><span class="line"><span class="comment">// CommitterEventHandler.handle</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(CommitterEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// å°†äº‹ä»¶æ”¾å…¥é˜Ÿåˆ—ä¸­</span></span><br><span class="line">    eventQueue.put(event);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æåˆ°<code>CommitterEventHandler</code>æ˜¯ä½œä¸ºä¸€ä¸ªServiceæ·»åŠ åˆ°MRAppMasteræœåŠ¡ä¸­çš„ï¼Œæ˜¾ç„¶å®ƒç»§æ‰¿äº†<code>AbstractService</code>ï¼Œç„¶è€Œå®ƒåˆèƒ½å¤„ç†äº‹ä»¶ï¼Œåˆ™å®ƒå®ç°äº†<code>EventHandler</code>æ¥å£ã€‚åœ¨å…¶<code>handle</code>æ–¹æ³•ä¸­å°†eventæ”¾å…¥äº‹ä»¶é˜Ÿåˆ—<code>eventQueue</code>ä¸­ï¼ŒeventQueueæ˜¯<code>LinkedBlockingQueue</code>ç±»å‹çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><p>CommitterEventHandleré€šè¿‡handleå°†eventæ”¾å…¥eventQueueä¸­ï¼Œåœ¨<code>serviceStart</code>ä¸­ä¼šå¯åŠ¨ä¸€ä¸ªçº¿ç¨‹ä»eventQueueä¸­takeäº‹ä»¶ç„¶åäº¤ç»™ThreadPoolExecutorå»æ‰§è¡Œã€‚å…·ä½“çš„æ‰§è¡Œä»£ç åœ¨<code>EventProcessor.run</code>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;Processing the event &quot;</span> + event.toString());</span><br><span class="line">  <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">  <span class="keyword">case</span> JOB_SETUP:</span><br><span class="line">    handleJobSetup((CommitterJobSetupEvent) event);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> JOB_COMMIT:</span><br><span class="line">    handleJobCommit((CommitterJobCommitEvent) event);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> JOB_ABORT:</span><br><span class="line">    handleJobAbort((CommitterJobAbortEvent) event);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> TASK_ABORT:</span><br><span class="line">    handleTaskAbort((CommitterTaskAbortEvent) event);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(<span class="string">&quot;Unexpected committer event &quot;</span></span><br><span class="line">        + event.toString());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// æ­¤æ—¶æ”¾å…¥çš„äº‹ä»¶ç±»å‹æ˜¯CommitterEventType.JOB_SETUPï¼Œåˆ™åœ¨handleJobSetupä¸­å¤„ç†</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">handleJobSetup</span><span class="params">(CommitterJobSetupEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// Create the temporary directory that is the root of all of the task work directories.</span></span><br><span class="line">  <span class="comment">// committeræ˜¯åœ¨MRAppMaster.serviceInitä¸­createçš„OutputCommitter</span></span><br><span class="line">    committer.setupJob(event.getJobContext());</span><br><span class="line">    <span class="comment">// JobEventType.JOB_SETUP_COMPLETED</span></span><br><span class="line">    context.getEventHandler().handle(</span><br><span class="line">        <span class="keyword">new</span> JobSetupCompletedEvent(event.getJobID()));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Job setup failed&quot;</span>, e);</span><br><span class="line">    context.getEventHandler().handle(<span class="keyword">new</span> JobSetupFailedEvent(</span><br><span class="line">        event.getJobID(), StringUtils.stringifyException(e)));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CommitterEventHandlerå¤„ç†CommitterEventType.JOB_SETUPäº‹ä»¶ç±»å‹æ—¶ï¼Œä¼šç»™jobåˆ›å»º<em>ä¸´æ—¶ç›®å½•</em>å­˜æ”¾mræ‰€éœ€çš„æ–‡ä»¶ï¼Œåˆ›å»ºæˆæœä¹‹åè§¦å‘<code>JobEventType.JOB_SETUP_COMPLETED</code>äº‹ä»¶ç±»å‹ï¼Œå¤±è´¥åˆ™è§¦å‘<code>JobEventType.JOB_SETUP_FAILED</code>ã€‚</p><p><code>JobEventType.JOB_SETUP_COMPLETED</code>å’Œ<code>JobEventType.JOB_SETUP_FAILED</code>éƒ½æ˜¯JobImplçŠ¶æ€æœºä¸­çš„çŠ¶æ€ï¼Œæ­¤æ—¶jobçš„çŠ¶æ€æ˜¯SETUPï¼Œå½“OutputCommitteræŠŠjobæ‰€éœ€çš„ä¸´æ—¶ç›®å½•åˆ›å»ºæˆåŠŸä¹‹åï¼Œè§¦å‘<code>JobEventType.JOB_SETUP_COMPLETED</code>ï¼Œç”±<code>SetupCompletedTransition</code>è¿›è¡Œå¤„ç†ï¼Œçœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(JobImpl job, JobEvent event)</span> </span>&#123;</span><br><span class="line">  job.setupProgress = <span class="number">1.0f</span>;</span><br><span class="line">  <span class="comment">// SETUP åˆ° RUNNINGæ—¶ï¼Œå¼€å§‹è°ƒåº¦task</span></span><br><span class="line">  job.scheduleTasks(job.mapTasks, job.numReduceTasks == <span class="number">0</span>);</span><br><span class="line">  job.scheduleTasks(job.reduceTasks, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we have no tasks, just transition to job completed</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>SetupCompletedTransitionå¤„ç†ä¹‹åjobçš„çŠ¶æ€å˜ä¸º<em>RUNNING</em>ï¼Œå…¶å¤„ç†é€»è¾‘æ˜¯è°ƒåº¦taskï¼Œtaskå¯¹è±¡æ˜¯åœ¨<code>InitTransition.transition</code>ä¸­è°ƒç”¨<code>createMapTasks</code>å’Œ<code>createReduceTasks</code>ä¸­åˆ›å»ºçš„ã€‚<br><code>scheduleTasks</code>å¯¹æ¯ä¸ªtaskæ„é€ ä¸€ä¸ª<code>TaskEventType.T_SCHEDULE</code>ç±»å‹çš„TaskEventäº‹ä»¶ï¼Œå¹¶é€šè¿‡å¼‚æ­¥è°ƒåº¦å™¨åˆ†å‘å‡ºå»ï¼Œç”±æ¯ä¸ªå…·ä½“çš„taskè¿›è¡Œæ‰§è¡Œï¼Œmap taskä¹‹é—´æ²¡æœ‰æ‰§è¡Œé¡ºåºä¸Šçš„ä¾èµ–ï¼Œè¿™æ ·map taskå°±è¾¾åˆ°äº†å¹¶è¡Œçš„ç›®çš„ã€‚<br>çœ‹ä¸‹ç›¸å…³ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">scheduleTasks</span><span class="params">(Set&lt;TaskId&gt; taskIDs,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> recoverTaskOutput)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (TaskId taskID : taskIDs) &#123;</span><br><span class="line">    TaskInfo taskInfo = completedTasksFromPreviousRun.remove(taskID);</span><br><span class="line">    <span class="keyword">if</span> (taskInfo != <span class="keyword">null</span>) &#123;</span><br><span class="line">      eventHandler.handle(<span class="keyword">new</span> TaskRecoverEvent(taskID, taskInfo,</span><br><span class="line">          committer, recoverTaskOutput));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¼€å§‹è°ƒåº¦task</span></span><br><span class="line">      <span class="comment">// é€šè¿‡å¼‚æ­¥è°ƒåº¦å™¨å°†taskäº‹ä»¶åˆ†å‘å‡ºå»</span></span><br><span class="line">      eventHandler.handle(<span class="keyword">new</span> TaskEvent(taskID, TaskEventType.T_SCHEDULE));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¤„ç†<code>TaskEvent</code>äº‹ä»¶çš„handleæ˜¯åœ¨MRAppMasterä¸­æ³¨å†Œåˆ°å¼‚æ­¥è°ƒåº¦å™¨dispatcherä¸­çš„<code>TaskEventDispatcher</code>ï¼Œå…¶handleä¸­è°ƒç”¨äº†<code>((EventHandler&lt;TaskEvent&gt;)task).handle(event)</code>ï¼Œè¿›å…¥äº†taskçŠ¶æ€æœºçš„è½¬æ¢æµç¨‹ä¸­ã€‚<br>taskåœ¨createMapTasksä¸­åˆå§‹åŒ–çŠ¶æ€æ˜¯NEWï¼Œ<code>TaskEventType.T_SCHEDULE</code>äº‹ä»¶ç±»å‹è¢«è§¦å‘ä¹‹åï¼Œç”±<code>InitialScheduleTransition</code>ä½¿å…¶çŠ¶æ€è½¬ä¸º<code>SCHEDULED</code>ã€‚çœ‹ä¸‹InitialScheduleTransitionçš„ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(TaskImpl task, TaskEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è°ƒåº¦task attemptï¼Œattemptæ˜¯é’ˆå¯¹taskçš„</span></span><br><span class="line">  <span class="comment">// ç”³è¯·container</span></span><br><span class="line">  task.addAndScheduleAttempt(Avataar.VIRGIN);</span><br><span class="line">  task.scheduledTime = task.clock.getTime();</span><br><span class="line">  task.sendTaskStartedEvent();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>yarnä¸­å®è´¨æ€§æ‰§è¡Œæ“ä½œçš„éƒ½æ˜¯attemptï¼Œå¦‚jobæ˜¯jobAttemptï¼Œtaskæ˜¯taskAttemptï¼Œä½¿ç”¨attemptæ˜¯è€ƒè™‘åˆ°äº†å¤±è´¥é‡è¯•å’Œæ¨æµ‹æ‰§è¡Œ(Speculative Execution)ã€‚<br>æ‰€ä»¥taskè°ƒåº¦æ—¶å…ˆåˆ›å»ºä¸€ä¸ªattemptå¹¶è°ƒåº¦ï¼Œç„¶åå‘jobhistoryå‘é€<code>EventType.TASK_STARTED</code>äº‹ä»¶ç±»å‹ã€‚é‡ç‚¹çœ‹ä¸‹<code>addAndScheduleAttempt</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addAndScheduleAttempt</span><span class="params">(Avataar avataar)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å°†attemptæ·»åŠ åˆ°singletonMapçš„mapä¸­</span></span><br><span class="line">  TaskAttempt attempt = addAttempt(avataar);</span><br><span class="line">  inProgressAttempts.add(attempt.getID());</span><br><span class="line">  <span class="comment">//schedule the nextAttemptNumber</span></span><br><span class="line">  <span class="keyword">if</span> (failedAttempts.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    eventHandler.handle(<span class="keyword">new</span> TaskAttemptEvent(attempt.getID(),</span><br><span class="line">        TaskAttemptEventType.TA_RESCHEDULE));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ä¸ºtaskç”³è¯·containerï¼Œå¼€å¯task attemptçŠ¶æ€æœºå¾ªç¯</span></span><br><span class="line">    eventHandler.handle(<span class="keyword">new</span> TaskAttemptEvent(attempt.getID(),</span><br><span class="line">        TaskAttemptEventType.TA_SCHEDULE));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è§¦å‘<code>TaskAttemptEventType.TA_SCHEDULE</code>äº‹ä»¶ç±»å‹çš„<code>TaskAttemptEvent</code>ï¼Œå¹¶é€šè¿‡å¼‚æ­¥è°ƒåº¦å™¨å°†å…¶åˆ†å‘ç»™<code>TaskAttemptEventDispatcher</code>ï¼Œè°ƒç”¨<code>TaskAttemptImpl.handle</code>è¿›è¡Œå¤„ç†ã€‚<br>åœ¨<code>scheduleTasks</code>ä¸­å¦‚æ­¤å¾ªç¯ï¼Œå°†map taskè°ƒåº¦ç»“æŸä¹‹åï¼Œå¼€å§‹è°ƒåº¦reduce taskã€‚ç”±äºreduceä¾èµ–mapçš„æ‰§è¡Œè¿›åº¦ï¼Œè¿™é‡Œå…ˆä¸å¯¹reduce taskè¿›è¡Œå±•å¼€ï¼Œæˆ‘ä»¬ç»§ç»­è·Ÿè¸ªä¸‹map taskçš„attemptçŠ¶æ€è½¬æ¢ã€‚</p><p>è§¦å‘<code>TaskAttemptEventType.TA_SCHEDULE</code>äº‹ä»¶ç±»å‹æ—¶task attemptçš„çŠ¶æ€æ—¶NEWï¼Œå¯¹åº”çš„handleä¸º<code>RequestContainerTransition</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(TaskAttemptImpl taskAttempt, </span></span></span><br><span class="line"><span class="params"><span class="function">    TaskAttemptEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Tell any speculator that we&#x27;re requesting a container</span></span><br><span class="line">  taskAttempt.eventHandler.handle</span><br><span class="line">      (<span class="keyword">new</span> SpeculatorEvent(taskAttempt.getID().getTaskId(), +<span class="number">1</span>));</span><br><span class="line">  <span class="comment">//request for container</span></span><br><span class="line">  <span class="keyword">if</span> (rescheduled) &#123;</span><br><span class="line">    taskAttempt.eventHandler.handle(</span><br><span class="line">        ContainerRequestEvent.createContainerRequestEventForFailedContainer(</span><br><span class="line">            taskAttempt.attemptId, </span><br><span class="line">            taskAttempt.resourceCapability));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// è¯·æ±‚èµ„æº</span></span><br><span class="line">    <span class="comment">// è¯·æ±‚containerä¸­åŒ…æ‹¬dataLocalHostsï¼Œæ¥è‡ªsplitInfo.getLocations()</span></span><br><span class="line">    taskAttempt.eventHandler.handle(<span class="keyword">new</span> ContainerRequestEvent(</span><br><span class="line">        taskAttempt.attemptId, taskAttempt.resourceCapability,</span><br><span class="line">        taskAttempt.dataLocalHosts.toArray(</span><br><span class="line">            <span class="keyword">new</span> String[taskAttempt.dataLocalHosts.size()]),</span><br><span class="line">        taskAttempt.dataLocalRacks.toArray(</span><br><span class="line">            <span class="keyword">new</span> String[taskAttempt.dataLocalRacks.size()])));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>containerçš„è¯·æ±‚ä¸­åŒ…å«resourceå¤§å°ã€æ•°æ®æ‰€åœ¨hostsæ•°ç»„å’Œæœºæ¶æ•°ç»„ï¼Œä»¥ä¿è¯è®¡ç®—çš„æœ¬åœ°æ€§ã€‚</p><p>è¿™é‡Œçš„eventHandlerä¾ç„¶æ˜¯åœ¨MRAppMasterä¸­çš„å¼‚æ­¥è°ƒåº¦å™¨ï¼Œæ­¤æ—¶è§¦å‘çš„ContainerRequestEventäº‹ä»¶çš„ç±»å‹æ˜¯<code>ContainerAllocator.EventType.CONTAINER_REQ</code>ï¼Œç”±<code>containerAllocator</code>å¤„ç†ï¼Œåœ¨<a href="http://bigdatadecode.top/YARNSrcMRAppMasterStart.html">ä¸Šä¸€ç¯‡</a>ä¸­containerAllocatoræ ¹æ®mræ˜¯å¦ä¸ºuberçŠ¶æ€åˆ›å»ºä¸åŒçš„<code>containerAllocator</code>ï¼Œè¿™é‡Œè·Ÿä¸‹éuberçŠ¶æ€çš„<code>RMContainerAllocator</code>ï¼ŒæŸ¥çœ‹RMContainerAllocator.handleä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(ContainerAllocatorEvent event)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    eventQueue.put(event);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœä½ ä»å¼€å¤´çœ‹åˆ°è¿™é‡Œä½ ä¼šå‘ç°è¿™ä¹Ÿæ˜¯ä¸€ä¸ªäº‹ä»¶é˜Ÿåˆ—eventQueueï¼Œ(åœ¨Hadoopæºç ä¸­è¿™ç§æ–¹å¼è¢«å¹¿æ³›ä½¿ç”¨)ï¼ŒåŒæ—¶<code>RMContainerAllocator</code>æ—¢æ˜¯ä¸€ä¸ªserviceä¹Ÿæ˜¯ä¸€ä¸ªeventHandleã€‚<br>çœ‹ä¸‹serviceStartæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.eventHandlingThread = <span class="keyword">new</span> Thread() &#123;</span><br><span class="line">    <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">while</span> (!stopped.get() &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          event = RMContainerAllocator.<span class="keyword">this</span>.eventQueue.take();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          handleEvent(event);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">          ...</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">this</span>.eventHandlingThread.start();</span><br><span class="line">  <span class="comment">// è°ƒç”¨çˆ¶ç±»çš„serviceStartï¼Œå¼€å¯heartbeatçº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">super</span>.serviceStart();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>serviceStartä¸­åˆ›å»ºäº†ä¸€ä¸ªhandleå¤„ç†çº¿ç¨‹<code>eventHandlingThread</code>ï¼Œæ­¤çº¿ç¨‹è´Ÿè´£ä»eventQueueä¸­å–å‡ºeventä¼ ç»™<code>handleEvent</code>æ–¹æ³•å¤„ç†ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">handleEvent</span><span class="params">(ContainerAllocatorEvent event)</span> </span>&#123;</span><br><span class="line">  recalculateReduceSchedule = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (event.getType() == ContainerAllocator.EventType.CONTAINER_REQ) &#123;</span><br><span class="line">    ContainerRequestEvent reqEvent = (ContainerRequestEvent) event;</span><br><span class="line">    JobId jobId = getJob().getID();</span><br><span class="line">    Resource supportedMaxContainerCapability = getMaxContainerCapability();</span><br><span class="line">    <span class="keyword">if</span> (reqEvent.getAttemptID().getTaskId().getTaskType().equals(TaskType.MAP)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (mapResourceRequest.equals(Resources.none())) &#123;</span><br><span class="line">        mapResourceRequest = reqEvent.getCapability();</span><br><span class="line">        eventHandler.handle(<span class="keyword">new</span> JobHistoryEvent(jobId,</span><br><span class="line">          <span class="keyword">new</span> NormalizedResourceEvent(</span><br><span class="line">            org.apache.hadoop.mapreduce.TaskType.MAP, mapResourceRequest</span><br><span class="line">              .getMemory())));</span><br><span class="line">        LOG.info(<span class="string">&quot;mapResourceRequest:&quot;</span> + mapResourceRequest);</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// set the resources</span></span><br><span class="line">      <span class="comment">// å¯¹reqEventä¸­èµ„æºè¿›è¡Œæ ¡éªŒä¹‹åå¯¹å…¶è¿›è¡Œè®¾ç½®</span></span><br><span class="line">      reqEvent.getCapability().setMemory(mapResourceRequest.getMemory());</span><br><span class="line">      reqEvent.getCapability().setVirtualCores(</span><br><span class="line">        mapResourceRequest.getVirtualCores());</span><br><span class="line">      scheduledRequests.addMap(reqEvent);<span class="comment">//maps are immediately scheduled</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// reduce task</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      event.getType() == ContainerAllocator.EventType.CONTAINER_DEALLOCATE) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">      event.getType() == ContainerAllocator.EventType.CONTAINER_FAILED) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶eventçš„äº‹ä»¶ç±»å‹æ˜¯<code>ContainerAllocator.EventType.CONTAINER_REQ</code>ï¼Œåœ¨handleEventä¸­å°†map taské€šè¿‡<em>scheduledRequests</em>è¿›è¡Œè°ƒåº¦ã€‚çœ‹ä¸‹<code>scheduledRequests.addMap</code>æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addMap</span><span class="params">(ContainerRequestEvent event)</span> </span>&#123;</span><br><span class="line">  ContainerRequest request = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (event.getEarlierAttemptFailed()) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æ ¹æ®æœ¬åœ°æ€§å°†task attemptæ”¾å…¥å¯¹åº”çš„mappingä¸­</span></span><br><span class="line">    <span class="comment">// mapsHostmapping or mapsRackMapping</span></span><br><span class="line">    <span class="keyword">for</span> (String host : event.getHosts()) &#123;</span><br><span class="line">      LinkedList&lt;TaskAttemptId&gt; list = mapsHostMapping.get(host);</span><br><span class="line">      <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">        list = <span class="keyword">new</span> LinkedList&lt;TaskAttemptId&gt;();</span><br><span class="line">        mapsHostMapping.put(host, list);</span><br><span class="line">      &#125;</span><br><span class="line">      list.add(event.getAttemptID());</span><br><span class="line">      ...</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">for</span> (String rack: event.getRacks()) &#123;</span><br><span class="line">     LinkedList&lt;TaskAttemptId&gt; list = mapsRackMapping.get(rack);</span><br><span class="line">     <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">       list = <span class="keyword">new</span> LinkedList&lt;TaskAttemptId&gt;();</span><br><span class="line">       mapsRackMapping.put(rack, list);</span><br><span class="line">     &#125;</span><br><span class="line">     list.add(event.getAttemptID());</span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="comment">// æ„å»ºä¸€ä¸ªcontainer request</span></span><br><span class="line">   request = <span class="keyword">new</span> ContainerRequest(event, PRIORITY_MAP);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†container request å’Œå¯¹åº”çš„attemptIDæ”¾å…¥mapsä¸­</span></span><br><span class="line">  maps.put(event.getAttemptID(), request);</span><br><span class="line">  <span class="comment">// å°†requestæ”¾å…¥aské›†åˆä¸­</span></span><br><span class="line">  addContainerReq(request);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ScheduledRequestsæ˜¯RMContainerAllocatorçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯<code>addMap</code>ï¼Œä»å­—é¢ä¸Šçœ‹æ˜¯å°†mapçš„container requestæ”¾å…¥é›†åˆä¸­ï¼Œé‚£ä¹ˆä»€ä¹ˆæ—¶å€™ä»é›†åˆ<code>maps</code>ä¸­removeå‘¢ï¼Ÿè¿™é‡Œå…ˆæ‰“ä¸ªæ ‡è®°ï¼Œéšåå†ä»‹ç»ã€‚<br>æ¥ä¸‹æ¥è°ƒç”¨<code>addContainerReq</code>å°†requestæ”¾å…¥<code>ask</code>é›†åˆä¸­ï¼Œéšåçš„å¿ƒè·³ä¸­ä¼šå‘é€ç»™RMã€‚å…ˆçœ‹ä¸‹addContainerReqä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addContainerReq</span><span class="params">(ContainerRequest req)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Create resource requests</span></span><br><span class="line">  <span class="keyword">for</span> (String host : req.hosts) &#123;</span><br><span class="line">    <span class="comment">// Data-local</span></span><br><span class="line">    <span class="keyword">if</span> (!isNodeBlacklisted(host)) &#123;</span><br><span class="line">      addResourceRequest(req.priority, host, req.capability);</span><br><span class="line">    &#125;      </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Nothing Rack-local for now</span></span><br><span class="line">  <span class="keyword">for</span> (String rack : req.racks) &#123;</span><br><span class="line">    addResourceRequest(req.priority, rack, req.capability);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è¿™æ¡æ˜¯ä¸æ˜¯æ— è®ºå¦‚ä½•éƒ½ä¼šæ‰§è¡Œï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  <span class="comment">// Off-switch</span></span><br><span class="line">  addResourceRequest(req.priority, ResourceRequest.ANY, req.capability);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œæœ‰ç‚¹ç–‘æƒ‘</strong>ï¼Œæ— è®ºè¿™ä¸ªè¯·æ±‚æ˜¯å¯¹æ•°æ®çš„è¦æ±‚æ˜¯æœ¬åœ°æ€§è¿˜æ˜¯æœ¬rackæ›´æˆ–è€…æ˜¯ANYï¼Œéƒ½ä¼šæ‰§è¡Œ<code>addResourceRequest(req.priority, ResourceRequest.ANY, req.capability);</code>è¿™æ®µä»£ç ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ<br>addResourceRequestä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addResourceRequest</span><span class="params">(Priority priority, String resourceName,</span></span></span><br><span class="line"><span class="params"><span class="function">    Resource capability)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡ä¼˜å…ˆçº§priorityå¾—åˆ°ä¸€ä¸ªmapï¼Œmapçš„key/valueæ˜¯resourceName/map</span></span><br><span class="line">  <span class="comment">// ä¹Ÿå°±æ˜¯è¯¥hostä¸Šå¯¹åº”çš„request map</span></span><br><span class="line">  Map&lt;String, Map&lt;Resource, ResourceRequest&gt;&gt; remoteRequests =</span><br><span class="line">    <span class="keyword">this</span>.remoteRequestsTable.get(priority);</span><br><span class="line">  <span class="keyword">if</span> (remoteRequests == <span class="keyword">null</span>) &#123;</span><br><span class="line">    remoteRequests = <span class="keyword">new</span> HashMap&lt;String, Map&lt;Resource, ResourceRequest&gt;&gt;();</span><br><span class="line">    <span class="keyword">this</span>.remoteRequestsTable.put(priority, remoteRequests);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç„¶åå†é€šè¿‡resourceNameå¾—åˆ°è¯¥host/rackä¸Šçš„request map</span></span><br><span class="line">  Map&lt;Resource, ResourceRequest&gt; reqMap = remoteRequests.get(resourceName);</span><br><span class="line">  <span class="keyword">if</span> (reqMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">    reqMap = <span class="keyword">new</span> HashMap&lt;Resource, ResourceRequest&gt;();</span><br><span class="line">    remoteRequests.put(resourceName, reqMap);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æœ€åé€šè¿‡èµ„æºçš„å¤§å°å¾—åˆ°ä¸€ä¸ªè¯·æ±‚</span></span><br><span class="line">  ResourceRequest remoteRequest = reqMap.get(capability);</span><br><span class="line">  <span class="comment">// å¦‚æœè¯¥èµ„æºå¤§å°æ²¡æœ‰å¯¹åº”çš„requestï¼Œåˆ™æ–°å»ºä¸€ä¸ªï¼Œæ³¨æ„æ­¤æ—¶containerçš„numä¸º0</span></span><br><span class="line">  <span class="keyword">if</span> (remoteRequest == <span class="keyword">null</span>) &#123;</span><br><span class="line">    remoteRequest = recordFactory.newRecordInstance(ResourceRequest.class);</span><br><span class="line">    remoteRequest.setPriority(priority);</span><br><span class="line">    remoteRequest.setResourceName(resourceName);</span><br><span class="line">    remoteRequest.setCapability(capability);</span><br><span class="line">    remoteRequest.setNumContainers(<span class="number">0</span>);</span><br><span class="line">    reqMap.put(capability, remoteRequest);</span><br><span class="line">  &#125;</span><br><span class="line">  remoteRequest.setNumContainers(remoteRequest.getNumContainers() + <span class="number">1</span>);</span><br><span class="line">  <span class="comment">// Note this down for next interaction with ResourceManager</span></span><br><span class="line">  addResourceRequestToAsk(remoteRequest);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>addResourceRequestçš„ä½œç”¨æ˜¯å°†container requeståœ¨remoteRequestsTableä¸­è®°å½•ï¼Œåªæ˜¯è®°å½•å¯¹åº”requestçš„ä¸ªæ•°ï¼Œç„¶åå°†æ›´æ–°åçš„ResourceRequestæ”¾å…¥ask setä¸­ã€‚<br>è°ƒç”¨addResourceRequestToAskå°†ResourceRequestæ”¾å…¥ask setä¸­ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addResourceRequestToAsk</span><span class="params">(ResourceRequest remoteRequest)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// because objects inside the resource map can be deleted ask can end up </span></span><br><span class="line">  <span class="comment">// containing an object that matches new resource object but with different</span></span><br><span class="line">  <span class="comment">// numContainers. So exisintg values must be replaced explicitly</span></span><br><span class="line">  <span class="keyword">if</span>(ask.contains(remoteRequest)) &#123;</span><br><span class="line">    ask.remove(remoteRequest);</span><br><span class="line">  &#125;</span><br><span class="line">  ask.add(remoteRequest);    </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°è¿™é‡Œçœ‹ä¼¼ä»£ç åˆ°æ­¤æ–­äº†ï¼Œå®åˆ™ä¸ç„¶ï¼Œä¸Šæ–‡ä¸­æåˆ°<code>RMContainerAllocator</code>æ—¢æ˜¯ä¸€ä¸ªserviceä¹Ÿæ˜¯ä¸€ä¸ªeventHandleï¼Œé‚£ä¹ˆå®ƒä½œä¸ºæœåŠ¡æ—¶ï¼Œä¼šæœ‰å“ªäº›åŠŸèƒ½å‘¢ï¼Ÿ</p><h2 id="æ‰¿ä¸Šå¯ä¸‹"><a href="#æ‰¿ä¸Šå¯ä¸‹" class="headerlink" title="æ‰¿ä¸Šå¯ä¸‹"></a>æ‰¿ä¸Šå¯ä¸‹</h2><p>æœ¬ç¯‡ä»jobçš„çŠ¶æ€ç”±INITEDå˜ä¸ºSETUPä¹‹åï¼Œåˆç»è¿‡ä¸€äº›äº‹ä»¶è§¦å‘ä½¿jobå˜ä¸ºRUNNINGçŠ¶æ€ï¼Œå¼€å§‹åˆ›å»ºtaskï¼Œå¹¶åˆ›å»ºcontainer requestï¼Œå°†requestæ”¾å…¥askä¸­ã€‚<br>æ¥ä¸‹æ¥å°±æ˜¯AMä¸­çš„RMContainerAllocatoræœåŠ¡ä¸RMä¿æŒå¿ƒè·³ï¼Œåœ¨ä¸‹æ¬¡å¿ƒè·³æ—¶å‘RMç”³è¯·èµ„æºï¼Œè¿™éƒ¨åˆ†åœ¨ä¸‹ä¸€ç¯‡ä»‹ç»ã€‚</p><!--è¿™é‡Œå°†remoteRequestæ”¾å…¥askä¸­ï¼ŒremoteRequestä¸­è®°å½•äº†priority resourceName capability container'numï¼Œåˆ™åœ¨hostä¸Šä¸€æ¬¡åˆ†é…å¤šä¸ªcontainerï¼Ÿè¿™ä¸ªcontaineræ²¡æœ‰ä¸attemptIDå…³è”ï¼Ÿï¼Ÿ-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> MRAppMaster </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹MRAppMasterå¯åŠ¨</title>
      <link href="/YARNSrcMRAppMasterStart.html"/>
      <url>/YARNSrcMRAppMasterStart.html</url>
      
        <content type="html"><![CDATA[<p>ç”±<a href="http://bigdatadecode.top/YARNSrcApplicationMasterStart.html">YARNæºç åˆ†æä¹‹ApplicationMasterå¯åŠ¨æµç¨‹</a>ä¸­å¾—çŸ¥MRçš„AppMasteræ˜¯ç”±MRAppMasterå¯åŠ¨çš„ï¼Œåœ¨è„šæœ¬ä¸­è°ƒç”¨äº†AppMasterçš„mainæ–¹æ³•ã€‚</p><p>æœ¬æ–‡å°±é¡ºç€ä»£ç æ¥å¯¹MRAppMasterè¿›è¡Œè§£æä¸‹ã€‚</p><span id="more"></span><p>å…ˆæ¥çœ‹ä¸‹è¯¥ç±»çš„mainæ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// Environmentä¸­çš„ç¯å¢ƒå˜é‡æ˜¯åœ¨launch_container.shä¸­exportçš„</span></span><br><span class="line">    String containerIdStr =</span><br><span class="line">        System.getenv(Environment.CONTAINER_ID.name());</span><br><span class="line">    String nodeHostString = System.getenv(Environment.NM_HOST.name());</span><br><span class="line">    String nodePortString = System.getenv(Environment.NM_PORT.name());</span><br><span class="line">    String nodeHttpPortString =</span><br><span class="line">        System.getenv(Environment.NM_HTTP_PORT.name());</span><br><span class="line">    String appSubmitTimeStr =</span><br><span class="line">        System.getenv(ApplicationConstants.APP_SUBMIT_TIME_ENV);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// ä¸€ä¸ªMRå¯¹åº”ä¸€ä¸ªMRAppMaterå¯¹è±¡</span></span><br><span class="line">    MRAppMaster appMaster =</span><br><span class="line">        <span class="keyword">new</span> MRAppMaster(applicationAttemptId, containerId, nodeHostString,</span><br><span class="line">            Integer.parseInt(nodePortString),</span><br><span class="line">            Integer.parseInt(nodeHttpPortString), appSubmitTime);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å¹¶å¯åŠ¨appMaster</span></span><br><span class="line">    initAndStartAppMaster(appMaster, conf, jobUserName);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    LOG.fatal(<span class="string">&quot;Error starting MRAppMaster&quot;</span>, t);</span><br><span class="line">    ExitUtil.terminate(<span class="number">1</span>, t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MRAppMasteré¦–å…ˆä»ç¯å¢ƒå˜é‡ä¸­è·å–ç›¸å…³çš„ä¿¡æ¯ï¼Œç„¶åè°ƒç”¨<code>initAndStartAppMaster</code>å¼€å¯AppMasteræœåŠ¡ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">initAndStartAppMaster</span><span class="params">(<span class="keyword">final</span> MRAppMaster appMaster,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> JobConf conf, String jobUserName)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">    InterruptedException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  appMasterUgi.doAs(<span class="keyword">new</span> PrivilegedExceptionAction&lt;Object&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Object <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">      appMaster.init(conf);</span><br><span class="line">      appMaster.start();</span><br><span class="line">      <span class="keyword">if</span>(appMaster.errorHappenedShutDown) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Was asked to shut down.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MRAppMasterç»§æ‰¿äº†CompositeServiceï¼Œåˆ™è°ƒç”¨initè¿›è¡ŒæœåŠ¡åˆå§‹åŒ–ï¼Œstartå¯åŠ¨æœåŠ¡ã€‚è€Œinitåˆè°ƒç”¨<code>MRAppMaster.serviceInit</code>å¯¹appMasterè¿›è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨<code>MRAppMaster.serviceStart</code>å¯åŠ¨AppMasteræœåŠ¡ã€‚</p><h2 id="MRAppMasteråˆå§‹åŒ–"><a href="#MRAppMasteråˆå§‹åŒ–" class="headerlink" title="MRAppMasteråˆå§‹åŒ–"></a>MRAppMasteråˆå§‹åŒ–</h2><p>å…ˆçœ‹ä¸‹AppMasterçš„åˆå§‹åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceInit</span><span class="params">(<span class="keyword">final</span> Configuration conf)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ...  </span><br><span class="line">  <span class="comment">// åˆ¤æ–­ä¸€äº›ç›®å½•æ˜¯å¦å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    String user = UserGroupInformation.getCurrentUser().getShortUserName();</span><br><span class="line">    <span class="comment">// ç›®å½•ä¸º /tmp/hadoop-yarn/staging/user/.staging</span></span><br><span class="line">    Path stagingDir = MRApps.getStagingAreaDir(conf, user);</span><br><span class="line">    FileSystem fs = getFileSystem(conf);</span><br><span class="line">    <span class="keyword">boolean</span> stagingExists = fs.exists(stagingDir);</span><br><span class="line">    <span class="comment">// ç›®å½•ä¸º /tmp/hadoop-yarn/staging/user/.staging/jobId/COMMIT_STARTED</span></span><br><span class="line">    Path startCommitFile = MRApps.getStartJobCommitFile(conf, user, jobId);</span><br><span class="line">    <span class="keyword">boolean</span> commitStarted = fs.exists(startCommitFile);</span><br><span class="line">    <span class="comment">// ç›®å½•ä¸º /tmp/hadoop-yarn/staging/user/.staging/jobId/COMMIT_SUCCESS</span></span><br><span class="line">    Path endCommitSuccessFile = MRApps.getEndJobCommitSuccessFile(conf, user, jobId);</span><br><span class="line">    <span class="keyword">boolean</span> commitSuccess = fs.exists(endCommitSuccessFile);</span><br><span class="line">    <span class="comment">// ç›®å½•ä¸º /tmp/hadoop-yarn/staging/user/.staging/jobId/COMMIT_FAIL</span></span><br><span class="line">    Path endCommitFailureFile = MRApps.getEndJobCommitFailureFile(conf, user, jobId);</span><br><span class="line">    <span class="keyword">boolean</span> commitFailure = fs.exists(endCommitFailureFile);</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(<span class="string">&quot;Error while initializing&quot;</span>, e);</span><br><span class="line">  &#125;  </span><br><span class="line">  <span class="keyword">if</span> (errorHappenedShutDown) &#123;</span><br><span class="line">    <span class="comment">// å‘ç”Ÿerrorçš„å¤„ç†é€»è¾‘</span></span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºMRä¾èµ–çš„OutputCommitter</span></span><br><span class="line">    committer = createOutputCommitter(conf);</span><br><span class="line">    <span class="comment">// ä¸ºMRAppMasteræœåŠ¡åˆ›å»ºå¼‚æ­¥è°ƒåº¦å™¨æœåŠ¡</span></span><br><span class="line">    dispatcher = createDispatcher();</span><br><span class="line">    addIfService(dispatcher);</span><br><span class="line">    <span class="comment">//service to handle requests from JobClient</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºMRClientService</span></span><br><span class="line">    clientService = createClientService(context);</span><br><span class="line">    <span class="comment">// Init ClientService separately so that we stop it separately, since this</span></span><br><span class="line">    <span class="comment">// service needs to wait some time before it stops so clients can know the</span></span><br><span class="line">    <span class="comment">// final states</span></span><br><span class="line">    clientService.init(conf);</span><br><span class="line">    <span class="comment">// æ ¹æ®mrçš„è¿è¡Œæ–¹å¼åˆ›å»ºä¸åŒçš„containeråˆ†é…router</span></span><br><span class="line">    <span class="comment">// è°ƒåº¦å„ä¸ªçŠ¶æ€ æµç¨‹ ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ##########################ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">    <span class="comment">// è¯·æ±‚çš„æµç¨‹ï¼Œåˆ†é…çš„containeræ˜¯rmå·²ç»åˆ†é…åˆ°amä¸Šçš„èµ„æºï¼Ÿï¼Ÿï¼Ÿä¸»åŠ¨åˆ†é…çš„ï¼Ÿåœ¨å“ªç”³è¯·</span></span><br><span class="line">    containerAllocator = createContainerAllocator(clientService, context);</span><br><span class="line">    <span class="comment">//service to handle the output committer</span></span><br><span class="line">    committerEventHandler = createCommitterEventHandler(context, committer);</span><br><span class="line">    addIfService(committerEventHandler);</span><br><span class="line">    <span class="comment">//service to handle requests to TaskUmbilicalProtocol</span></span><br><span class="line">    <span class="comment">// ä¸»è¦è´Ÿè´£å¯åŠ¨task ä½¿ç”¨TaskUmbilicalProtocolåè®®</span></span><br><span class="line">    taskAttemptListener = createTaskAttemptListener(context);</span><br><span class="line">    addIfService(taskAttemptListener);</span><br><span class="line">    <span class="comment">//service to log job history events</span></span><br><span class="line">    EventHandler&lt;JobHistoryEvent&gt; historyService = </span><br><span class="line">      createJobHistoryHandler(context);</span><br><span class="line">    dispatcher.register(org.apache.hadoop.mapreduce.jobhistory.EventType.class,</span><br><span class="line">        historyService);</span><br><span class="line">    <span class="keyword">this</span>.jobEventDispatcher = <span class="keyword">new</span> JobEventDispatcher();</span><br><span class="line">    <span class="comment">//register the event dispatchers</span></span><br><span class="line">    dispatcher.register(JobEventType.class, jobEventDispatcher);</span><br><span class="line">    dispatcher.register(TaskEventType.class, <span class="keyword">new</span> TaskEventDispatcher());</span><br><span class="line">    dispatcher.register(TaskAttemptEventType.class, </span><br><span class="line">        <span class="keyword">new</span> TaskAttemptEventDispatcher());</span><br><span class="line">    dispatcher.register(CommitterEventType.class, committerEventHandler);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Now that there&#x27;s a FINISHING state for application on RM to give AMs</span></span><br><span class="line">    <span class="comment">// plenty of time to clean up after unregister it&#x27;s safe to clean staging</span></span><br><span class="line">    <span class="comment">// directory after unregistering with RM. So, we start the staging-dir</span></span><br><span class="line">    <span class="comment">// cleaner BEFORE the ContainerAllocator so that on shut-down,</span></span><br><span class="line">    <span class="comment">// ContainerAllocator unregisters first and then the staging-dir cleaner</span></span><br><span class="line">    <span class="comment">// deletes staging directory.</span></span><br><span class="line">    <span class="comment">// å¼€å¯æ¸…ç†æœåŠ¡</span></span><br><span class="line">    <span class="comment">// ä¸OutputCommitterçš„åŒºåˆ«</span></span><br><span class="line">    addService(createStagingDirCleaningService());</span><br><span class="line">    <span class="comment">// service to allocate containers from RM (if non-uber) or to fake it (uber)</span></span><br><span class="line">    addIfService(containerAllocator);</span><br><span class="line">    dispatcher.register(ContainerAllocator.EventType.class, containerAllocator);</span><br><span class="line">    <span class="comment">// corresponding service to launch allocated containers via NodeManager</span></span><br><span class="line">    containerLauncher = createContainerLauncher(context);</span><br><span class="line">    addIfService(containerLauncher);</span><br><span class="line">    dispatcher.register(ContainerLauncher.EventType.class, containerLauncher);</span><br><span class="line">    <span class="comment">// Add the JobHistoryEventHandler last so that it is properly stopped first.</span></span><br><span class="line">    <span class="comment">// This will guarantee that all history-events are flushed before AM goes</span></span><br><span class="line">    <span class="comment">// ahead with shutdown.</span></span><br><span class="line">    <span class="comment">// Note: Even though JobHistoryEventHandler is started last, if any</span></span><br><span class="line">    <span class="comment">// component creates a JobHistoryEvent in the meanwhile, it will be just be</span></span><br><span class="line">    <span class="comment">// queued inside the JobHistoryEventHandler</span></span><br><span class="line">    <span class="comment">// å¯è§æœåŠ¡çš„å¯åŠ¨é¡ºåºæ˜¯å…ˆè¿›åå‡º</span></span><br><span class="line">    addIfService(historyService);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">super</span>.serviceInit(conf);</span><br><span class="line">&#125; <span class="comment">// end of init()</span></span><br></pre></td></tr></table></figure><p>å¦‚æœä¸€åˆ‡æ­£å¸¸ä¼šè¿›å…¥æœ€åä¸€ä¸ª<code>if</code> <code>else</code>è¯­å¥å—çš„elseä¸­è¿›è¡ŒAMçš„åˆå§‹åŒ–ã€‚æ¥çœ‹ä¸‹åˆå§‹åŒ–ä¸­éƒ½åŒ…æ‹¬å“ªäº›æœåŠ¡ã€‚</p><blockquote><p>å…ˆåˆ›å»º<code>OutputCommitter</code>å¯¹è±¡ï¼Œè¿™æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå®ç°ç±»æœ‰FileOutputCommitterã€‚éšåç”¨ä¸æ„å»º<code>CommitterEventHandler</code>æœåŠ¡ï¼Œå¹¶å°†æ­¤æœåŠ¡åŠ å…¥AppMasteræœåŠ¡ä¸­ã€‚<br>OutputCommitterçš„ä½œç”¨æœ‰</p></blockquote><ol><li>jobåˆå§‹åŒ–æ—¶è¿›è¡Œä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚ä¸ºjobåˆ›å»ºä¸´æ—¶è¾“å‡ºç›®å½•</li><li>jobå®Œæˆæ—¶è¿›è¡Œä¸€äº›æ‰«å°¾å·¥ä½œï¼Œæ¯”å¦‚å½“jobå®Œæˆä¹‹ååˆ é™¤ä¸´æ—¶è¾“å‡ºç›®å½•</li><li>ä¸ºtaskå‡†å¤‡ä¸´æ—¶è¾“å‡ºç›®å½•</li><li>æ£€æŸ¥taskæ˜¯å¦éœ€è¦commit</li><li>commit taskè¾“å‡ºç›®å½•</li><li>æ”¾å¼ƒtask commit</li></ol><blockquote><p>åˆ›å»ºå¼‚æ­¥è°ƒåº¦å™¨dispatcherã€‚ä¸»è¦ç”¨äºäº‹ä»¶çš„è°ƒåº¦ï¼Œæ˜¯yarnæ¡†æ¶ä¸­ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µã€‚</p></blockquote><blockquote><p>åˆ›å»ºMRClientServiceå¯¹è±¡clientServiceï¼ŒMRClientServiceä¸»è¦ç”¨äºclientä¸amè¿›è¡Œé€šä¿¡ï¼Œéœ€è¦å¯¹å…¶è¿›è¡Œå•ç‹¬çš„åˆå§‹åŒ–å’Œåœæ­¢ã€‚</p></blockquote><blockquote><p>åˆ›å»ºTaskAttemptListenerImplæœåŠ¡ï¼Œä¸»è¦ç”¨ä¸å’Œtaskçš„é€šè¡Œã€‚</p></blockquote><blockquote><p>åˆ›å»ºStagingDirCleaningServiceæœåŠ¡ï¼Œç”¨äºåˆ é™¤ä¸´æ—¶ç›®å½•ã€‚æ­¤æœåŠ¡è¦åœ¨containerAllocatoræœåŠ¡ä¹‹å‰æ·»åŠ ï¼Œå› ä¸ºcontaineræ³¨é”€ä¹‹åæ‰èƒ½æ¸…æ¥šè¯¥containerçš„ä¸´æ—¶ç›®å½•ã€‚======é‚£å’ŒoutputCommitteræœ‰ä»€ä¹ˆåŒºåˆ«å‘¢ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</p></blockquote><blockquote><p>åˆ›å»ºContainerAllocatorRouteræœåŠ¡ï¼Œç”¨ä¸åˆ†é…containerã€‚æ ¹æ®MRæ˜¯å¦ä¸ºUberç±»å‹åˆ›å»ºä¸åŒçš„åˆ†é…ç­–ç•¥ï¼Œå¦‚æœæ˜¯Uberåˆ™åˆ›å»º<code>LocalContainerAllocator</code>ï¼Œå¦åˆ™åˆ›å»º<code>RMContainerAllocator</code></p></blockquote><blockquote><p>åˆ›å»ºJobHistoryEventHandleræœåŠ¡ï¼Œè¿™ä¸ªæœåŠ¡æ˜¯æœ€åæ·»åŠ çš„ï¼Œè¦ä¿è¯æ­¤æœåŠ¡å…ˆåœæ­¢ã€‚</p></blockquote><p>åˆå§‹åŒ–ä¸åªæ˜¯æ·»åŠ ä¸€äº›æœåŠ¡è¿˜ä¼šå‘å¼‚æ­¥è°ƒåº¦å™¨ä¸­æ³¨å†Œä¸€äº›äº‹ä»¶å¤„ç†å™¨ï¼ŒåŒ…æ‹¬jobhistory.EventTypeã€JobEventTypeã€TaskEventTypeã€TaskAttemptEventTypeã€CommitterEventTypeã€ContainerAllocator.EventTypeå’ŒContainerLauncher.EventTypeã€‚</p><h2 id="MRAppMasterå¯åŠ¨"><a href="#MRAppMasterå¯åŠ¨" class="headerlink" title="MRAppMasterå¯åŠ¨"></a>MRAppMasterå¯åŠ¨</h2><p>åˆå§‹åŒ–ä¹‹åï¼Œè°ƒç”¨<code>serviceStart</code>å¯åŠ¨æœåŠ¡ï¼Œçœ‹ä¸‹éƒ½å¯åŠ¨äº†ä»€ä¹ˆæœåŠ¡</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// /////////////////// Create the job itself.</span></span><br><span class="line">  <span class="comment">// å¼€å¯jobçš„çŠ¶æ€æœº JobImpl NEW</span></span><br><span class="line">  job = createJob(getConfig(), forcedState, shutDownMessage);</span><br><span class="line">  <span class="comment">// jobåˆ›å»ºæˆåŠŸä¹‹åï¼Œå‘jobHistoryå‘é€EventType.AM_STARTEDäº‹ä»¶ç±»å‹ï¼Œ</span></span><br><span class="line">  <span class="comment">// ä½†æ˜¯ä¸ºä»€ä¹ˆä¼šæœ‰amInfosï¼ŒamInfosç”¨æ¥å¹²å•¥ï¼Ÿ</span></span><br><span class="line">  <span class="keyword">for</span> (AMInfo info : amInfos) &#123;</span><br><span class="line">    dispatcher.getEventHandler().handle(</span><br><span class="line">        <span class="keyword">new</span> JobHistoryEvent(job.getID(), <span class="keyword">new</span> AMStartedEvent(info</span><br><span class="line">            .getAppAttemptId(), info.getStartTime(), info.getContainerId(),</span><br><span class="line">            info.getNodeManagerHost(), info.getNodeManagerPort(), info</span><br><span class="line">                .getNodeManagerHttpPort())));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Send out an MR AM inited event for this AM.</span></span><br><span class="line">  dispatcher.getEventHandler().handle(</span><br><span class="line">      <span class="keyword">new</span> JobHistoryEvent(job.getID(), <span class="keyword">new</span> AMStartedEvent(amInfo</span><br><span class="line">          .getAppAttemptId(), amInfo.getStartTime(), amInfo.getContainerId(),</span><br><span class="line">          amInfo.getNodeManagerHost(), amInfo.getNodeManagerPort(), amInfo</span><br><span class="line">              .getNodeManagerHttpPort(), <span class="keyword">this</span>.forcedState == <span class="keyword">null</span> ? <span class="keyword">null</span></span><br><span class="line">                  : <span class="keyword">this</span>.forcedState.toString())));</span><br><span class="line">  amInfos.add(amInfo);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// metrics system init is really init &amp; start.</span></span><br><span class="line">  <span class="comment">// It&#x27;s more test friendly to put it here.</span></span><br><span class="line">  DefaultMetricsSystem.initialize(<span class="string">&quot;MRAppMaster&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> initFailed = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (!errorHappenedShutDown) &#123;</span><br><span class="line">    <span class="comment">// create a job event for job intialization</span></span><br><span class="line">    <span class="comment">// job init  jobä»NEWå˜ä¸ºINITED</span></span><br><span class="line">    JobEvent initJobEvent = <span class="keyword">new</span> JobEvent(job.getID(), JobEventType.JOB_INIT);</span><br><span class="line">    <span class="comment">// Send init to the job (this does NOT trigger job execution)</span></span><br><span class="line">    <span class="comment">// This is a synchronous call, not an event through dispatcher. We want</span></span><br><span class="line">    <span class="comment">// job-init to be done completely here.</span></span><br><span class="line">    <span class="comment">// æ³¨æ„æ³¨é‡Šçš„å†…å®¹ï¼Œä¸dispatcherçš„åŒºåˆ«</span></span><br><span class="line">    jobEventDispatcher.handle(initJobEvent);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If job is still not initialized, an error happened during</span></span><br><span class="line">    <span class="comment">// initialization. Must complete starting all of the services so failure</span></span><br><span class="line">    <span class="comment">// events can be processed.</span></span><br><span class="line">    initFailed = (((JobImpl)job).getInternalState() != JobStateInternal.INITED);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Start ClientService here, since it&#x27;s not initialized if</span></span><br><span class="line">    <span class="comment">// errorHappenedShutDown is true</span></span><br><span class="line">    clientService.start();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//start all the components</span></span><br><span class="line">  <span class="keyword">super</span>.serviceStart();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// finally set the job classloader</span></span><br><span class="line">  MRApps.setClassLoader(jobClassLoader, getConfig());</span><br><span class="line">  <span class="comment">// å¦‚æœjob INITEDå¤±è´¥ï¼Œåˆ™jobçš„çŠ¶æ€ä¸ºJOB_INIT_FAILED</span></span><br><span class="line">  <span class="keyword">if</span> (initFailed) &#123;</span><br><span class="line">    JobEvent initFailedEvent = <span class="keyword">new</span> JobEvent(job.getID(), JobEventType.JOB_INIT_FAILED);</span><br><span class="line">    jobEventDispatcher.handle(initFailedEvent);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// All components have started, start the job.</span></span><br><span class="line">    startJobs();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨å¯åŠ¨MRAppMasteræ‰€æœ‰æœåŠ¡ä¹‹å‰</p><ol><li>å…ˆè°ƒç”¨<code>createJob</code>åˆ›å»ºjobï¼Œjobæ˜¯JobImplå¯¹è±¡ã€‚jobçš„åˆ›å»ºå¼€å¯äº†jobçš„çŠ¶æ€æœºæ—…ç¨‹ï¼Œåˆå§‹çš„çŠ¶æ€æ˜¯<em>NEW</em>ã€‚åœ¨createJobä¸­è¿˜ä¼šå‘å¼‚æ­¥è°ƒåº¦å™¨æ³¨å†ŒJobFinishEventäº‹ä»¶ç±»å‹ã€‚</li><li>è§¦å‘jobçš„JOB_INITå¹¶äº¤ç»™äº‹ä»¶å¤„ç†å™¨JobEventDispatcherè¿›è¡Œå¤„ç†ï¼Œ<strong>æ­¤æ—¶æ˜¯åŒæ­¥çš„ï¼Œç­‰å¾…job initçš„ç»“æœ</strong>ã€‚</li><li>åœ¨å¯åŠ¨MRAppMasterä¸­æœåŠ¡ä¹‹å‰è¦å…ˆå¯åŠ¨clientServiceï¼Œç„¶åå¯åŠ¨æ‰€æœ‰çš„æœåŠ¡</li><li>å¦‚æœjobä»NEWè½¬åŒ–ä¸ºINITEDæ—¶å‘ç”Ÿäº†æ•…éšœï¼Œåˆ™ç½®<code>initFailed</code>ä¸ºtrueï¼Œå‘JobEventDispatcherå‘é€JobEventType.JOB_INIT_FAILEDäº‹ä»¶ç±»å‹</li><li>ä¸€åˆ‡æ­£å¸¸ä¹‹åè°ƒç”¨<code>startJobs()</code></li></ol><p>é’ˆå¯¹ä¸Šè¿°æµç¨‹æˆ‘ä»¬çœ‹ä¸‹å…·ä½“ä»£ç ï¼Œ</p><p>serviceStartæ—¶å…ˆè°ƒç”¨createJobåˆ›å»ºä¸€ä¸ªjobï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Job <span class="title">createJob</span><span class="params">(Configuration conf, JobStateInternal forcedState, </span></span></span><br><span class="line"><span class="params"><span class="function">    String diagnostic)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// new å‡ºjobå¯¹è±¡ï¼Œå¼€å¯jobçŠ¶æ€æœº(åˆå§‹åŒ–jobçš„çŠ¶æ€æ—¶NEW)</span></span><br><span class="line">  <span class="comment">// create single job</span></span><br><span class="line">  Job newJob =</span><br><span class="line">      <span class="keyword">new</span> JobImpl(jobId, appAttemptID, conf, dispatcher.getEventHandler(),</span><br><span class="line">          taskAttemptListener, jobTokenSecretManager, jobCredentials, clock,</span><br><span class="line">          completedTasksFromPreviousRun, metrics,</span><br><span class="line">          committer, newApiCommitter,</span><br><span class="line">          currentUser.getUserName(), appSubmitTime, amInfos, context, </span><br><span class="line">          forcedState, diagnostic);</span><br><span class="line">  ((RunningAppContext) context).jobs.put(newJob.getID(), newJob);</span><br><span class="line">  <span class="comment">// å¼€å§‹jobçš„çŠ¶æ€ä¹‹åï¼Œå‘å¼‚æ­¥è°ƒåº¦å™¨æ³¨å†ŒJobFinishEventäº‹ä»¶ç±»å‹çš„handler</span></span><br><span class="line">  dispatcher.register(JobFinishEvent.Type.class,</span><br><span class="line">      createJobFinishEventHandler());     </span><br><span class="line">  <span class="keyword">return</span> newJob;</span><br><span class="line">&#125; <span class="comment">// end createJob()</span></span><br></pre></td></tr></table></figure><p>createJobçš„æ—¶å€™ç”¨åˆ°ä¸€ä¸ªå±æ€§<code>amInfos</code>ï¼ŒamInfosæ˜¯ä¸€ä¸ªlistï¼Œåœ¨serviceStartæ—¶å®ä¾‹åŒ–ã€‚</p><blockquote><p>åœ¨createJobä¹‹åï¼Œä¼šå°†amInfosä¸­çš„amInfoæ„å»ºä¸€ä¸ªEventType.AM_STARTEDäº‹ä»¶ç±»å‹çš„JobHistoryEventäº‹ä»¶ï¼Œè¿™é‡Œæœ‰äº›ç–‘é—®ï¼Œä¸€ä¸ªmrä¼šæœ‰å¤šä¸ªamInfoï¼Ÿè€Œä¸”ä¸æ˜¯å› ä¸ºé‡è¯•ï¼Ÿï¼Ÿï¼Ÿ</p></blockquote><p>å¦‚æœæœŸé—´æ²¡æœ‰å‘ç”Ÿerrorï¼Œåˆ™è§¦å‘JobEventType.JOB_INITäº‹ä»¶ç±»å‹ï¼Œç”±<code>jobEventDispatcher.handle(initJobEvent)</code>å¤„ç†ï¼Œæœ€ç»ˆè°ƒç”¨çš„æ˜¯JobImpl.handleäº¤ç”±çŠ¶æ€æœºè¿›è¡Œå¤„ç†ï¼ŒjobåŸå…ˆçŠ¶æ€æ˜¯NEWï¼Œåˆ™JobEventType.JOB_INITçš„å¤„ç†ç±»æ˜¯<code>InitTransition</code>ï¼Œé€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> JobStateInternal <span class="title">transition</span><span class="params">(JobImpl job, JobEvent event)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// åˆ›å»ºjob context</span></span><br><span class="line">  <span class="keyword">if</span> (job.newApiCommitter) &#123;</span><br><span class="line">    job.jobContext = <span class="keyword">new</span> JobContextImpl(job.conf,</span><br><span class="line">        job.oldJobId);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    job.jobContext = <span class="keyword">new</span> org.apache.hadoop.mapred.JobContextImpl(</span><br><span class="line">        job.conf, job.oldJobId);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    setup(job);</span><br><span class="line">    job.fs = job.getFileSystem(job.conf);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//log to job history</span></span><br><span class="line">    <span class="comment">// EventType.JOB_SUBMITTED</span></span><br><span class="line">    JobSubmittedEvent jse = <span class="keyword">new</span> JobSubmittedEvent(job.oldJobId,</span><br><span class="line">          job.conf.get(MRJobConfig.JOB_NAME, <span class="string">&quot;test&quot;</span>), </span><br><span class="line">        job.conf.get(MRJobConfig.USER_NAME, <span class="string">&quot;mapred&quot;</span>),</span><br><span class="line">        job.appSubmitTime,</span><br><span class="line">        job.remoteJobConfFile.toString(),</span><br><span class="line">        job.jobACLs, job.queueName,</span><br><span class="line">        job.conf.get(MRJobConfig.WORKFLOW_ID, <span class="string">&quot;&quot;</span>),</span><br><span class="line">        job.conf.get(MRJobConfig.WORKFLOW_NAME, <span class="string">&quot;&quot;</span>),</span><br><span class="line">        job.conf.get(MRJobConfig.WORKFLOW_NODE_NAME, <span class="string">&quot;&quot;</span>),</span><br><span class="line">        getWorkflowAdjacencies(job.conf),</span><br><span class="line">        job.conf.get(MRJobConfig.WORKFLOW_TAGS, <span class="string">&quot;&quot;</span>));</span><br><span class="line">    job.eventHandler.handle(<span class="keyword">new</span> JobHistoryEvent(job.jobId, jse));</span><br><span class="line">    <span class="comment">//TODO JH Verify jobACLs, UserName via UGI?</span></span><br><span class="line">    <span class="comment">// æ ¹æ®åœ¨JobSubmitter.submitJobInternalä¸­åˆ’åˆ†çš„æ–‡ä»¶æ¥åˆ‡åˆ†task</span></span><br><span class="line">    <span class="comment">// è¯»å–æ–‡ä»¶åˆ‡åˆ†å…ƒä¿¡æ¯</span></span><br><span class="line">    TaskSplitMetaInfo[] taskSplitMetaInfo = createSplits(job, job.jobId);</span><br><span class="line">    job.numMapTasks = taskSplitMetaInfo.length;</span><br><span class="line">    job.numReduceTasks = job.conf.getInt(MRJobConfig.NUM_REDUCES, <span class="number">0</span>);</span><br><span class="line">    <span class="comment">// mapWeight å’Œ reduceWeight ç”¨æ¥è®¡ç®—mrçš„è¿›åº¦</span></span><br><span class="line">    <span class="keyword">if</span> (job.numMapTasks == <span class="number">0</span> &amp;&amp; job.numReduceTasks == <span class="number">0</span>) &#123;</span><br><span class="line">      job.addDiagnostic(<span class="string">&quot;No of maps and reduces are 0 &quot;</span> + job.jobId);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (job.numMapTasks == <span class="number">0</span>) &#123;</span><br><span class="line">      job.reduceWeight = <span class="number">0.9f</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (job.numReduceTasks == <span class="number">0</span>) &#123;</span><br><span class="line">      job.mapWeight = <span class="number">0.9f</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      job.mapWeight = job.reduceWeight = <span class="number">0.45f</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">long</span> inputLength = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; job.numMapTasks; ++i) &#123;</span><br><span class="line">      inputLength += taskSplitMetaInfo[i].getInputDataLength();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­è¯¥jobæ˜¯å¦å¯ä»¥åœ¨uberæ¨¡å¼ä¸‹è¿è¡Œ</span></span><br><span class="line">    job.makeUberDecision(inputLength);</span><br><span class="line">    </span><br><span class="line">    job.taskAttemptCompletionEvents =</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;TaskAttemptCompletionEvent&gt;(</span><br><span class="line">            job.numMapTasks + job.numReduceTasks + <span class="number">10</span>);</span><br><span class="line">    job.mapAttemptCompletionEvents =</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;TaskCompletionEvent&gt;(job.numMapTasks + <span class="number">10</span>);</span><br><span class="line">    job.taskCompletionIdxToMapCompletionIdx = <span class="keyword">new</span> ArrayList&lt;Integer&gt;(</span><br><span class="line">        job.numMapTasks + job.numReduceTasks + <span class="number">10</span>);</span><br><span class="line">    <span class="comment">// è¿™é‡Œé”™è¯¯ç‡ï¼Œæ˜¯æŒ‡å¯ä»¥å®¹å¿ä¸€äº›mapå¤±è´¥ï¼Œè€Œmrå¿½ç•¥è¿™äº›å¤±è´¥çš„taskï¼Œç»§ç»­æ­£å¸¸æ‰§è¡Œï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">    job.allowedMapFailuresPercent =</span><br><span class="line">        job.conf.getInt(MRJobConfig.MAP_FAILURES_MAX_PERCENT, <span class="number">0</span>);</span><br><span class="line">    job.allowedReduceFailuresPercent =</span><br><span class="line">        job.conf.getInt(MRJobConfig.REDUCE_FAILURES_MAXPERCENT, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// create the Tasks but don&#x27;t start them yet</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºmap reduce taskå¯¹è±¡</span></span><br><span class="line">    createMapTasks(job, inputLength, taskSplitMetaInfo);</span><br><span class="line">    createReduceTasks(job);</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> JobStateInternal.INITED;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Leave job in the NEW state. The MR AM will detect that the state is</span></span><br><span class="line">    <span class="comment">// not INITED and send a JOB_INIT_FAILED event.</span></span><br><span class="line">    <span class="keyword">return</span> JobStateInternal.NEW;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>job initçš„æ—¶å€™ä¼šæ ¹æ®æ–‡ä»¶splitçš„å…ƒæ•°æ®ä¿¡æ¯åˆ›å»ºmapå’Œreduce taskï¼Œæ­¤æ—¶å¹¶æ²¡æœ‰å¯åŠ¨è¿™äº›task</em>ã€‚</p><p>initJobæ‰§è¡Œç»“æŸä¹‹åï¼Œè¿”å›ç»™serviceStartç›®å‰jobçš„çŠ¶æ€ï¼ŒæˆåŠŸè¿”å›INITEDï¼Œç„¶åç»§ç»­æ‰§è¡Œï¼Œå¯åŠ¨åœ¨serviceInitä¸­æ·»åŠ çš„serviceï¼Œç„¶åæ‰§è¡ŒstartJob</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">startJobs</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** create a job-start event to get this ball rolling */</span></span><br><span class="line">  JobEvent startJobEvent = <span class="keyword">new</span> JobStartEvent(job.getID(),</span><br><span class="line">      recoveredJobStartTime);</span><br><span class="line">  <span class="comment">/** send the job-start event. this triggers the job execution. */</span></span><br><span class="line">  <span class="comment">// è§¦å‘job execution</span></span><br><span class="line">  dispatcher.getEventHandler().handle(startJobEvent);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>startJobsä¸»è¦æ˜¯åˆ›å»ºä¸€ä¸ª<code>JobEventType.JOB_START</code>äº‹ä»¶ç±»å‹ï¼Œç”±JobImplçš„çŠ¶æ€æœºè¿›è¡Œå¤„ç†ã€‚<br>startJobsä¹‹å‰jobçš„çŠ¶æ€ä¸ºINITEDï¼Œåˆ™ç”±<code>StartTransition</code>è¿›è¡Œå¤„ç†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * This transition executes in the event-dispatcher thread, though it&#x27;s</span></span><br><span class="line"><span class="comment"> * triggered in MRAppMaster&#x27;s startJobs() method.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(JobImpl job, JobEvent event)</span> </span>&#123;</span><br><span class="line">  JobStartEvent jse = (JobStartEvent) event;</span><br><span class="line">  <span class="keyword">if</span> (jse.getRecoveredJobStartTime() != <span class="number">0</span>) &#123;</span><br><span class="line">    job.startTime = jse.getRecoveredJobStartTime();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    job.startTime = job.clock.getTime();</span><br><span class="line">  &#125;</span><br><span class="line">  JobInitedEvent jie =</span><br><span class="line">    <span class="keyword">new</span> JobInitedEvent(job.oldJobId,</span><br><span class="line">         job.startTime,</span><br><span class="line">         job.numMapTasks, job.numReduceTasks,</span><br><span class="line">         job.getState().toString(),</span><br><span class="line">         job.isUber());</span><br><span class="line">  job.eventHandler.handle(<span class="keyword">new</span> JobHistoryEvent(job.jobId, jie));</span><br><span class="line">  JobInfoChangeEvent jice = <span class="keyword">new</span> JobInfoChangeEvent(job.oldJobId,</span><br><span class="line">      job.appSubmitTime, job.startTime);</span><br><span class="line">  job.eventHandler.handle(<span class="keyword">new</span> JobHistoryEvent(job.jobId, jice));</span><br><span class="line">  job.metrics.runningJob(job);</span><br><span class="line">  <span class="comment">// CommitterEventHandler.handle CommitterEventType.JOB_SETUP</span></span><br><span class="line">  job.eventHandler.handle(<span class="keyword">new</span> CommitterJobSetupEvent(</span><br><span class="line">          job.jobId, job.jobContext));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>serviceStart</code>è·³ç”¨<code>startJobs</code>ä¹‹åï¼Œå°±å®Œæˆäº†jobçš„å¯åŠ¨ï¼ŒMRAppMasterä¹Ÿå¯åŠ¨å®Œæ¯•ï¼Œè§¦å‘job executionï¼Œä½¿jobä¹‹åä¼šåœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­è¿›è¡ŒçŠ¶æ€æœºçš„è½¬æ¢ï¼Œéšåå°±æ˜¯MRAppMasterä¸­çš„å„ä¸ªæœåŠ¡æ¥é…åˆjobæ¥è¿›è¡Œå·¥ä½œã€‚</p><p>åœ¨StartTransitionä¸­ï¼Œåˆ›å»º<code>CommitterEventType.JOB_SETUP</code>äº‹ä»¶ç±»å‹ï¼Œç”±<code>CommitterEventHandler.handle</code>å¤„ç†ï¼Œè¿›è¡Œjobçš„å‡†å¤‡å·¥ä½œã€‚</p><p>æœ€åè¿™é‡Œéœ€è¦æ³¨æ„ä¸‹<code>StartTransition</code>ä¸Šçš„æ³¨é‡Šï¼Œè¯´StartTransition.transitionæ˜¯åœ¨<strong>äº‹ä»¶å¼‚æ­¥è°ƒåº¦å™¨</strong>çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ç°åœ¨jobä»¥åçš„æµç¨‹å·²ç»å’ŒMRAppMasteråˆ†ç¦»äº†ã€‚<br>MRAppMasteråœ¨startJobsä¸­å¼‚æ­¥è°ƒç”¨<code>dispatcher.getEventHandler().handle(startJobEvent)</code>ï¼Œç„¶åè¿”å›åˆ°serviceStartï¼Œæ­¤æ—¶MRAppMasterå¯åŠ¨æˆåŠŸï¼Œä¹‹åå°±æ˜¯ä»¥æœåŠ¡çš„å½¢æ€å­˜æ´»ã€‚</p><p>ä¸‹ä¸€ç¯‡æ¥ç€ä»‹ç»jobåœ¨æ¥æ”¶åˆ°<code>JobEventType.JOB_START</code>äº‹ä»¶ç±»å‹ä¹‹åç”±INITEDçŠ¶æ€å˜ä¸ºSETUPä¹‹åçš„æµç¨‹ã€‚</p><blockquote><p>æœ¬ç¯‡åªä»‹ç»äº†MRAppMasterçš„å¯åŠ¨è¿‡ç¨‹ï¼Œå¹¶æ²¡æœ‰æŠŠMRAppMasteråœ¨MRæ‰§è¡Œè¿‡ç¨‹çš„ä½œç”¨ä»‹ç»å®Œæ•´ï¼Œéšåå‡ ç¯‡æˆ‘ä¼šé¡ºç€MRçš„æ‰§è¡Œæµç¨‹æ¥ä»‹ç»MRAppMasterçš„å…·ä½“ä½œç”¨ã€‚</p></blockquote><!--åˆ é™¤ä¸´æ—¶æ–‡ä»¶åˆ°åº•åœ¨å“ªï¼ŸLOG.info("Deleting staging directory " + FileSystem.getDefaultUri(getConfig()) +            " " + jobTempDir);-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> MRAppMaster </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSä¹‹Cannot obtain block length for LocatedBlockå¼‚å¸¸</title>
      <link href="/HDFSCannotObtainBlockLengthForLocatedBlock.html"/>
      <url>/HDFSCannotObtainBlockLengthForLocatedBlock.html</url>
      
        <content type="html"><![CDATA[<p>æ˜¨å¤©å…¬å¸é›†ç¾¤å‡çº§ï¼Œé‡‡é›†å¹³å°çš„flume agentæ²¡æœ‰åœï¼Œå¯¼è‡´ä¸€äº›æ–‡ä»¶å¼‚å¸¸ï¼Œæ— æ³•è¯»ï¼Œä¹Ÿæ— æ³•ä½¿ç”¨cpæˆ–è€…getå‘½ä»¤ï¼ŒæŠ¥<code>Cannot obtain block length for LocatedBlock</code>ã€‚</p><span id="more"></span><p>é¦–å…ˆä½¿ç”¨fsckæ¥æ£€æŸ¥ä¸‹è¯¥æ–‡ä»¶ï¼Œå‘½ä»¤<code>hdfs fsck file_path -files -blocks -locations</code>ï¼Œæç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Status: HEALTHY</span><br><span class="line"> Total size: 0 B (Total open files size: 18935B)</span><br></pre></td></tr></table></figure><p>ç°å®æ–‡ä»¶ä¾ç„¶æ˜¯æ‰“å¼€çš„ï¼Œä½¿ç”¨å‘½ä»¤<code>hadoop fsck file_path -openforwrite</code>æŸ¥çœ‹ç›®å½•ä¸‹æ‰“å¼€çš„æ–‡ä»¶ï¼Œæ˜¾ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">17</span>/08/<span class="number">03</span> <span class="number">15</span>:<span class="number">21</span>:<span class="number">50</span> WARN ssl.FileBasedKeyStoresFactory: The property <span class="string">&#x27;ssl.client.truststore.location&#x27;</span> has not been set, no TrustStore will be loaded</span><br><span class="line">Connecting to namenode via http:<span class="comment">//namenode:50070</span></span><br><span class="line"><span class="function">FSCK started by <span class="title">portal</span> <span class="params">(auth:KERBEROS_SSL)</span> from /10.160.xx.22 <span class="keyword">for</span> path file_path at Thu Aug 03 15:21:51 CST 2017</span></span><br><span class="line"><span class="function">............/file_path/xx.1501646609139.lzo.tmp 827 bytes, 1 <span class="title">block</span><span class="params">(s)</span>, OPENFORWRITE: ......................./file_path/xx.1501650099752.lzo 333 bytes, 1 <span class="title">block</span><span class="params">(s)</span>, OPENFORWRITE:</span></span><br><span class="line"><span class="function">/file_path/xx.1501650099752.lzo: MISSING 1 blocks of total size 333 B........................Status: CORRUPT</span></span><br></pre></td></tr></table></figure><p>æ˜¾ç¤º<code>OPENFORWRITE</code>ï¼Œä¹Ÿæœ‰<code>MISSING</code>ä¿¡æ¯ï¼Œæ¨æ–­åº”è¯¥æ˜¯æ–‡ä»¶æ²¡æœ‰closeæˆåŠŸã€‚</p><p>ä¹‹æ‰€ä»¥æ²¡æœ‰å…³æˆåŠŸï¼Œé€šè¿‡çœ‹flumeçš„logå‘ç°é›†ç¾¤æ˜¯safemodeçŠ¶æ€ï¼Œæ— æ³•closeæˆåŠŸï¼Œflume catchä½å¼‚å¸¸ä¹‹ååªæ˜¯æŠ›å‡ºäº†ä¸ªWARNï¼Œè®¾ç½®<code>failedToClose</code>ä¸ºtrueï¼Œç„¶åç»§ç»­æ‰§è¡Œä»£ç è¿›è¡Œrenameæ“ä½œï¼Œrenameæ“ä½œæ²¡æœ‰æˆåŠŸè¢«æ”¾åˆ°ä¸€ä¸ªçº¿ç¨‹ä¸­ä¸æ–­çš„å»å°è¯•renameï¼Œç­‰é›†ç¾¤æ¢å¤ä¹‹åï¼ŒrenameæˆåŠŸäº†ã€‚</p><p>ä¸‹é¢å°±æ˜¯æ€ä¹ˆæ¢å¤æ–‡ä»¶ï¼Œæ–‡ä»¶æ˜¯æ‰“å¼€çŠ¶æ€æ˜¯å› ä¸ºnamenodeä¾ç„¶è®°å½•è¿™è¯¥æ–‡ä»¶çš„ç§Ÿçº¦ï¼Œè¯¥ç§Ÿçº¦æ²¡æœ‰è¢«å…³é—­ï¼Œä½¿ç”¨appendToFileå‘½ä»¤æ£€éªŒä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™ä¸ªå‘½ä»¤æ‰§è¡Œä¹‹åï¼Œå…è®¸åœ¨çª—ä½“ä¸­è¾“å…¥å­—ç¬¦ä¸²ï¼ŒCtrl + Cé€€å‡ºstdinï¼Œæ­¤åstdinæ•°æ®å°†ä¼šè¿½åŠ åˆ°hdfsæ–‡ä»¶ä¸­ã€‚</span></span><br><span class="line">$ hadoop dfs -appendToFile - /file_path/<span class="number">341.</span>lzo</span><br><span class="line">DEPRECATED: Use of <span class="keyword">this</span> script to execute hdfs command is deprecated.</span><br><span class="line">Instead use the hdfs command <span class="keyword">for</span> it.</span><br><span class="line"></span><br><span class="line">appendToFile: Failed to APPEND_FILE /file_path/<span class="number">341.</span>lzo <span class="keyword">for</span> DFSClient_NONMAPREDUCE_-<span class="number">1675067591_1</span> on <span class="number">10.120</span><span class="number">.233</span><span class="number">.47</span> because <span class="keyword">this</span> file lease is currently owned by DFSClient_NONMAPREDUCE_-<span class="number">1514310687_13</span> on <span class="number">10.200</span><span class="number">.128</span><span class="number">.130</span></span><br></pre></td></tr></table></figure><p>ç§Ÿçº¦å†²çªäº†ï¼Œç¡®è®¤ç§Ÿçº¦æ²¡æœ‰å…³é—­ã€‚</p><p>åœ¨hdfså®˜ç½‘ä¸ŠæŸ¥çœ‹hdfsæœ‰æ¢å¤ç§Ÿçº¦çš„å‘½ä»¤ï¼Œ<code>hdfs debug recoverLease -path</code>ï¼Œä½†æ˜¯åœ¨2.7ç‰ˆæœ¬ä»¥åæ‰æœ‰ï¼Œæ˜¨å¤©é›†ç¾¤å‡çº§åˆ°äº†2.7.3ï¼Œä½†æ˜¯å‘çš„æ˜¯å®¢æˆ·ç«¯æ²¡æœ‰å‡çº§ä¾ç„¶æ˜¯è€ç‰ˆçš„ï¼Œæ²¡æœ‰è¿™ä¸ªå‘½ä»¤ã€‚<br>(è®©Hadoopè¿ç»´ç»™æ‰§è¡Œä¸‹debugå‘½ä»¤å±…ç„¶è®©æˆ‘æŠŠæŸåçš„æ–‡ä»¶åˆ æ‰ã€‚ã€‚ã€‚)åªå¥½è‡ªå·±è£…ä¸ª2.7.3çš„å®¢æˆ·ç«¯äº†ï¼Œç„¶åæ‰§è¡ŒrecoverLeaseå‘½ä»¤ä¹‹åï¼Œæ–‡ä»¶æ¢å¤æ­£å¸¸ã€‚</p><p>æ‰¹é‡å¤„ç†å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fsck /file_path -openforwrite | egrep -v <span class="string">&#x27;^\.+$&#x27;</span> | egrep <span class="string">&quot;MISSING|OPENFORWRITE&quot;</span> | grep -o <span class="string">&quot;/[^ ]*&quot;</span> | sed -e <span class="string">&quot;s/:$//&quot;</span> | xargs -i hdfs debug recoverLease -path &#123;&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºä»€ä¹ˆä¼šå‡ºç°ç§Ÿçº¦æ²¡æœ‰å…³é—­è¿™ä¸ªå¾ˆå¥‡æ€ªï¼ŒHDFSæ˜¯æœ‰ç§Ÿçº¦æ¢å¤æœºåˆ¶çš„ï¼Œä½†ä¸ºä»€ä¹ˆæ²¡æœ‰å…³æˆåŠŸæœ‰ç‚¹é—æ†¾ï¼Œä¹‹å‰åˆ†æçš„HDFSç§Ÿçº¦æœºåˆ¶æœ‰äº›ç»†èŠ‚ä¸å¤ªè®°å¾—äº†ï¼Œæœ‰æ—¶é—´åœ¨reviewä¸‹ã€‚</p><!-- flume closeå¤±è´¥ä¹‹åï¼Œå°†æ­¤pathä»mapä¸­ç§»é™¤ï¼Œå°±ä¸åœ¨æ“ä½œæ­¤æ–‡ä»¶äº†ï¼Œä¹Ÿå°±ä¸ä¼šè§¦å‘æ­¤æ–‡ä»¶çš„ç§Ÿçº¦ï¼Œhdfså¹¶æ²¡æœ‰å› ä¸ºtimeoutè€Œå…³é—­ç§Ÿçº¦ï¼Œä¸ºä»€ä¹ˆæ²¡æœ‰timeoutï¼Ÿï¼Ÿï¼Ÿ-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Lease </tag>
            
            <tag> LocatedBlockå¼‚å¸¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ©ç”¨canalåŒæ­¥mysqlåˆ°HDFS</title>
      <link href="/MysqlToHDFSWithCanal.html"/>
      <url>/MysqlToHDFSWithCanal.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/%E5%AE%9E%E6%97%B6%E6%8A%93%E5%8F%96MySQL%E7%9A%84%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%88%B0Hadoop.html">ä¹‹å‰æœ‰ä¸€ç¯‡</a>ä»‹ç»æ€§çš„æ–‡ç« ç®€å•ä»‹ç»äº†å®æ—¶åŒæ­¥mysqlåˆ°hdfsçš„å‡ ç§æ–¹æ¡ˆï¼Œæœ¬ç¯‡ä¸»è¦è®°å½•ä¸‹åˆ©ç”¨canalåŒæ­¥mysqlåˆ°hdfsçš„å…·ä½“æ–¹æ¡ˆã€‚</p><span id="more"></span><h2 id="canal-server-éƒ¨ç½²"><a href="#canal-server-éƒ¨ç½²" class="headerlink" title="canal server éƒ¨ç½²"></a>canal server éƒ¨ç½²</h2><p>åœ¨canalä¸­ä¸€ä¸ªmysqlå®ä¾‹å¯¹åº”ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶æ”¾åœ¨confç›®å½•ä¸‹çš„ä¸€ä¸ªæ–‡ä»¶å¤¹ä¸­ï¼Œè¯¥æ–‡ä»¶å¤¹çš„åå­—å°±ä»£è¡¨äº†mysqlå®ä¾‹ã€‚ç»“æ„å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">-rwxr-xr-x 1 dc user 2645 Jul 18 14:25 canal.properties</span><br><span class="line">-rwxr-xr-x 1 dc user 2521 Jul 17 18:31 canal.properties.bak</span><br><span class="line">-rwxr-xr-x 1 dc user 3045 Jul 17 18:31 logback.xml</span><br><span class="line">drwxr-xr-x 2 dc user 4096 Jul 17 18:38 spring</span><br><span class="line">drwxr-xr-x 2 dc user 4096 Jul 19 11:55 trans1</span><br></pre></td></tr></table></figure><p>trans1ä»£è¡¨ä¸€ä¸ªmysqlå®ä¾‹ï¼Œè¯¥æ–‡ä»¶å¤¹ä¸­æœ‰ä¸ªinstance.propertiesæ–‡ä»¶ï¼Œåœ¨é‡Œé¢é…ç½®mysqlæ•°æ®åº“çš„ä¿¡æ¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## mysql serverId éƒ¨ç½²haçš„è¯ï¼ŒslaveIdä¸èƒ½é‡å¤</span></span><br><span class="line">canal.instance.mysql.slaveId = 1235</span><br><span class="line">canal.instance.master.address = 10.172.152.66:3306</span><br><span class="line"><span class="comment"># username/password</span></span><br><span class="line">canal.instance.dbUsername = root</span><br><span class="line">canal.instance.dbPassword = root</span><br><span class="line"><span class="comment"># é‡‡é›†è¡¨çš„æ­£åˆ™</span></span><br><span class="line">canal.instance.filter.regex = .*\\..*</span><br></pre></td></tr></table></figure><h3 id="canal-server-HAéƒ¨ç½²"><a href="#canal-server-HAéƒ¨ç½²" class="headerlink" title="canal server HAéƒ¨ç½²"></a>canal server HAéƒ¨ç½²</h3><p>é‡‡ç”¨canalçš„HAæ¨¡å¼ï¼Œcanalçš„HAæ˜¯ä¾èµ–zkæ¥å®ç°çš„ã€‚<br>ä¿®æ”¹é…ç½®æ–‡ä»¶ï¼Œé…ç½®æ–‡ä»¶æ˜¯confç›®å½•ä¸‹å¤§canal.properties</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># common argument</span></span><br><span class="line">canal.id= 1             <span class="comment"># å¦ä¸€å° canal.id= 2</span></span><br><span class="line">canal.ip= 10.172.152.66 <span class="comment"># å¦ä¸€å° canal.ip= 10.172.152.124</span></span><br><span class="line">canal.port= 11111</span><br><span class="line">canal.zkServers= 10.172.152.66:2181,10.172.152.124:2181,10.172.152.125:2181</span><br><span class="line"><span class="comment"># confç›®å½•ä¸‹mysqlå®ä¾‹çš„æ–‡ä»¶å</span></span><br><span class="line">canal.destinations= trans1</span><br><span class="line"><span class="comment"># ä½¿ç”¨haå¿…é¡»ä½¿ç”¨default-instance.xml</span></span><br><span class="line">canal.instance.global.spring.xml = classpath:spring/default-instance.xml</span><br></pre></td></tr></table></figure><p>canalçš„éƒ¨ç½²æ¯”è¾ƒç®€å•ï¼Œåœ¨instance.propertiesä¹Ÿè®¾ç½®ä»å“ªä¸ªbinlogæŸä¸ªä½ç½®å¤„å¼€å§‹è¯»(æœªæµ‹)ã€‚<br>ä¸‹é¢çœ‹ä¸‹clientçš„è®¾è®¡ï¼Œç”±äºcanalå¹¶æ²¡æœ‰ç»§æ‰¿clientåªæ˜¯æä¾›äº†ä¸€å¥—clientçš„apiç”±ç”¨æˆ·è‡ªå·±å»å®ç°ï¼Œåˆ™è¿™é‡Œé‡ç‚¹è®°å½•ä¸‹clientçš„è®¾è®¡ã€‚</p><h2 id="canal-client-åŠŸèƒ½è®¾è®¡"><a href="#canal-client-åŠŸèƒ½è®¾è®¡" class="headerlink" title="canal client åŠŸèƒ½è®¾è®¡"></a>canal client åŠŸèƒ½è®¾è®¡</h2><p>clientçš„ä¸»è¦åŠŸèƒ½æ˜¯ä¸canal serverçš„æŸä¸ªdestinationså»ºç«‹è¿æ¥æ¶ˆè´¹è®¢é˜…çš„binlogä¿¡æ¯ï¼Œå¹¶å°†binlogè¿›è¡Œè§£æè½åœ°åˆ°å­˜å‚¨ç³»ç»Ÿä¸­ã€‚</p><h3 id="clientæ¶ˆè´¹åŸç†"><a href="#clientæ¶ˆè´¹åŸç†" class="headerlink" title="clientæ¶ˆè´¹åŸç†"></a>clientæ¶ˆè´¹åŸç†</h3><p>client apiä¸­æœ‰ackå’Œrollbackæœºåˆ¶ï¼Œä¿è¯äº†æ•°æ®ä¸ä¸¢å¤±ã€‚<br>ackæœºåˆ¶é‡‡ç”¨å¼‚æ­¥ç¡®è®¤ï¼Œä¹Ÿå°±æ˜¯å¯ä»¥è¿ç»­è°ƒç”¨getå¤šæ¬¡ï¼Œåç»­å¼‚æ­¥æŒ‰é¡ºåºæäº¤ack/rollbackï¼Œè¿™ç§æœºåˆ¶åœ¨canalä¸­ç§°ä¸º<em>æµå¤±api</em>è®¾è®¡ã€‚</p><p>æµå¼apiè®¾è®¡çš„å¥½å¤„ï¼š</p><ul><li>get/ackå¼‚æ­¥åŒ–ï¼Œå‡å°‘å› ackå¸¦æ¥çš„ç½‘ç»œå»¶è¿Ÿå’Œæ“ä½œæˆæœ¬ (99%çš„çŠ¶æ€éƒ½æ˜¯å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œå¼‚å¸¸çš„rollbackå±äºä¸ªåˆ«æƒ…å†µï¼Œæ²¡å¿…è¦ä¸ºä¸ªåˆ«çš„caseç‰ºç‰²æ•´ä¸ªæ€§èƒ½)</li><li>getè·å–æ•°æ®åï¼Œä¸šåŠ¡æ¶ˆè´¹å­˜åœ¨ç“¶é¢ˆæˆ–è€…éœ€è¦å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ¶ˆè´¹æ—¶ï¼Œå¯ä»¥ä¸åœçš„è½®è¯¢getæ•°æ®ï¼Œä¸åœçš„å¾€åå‘é€ä»»åŠ¡ï¼Œæé«˜å¹¶è¡ŒåŒ–ã€‚</li></ul><h3 id="æ•°æ®æ ¼å¼åŠä½¿ç”¨"><a href="#æ•°æ®æ ¼å¼åŠä½¿ç”¨" class="headerlink" title="æ•°æ®æ ¼å¼åŠä½¿ç”¨"></a>æ•°æ®æ ¼å¼åŠä½¿ç”¨</h3><p>clientå°†binlogä¸­çš„ä¿¡æ¯è§£ææˆjsonï¼Œjsonæ ¼å¼åˆ†ä¸ºä¸¤ç§ï¼Œä¸€ç§æ˜¯DMLï¼Œä¸»è¦åŒ…æ‹¬insertã€updateå’Œdeleteï¼Œå¦ä¸€ç§æ˜¯DDLï¼Œä¸»è¦åŒ…æ‹¬createã€alterå’Œdropã€‚<br>jsonæ ¼å¼å¦‚ä¸‹ï¼š</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DML-json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;database&quot;</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;e&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;delete/insert/update&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;executeTime&quot;</span>:<span class="string">&quot;1501645930000&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;consumerTime&quot;</span>:<span class="string">&quot;1501645930000&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;data&quot;</span>:[</span><br><span class="line">   &#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;1&quot;</span>,<span class="attr">&quot;num&quot;</span>:<span class="string">&quot;1&quot;</span>&#125;,</span><br><span class="line">   &#123;<span class="attr">&quot;id&quot;</span>:<span class="string">&quot;2&quot;</span>,<span class="attr">&quot;num&quot;</span>:<span class="string">&quot;2&quot;</span>&#125;</span><br><span class="line">   ]</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// DDL-json</span></span><br><span class="line">&#123;</span><br><span class="line">   <span class="attr">&quot;database&quot;</span>:<span class="string">&quot;test&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;table&quot;</span>:<span class="string">&quot;e&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;type&quot;</span>:<span class="string">&quot;create/alter/drop&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;executeTime&quot;</span>:<span class="string">&quot;1501645930000&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;consumerTime&quot;</span>:<span class="string">&quot;1501645930000&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;isDDL&quot;</span>:<span class="string">&quot;true/false&quot;</span>,</span><br><span class="line">   <span class="attr">&quot;sql&quot;</span>:<span class="string">&quot;create table e(id int)&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥åˆ†ä¸ºä¸¤ä¸ªjsonæ ¼å¼ï¼Œæ˜¯å› ä¸ºæƒ³æŠŠ<em>DML-jsoné‡Œçš„æ•°æ®ç›´æ¥æ ¼å¼åŒ–ä½œä¸ºå½“å¤©çš„å¢é‡ä½¿ç”¨</em>ï¼Œè€ŒDDL-jsonåˆ™éœ€è¦è§£ææˆhqlï¼Œä¸ªäººå»ºè®®åœ¨æ‰§è¡Œæ—¶éœ€è¦äººå·¥checkï¼ŒDDL-jsonæ¯å¤©åº”è¯¥ä¸ä¼šå¤ªå¤šï¼ŒåˆæœŸäººå·¥checkçš„å‹åŠ›ä¸å¤§ï¼Œç­‰ç¨‹åºæˆç†Ÿä¹‹åå¯ä»¥ä¸ç”¨äººå·¥checkã€‚</p><blockquote><p>è§£æDML-jsonçš„æ—¶å€™éœ€è¦ç»™æ•°æ®æ–°å¢ä¸€åˆ—æ¥æ ‡è¯†æ•°æ®çš„çŠ¶æ€ï¼Œæ•°æ®çš„çŠ¶æ€æ˜¯æŒ‡æ•°æ®æ˜¯å¦è¢«åˆ é™¤ã€‚</p></blockquote><h3 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h3><p>æ–¹ä¾¿ç¨‹åºçš„ç§»æ¤æ€§å°†ä¸€äº›å‚æ•°æå‡ºï¼Œä½œä¸ºé…ç½®æ–‡ä»¶ï¼Œç”±ç¨‹åºåŠ¨æ€å‘¨æœŸæ€§çš„åŠ è½½ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ZK_HOSTS = <span class="comment"># canal server haçš„zkåœ°å€</span></span><br><span class="line">DESTINATION =  <span class="comment"># è¦æ¶ˆè´¹çš„mysqlå®ä¾‹</span></span><br><span class="line">FILTER_REGEX =  <span class="comment"># è®¢é˜…çš„è¡¨ä¿¡æ¯çš„æ­£åˆ™</span></span><br><span class="line">BATCH_SIZE =  <span class="comment"># æ‰¹é‡è·å–çš„æ¡æ•°</span></span><br><span class="line">DML_PATH = </span><br><span class="line">DDL_PATH = </span><br><span class="line">DELAY_TIME =  <span class="comment"># å»¶è¿ŸæŠ¥è­¦çš„é˜ˆå€¼ï¼Œå•ä½ms</span></span><br></pre></td></tr></table></figure><h3 id="å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†æ•°æ®"><a href="#å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†æ•°æ®" class="headerlink" title="å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†æ•°æ®"></a>å¤šçº¿ç¨‹å¼‚æ­¥å¤„ç†æ•°æ®</h3><p>client apiæä¾›getï¼ackï¼rollbackæ¥å£ï¼Œä¸ºäº†æé«˜æ¶ˆè´¹æ•ˆç‡ï¼Œé‡‡ç”¨å¼‚æ­¥ackçš„æœºåˆ¶ã€‚</p><p>è®¾è®¡ä¸€ä¸ªä¸€å®šå¤§å°çš„<code>ackQueue</code>ï¼Œgetä¸æ–­çš„è·å–æ•°æ®ï¼Œå°†messageäº¤ç»™æ–°çº¿ç¨‹å¤„ç†å¹¶å°†<code>batchId</code>æ”¾å…¥ackQueueä¸­ï¼Œå¾…æ–°çº¿ç¨‹å¤„ç†å®Œmessageä¹‹åè¿›è¡Œackç¡®è®¤ï¼Œä»ackQueueä¸­å–å‡ºbatchIdæŒ‰é¡ºåºç¡®è®¤ï¼Œå¦‚é‡åˆ°å¼‚å¸¸è¿›è¡Œå›æ»šã€‚</p><p>ä¼ªä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span>&#123;</span><br><span class="line"><span class="keyword">while</span>(<span class="keyword">true</span>)&#123;</span><br><span class="line">Message message = connector.getWithoutAck(BATCH_SIZE); <span class="comment">// è·å–æŒ‡å®šæ•°é‡çš„æ•°æ®</span></span><br><span class="line">        batchId = message.getId();</span><br><span class="line">        ackQueue.put(batchId);</span><br><span class="line">        executorService.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="comment">// éœ€è¦ä¸€ä¸ªçº¿ç¨‹å’Œæ–‡ä»¶çš„æ˜ å°„ï¼Œé˜²æ­¢å¤šä¸ªçº¿ç¨‹å†™åŒä¸€ä¸ªæ–‡ä»¶</span></span><br><span class="line">                parseMessage(message);</span><br><span class="line">                <span class="comment">// åˆ¤æ–­batchIdæ˜¯å¦å’ŒackQueueä¸­å–å¾—çš„batchIdä¸€è‡´ï¼Œå¤§äºåˆ™ç­‰å¾…å°äºæŠ¥å¼‚å¸¸</span></span><br><span class="line">                ackMessage(batchId);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125;<span class="keyword">catch</span> (Exception e)&#123;</span><br><span class="line">connector.rollback(batchId);</span><br><span class="line">&#125;<span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="æ•°æ®å½’æ¡£"><a href="#æ•°æ®å½’æ¡£" class="headerlink" title="æ•°æ®å½’æ¡£"></a>æ•°æ®å½’æ¡£</h3><p>ç”±äºç›®å‰çš„ä½¿ç”¨åœºæ™¯å¯¹å®æ—¶è¦æ±‚ä¸é«˜ï¼Œè€Œæ˜¯ç¦»çº¿ä½¿ç”¨ï¼Œåˆ™å»ºè®®å°†æ•°æ®ç›´æ¥å†™å…¥æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿï¼Œç„¶åæ‰¹é‡ä¸Šä¼ è‡³HDFSã€‚<br>è¿™æ ·æ—¢å¯ä»¥æé«˜å†™çš„æ•ˆç‡åˆå¯ä»¥å‡å°‘å¯¹hdfsçš„æ“ä½œï¼Œå¹¶ä¸”åœ¨ä¸Šä¼ hdfsæ—¶å¯ä»¥å¯¹æ•°æ®è¿›è¡Œåˆå¹¶ï¼Œä»æºå¤´ä¸Šå‡å°‘å°æ–‡ä»¶çš„ç”Ÿæˆã€‚</p><p>æ•°æ®å½’æ¡£æ–¹æ¡ˆï¼š</p><ol><li>æ•°æ®æ–‡ä»¶åˆ‡åˆ†å¯ä»¥æŒ‰ç…§æŒæœ‰ä¸€ä¸ªæ–‡ä»¶å¥æŸ„çš„æ—¶é—´æ¥è¿›è¡Œåˆ‡åˆ†å¹¶ä¸”åˆ°é›¶ç‚¹ç»Ÿä¸€å…³é—­æ‰€æœ‰å¥æŸ„ã€‚</li><li>ä½¿ç”¨binlogä¸­çš„executeTimeè¿›è¡Œæ–‡ä»¶åˆ‡åˆ†ï¼Œä¿è¯æ•°æ®å½’æ¡£çš„æ—¶é—´å‡†å¤‡æ€§ã€‚<h3 id="è·¨ç½‘ç»œä¼ è¾“"><a href="#è·¨ç½‘ç»œä¼ è¾“" class="headerlink" title="è·¨ç½‘ç»œä¼ è¾“"></a>è·¨ç½‘ç»œä¼ è¾“</h3>åŒ—äº¬çš„æ•°æ®å‘æ­å·ä¼ è¾“é‡‡ç”¨ä¸¤ç§æ–¹æ¡ˆï¼š</li><li>clientå°†æ•°æ®å†™å…¥æœ¬åœ°ï¼Œç„¶åé€šè¿‡rsyncä¼ è¾“åˆ°æ­å·æœåŠ¡å™¨</li><li>clientè°ƒç”¨Avro rpcå°†æ•°æ®å†™å…¥æ­å·çš„flume agentçš„Avro sourceä¸­ï¼Œé€šè¿‡fileChannelå°†æ•°æ®å†™å…¥æ­å·æœåŠ¡å™¨ã€‚</li></ol><p>å¯¹æ¯”ï¼š<br>æ–¹æ¡ˆ1ä½¿ç”¨rsyncè¿›è¡Œæ•°æ®ä¼ è¾“ï¼Œç®€å•æ–¹ä¾¿åªå¼€ä¸€æ¬¡æ¥å£æƒé™ã€‚è€Œä¸”clientå’Œæ­å·çš„clientä¸€è‡´ï¼Œä¸éœ€è¦é¢å¤–çš„å¼€å‘ã€‚</p><p>æ–¹æ¡ˆ2ç”±äºä½¿ç”¨rpcä¼ è¾“åˆ™æ¯ä¸ªclientå¯¹åº”ä¸€ä¸ªportï¼Œéœ€è¦å¤šæ¬¡ç”³è¯·portæƒé™ï¼ŒåŒæ ·åœ¨æ­å·çš„æœºå™¨ä¸Šä¹Ÿéœ€è¦å¼€é€športæƒé™ï¼Œè¿™æ ·æš´éœ²çš„portè¾ƒå¤šï¼Œè€Œä¸”éœ€è¦è¿ç»´å¼€é€šæƒé™ã€‚<br>ç”±äºä¸€ä¸ªmysqlå®ä¾‹å¯¹åº”ä¸€ä¸ªclientï¼Œåˆ™ä¼šéœ€è¦å¤šä¸ªportè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</p><blockquote><p>å»ºè®®rsyncåŒæ­¥ </p></blockquote><h3 id="ç›‘æ§æŠ¥è­¦"><a href="#ç›‘æ§æŠ¥è­¦" class="headerlink" title="ç›‘æ§æŠ¥è­¦"></a>ç›‘æ§æŠ¥è­¦</h3><p>ç›‘æ§ä¸»è¦æ˜¯ç›‘æ§æ¶ˆè´¹å»¶è¿Ÿï¼Œåˆ¤æ–­æ¶ˆè´¹å»¶è¿Ÿçš„ä¾æ®æ˜¯å¤„ç†å½“å‰messageçš„æ—¶é—´å’Œè¯¥messageåœ¨binlogä¸­çš„executeTimeçš„å·®å€¼ï¼Œå¤§äºè®¾ç½®çš„é˜ˆå€¼åˆ™è®¤ä¸ºæ¶ˆè´¹æ»åï¼Œè¿›è¡ŒæŠ¥è­¦ã€‚<br>ä¹Ÿå¯ä»¥åˆ¤æ–­ä¸€ä¸ªæ—¶é—´çª—å£ä¸­ä¸¤ä¸ªæ—¶é—´ç‚¹å·®å€¼è¿›è¡Œæ˜¯å¦æ¶ˆè´¹æ»åçš„åˆ¤æ–­ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> MySQL </tag>
            
            <tag> canal </tag>
            
            <tag> åŒæ­¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè™šæ‹ŸæœºåŠGCåŸºç¡€ä»‹ç»</title>
      <link href="/Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8F%8AGC%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D.html"/>
      <url>/Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%8F%8AGC%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D.html</url>
      
        <content type="html"><![CDATA[<p>ä½œä¸ºä¸€ä¸ªhadoopå¼€å‘ï¼Œå·¥ä½œä¸­éš¾å…ä¼šé‡åˆ°gcçš„é—®é¢˜ï¼Œä»¥å‰æ€»æ˜¯ä¸€å¤´é›¾æ°´ï¼Œè¿™æ¬¡æŠ½æ—¶é—´ç³»ç»Ÿçš„æ•´ç†ä¸‹ï¼Œåªæ˜¯å…¥é—¨ï¼Œæ›´åŠ æ·±å…¥çš„çŸ¥è¯†åœ¨å·¥ä½œä¸­ç”¨åˆ°äº†å†æ•´ç†ã€‚</p><p>è¦ç†è§£gcå…ˆè¦ææ¸…æ¥šJVMï¼ŒJVMæ˜¯ä¸€ä¸ªæŠ½è±¡çš„è®¡ç®—æœºç»“æ„ã€‚Javaç¨‹åºæ ¹æ®JVMçš„ç‰¹æ€§ç¼–å†™ã€‚JVMé’ˆå¯¹ç‰¹å®šäºæ“ä½œç³»ç»Ÿå¹¶ä¸”å¯ä»¥å°†JavaæŒ‡ä»¤ç¿»è¯‘æˆåº•å±‚ç³»ç»Ÿçš„æŒ‡ä»¤å¹¶æ‰§è¡Œã€‚JVMç¡®ä¿äº†Javaçš„å¹³å°æ— å…³æ€§ã€‚</p><span id="more"></span><h2 id="JVMæ¶æ„"><a href="#JVMæ¶æ„" class="headerlink" title="JVMæ¶æ„"></a>JVMæ¶æ„</h2><p>ä¸‹å›¾æ˜¯JVMçš„æ¶æ„(æ­¤æ¶æ„å›¾æ˜¯HotSpot JVM)<br><img src="/blogimgs/Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D/JVM%E6%9E%B6%E6%9E%84.jpg" alt="JVMæ¶æ„å›¾" title="JVMæ¶æ„å›¾"><br>ä¸‹é¢ç®€å•ä»‹ç»ä¸‹å„ä¸ªç»„ä»¶ï¼š</p><blockquote><p>class filesæ–‡ä»¶æ˜¯é€šè¿‡.javaæ–‡ä»¶ç¼–è¯‘è€Œæ¥çš„ã€‚</p></blockquote><blockquote><p><em>ClassLoaderçš„ä½œç”¨æ˜¯è£…è½½èƒ½è¢«JVMè¯†åˆ«çš„æŒ‡ä»¤ï¼Œä¹Ÿå°±æ˜¯åŠ è½½.classæ–‡ä»¶åˆ°å †ä¸­ï¼Œå½¢æˆä¸€ä¸ªè¯¥ç±»çš„å¯¹è±¡(ä¹Ÿå°±æ˜¯è¯´ClassLoaderå°†classæ–‡ä»¶ç¿»è¯‘ä¸ºå¯¹è±¡å­˜æ”¾åœ¨å †å†…å­˜ä¸­ã€‚)<em>ã€‚å…¶åŠ è½½æµç¨‹ä¸º</em>åŠ è½½ â€“&gt; éªŒè¯ â€“&gt; å‡†å¤‡ â€“&gt; è§£æ â€“&gt; åˆå§‹åŒ–</em>ã€‚<br>ClassLoaderï¼Œè¿™ä¸ªä¸œè¥¿è¿˜æ˜¯éå¸¸é‡è¦çš„ï¼Œ<em>åœ¨JVMä¸­æ˜¯é€šè¿‡ClassLoaderå’Œç±»æœ¬èº«å…±åŒå»åˆ¤æ–­ä¸¤ä¸ªClassæ˜¯å¦ç›¸åŒ</em>ã€‚æ¢å¥è¯è¯´å°±æ˜¯ï¼šä¸åŒçš„ClassLoaderåŠ è½½åŒä¸€ä¸ªClassæ–‡ä»¶ï¼Œé‚£ä¹ˆJVMè®¤ä¸ºä»–ä»¬ç”Ÿæˆçš„ç±»æ˜¯ä¸åŒçš„ã€‚æœ‰äº›æ—¶å€™ä¸ä¼šä»Classæ–‡ä»¶ä¸­åŠ è½½æµï¼ˆæ¯”å¦‚Java Appletæ˜¯ä»ç½‘ç»œä¸­åŠ è½½ï¼‰ï¼Œé‚£ä¹ˆè¿™ä¸ªClassLoaderå’Œæ™®é€šçš„å®ç°é€»è¾‘å½“ç„¶æ˜¯ä¸ä¸€æ ·çš„ï¼Œé€šè¿‡ä¸åŒçš„ClassLoaderå°±å¯ä»¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚</p></blockquote><blockquote><p>Runtime Data Area(è¿è¡Œæ•°æ®åŒºåŸŸ)ä¹Ÿæ˜¯Javaå†…å­˜åŒºåŸŸï¼Œåœ¨æ­¤åŒºåŸŸå†…åˆåˆ†ä¸º5éƒ¨åˆ†ï¼ŒGCå°±æ˜¯å¯¹è¿™äº›åŒºåŸŸå†…å­˜çš„æ“ä½œã€‚å…¶ä¸­è¿™5éƒ¨åˆ†æ ¹æ®æ˜¯å¦è¢«çº¿ç¨‹å…±äº«å¯ä»¥åˆ†ä¸ºä¸¤å¤§ç±»ï¼Œ<em>PC Registerã€Java Stacks å’Œ Native Method Statckä¸ºçº¿ç¨‹ç§æœ‰çš„ï¼ŒHeap Memory å’Œ Method Areaæ˜¯çº¿ç¨‹å…±äº«çš„</em>ã€‚</p></blockquote><p>1ã€PC Register(ç¨‹åºè®¡æ•°å™¨)</p><p>PC Registeræ˜¯ä¸€ä¸ªæ¯”è¾ƒå°çš„å†…å­˜åŒºåŸŸï¼Œç”¨äºæŒ‡ç¤ºå½“å‰çº¿ç¨‹æ‰€æ‰§è¡Œçš„å­—èŠ‚ç æ‰§è¡Œåˆ°äº†ç¬¬å‡ è¡Œï¼Œå¯ä»¥ç†è§£ä¸ºæ˜¯å½“å‰çº¿ç¨‹çš„è¡Œå·æŒ‡ç¤ºå™¨ã€‚å­—èŠ‚ç è§£é‡Šå™¨åœ¨å·¥ä½œæ—¶ï¼Œä¼šé€šè¿‡æ”¹å˜è¿™ä¸ªè®¡æ•°å™¨çš„å€¼æ¥å–ä¸‹ä¸€æ¡è¯­å¥æŒ‡ä»¤ã€‚<br>æ¯ä¸ªç¨‹åºè®¡æ•°å™¨åªç”¨æ¥è®°å½•ä¸€ä¸ªçº¿ç¨‹çš„è¡Œå·ï¼Œæ‰€ä»¥å®ƒæ˜¯<strong>çº¿ç¨‹ç§æœ‰</strong>ï¼ˆä¸€ä¸ªçº¿ç¨‹å°±æœ‰ä¸€ä¸ªç¨‹åºè®¡æ•°å™¨ï¼‰çš„ã€‚<br>å¦‚æœç¨‹åºæ‰§è¡Œçš„æ˜¯ä¸€ä¸ªJavaæ–¹æ³•ï¼Œåˆ™è®¡æ•°å™¨è®°å½•çš„æ˜¯æ­£åœ¨æ‰§è¡Œçš„è™šæ‹Ÿæœºå­—èŠ‚ç æŒ‡ä»¤åœ°å€ï¼›å¦‚æœæ­£åœ¨æ‰§è¡Œçš„æ˜¯ä¸€ä¸ªæœ¬åœ°ï¼ˆnativeï¼Œç”±Cè¯­è¨€ç¼–å†™å®Œæˆï¼‰æ–¹æ³•ï¼Œåˆ™è®¡æ•°å™¨çš„å€¼ä¸ºUndefinedï¼Œç”±äºç¨‹åºè®¡æ•°å™¨åªæ˜¯è®°å½•å½“å‰æŒ‡ä»¤åœ°å€ï¼Œæ‰€ä»¥ä¸å­˜åœ¨å†…å­˜æº¢å‡ºçš„æƒ…å†µï¼Œå› æ­¤ï¼Œ<strong>ç¨‹åºè®¡æ•°å™¨æ˜¯JVMå†…å­˜åŒºåŸŸä¸­å”¯ä¸€ä¸€ä¸ªä¸ä¼šå‘ç”ŸOutOfMemoryErrorçš„åŒºåŸŸ</strong>ã€‚</p><p>2ã€Java Stacks(Java æ ˆ)</p><p>Javaæ ˆä¹Ÿç§°ä¸ºæ–¹æ³•æ ˆï¼Œå­˜æ”¾è¿™ä¸æ–¹æ³•ç›¸å…³çš„ä¿¡æ¯ï¼Œå¦‚<em>æ–¹æ³•ä¸­çš„å±€éƒ¨å˜é‡ã€æ–¹æ³•å…¥å£ã€æ–¹æ³•å‡ºå£</em>ç­‰ã€‚<br>ä¸€ä¸ªçº¿ç¨‹çš„æ¯ä¸ªæ–¹æ³•åœ¨æ‰§è¡Œçš„åŒæ—¶ï¼Œéƒ½ä¼šåˆ›å»ºä¸€ä¸ª<em>æ ˆå¸§</em>(Statck Frame)ï¼Œæ ˆå¸§ä¸­å­˜å‚¨çš„æœ‰å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œç«™ã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•å‡ºå£ç­‰ï¼Œ<em>å½“æ–¹æ³•è¢«è°ƒç”¨æ—¶ï¼Œæ ˆå¸§åœ¨Javaæ ˆä¸­å…¥æ ˆï¼Œå½“æ–¹æ³•æ‰§è¡Œå®Œæˆæ—¶ï¼Œæ ˆå¸§å‡ºæ ˆ</em>ã€‚</p><p>å±€éƒ¨å˜é‡è¡¨ä¸­å­˜å‚¨ç€æ–¹æ³•çš„ç›¸å…³<em>å±€éƒ¨å˜é‡</em>ï¼ŒåŒ…æ‹¬å„ç§åŸºæœ¬æ•°æ®ç±»å‹ï¼Œå¯¹è±¡çš„å¼•ç”¨ï¼Œè¿”å›åœ°å€ç­‰ã€‚åœ¨å±€éƒ¨å˜é‡è¡¨ä¸­ï¼Œåªæœ‰longå’Œdoubleç±»å‹ä¼šå ç”¨2ä¸ªå±€éƒ¨å˜é‡ç©ºé—´(Slotï¼Œå¯¹äº32ä½æœºå™¨ï¼Œä¸€ä¸ªSlotå°±æ˜¯32ä¸ªbit)ï¼Œå…¶å®ƒéƒ½æ˜¯1ä¸ªSlotã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<em>å±€éƒ¨å˜é‡è¡¨æ˜¯åœ¨__ç¼–è¯‘__æ—¶å°±å·²ç»ç¡®å®šå¥½çš„ï¼Œæ–¹æ³•è¿è¡Œæ‰€éœ€è¦åˆ†é…çš„ç©ºé—´åœ¨æ ˆå¸§ä¸­æ˜¯å®Œå…¨ç¡®å®šçš„</em>ï¼Œåœ¨æ–¹æ³•çš„ç”Ÿå‘½å‘¨æœŸå†…éƒ½ä¸ä¼šæ”¹å˜ã€‚</p><p>Javaæ ˆä¸­å®šä¹‰äº†ä¸¤ç§å¼‚å¸¸ï¼Œå¦‚æœçº¿ç¨‹è°ƒç”¨çš„æ ˆæ·±åº¦å¤§äºè™šæ‹Ÿæœºå…è®¸çš„æœ€å¤§æ·±åº¦(ä¾‹å¦‚é€’å½’çš„æ·±åº¦è¾ƒå¤§)ï¼Œåˆ™æŠ›å‡º<em>StatckOverFlowError</em>(æ ˆæº¢å‡º)ï¼›ä¸è¿‡å¤šæ•°Javaè™šæ‹Ÿæœºéƒ½å…è®¸åŠ¨æ€æ‰©å±•è™šæ‹Ÿæœºæ ˆçš„å¤§å°(æœ‰å°‘éƒ¨åˆ†æ˜¯å›ºå®šé•¿åº¦çš„)ï¼Œæ‰€ä»¥çº¿ç¨‹å¯ä»¥ä¸€ç›´ç”³è¯·æ ˆï¼Œç›´åˆ°å†…å­˜ä¸è¶³ï¼Œæ­¤æ—¶ï¼Œä¼šæŠ›å‡º<em>OutOfMemoryError</em>(å†…å­˜æº¢å‡º)ã€‚</p><p>Javaæ ˆä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹å¯¹åº”ç€ä¸€ä¸ªJavaæ ˆï¼Œå› æ­¤Javaæ ˆä¹Ÿæ˜¯<strong>çº¿ç¨‹ç§æœ‰</strong>çš„ã€‚</p><p>3ã€Native Method Statck(æœ¬åœ°æ–¹æ³•æ ˆ)</p><p><em>æœ¬åœ°æ–¹æ³•æ ˆåœ¨ä½œç”¨ï¼Œè¿è¡Œæœºåˆ¶ï¼Œå¼‚å¸¸ç±»å‹ç­‰æ–¹é¢éƒ½ä¸Javaæ ˆç›¸åŒ</em>ï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯ï¼šJavaæ ˆæ˜¯æ‰§è¡ŒJavaæ–¹æ³•çš„ï¼Œè€Œ<em>æœ¬åœ°æ–¹æ³•æ ˆæ˜¯ç”¨æ¥æ‰§è¡Œnativeæ–¹æ³•</em>(ä¹Ÿå°±æ˜¯ç”±cè¯­è¨€ç¼–å†™çš„æ–¹æ³•)çš„ï¼Œåœ¨å¾ˆå¤šè™šæ‹Ÿæœºä¸­ï¼ˆå¦‚Sunçš„JDKé»˜è®¤çš„HotSpotè™šæ‹Ÿæœºï¼‰ï¼Œä¼šå°†æœ¬åœ°æ–¹æ³•æ ˆä¸è™šæ‹Ÿæœºæ ˆæ”¾åœ¨ä¸€èµ·ä½¿ç”¨ã€‚<br>æœ¬åœ°æ–¹æ³•æ ˆä¹Ÿæ˜¯<em>çº¿ç¨‹ç§æœ‰</em>çš„ã€‚</p><p>4ã€Heap Memory(å †å†…å­˜)</p><p>å †å†…å­˜ä¸»è¦æ˜¯ç”¨æ¥<em>åŠ¨æ€çš„å­˜å‚¨å¯¹è±¡å®ä¾‹</em>ï¼ŒåŸåˆ™ä¸Šè®²ï¼Œæ‰€æœ‰çš„å¯¹è±¡éƒ½åœ¨å †åŒºä¸Šåˆ†é…å†…å­˜(ä¸è¿‡ç°ä»£æŠ€æœ¯é‡Œï¼Œä¹Ÿä¸æ˜¯è¿™ä¹ˆç»å¯¹çš„ï¼Œä¹Ÿæœ‰æ ˆä¸Šç›´æ¥åˆ†é…çš„)ã€‚ä¹Ÿæ˜¯<em>Java GCæœºåˆ¶æ‰€ç®¡ç†çš„ä¸»è¦å†…å­˜åŒºåŸŸ</em>ï¼Œå †åŒºç”±æ‰€æœ‰<em>çº¿ç¨‹å…±äº«</em>ï¼Œåœ¨è™šæ‹Ÿæœºå¯åŠ¨æ—¶åˆ›å»ºã€‚å †åŒºçš„å­˜åœ¨æ˜¯ä¸ºäº†å­˜å‚¨å¯¹è±¡å®ä¾‹ï¼Œ</p><p>ä¸€èˆ¬çš„ï¼Œæ ¹æ®Javaè™šæ‹Ÿæœºè§„èŒƒè§„å®šï¼Œå †å†…å­˜éœ€è¦åœ¨é€»è¾‘ä¸Šæ˜¯è¿ç»­çš„ï¼ˆåœ¨ç‰©ç†ä¸Šä¸éœ€è¦ï¼‰ï¼Œåœ¨å®ç°æ—¶ï¼Œå¯ä»¥æ˜¯å›ºå®šå¤§å°çš„ï¼Œä¹Ÿå¯ä»¥æ˜¯å¯æ‰©å±•çš„ï¼Œç›®å‰ä¸»æµçš„è™šæ‹Ÿæœºéƒ½æ˜¯å¯æ‰©å±•çš„ã€‚<em>å¦‚æœåœ¨æ‰§è¡Œåƒåœ¾å›æ”¶ä¹‹åï¼Œä»æ²¡æœ‰è¶³å¤Ÿçš„å†…å­˜åˆ†é…ï¼Œä¹Ÿä¸èƒ½å†æ‰©å±•ï¼Œå°†ä¼šæŠ›å‡ºOutOfMemoryError:__Java heap space__å¼‚å¸¸</em>ã€‚</p><p>å †å†…å­˜çš„è¯¦ç»†å†…å­˜åœ¨ä¸‹é¢çš„ç« èŠ‚è¿›è¡Œæ‰©å±•ã€‚</p><p>5ã€Method Area(æ–¹æ³•åŒº)</p><p>æ–¹æ³•åŒºä¹Ÿå°±æ˜¯å¹³æ—¶æ‰€è¯´çš„<em>éå †å†…å­˜</em>(Non-heap)ï¼Œä½†æŒ‰ç…§Java GCçš„åˆ†ä»£æ”¶é›†æœºåˆ¶æ¥è¯´ï¼Œæ–¹æ³•åŒºä¹Ÿå«æ°¸ä¹…ä»£(Permanent Generation)ã€‚</p><p>æ–¹æ³•åŒºæ˜¯å„ä¸ª<em>çº¿ç¨‹å…±äº«</em>çš„åŒºåŸŸï¼Œç”¨äºå­˜å‚¨å·²ç»è¢«è™šæ‹ŸæœºåŠ è½½çš„<em>ç±»ä¿¡æ¯</em>(å³åŠ è½½ç±»æ—¶éœ€è¦åŠ è½½çš„ä¿¡æ¯ï¼ŒåŒ…æ‹¬ç‰ˆæœ¬ã€fieldã€æ–¹æ³•ã€æ¥å£ç­‰ä¿¡æ¯)ã€<em>finalå¸¸é‡</em>ã€<em>é™æ€å˜é‡</em>ã€ç¼–è¯‘å™¨å³æ—¶ç¼–è¯‘çš„ä»£ç ç­‰ã€‚</p><p>æ–¹æ³•åŒºåœ¨ç‰©ç†ä¸Šä¹Ÿä¸éœ€è¦æ˜¯è¿ç»­çš„ï¼Œå¯ä»¥é€‰æ‹©å›ºå®šå¤§å°æˆ–å¯æ‰©å±•å¤§å°ï¼Œå¹¶ä¸”æ–¹æ³•åŒºæ¯”å †è¿˜å¤šäº†ä¸€ä¸ªé™åˆ¶ï¼šå¯ä»¥é€‰æ‹©æ˜¯å¦æ‰§è¡Œåƒåœ¾æ”¶é›†ã€‚ä¸€èˆ¬çš„ï¼Œæ–¹æ³•åŒºä¸Šæ‰§è¡Œçš„åƒåœ¾æ”¶é›†æ˜¯å¾ˆå°‘çš„ï¼Œè¿™ä¹Ÿæ˜¯æ–¹æ³•åŒºè¢«ç§°ä¸ºæ°¸ä¹…ä»£çš„åŸå› ä¹‹ä¸€ï¼ˆHotSpotï¼‰ï¼Œä½†è¿™ä¹Ÿä¸ä»£è¡¨ç€åœ¨æ–¹æ³•åŒºä¸Šå®Œå…¨æ²¡æœ‰åƒåœ¾æ”¶é›†ï¼Œå…¶ä¸Šçš„åƒåœ¾æ”¶é›†ä¸»è¦æ˜¯é’ˆå¯¹<em>å¸¸é‡æ± çš„å†…å­˜å›æ”¶å’Œå¯¹å·²åŠ è½½ç±»çš„å¸è½½</em>ã€‚</p><p>åœ¨æ–¹æ³•åŒºä¸Šè¿›è¡Œåƒåœ¾æ”¶é›†ï¼Œæ¡ä»¶è‹›åˆ»è€Œä¸”ç›¸å½“å›°éš¾ï¼Œæ•ˆæœä¹Ÿä¸ä»¤äººæ»¡æ„ï¼Œæ‰€ä»¥ä¸€èˆ¬ä¸åšå¤ªå¤šè€ƒè™‘ï¼Œå¯ä»¥ç•™ä½œä»¥åè¿›ä¸€æ­¥æ·±å…¥ç ”ç©¶æ—¶ä½¿ç”¨ã€‚</p><p>æ–¹æ³•åŒºåœ¨å†…å­˜ä¸è¶³æ—¶æŠ›å‡ºOutOfMemoryError:<strong>PermGen space</strong>å¼‚å¸¸ï¼Œã€‚</p><blockquote><p>Execution Engine(æ‰§è¡Œå¼•æ“)çš„åŠŸèƒ½æ˜¯æ‰§è¡Œclassesä¸­çš„æŒ‡ä»¤ã€‚ä»»ä½•JVM specificationå®ç°(JDK)çš„æ ¸å¿ƒéƒ½æ˜¯Execution engineï¼Œè€ŒExecution engineæœ€æ ¸å¿ƒçš„ä¸¤å—æ˜¯JIT(just in time)å³æ—¶ç¼–è¯‘å™¨å’ŒGC(Garbage Collection)åƒåœ¾å›æ”¶å™¨ã€‚Execution EngineåŒ…å«Interpreter(è§£é‡Šå™¨)ã€JITã€Hotspot profilerå’ŒGCã€‚</p></blockquote><p>Interpreterï¼šä¸»è¦åŠŸèƒ½æ˜¯è¯»bytecodeï¼Œç„¶åæ‰§è¡Œç›¸å¯¹åº”çš„æŒ‡ä»¤ã€‚<br>JIT(Just-in-time) Compilerï¼šè¿™ä¸ªéƒ¨åˆ†ä¸»è¦æ˜¯ç”¨ä»¥ä¼˜åŒ–execution engineçš„æ€§èƒ½ï¼Œä¸€èˆ¬execution engineä¼šå…ˆç”¨interpreterå»è§£é‡Šbytecode, ç„¶åæ‰§è¡Œå¯¹åº”çš„å‘½ä»¤ã€‚åœ¨å¾ˆå¤šæ—¶å€™ï¼ŒJIT complilerå¯ä»¥å°†ç›¸ç±»ä¼¼çš„bytecodeéƒ½ç¿»è¯‘æˆnative codeï¼Œç„¶åç›´æ¥è¿è¡Œã€‚ç›´æ¥æ‰§è¡Œnative codeä¼šæ¯”bytecodeå¿«ã€‚<br>Hotspot profiler: è¿™ä¸ªéƒ¨åˆ†ä¹Ÿæ˜¯ç”¨æ¥ä¼˜åŒ–æ€§èƒ½çš„ï¼Œå½“æŸäº›methodè¢«å¤šæ¬¡ä½¿ç”¨æ—¶ï¼ŒHotspotè¿™ä¸ªéƒ¨åˆ†å°±ä¼šç”¨profilerå»è®°å½•é‚£äº›methodæ‰€å¯¹åº”çš„native codeï¼Œ è¿™æ ·å°±å¯ä»¥ç›´æ¥ç”¨native codeè€Œä¸æ˜¯byte codeäº†ã€‚<br>Garbage collector: è¿™ä¸ªéƒ¨åˆ†ä¸»è¦è´Ÿè´£å†…å­˜çš„ç®¡ç†ï¼Œå½“ç¨‹åºä¸­çš„objectä¸å†è¢«ç”¨çš„æ—¶å€™ï¼Œgarbage collectorä¼šå°†å…¶åˆ é™¤ã€‚</p><p>é€šè¿‡ç±»è£…è½½å™¨è£…è½½çš„ï¼Œè¢«åˆ†é…åˆ°JVMçš„è¿è¡Œæ—¶æ•°æ®åŒºçš„å­—èŠ‚ç ä¼šè¢«<em>æ‰§è¡Œå¼•æ“</em>æ‰§è¡Œã€‚æ‰§è¡Œå¼•æ“ä»¥æŒ‡ä»¤ä¸ºå•ä½è¯»å–Javaå­—èŠ‚ç ã€‚å®ƒå°±åƒä¸€ä¸ªCPUä¸€æ ·ï¼Œä¸€æ¡ä¸€æ¡åœ°æ‰§è¡Œæœºå™¨æŒ‡ä»¤ã€‚æ¯ä¸ªå­—èŠ‚ç æŒ‡ä»¤éƒ½ç”±ä¸€ä¸ª1å­—èŠ‚çš„æ“ä½œç å’Œé™„åŠ çš„æ“ä½œæ•°ç»„æˆã€‚æ‰§è¡Œå¼•æ“å–å¾—ä¸€ä¸ªæ“ä½œç ï¼Œç„¶åæ ¹æ®æ“ä½œæ•°æ¥æ‰§è¡Œä»»åŠ¡ï¼Œå®Œæˆåå°±ç»§ ç»­æ‰§è¡Œä¸‹ä¸€æ¡æ“ä½œç ã€‚<br>ä¸è¿‡Javaå­—èŠ‚ç æ˜¯ç”¨ä¸€ç§äººç±»å¯ä»¥è¯»æ‡‚çš„è¯­è¨€ç¼–å†™çš„ï¼Œè€Œä¸æ˜¯ç”¨æœºå™¨å¯ä»¥ç›´æ¥æ‰§è¡Œçš„è¯­è¨€ã€‚å› æ­¤ï¼Œæ‰§è¡Œå¼•æ“å¿…é¡»æŠŠå­—èŠ‚ç è½¬æ¢æˆå¯ä»¥ç›´æ¥è¢«JVMæ‰§è¡Œçš„è¯­è¨€ã€‚å­—èŠ‚ç å¯ä»¥é€šè¿‡ä»¥ä¸‹ä¸¤ç§æ–¹å¼è½¬æ¢æˆåˆé€‚çš„è¯­è¨€ã€‚</p><ul><li><p>è§£é‡Šå™¨(è§£é‡Šæ‰§è¡Œ)ï¼šä¸€æ¡ä¸€æ¡åœ°è¯»å–ï¼Œè§£é‡Šå¹¶ä¸”æ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤ã€‚å› ä¸ºå®ƒä¸€æ¡ä¸€æ¡åœ°è§£é‡Šå’Œæ‰§è¡ŒæŒ‡ä»¤ï¼Œæ‰€ä»¥å®ƒå¯ä»¥å¾ˆå¿«åœ°è§£é‡Šå­—èŠ‚ç ï¼Œä½†æ˜¯æ‰§è¡Œèµ·æ¥ä¼šæ¯”è¾ƒæ…¢ã€‚è¿™æ˜¯è§£é‡Šæ‰§è¡Œçš„è¯­è¨€çš„ä¸€ä¸ªç¼ºç‚¹ã€‚å­—èŠ‚ç è¿™ç§â€œè¯­è¨€â€åŸºæœ¬æ¥è¯´æ˜¯è§£é‡Šæ‰§è¡Œçš„ã€‚</p></li><li><p>å³æ—¶(Just-In-Time)ç¼–è¯‘å™¨(ç¼–è¯‘æ‰§è¡Œ)ï¼š å³æ—¶ç¼–è¯‘å™¨è¢«å¼•å…¥ç”¨æ¥å¼¥è¡¥è§£é‡Šå™¨çš„ç¼ºç‚¹ã€‚æ‰§è¡Œå¼•æ“é¦–å…ˆæŒ‰ç…§è§£é‡Šæ‰§è¡Œçš„æ–¹å¼æ¥æ‰§è¡Œï¼Œç„¶ååœ¨åˆé€‚çš„æ—¶å€™ï¼Œå³æ—¶ç¼–è¯‘å™¨æŠŠæ•´æ®µå­—èŠ‚ç ç¼–è¯‘æˆæœ¬åœ°ä»£ç ã€‚ç„¶åï¼Œæ‰§è¡Œå¼• æ“å°±æ²¡æœ‰å¿…è¦å†å»è§£é‡Šæ‰§è¡Œæ–¹æ³•äº†ï¼Œå®ƒå¯ä»¥ç›´æ¥é€šè¿‡æœ¬åœ°ä»£ç å»æ‰§è¡Œå®ƒã€‚æ‰§è¡Œæœ¬åœ°ä»£ç æ¯”ä¸€æ¡ä¸€æ¡è¿›è¡Œè§£é‡Šæ‰§è¡Œçš„é€Ÿåº¦å¿«å¾ˆå¤šã€‚ç¼–è¯‘åçš„ä»£ç å¯ä»¥æ‰§è¡Œçš„å¾ˆå¿«ï¼Œå› ä¸º æœ¬åœ°ä»£ç æ˜¯ä¿å­˜åœ¨ç¼“å­˜é‡Œçš„ã€‚</p></li></ul><p>ä¸è¿‡ï¼Œç”¨JITç¼–è¯‘å™¨æ¥ç¼–è¯‘ä»£ç æ‰€èŠ±çš„æ—¶é—´è¦æ¯”ç”¨è§£é‡Šå™¨å»ä¸€æ¡æ¡è§£é‡Šæ‰§è¡ŒèŠ±çš„æ—¶é—´è¦å¤šã€‚å› æ­¤ï¼Œå¦‚æœä»£ç åªè¢«æ‰§è¡Œä¸€æ¬¡çš„è¯ï¼Œé‚£ä¹ˆæœ€å¥½è¿˜æ˜¯è§£é‡Šæ‰§è¡Œè€Œä¸æ˜¯ç¼–è¯‘åå†æ‰§è¡Œã€‚å› æ­¤ï¼Œå†…ç½®äº†JITç¼–è¯‘å™¨çš„JVMéƒ½ä¼šæ£€æŸ¥æ–¹æ³•çš„æ‰§è¡Œé¢‘ç‡ï¼Œ<em>å¦‚æœä¸€ä¸ªæ–¹æ³•çš„æ‰§è¡Œé¢‘ç‡è¶…è¿‡ä¸€ä¸ªç‰¹å®šçš„å€¼çš„è¯ï¼Œé‚£ä¹ˆè¿™ä¸ªæ–¹æ³•å°±ä¼šè¢«ç¼–è¯‘æˆæœ¬åœ°ä»£ç </em>ã€‚</p><h2 id="åƒåœ¾å›æ”¶-GC"><a href="#åƒåœ¾å›æ”¶-GC" class="headerlink" title="åƒåœ¾å›æ”¶(GC)"></a>åƒåœ¾å›æ”¶(GC)</h2><p><em>åƒåœ¾å›æ”¶ä¸»è¦ç»„ä»¶æ˜¯å †å†…å­˜å’Œåƒåœ¾å›æ”¶å™¨</em>ã€‚å †å†…å­˜æ˜¯å†…å­˜æ•°æ®åŒºï¼Œç”¨æ¥ä¿å­˜è¿è¡Œæ—¶çš„å¯¹è±¡å®ä¾‹ã€‚åƒåœ¾å›æ”¶å™¨ä¹Ÿä¼šåœ¨è¿™é‡Œæ“ä½œã€‚åƒåœ¾å›æ”¶å™¨æ˜¯ä¸ªå®ˆæŠ¤è¿›ç¨‹ã€‚</p><p>GCä¸»è¦æ˜¯å¯¹å †å†…å­˜çš„å›æ”¶ï¼Œå †å†…å­˜æŒ‰ç…§éš”ä»£åˆ’åˆ†å°†å †å†…å­˜åˆ’åˆ†ä¸ºæ–°ç”Ÿä»£(Young Generation)ã€è€å¹´ä»£(Old Generation)ï¼Œæ–¹æ³•åŒº(non-heap)åˆ’åˆ†ä¸ºæ°¸ä¹…ä»£(Permanent Generation)ã€‚javaçš„å†…å­˜åˆ†é…å¦‚ä¸‹å›¾ï¼š<br><img src="/blogimgs/Java%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E7%A1%80%E4%BB%8B%E7%BB%8D/java%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D.png" alt="javaå†…å­˜åˆ†é…" title="javaå†…å­˜åˆ†é…"></p><ul><li>æ–°ç”Ÿä»£</li></ul><p>æ–°ç”Ÿä»£åˆ†ä¸º3ä¸ªåŒºåŸŸï¼šEdenã€Survivor0å’ŒSurvivor1ã€‚</p><p>æ–°åˆ›å»ºçš„å¯¹è±¡è¢«åˆ†é…åœ¨EdenåŒº(å¤§å¯¹è±¡å¯ä»¥ç›´æ¥è¢«åˆ›å»ºåœ¨å¹´è€ä»£)ï¼Œç”±äºå¤§éƒ¨åˆ†å¯¹è±¡åœ¨åˆ›å»ºåä¼šå¾ˆå¿«ä¸å†ä½¿ç”¨ï¼Œæ‰€ä»¥å¾ˆå¤šå¯¹è±¡è¢«åˆ›å»ºåœ¨æ–°ç”Ÿä»£ï¼Œç„¶åæ¶ˆå¤±ã€‚å¯¹è±¡ä»è¿™ä¸ªåŒºåŸŸæ¶ˆå¤±çš„è¿‡ç¨‹æˆ‘ä»¬ç§°ä¹‹ä¸º*minor GC(or young gc)*ã€‚</p><p>æ–°ç”Ÿä»£minor gcçš„æµç¨‹ä¸ºï¼š<br>1ã€æ–°ç”Ÿæˆçš„å¯¹è±¡æ”¾å…¥EdenåŒºï¼Œç­‰EdenåŒºæ»¡ä¹‹åï¼Œæ‰§è¡Œä¸€æ¬¡minor gcï¼Œå°†Edenä¸­å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡æ”¾å…¥S0(Survivor0)ä¸­<br>2ã€æ­¤æ—¶EdenåŒºä¸ºç©ºï¼Œæ–°ç”Ÿçš„å¯¹è±¡å†æ¬¡æ”¾å…¥EdenåŒºï¼ŒEdenåŒºå†æ¬¡è¢«æ”¾æ»¡ï¼Œæ‰§è¡Œä¸€æ¬¡minor gcï¼Œæ­¤æ—¶å°†Edenä¸­å­˜æ´»çš„å¯¹è±¡å†æ¬¡æ”¾å…¥S0ä¸­ï¼Œ<em>å¾ªç¯å‡ æ¬¡å¾…S0ä¹Ÿæ»¡ä¹‹å</em>ï¼Œå°†Edenå’ŒS0ä¸­å­˜æ´»çš„å¯¹è±¡æ”¾å…¥S1ä¸­ï¼Œæ­¤æ—¶Edenå’ŒS0ä¸ºç©º<br>3ã€åå¤ä¸Šè¿°æµç¨‹15æ¬¡(é»˜è®¤15æ¬¡ï¼Œç”±-XX:MaxTenuringThresholdæ§åˆ¶ï¼Œå¤§äºè¯¥å€¼è¿›å…¥è€å¹´ä»£ï¼Œ<em>ä½†è¿™åªæ˜¯ä¸ªæœ€å¤§å€¼ï¼Œå¹¶ä¸ä»£è¡¨ä¸€å®šæ˜¯è¿™ä¸ªå€¼</em>)ä¹‹åï¼Œå°†S0æˆ–è€…S1ä¸­ä¾ç„¶å­˜æ´»çš„å¯¹è±¡æ”¾å…¥è€å¹´ä»£ä¸­ï¼Œå°†Edenä¸­å­˜æ´»çš„å¯¹è±¡æ”¾å…¥S0æˆ–è€…S1ä¸­ã€‚</p><blockquote><p>S0å’ŒS1ä¸¤ä¸ªå¹¸å­˜åŒºåŒæ—¶åªæœ‰ä¸€ä¸ªåŒºåŸŸé‡Œæœ‰æ•°æ®</p></blockquote><blockquote><p>Edenã€S0å’ŒS1æ‰€å çš„æ¯”ä¾‹ç”±å‚æ•°-XX:SurvivorRatioæ§åˆ¶ï¼Œé»˜è®¤SurvivorRatio=8ï¼Œå³Eden:S0:S1=8:1:1ã€‚å¦‚æœSurvivorRatio=10ï¼ŒEden:S0:S1=10:1:1ï¼ŒEdenå æ–°ç”Ÿä»£çš„10/12ï¼ŒS0å’ŒS1å„å 1/12ã€‚</p></blockquote><p>åœ¨æ‰§è¡Œminor gcæ—¶å¯èƒ½<em>éœ€è¦æŸ¥è¯¢æ•´ä¸ªè€å¹´ä»£ä»¥ç¡®å®šæ–°ç”Ÿä»£ä¸­çš„å¯¹è±¡æ˜¯å¦å¯ä»¥æ¸…ç†å›æ”¶</em>ï¼Œè¿™æ˜¾ç„¶æ˜¯ä½æ•ˆçš„ã€‚è§£å†³çš„æ–¹æ³•æ˜¯ï¼Œè€å¹´ä»£ä¸­ç»´æŠ¤ä¸€ä¸ª<em>card table</em>ï¼Œä»–æ˜¯ä¸€ä¸ª512 byteå¤§å°çš„å—ã€‚æ‰€æœ‰è€å¹´ä»£å¯¹è±¡å¼•ç”¨æ–°ç”Ÿä»£å¯¹è±¡çš„è®°å½•éƒ½è®°å½•åœ¨è¿™é‡Œã€‚å½“é’ˆå¯¹æ–°ç”Ÿä»£æ‰§è¡ŒGCçš„æ—¶å€™ï¼Œåªéœ€è¦æŸ¥è¯¢card tableæ¥å†³å®šæ˜¯å¦å¯ä»¥è¢«å›æ”¶ï¼Œè€Œä¸ç”¨æŸ¥è¯¢æ•´ä¸ªè€å¹´ä»£ã€‚è¿™ä¸ªcard tableç”±ä¸€ä¸ªwrite barrieræ¥ç®¡ç†ã€‚write barrierç»™GCå¸¦æ¥äº†å¾ˆå¤§çš„æ€§èƒ½æå‡ï¼Œè™½ç„¶ç”±æ­¤å¯èƒ½å¸¦æ¥ä¸€äº›å¼€é”€ï¼Œä½†GCçš„æ•´ä½“æ—¶é—´è¢«æ˜¾è‘—çš„å‡å°‘ã€‚</p><ul><li>è€å¹´ä»£</li></ul><p>å¯¹è±¡å¦‚æœåœ¨å¹´è½»ä»£å­˜æ´»äº†è¶³å¤Ÿé•¿çš„æ—¶é—´è€Œæ²¡æœ‰è¢«æ¸…ç†æ‰(å³åœ¨å‡ æ¬¡Young GCåå­˜æ´»äº†ä¸‹æ¥)ï¼Œåˆ™ä¼šè¢«å¤åˆ¶åˆ°è€å¹´ä»£ï¼Œè€å¹´ä»£çš„ç©ºé—´ä¸€èˆ¬æ¯”æ–°ç”Ÿä»£å¤§ï¼Œèƒ½å­˜æ”¾æ›´å¤šçš„å¯¹è±¡ï¼Œåœ¨è€å¹´ä»£ä¸Šå‘ç”Ÿçš„GCæ¬¡æ•°ä¹Ÿæ¯”æ–°ç”Ÿä»£å°‘ã€‚å½“è€å¹´ä»£å†…å­˜ä¸è¶³æ—¶ï¼Œå°†æ‰§è¡Œ<em>Major GCï¼Œä¹Ÿå«Full GC</em>ã€‚</p><p>ä»–ä»¬æ˜¯ä¸€ä¸ªæ¦‚å¿µï¼Œå°±æ˜¯é’ˆå¯¹è€å¹´ä»£/æ°¸ä¹…ä»£è¿›è¡ŒGCã€‚å› ä¸ºå–åå«Fullå°±ä¼šè®©äººç–‘æƒ‘ï¼Œåˆ°åº•ä¼šä¸ä¼šå…ˆMinor GCã€‚<em>äº‹å®ä¸ŠFull GCæœ¬èº«ä¸ä¼šå…ˆè¿›è¡ŒMinor GC</em>ï¼Œ<strong>æˆ‘ä»¬å¯ä»¥é…ç½®</strong>ï¼Œè®©Full GCä¹‹å‰å…ˆè¿›è¡Œä¸€æ¬¡Minor GCï¼Œå› ä¸ºè€å¹´ä»£å¾ˆå¤šå¯¹è±¡éƒ½ä¼šå¼•ç”¨åˆ°æ–°ç”Ÿä»£çš„å¯¹è±¡ï¼Œå…ˆè¿›è¡Œä¸€æ¬¡Minor GCå¯ä»¥æé«˜è€å¹´ä»£GCçš„é€Ÿåº¦ã€‚<em>æ¯”å¦‚è€å¹´ä»£ä½¿ç”¨CMSæ—¶ï¼Œè®¾ç½®CMSScavengeBeforeRemarkä¼˜åŒ–ï¼Œè®©CMS remarkä¹‹å‰å…ˆè¿›è¡Œä¸€æ¬¡Minor GC</em>ã€‚</p><blockquote><p>ä¸ªäººç†è§£Major GCé’ˆå¯¹OldåŒºï¼Œæ­¤åŒºåŸŸçš„gcç®—æ³•åŒ…æ‹¬CMSã€G1ç­‰ã€‚è€ŒFull GCçš„æ¬¡æ•°æ˜¯ç”±STW(stop the world)å†³å®šçš„ï¼Œåˆ™å½“ä½¿ç”¨CMS(initial markã€concurrent markã€remarkå’Œconcurrent sweep)æ—¶ï¼Œå¯¹OldåŒºè¿›è¡Œgcæ—¶ï¼Œfull gcçš„ä¸ªæ•°ä¼šåŠ 2ï¼Œå› ä¸ºCMSä¸­STWçš„æ¬¡æ•°æ˜¯2(åˆ†åˆ«ä¸ºinitial markå’Œremarké˜¶æ®µ)</p></blockquote><blockquote><p><strong>CMS ä¸ç­‰äºFull GCï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°CMSåˆ†ä¸ºå¤šä¸ªé˜¶æ®µï¼Œåªæœ‰stop the worldçš„é˜¶æ®µè¢«è®¡ç®—åˆ°äº†Full GCçš„æ¬¡æ•°å’Œæ—¶é—´ï¼Œè€Œå’Œä¸šåŠ¡çº¿ç¨‹å¹¶å‘çš„GCçš„æ¬¡æ•°å’Œæ—¶é—´åˆ™ä¸è¢«è®¤ä¸ºæ˜¯Full GC</strong></p></blockquote><blockquote><p>æ–°ç”Ÿä»£å’Œè€å¹´ä»£æ‰€å å†…å­˜çš„æ¯”ä¾‹å‚æ•°ç”±-XX:NewRatioæ§åˆ¶ï¼Œé»˜è®¤NewRatio=3ï¼Œå³Old:Young=3:1ï¼Œåˆ™Oldå å†…å­˜çš„3/4ï¼ŒYoungå å†…å­˜çš„1/4ã€‚</p></blockquote><ul><li>æ°¸ä¹…ä»£</li></ul><p>æ°¸ä¹…ä»£ç”¨æ¥ä¿å­˜<em>ç±»å¸¸é‡ä»¥åŠå­—ç¬¦ä¸²å¸¸é‡</em>ã€‚å› æ­¤ï¼Œ<em>è¿™ä¸ªåŒºåŸŸä¸æ˜¯ç”¨æ¥æ°¸ä¹…çš„å­˜å‚¨é‚£äº›ä»è€å¹´ä»£å­˜æ´»ä¸‹æ¥çš„å¯¹è±¡</em>ã€‚è¿™ä¸ªåŒºåŸŸä¹Ÿå¯èƒ½å‘ç”ŸGCã€‚å¹¶ä¸”å‘ç”Ÿåœ¨è¿™ä¸ªåŒºåŸŸä¸Šçš„GCäº‹ä»¶ä¹Ÿä¼šè¢«ç®—ä¸º<em>major GC</em>ã€‚</p><p><em>è¿è¡Œæ—¶å¸¸é‡æ± </em>(Runtime Constant Pool)æ˜¯å­˜åœ¨è¯¥åŒºåŸŸï¼Œç”¨äºå­˜å‚¨ç¼–è¯‘æœŸå°±ç”Ÿæˆçš„å­—é¢å¸¸é‡ã€ç¬¦å·å¼•ç”¨ã€ç¿»è¯‘å‡ºæ¥çš„ç›´æ¥å¼•ç”¨(ç¬¦å·å¼•ç”¨å°±æ˜¯ç¼–ç æ˜¯ç”¨å­—ç¬¦ä¸²è¡¨ç¤ºæŸä¸ªå˜é‡ã€æ¥å£çš„ä½ç½®ï¼Œç›´æ¥å¼•ç”¨å°±æ˜¯æ ¹æ®ç¬¦å·å¼•ç”¨ç¿»è¯‘å‡ºæ¥çš„åœ°å€ï¼Œå°†åœ¨ç±»é“¾æ¥é˜¶æ®µå®Œæˆç¿»è¯‘)ï¼›è¿è¡Œæ—¶å¸¸é‡æ± é™¤äº†å­˜å‚¨ç¼–è¯‘æœŸå¸¸é‡å¤–ï¼Œä¹Ÿå¯ä»¥å­˜å‚¨åœ¨è¿è¡Œæ—¶é—´äº§ç”Ÿçš„å¸¸é‡(æ¯”å¦‚Stringç±»çš„intern()æ–¹æ³•ï¼Œä½œç”¨æ˜¯Stringç»´æŠ¤äº†ä¸€ä¸ªå¸¸é‡æ± ï¼Œå¦‚æœè°ƒç”¨çš„å­—ç¬¦â€œabcâ€å·²ç»åœ¨å¸¸é‡æ± ä¸­ï¼Œåˆ™è¿”å›æ± ä¸­çš„å­—ç¬¦ä¸²åœ°å€ï¼Œå¦åˆ™ï¼Œæ–°å»ºä¸€ä¸ªå¸¸é‡åŠ å…¥æ± ä¸­ï¼Œå¹¶è¿”å›åœ°å€)ã€‚</p><h2 id="GCç›‘æ§"><a href="#GCç›‘æ§" class="headerlink" title="GCç›‘æ§"></a>GCç›‘æ§</h2><p>GCç›‘æ§ä¸»è¦æ˜¯ä¸ºäº†ææ¸…æ¥šJVMæ˜¯å¦‚ä½•æ‰§è¡ŒGCçš„ï¼Œé‰´åˆ«JVMæ˜¯å¦åœ¨é«˜æ•ˆåœ°æ‰§è¡ŒGCï¼Œä»¥åŠæ˜¯å¦æœ‰å¿…è¦è¿›è¡Œé¢å¤–çš„æ€§èƒ½è°ƒä¼˜ã€‚</p><p>ç›‘æ§GCæœ‰å¾ˆå¤šç§æ–¹æ³•ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ä¸¤ç§ï¼Œä¸€ç§æ˜¯å›¾å½¢åŒ–çš„GCç›‘æ§ï¼Œä¸€ç§æ˜¯å‘½ä»¤è¡Œå¼çš„ç›‘æ§å‘½ä»¤ã€‚</p><h3 id="å›¾å½¢åŒ–GCç›‘æ§"><a href="#å›¾å½¢åŒ–GCç›‘æ§" class="headerlink" title="å›¾å½¢åŒ–GCç›‘æ§"></a>å›¾å½¢åŒ–GCç›‘æ§</h3><p>å›¾å½¢åŒ–GCç›‘æ§ä¸»è¦ä»‹ç»ä¸‹JDKè‡ªå¸¦çš„Java VisualVMã€‚</p><p>Java VisualVMå­˜åœ¨JDKçš„å®‰è£…ç›®å½•ä¸‹çš„binæ–‡ä»¶å¤¹ä¸­ã€‚ä¸»è¦ç”¨äºï¼š</p><ul><li>ç”Ÿæˆå¹¶åˆ†æå †çš„å†…å­˜è½¬å‚¨ï¼›</li><li>åœ¨MBeansä¸Šè§‚å¯Ÿå¹¶æ“ä½œï¼›</li><li>ç›‘è§†åƒåœ¾å›æ”¶ï¼›</li><li>å†…å­˜å’ŒCPUæ€§èƒ½åˆ†æï¼›</li></ul><p>æ›´å¤šè¯¦ç»†å†…å®¹è¯·çœ‹<a href="http://www.importnew.com/13838.html">è¿™é‡Œ</a></p><h3 id="GCç›‘æ§å‘½ä»¤"><a href="#GCç›‘æ§å‘½ä»¤" class="headerlink" title="GCç›‘æ§å‘½ä»¤"></a>GCç›‘æ§å‘½ä»¤</h3><p>GCç›‘æ§å‘½ä»¤å¸¸ç”¨çš„æœ‰<em>jstatå’Œjmap</em>ã€‚</p><ul><li>jstat</li></ul><p>jstatç”¨äºç›‘è§†è™šæ‹Ÿæœºå„ç§è¿è¡ŒçŠ¶æ€ä¿¡æ¯çš„å‘½ä»¤è¡Œå·¥å…·ã€‚å¯ä»¥æ˜¾ç¤ºæœ¬åœ°æˆ–è€…è¿œç¨‹è™šæ‹Ÿæœºè¿›ç¨‹ä¸­çš„<em>ç±»è£…è½½ã€å†…å­˜ã€åƒåœ¾æ”¶é›†ã€JITç¼–è¯‘</em>ç­‰è¿è¡Œæ•°æ®ã€‚<br>å…¶å‘½ä»¤æ ¼å¼ä¸º<code>jstat [ option vmid|lvmid [interval[s|ms] [count]]]</code>ï¼Œå…¶ä¸­vmidæ˜¯è¿æ¥æœ¬åœ°è™šæ‹Ÿæœºç”¨çš„ï¼Œlvmidæ˜¯è¿æ¥è¿œç¨‹è™šæ‹Ÿæœºç”¨çš„ï¼Œå‚æ•°intervalå’Œcountä»£è¡¨æŸ¥è¯¢é—´éš”å’Œæ¬¡æ•°ï¼Œçœç•¥è¯´æ˜æŸ¥è¯¢1æ¬¡ã€‚å‡è®¾éœ€è¦æ¯250æ¯«ç§’æŸ¥è¯¢ä¸€æ¬¡è¿›ç¨‹1234åƒåœ¾æ”¶é›†çš„çŠ¶æ€ï¼Œä¸€å…±æŸ¥è¯¢3æ¬¡ï¼Œåˆ™å‘½ä»¤ä¸º<code>jstat -gc 1234 250 3</code>ï¼Œè¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">S0C       S1C       S0U    S1U      EC         EU          OC         OU         PC         PU         YGC     YGCT    FGC      FGCT     GCT</span><br><span class="line">3008.0   3072.0    0.0     1511.1   343360.0   46383.0     699072.0   283690.2   75392.0    41064.3    2540    18.454    4      1.133    19.588</span><br><span class="line">3008.0   3072.0    0.0     1511.1   343360.0   47530.9     699072.0   283690.2   75392.0    41064.3    2540    18.454    4      1.133    19.588</span><br><span class="line">3008.0   3072.0    0.0     1511.1   343360.0   47793.0     699072.0   283690.2   75392.0    41064.3    2540    18.454    4      1.133    19.588</span><br></pre></td></tr></table></figure><p>å…¶ä¸­å„åˆ—ä»£è¡¨çš„æ„æ€å¦‚ä¸‹ï¼š<br>S0C  è¾“å‡ºSurvivor0ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>S1C     è¾“å‡ºSurvivor1ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>S0U     è¾“å‡ºSurvivor0å·²ç”¨ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>S1U     è¾“å‡ºSurvivor1å·²ç”¨ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>EC  è¾“å‡ºEdenç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>EU  è¾“å‡ºEdenå·²ç”¨ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>OC  è¾“å‡ºè€å¹´ä»£ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>OU  è¾“å‡ºè€å¹´ä»£å·²ç”¨ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>PC  è¾“å‡ºæŒä¹…ä»£ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>PU  è¾“å‡ºæŒä¹…ä»£å·²ç”¨ç©ºé—´çš„å¤§å°ã€‚å•ä½KBã€‚<br>YGC     æ–°ç”Ÿä»£ç©ºé—´GCæ—¶é—´å‘ç”Ÿçš„æ¬¡æ•°ã€‚<br>YGCT  æ–°ç”Ÿä»£GCå¤„ç†èŠ±è´¹çš„æ—¶é—´ã€‚<br>FGC     full GCå‘ç”Ÿçš„æ¬¡æ•°ã€‚<br>FGCT  full GCæ“ä½œèŠ±è´¹çš„æ—¶é—´<br>GCT     GCæ“ä½œèŠ±è´¹çš„æ€»æ—¶é—´ã€‚</p><ul><li>jmap</li></ul><p>jampæ˜¯å†…å­˜æ˜ å°„å·¥å…·ï¼Œç”¨äºç”Ÿæˆå †è½¬å‚¨å¿«ç…§(ä¸€èˆ¬ç§°ä¸ºheapdumpæˆ–è€…dumpæ–‡ä»¶)ã€‚<em>jmapçš„ä½œç”¨ä¸ä»…ä»…æ˜¯ä¸ºäº†ç”Ÿæˆdumpæ–‡ä»¶ï¼Œè¿˜å¯ä»¥æŸ¥è¯¢finalizeæ‰§è¡Œé˜Ÿåˆ—ã€javaå †å’Œæ°¸ä¹…ä»£çš„è¯¦ç»†ä¿¡æ¯</em>ï¼Œå¦‚ç©ºé—´ä½¿ç”¨ç‡ã€å½“å‰ç”¨çš„æ˜¯å“ªç§åƒåœ¾æ”¶é›†å™¨ç­‰ã€‚<br>å…¶å‘½ä»¤æ ¼å¼ä¸º<code>jmap [ option ] vmid</code>ï¼Œå¸¸ç”¨optionæœ‰-dumpå’Œ-heapï¼Œ-dumpç”¨äºç”Ÿæˆjavaå †è½¬å‚¨å¿«ç…§ã€‚-heapç”¨äºæ˜¾ç¤ºjavaå †çš„è¯¦ç»†ä¿¡æ¯ï¼Œå¦‚ä½¿ç”¨å“ªç§å›æ”¶å™¨ã€å‚æ•°é…ç½®ã€åˆ†ä»£æƒ…å†µç­‰ã€‚</p><p>æŸ¥çœ‹è¿›ç¨‹pidçš„å†…å­˜ä½¿ç”¨æƒ…å†µ<br>å‘½ä»¤<code>jmap -histo:live pid &gt; mem</code><br>æˆ–è€…<br>å‘½ä»¤<code>jmap -histo pid &gt; mem</code></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬ç¯‡ä¸»è¦ç§‘æ™®äº†ä¸‹JVMçš„æ¶æ„å’ŒJavaçš„å†…å­˜åˆ†é…ã€‚åœ¨JVMæ¶æ„ä¸­ä¸»è¦å…³æ³¨è¿è¡Œæ—¶æ•°æ®åŒºåŸŸï¼Œè¿™é‡Œåˆ†ä¸ºä¸¤å¤§ç±»ï¼Œçº¿ç¨‹å…±äº«çš„æ–¹æ³•åŒºå’ŒJavaå †ï¼Œçº¿ç¨‹ç§æœ‰çš„ç¨‹åºè®¡æ•°å™¨ã€Javaæ ˆå’Œæœ¬åœ°æ–¹æ³•æ ˆï¼Œçº¿ç¨‹ç§æœ‰æ˜¯æŒ‡æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šæœ‰è¿™3ä¸ªæ¨¡å—ã€‚åœ¨æ•´ä¸ªè¿è¡Œæ—¶æ•°æ®åŒºåŸŸåªæœ‰ç¨‹åºè®¡æ•°å™¨ä¸ä¼šå‘ç”ŸOOMï¼Œå…¶å®ƒéƒ¨åˆ†éƒ½ä¼šå‘ç”ŸOOMï¼ŒOOMçš„ä¸»è¦ç±»å‹æœ‰<em>Java heap spaceã€PermGen spaceã€OutOfMemoryErrorå’ŒStatckOverFlowError</em>ã€‚</p><!-- // JVM sizing options-server -Xms40g -Xmx40g -XX:MaxDirectMemorySize=4096m -XX:PermSize=256m -XX:MaxPermSize=256m   // Young generation options-XX:NewSize=6g -XX:MaxNewSize=6g -XX:+UseParNewGC -XX:MaxTenuringThreshold=2 -XX:SurvivorRatio=8 -XX:+UnlockDiagnosticVMOptions -XX:ParGCCardsPerStrideChunk=32768// Old generation  options-XX:+UseConcMarkSweepGC -XX:CMSParallelRemarkEnabled -XX:+ParallelRefProcEnabled -XX:+CMSClassUnloadingEnabled  -XX:CMSInitiatingOccupancyFraction=80 -XX:+UseCMSInitiatingOccupancyOnly   // Other options-XX:+AlwaysPreTouch -XX:+PrintGCDetails -XX:+PrintGCTimeStamps -XX:+PrintGCDateStamps -XX:+PrintTenuringDistribution -XX:+PrintGCApplicationStoppedTime -XX:-OmitStackTraceInFastThrow--><h2 id="é™„åŠ ï¼šç›´æ¥å†…å­˜"><a href="#é™„åŠ ï¼šç›´æ¥å†…å­˜" class="headerlink" title="é™„åŠ ï¼šç›´æ¥å†…å­˜"></a>é™„åŠ ï¼šç›´æ¥å†…å­˜</h2><p>ç›´æ¥å†…å­˜å¹¶ä¸æ˜¯JVMç®¡ç†çš„å†…å­˜ï¼Œåˆ™ç›´æ¥å†…å­˜åœ¨åˆ†é…æ—¶ä¸ä¼šå—åˆ°Javaå †å¤§å°çš„é™åˆ¶ï¼Œä½†æ˜¯ä¼šå—åˆ°æœ¬æœºå†…å­˜å¤§å°çš„é™åˆ¶ï¼Œæ‰€æœ‰ä¹Ÿå¯èƒ½ä¼šæŠ›<em>OutOfMemoryErrorå¼‚å¸¸</em>ã€‚å¯ä»¥è¿™æ ·ç†è§£ï¼Œç›´æ¥å†…å­˜ï¼Œå°±æ˜¯JVMä»¥å¤–çš„æœºå™¨å†…å­˜ï¼Œæ¯”å¦‚ï¼Œä½ æœ‰4Gçš„å†…å­˜ï¼ŒJVMå ç”¨äº†1Gï¼Œåˆ™å…¶ä½™çš„3Gå°±æ˜¯ç›´æ¥å†…å­˜ã€‚</p><p>JDKä¸­æœ‰ä¸€ç§åŸºäºé€šé“(Channel)å’Œç¼“å†²åŒº(Buffer)çš„å†…å­˜åˆ†é…æ–¹å¼ï¼Œå°†ç”±Cè¯­è¨€å®ç°çš„nativeå‡½æ•°åº“åˆ†é…åœ¨ç›´æ¥å†…å­˜ä¸­ï¼Œç”¨å­˜å‚¨åœ¨JVMå †ä¸­çš„DirectByteBufferæ¥å¼•ç”¨ã€‚<br>åœ¨NIOç±»ä¸­å¼•å…¥ä¸€ç§åŸºäºé€šé“ä¸ç¼“å†²åŒºçš„IOæ–¹å¼ï¼Œå®ƒå¯ä»¥ä½¿ç”¨Nativeå‡½æ•°åº“ç›´æ¥åˆ†é…å †å¤–å†…å­˜ï¼Œç„¶åé€šè¿‡ä¸€ä¸ªå­˜å‚¨åœ¨Javaå †ä¸­çš„DirectByteBufferå¯¹è±¡ä½œä¸ºè¿™å—å†…å­˜çš„å¼•ç”¨è¿›è¡Œæ“ä½œã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> jvm </tag>
            
            <tag> gc </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>unclean.leader.election.enableå¼•èµ·çš„outOfRanger</title>
      <link href="/unclean.leader.election.enable%E5%BC%95%E8%B5%B7%E7%9A%84outOfRanger.html"/>
      <url>/unclean.leader.election.enable%E5%BC%95%E8%B5%B7%E7%9A%84outOfRanger.html</url>
      
        <content type="html"><![CDATA[<p>å‰æ®µæ—¶é—´é‡‡é›†å¹³å°çš„æ•°æ®é‡å‘ç”Ÿå¼‚å¸¸ï¼Œå¯¹æ•°æ®è¿›è¡Œæ’æŸ¥å‘ç°hdfsä¸Šå­˜åœ¨å†å²æ•°æ®é‡å¤æ¶ˆè´¹çš„é—®é¢˜ã€‚</p><blockquote><p>é‡‡é›†å¹³å°æ˜¯ç”±TailDirSource+KafkaChannelå°†æ•°æ®å†™å…¥kafkaï¼Œç„¶åé€šè¿‡kafkaChannel+HDFSSinkå°†æ•°æ®å†™å…¥hdfs </p></blockquote><p>æ•´ä¸ªé‡‡é›†å¹³å°å¯èƒ½å‡ºç°çš„æ•…éšœçš„åœ°æ–¹å¦‚ä¸‹ï¼š</p><ol><li>taildiré‡å¤é‡‡é›†äº†log </li><li>taildirè°ƒç”¨kafkachannelå‘kafkaå†™æ•°æ®æ—¶è¿›è¡Œäº†å›æ»š</li><li>hdfsSinkè°ƒç”¨kafkachannelæ¶ˆè´¹æ•°æ®æ—¶ï¼Œè¿›è¡Œäº†é‡å¤æ¶ˆè´¹</li><li>hdfsSinkå†™å…¥hdfsæ—¶å‘ç”Ÿäº†å›æ»š</li></ol><span id="more"></span><h2 id="æ•…éšœåˆ†æ"><a href="#æ•…éšœåˆ†æ" class="headerlink" title="æ•…éšœåˆ†æ"></a>æ•…éšœåˆ†æ</h2><ol><li>é¦–å…ˆæ£€æŸ¥äº†ä¸‹hdfsä¸Šçš„æ•°æ®é‡å¼‚å¸¸çš„ç°è±¡ï¼Œæ˜¯å¤šä½™çš„æ•°æ®æ˜¯æœ€æ–°çš„æ•°æ®è¿˜æ˜¯å†å²æ•°æ®ï¼Œç»æ•°æ®æ ¡éªŒç¡®è®¤æ•°æ®é‡æš´å¢æ˜¯ç”±äºå†å²æ•°æ®é€ æˆçš„ã€‚</li><li>æŸ¥çœ‹ä¸šåŠ¡æ–¹æœåŠ¡å™¨ä¸Šå†å²logæ˜¯å¦å‘ç”Ÿå˜åŒ–ï¼ŒæŸ¥è¯ålogçš„å†å²æ–‡ä»¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ã€‚</li><li>é‡‡é›†ç«¯çš„flume logæ— å¼‚å¸¸ï¼Œåœ¨kafkaåˆ°hdfsçš„ç¯èŠ‚ä¸­çš„flume logä¸­å‘ç°<em>infoçº§åˆ«çš„offseté‡ç½®ä¿¡æ¯</em>ã€‚åˆæ­¥æ€€ç–‘æ˜¯offsetå‘ç”Ÿäº†out of rangerï¼Œç„¶åè¢«é‡ç½®äº†offsetï¼Œè€Œè¿™ä¸ªoffsetåˆæ˜¯æ¯”è¾ƒæ—©çš„ä¸€ä¸ªoffsetï¼Œå¯¼è‡´é‡æ–°è¯»å–äº†å¤§é‡çš„å†å²æ•°æ®ã€‚<br>log å†…å®¹å¦‚ä¸‹ï¼š</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">15 äº”æœˆ 2017 17:56:59,396 INFO  [SinkRunner-PollingRunner-DefaultSinkProcessor] (org.apache.kafka.clients.consumer.internals.Fetcher.handleFetchResponse:595)  - Fetch offset 2261734 is out of range, resetting offset</span><br></pre></td></tr></table></figure><h2 id="å®è·µéªŒè¯"><a href="#å®è·µéªŒè¯" class="headerlink" title="å®è·µéªŒè¯"></a>å®è·µéªŒè¯</h2><p>åœ¨KafkaOffsetMonitorçš„logä¸­å‘ç°offseté‡ç½®çš„è®°å½•ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">2017-05-18 13:25:17 INFO  KafkaOffsetGetter$:68 - Processed commit message: [consumer-group,topic-xx,8] =&gt; OffsetAndMetadata[119088,0e78ce6b-4dca-4cd6-b914-22b78ebbaaff,1495085117090]</span><br><span class="line"><span class="comment"># ä¸‹ä¸€æ¬¡è®°å½•çš„offsetå°±å‘ç”Ÿäº†é‡ç½®ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</span></span><br><span class="line">2017-05-18 13:25:20 INFO  KafkaOffsetGetter$:68 - Processed commit message: [bconsumer-group,topic-xx,8] =&gt; OffsetAndMetadata[418,b0abba89-4f7a-4168-9e90-39a4db2a62f0,1495085120134]</span><br></pre></td></tr></table></figure><p>ä»logä¸­å¯ä»¥çœ‹å‡ºtopic topic-xxçš„8åˆ†åŒºçš„offsetä»119088ç½®æˆäº†418ã€‚</p><p>ç„¶åä»ä»£ç ä¸­æŸ¥æ‰¾out of rangerç›¸å…³çš„ä»£ç å¹¶ç»“åˆå½“å‰é›†ç¾¤çš„çŠ¶æ€è¿›è¡Œåˆ†æï¼Œå‘ç°å½“æŸä¸ªtopicçš„leaderå’Œfollowersçš„çŠ¶æ€ä¸ä¸€è‡´æ—¶ï¼Œå‘ç”Ÿleaderåˆ‡æ¢æ—¶ï¼Œä¼šå‘é€out of rangeï¼Œæ­¤æ—¶consumerè¿›è¡Œæ¶ˆè´¹æ—¶å‘ç°offsetéæ³•ï¼Œå°±ä¼šè¢«é‡ç½®ä¸ºearliestï¼Œè¿›è¡Œé‡å¤æ¶ˆè´¹ã€‚</p><h2 id="æ•…éšœé‡ç°"><a href="#æ•…éšœé‡ç°" class="headerlink" title="æ•…éšœé‡ç°"></a>æ•…éšœé‡ç°</h2><p>åœ¨æµ‹è¯•ç¯å¢ƒä¸­åˆ›å»ºä¸€ä¸ªtopic testï¼Œ3ä¸ªåˆ†åŒºï¼Œ2ä¸ªå‰¯æœ¬ï¼Œbroker 1ä¸ºleaderï¼Œbroker 2ä¸ºfollowerã€‚<br>å†™å…¥ä¸€äº›æ•°æ®flumeè¿›è¡Œæ­£å¸¸æ¶ˆè´¹ï¼Œæ¶ˆè´¹è‡³æœ€æ–°çŠ¶æ€Aå¤„ä¹‹åï¼Œå°†testçš„followerçš„broker2åœæ‰ï¼Œç»§ç»­å‘testå†™å…¥æ•°æ®ï¼Œå¹¶è®©consumerå†æ¬¡æ¶ˆè´¹è‡³æœ€æ–°çŠ¶æ€Bå¤„ã€‚</p><blockquote><p>æ­¤æ—¶åœæ‰çš„follower broker 2çš„çŠ¶æ€å·²å’Œleader broker 1çš„çŠ¶æ€ä¸ä¸€æ ·ï¼Œå·²æ»åleaderçš„çŠ¶æ€ã€‚</p></blockquote><p>ç°åœ¨å°†follower broker 2å¯åŠ¨ï¼Œæ­¤æ—¶followerå’Œleaderçš„çŠ¶æ€ä¸ä¸€æ ·ï¼Œfolloweréœ€è¦å’Œleaderè¿›è¡ŒåŒæ­¥ï¼Œä½†å½“followerä¸leaderæœªåŒæ­¥æˆåŠŸä¹‹å‰å°†leader broker 1åœæ‰ï¼Œç„¶åfollower broker 2ç»è¿‡leaderçš„é€‰ä¸¾æœºåˆ¶è¢«è¿«é€‰ä¸ºleader(<em>unclean.leader.election.enableä¸ºtrueæ—¶ï¼Œé€‰æ‹©ç¬¬ä¸€ä¸ªå¯åŠ¨çš„å‰¯æœ¬ä¸ºleader</em>)ï¼Œåœ¨è¢«é€‰ä¸¾ä¸ºleaderä¹‹å‰broker 2çš„çŠ¶æ€å¹¶æ²¡æœ‰å’Œbroker 1çš„çŠ¶æ€ä¸€è‡´ï¼Œ<strong>ä¹Ÿå°±æ˜¯è¯´broker 2ä¸Šçš„LEOå¹¶æ²¡æœ‰åŒæ­¥åˆ°Bå¤„ï¼Œè€Œbroker 2è¢«é€‰ä¸¾ä¸ºäº†leaderï¼Œæ­¤æ—¶producerç»§ç»­å‘topicä¸­å†™æ•°æ®ï¼Œå†™å…¥ä¹‹åconsumerä¼šè¿›è¡Œæ¶ˆè´¹ï¼Œconsumeréœ€è¦æ¶ˆè´¹çš„offsetçš„Bï¼Œè€Œbroker 2çš„LEOå¹¶æ²¡æœ‰åŒæ­¥åˆ°Bå¤„ï¼Œæ­¤æ—¶å°±å‘ç”Ÿäº†out of rangerï¼Œoffsetè¢«é‡ç½®ä¸ºäº†earliest</strong>ã€‚</p><h2 id="ä¼˜åŒ–æ–¹æ¡ˆ"><a href="#ä¼˜åŒ–æ–¹æ¡ˆ" class="headerlink" title="ä¼˜åŒ–æ–¹æ¡ˆ"></a>ä¼˜åŒ–æ–¹æ¡ˆ</h2><p>é’ˆå¯¹ä»¥ä¸Šæƒ…å†µæˆ‘ä»¬è¿›è¡Œäº†ä¸€ä¸‹ä¿®æ”¹ï¼š</p><ol><li>å°†topicçš„å‰¯æœ¬æ•°è®¾ç½®ä¸º3(åŸå…ˆä¸º2)ï¼Œå‡å°‘ISRåˆ—è¡¨åªæœ‰ä¸€ä¸ªleaderçš„å‡ ç‡</li><li>è°ƒæ•´<code>min.insync.replicas</code>ä¸º2(é»˜è®¤æ˜¯1)ï¼Œæ­¤å‚æ•°çš„æ„æ€æ˜¯å½“ISRä¸­çš„ä¸ªæ•°å°äºæ­¤å€¼æ—¶ï¼Œproduceræ— æ³•å†™å…¥æ•°æ®ï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ã€‚æ­¤å‚æ•°è¿˜éœ€è¦ç»“åˆacksæ¥ä½¿ç”¨ï¼Œéœ€è¦å°†acksè®¾ç½®ä¸ºallæˆ–è€…-1(flumeä¸­kafkaChannelé»˜è®¤æ˜¯all)ã€‚</li><li>è°ƒæ•´<code>unclean.leader.election.enable</code>å‚æ•°ä¸ºfalse(é»˜è®¤ä¸ºtrue)ï¼Œæ­¤å‚æ•°æ ‡è¯†å½“ISRä¸­æ²¡æœ‰å‰¯æœ¬æ—¶ï¼Œé€‰ä¸¾æœ€æ—©å¯åŠ¨çš„brokerä¸ºleaderã€‚</li><li>è°ƒæ•´æ“ä½œç£ç›˜çš„çº¿ç¨‹æ•°num.io.threadsä¸º24(åŸæ¥ä¸º12)</li><li>å¯¹flume taildirSourceè¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œåœ¨bodyä¸­æ·»åŠ logæ‰€åœ¨ä¸»æœºåã€log è·¯å¾„å’Œé‡‡é›†æ—¶é—´ã€‚æ·»åŠ è¿™äº›å…ƒæ•°æ®ä¿¡æ¯ä¸ºæ—¥åæ•…éšœæ’é™¤æä¾›æ–¹ä¾¿ã€‚</li><li>kafkachannelä¸­å¢åŠ producerç«¯é‡è¯•çš„metricsç»Ÿè®¡(ç¬¬2ç‚¹ä¸­å†™å…¥å¤±è´¥çš„æ¬¡æ•°ä¼šåœ¨æ­¤å¤„è®°å½•)è¯¥åŠŸèƒ½æäº¤ï¼Œ<a href="https://issues.apache.org/jira/browse/FLUME-3104">patch</a> </li><li>é›†ç¾¤å› ä¸ºç»´æŠ¤éœ€è¦é‡å¯æ—¶ï¼Œå…ˆåœæ‰ä¸€å°brokerï¼Œç„¶åé‡å¯è¯¥brokerï¼Œç­‰åˆ°è¯¥brokerå·²åŠ å…¥åˆ°ISRä¸­ä¹‹åï¼Œå†å¯¹å…¶å®ƒbrokerè¿›è¡Œå¦‚ä¸Šæ“ä½œï¼Œåˆ‡å‹¿å•ä¸ªbrokerä¾æ¬¡é‡å¯ã€‚</li></ol>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
            <tag> è¿ç»´ </tag>
            
            <tag> big data </tag>
            
            <tag> offset resetting </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹ApplicationMasterå¯åŠ¨æµç¨‹</title>
      <link href="/YARNSrcApplicationMasterStart.html"/>
      <url>/YARNSrcApplicationMasterStart.html</url>
      
        <content type="html"><![CDATA[<p>ä»»ä½•ä¸€ä¸ªè®¡ç®—æ¡†æ¶æˆ–è€…è¯´ä¸€ä¸ªæœåŠ¡è¦è¿è¡Œåœ¨yarnä¸Šï¼Œéƒ½éœ€è¦ä¸€ä¸ªmasteræ¥å¯¹jobè¿›è¡Œç®¡ç†ï¼Œè¿™ä¸ªmasterå°±æ˜¯ApplicationMasterã€‚</p><p>ApplicationMasteræ˜¯ä¸€ä¸ªjobçš„å¤§è„‘ï¼Œä¸‹é¢å°±ä»¥MapReduceä¸ºä¾‹ï¼Œä»‹ç»ä¸‹ApplicationMasterçš„å¯åŠ¨æµç¨‹ã€‚</p><span id="more"></span><p>é¦–å…ˆclientå‘RMæäº¤ä¸€ä¸ªapplicationè¯·æ±‚ï¼ŒRMåˆ›å»ºä¸€ä¸ªapplicationï¼Œç„¶åå†åˆ›å»ºä¸€ä¸ªappattemptï¼ŒåæœŸçš„è°ƒåº¦å’Œä»»åŠ¡çš„æ‹†è§£éƒ½æ˜¯å¯¹è¿™ä¸ªappattemptè¿›è¡Œçš„ï¼Œå½“appattemptçš„çŠ¶æ€ä»<code>ALLOCATED_SAVING</code>å˜æˆ<code>ALLOCATED</code>æ—¶ï¼Œç”±<code>AttemptStoredTransition.transition</code>è°ƒç”¨<code>appAttempt.launchAttempt()</code>è¿›è¡Œå¯åŠ¨ï¼Œä¸‹é¢æ¥çœ‹ä¸‹å…·ä½“ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RMAppAttemptImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">launchAttempt</span><span class="params">()</span></span>&#123;</span><br><span class="line">  <span class="comment">// Send event to launch the AM Container</span></span><br><span class="line">  <span class="comment">// é€šè¿‡å¼‚æ­¥è°ƒåº¦å™¨å¾—åˆ°è¯¥äº‹ä»¶æ³¨å†Œçš„handle (åœ¨ResourceManagerä¸­æ³¨å†Œ)</span></span><br><span class="line">  <span class="comment">// AMLauncherEvent å¯¹åº”çš„handleæ˜¯ApplicationMasterLauncher</span></span><br><span class="line">  eventHandler.handle(<span class="keyword">new</span> AMLauncherEvent(AMLauncherEventType.LAUNCH, <span class="keyword">this</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AMLauncherEventå¯¹åº”çš„handleæ˜¯ApplicationMasterLauncherï¼Œäº‹ä»¶ç±»å‹æ˜¯LAUNCHï¼Œåœ¨<code>ApplicationMasterLauncher.handle</code>ä¸­ä¼šè°ƒç”¨<code>launch(application)</code>ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">(RMAppAttempt application)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªçº¿ç¨‹</span></span><br><span class="line">  Runnable launcher = createRunnableLauncher(application, </span><br><span class="line">      AMLauncherEventType.LAUNCH);</span><br><span class="line">  <span class="comment">// å°†çº¿ç¨‹æ”¾å…¥é˜»å¡é˜Ÿåˆ—ä¸­</span></span><br><span class="line">  masterEvents.add(launcher);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªä»è¿™ä¸ªæ–¹æ³•æ¥åˆ†æï¼Œé¦–å…ˆåˆ›å»ºäº†ä¸€ä¸ªlauncherçº¿ç¨‹ï¼Œç„¶åå°†å…¶æ”¾å…¥ä¸€ä¸ªé˜Ÿåˆ—ä¸­ï¼Œç­‰å¾…å¦ä¸€ä¸ªçº¿ç¨‹ä»é˜Ÿåˆ—ä¸­å–å‡ºè¿›è¡Œæ“ä½œï¼Œè¿™æ˜¯å…¸å‹çš„ç”Ÿäº§è€…æ¶ˆè´¹è€…æ¨¡å‹ã€‚é‚£ä¹ˆæˆ‘ä»¬å°±æ¥çœ‹ä¸‹<code>ApplicationMasterLauncher</code>(ApplicationMasterLauncheræ˜¯ä¸€ä¸ªäº‹ä»¶ä¹Ÿæ˜¯ä¸€ä¸ªæœåŠ¡)å…³äºè¿™å—ä»£ç çš„å…·ä½“å®ç°ã€‚</p><p>å…ˆçœ‹ä¸‹<code>createRunnableLauncher</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Runnable <span class="title">createRunnableLauncher</span><span class="params">(RMAppAttempt application, </span></span></span><br><span class="line"><span class="params"><span class="function">    AMLauncherEventType event)</span> </span>&#123;</span><br><span class="line">  Runnable launcher =</span><br><span class="line">      <span class="keyword">new</span> AMLauncher(context, application, event, getConfig());</span><br><span class="line">  <span class="keyword">return</span> launcher;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œåªæ˜¯newäº†ä¸€ä¸ªAMLauncherï¼ŒAMLauncherå®ç°äº†Runnableæ¥å£ï¼Œæ˜¯æ‰§è¡ŒAMæ“ä½œçš„çº¿ç¨‹ï¼Œåªæ‰§è¡Œ<code>launch</code>å’Œ<code>cleanup</code>ã€‚</p><p>launcherçº¿ç¨‹åˆ›å»ºä¹‹åaddåˆ°é˜»å¡é˜Ÿåˆ—masterEventsä¸­ï¼Œé‚£ä¹ˆå¿…ç„¶ä¼šæœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ¥é˜Ÿåˆ—ä¸­take launcherï¼Œè¿™ä¸ªçº¿ç¨‹æ˜¯<code>LauncherThread</code>ç±»å‹çš„<code>launcherHandlingThread</code>ï¼ŒlauncherHandlingThreadå°†launcherå–å‡ºä¸¢ç»™çº¿ç¨‹æ± å»æ‰§è¡Œï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">LauncherThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">LauncherThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>(<span class="string">&quot;ApplicationMaster Launcher&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">while</span> (!<span class="keyword">this</span>.isInterrupted()) &#123;</span><br><span class="line">      Runnable toLaunch;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ä»é˜»å¡é˜Ÿåˆ—ä¸­å–å‡º </span></span><br><span class="line">        toLaunch = masterEvents.take();</span><br><span class="line">        <span class="comment">// äº¤ç»™çº¿ç¨‹æ± æ‰§è¡Œ</span></span><br><span class="line">        <span class="comment">// this.launcherPool = new ThreadPoolExecutor(10, 10, 1, TimeUnit.HOURS, new LinkedBlockingQueue&lt;Runnable&gt;());</span></span><br><span class="line">        launcherPool.execute(toLaunch);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        LOG.warn(<span class="keyword">this</span>.getClass().getName() + <span class="string">&quot; interrupted. Returning.&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure><p>æ”¾å…¥çº¿ç¨‹æ± ä¹‹åï¼Œlauncherçº¿ç¨‹å°±å¼€å§‹æ‰§è¡Œï¼Œè°ƒç”¨çš„æ˜¯<code>AMLauncher.run</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">  <span class="keyword">case</span> LAUNCH:</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      LOG.info(<span class="string">&quot;Launching master&quot;</span> + application.getAppAttemptId());</span><br><span class="line">      launch();</span><br><span class="line">      <span class="comment">// å‘AMLivelinessMonitorä¸­æ³¨å†Œam</span></span><br><span class="line">      handler.handle(<span class="keyword">new</span> RMAppAttemptEvent(application.getAppAttemptId(),</span><br><span class="line">          RMAppAttemptEventType.LAUNCHED));</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Exception ie) &#123;</span><br><span class="line">      String message = <span class="string">&quot;Error launching &quot;</span> + application.getAppAttemptId()</span><br><span class="line">          + <span class="string">&quot;. Got exception: &quot;</span> + StringUtils.stringifyException(ie);</span><br><span class="line">      LOG.info(message);</span><br><span class="line">      handler.handle(<span class="keyword">new</span> RMAppAttemptLaunchFailedEvent(application</span><br><span class="line">          .getAppAttemptId(), message));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CLEANUP:</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    LOG.warn(<span class="string">&quot;Received unknown event-type &quot;</span> + eventType + <span class="string">&quot;. Ignoring.&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹å‰æ”¾å…¥é˜»å¡é˜Ÿåˆ—masterEventsçš„äº‹ä»¶ç±»å‹æ˜¯LAUNCHï¼Œåˆ™æ­¤å¤„è°ƒç”¨<code>launch()</code>æ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">launch</span><span class="params">()</span> <span class="keyword">throws</span> IOException, YarnException </span>&#123;</span><br><span class="line">  <span class="comment">// å¾—åˆ°å¯¹åº”nodeçš„rpcå®¢æˆ·ç«¯</span></span><br><span class="line">  connect();</span><br><span class="line">  ContainerId masterContainerID = masterContainer.getId();</span><br><span class="line">  ApplicationSubmissionContext applicationContext =</span><br><span class="line">    application.getSubmissionContext();</span><br><span class="line">  LOG.info(<span class="string">&quot;Setting up container &quot;</span> + masterContainer</span><br><span class="line">      + <span class="string">&quot; for AM &quot;</span> + application.getAppAttemptId());  </span><br><span class="line">  ContainerLaunchContext launchContext =</span><br><span class="line">      createAMContainerLaunchContext(applicationContext, masterContainerID);</span><br><span class="line">  <span class="comment">// æ„å»ºrequest</span></span><br><span class="line">  StartContainerRequest scRequest =</span><br><span class="line">      StartContainerRequest.newInstance(launchContext,</span><br><span class="line">        masterContainer.getContainerToken());</span><br><span class="line">  List&lt;StartContainerRequest&gt; list = <span class="keyword">new</span> ArrayList&lt;StartContainerRequest&gt;();</span><br><span class="line">  list.add(scRequest);</span><br><span class="line">  StartContainersRequest allRequests =</span><br><span class="line">      StartContainersRequest.newInstance(list);</span><br><span class="line">  <span class="comment">// è¿œç¨‹è°ƒç”¨startContainers</span></span><br><span class="line">  StartContainersResponse response =</span><br><span class="line">      containerMgrProxy.startContainers(allRequests);</span><br><span class="line">  <span class="keyword">if</span> (response.getFailedRequests() != <span class="keyword">null</span></span><br><span class="line">      &amp;&amp; response.getFailedRequests().containsKey(masterContainerID)) &#123;</span><br><span class="line">    Throwable t =</span><br><span class="line">        response.getFailedRequests().get(masterContainerID).deSerialize();</span><br><span class="line">    parseAndThrowException(t);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Done launching container &quot;</span> + masterContainer + <span class="string">&quot; for AM &quot;</span></span><br><span class="line">        + application.getAppAttemptId());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AMLaunch.launchå…ˆåœ¨<code>connect()</code>ä¸­æ‹¿åˆ°å¯¹åº”nodeçš„rpcå®¢æˆ·ç«¯<code>containerMgrProxy</code>ï¼Œç„¶åæ„é€ requestï¼Œæœ€åè°ƒç”¨rpcå‡½æ•°<code>startContainers()</code>å¹¶è¿”å›responseã€‚çœ‹ä¸‹<em>nodeç«¯</em>çš„<code>startContainers</code>ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StartContainersResponse</span></span><br><span class="line"><span class="function">    <span class="title">startContainers</span><span class="params">(StartContainersRequest requests)</span> <span class="keyword">throws</span> YarnException,</span></span><br><span class="line"><span class="function">        IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  UserGroupInformation remoteUgi = getRemoteUgi();</span><br><span class="line">  NMTokenIdentifier nmTokenIdentifier = selectNMTokenIdentifier(remoteUgi);</span><br><span class="line">  authorizeUser(remoteUgi,nmTokenIdentifier);</span><br><span class="line">  List&lt;ContainerId&gt; succeededContainers = <span class="keyword">new</span> ArrayList&lt;ContainerId&gt;();</span><br><span class="line">  Map&lt;ContainerId, SerializedException&gt; failedContainers =</span><br><span class="line">      <span class="keyword">new</span> HashMap&lt;ContainerId, SerializedException&gt;();</span><br><span class="line">  <span class="keyword">for</span> (StartContainerRequest request : requests.getStartContainerRequests()) &#123;</span><br><span class="line">    ContainerId containerId = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ContainerTokenIdentifier containerTokenIdentifier =</span><br><span class="line">          BuilderUtils.newContainerTokenIdentifier(request.getContainerToken());</span><br><span class="line">      verifyAndGetContainerTokenIdentifier(request.getContainerToken(),</span><br><span class="line">        containerTokenIdentifier);</span><br><span class="line">      containerId = containerTokenIdentifier.getContainerID();</span><br><span class="line">      startContainerInternal(nmTokenIdentifier, containerTokenIdentifier,</span><br><span class="line">        request);</span><br><span class="line">      succeededContainers.add(containerId);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (YarnException e) &#123;</span><br><span class="line">      failedContainers.put(containerId, SerializedException.newInstance(e));</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InvalidToken ie) &#123;</span><br><span class="line">      failedContainers.put(containerId, SerializedException.newInstance(ie));</span><br><span class="line">      <span class="keyword">throw</span> ie;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="keyword">throw</span> RPCUtil.getRemoteException(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> StartContainersResponse.newInstance(getAuxServiceMetaData(),</span><br><span class="line">    succeededContainers, failedContainers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>startContainerså¯¹requestä¸­çš„containerè¯·æ±‚è¿›è¡Œéå†ï¼Œè°ƒç”¨<code>startContainerInternal</code>å¯åŠ¨ä¸€ä¸ªcontainerï¼Œè¿™ä¸ªcontaineræ˜¯åœ¨nodemanagerä¸Šå‡†å¤‡è¿è¡Œtaskçš„ã€‚å¯åŠ¨æˆåŠŸçš„æ”¾å…¥succeededContainersåˆ—è¡¨ä¸­ï¼Œå¤±è´¥çš„åˆ™æ”¾å…¥failedContainersä¸­ï¼Œéå†ç»“æŸæ„é€ ä¸€ä¸ªresponseè¿”å›ç»™rmã€‚</p><p>çœ‹ä¸‹å¯åŠ¨containerçš„startContainerInternalæ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startContainerInternal</span><span class="params">(NMTokenIdentifier nmTokenIdentifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    ContainerTokenIdentifier containerTokenIdentifier,</span></span></span><br><span class="line"><span class="params"><span class="function">    StartContainerRequest request)</span> <span class="keyword">throws</span> YarnException, IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  ContainerId containerId = containerTokenIdentifier.getContainerID();</span><br><span class="line">  String containerIdStr = containerId.toString();</span><br><span class="line">  String user = containerTokenIdentifier.getApplicationSubmitter();</span><br><span class="line"></span><br><span class="line">  LOG.info(<span class="string">&quot;Start request for &quot;</span> + containerIdStr + <span class="string">&quot; by user &quot;</span> + user);</span><br><span class="line">  <span class="comment">// å¾—åˆ°å½“å‰containerçš„ä¸Šä¸‹æ–‡ä¿¡æ¯</span></span><br><span class="line">  ContainerLaunchContext launchContext = request.getContainerLaunchContext();</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// åˆ›å»ºcontainerå¯¹è±¡ï¼Œå¼€å§‹NodeManagerä¸Šcontainerçš„çŠ¶æ€æœºè½¬æ¢</span></span><br><span class="line">  <span class="comment">// containerçš„åˆå§‹çŠ¶æ€ä¸ºNEW</span></span><br><span class="line">  Container container =</span><br><span class="line">      <span class="keyword">new</span> ContainerImpl(getConfig(), <span class="keyword">this</span>.dispatcher,</span><br><span class="line">          context.getNMStateStore(), launchContext,</span><br><span class="line">        credentials, metrics, containerTokenIdentifier);</span><br><span class="line"></span><br><span class="line">  ApplicationId applicationID =</span><br><span class="line">      containerId.getApplicationAttemptId().getApplicationId();</span><br><span class="line">  <span class="comment">// å°†containeræ”¾å…¥contextçš„containersä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (context.getContainers().putIfAbsent(containerId, container) != <span class="keyword">null</span>) &#123;</span><br><span class="line">    NMAuditLogger.logFailure(user, AuditConstants.START_CONTAINER,</span><br><span class="line">      <span class="string">&quot;ContainerManagerImpl&quot;</span>, <span class="string">&quot;Container already running on this node!&quot;</span>,</span><br><span class="line">      applicationID, containerId);</span><br><span class="line">    <span class="keyword">throw</span> RPCUtil.getRemoteException(<span class="string">&quot;Container &quot;</span> + containerIdStr</span><br><span class="line">        + <span class="string">&quot; already is running on this node!!&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!serviceStopped) &#123;</span><br><span class="line">      <span class="comment">// Create the application</span></span><br><span class="line">      <span class="comment">// åˆ›å»ºapplicationå¯¹è±¡</span></span><br><span class="line">      Application application =</span><br><span class="line">          <span class="keyword">new</span> ApplicationImpl(dispatcher, user, applicationID, credentials, context);</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯è¯¥applicationçš„ç¬¬ä¸€ä¸ªcontainerï¼Œåˆ™è¿›è¡Œä¸€äº›è¾…åŠ©æ“ä½œï¼Œå¦‚å¯åŠ¨log aggregationæœåŠ¡</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="keyword">null</span> == context.getApplications().putIfAbsent(applicationID,</span><br><span class="line">        application)) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Creating a new application reference for app &quot;</span> + applicationID);</span><br><span class="line">        LogAggregationContext logAggregationContext =</span><br><span class="line">            containerTokenIdentifier.getLogAggregationContext();</span><br><span class="line">        Map&lt;ApplicationAccessType, String&gt; appAcls =</span><br><span class="line">            container.getLaunchContext().getApplicationACLs();</span><br><span class="line">        <span class="comment">// logAggregationContextæ”¾å…¥contextä¸­å…±ç”¨</span></span><br><span class="line">        context.getNMStateStore().storeApplication(applicationID,</span><br><span class="line">            buildAppProto(applicationID, user, credentials, appAcls,</span><br><span class="line">              logAggregationContext));</span><br><span class="line">        <span class="comment">// è§¦å‘ApplicationEventType.INIT_APPLICATIONäº‹ä»¶ç±»å‹</span></span><br><span class="line">        dispatcher.getEventHandler().handle(</span><br><span class="line">          <span class="keyword">new</span> ApplicationInitEvent(applicationID, appAcls,</span><br><span class="line">            logAggregationContext));</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">this</span>.context.getNMStateStore().storeContainer(containerId, request);</span><br><span class="line">      <span class="comment">// è§¦å‘ApplicationEventType.INIT_CONTAINERäº‹ä»¶ç±»å‹</span></span><br><span class="line">      dispatcher.getEventHandler().handle(</span><br><span class="line">        <span class="keyword">new</span> ApplicationContainerInitEvent(container));</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> YarnException(</span><br><span class="line">          <span class="string">&quot;Container start failed as the NodeManager is &quot;</span> +</span><br><span class="line">          <span class="string">&quot;in the process of shutting down&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>startContainerInternalé¦–å…ˆåˆ›å»ºä¸€ä¸ªcontainerå¯¹è±¡ï¼Œè¿™ä¹Ÿå°±å¼€å¯äº†containerçš„çŠ¶æ€æœºä¹‹æ—…ï¼Œæ–°å»ºçš„containerçŠ¶æ€æ˜¯NEWã€‚<br>éšååˆ¤æ–­è¯¥containeræ˜¯å¦æ˜¯è¯¥applicationçš„ç¬¬ä¸€ä¸ªcontainerï¼Œå¦‚æœæ˜¯åˆ™å¯åŠ¨æ—¥å¿—èšåˆåŠŸèƒ½ï¼Œå¹¶è§¦å‘ApplicationEventType.INIT_APPLICATIONäº‹ä»¶ç±»å‹ï¼Œä½¿applicationçš„çŠ¶æ€ç”±<em>ApplicationState.NEW</em>å˜ä¸º<em>ApplicationState.INITING</em>ï¼Œæœ€åè§¦å‘ApplicationEventType.INIT_CONTAINERäº‹ä»¶ç±»å‹ï¼Œæ›´æ–°containerçš„çŠ¶æ€ã€‚å¦‚æœä¸æ˜¯åˆ™ç›´æ¥è§¦å‘ApplicationEventType.INIT_CONTAINERäº‹ä»¶ç±»å‹ã€‚</p><p>ifè¯­å¥æ‰§è¡Œå®Œä¹‹åï¼Œapplicationçš„çŠ¶æ€ç”±NEWå˜ä¸ºäº†INITINGï¼Œæ­¤æ—¶å°†containerä¿¡æ¯å­˜å‚¨åœ¨contextä¸­ï¼Œå¹¶è§¦å‘ApplicationEventType.INIT_CONTAINERäº‹ä»¶ç±»å‹ï¼Œ<em>ç”±äºæ­¤æ—¶applicationçš„çŠ¶æ€æ˜¯INITINGï¼Œäº‹ä»¶ç±»å‹ä¸ºINIT_CONTAINERï¼Œåˆ™å¤„ç†æ¬¡äº‹ä»¶çš„handleræ˜¯<code>InitContainerTransition</code>ï¼Œéšåapplicationçš„çŠ¶æ€ä¾ç„¶æ˜¯INITING</em>ï¼Œçœ‹ä¸‹InitContainerTransition.transitionæ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(ApplicationImpl app, ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">  ApplicationContainerInitEvent initEvent =</span><br><span class="line">    (ApplicationContainerInitEvent) event;</span><br><span class="line">  Container container = initEvent.getContainer();</span><br><span class="line">  app.containers.put(container.getContainerId(), container);</span><br><span class="line">  LOG.info(<span class="string">&quot;Adding &quot;</span> + container.getContainerId()</span><br><span class="line">      + <span class="string">&quot; to application &quot;</span> + app.toString());</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">switch</span> (app.getApplicationState()) &#123;</span><br><span class="line">  <span class="keyword">case</span> RUNNING:</span><br><span class="line">    app.dispatcher.getEventHandler().handle(<span class="keyword">new</span> ContainerInitEvent(</span><br><span class="line">        container.getContainerId()));</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> INITING:</span><br><span class="line">  <span class="keyword">case</span> NEW:</span><br><span class="line">    <span class="comment">// these get queued up and sent out in AppInitDoneTransition</span></span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">assert</span> <span class="keyword">false</span> : <span class="string">&quot;Invalid state for InitContainerTransition: &quot;</span> +</span><br><span class="line">        app.getApplicationState();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœ‹ä»£ç å¯è§å½“applicationçš„çŠ¶æ€æ˜¯INITINGå’ŒNEWæ—¶ï¼Œè§¦å‘INIT_CNONTAINERæ–¹æ³•æ—¶ä¸è¿›è¡Œä»»ä½•æ“ä½œï¼Œåˆ™applicationçš„çŠ¶æ€ä¹Ÿä¸ä¼šå‘ç”Ÿå˜åŒ–ã€‚<em>åªæœ‰å½“applicationçš„çŠ¶æ€æ—¶RUNNINGæ—¶</em>ï¼Œæ‰ä¼šè§¦å‘ç”±<code>ContainerEventType.INIT_CONTAINER</code>äº‹ä»¶ç±»å‹è§¦å‘containerçš„çŠ¶æ€è½¬ç§»ã€‚</p><p>é‚£ä¹ˆä½•æ—¶applicationçš„çŠ¶æ€æ‰ä¼šå˜ä¸ºRUNNINGå‘¢ï¼Ÿæˆ‘ä»¬å›åˆ°åœ¨æ–°å»ºapplicationå¯¹è±¡æ—¶è§¦å‘çš„<code>ApplicationEventType.INIT_APPLICATION</code>äº‹ä»¶ç±»å‹ä¸Šï¼Œæ­¤æ—¶applicationåˆšè¢«newå‡ºæ¥ï¼Œåˆ™åˆå§‹çŠ¶æ€ä¸ŠNEWï¼Œåˆ™å¤„ç†è¯¥äº‹ä»¶ç±»å‹çš„handleræ˜¯<code>AppInitTransition</code>ï¼Œä¸‹é¢çœ‹ä¸‹<code>AppInitTransition.transition</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(ApplicationImpl app, ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">  ApplicationInitEvent initEvent = (ApplicationInitEvent)event;</span><br><span class="line">  ...</span><br><span class="line">  app.dispatcher.getEventHandler().handle(</span><br><span class="line">      <span class="keyword">new</span> LogHandlerAppStartedEvent(app.appId, app.user,</span><br><span class="line">          app.credentials, ContainerLogsRetentionPolicy.ALL_CONTAINERS,</span><br><span class="line">          app.applicationACLs, app.logAggregationContext)); </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥transtionä¸­æ˜¯ä¸€ä¸ªå¼‚æ­¥è°ƒåº¦å™¨ï¼Œå¤„ç†çš„äº‹ä»¶æ˜¯<code>LogHandlerAppStartedEvent</code>ï¼Œäº‹ä»¶ç±»å‹æ˜¯<code>LogHandlerEventType.APPLICATION_STARTED</code>ï¼Œæ­¤äº‹ä»¶ç±»å‹æ˜¯åœ¨<code>LogAggregationService</code>ä¸­å¤„ç†çš„ï¼Œçœ‹ä¸‹å¯¹åº”çš„handleæ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(LogHandlerEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> APPLICATION_STARTED:</span><br><span class="line">      LogHandlerAppStartedEvent appStartEvent =</span><br><span class="line">          (LogHandlerAppStartedEvent) event;</span><br><span class="line">      initApp(appStartEvent.getApplicationId(), appStartEvent.getUser(),</span><br><span class="line">          appStartEvent.getCredentials(),</span><br><span class="line">          appStartEvent.getLogRetentionPolicy(),</span><br><span class="line">          appStartEvent.getApplicationAcls(),</span><br><span class="line">          appStartEvent.getLogAggregationContext());</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CONTAINER_FINISHED:</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> APPLICATION_FINISHED:</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      ; <span class="comment">// Ignore</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LogAggregationServiceä»åå­—æ¥çœ‹ï¼Œåªè¦æ˜¯ç”¨æ¥è¿›è¡Œæ—¥å¿—èšåˆçš„ï¼Œå¤„ç†çš„äº‹ä»¶ç±»å‹æœ‰<code>APPLICATION_STARTED</code>ã€<code>CONTAINER_FINISHED</code>å’Œ<code>APPLICATION_FINISHED</code>ã€‚<br>APPLICATION_STARTEDäº‹ä»¶ç±»å‹ä¼šè°ƒç”¨<code>initApp</code>æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initApp</span><span class="params">(<span class="keyword">final</span> ApplicationId appId, String user,</span></span></span><br><span class="line"><span class="params"><span class="function">    Credentials credentials, ContainerLogsRetentionPolicy logRetentionPolicy,</span></span></span><br><span class="line"><span class="params"><span class="function">    Map&lt;ApplicationAccessType, String&gt; appAcls,</span></span></span><br><span class="line"><span class="params"><span class="function">    LogAggregationContext logAggregationContext)</span> </span>&#123;</span><br><span class="line">  ApplicationEvent eventResponse;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    verifyAndCreateRemoteLogDir(getConfig());</span><br><span class="line">    initAppAggregator(appId, user, credentials, logRetentionPolicy, appAcls,</span><br><span class="line">        logAggregationContext);</span><br><span class="line">    eventResponse = <span class="keyword">new</span> ApplicationEvent(appId,</span><br><span class="line">        ApplicationEventType.APPLICATION_LOG_HANDLING_INITED);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (YarnRuntimeException e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Application failed to init aggregation&quot;</span>, e);</span><br><span class="line">    eventResponse = <span class="keyword">new</span> ApplicationEvent(appId,</span><br><span class="line">        ApplicationEventType.APPLICATION_LOG_HANDLING_FAILED);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">this</span>.dispatcher.getEventHandler().handle(eventResponse);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>logDiråˆ›å»ºæˆåŠŸä¹‹åï¼Œä¼šè§¦å‘<code>ApplicationEventType.APPLICATION_LOG_HANDLING_INITED</code>äº‹ä»¶ç±»å‹ï¼Œæ­¤æ—¶applicationçš„çŠ¶æ€æ˜¯INITINGï¼Œåˆ™å¯¹åº”çš„handleræ˜¯<code>AppLogInitDoneTransition</code>ï¼Œçœ‹ä¸‹transitionæ–¹æ³•:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(ApplicationImpl app, ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">  app.dispatcher.getEventHandler().handle(</span><br><span class="line">      <span class="keyword">new</span> ApplicationLocalizationEvent(</span><br><span class="line">          LocalizationEventType.INIT_APPLICATION_RESOURCES, app));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“LogAggregationServiceä¸ºapplicationåˆ›å»ºäº†logDirå¹¶ä¸”å¯åŠ¨æ—¥å¿—èšåˆçº¿ç¨‹ä¹‹åï¼Œæ‰ä¼šé€šè¿‡AppLogInitDoneTransitionå¤„ç†APPLICATION_LOG_HANDLING_INITEDäº‹ä»¶ã€‚<br>åœ¨AppLogInitDoneTransitionä¸­è§¦å‘<code>LocalizationEventType.INIT_APPLICATION_RESOURCES</code>åœ¨ResourceLocalizationServiceä¸­è¢«æ•è·ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(LocalizationEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> create log dir as $logdir/$user/$appId</span></span><br><span class="line">  <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">  <span class="keyword">case</span> INIT_APPLICATION_RESOURCES:</span><br><span class="line">    handleInitApplicationResources(</span><br><span class="line">        ((ApplicationLocalizationEvent)event).getApplication());</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> INIT_CONTAINER_RESOURCES:</span><br><span class="line">    LOG.info(<span class="string">&quot;&#123;intellij&#125; ResourceLocalizationsService handle INIT_CONTAINER_RESOURCES&quot;</span>);</span><br><span class="line">    handleInitContainerResources((ContainerLocalizationRequestEvent) event);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CACHE_CLEANUP:</span><br><span class="line">    handleCacheCleanup(event);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> CLEANUP_CONTAINER_RESOURCES:</span><br><span class="line">    handleCleanupContainerResources((ContainerLocalizationCleanupEvent)event);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> DESTROY_APPLICATION_RESOURCES:</span><br><span class="line">    handleDestroyApplicationResources(</span><br><span class="line">        ((ApplicationLocalizationEvent)event).getApplication());</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(<span class="string">&quot;Unknown localization event: &quot;</span> + event);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handleä¸­å¤„ç†ä¸åŒçš„äº‹ä»¶ç±»å‹ï¼ŒINIT_APPLICATION_RESOURCESç”±<code>handleInitApplicationResources</code>å¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleInitApplicationResources</span><span class="params">(Application app)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// 0) Create application tracking structs</span></span><br><span class="line">  String userName = app.getUser();</span><br><span class="line">  privateRsrc.putIfAbsent(userName, <span class="keyword">new</span> LocalResourcesTrackerImpl(userName,</span><br><span class="line">      <span class="keyword">null</span>, dispatcher, <span class="keyword">true</span>, <span class="keyword">super</span>.getConfig(), stateStore));</span><br><span class="line">  String appIdStr = ConverterUtils.toString(app.getAppId());</span><br><span class="line">  appRsrc.putIfAbsent(appIdStr, <span class="keyword">new</span> LocalResourcesTrackerImpl(app.getUser(),</span><br><span class="line">      app.getAppId(), dispatcher, <span class="keyword">false</span>, <span class="keyword">super</span>.getConfig(), stateStore));</span><br><span class="line">  <span class="comment">// 1) Signal container init</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// This is handled by the ApplicationImpl state machine and allows</span></span><br><span class="line">  <span class="comment">// containers to proceed with launching.</span></span><br><span class="line">  dispatcher.getEventHandler().handle(<span class="keyword">new</span> ApplicationInitedEvent(</span><br><span class="line">        app.getAppId()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè§¦å‘<code>ApplicationEventType.APPLICATION_INITED</code>ï¼Œåœ¨applicationçš„çŠ¶æ€æœºä¸­å¤„ç†ï¼Œå¯¹åº”çš„handleræ˜¯<code>AppInitDoneTransition</code>ï¼Œå¤„ç†ä¹‹åapplicationçš„çŠ¶æ€ç”±INITINGè½¬åŒ–ä¸ºRUNNINGã€‚AppInitDoneTransition.transitionæ–¹æ³•å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">transition</span><span class="params">(ApplicationImpl app, ApplicationEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Start all the containers waiting for ApplicationInit</span></span><br><span class="line">  <span class="keyword">for</span> (Container container : app.containers.values()) &#123;</span><br><span class="line">    app.dispatcher.getEventHandler().handle(<span class="keyword">new</span> ContainerInitEvent(</span><br><span class="line">          container.getContainerId()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¼šè§¦å‘ContainerEventType.INIT_CONTAINERäº‹ä»¶ç±»å‹ï¼Œç”±æ­¤äº‹ä»¶ç±»å‹å¼€å¯containerçš„çŠ¶æ€è½¬ç§»ã€‚<br>åœ¨<code>startContainerInternal</code>ä¸­æ–°å»ºäº†ä¸€ä¸ªcontainerï¼Œåˆå§‹åŒ–çŠ¶æ€ä¸ºNEWã€‚æ­¤æ—¶å½“<code>ApplicationEventType.APPLICATION_INITED</code>è§¦å‘ä¹‹åï¼Œå¯¹åº”çš„handlerä¼šè§¦å‘<code>ContainerEventType.INIT_CONTAINER</code>ï¼Œcontainerå¼€å§‹çŠ¶æ€çš„è½¬åŒ–ï¼Œå¯¹åº”çš„handleræ˜¯<code>RequestResourcesTransition</code>ï¼Œçœ‹ä¸‹transtionçš„ä»£ç :</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ContainerState <span class="title">transition</span><span class="params">(ContainerImpl container,</span></span></span><br><span class="line"><span class="params"><span class="function">    ContainerEvent event)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">final</span> ContainerLaunchContext ctxt = container.launchContext;</span><br><span class="line">  container.metrics.initingContainer();</span><br><span class="line"></span><br><span class="line">  container.dispatcher.getEventHandler().handle(<span class="keyword">new</span> AuxServicesEvent</span><br><span class="line">      (AuxServicesEventType.CONTAINER_INIT, container));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Inform the AuxServices about the opaque serviceData</span></span><br><span class="line">  Map&lt;String,ByteBuffer&gt; csd = ctxt.getServiceData();</span><br><span class="line">  <span class="keyword">if</span> (csd != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// This can happen more than once per Application as each container may</span></span><br><span class="line">    <span class="comment">// have distinct service data</span></span><br><span class="line">    <span class="keyword">for</span> (Map.Entry&lt;String,ByteBuffer&gt; service : csd.entrySet()) &#123;</span><br><span class="line">      container.dispatcher.getEventHandler().handle(</span><br><span class="line">          <span class="keyword">new</span> AuxServicesEvent(AuxServicesEventType.APPLICATION_INIT,</span><br><span class="line">              container.user, container.containerId</span><br><span class="line">                  .getApplicationAttemptId().getApplicationId(),</span><br><span class="line">              service.getKey().toString(), service.getValue()));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Send requests for public, private resources</span></span><br><span class="line">  <span class="comment">// ä¸ºpublicå’Œprivateèµ„æºå‘é€è¿œç¨‹è¯·æ±‚ï¼Œè¿™é‡Œçš„è¯·æ±‚åè®®æ˜¯yarn_protos.ContainerLaunchContextProto</span></span><br><span class="line">  Map&lt;String,LocalResource&gt; cntrRsrc = ctxt.getLocalResources();</span><br><span class="line">  <span class="keyword">if</span> (!cntrRsrc.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">for</span> (Map.Entry&lt;String,LocalResource&gt; rsrc : cntrRsrc.entrySet()) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          LocalResourceRequest req =</span><br><span class="line">              <span class="keyword">new</span> LocalResourceRequest(rsrc.getValue());</span><br><span class="line">          List&lt;String&gt; links = container.pendingResources.get(req);</span><br><span class="line">          <span class="keyword">if</span> (links == <span class="keyword">null</span>) &#123;</span><br><span class="line">            links = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">            container.pendingResources.put(req, links);</span><br><span class="line">          &#125;</span><br><span class="line">          links.add(rsrc.getKey());</span><br><span class="line">          <span class="keyword">switch</span> (rsrc.getValue().getVisibility()) &#123;</span><br><span class="line">          <span class="keyword">case</span> PUBLIC:</span><br><span class="line">            container.publicRsrcs.add(req);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> PRIVATE:</span><br><span class="line">            container.privateRsrcs.add(req);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> APPLICATION:</span><br><span class="line">            container.appRsrcs.add(req);</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">          LOG.info(<span class="string">&quot;Got exception parsing &quot;</span> + rsrc.getKey()</span><br><span class="line">              + <span class="string">&quot; and value &quot;</span> + rsrc.getValue());</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (URISyntaxException e) &#123;</span><br><span class="line">      <span class="comment">// malformed resource; abort container launch</span></span><br><span class="line">      LOG.warn(<span class="string">&quot;Failed to parse resource-request&quot;</span>, e);</span><br><span class="line">      container.cleanup();</span><br><span class="line">      container.metrics.endInitingContainer();</span><br><span class="line">      <span class="keyword">return</span> ContainerState.LOCALIZATION_FAILED;</span><br><span class="line">    &#125;</span><br><span class="line">    Map&lt;LocalResourceVisibility, Collection&lt;LocalResourceRequest&gt;&gt; req =</span><br><span class="line">        <span class="keyword">new</span> HashMap&lt;LocalResourceVisibility, </span><br><span class="line">                    Collection&lt;LocalResourceRequest&gt;&gt;();</span><br><span class="line">    <span class="keyword">if</span> (!container.publicRsrcs.isEmpty()) &#123;</span><br><span class="line">      req.put(LocalResourceVisibility.PUBLIC, container.publicRsrcs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!container.privateRsrcs.isEmpty()) &#123;</span><br><span class="line">      req.put(LocalResourceVisibility.PRIVATE, container.privateRsrcs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!container.appRsrcs.isEmpty()) &#123;</span><br><span class="line">      req.put(LocalResourceVisibility.APPLICATION, container.appRsrcs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">&quot;&#123;intellij&#125; ContainerImpl new to localizing handle&quot;</span>);</span><br><span class="line">    container.dispatcher.getEventHandler().handle(</span><br><span class="line">          <span class="keyword">new</span> ContainerLocalizationRequestEvent(container, req));</span><br><span class="line">    <span class="keyword">return</span> ContainerState.LOCALIZING;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    container.sendLaunchEvent();</span><br><span class="line">    container.metrics.endInitingContainer();</span><br><span class="line">    <span class="keyword">return</span> ContainerState.LOCALIZED;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»è¯¥handlerçš„åå­—ä¸Šå¯ä»¥çœ‹å‡ºå…¶ä¸»è¦ä½œç”¨æ˜¯è¯·æ±‚containerçš„resourcesï¼Œæ–¹æ³•ä¸­ä¼šåˆ¤æ–­è¯¥containeræ˜¯å¦éœ€è¦è¯·æ±‚resourcesï¼Œ</p><ul><li>å¦‚æœéœ€è¦åˆ™å°†èµ„æºè¿›è¡Œæœ¬åœ°åŒ–ï¼Œè§¦å‘<code>LocalizationEventType.INIT_CONTAINER_RESOURCES</code>ï¼Œè¿”å›<code>ContainerState.LOCALIZING</code>ï¼Œä½¿<em>containerç”±NEWè½¬æ¢ä¸ºLOCALIZINGçŠ¶æ€</em>ã€‚è€ŒLocalizationEventType.INIT_CONTAINER_RESOURCESè¢«<code>ResourceLocalizationService</code>è¿›è¡Œæ•è·ï¼Œå¼€å§‹Resourceçš„æœ¬åœ°åŒ–ã€‚</li><li>å¦‚æœä¸éœ€è¦åˆ™å‘é€<code>LAUNCH_CONTAINER</code>äº‹ä»¶ï¼Œè¿”å›<code>ContainerState.LOCALIZED</code>ï¼Œä½¿<em>containerä»NEWç›´æ¥è½¬åŒ–ä¸ºLOCALIZED</em>ã€‚</li></ul><p>è¿™é‡Œæˆ‘ä»¬è·Ÿä¸‹ä¸éœ€è¦è¯·æ±‚resourcesçš„æƒ…å†µï¼Œè°ƒç”¨<code>sendLaunchEvent</code>å‘é€<code>ContainersLauncherEventType.LAUNCH_CONTAINER</code>äº‹ä»¶ç±»å‹ï¼Œç”±<code>ContainersLauncher</code>æ•è·ã€‚å…¶handleæ–¹æ³•å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(ContainersLauncherEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> ContainersLauncher launches containers one by one!!</span></span><br><span class="line">  Container container = event.getContainer();</span><br><span class="line">  ContainerId containerId = container.getContainerId();</span><br><span class="line">  <span class="keyword">switch</span> (event.getType()) &#123;</span><br><span class="line">    <span class="keyword">case</span> LAUNCH_CONTAINER:</span><br><span class="line">      Application app =</span><br><span class="line">        context.getApplications().get(</span><br><span class="line">            containerId.getApplicationAttemptId().getApplicationId());</span><br><span class="line">      <span class="comment">// æ–°å»ºä¸€ä¸ªContainerLaunchçº¿ç¨‹ï¼Œç„¶åæ”¾å…¥çº¿ç¨‹æ± containerLauncherä¸­æ‰§è¡Œ</span></span><br><span class="line">      ContainerLaunch launch =</span><br><span class="line">          <span class="keyword">new</span> ContainerLaunch(context, getConfig(), dispatcher, exec, app,</span><br><span class="line">            event.getContainer(), dirsHandler, containerManager);</span><br><span class="line">      containerLauncher.submit(launch);</span><br><span class="line">      running.put(containerId, launch);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> RECOVER_CONTAINER:</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> CLEANUP_CONTAINER:</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ContainerLaunchçº¿ç¨‹æäº¤åˆ°containerLauncherçº¿ç¨‹æ± ä¹‹åå¼€å§‹æ‰§è¡Œæ­¤çº¿ç¨‹ã€‚ContainerLaunchå®ç°äº†Callableæ¥å£ï¼Œåˆ™çº¿ç¨‹çš„æ‰§è¡Œé€»è¾‘åœ¨callæ–¹æ³•ä¸­ï¼Œå¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Integer <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// LaunchContainer is a blocking call. We are here almost means the</span></span><br><span class="line">    <span class="comment">// container is launched, so send out the event.</span></span><br><span class="line">    <span class="comment">// å¤„ç†ContainerEventType.CONTAINER_LAUNCHEDï¼Œä½¿containerç”±LOCALIZEDå˜ä¸ºRUNNING</span></span><br><span class="line">    <span class="comment">// å¹¶å¼€å§‹ç›‘æ§è¿™ä¸ªcontainerä½¿ç”¨çš„å†…å­˜(ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜)</span></span><br><span class="line">    dispatcher.getEventHandler().handle(<span class="keyword">new</span> ContainerEvent(</span><br><span class="line">          containerID,</span><br><span class="line">          ContainerEventType.CONTAINER_LAUNCHED));</span><br><span class="line">    context.getNMStateStore().storeContainerLaunched(containerID);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if the container is signalled to be killed.</span></span><br><span class="line">    <span class="keyword">if</span> (!shouldLaunchContainer.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">      LOG.info(<span class="string">&quot;Container &quot;</span> + containerIdStr + <span class="string">&quot; not launched as &quot;</span></span><br><span class="line">          + <span class="string">&quot;cleanup already called&quot;</span>);</span><br><span class="line">      ret = ExitCode.TERMINATED.getExitCode();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">      exec.activateContainer(containerID, pidFilePath);</span><br><span class="line">      <span class="comment">// æ‰§è¡Œå¯åŠ¨containerçš„è„šæœ¬</span></span><br><span class="line">      ret = exec.launchContainer(container, nmPrivateContainerScriptPath,</span><br><span class="line">              nmPrivateTokensPath, user, appIdStr, containerWorkDir,</span><br><span class="line">              localDirs, logDirs);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Failed to launch container.&quot;</span>, e);</span><br><span class="line">    dispatcher.getEventHandler().handle(<span class="keyword">new</span> ContainerExitEvent(</span><br><span class="line">        containerID, ContainerEventType.CONTAINER_EXITED_WITH_FAILURE, ret,</span><br><span class="line">        e.getMessage()));</span><br><span class="line">    <span class="keyword">return</span> ret;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    completed.set(<span class="keyword">true</span>);</span><br><span class="line">    exec.deactivateContainer(containerID);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      context.getNMStateStore().storeContainerCompleted(containerID, ret);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Unable to set exit code for container &quot;</span> + containerID);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  dispatcher.getEventHandler().handle(</span><br><span class="line">      <span class="keyword">new</span> ContainerEvent(containerID,</span><br><span class="line">          ContainerEventType.CONTAINER_EXITED_WITH_SUCCESS));</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ContainerLaunchå°†containerè¿è¡Œç¯å¢ƒå‡†å¤‡å¥½ä¹‹åï¼Œè§¦å‘<code>ContainerEventType.CONTAINER_LAUNCHED</code>äº‹ä»¶ç±»å‹ï¼ŒLaunchTransitionæ•è·ä¹‹åï¼Œ*<em>è§¦å‘ç›‘æ§containerçš„äº‹ä»¶(ç›‘æ§containeræ‰€éœ€çš„ç‰©ç†å†…å­˜å’Œè™šæ‹Ÿå†…å­˜)*<em>ï¼Œä½¿containerç”±LOCALIZEDå˜ä¸ºRUNNINGã€‚<br>è§¦å‘ContainerEventType.CONTAINER_LAUNCHEDäº‹ä»¶ç±»å‹ä¹‹åï¼Œç»§ç»­æ‰§è¡Œï¼Œè°ƒç”¨<code>exec.launchContainer</code>å¯åŠ¨containerï¼Œ</em>è¯¥æ–¹æ³•åœ¨containeræ‰§è¡Œå®Œæ¯•ä¹‹åæ‰ä¼šè¿”å›*ã€‚å¦‚æœæ­£å¸¸ç»“æŸretä¸º0ï¼Œè§¦å‘<code>ContainerEventType.CONTAINER_EXITED_WITH_SUCCESS</code>äº‹ä»¶ç±»å‹ï¼Œ</em>ä½¿containerç”±RUNNINGå˜ä¸ºEXITED_WITH_SUCCESS*ã€‚</p><p>è¿™é‡Œexec.launchContainerçš„å®ç°æ˜¯<code>DefaultContainerExecutor.launchContainer</code>ï¼Œåœ¨launchContaineræ–¹æ³•ä¸­ä¼šæ‰§è¡Œ<code>bash default_container_executor.sh</code>å‘½ä»¤ï¼Œdefault_container_executor.shè„šæœ¬çš„å†…å®¹æ˜¯:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">/bin/bash <span class="string">&quot;/xx/usercache/user/appcache/application_1499422474367_0001/container_1499422474367_0001_01_000001/default_container_executor_session.sh&quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è°ƒç”¨äº†default_container_executor_session.shè„šæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">...</span><br><span class="line"><span class="built_in">exec</span> /bin/bash <span class="string">&quot;/xx/usercache/user/appcache/application_1499422474367_0001/container_1499422474367_0001_01_000001/launch_container.sh&quot;</span></span><br></pre></td></tr></table></figure><p>æœ€åè°ƒç”¨äº†launch_container.shè„šæœ¬ï¼Œå†…å®¹å¦‚ä¸‹:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="built_in">exec</span> /bin/bash -c <span class="string">&quot;<span class="variable">$JAVA_HOME</span>/bin/java -Dlog4j.configuration=container-log4j.properties -Dyarn.app.container.log.dir=/xx/application_1499422474367_0001/container_1499422474367_0001_01_000001 -Dyarn.app.container.log.filesize=0 -Dhadoop.root.logger=INFO,CLA  -Xmx1024m org.apache.hadoop.mapreduce.v2.app.MRAppMaster 1&gt;/xx/application_1499422474367_0001/container_1499422474367_0001_01_000001/stdout 2&gt;/xx/application_1499422474367_0001/container_1499422474367_0001_01_000001/stderr &quot;</span></span><br><span class="line">...</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªcontaineræ˜¯appmasterï¼Œæ‰€ä»¥è¿™é‡Œè°ƒç”¨çš„æ˜¯<code>MRAppMaster</code>ï¼Œå¹¶å°†æ ‡å‡†è¾“å‡ºå†™åˆ°stdoutä¸­ï¼Œå°†æ ‡å‡†é”™è¯¯è¾“å‡ºå†™åˆ°stderrä¸­ã€‚è¿™ä¹Ÿå°±æ˜¯containerçš„logç›®å½•é‡Œæœ‰ä¸‰ä¸ªæ–‡ä»¶çš„åŸå› ã€‚</p><p>è‡³æ­¤ï¼ŒAppMasterå¯åŠ¨å®Œæ¯•ï¼Œè¿‡ç¨‹æ¯”è¾ƒç¹çï¼Œä¸‹é¢é™„ä¸Šä¸€å¼ å›¾ã€‚éšåä»‹ç»ä¸‹MRAppMasterçš„è¿è¡Œè¿‡ç¨‹ã€‚<br><img src="/blogimgs/appmaster/appMaster.png" alt="AppMasterå¯åŠ¨æµç¨‹" title="AppMasterå¯åŠ¨æµç¨‹"></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> ApplicationMaster </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹ApplicationMasteråˆ†é…ç­–ç•¥</title>
      <link href="/YARNSrcAMAssignPolicy.html"/>
      <url>/YARNSrcAMAssignPolicy.html</url>
      
        <content type="html"><![CDATA[<p>ä¸€æ¬¡å’Œæœ‹å‹çš„è°ˆè¯ä¸­æ¶‰åŠåˆ°ApplicationMasterçš„containeråˆ†é…ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Œæˆ‘æ˜ åƒä¸­æ˜¯éšæœºåˆ†é…çš„ï¼Œä½†ä»–è¯´æ˜¯æ ¹æ®å„èŠ‚ç‚¹ç©ºé—²èµ„æºæ¥åˆ†é…çš„ã€‚<br>ä¹‹å‰çœ‹ä»£ç çš„æ—¶å€™ä¹Ÿæ²¡æ³¨æ„è¿™å—çš„é€»è¾‘ï¼Œæ—¢ç„¶ç°åœ¨æœ‰äº†ç–‘æƒ‘é‚£å°±å»ä»£ç é‡Œç…ç…ã€‚</p><span id="more"></span><p>ä»MRçš„è¿è¡Œlogä¸­å¯ä»¥æ‰¾åˆ°AMçš„containeræ˜¯åœ¨ä»€ä¹ˆæ—¶å€™åˆ†é…çš„ï¼Œè§log</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">2017-04-09 03:26:17,113 INFO org.apache.hadoop.yarn.server.resourcemanager.rmapp.attempt.RMAppAttemptImpl: appattempt_1491729774382_0001_000001 State change from SUBMITTED to SCHEDULED</span><br><span class="line">2017-04-09 03:26:17,415 INFO org.apache.hadoop.yarn.server.resourcemanager.rmcontainer.RMContainerImpl: container_1491729774382_0001_01_000001 Container Transitioned from NEW to ALLOCATED</span><br></pre></td></tr></table></figure><p>AM containeræ˜¯åœ¨appattemptçš„çŠ¶æ€ç”±<code>SUBMITTED</code>å˜ä¸º<code>SCHEDULED</code>æ—¶åˆå§‹åŒ–çš„ã€‚<br>appattemptç”±<code>SUBMITTED</code>å˜ä¸º<code>SCHEDULED</code>çŠ¶æ€çš„å¤„ç†é€»è¾‘ä¸º:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ScheduleTransition</span></span></span><br><span class="line"><span class="class">    <span class="keyword">implements</span></span></span><br><span class="line"><span class="class">    <span class="title">MultipleArcTransition</span>&lt;<span class="title">RMAppAttemptImpl</span>, <span class="title">RMAppAttemptEvent</span>, <span class="title">RMAppAttemptState</span>&gt; </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> RMAppAttemptState <span class="title">transition</span><span class="params">(RMAppAttemptImpl appAttempt,</span></span></span><br><span class="line"><span class="params"><span class="function">      RMAppAttemptEvent event)</span> </span>&#123;</span><br><span class="line">    ApplicationSubmissionContext subCtx = appAttempt.submissionContext;</span><br><span class="line">    <span class="keyword">if</span> (!subCtx.getUnmanagedAM()) &#123;</span><br><span class="line">      <span class="comment">// Need reset #containers before create new attempt, because this request</span></span><br><span class="line">      <span class="comment">// will be passed to scheduler, and scheduler will deduct the number after</span></span><br><span class="line">      <span class="comment">// AM container allocated</span></span><br><span class="line">      <span class="comment">// è®¾ç½®am containerçš„è¯·æ±‚</span></span><br><span class="line">      appAttempt.amReq.setNumContainers(<span class="number">1</span>);</span><br><span class="line">      appAttempt.amReq.setPriority(AM_CONTAINER_PRIORITY);</span><br><span class="line">      <span class="comment">// ResourceNameä¸ºANYè¡¨ç¤ºä»»ä½•æœºæ¶ä¸Šçš„ä»»ä¸€æœºå™¨</span></span><br><span class="line">      appAttempt.amReq.setResourceName(ResourceRequest.ANY);</span><br><span class="line">      appAttempt.amReq.setRelaxLocality(<span class="keyword">true</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// ç”±è°ƒåº¦å™¨æ¥åˆ†é…èµ„æº</span></span><br><span class="line">      Allocation amContainerAllocation =</span><br><span class="line">          appAttempt.scheduler.allocate(appAttempt.applicationAttemptId,</span><br><span class="line">              Collections.singletonList(appAttempt.amReq),</span><br><span class="line">              EMPTY_CONTAINER_RELEASE_LIST, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">return</span> RMAppAttemptState.SCHEDULED;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä¸ºAM containeræ„é€ containerè¯·æ±‚ï¼Œå…¶å®ä»<code>appAttempt.amReq.setResourceName(ResourceRequest.ANY)</code>å°±å¯ä»¥çœ‹å‡ºam containerçš„åˆ†é…åŸåˆ™æ˜¯éšæœºçš„ï¼Œå› ä¸ºåœ¨åˆ›å»ºè¯·æ±‚æ—¶å¯¹ResourceNameå¹¶æ²¡æœ‰è¦æ±‚ã€‚ä½†æˆ‘ä»¬è¿˜æ˜¯ç»§ç»­çœ‹ä¸‹ä»£ç ä»¥éªŒè¯ä¸‹ã€‚<br>è¯·æ±‚åˆ›å»ºæˆåŠŸä¹‹åï¼Œç”±è°ƒåº¦å™¨æ¥åˆ†é…èµ„æºï¼Œè¿™é‡Œé»˜è®¤ä½¿ç”¨çš„æ˜¯Capacityè°ƒåº¦ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CapacityScheduler.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Allocation <span class="title">allocate</span><span class="params">(ApplicationAttemptId applicationAttemptId,</span></span></span><br><span class="line"><span class="params"><span class="function">    List&lt;ResourceRequest&gt; ask, List&lt;ContainerId&gt; release, </span></span></span><br><span class="line"><span class="params"><span class="function">    List&lt;String&gt; blacklistAdditions, List&lt;String&gt; blacklistRemovals)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  FiCaSchedulerApp application = getApplicationAttempt(applicationAttemptId);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Release containers</span></span><br><span class="line">  releaseContainers(release, application);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (application) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">if</span> (!ask.isEmpty()) &#123;</span><br><span class="line">      ...</span><br><span class="line">      application.showRequests();</span><br><span class="line">      <span class="comment">// å°†è¯·æ±‚è¯¥application attemptçš„mapä¸­</span></span><br><span class="line">      <span class="comment">// Update application requests</span></span><br><span class="line">      application.updateResourceRequests(ask);</span><br><span class="line">      application.showRequests();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    application.updateBlacklist(blacklistAdditions, blacklistRemovals);</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">return</span> application.getAllocation(getResourceCalculator(),</span><br><span class="line">                 clusterResource, getMinimumResourceCapability());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>CapacityScheduleråˆ†é…è¯·æ±‚æ—¶ï¼Œè°ƒç”¨<code>application.updateResourceRequests(ask)</code>å°†è¯·æ±‚æ”¾å…¥mapä¸­ï¼Œç­‰å¾…nmå¿ƒè·³æ—¶æ¥å–ã€‚<br>è¿™ä¸ªapplicationæ˜¯<code>FiCaSchedulerApp</code>çš„å¯¹è±¡ï¼ŒFiCaSchedulerAppå…¶å®å¯¹åº”çš„æ˜¯application attemptã€‚updateResurceRequestsä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">updateResourceRequests</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    List&lt;ResourceRequest&gt; requests)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!isStopped) &#123;</span><br><span class="line">  <span class="comment">// AppSchedulingInfo.updateResourceRequests</span></span><br><span class="line">    appSchedulingInfo.updateResourceRequests(requests, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>AppSchedulingInfoè®°å½•äº†applicationçš„æ‰€æœ‰æ¶ˆè´¹æƒ…å†µï¼Œå½“ç„¶ä¹ŸåŒ…æ‹¬<strong>è¿™ä¸ªapplication</strong>æ­£åœ¨è¿è¡Œæˆ–è€…å·²ç»å®Œæˆçš„containerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">updateResourceRequests</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    List&lt;ResourceRequest&gt; requests, <span class="keyword">boolean</span> recoverPreemptedRequest)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Update resource requests</span></span><br><span class="line">  <span class="keyword">for</span> (ResourceRequest request : requests) &#123;</span><br><span class="line">    Priority priority = request.getPriority();</span><br><span class="line">    String resourceName = request.getResourceName();</span><br><span class="line">    <span class="keyword">boolean</span> updatePendingResources = <span class="keyword">false</span>;</span><br><span class="line">    ResourceRequest lastRequest = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœrequestçš„ResourceNameæ˜¯ResourceRequest.ANY</span></span><br><span class="line">    <span class="comment">// åªæœ‰am containeræ˜¯ANYï¼Ÿï¼Ÿï¼Ÿä¸åº”è¯¥å§</span></span><br><span class="line">    <span class="keyword">if</span> (resourceName.equals(ResourceRequest.ANY)) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// ResourceRequest.ANYæ‰ç½®ä¸ºtrueï¼Ÿï¼Ÿ</span></span><br><span class="line">      updatePendingResources = <span class="keyword">true</span>;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Premature optimization?</span></span><br><span class="line">      <span class="comment">// Assumes that we won&#x27;t see more than one priority request updated</span></span><br><span class="line">      <span class="comment">// in one call, reasonable assumption... however, it&#x27;s totally safe</span></span><br><span class="line">      <span class="comment">// to activate same application more than once.</span></span><br><span class="line">      <span class="comment">// Thus we don&#x27;t need another loop ala the one in decrementOutstanding()  </span></span><br><span class="line">      <span class="comment">// which is needed during deactivate.</span></span><br><span class="line">      <span class="keyword">if</span> (request.getNumContainers() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        activeUsersManager.activateApplication(user, applicationId);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// requestsæ˜¯ä¸€ä¸ªè¯·æ±‚åˆ—è¡¨ map</span></span><br><span class="line">    <span class="comment">// æŸ¥çœ‹requestsä¸­æ˜¯å¦å·²æœ‰è¯¥ä¼˜å…ˆçº§çš„è¯·æ±‚</span></span><br><span class="line">    <span class="comment">// this.requestsä¸­å­˜æ”¾çš„æ˜¯è¿™ä¸ªapplicationçš„request</span></span><br><span class="line">    Map&lt;String, ResourceRequest&gt; asks = <span class="keyword">this</span>.requests.get(priority);</span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ­¤ä¼˜å…ˆçº§çš„è¯·æ±‚ï¼Œåˆ™newä¸€ä¸ªmap</span></span><br><span class="line">    <span class="keyword">if</span> (asks == <span class="keyword">null</span>) &#123;</span><br><span class="line">      asks = <span class="keyword">new</span> HashMap&lt;String, ResourceRequest&gt;();</span><br><span class="line">      <span class="keyword">this</span>.requests.put(priority, asks);</span><br><span class="line">      <span class="keyword">this</span>.priorities.add(priority);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// asksä¸ä¸ºnullï¼ŒæŸ¥çœ‹asksä¸­æ˜¯å¦æœ‰ä¸æ­¤è¯·æ±‚ResourceNameä¸€æ ·çš„è¯·æ±‚</span></span><br><span class="line">    lastRequest = asks.get(resourceName);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (recoverPreemptedRequest &amp;&amp; lastRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// Increment the number of containers to 1, as it is recovering a</span></span><br><span class="line">      <span class="comment">// single container.</span></span><br><span class="line">      request.setNumContainers(lastRequest.getNumContainers() + <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŠŠåŸæ¥çš„è¯·æ±‚æ‹¿å‡ºèµ‹å€¼ç»™lastRequestï¼Œ</span></span><br><span class="line">    <span class="comment">// ç„¶åå°†æ–°çš„requestå°†å…¥asksä¸­ï¼ŒlastRequestæ€ä¹ˆåŠï¼Ÿåœ¨å“ªå¤„ç†çš„ï¼Ÿ</span></span><br><span class="line">    asks.put(resourceName, request);</span><br><span class="line">    <span class="keyword">if</span> (updatePendingResources) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Similarly, deactivate application?</span></span><br><span class="line">      <span class="keyword">if</span> (request.getNumContainers() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;checking for deactivate... &quot;</span>);</span><br><span class="line">        checkForDeactivation();</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">int</span> lastRequestContainers = lastRequest != <span class="keyword">null</span> ? lastRequest</span><br><span class="line">          .getNumContainers() : <span class="number">0</span>;</span><br><span class="line">      Resource lastRequestCapability = lastRequest != <span class="keyword">null</span> ? lastRequest</span><br><span class="line">          .getCapability() : Resources.none();</span><br><span class="line">      metrics.incrPendingResources(user, request.getNumContainers(),</span><br><span class="line">          request.getCapability());</span><br><span class="line">      metrics.decrPendingResources(user, lastRequestContainers,</span><br><span class="line">          lastRequestCapability);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>updateResourceRequestsä¸»è¦æ˜¯å°†è¯·æ±‚æ”¾å…¥<code>requests</code>ä¸­ï¼Œç­‰å¾…nmå¿ƒè·³æ¥å–ã€‚ä¸è¿‡è¿™é‡Œæœ‰ç‚¹æ¨¡ç³Šï¼Œåœ¨æ›´æ–°requestsä¹‹å‰ï¼Œå¦‚æœå­˜åœ¨è¯¥ResourceNameçš„è¯·æ±‚åˆ™å–å‡ºï¼Œèµ‹å€¼ç»™<code>lastRequest</code>ï¼Œç„¶åè¿™ä¸ªlastRequestæ˜¯æ€ä¹ˆå¤„ç†çš„å‘¢ï¼Ÿä¸çŸ¥é“æ€ä¹ˆå›äº‹ï¼Œæ ‡æ³¨ä¸‹ã€‚</p><!-- priorityå¯¹åº”çš„valueä¹Ÿæ˜¯ä¸€ä¸ªmapï¼Œæ˜¯ResourceNameå’ŒResourceRequestçš„key valueå¯¹ --><p>æ›´æ–°å®Œrequestsä¹‹åï¼Œå›åˆ°<code>CapacityScheduler.allocate</code>ä¸­ç»§ç»­æ‰§è¡Œï¼Œreturnæ—¶æ‰§è¡Œ<code>application.getAllocation</code>è¿”å›ä¸€ä¸ªAllocationå¯¹è±¡ï¼Œè¿™é‡Œä¼šç»™containeråˆ›å»ºTOKENï¼Œè¿™é‡Œåˆ›å»ºTOKENçš„containeræ˜¯å·²ç»åˆ†é…ç»™nmçš„ï¼Œä¹Ÿå°±æ˜¯å·²ç»å®ä¾‹åŒ–çš„RMContainerï¼Œ<em>æ˜¯ä¸æ˜¯è¯´è°ƒåº¦å™¨åœ¨è°ƒåº¦containeræ—¶ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªè¯·æ±‚ï¼Œç„¶åä»<code>newlyAllocatedContainers</code>åˆ—è¡¨ä¸­å–å‡ºä¸Šæ¬¡è¯·æ±‚containerçš„å“åº”ç»“æœ</em>ï¼Ÿ</p><hr><p>am containerçš„è¯·æ±‚åˆ›å»ºå¥½ä¹‹åï¼Œç­‰å¾…nmå¿ƒè·³æ¥å–</p><p>æŸä¸ªnmå‘é€æ¥äº†å¿ƒè·³ï¼Œ<br>ä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// CapacityScheduler.handle  NODE_UPDATEäº‹ä»¶</span></span><br><span class="line"><span class="keyword">case</span> NODE_UPDATE:</span><br><span class="line">&#123;</span><br><span class="line">  NodeUpdateSchedulerEvent nodeUpdatedEvent = (NodeUpdateSchedulerEvent)event;</span><br><span class="line">  RMNode node = nodeUpdatedEvent.getRMNode();</span><br><span class="line">  <span class="comment">// æ›´æ–°è¯¥èŠ‚ç‚¹ä¸Šçš„containerçš„ä¿¡æ¯</span></span><br><span class="line">  <span class="comment">// å¯¹åˆšåˆ†é…åˆ°è¯¥èŠ‚ç‚¹çš„containerè¿›è¡Œlaunchï¼Œå·²ç»å®Œæˆçš„containerè¿›è¡ŒçŠ¶æ€è½¬ç§»</span></span><br><span class="line">  nodeUpdate(node);</span><br><span class="line">  <span class="keyword">if</span> (!scheduleAsynchronously) &#123;</span><br><span class="line">  <span class="comment">// è¯¥èŠ‚ç‚¹å–containerè¯·æ±‚</span></span><br><span class="line">    allocateContainersToNode(getNode(node.getNodeID()));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nmä¸CapacitySchedulerå¿ƒè·³ä¹‹åï¼Œé€šè¿‡<code>nodeUpdate(node)</code>å¯¹æ”¹èŠ‚ç‚¹ä¸Šå·²æœ‰çš„containerè¿›è¡ŒçŠ¶æ€æ›´æ–°ï¼Œç„¶åè°ƒç”¨<code>allocateContainersToNode</code>å»æ‹‰å–æ–°çš„containerè¯·æ±‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">allocateContainersToNode</span><span class="params">(FiCaSchedulerNode node)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Assign new containers...</span></span><br><span class="line">  <span class="comment">// 1. Check for reserved applications</span></span><br><span class="line">  <span class="comment">// 2. Schedule if there are no reservations</span></span><br><span class="line">  <span class="comment">// å¦‚æœæœ‰é¢„ç•™containerçš„è¯å…ˆåˆ†é…é¢„ç•™çš„container</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Try to schedule more if there are no reservations to fulfill</span></span><br><span class="line">  <span class="keyword">if</span> (node.getReservedContainer() == <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// è®¡ç®—nmä¸Šæ˜¯å¦è¿˜æœ‰ç©ºé—²çš„èµ„æºè¿›è¡Œåˆ†é…container</span></span><br><span class="line">    <span class="keyword">if</span> (calculator.computeAvailableContainers(node.getAvailableResource(),</span><br><span class="line">      minimumAllocation) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Trying to schedule on node: &quot;</span> + node.getNodeName() +</span><br><span class="line">            <span class="string">&quot;, available: &quot;</span> + node.getAvailableResource());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åˆ†é…container</span></span><br><span class="line">      root.assignContainers(clusterResource, node, <span class="keyword">false</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Skipping scheduling since node &quot;</span> + node.getNodeID() + </span><br><span class="line">        <span class="string">&quot; is reserved by application &quot;</span> + </span><br><span class="line">        node.getReservedContainer().getContainerId().getApplicationAttemptId()</span><br><span class="line">        );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒåº¦å™¨ç»™è¿™å°nmè°ƒåº¦containeræ—¶ï¼Œå…ˆåˆ¤æ–­è¿™å°nmä¸Šæ˜¯å¦æœ‰é¢„ç•™çš„containerï¼Œå¦‚æœæœ‰å…ˆå¯¹é¢„ç•™çš„containerè¿›è¡Œåˆ†é…ï¼Œå¦‚æœæ²¡æœ‰é¢„ç•™çš„containeræ‰è°ƒç”¨<code>root.assignContainers</code>è¿›è¡Œè°ƒåº¦ã€‚<br>rootæ˜¯<code>CSQueue</code>å¯¹è±¡ï¼ŒCSQueueæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒæŠ½è±¡ç±»AbstractCSQueueå®ç°äº†è¯¥æ¥å£ï¼Œè€ŒAbstractCSQueueåˆè¢«ParentQueueå’ŒChildQueueç»§æ‰¿ï¼Œè¿™é‡Œè°ƒç”¨çš„æ˜¯ParentQueueçš„assignContainersï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> CSAssignment <span class="title">assignContainers</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Resource clusterResource, FiCaSchedulerNode node, <span class="keyword">boolean</span> needToUnreserve)</span> </span>&#123;</span><br><span class="line">  CSAssignment assignment = </span><br><span class="line">      <span class="keyword">new</span> CSAssignment(Resources.createResource(<span class="number">0</span>, <span class="number">0</span>), NodeType.NODE_LOCAL);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// if our queue cannot access this node, just return</span></span><br><span class="line">  <span class="keyword">if</span> (!SchedulerUtils.checkQueueAccessToNode(accessibleLabels,</span><br><span class="line">      labelManager.getLabelsOnNode(node.getNodeID()))) &#123;</span><br><span class="line">    <span class="keyword">return</span> assignment;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">while</span> (canAssign(clusterResource, node)) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">boolean</span> localNeedToUnreserve = <span class="keyword">false</span>;</span><br><span class="line">    Set&lt;String&gt; nodeLabels = labelManager.getLabelsOnNode(node.getNodeID()); </span><br><span class="line">    <span class="comment">// Are we over maximum-capacity for this queue?</span></span><br><span class="line">    <span class="keyword">if</span> (!canAssignToThisQueue(clusterResource, nodeLabels)) &#123;</span><br><span class="line">      <span class="comment">// check to see if we could if we unreserve first</span></span><br><span class="line">      localNeedToUnreserve = assignToQueueIfUnreserve(clusterResource);</span><br><span class="line">      <span class="keyword">if</span> (!localNeedToUnreserve) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Schedule</span></span><br><span class="line">    CSAssignment assignedToChild = </span><br><span class="line">        assignContainersToChildQueues(clusterResource, node, localNeedToUnreserve | needToUnreserve);</span><br><span class="line">    assignment.setType(assignedToChild.getType());</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Do not assign more than one container if this isn&#x27;t the root queue</span></span><br><span class="line">    <span class="comment">// or if we&#x27;ve already assigned an off-switch container</span></span><br><span class="line">    <span class="keyword">if</span> (!rootQueue || assignment.getType() == NodeType.OFF_SWITCH) &#123;</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (rootQueue &amp;&amp; assignment.getType() == NodeType.OFF_SWITCH) &#123;</span><br><span class="line">          LOG.debug(<span class="string">&quot;Not assigning more than one off-switch container,&quot;</span> +</span><br><span class="line">              <span class="string">&quot; assignments so far: &quot;</span> + assignment);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> assignment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ†é…æ—¶ï¼Œå…ˆåˆ¤æ–­æ­¤é˜Ÿåˆ—æ˜¯å¦å¯ä»¥è®¿é—®è¯¥nmï¼Œç„¶ååˆ¤æ–­æ˜¯å¦å¯ä»¥è®¿é—®è¯¥nmä¸Šçš„labelï¼Œéƒ½åˆ¤æ–­é€šè¿‡ä¹‹åè°ƒç”¨<code>assignContainersToChildQueues</code>è¿›è¡Œåˆ†é…ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> CSAssignment <span class="title">assignContainersToChildQueues</span><span class="params">(Resource cluster, </span></span></span><br><span class="line"><span class="params"><span class="function">    FiCaSchedulerNode node, <span class="keyword">boolean</span> needToUnreserve)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Try to assign to most &#x27;under-served&#x27; sub-queue</span></span><br><span class="line">  <span class="keyword">for</span> (Iterator&lt;CSQueue&gt; iter=childQueues.iterator(); iter.hasNext();) &#123;</span><br><span class="line">    CSQueue childQueue = iter.next();</span><br><span class="line">    ...</span><br><span class="line">    assignment = childQueue.assignContainers(cluster, node, needToUnreserve);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// If we do assign, remove the queue and re-insert in-order to re-sort</span></span><br><span class="line">    <span class="keyword">if</span> (Resources.greaterThan(</span><br><span class="line">            resourceCalculator, cluster, </span><br><span class="line">            assignment.getResource(), Resources.none())) &#123;</span><br><span class="line">      <span class="comment">// Remove and re-insert to sort</span></span><br><span class="line">      iter.remove();</span><br><span class="line">      LOG.info(<span class="string">&quot;Re-sorting assigned queue: &quot;</span> + childQueue.getQueuePath() + </span><br><span class="line">          <span class="string">&quot; stats: &quot;</span> + childQueue);</span><br><span class="line">      childQueues.add(childQueue);</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        printChildQueues();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> assignment;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>assignContainersToChildQueuesè°ƒç”¨ChildQueueçš„assignContainerè¿›è¡Œåˆ†é…ï¼Œåˆ†é…ä¹‹åè¦è®²æ”¹childQueueä»é˜Ÿåˆ—ä¸­removeæ‰ï¼Œç„¶åé‡æ–°æ’å…¥åˆ°é˜Ÿåˆ—ä¸­ï¼Œè¿›è¡Œæ’åºã€‚<br>childQueue.assignContainerså¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> CSAssignment <span class="title">assignContainers</span><span class="params">(Resource clusterResource,</span></span></span><br><span class="line"><span class="params"><span class="function">    FiCaSchedulerNode node, <span class="keyword">boolean</span> needToUnreserve)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// if our queue cannot access this node, just return</span></span><br><span class="line">  <span class="keyword">if</span> (!SchedulerUtils.checkQueueAccessToNode(accessibleLabels,</span><br><span class="line">      labelManager.getLabelsOnNode(node.getNodeID()))) &#123;</span><br><span class="line">    <span class="keyword">return</span> NULL_ASSIGNMENT;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Check for reserved resources</span></span><br><span class="line">  RMContainer reservedContainer = node.getReservedContainer();</span><br><span class="line">  <span class="keyword">if</span> (reservedContainer != <span class="keyword">null</span>) &#123;</span><br><span class="line">    FiCaSchedulerApp application = </span><br><span class="line">        getApplication(reservedContainer.getApplicationAttemptId());</span><br><span class="line">    <span class="keyword">synchronized</span> (application) &#123;</span><br><span class="line">      <span class="keyword">return</span> assignReservedContainer(application, node, reservedContainer,</span><br><span class="line">          clusterResource);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Try to assign containers to applications in order</span></span><br><span class="line">  <span class="keyword">for</span> (FiCaSchedulerApp application : activeApplications) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// åŠ é”</span></span><br><span class="line">    <span class="keyword">synchronized</span> (application) &#123;</span><br><span class="line">      <span class="comment">// Check if this resource is on the blacklist</span></span><br><span class="line">      <span class="keyword">if</span> (SchedulerAppUtils.isBlacklisted(application, node, LOG)) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Schedule in priority order</span></span><br><span class="line">      <span class="keyword">for</span> (Priority priority : application.getPriorities()) &#123;</span><br><span class="line">      <span class="comment">// ä¸ºä»€ä¹ˆæ˜¯ANYï¼Ÿ</span></span><br><span class="line">      <span class="comment">// å¦‚æœå½“å‰applicationä¸­çš„requestä¸­æ²¡æœ‰ANYå°±ä¸åˆ†é…ï¼Ÿ</span></span><br><span class="line">      <span class="comment">// æƒ³åŠæ³•debugè¯•ä¸€ä¸‹</span></span><br><span class="line">        ResourceRequest anyRequest =</span><br><span class="line">            application.getResourceRequest(priority, ResourceRequest.ANY);</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == anyRequest) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Required resource</span></span><br><span class="line">        Resource required = anyRequest.getCapability();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do we need containers at this &#x27;priority&#x27;?</span></span><br><span class="line">        <span class="keyword">if</span> (application.getTotalRequiredResources(priority) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">this</span>.reservationsContinueLooking) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!needContainers(application, priority, required)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;doesn&#x27;t need containers based on reservation algo!&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        Set&lt;String&gt; requestedNodeLabels =</span><br><span class="line">            getRequestLabelSetByExpression(anyRequest</span><br><span class="line">                .getNodeLabelExpression());</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Compute user-limit &amp; set headroom</span></span><br><span class="line">        <span class="comment">// Note: We compute both user-limit &amp; headroom with the highest </span></span><br><span class="line">        <span class="comment">//       priority request as the target. </span></span><br><span class="line">        <span class="comment">//       This works since we never assign lower priority requests</span></span><br><span class="line">        <span class="comment">//       before all higher priority ones are serviced.</span></span><br><span class="line">        Resource userLimit = </span><br><span class="line">            computeUserLimitAndSetHeadroom(application, clusterResource, </span><br><span class="line">                required, requestedNodeLabels);          </span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Check queue max-capacity limit</span></span><br><span class="line">        <span class="keyword">if</span> (!canAssignToThisQueue(clusterResource, required,</span><br><span class="line">            labelManager.getLabelsOnNode(node.getNodeID()), application, <span class="keyword">true</span>)) &#123;</span><br><span class="line">          <span class="keyword">return</span> NULL_ASSIGNMENT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Check user limit</span></span><br><span class="line">        <span class="keyword">if</span> (!assignToUser(clusterResource, application.getUser(), userLimit,</span><br><span class="line">            application, <span class="keyword">true</span>, requestedNodeLabels)) &#123;</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Inform the application it is about to get a scheduling opportunity</span></span><br><span class="line">        <span class="comment">// è¿™åˆæ˜¯ä»€ä¹ˆé¬¼ï¼Ÿå¢åŠ è°ƒåº¦çš„æœºä¼šï¼Ÿ</span></span><br><span class="line">        application.addSchedulingOpportunity(priority);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Try to schedule</span></span><br><span class="line">        <span class="comment">// å¼€å§‹è°ƒåº¦</span></span><br><span class="line">        CSAssignment assignment =  </span><br><span class="line">          assignContainersOnNode(clusterResource, node, application, priority, </span><br><span class="line">              <span class="keyword">null</span>, needToUnreserve);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Did the application skip this node?</span></span><br><span class="line">        <span class="keyword">if</span> (assignment.getSkipped()) &#123;</span><br><span class="line">          <span class="comment">// Don&#x27;t count &#x27;skipped nodes&#x27; as a scheduling opportunity!</span></span><br><span class="line">          application.subtractSchedulingOpportunity(priority);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Did we schedule or reserve a container?</span></span><br><span class="line">        Resource assigned = assignment.getResource();</span><br><span class="line">        <span class="keyword">if</span> (Resources.greaterThan(</span><br><span class="line">            resourceCalculator, clusterResource, assigned, Resources.none())) &#123;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// Book-keeping </span></span><br><span class="line">          <span class="comment">// Note: Update headroom to account for current allocation too...</span></span><br><span class="line">          allocateResource(clusterResource, application, assigned,</span><br><span class="line">              labelManager.getLabelsOnNode(node.getNodeID()));</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// Don&#x27;t reset scheduling opportunities for non-local assignments</span></span><br><span class="line">          <span class="comment">// otherwise the app will be delayed for each non-local assignment.</span></span><br><span class="line">          <span class="comment">// This helps apps with many off-cluster requests schedule faster.</span></span><br><span class="line">          <span class="keyword">if</span> (assignment.getType() != NodeType.OFF_SWITCH) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;Resetting scheduling opportunities&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            application.resetSchedulingOpportunities(priority);</span><br><span class="line">          &#125;</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// Done</span></span><br><span class="line">          <span class="keyword">return</span> assignment;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Do not assign out of order w.r.t priorities</span></span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(LOG.isDebugEnabled()) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot;post-assignContainers for application &quot;</span></span><br><span class="line">        + application.getApplicationId());</span><br><span class="line">    &#125;</span><br><span class="line">    application.showRequests();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> NULL_ASSIGNMENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LeafQueue.assignContainersä¼šä»éå†å½“å‰é˜Ÿåˆ—ä¸­æ­£åœ¨è¿è¡Œçš„applicationçš„containerè¯·æ±‚ï¼Œé€šè¿‡ä¸€ç³»åˆ—çš„é€»è¾‘ä¹‹åè°ƒç”¨<code>assignContainersOnNode</code>è¿›è¡Œè°ƒåº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> CSAssignment <span class="title">assignContainersOnNode</span><span class="params">(Resource clusterResource,</span></span></span><br><span class="line"><span class="params"><span class="function">    FiCaSchedulerNode node, FiCaSchedulerApp application, Priority priority,</span></span></span><br><span class="line"><span class="params"><span class="function">    RMContainer reservedContainer, <span class="keyword">boolean</span> needToUnreserve)</span> </span>&#123;</span><br><span class="line">  Resource assigned = Resources.none();</span><br><span class="line">  <span class="comment">// å¦‚æœResourceNameæ˜¯NODE_LOCAL</span></span><br><span class="line">  ResourceRequest nodeLocalResourceRequest =</span><br><span class="line">      application.getResourceRequest(priority, node.getNodeName());</span><br><span class="line">  <span class="keyword">if</span> (nodeLocalResourceRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">    assigned = </span><br><span class="line">        assignNodeLocalContainers(clusterResource, nodeLocalResourceRequest, </span><br><span class="line">            node, application, priority, reservedContainer, needToUnreserve); </span><br><span class="line">    <span class="keyword">if</span> (Resources.greaterThan(resourceCalculator, clusterResource, </span><br><span class="line">        assigned, Resources.none())) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CSAssignment(assigned, NodeType.NODE_LOCAL);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœResourceNameæ˜¯Rack-local</span></span><br><span class="line">  ResourceRequest rackLocalResourceRequest =</span><br><span class="line">      application.getResourceRequest(priority, node.getRackName());</span><br><span class="line">  <span class="keyword">if</span> (rackLocalResourceRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!rackLocalResourceRequest.getRelaxLocality()) &#123;</span><br><span class="line">      <span class="keyword">return</span> SKIP_ASSIGNMENT;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    assigned = </span><br><span class="line">        assignRackLocalContainers(clusterResource, rackLocalResourceRequest, </span><br><span class="line">            node, application, priority, reservedContainer, needToUnreserve);</span><br><span class="line">    <span class="keyword">if</span> (Resources.greaterThan(resourceCalculator, clusterResource, </span><br><span class="line">        assigned, Resources.none())) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">new</span> CSAssignment(assigned, NodeType.RACK_LOCAL);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// å¦‚æœResourceNameæ˜¯Off-switchï¼Œä¹Ÿå°±æ˜¯ANY</span></span><br><span class="line">  ResourceRequest offSwitchResourceRequest =</span><br><span class="line">      application.getResourceRequest(priority, ResourceRequest.ANY);</span><br><span class="line">  <span class="keyword">if</span> (offSwitchResourceRequest != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!offSwitchResourceRequest.getRelaxLocality()) &#123;</span><br><span class="line">      <span class="keyword">return</span> SKIP_ASSIGNMENT;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> CSAssignment(</span><br><span class="line">        assignOffSwitchContainers(clusterResource, offSwitchResourceRequest,</span><br><span class="line">            node, application, priority, reservedContainer, needToUnreserve), </span><br><span class="line">            NodeType.OFF_SWITCH);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> SKIP_ASSIGNMENT;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>assignContainersOnNodeä¼šæ ¹æ®è¯·æ±‚ä¸­èµ„æºçš„ç±»å‹è¿›è¡Œä¸åŒçš„é€»è¾‘å¤„ç†ï¼Œç”±äºam containerä¸­ResourceRequestä¸ºANYï¼Œæ‰€ä»¥è¿™é‡Œåªå…³æ³¨ä¸‹Off-switchçš„å¤„ç†é€»è¾‘ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Resource <span class="title">assignOffSwitchContainers</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Resource clusterResource, ResourceRequest offSwitchResourceRequest,</span></span></span><br><span class="line"><span class="params"><span class="function">    FiCaSchedulerNode node, FiCaSchedulerApp application, Priority priority, </span></span></span><br><span class="line"><span class="params"><span class="function">    RMContainer reservedContainer, <span class="keyword">boolean</span> needToUnreserve)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (canAssign(application, priority, node, NodeType.OFF_SWITCH, </span><br><span class="line">      reservedContainer)) &#123;</span><br><span class="line">    <span class="keyword">return</span> assignContainer(clusterResource, node, application, priority,</span><br><span class="line">        offSwitchResourceRequest, NodeType.OFF_SWITCH, reservedContainer,</span><br><span class="line">        needToUnreserve);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> Resources.none();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>assignOffSwitchContainersåˆè°ƒç”¨äº†assignContainerï¼Œç»§ç»­è·Ÿè¸ª</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Resource <span class="title">assignContainer</span><span class="params">(Resource clusterResource, FiCaSchedulerNode node, </span></span></span><br><span class="line"><span class="params"><span class="function">    FiCaSchedulerApp application, Priority priority, </span></span></span><br><span class="line"><span class="params"><span class="function">    ResourceRequest request, NodeType type, RMContainer rmContainer,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> needToUnreserve)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// containerçš„èµ„æºå¤§å°  </span></span><br><span class="line">  Resource capability = request.getCapability();</span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹å¯ç”¨çš„èµ„æºå¤§å°</span></span><br><span class="line">  Resource available = node.getAvailableResource();</span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹æ€»å…±èµ„æºå¤§å°</span></span><br><span class="line">  Resource totalResource = node.getTotalResource();</span><br><span class="line">  <span class="comment">// åˆ¤æ–­è¯·æ±‚çš„èµ„æºæ˜¯å¦è¶…è¿‡äº†èŠ‚ç‚¹çš„æ€»é‡</span></span><br><span class="line">  <span class="keyword">if</span> (!Resources.fitsIn(capability, totalResource)) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Node : &quot;</span> + node.getNodeID()</span><br><span class="line">        + <span class="string">&quot; does not have sufficient resource for request : &quot;</span> + request</span><br><span class="line">        + <span class="string">&quot; node total capability : &quot;</span> + node.getTotalResource());</span><br><span class="line">    <span class="keyword">return</span> Resources.none();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">assert</span> Resources.greaterThan(</span><br><span class="line">      resourceCalculator, clusterResource, available, Resources.none());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the container if necessary</span></span><br><span class="line">  <span class="comment">// ç”ŸæˆcontainerId</span></span><br><span class="line">  Container container = </span><br><span class="line">      getContainer(rmContainer, application, node, capability, priority);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å…ˆåˆ¤æ–­æ˜¯å¦å¯ä»¥åˆ†é…é¢„ç•™çš„containerï¼Œ</span></span><br><span class="line">  <span class="comment">// å¯ä»¥åˆ†é…æ­£å¸¸çš„containeræ—¶ï¼Œæ‰å»åˆ¤æ–­ç©ºé—²çš„èµ„æºæ˜¯å¦å¯ä»¥åˆ†é…</span></span><br><span class="line">  <span class="comment">// Can we allocate a container on this node?</span></span><br><span class="line">  <span class="keyword">int</span> availableContainers = </span><br><span class="line">      resourceCalculator.computeAvailableContainers(available, capability);</span><br><span class="line">  <span class="keyword">if</span> (availableContainers &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Allocate...</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// Inform the application</span></span><br><span class="line">    RMContainer allocatedContainer = </span><br><span class="line">        application.allocate(type, node, priority, request, container);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Does the application need this resource?</span></span><br><span class="line">    <span class="keyword">if</span> (allocatedContainer == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> Resources.none();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é€šçŸ¥nodeè¿›è¡Œåˆ†é…ï¼Œå°†containeræ”¾å…¥launchedContainers mapä¸­</span></span><br><span class="line">    <span class="comment">// Inform the node</span></span><br><span class="line">    node.allocateContainer(allocatedContainer);</span><br><span class="line"></span><br><span class="line">    LOG.info(<span class="string">&quot;assignedContainer&quot;</span> +</span><br><span class="line">        <span class="string">&quot; application attempt=&quot;</span> + application.getApplicationAttemptId() +</span><br><span class="line">        <span class="string">&quot; container=&quot;</span> + container + </span><br><span class="line">        <span class="string">&quot; queue=&quot;</span> + <span class="keyword">this</span> + </span><br><span class="line">        <span class="string">&quot; clusterResource=&quot;</span> + clusterResource);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> container.getResource();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// if we are allowed to allocate but this node doesn&#x27;t have space, reserve it or</span></span><br><span class="line">    <span class="comment">// if this was an already a reserved container, reserve it again</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> Resources.none();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>assignContaineré¦–å…ˆåˆ¤æ–­containerè¯·æ±‚çš„èµ„æºæ˜¯å¦è¶…è¿‡äº†èŠ‚ç‚¹çš„æ€»èµ„æºé‡ï¼Œå¦‚æœæ²¡æœ‰è¶…è¿‡è°ƒç”¨<code>getContainer</code>æŸ¥çœ‹å½“å‰èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰é¢„ç•™çš„containerï¼Œæ²¡æœ‰åˆ™<code>createContainer</code>ï¼Œ<strong>ç”ŸæˆcontainerId</strong>ã€‚containerIdç”Ÿæˆä¹‹åï¼Œå»åˆ¤æ–­å½“å‰èŠ‚ç‚¹ä¸Šçš„ç©ºé—²èµ„æºèƒ½å¦å¤Ÿåˆ†é…ï¼Œå¦‚æœå¯ä»¥çš„è¯å°±è°ƒç”¨<code>application.allocate</code>è¿›è¡Œåˆ†é…ï¼Œapplicationæ˜¯FiCaSchedulerAppçš„å¯¹è±¡ã€‚æœ€åå°†containeræ”¾å…¥<code>launchedContainers</code>ä¸­ï¼Œéšåä¼šå¿ƒè·³è¿”å›ç»™nodeã€‚allocateä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">public</span> RMContainer <span class="title">allocate</span><span class="params">(NodeType type, FiCaSchedulerNode node,</span></span></span><br><span class="line"><span class="params"><span class="function">    Priority priority, ResourceRequest request, </span></span></span><br><span class="line"><span class="params"><span class="function">    Container container)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// containeråœ¨RMç«¯ç§°ä¸ºRMcontainer</span></span><br><span class="line">  <span class="comment">// Create RMContainer</span></span><br><span class="line">  RMContainer rmContainer = <span class="keyword">new</span> RMContainerImpl(container, <span class="keyword">this</span></span><br><span class="line">      .getApplicationAttemptId(), node.getNodeID(),</span><br><span class="line">      appSchedulingInfo.getUser(), <span class="keyword">this</span>.rmContext);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add it to allContainers list.</span></span><br><span class="line">  <span class="comment">// å°†ç”Ÿæˆçš„containeræ”¾å…¥allContainers list</span></span><br><span class="line">  <span class="comment">// è°ƒåº¦å™¨åœ¨è°ƒåº¦çš„æ—¶å€™ä»ä¸­å–å‡ºcontainer</span></span><br><span class="line">  newlyAllocatedContainers.add(rmContainer);</span><br><span class="line">  liveContainers.put(container.getId(), rmContainer);    </span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update consumption and track allocations</span></span><br><span class="line">  List&lt;ResourceRequest&gt; resourceRequestList = appSchedulingInfo.allocate(</span><br><span class="line">      type, node, priority, request, container);</span><br><span class="line">  Resources.addTo(currentConsumption, container.getResource());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Update resource requests related to &quot;request&quot; and store in RMContainer </span></span><br><span class="line">  ((RMContainerImpl)rmContainer).setResourceRequests(resourceRequestList);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Inform the container</span></span><br><span class="line">  <span class="comment">// æ—¶é—´è°ƒåº¦å™¨æ¥é€šçŸ¥containerå·²ç»å‡†å¤‡å¥½ï¼Œè§¦å‘containerçŠ¶æ€æœº</span></span><br><span class="line">  rmContainer.handle(</span><br><span class="line">      <span class="keyword">new</span> RMContainerEvent(container.getId(), RMContainerEventType.START));</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> rmContainer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>allocateåˆ›å»ºä¸€ä¸ªRMContainerï¼Œå¹¶å°†å…¶æ”¾å…¥allContainersåˆ—è¡¨<code>newlyAllocatedContainers</code>ä¸­ï¼Œå¹¶è§¦å‘äº†RMContainerçš„çŠ¶æ€æœºå˜åŒ–ã€‚<br>è°ƒåº¦å™¨ä»newlyAllocatedContainerså–å‡ºcontaineråˆ†é…ç»™nodeã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å¤§è‡´çš„æµç¨‹é¡ºç€ä»£ç ç†è§£çš„å·®ä¸å¤šäº†ï¼Œä½†ä¸€äº›ç»†èŠ‚è¿˜æ˜¯æ²¡æœ‰æå¤ªæ¸…æ¥šï¼Œéšåè¯¦ç»†debugä¸‹ï¼Œåœ¨æ›´æ–°å§ã€‚<br><strong>è¯´ä¸‹æˆ‘ç›®å‰çš„ç†è§£ï¼Œè°ƒåº¦å™¨é¦–å…ˆåˆ›å»ºä¸€ä¸ªcontainerè¯·æ±‚ï¼Œå¹¶æŸ¥çœ‹<code>newlyAllocatedContainers</code>ä¸­æ˜¯å¦æœ‰å¯è°ƒåº¦çš„containerï¼Œå¦‚æœæœ‰åˆ™åˆ›å»ºè¯¥containerçš„TOKENã€‚ç„¶ånmæ¥è¿›è¡Œå¿ƒè·³çš„æ—¶å€™ï¼Œä»requestsä¸­å–å‡ºå¯¹åº”çš„è¯·æ±‚è¿›è¡Œå®ä¾‹åŒ–ï¼Œéšåå†æ”¾å…¥<code>newlyAllocatedContainers</code>åˆ—è¡¨ä¸­ï¼Œç­‰å¾…è°ƒåº¦ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> ApplicationMaster </tag>
            
            <tag> åˆ†é…ç­–ç•¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Intellij ideaä¸­ä¾èµ–æ¨¡å—é—´çš„testä»£ç </title>
      <link href="/Intellij%20idea%E4%B8%AD%E4%BE%9D%E8%B5%96%E6%A8%A1%E5%9D%97%E9%97%B4%E7%9A%84test%E4%BB%A3%E7%A0%81.html"/>
      <url>/Intellij%20idea%E4%B8%AD%E4%BE%9D%E8%B5%96%E6%A8%A1%E5%9D%97%E9%97%B4%E7%9A%84test%E4%BB%A3%E7%A0%81.html</url>
      
        <content type="html"><![CDATA[<p>ä¸ºäº†æ–¹ä¾¿å¹³æ—¶çœ‹ä»£ç å’Œdebugä»£ç ï¼Œæˆ‘åœ¨hadoopçš„æºç ä¸­æ–°å»ºäº†ä¸ªæ¨¡å—<em>hadoop-hunhun</em>ï¼Œæ­¤æ¨¡å—ä¾èµ–å…¶ä½™hadoopæ¨¡å—ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥åœ¨srcä¸­debugä»£ç äº†ã€‚</p><p>åœ¨ä½¿ç”¨<code>MiniMRClientCluster</code>è¿›è¡Œmræµ‹è¯•æ—¶ï¼Œå‘ç°éœ€è¦ä¾èµ–ä¸€äº›æ¨¡å—çš„testä»£ç ï¼Œä¸‹é¢å°±æ¥è®°å½•ä¸‹è½½intellij ideaä¸­æ¨¡å—æ€ä¹ˆä¾èµ–å…¶ä½™æ¨¡å—çš„testä»£ç ã€‚</p><span id="more"></span><p>é¦–å…ˆæ‰¾åˆ°æ‰€ä¾èµ–çš„testä»£ç åœ¨å“ªä¸ªæ¨¡å—ï¼Œè¿™é‡Œä¼šä¾èµ–jobclientã€yarn-server-testå’Œcommonæ¨¡å—ä¸­çš„testä»£ç ï¼Œæ“ä½œæ­¥éª¤ä¸ºï¼š</p><p>File -&gt; Project Structure<br>ç‚¹å‡»æ–°å»ºçš„hadoop-hunhunæ¨¡å—ï¼Œé€‰æ‹©Dependenciesé€‰é¡¹å¡ï¼Œè¿™é‡Œæˆ‘å·²ç»æ·»åŠ äº†å¯¹å…¶å®ƒæ¨¡å—çš„ä¾èµ–ï¼Œå¦‚å›¾ï¼š<br><img src="/blogimgs/modulesDependence/dependence.png" alt="dependencies" title="dependencies"></p><p>åœ¨æ·»åŠ testä¾èµ–ä¹‹å‰ï¼Œè¦åœ¨testæ‰€åœ¨æ¨¡å—ä¸­æ‰¾åˆ°testä»£ç çš„è¾“å‡ºè·¯å¾„ï¼Œä»¥jobclientä¸­testä¸ºä¾‹ï¼Œåœ¨<em>Project Structure</em>ä¸­ç‚¹å‡»<code>hadoop-mapreduce-client-jobclient</code>æ¨¡å—ï¼Œç„¶åé€‰æ‹©<code>Paths</code>ï¼Œå°†å…¶<strong>Test Output path</strong>çš„å†…å®¹è¿›è¡Œå¤åˆ¶ï¼Œå¦‚ä¸‹ï¼š<br><img src="/blogimgs/modulesDependence/testoutput.png" alt="TestOutputPath" title="TestOutputPath"></p><p>ç„¶åå†æ¬¡å›åˆ°<em>hadoop-hunhun</em>æ¨¡å—ä¸­çš„dependenciesé€‰é¡¹å¡ä¸­ï¼Œç‚¹å‡»å³ä¸‹è§’çš„â€+â€,é€‰æ‹©<strong>Library</strong>ï¼Œå¦‚ä¸‹ï¼š<br><img src="/blogimgs/modulesDependence/library.png" alt="Library" title="Library"><br>åœ¨å¼¹å‡ºçš„å¯¹è¯æ¡†ä¸­ç‚¹å‡»<em>New Library</em>ï¼Œé€‰æ‹©<em>java</em>ï¼Œè¾“å…¥åœ¨ä¸Šä¸€æ­¥ä¸­å¤åˆ¶çš„Test Output Pathï¼Œç‚¹å‡»okï¼Œä¹‹åç‚¹å‡»Add Selectedã€‚</p><p>å®Œæˆä¸Šè¿°æ­¥éª¤åˆ™æ·»åŠ æˆåŠŸã€‚</p><p>ä¹‹åå°±å¯ä»¥åˆ©ç”¨<code>MiniMRClientCluster</code>åœ¨srcä¸­debugä»£ç äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> Intellij idea </tag>
            
            <tag> model dependence </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>flumeäº‹åŠ¡è§£æ</title>
      <link href="/flume%E4%BA%8B%E5%8A%A1%E8%A7%A3%E6%9E%90.html"/>
      <url>/flume%E4%BA%8B%E5%8A%A1%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨flumeä¸­<em>äº‹åŠ¡</em>æ˜¯ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µï¼Œäº‹åŠ¡ä¿è¯äº†æ•°æ®çš„å¯ç”¨æ€§ã€‚è¿™é‡Œçš„äº‹åŠ¡æœ‰åˆ«äºæ•°æ®åº“ä¸­çš„äº‹åŠ¡ï¼Œæ¯”äº‹åŠ¡åœ¨å›æ»šæ—¶ï¼Œå¯èƒ½ä¼šé€ æˆæ•°æ®é‡å¤ï¼Œ<em>æ‰€ä»¥flumeä¿è¯çš„æ˜¯æ¯æ¡æ•°æ®æœ€å°‘å‘é€ä¸€æ¬¡ï¼Œä»¥æ­¤æ¥ä¿è¯æ•°æ®ä¸ä¸¢å¤±</em>ã€‚</p><p>æ­¤ç¯‡ä»å…·ä½“çš„æ•°æ®æµä¸­åˆ†æäº‹åŠ¡ï¼Œé…ç½®çš„æ•°æ®æµæ˜¯<em>taildir+kafkachannel</em>ï¼Œç„¶å<em>kafkachannel+hdfsSink</em>ã€‚</p><p>kafkachannelä¸­ç»´æŠ¤äº†ä¸¤ä¸ªäº‹åŠ¡ï¼Œåˆ†åˆ«æ˜¯putäº‹åŠ¡å’Œtakeäº‹åŠ¡ã€‚</p><span id="more"></span><h2 id="putäº‹åŠ¡"><a href="#putäº‹åŠ¡" class="headerlink" title="putäº‹åŠ¡"></a>putäº‹åŠ¡</h2><p>kafkachannelçš„putäº‹åŠ¡æ˜¯ç”±taildirè§¦å‘çš„ï¼Œæˆ‘ä»¬ä»ä»£ç ä¸­è·Ÿä¸‹putäº‹åŠ¡çš„æµç¨‹ã€‚</p><p>taildirçš„å…¥å£æ˜¯TaildirSource.processï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Status <span class="title">process</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Status status = Status.READY;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    existingInodes.clear();</span><br><span class="line">    existingInodes.addAll(reader.updateTailFiles());</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">long</span> inode : existingInodes) &#123;</span><br><span class="line">      TailFile tf = reader.getTailFiles().get(inode);</span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦éœ€è¦tail</span></span><br><span class="line">      <span class="comment">// åˆ¤æ–­è§„åˆ™ï¼Œä¿®æ”¹æ—¶é—´æ˜¯å¦å¤§äºä¸Šæ¬¡è®°å½•çš„tialæ—¶é—´ï¼Œè®°å½•çš„postitionæ˜¯å¦å¤§äºè¯¥æ–‡ä»¶çš„length</span></span><br><span class="line">      <span class="keyword">if</span> (tf.needTail()) &#123;</span><br><span class="line">        tailFileProcess(tf, <span class="keyword">true</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    closeTailFiles();</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“fileçš„ä¿®æ”¹æ—¶é—´å¤§äºè®°å½•çš„ä¸Šæ¬¡tailæ—¶é—´æˆ–è€…è®°å½•çš„postitionå¤§äºfileçš„lengthæ—¶(ä»0å¤„tail)ï¼Œéœ€è¦tailè¯¥fileã€‚<br>æ–‡ä»¶çš„tailé€»è¾‘åœ¨<code>tailFileProcess</code>ä»£ç ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">tailFileProcess</span><span class="params">(TailFile tf, <span class="keyword">boolean</span> backoffWithoutNL)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    reader.setCurrentFile(tf);</span><br><span class="line">    <span class="comment">// ä»æ–‡ä»¶ä¸­è¯»å–batchSizeæ¡æ•°æ®</span></span><br><span class="line">    List&lt;Event&gt; events = reader.readEvents(batchSize, backoffWithoutNL);</span><br><span class="line">    <span class="keyword">if</span> (events.isEmpty()) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    sourceCounter.addToEventReceivedCount(events.size());</span><br><span class="line">    sourceCounter.incrementAppendBatchReceivedCount();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// äº‹åŠ¡çš„å®ç°</span></span><br><span class="line">      getChannelProcessor().processEventBatch(events);</span><br><span class="line">      reader.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ChannelException ex) &#123;</span><br><span class="line">      logger.warn(<span class="string">&quot;The channel is full or unexpected failure. &quot;</span> +</span><br><span class="line">          <span class="string">&quot;The source will try again after &quot;</span> + retryInterval + <span class="string">&quot; ms&quot;</span>);</span><br><span class="line">      TimeUnit.MILLISECONDS.sleep(retryInterval);</span><br><span class="line">      retryInterval = retryInterval &lt;&lt; <span class="number">1</span>;</span><br><span class="line">      retryInterval = Math.min(retryInterval, maxRetryInterval);</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    retryInterval = <span class="number">1000</span>;</span><br><span class="line">    sourceCounter.addToEventAcceptedCount(events.size());</span><br><span class="line">    sourceCounter.incrementAppendBatchAcceptedCount();</span><br><span class="line">    <span class="comment">// è¿½ä¸Šå†™å…¥çš„é€Ÿåº¦ä¹‹åæ‰ä¼šé€€å‡ºå½“å‰fileï¼Ÿæ˜¯å¦å­˜åœ¨å…¶å®ƒæ–‡ä»¶æ— æ³•å¾—åˆ°tailçš„æœºä¼šï¼Ÿï¼Ÿ</span></span><br><span class="line">    <span class="comment">// è¿™åº”è¯¥æ˜¯ä¸ªbug</span></span><br><span class="line">    <span class="keyword">if</span> (events.size() &lt; batchSize) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ä¸Šé¢çš„bugæ˜¯å½“ä¸€ä¸ªfileGroupä¸­æœ‰å¤šä¸ªæ­£åœ¨å†™å…¥çš„æ–‡ä»¶æ—¶ï¼Œå¦‚æœæŸä¸ªæ–‡ä»¶çš„å†™å…¥é‡å¤§ï¼Œè‡´ä½¿æ¯æ¬¡éƒ½èƒ½ä»ä¸­è¯»å–batchSizeæ¡æ•°æ®ï¼Œåˆ™å…¶å®ƒæ–‡ä»¶å°†æ²¡æœ‰æœºä¼šè¢«è¯»å–ã€‚<br>è¿™ä¸ªbugæˆ‘å·²æäº¤åˆ°ç¤¾åŒº<a href="https://issues.apache.org/jira/browse/FLUME-3101">FLUME-3101</a></p></blockquote><p>ä¸‹é¢çœ‹ä¸‹äº‹åŠ¡å…·ä½“æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œ<br><code>getChannelProcessor().processEventBatch(events)</code> -&gt; <code>ChannelProcesser.processEventBatch</code>ï¼Œçœ‹ä¸‹processEventBatchçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processEventBatch</span><span class="params">(List&lt;Event&gt; events)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å°†eventä¸channelç»„æˆmap</span></span><br><span class="line">  <span class="keyword">for</span> (Event event : events) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Process required channels</span></span><br><span class="line">  <span class="keyword">for</span> (Channel reqChannel : reqChannelQueue.keySet()) &#123;</span><br><span class="line">  <span class="comment">// å¾—åˆ°channelå¯¹åº”çš„äº‹åŠ¡</span></span><br><span class="line">    Transaction tx = reqChannel.getTransaction();</span><br><span class="line">    Preconditions.checkNotNull(tx, <span class="string">&quot;Transaction object must not be null&quot;</span>);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å¼€å§‹äº‹åŠ¡</span></span><br><span class="line">      tx.begin();</span><br><span class="line">      <span class="comment">// å¤„ç†äº‹åŠ¡ï¼Œè¿™é‡Œæ˜¯å…ˆå°†eventå†™å…¥å†…å­˜ï¼Œç„¶åç”±commitæ‰¹é‡å°†eventså†™å…¥kafka</span></span><br><span class="line">      List&lt;Event&gt; batch = reqChannelQueue.get(reqChannel);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">for</span> (Event event : batch) &#123;</span><br><span class="line">        reqChannel.put(event);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æäº¤äº‹åŠ¡ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªäº‹åŠ¡çš„ç»“æŸ</span></span><br><span class="line">      tx.commit();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      <span class="comment">// å‘ç”Ÿè®®ç¨‹ï¼Œè¿›è¡Œäº‹åŠ¡å›æ»š</span></span><br><span class="line">      tx.rollback();</span><br><span class="line">      <span class="keyword">if</span> (t <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Error while writing to required channel: &quot;</span> + reqChannel, t);</span><br><span class="line">        <span class="keyword">throw</span> (Error) t;</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ChannelException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (ChannelException) t;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">&quot;Unable to put batch on required &quot;</span> +</span><br><span class="line">            <span class="string">&quot;channel: &quot;</span> + reqChannel, t);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (tx != <span class="keyword">null</span>) &#123;</span><br><span class="line">        tx.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Process optional channels</span></span><br><span class="line">  <span class="keyword">for</span> (Channel optChannel : optChannelQueue.keySet()) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆä»è¯¥sourceä¸­ç»‘å®šçš„channelä¸­æ‹¿åˆ°å¯¹åº”çš„<code>Transaction</code>ï¼Œç„¶åè°ƒç”¨<code>begin</code>æ–¹æ³•å¼€å§‹äº‹åŠ¡ï¼Œç­‰æ•°æ®å¤„ç†ç»“æŸä¹‹åï¼Œè°ƒç”¨<code>commit</code>æäº¤äº‹åŠ¡ï¼Œå¦‚æœå¤„ç†æ•°æ®çš„è¿‡ç¨‹ä¸­å‘ç”Ÿé”™è¯¯ï¼Œåˆ™åœ¨catchä¸­æ•è·ï¼Œè°ƒç”¨<code>rollback</code>è¿›è¡Œäº‹åŠ¡å›æ»šã€‚</p><p>å…ˆçœ‹ä¸‹æ•°æ®å¤„ç†çš„é€»è¾‘ï¼Œé€šè¿‡<code>reqChannel.put(event)</code>å°†æ•°æ®å°†å…¥channelçš„å†…å­˜ä¸­ã€‚çœ‹ä¼¼è°ƒç”¨çš„æ˜¯channelçš„æ–¹æ³•ï¼Œå…¶å®channelçš„putåªæ˜¯å¯¹Transactionçš„putè¿›è¡Œäº†ä¸‹å°è£…ï¼Œè€Œ<code>Transaction.put</code>çš„å…·ä½“å®ç°æ˜¯åœ¨channelä¸­çš„Transaction.doPuté‡Œå®ç°çš„ã€‚<br><code>reqChannel.put(event)</code> -&gt; <code>BasicChannelSemantics.put</code> -&gt; <code>BasicTransactionSemantics.put</code> -&gt; <code>BasicTransactionSemantics.duPut</code><br>å…¶ä¸­<code>doPut</code>æ˜¯ä¸€ä¸ªæŠ½è±¡æ–¹æ³•ï¼Œå…¶å…·ä½“å®ç°æ”¾åœ¨å„ä¸ªchannelçš„Transactionä¸­ã€‚è¿™é‡Œä½¿ç”¨çš„kafkaChannelï¼Œå…¶å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doPut</span><span class="params">(Event event)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// äº‹åŠ¡ç±»å‹ PUT or TAKE</span></span><br><span class="line">  type = TransactionType.PUT;</span><br><span class="line">  ...</span><br><span class="line">  Integer partitionId = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (staticPartitionId != <span class="keyword">null</span>) &#123;</span><br><span class="line">      partitionId = staticPartitionId;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//Allow a specified header to override a static ID</span></span><br><span class="line">    <span class="keyword">if</span> (partitionHeader != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String headerVal = event.getHeaders().get(partitionHeader);</span><br><span class="line">      <span class="keyword">if</span> (headerVal != <span class="keyword">null</span>) &#123;</span><br><span class="line">        partitionId = Integer.parseInt(headerVal);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†eventæ„å»ºä¸€ä¸ªProducerRecordå¯¹è±¡æ”¾å…¥producerRecordsä¸­ï¼Œ</span></span><br><span class="line">    <span class="comment">// ç­‰å¾…commitæ—¶å†™å…¥kafka</span></span><br><span class="line">    <span class="keyword">if</span> (partitionId != <span class="keyword">null</span>) &#123;</span><br><span class="line">      producerRecords.get().add(</span><br><span class="line">          <span class="keyword">new</span> ProducerRecord&lt;String, <span class="keyword">byte</span>[]&gt;(topic.get(), partitionId, key,</span><br><span class="line">                                             serializeValue(event, parseAsFlumeEvent)));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      producerRecords.get().add(</span><br><span class="line">          <span class="keyword">new</span> ProducerRecord&lt;String, <span class="keyword">byte</span>[]&gt;(topic.get(), key,</span><br><span class="line">                                             serializeValue(event, parseAsFlumeEvent)));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NumberFormatException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">&quot;Non integer partition id specified&quot;</span>, e);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">&quot;Error while serializing event&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doPuté¦–å…ˆç»™äº‹åŠ¡çš„ç±»å‹èµ‹å€¼ï¼Œç„¶åå°†eventæ”¾å…¥å†…å­˜ä¸­ï¼Œå¦‚æœæ­¤è¿‡ç¨‹ä¸­æ²¡æœ‰å‘ç”Ÿé”™è¯¯ï¼Œåˆ™ä¼šè°ƒç”¨<code>commit</code>å¯¹å†…å­˜ä¸­çš„eventæäº¤åˆ°kafkaä¸­ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹<code>commit</code>çš„ä»£ç ï¼Œcommitçš„è°ƒç”¨é€»è¾‘å’Œputç±»ä¼¼ï¼Œå…·ä½“å®ç°æ˜¯åœ¨KafkaChannel.KafkaTransactionçš„duCommitä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doCommit</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.NONE)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­éœ€è¦commitçš„äº‹åŠ¡ç±»å‹</span></span><br><span class="line">  <span class="comment">// æ­¤å¤„å…ˆåˆ†æPUTçš„commit</span></span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.PUT)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!kafkaFutures.isPresent()) &#123;</span><br><span class="line">      kafkaFutures = Optional.of(<span class="keyword">new</span> LinkedList&lt;Future&lt;RecordMetadata&gt;&gt;());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">long</span> batchSize = producerRecords.get().size();</span><br><span class="line">      <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">      <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">for</span> (ProducerRecord&lt;String, <span class="keyword">byte</span>[]&gt; record : producerRecords.get()) &#123;</span><br><span class="line">        index++;</span><br><span class="line">        <span class="comment">// å¤šçº¿ç¨‹ä¹‹é—´å…±äº«ä¸€ä¸ªproducerå®ä¾‹(å®˜æ–¹æ¨èï¼Œä½†ä¹Ÿå¯ä»¥æ ¹æ®è‡ªå·±çš„æƒ…å†µè€Œå®š)</span></span><br><span class="line">        <span class="comment">// The producer is thread safe and sharing a single producer instance </span></span><br><span class="line">        <span class="comment">// across threads will generally be faster than having multiple instances.</span></span><br><span class="line">        kafkaFutures.get().add(producer.send(record, <span class="keyword">new</span> ChannelCallback(index, startTime)));</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//prevents linger.ms from being a problem</span></span><br><span class="line">      <span class="comment">// å¼ºåˆ¶å‘é€ç´¯åŠ é˜Ÿåˆ—RecordAccumulatorä¸­çš„æ•°æ®</span></span><br><span class="line">      producer.flush();</span><br><span class="line">      <span class="comment">// ç­‰å¾…å„çº¿ç¨‹å°†æ•°æ®å‘é€è‡³kafka</span></span><br><span class="line">      <span class="keyword">for</span> (Future&lt;RecordMetadata&gt; future : kafkaFutures.get()) &#123;</span><br><span class="line">        future.get();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">long</span> endTime = System.nanoTime();</span><br><span class="line">      counter.addToKafkaEventSendTimer((endTime - startTime) / (<span class="number">1000</span> * <span class="number">1000</span>));</span><br><span class="line">      counter.addToEventPutSuccessCount(batchSize);</span><br><span class="line">      producerRecords.get().clear();</span><br><span class="line">      kafkaFutures.get().clear();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      logger.warn(<span class="string">&quot;Sending events to Kafka failed&quot;</span>, ex);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">&quot;Commit failed as send to Kafka failed&quot;</span>,</span><br><span class="line">              ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PUTç±»å‹çš„äº‹åŠ¡å’ŒTAKEç±»å‹çš„äº‹åŠ¡éƒ½æ˜¯åœ¨doCommitä¸­æäº¤ï¼Œè¿™é‡Œè°ƒç”¨çš„éƒ½æ˜¯kafkaçš„Java Apiï¼Œéœ€è¦æ³¨æ„çš„æ˜¯å„ä¸ªçº¿ç¨‹ä¹‹é—´å…±äº«ä¸€ä¸ªproducerå®ä¾‹ï¼Œeventå‘é€åˆ°kafkaå¯ä»¥è®¤ä¸ºæ˜¯åŒæ­¥å‘é€ï¼Œå› ä¸ºè°ƒç”¨äº†<code>future.get</code>ç­‰å¾…å„ä¸ªçº¿ç¨‹çš„ç»“æŸã€‚<br>è¿™é‡Œè¿˜è°ƒç”¨äº†<code>producer.flush()</code>ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢é…ç½®äº†<code>linger.ms</code>å¯¹recordè¿›è¡Œåˆå¹¶å‘é€ï¼Œflushå¼ºåˆ¶å°†é˜Ÿåˆ—ä¸­çš„æ•°æ®å‘é€åˆ°kafkaã€‚</p><p>æ— è®ºæ˜¯åœ¨doPutè¿˜æ˜¯åœ¨doCommitä¸­å‘ç”Ÿé”™è¯¯ï¼Œéƒ½ä¼šå¯¹äº‹åŠ¡è¿›è¡Œå›æ»šã€‚å›æ»šæ˜¯åœ¨doRollbackä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRollback</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.NONE)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.PUT)) &#123;</span><br><span class="line">  <span class="comment">// PUTæ—¶å‘ç”Ÿé”™è¯¯ï¼Œåˆ™æŠŠå†…å­˜ä¸­çš„æ•°æ®æ¸…ç©º</span></span><br><span class="line">  <span class="comment">// ä½†æ²¡æœ‰å¯¹å›æ»šçš„æ¬¡æ•°è¿›è¡Œç»Ÿè®¡</span></span><br><span class="line">    producerRecords.get().clear();</span><br><span class="line">    kafkaFutures.get().clear();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>ç”±ä¸Šé¢çš„åˆ†æå¯çŸ¥ï¼Œkafkachannelæ˜¯å°†eventé€šè¿‡doPutå†™å…¥å†…å­˜ï¼Œç„¶åé€šè¿‡doCommitå°†å†…å­˜ä¸­çš„æ•°æ®å‘é€åˆ°kafkaï¼Œè¿™ä¸ªäº‹åŠ¡æ˜¯å°†eventå†™å…¥åˆ°kafkaæ—¶æ‰ç»“æŸã€‚<br>è€Œmemorychannelåˆ™æ˜¯å°†eventé€šè¿‡doPutå†™å…¥å†…å­˜(putList)ä¸­ï¼Œç„¶åé€šè¿‡doCommitå°†putListä¸­çš„æ•°æ®å†™å…¥queueä¸­ï¼Œå†™å…¥queueæˆåŠŸåˆ™äº‹åŠ¡ç»“æŸã€‚å¯è§å¦‚æœä½¿ç”¨kafkachannelå‘kafkaä¸­å†™æ•°æ®æ—¶ä¼šæ¯”memorychannelè¦é«˜æ•ˆï¼Œæ›´é‡è¦çš„æ˜¯èƒ½ä¿è¯æ•°æ®çš„äº‹åŠ¡æ€§</em>ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹takeäº‹åŠ¡</p><h2 id="takeäº‹åŠ¡"><a href="#takeäº‹åŠ¡" class="headerlink" title="takeäº‹åŠ¡"></a>takeäº‹åŠ¡</h2><p>kafkachannelä¸­çš„takeäº‹åŠ¡æ˜¯ç”±sinkè§¦å‘çš„ï¼Œè¿™é‡Œæ˜¯æŒ‡hdfsSinkï¼Œä¸‹é¢çœ‹ä¸‹takeçš„äº‹åŠ¡ä»£ç ã€‚</p><p>æ­¤å¤„çš„sinkç”¨çš„æ˜¯HDFSEventSinkï¼Œå…¶processä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// éçº¿ç¨‹å®‰å…¨</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Status <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> EventDeliveryException </span>&#123;</span><br><span class="line">  <span class="comment">// æ‹¿åˆ°sinkå…³è”çš„channel</span></span><br><span class="line">  Channel channel = getChannel();</span><br><span class="line">  <span class="comment">// ä»channelä¸­å¾—åˆ°Transaction</span></span><br><span class="line">  Transaction transaction = channel.getTransaction();</span><br><span class="line">  List&lt;BucketWriter&gt; writers = Lists.newArrayList();</span><br><span class="line">  <span class="comment">// å¼€å§‹äº‹åŠ¡</span></span><br><span class="line">  transaction.begin();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> txnEventCount = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span> (txnEventCount = <span class="number">0</span>; txnEventCount &lt; batchSize; txnEventCount++) &#123;</span><br><span class="line">      <span class="comment">// ä»channelä¸­å–å‡ºä¸€æ¡æ•°æ®</span></span><br><span class="line">      Event event = channel.take();</span><br><span class="line">      <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">synchronized</span> (sfWritersLock) &#123;</span><br><span class="line">        bucketWriter = sfWriters.get(lookupPath);</span><br><span class="line">        <span class="comment">// we haven&#x27;t seen this file yet, so open it and cache the handle</span></span><br><span class="line">        <span class="comment">// æ²¡æœ‰æ–‡ä»¶çš„å¥æŸ„ï¼Œåˆ™æ–°å»ºä¸€ä¸ª</span></span><br><span class="line">        <span class="keyword">if</span> (bucketWriter == <span class="keyword">null</span>) &#123;</span><br><span class="line">          hdfsWriter = writerFactory.getWriter(fileType);</span><br><span class="line">          bucketWriter = initializeBucketWriter(realPath, realName,</span><br><span class="line">            lookupPath, hdfsWriter, closeCallback);</span><br><span class="line">          sfWriters.put(lookupPath, bucketWriter);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// track the buckets getting written in this transaction</span></span><br><span class="line">      <span class="comment">// ä¸€æ¬¡äº‹åŠ¡ä¸­ï¼Œtakeçš„eventå¯èƒ½æ¥è‡ªä¸åŒtopicçš„paritionï¼Œåˆ™éœ€è¦åŒæ—¶æ‰“å¼€å¤šä¸ªæ–‡ä»¶å¥æŸ„</span></span><br><span class="line">      <span class="keyword">if</span> (!writers.contains(bucketWriter)) &#123;</span><br><span class="line">        writers.add(bucketWriter);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Write the data to HDFS</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        bucketWriter.append(event);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (BucketClosedException ex) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// flush all pending buckets before committing the transaction</span></span><br><span class="line">    <span class="keyword">for</span> (BucketWriter bucketWriter : writers) &#123;</span><br><span class="line">      bucketWriter.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// äº‹åŠ¡æäº¤</span></span><br><span class="line">    transaction.commit();</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException eIO) &#123;</span><br><span class="line">  <span class="comment">// å‘ç”Ÿå¼‚å¸¸è¿›è¡Œäº‹åŠ¡å›æ»š</span></span><br><span class="line">    transaction.rollback();</span><br><span class="line">    LOG.warn(<span class="string">&quot;HDFS IO error&quot;</span>, eIO);</span><br><span class="line">    <span class="keyword">return</span> Status.BACKOFF;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable th) &#123;</span><br><span class="line">    transaction.rollback();</span><br><span class="line">    LOG.error(<span class="string">&quot;process failed&quot;</span>, th);</span><br><span class="line">    <span class="keyword">if</span> (th <span class="keyword">instanceof</span> Error) &#123;</span><br><span class="line">      <span class="keyword">throw</span> (Error) th;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> EventDeliveryException(th);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    transaction.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sinkçš„processä¸­å…ˆä»å¯¹åº”çš„channelä¸­å¾—åˆ°Transactionï¼Œç„¶åè°ƒç”¨<code>begin</code>å¼€å§‹æ‰§è¡Œäº‹åŠ¡ï¼Œç„¶åå¼€å§‹å¤„ç†æ•°æ®ã€‚<br>å¤„ç†æ•°æ®æ—¶ï¼Œè°ƒç”¨<code>channel.take</code>ä»channelä¸­takeä¸€æ¡eventï¼Œ<code>take</code>æœ€ç»ˆè°ƒç”¨çš„æ˜¯<code>KafkaTransaction.doTake</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Event <span class="title">doTake</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// äº‹åŠ¡ç±»å‹</span></span><br><span class="line">  type = TransactionType.TAKE;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// channelUUIDæ˜¯finalç±»å‹çš„ï¼Œé‚£ä¸€ä¸ªkafkachannelå®ä¾‹åªæœ‰ä¸€ä¸ªconsumerï¼Ÿ</span></span><br><span class="line">    <span class="keyword">if</span> (!(consumerAndRecords.get().uuid.equals(channelUUID))) &#123;</span><br><span class="line">      logger.info(<span class="string">&quot;UUID mismatch, creating new consumer&quot;</span>);</span><br><span class="line">      decommissionConsumerAndRecords(consumerAndRecords.get());</span><br><span class="line">      consumerAndRecords.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    logger.warn(<span class="string">&quot;Error while shutting down consumer&quot;</span>, ex);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!events.isPresent()) &#123;</span><br><span class="line">    events = Optional.of(<span class="keyword">new</span> LinkedList&lt;Event&gt;());</span><br><span class="line">  &#125;</span><br><span class="line">  Event e;</span><br><span class="line">  <span class="comment">// Give the channel a chance to commit if there has been a rebalance</span></span><br><span class="line">  <span class="keyword">if</span> (rebalanceFlag.get()) &#123;</span><br><span class="line">    logger.debug(<span class="string">&quot;Returning null event after Consumer rebalance.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!consumerAndRecords.get().failedEvents.isEmpty()) &#123;</span><br><span class="line">    e = consumerAndRecords.get().failedEvents.removeFirst();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ( logger.isTraceEnabled() ) &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;Assignment during take: &#123;&#125;&quot;</span>,</span><br><span class="line">          consumerAndRecords.get().consumer.assignment().toString());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">      <span class="keyword">if</span> (!consumerAndRecords.get().recordIterator.hasNext()) &#123;</span><br><span class="line">        consumerAndRecords.get().poll();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (consumerAndRecords.get().recordIterator.hasNext()) &#123;</span><br><span class="line">        ConsumerRecord&lt;String, <span class="keyword">byte</span>[]&gt; record = consumerAndRecords.get().recordIterator.next();</span><br><span class="line">        e = deserializeValue(record.value(), parseAsFlumeEvent);</span><br><span class="line">        TopicPartition tp = <span class="keyword">new</span> TopicPartition(record.topic(), record.partition());</span><br><span class="line">        OffsetAndMetadata oam = <span class="keyword">new</span> OffsetAndMetadata(record.offset() + <span class="number">1</span>, batchUUID);</span><br><span class="line">        consumerAndRecords.get().saveOffsets(tp,oam);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//Add the key to the header</span></span><br><span class="line">        <span class="keyword">if</span> (record.key() != <span class="keyword">null</span>) &#123;</span><br><span class="line">          e.getHeaders().put(KEY_HEADER, record.key());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> endTime = System.nanoTime();</span><br><span class="line">        counter.addToKafkaEventGetTimer((endTime - startTime) / (<span class="number">1000</span> * <span class="number">1000</span>));</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">          logger.debug(<span class="string">&quot;&#123;&#125; processed output from partition &#123;&#125; offset &#123;&#125;&quot;</span>,</span><br><span class="line">              <span class="keyword">new</span> Object[] &#123;getName(), record.partition(), record.offset()&#125;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">      logger.warn(<span class="string">&quot;Error while getting events from Kafka. This is usually caused by &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;trying to read a non-flume event. Ensure the setting for &quot;</span> +</span><br><span class="line">                  <span class="string">&quot;parseAsFlumeEvent is correct&quot;</span>, ex);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> ChannelException(<span class="string">&quot;Error while getting events from Kafka&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  eventTaken = <span class="keyword">true</span>;</span><br><span class="line">  events.get().add(e);</span><br><span class="line">  <span class="keyword">return</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>doTakeå…¶å®å°±æ˜¯ä½¿ç”¨consumeræ¶ˆè´¹kafkaã€‚<em>ç†æƒ³æƒ…å†µä¸‹åº”è¯¥è®©ä¸€ä¸ªconsumeræ¶ˆè´¹å¤šä¸ªtopicçš„ä¸€ä¸ªpartition</em>ï¼Œ<strong>ä½†è¿™é‡Œconsumeræ˜¯å’ŒchannelUUIDå¯¹åº”çš„ï¼Œè€ŒchannelUUIDåˆæ˜¯finalç±»å‹çš„ï¼Œé‚£æ˜¯ä¸æ˜¯è¯´kafkachannelå®ä¾‹ä¸­åªæœ‰ä¸€ä¸ªconsumer</strong>ï¼Ÿ<br>è¿™é‡Œçš„æ¶ˆè´¹é€»è¾‘æ˜¯consumeré€šè¿‡pollå°†æ•°æ®æ‹‰åˆ°æœ¬åœ°å†…å­˜ä¸­ï¼Œç„¶ååœ¨sinkä¸­ä¸€æ¡ä¸€æ¡çš„å–ï¼Œæ¯å–ä¸€æ¡offsetå°±åŠ 1ï¼Œå†…å­˜å–å®Œä¹‹åå†è°ƒç”¨ä¸€æ¬¡pollã€‚<br>sinkæ‹¿åˆ°eventä¹‹åï¼Œæ ¹æ®eventçš„ä¿¡æ¯æ”¾å…¥ç›¸åº”çš„<code>bucketWriter</code>ä¸­ï¼Œå–å‡ºbatchSizeå¤§å°ä¹‹åå°†æ‰€æœ‰çš„bucketWriterè¿›è¡Œä¸€æ¬¡<code>flush</code>ã€‚flushæˆåŠŸä¹‹åè¿›è¡Œ<em>äº‹åŠ¡çš„commit</em>ã€‚</p><p>commitè°ƒç”¨çš„æ˜¯doCommitï¼Œä¸‹é¢çœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doCommit</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  logger.trace(<span class="string">&quot;Starting commit&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.NONE)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.PUT)) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// event taken ensures that we have collected events in this transaction</span></span><br><span class="line">    <span class="comment">// before committing</span></span><br><span class="line">    <span class="comment">// commitä¹‹å‰è¦ä¿è¯å½“å‰äº‹åŠ¡ä¸­çš„eventéƒ½è¢«é‡‡é›†äº†</span></span><br><span class="line">    <span class="keyword">if</span> (consumerAndRecords.get().failedEvents.isEmpty() &amp;&amp; eventTaken) &#123;</span><br><span class="line">      logger.trace(<span class="string">&quot;About to commit batch&quot;</span>);</span><br><span class="line">      <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">      <span class="comment">// æäº¤offset</span></span><br><span class="line">      consumerAndRecords.get().commitOffsets();</span><br><span class="line">      <span class="keyword">long</span> endTime = System.nanoTime();</span><br><span class="line">      counter.addToKafkaCommitTimer((endTime - startTime) / (<span class="number">1000</span> * <span class="number">1000</span>));</span><br><span class="line">      <span class="keyword">if</span> (logger.isDebugEnabled()) &#123;</span><br><span class="line">        logger.debug(consumerAndRecords.get().getCommittedOffsetsString());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> takes = events.get().size();</span><br><span class="line">    <span class="keyword">if</span> (takes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      counter.addToEventTakeSuccessCount(takes);</span><br><span class="line">      events.get().clear();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œoffsetæ˜¯æ‰‹åŠ¨è§¦å‘çš„ï¼Œè°ƒç”¨çš„æ˜¯kafka consumerçš„api<code>consumer.commitSync(offsets)</code>ã€‚<br>å¦‚æœåœ¨commitæˆ–è€…flushçš„è¿‡ç¨‹ä¸­å‘ç”Ÿå¼‚å¸¸ï¼Œåˆ™è¿›è¡Œäº‹åŠ¡å›æ»šï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doRollback</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.NONE)) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (type.equals(TransactionType.PUT)) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// å›æ»šæ¬¡æ•°ç»Ÿè®¡</span></span><br><span class="line">    counter.addToRollbackCounter(events.get().size());</span><br><span class="line">    <span class="comment">// å°†å†…å­˜ä¸­çš„eventæ”¾å…¥failedEventsä¸­</span></span><br><span class="line">    consumerAndRecords.get().failedEvents.addAll(events.get());</span><br><span class="line">    events.get().clear();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>flumeçš„äº‹åŠ¡ä¿è¯äº†æ•°æ®ä¸ä¼šä¸¢å¤±ï¼Œæ˜¯flumeä¸­ä¸€ä¸ªé‡è¦çš„æ¦‚å¿µã€‚</p><h2 id="ç–‘è™‘"><a href="#ç–‘è™‘" class="headerlink" title="ç–‘è™‘"></a>ç–‘è™‘</h2><p>HdfsSink å’Œ kafkachannel consumeréƒ½æ˜¯å•çº¿ç¨‹å—ï¼Ÿ<br>ä¸€ä¸ªkafkachannelå®ä¾‹ä¸€ä¸ªconsumerï¼Œsinkä»consumerä¸­å–æ•°ï¼Œç„¶ååˆ†ç»™ä¸åŒçš„bucketWriterï¼Œå¯ä»¥è®¤ä¸ºconsumeræ˜¯å•çº¿ç¨‹ï¼Œå¤„ç†æ•°æ®æ˜¯å¤šçº¿ç¨‹ï¼Ÿ</p>]]></content>
      
      
      <categories>
          
          <category> Flume </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Flume </tag>
            
            <tag> äº‹åŠ¡ </tag>
            
            <tag> kafkachannel </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>kafka channelå†™å…¥kafkaæŠ¥RecordTooLargeExceptionå¼‚å¸¸</title>
      <link href="/kafka%20channel%E5%86%99%E5%85%A5kafka%E6%8A%A5RecordTooLargeException%E5%BC%82%E5%B8%B8.html"/>
      <url>/kafka%20channel%E5%86%99%E5%85%A5kafka%E6%8A%A5RecordTooLargeException%E5%BC%82%E5%B8%B8.html</url>
      
        <content type="html"><![CDATA[<p>flumeé€šè¿‡kafka channelç›´æ¥å°†æ•°æ®å†™å…¥kafkaæ—¶ï¼Œå¦‚æœproducerä¸€æ¬¡å†™å…¥kafkaçš„æ•°æ®æ¯”è¾ƒå¤§æ—¶ï¼Œä¼šæŠ¥å¼‚å¸¸ï¼Œå¼‚å¸¸å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">15 äº”æœˆ 2017 17:17:09,814 WARN  [PollableSourceRunner-TaildirSource-r-op_hiveserver] (org.apache.flume.channel.kafka.KafkaChannel<span class="variable">$KafkaTransaction</span>.doCommit:560)  - Sending events to Kafka failed</span><br><span class="line">java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.RecordTooLargeException: The message is 1730741 bytes when serialized <span class="built_in">which</span> is larger than the maximum request size you have configured with the max.request.size configuration.</span><br><span class="line">at org.apache.kafka.clients.producer.KafkaProducer<span class="variable">$FutureFailure</span>.&lt;init&gt;(KafkaProducer.java:686)</span><br><span class="line">at org.apache.kafka.clients.producer.KafkaProducer.send(KafkaProducer.java:449)</span><br><span class="line">at org.apache.flume.channel.kafka.KafkaChannel<span class="variable">$KafkaTransaction</span>.doCommit(KafkaChannel.java:546)</span><br><span class="line">at org.apache.flume.channel.BasicTransactionSemantics.commit(BasicTransactionSemantics.java:151)</span><br><span class="line">at org.apache.flume.channel.ChannelProcessor.processEventBatch(ChannelProcessor.java:194)</span><br><span class="line">at org.apache.flume.source.taildir.TaildirSource.tailFileProcess(TaildirSource.java:263)</span><br><span class="line">at org.apache.flume.source.taildir.TaildirSource.process(TaildirSource.java:226)</span><br><span class="line">at org.apache.flume.source.PollableSourceRunner<span class="variable">$PollingRunner</span>.run(PollableSourceRunner.java:133)</span><br><span class="line">at java.lang.Thread.run(Thread.java:745)</span><br><span class="line">Caused by: org.apache.kafka.common.errors.RecordTooLargeException: The message is 1730741 bytes when serialized <span class="built_in">which</span> is larger than the maximum request size you have configured with the max.request.size configuration.</span><br></pre></td></tr></table></figure><p>å‘é€çš„æ•°æ®é‡è¶…è¿‡äº†<code>max.request.size</code>çš„é˜ˆå€¼(é»˜è®¤æ˜¯1048576)ï¼Œé‚£å°±åœ¨kafka channelä¸­å°†æ­¤å‚æ•°è°ƒå¤§ï¼Œ<code>a1.channels.c1.kafka.producer.max.request.size = 10485760</code></p><span id="more"></span><p>æ¥ç€åˆå‡ºç°äº†å¦‚ä¸‹å¼‚å¸¸ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">15 äº”æœˆ 2017 17:20:00,799 WARN  [PollableSourceRunner-TaildirSource-r-op_hiveserver] (org.apache.flume.channel.kafka.KafkaChannel<span class="variable">$KafkaTransaction</span>.doCommit:560)  - Sending events to Kafka failed</span><br><span class="line">java.util.concurrent.ExecutionException: org.apache.kafka.common.errors.RecordTooLargeException: The request included a message larger than the max message size the server will accept.</span><br><span class="line">at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.valueOrError(FutureRecordMetadata.java:56)</span><br><span class="line">at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.get(FutureRecordMetadata.java:43)</span><br><span class="line">at org.apache.kafka.clients.producer.internals.FutureRecordMetadata.get(FutureRecordMetadata.java:25)</span><br><span class="line">at org.apache.flume.channel.kafka.KafkaChannel<span class="variable">$KafkaTransaction</span>.doCommit(KafkaChannel.java:552)</span><br><span class="line">at org.apache.flume.channel.BasicTransactionSemantics.commit(BasicTransactionSemantics.java:151)</span><br><span class="line">at org.apache.flume.channel.ChannelProcessor.processEventBatch(ChannelProcessor.java:194)</span><br><span class="line">at org.apache.flume.source.taildir.TaildirSource.tailFileProcess(TaildirSource.java:263)</span><br><span class="line">at org.apache.flume.source.taildir.TaildirSource.process(TaildirSource.java:226)</span><br><span class="line">at org.apache.flume.source.PollableSourceRunner<span class="variable">$PollingRunner</span>.run(PollableSourceRunner.java:133)</span><br><span class="line">at java.lang.Thread.run(Thread.java:745)</span><br><span class="line">Caused by: org.apache.kafka.common.errors.RecordTooLargeException: The request included a message larger than the max message size the server will accept.</span><br></pre></td></tr></table></figure><p>å¼‚å¸¸å˜äº†ï¼Œå˜æˆ<strong>server ä¸æ¥æ”¶</strong>ï¼Œé‚£å°±æ˜¯è¯´è¿˜å¾—æ”¹kafkaé›†ç¾¤çš„é…ç½®ï¼Œåœ¨<code>server.properties</code>ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®:</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">message.max.bytes=10000120</span><br><span class="line">replica.fetch.max.bytes=10485760  </span><br></pre></td></tr></table></figure><ul><li>message.max.bytesæ˜¯æŒ‡kafkaä¸€æ¬¡èƒ½æ¥æ”¶æ•°æ®çš„ä¸Šé™ï¼Œmessage.max.bytesæ˜¯é’ˆå¯¹æ•´ä¸ªé›†ç¾¤è¿›è¡Œé…ç½®ï¼Œè¿˜å¯ä»¥å¯¹æŸä¸ªtopicè¿›è¡Œé…ç½®ï¼Œå‚æ•°æ˜¯<code>max.message.bytes</code>ï¼Œå‘½ä»¤ä¸º<code>bin/kafka-topics.sh --zookeeper localhost:2181 --alter --topic my-topic --config max.message.bytes=10485760</code></li><li>replica.fetch.max.bytesæ˜¯ä»partitionä¸­è¯»å–æ•°æ®æ—¶çš„ä¸Šé™ï¼Œä½†å¹¶ä¸æ˜¯å†³å¯¹çš„ä¸Šé™ï¼Œå‡å¦‚æŸä¸ªéç©ºpartitionçš„ç¬¬ä¸€æ¡messageçš„å¤§å°è¶…å‡ºäº†æ­¤å€¼ï¼Œä¾ç„¶èƒ½å¤Ÿè¯»å‡ºã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Flume </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
            <tag> è¿ç»´ </tag>
            
            <tag> big data </tag>
            
            <tag> flume </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é‡å¯Kafkaæ—¶ï¼ŒåŠ è½½.indexæ—¶ï¼ŒæŠ¥é”™ï¼šCorrupt index found</title>
      <link href="/kafka-corrupt%20index%20found.html"/>
      <url>/kafka-corrupt%20index%20found.html</url>
      
        <content type="html"><![CDATA[<h2 id="é”™è¯¯å‡ºç°åœºæ™¯"><a href="#é”™è¯¯å‡ºç°åœºæ™¯" class="headerlink" title="é”™è¯¯å‡ºç°åœºæ™¯"></a>é”™è¯¯å‡ºç°åœºæ™¯</h2><p>ä½¿ç”¨<code>kill -9 pid</code>å¼ºåˆ¶é€€å‡ºkafkaè¿›ç¨‹ä¹‹åï¼Œé‡å¯å‡ºç°æ­¤é”™è¯¯ï¼Œæç¤ºä¿¡æ¯å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ERROR There was an error <span class="keyword">in</span> one of the threads during logs loading: java.lang.IllegalArgumentException: requirement failed: Corrupt index found, index file (<span class="variable">$&#123;log.dirs&#125;</span>/<span class="variable">$&#123;topicName&#125;</span>-0/00000000000001964914.index) has non-zero size but the last offset is 1964914 and the base offset is 1964914 (kafka.log.LogManager)</span><br><span class="line">[2016-02-22 18:01:01,213] FATAL [Kafka Server 0], Fatal error during KafkaServer startup. Prepare to shutdown (kafka.server.KafkaServer)</span><br><span class="line">java.lang.IllegalArgumentException: requirement failed: Corrupt index found, index file (<span class="variable">$&#123;log.dirs&#125;</span>/<span class="variable">$&#123;topicName&#125;</span>-0/00000000000001964914.index) has non-zero size but the last offset is 1964914 and the base offset is 1964914</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="è§£å†³æ–¹æ³•"><a href="#è§£å†³æ–¹æ³•" class="headerlink" title="è§£å†³æ–¹æ³•"></a>è§£å†³æ–¹æ³•</h2><p>æŸ¥çœ‹æç¤ºä¿¡æ¯æ˜¯åŠ è½½.indexæ–‡ä»¶æ—¶å‡ºé”™ï¼Œå°†<strong>00000000000001964914.index</strong>åˆ é™¤ï¼Œå†æ¬¡é‡å¯ï¼Œå¯åŠ¨æ­£å¸¸ã€‚</p><h2 id="é”™è¯¯åŸå› åŠè§£å†³æ–¹æ³•åˆ†æ"><a href="#é”™è¯¯åŸå› åŠè§£å†³æ–¹æ³•åˆ†æ" class="headerlink" title="é”™è¯¯åŸå› åŠè§£å†³æ–¹æ³•åˆ†æ"></a>é”™è¯¯åŸå› åŠè§£å†³æ–¹æ³•åˆ†æ</h2><ul><li>Kafkaçš„æ–‡ä»¶å­˜å‚¨æœºåˆ¶</li></ul><blockquote><p>kafkaä¸­çš„messageä»¥topicçš„å½¢å¼å­˜åœ¨ï¼Œtopicåœ¨ç‰©ç†ä¸Šåˆåˆ†ä¸ºå¾ˆå¤šçš„partitionï¼Œpartitionç‰©ç†ä¸Šç”±å¾ˆå¤šsegmentç»„æˆï¼Œsegmentæ˜¯å­˜æ”¾messageçš„çœŸæ­£è½½ä½“ã€‚</p></blockquote><p>ä¸‹é¢å…·ä½“ä»‹ç»ä¸‹segmentæ–‡ä»¶ï¼š<br>(1) æ¯ä¸ªpartition(ç›®å½•)ç›¸å½“äºä¸€ä¸ªå·¨å‹æ–‡ä»¶è¢«å¹³å‡åˆ†é…åˆ°å¤šä¸ªå¤§å°ç›¸ç­‰segment(æ®µ)æ•°æ®æ–‡ä»¶ä¸­ã€‚ä½†æ¯ä¸ªæ®µsegment fileæ¶ˆæ¯æ•°é‡ä¸ä¸€å®šç›¸ç­‰ï¼Œè¿™ç§ç‰¹æ€§æ–¹ä¾¿old segment fileå¿«é€Ÿè¢«åˆ é™¤ã€‚<br>(2) æ¯ä¸ªpartitonåªéœ€è¦æ”¯æŒé¡ºåºè¯»å†™å°±è¡Œäº†ï¼Œsegmentæ–‡ä»¶ç”Ÿå‘½å‘¨æœŸç”±æœåŠ¡ç«¯é…ç½®å‚æ•°å†³å®šã€‚<br>(3) <strong>segment fileç»„æˆï¼šç”±2å¤§éƒ¨åˆ†ç»„æˆï¼Œåˆ†åˆ«ä¸ºindex fileå’Œdata fileï¼Œæ­¤2ä¸ªæ–‡ä»¶ä¸€ä¸€å¯¹åº”ï¼Œæˆå¯¹å‡ºç°ï¼Œåç¼€â€.indexâ€å’Œâ€œ.logâ€åˆ†åˆ«è¡¨ç¤ºä¸ºsegmentç´¢å¼•æ–‡ä»¶ã€æ•°æ®æ–‡ä»¶.</strong><br>(4) segmentæ–‡ä»¶å‘½åè§„åˆ™ï¼špartionå…¨å±€çš„ç¬¬ä¸€ä¸ªsegmentä»0å¼€å§‹ï¼Œåç»­æ¯ä¸ªsegmentæ–‡ä»¶åä¸ºä¸Šä¸€ä¸ªsegmentæ–‡ä»¶æœ€åä¸€æ¡æ¶ˆæ¯çš„offsetå€¼ã€‚æ•°å€¼æœ€å¤§ä¸º64ä½longå¤§å°ï¼Œ19ä½æ•°å­—å­—ç¬¦é•¿åº¦ï¼Œæ²¡æœ‰æ•°å­—ç”¨0å¡«å……ã€‚<br>segmentä¸­index&lt;â€”-&gt;data fileå¯¹åº”å…³ç³»ç‰©ç†ç»“æ„å¦‚ä¸‹ï¼š<br>![indexä¸logæ˜ å°„å…³ç³»](/blogimgs/kafka corrupt index found/kafka-fs-index-correspond-data.png â€œindexä¸logæ˜ å°„å…³ç³»â€)<br><code>.index</code>æ–‡ä»¶å­˜æ”¾çš„æ˜¯messageé€»è¾‘ç›¸å¯¹åç§»é‡ï¼ˆç›¸å¯¹offset=ç»å¯¹offset-base offsetï¼‰ä¸åœ¨ç›¸åº”çš„<code>.log</code>æ–‡ä»¶ä¸­çš„ç‰©ç†ä½ç½®ï¼ˆpositionï¼‰ã€‚ä½†<code>.index</code>å¹¶ä¸æ˜¯ä¸ºæ¯æ¡messageéƒ½æŒ‡å®šåˆ°ç‰©ç†ä½ç½®çš„æ˜ å°„ï¼Œè€Œæ˜¯ä»¥entryä¸ºå•ä½ï¼Œæ¯æ¡entryå¯ä»¥æŒ‡å®šè¿ç»­næ¡æ¶ˆæ¯çš„ç‰©ç†ä½ç½®æ˜ å°„ï¼ˆä¾‹å¦‚ï¼šå‡è®¾æœ‰20000<del>20009å…±10æ¡æ¶ˆæ¯ï¼Œ<code>.index</code>æ–‡ä»¶å¯é…ç½®ä¸ºæ¯æ¡entry<br>æŒ‡å®šè¿ç»­10æ¡æ¶ˆæ¯çš„ç‰©ç†ä½ç½®æ˜ å°„ï¼Œè¯¥ä¾‹ä¸­ï¼Œindex entryä¼šè®°å½•åç§»é‡ä¸º20000çš„æ¶ˆæ¯åˆ°å…¶ç‰©ç†æ–‡ä»¶ä½ç½®ï¼Œä¸€æ—¦è¯¥æ¡æ¶ˆæ¯è¢«å®šä½ï¼Œ20001</del>20009å¯ä»¥å¾ˆå¿«æŸ¥åˆ°ã€‚ï¼‰ã€‚æ¯ä¸ªentryå¤§å°8å­—èŠ‚ï¼Œå‰4ä¸ªå­—èŠ‚æ˜¯è¿™ä¸ªmessageç›¸å¯¹äºè¯¥log segmentç¬¬ä¸€ä¸ªæ¶ˆæ¯offsetï¼ˆbase offsetï¼‰çš„ç›¸å¯¹åç§»é‡ï¼Œå4ä¸ªå­—èŠ‚æ˜¯è¿™ä¸ªæ¶ˆæ¯åœ¨logæ–‡ä»¶ä¸­çš„ç‰©ç†ä½ç½®ã€‚</p><ul><li>Kafkaå¯åŠ¨åŠ è½½logæµç¨‹</li></ul><p>kafkaæ•°æ®logçš„ç®¡ç†ç±»æ˜¯LogManager.scalaï¼Œå…³é”®æºç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LogManager</span>(<span class="params">val logDirs: <span class="type">Array</span>[<span class="type">File</span>],</span></span></span><br><span class="line"><span class="params"><span class="class">                 val topicConfigs: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">LogConfig</span>],</span></span></span><br><span class="line"><span class="params"><span class="class">                 val defaultConfig: <span class="type">LogConfig</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 val cleanerConfig: <span class="type">CleanerConfig</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 ioThreads: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 val flushCheckMs: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 val flushCheckpointMs: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 val retentionCheckMs: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 scheduler: <span class="type">Scheduler</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 val brokerState: <span class="type">BrokerState</span>,</span></span></span><br><span class="line"><span class="params"><span class="class">                 private val time: <span class="type">Time</span></span>) <span class="keyword">extends</span> <span class="title">Logging</span> </span>&#123;</span><br><span class="line">  <span class="keyword">val</span> <span class="type">RecoveryPointCheckpointFile</span> = <span class="string">&quot;recovery-point-offset-checkpoint&quot;</span></span><br><span class="line">  <span class="keyword">val</span> <span class="type">LockFile</span> = <span class="string">&quot;.lock&quot;</span></span><br><span class="line">  <span class="keyword">val</span> <span class="type">InitialTaskDelayMs</span> = <span class="number">30</span>*<span class="number">1000</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> logCreationOrDeletionLock = <span class="keyword">new</span> <span class="type">Object</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> logs = <span class="keyword">new</span> <span class="type">Pool</span>[<span class="type">TopicAndPartition</span>, <span class="type">Log</span>]()</span><br><span class="line"></span><br><span class="line">  createAndValidateLogDirs(logDirs)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> dirLocks = lockLogDirs(logDirs)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> recoveryPointCheckpoints = logDirs.map(dir =&gt; (dir, <span class="keyword">new</span> <span class="type">OffsetCheckpoint</span>(<span class="keyword">new</span> <span class="type">File</span>(dir, <span class="type">RecoveryPointCheckpointFile</span>)))).toMap</span><br><span class="line">  loadLogs()      <span class="comment">//  å…³é”®æ–¹æ³•</span></span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>loadLogs()</code>ä¸­å…ˆåˆ¤æ–­ä¸Šæ¬¡å…³é—­æ˜¯å¦ä¸ºcleanshutdownï¼Œåˆ¤æ–­ä¾æ®ä¸º<code>$&#123;log.dirs&#125;</code>ç›®å½•ä¸­æ˜¯å¦å­˜åœ¨<code>.kafka_cleanshutDown</code>çš„æ–‡ä»¶</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (cleanShutdownFile.exists) &#123;</span><br><span class="line">  debug(</span><br><span class="line">    <span class="string">&quot;Found clean shutdown file. &quot;</span> +</span><br><span class="line">    <span class="string">&quot;Skipping recovery for all logs in data directory: &quot;</span> +</span><br><span class="line">    dir.getAbsolutePath)</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// log recovery itself is being performed by `Log` class during initialization</span></span><br><span class="line">  brokerState.newState(<span class="type">RecoveringFromUncleanShutdown</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åå¼€å§‹åŠ è½½logï¼Œå…¶ä¸­new Logæ–¹æ³•ä¸ºåˆå§‹åŒ–log file å’Œindex file</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> jobsForDir = <span class="keyword">for</span> &#123;</span><br><span class="line">  dirContent &lt;- <span class="type">Option</span>(dir.listFiles).toList</span><br><span class="line">  logDir &lt;- dirContent <span class="keyword">if</span> logDir.isDirectory</span><br><span class="line">&#125; <span class="keyword">yield</span> &#123;</span><br><span class="line">  <span class="type">Utils</span>.runnable &#123;</span><br><span class="line">    debug(<span class="string">&quot;Loading log &#x27;&quot;</span> + logDir.getName + <span class="string">&quot;&#x27;&quot;</span>)</span><br><span class="line">    <span class="comment">//ä»æ–‡ä»¶ç›®å½•ä¸Šè·å¾—topicå’Œpartition</span></span><br><span class="line">    <span class="keyword">val</span> topicPartition = <span class="type">Log</span>.parseTopicPartitionName(logDir.getName)</span><br><span class="line">    <span class="keyword">val</span> config = topicConfigs.getOrElse(topicPartition.topic, defaultConfig)</span><br><span class="line">    <span class="keyword">val</span> logRecoveryPoint = recoveryPoints.getOrElse(topicPartition, <span class="number">0</span>L)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> current = <span class="keyword">new</span> <span class="type">Log</span>(logDir, config, logRecoveryPoint, scheduler, time)</span><br><span class="line">    <span class="keyword">val</span> previous = <span class="keyword">this</span>.logs.put(topicPartition, current)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (previous != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IllegalArgumentException</span>(</span><br><span class="line">        <span class="string">&quot;Duplicate log directories found: %s, %s!&quot;</span>.format(</span><br><span class="line">        current.dir.getAbsolutePath, previous.dir.getAbsolutePath))</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Logä¸­çš„å…³é”®æ–¹æ³•æ˜¯<code>loadSegments()</code>æ–¹æ³•</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">loadSegments</span></span>() &#123;</span><br><span class="line">  <span class="comment">// create the log directory if it doesn&#x27;t exist</span></span><br><span class="line">  dir.mkdirs()</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// first do a pass through the files in the log directory and remove any temporary files </span></span><br><span class="line">  <span class="comment">// and complete any interrupted swap operations</span></span><br><span class="line">  <span class="keyword">for</span>(file &lt;- dir.listFiles <span class="keyword">if</span> file.isFile) &#123;</span><br><span class="line">    <span class="keyword">if</span>(!file.canRead)</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">IOException</span>(<span class="string">&quot;Could not read file &quot;</span> + file)</span><br><span class="line">    <span class="keyword">val</span> filename = file.getName</span><br><span class="line">    <span class="comment">// DeletedFileSuffix = &quot;.deleted&quot;  CleanedFileSuffix = &quot;.cleaned&quot;</span></span><br><span class="line">    <span class="comment">// åˆ é™¤æ‰€æœ‰åç¼€åä¸º.cleanedå’Œ.deleteçš„æ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">if</span>(filename.endsWith(<span class="type">DeletedFileSuffix</span>) || filename.endsWith(<span class="type">CleanedFileSuffix</span>)) &#123;</span><br><span class="line">      <span class="comment">// if the file ends in .deleted or .cleaned, delete it</span></span><br><span class="line">      file.delete()</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(filename.endsWith(<span class="type">SwapFileSuffix</span>)) &#123;   <span class="comment">// SwapFileSuffix = &quot;.swap&quot;</span></span><br><span class="line">      <span class="comment">// we crashed in the middle of a swap operation, to recover:</span></span><br><span class="line">      <span class="comment">// if a log, swap it in and delete the .index file</span></span><br><span class="line">      <span class="comment">// if an index just delete it, it will be rebuilt</span></span><br><span class="line">      <span class="keyword">val</span> baseName = <span class="keyword">new</span> <span class="type">File</span>(<span class="type">Utils</span>.replaceSuffix(file.getPath, <span class="type">SwapFileSuffix</span>, <span class="string">&quot;&quot;</span>))</span><br><span class="line">      <span class="keyword">if</span>(baseName.getPath.endsWith(<span class="type">IndexFileSuffix</span>)) &#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ.swapæ–‡ä»¶æ˜¯indexæ–‡ä»¶ï¼Œåˆ™åˆ é™¤è¯¥index</span></span><br><span class="line">        file.delete()</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span>(baseName.getPath.endsWith(<span class="type">LogFileSuffix</span>))&#123;</span><br><span class="line">      <span class="comment">// å¦‚æœ.swapæ˜¯logæ–‡ä»¶ï¼Œåˆ™åˆ é™¤è¯¥logæ–‡ä»¶å¯¹åº”çš„indexæ–‡ä»¶ï¼Œç„¶åå¤šlogæ–‡ä»¶è¿›è¡Œé‡å‘½å</span></span><br><span class="line">        <span class="comment">// delete the index</span></span><br><span class="line">        <span class="keyword">val</span> index = <span class="keyword">new</span> <span class="type">File</span>(<span class="type">Utils</span>.replaceSuffix(baseName.getPath, <span class="type">LogFileSuffix</span>, <span class="type">IndexFileSuffix</span>))</span><br><span class="line">        index.delete()</span><br><span class="line">        <span class="comment">// complete the swap operation</span></span><br><span class="line">        <span class="keyword">val</span> renamed = file.renameTo(baseName)</span><br><span class="line">        <span class="keyword">if</span>(renamed)</span><br><span class="line">          info(<span class="string">&quot;Found log file %s from interrupted swap operation, repairing.&quot;</span>.format(file.getPath))</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">KafkaException</span>(<span class="string">&quot;Failed to rename file %s.&quot;</span>.format(file.getPath))</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// now do a second pass and load all the .log and .index files</span></span><br><span class="line">  <span class="keyword">for</span>(file &lt;- dir.listFiles <span class="keyword">if</span> file.isFile) &#123;</span><br><span class="line">    <span class="keyword">val</span> filename = file.getName</span><br><span class="line">    <span class="comment">// IndexFileSuffix = &quot;.index&quot; </span></span><br><span class="line">    <span class="keyword">if</span>(filename.endsWith(<span class="type">IndexFileSuffix</span>)) &#123;</span><br><span class="line">      <span class="comment">// if it is an index file, make sure it has a corresponding .log file</span></span><br><span class="line">      <span class="keyword">val</span> logFile = <span class="keyword">new</span> <span class="type">File</span>(file.getAbsolutePath.replace(<span class="type">IndexFileSuffix</span>, <span class="type">LogFileSuffix</span>))</span><br><span class="line">      <span class="keyword">if</span>(!logFile.exists) &#123;</span><br><span class="line">        warn(<span class="string">&quot;Found an orphaned index file, %s, with no corresponding log file.&quot;</span>.format(file.getAbsolutePath))</span><br><span class="line">        <span class="comment">//  å¦‚æœä»…å­˜åœ¨indexæ–‡ä»¶ï¼Œæ²¡æœ‰ç›¸åº”çš„logæ–‡ä»¶ï¼Œåˆ™ç›´æ¥åˆ é™¤indexæ–‡ä»¶</span></span><br><span class="line">        file.delete()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(filename.endsWith(<span class="type">LogFileSuffix</span>)) &#123;    <span class="comment">// LogFileSuffix = &quot;.log&quot;</span></span><br><span class="line">      <span class="comment">// if its a log file, load the corresponding log segment</span></span><br><span class="line">      <span class="keyword">val</span> start = filename.substring(<span class="number">0</span>, filename.length - <span class="type">LogFileSuffix</span>.length).toLong</span><br><span class="line">      <span class="keyword">val</span> hasIndex = <span class="type">Log</span>.indexFilename(dir, start).exists</span><br><span class="line">      <span class="keyword">val</span> segment = <span class="keyword">new</span> <span class="type">LogSegment</span>(dir = dir, </span><br><span class="line">                                   startOffset = start,</span><br><span class="line">                                   indexIntervalBytes = config.indexInterval, </span><br><span class="line">                                   maxIndexSize = config.maxIndexSize,</span><br><span class="line">                                   rollJitterMs = config.randomSegmentJitter,</span><br><span class="line">                                   time = time)</span><br><span class="line">      <span class="comment">// å¦‚æœlogæ–‡ä»¶å¯¹åº”çš„indexæ–‡ä»¶ä¸å­˜åœ¨ï¼Œåˆ™å¯¹indexæ–‡ä»¶è¿›è¡Œrebuild                             </span></span><br><span class="line">      <span class="keyword">if</span>(!hasIndex) &#123;</span><br><span class="line">        error(<span class="string">&quot;Could not find index file corresponding to log file %s, rebuilding index...&quot;</span>.format(segment.log.file.getAbsolutePath))</span><br><span class="line">        segment.recover(config.maxMessageSize)</span><br><span class="line">      &#125;</span><br><span class="line">      segments.put(start, segment)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span>(logSegments.size == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// no existing segments, create a new mutable segment beginning at offset 0</span></span><br><span class="line">    segments.put(<span class="number">0</span>L, <span class="keyword">new</span> <span class="type">LogSegment</span>(dir = dir,</span><br><span class="line">                                   startOffset = <span class="number">0</span>,</span><br><span class="line">                                   indexIntervalBytes = config.indexInterval, </span><br><span class="line">                                   maxIndexSize = config.maxIndexSize,</span><br><span class="line">                                   rollJitterMs = config.randomSegmentJitter,</span><br><span class="line">                                   time = time))</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    recoverLog()</span><br><span class="line">    <span class="comment">// reset the index size of the currently active log segment to allow more entries</span></span><br><span class="line">    activeSegment.index.resize(config.maxIndexSize)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sanity check the index file of every segment to ensure we don&#x27;t proceed with a corrupt segment</span></span><br><span class="line">  <span class="comment">// è¿™é‡Œæ˜¯æŠ¥é”™çš„å…³é”®ä»£ç </span></span><br><span class="line">  <span class="keyword">for</span> (s &lt;- logSegments)</span><br><span class="line">    s.index.sanityCheck()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// OffsetIndex.scala</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Do a basic sanity check on this index to detect obvious problems</span></span><br><span class="line"><span class="comment"> * @throws IllegalArgumentException if any problems are found</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">sanityCheck</span></span>() &#123;</span><br><span class="line"><span class="comment">// é”™è¯¯æç¤ºä¿¡æ¯</span></span><br><span class="line"><span class="comment">// æ­£å¸¸æƒ…å†µä¸‹ æœ€åä¸€ä¸ªindexçš„æ–‡ä»¶å¤§å°ä¸º0ï¼Œ lastoffsetå¤§äºbaseoffset</span></span><br><span class="line">  require(entries == <span class="number">0</span> || lastOffset &gt; baseOffset,</span><br><span class="line">          <span class="string">&quot;Corrupt index found, index file (%s) has non-zero size but the last offset is %d and the base offset is %d&quot;</span></span><br><span class="line">          .format(file.getAbsolutePath, lastOffset, baseOffset))</span><br><span class="line">    <span class="keyword">val</span> len = file.length()</span><br><span class="line">    require(len % <span class="number">8</span> == <span class="number">0</span>,</span><br><span class="line">            <span class="string">&quot;Index file &quot;</span> + file.getName + <span class="string">&quot; is corrupt, found &quot;</span> + len +</span><br><span class="line">            <span class="string">&quot; bytes which is not positive or not a multiple of 8.&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç”±ä¸Šè¿°ä»£ç å¯è§ï¼ŒkafkaåŠ è½½logçš„å¤§è‡´æµç¨‹ä¸ºï¼š<br>1ã€ æ£€æŸ¥ä¸Šæ¬¡å…³é—­kafkaæ˜¯å¦ä¸ºclean shutdown<br>2ã€ åˆ é™¤æ‰€æœ‰åç¼€åä¸º.cleanedå’Œ.deleteçš„æ–‡ä»¶<br>3ã€ å¯¹äº.swpç»“å°¾çš„æ–‡ä»¶ï¼Œå¦‚æœæ˜¯logæ–‡ä»¶åˆ™ç›´æ¥æ¢å¤(å»æ‰.swp, å˜ä¸º.log)ï¼›                      å¦‚æœæ˜¯indexæ–‡ä»¶ç›´æ¥åˆ æ‰ï¼ˆç„¶årebuild indexæ–‡ä»¶ï¼‰ï¼›<br>4ã€ å¯¹äº.indexæ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰å¯¹åº”çš„.logæ–‡ä»¶(åŒä¸€ä¸ªlogSementå…¶indexå’Œlogçš„ä¸»æ–‡ä»¶åç›¸åŒ), åˆ™åˆ é™¤è¯¥indexæ–‡ä»¶ï¼›<br>5ã€ å¯¹äº.logæ–‡ä»¶ï¼ŒåŠ è½½å…¥å†…å­˜ï¼›å¦‚æœå…¶æ²¡æœ‰å¯¹åº”çš„.indexæ–‡ä»¶ï¼ˆå¯èƒ½åœ¨ç¬¬&lt;2&gt;æ­¥ä¸­è¢«åˆ é™¤), é‡æ–°æ¢å¤å…¶indexæ–‡ä»¶ï¼›<br>6ã€ å¦‚æœKafkaå·²ç»åŠ è½½åˆ°log, åˆ™å¼€å§‹recover log segments<br>7ã€ æœ€ååšsanityCheck, ä¸»è¦æ˜¯æ£€æŸ¥æ¯ä¸ªlog sementçš„indexæ–‡ä»¶ï¼Œç¡®ä¿ä¸ä¼šåŠ è½½ä¸€ä¸ªå‡ºé”™çš„Log Segment</p></blockquote><ul><li>æ¨ç†éªŒè¯</li></ul><p>æŸ¥çœ‹å…ˆå‰å‡ºç°å¼‚å¸¸æ—¶å¤‡ä»½kafka <code>.log</code> å’Œ<code>.index</code>æ–‡ä»¶ï¼Œä½¿ç”¨<code>ll</code>å‘½ä»¤æŸ¥çœ‹æ–‡ä»¶çš„å¤§å°ï¼ˆè¿™é‡Œè¯´ä¸‹<code>ll</code>å’Œ<code>du</code>çš„åŒºåˆ«ï¼Œ<code>du</code>æŸ¥çœ‹çš„æ˜¯æ–‡ä»¶å ç”¨çš„ç£ç›˜å—çš„å¤§å°ï¼Œè€Œ<code>ll</code>æŸ¥çœ‹çš„æ˜¯æ–‡ä»¶å¤§å°ï¼‰å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-rw-rw-r-- 1 username username    1678200 Feb 22 17:43 00000000000000163891.index</span><br><span class="line">-rw-rw-r-- 1 username username 1073741823 Feb 22 16:16 00000000000000163891.log</span><br><span class="line">-rw-rw-r-- 1 username username    1666008 Feb 22 17:43 00000000000001131903.index</span><br><span class="line">-rw-rw-r-- 1 username username 1073741375 Feb 22 16:42 00000000000001131903.log</span><br><span class="line">-rw-rw-r-- 1 username username   10485760 Feb 22 18:01 00000000000001964914.index</span><br><span class="line">-rw-rw-r-- 1 username username  834044222 Feb 22 17:31 00000000000001964914.log</span><br></pre></td></tr></table></figure><p>å‘ç°<code>00000000000001964914.index</code> çš„å¤§å°ä¸º<code>10485760b</code>ï¼Œå³10Mï¼Œå°†å…¶åˆ é™¤å¯ä»¥æ­£å¸¸å¯åŠ¨ã€‚</p><h2 id="indexä¸ºä»€ä¹ˆä¼šå‘ç”ŸæŸå"><a href="#indexä¸ºä»€ä¹ˆä¼šå‘ç”ŸæŸå" class="headerlink" title="indexä¸ºä»€ä¹ˆä¼šå‘ç”ŸæŸå"></a>indexä¸ºä»€ä¹ˆä¼šå‘ç”ŸæŸå</h2><p><code>.index</code>æ–‡ä»¶æ˜¯ä¸€ä¸ªç´¢å¼•æ–‡ä»¶æ˜ å°„ï¼Œå®ƒä¸ä¼šå¯¹æ¯æ¡æ¶ˆæ¯éƒ½ç´¢å¼•,æ‰€ä»¥æ˜¯ç¨€ç–æ–‡ä»¶ã€‚<br>kafkaè¿è¡Œæ—¶ä¼šåˆ›å»ºä¸€ä¸ª<code>log.index.size.max.bytes</code>å¤§å°çš„<code>.index</code>æ–‡ä»¶ï¼Œå‘å…¶ä¸­å†™å…¥ç¨€ç–ç´¢å¼•ï¼Œå†…å®¹è¾¾åˆ°é˜ˆå€¼ä¼šè¿›è¡Œrollã€‚<br><code>.index</code>çš„ä¸­ç´¢å¼•å¹¶ä¸æ˜¯å¾€<code>.log</code>ä¸­å†™ä¸€æ¡messageå°±å†™å…¥ä¸€æ¡ç´¢å¼•ï¼Œè€Œæ˜¯é—´éš”<code>indexIntervalBytes</code>å¤§å°ä¹‹åæ‰å†™å…¥ä¸€æ¡ç´¢å¼•æ¡ç›®</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Append the given messages starting with the given offset. Add an entry to the index if needed.</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">append</span></span>(offset: <span class="type">Long</span>, messages: <span class="type">ByteBufferMessageSet</span>) &#123;</span><br><span class="line">  <span class="keyword">if</span> (messages.sizeInBytes &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(bytesSinceLastIndexEntry &gt; indexIntervalBytes) &#123;</span><br><span class="line">      index.append(offset, log.sizeInBytes())             <span class="comment">// append an entry to the index (if needed)</span></span><br><span class="line">      <span class="keyword">this</span>.bytesSinceLastIndexEntry = <span class="number">0</span>                   <span class="comment">// æˆåŠŸå†™ä¸€æ¬¡ç´¢å¼•å,é‡ç½®ä¸º0</span></span><br><span class="line">    &#125;</span><br><span class="line">    log.append(messages)                                  <span class="comment">// append the messages</span></span><br><span class="line">    <span class="keyword">this</span>.bytesSinceLastIndexEntry += messages.sizeInBytes <span class="comment">// ç»Ÿè®¡å€¼å¢åŠ ,ç”¨äºåˆ¤æ–­æ˜¯å¦éœ€è¦å†™ç´¢å¼•</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äº<code>.index</code>æ–‡ä»¶æ˜¯ç¨€ç–æ–‡ä»¶ï¼Œæ‰€ä»¥éœ€è¦å¯¹å…¶è¿›è¡Œcompactedï¼Œåœ¨ä½¿ç”¨kill -9 æ—¶å¯èƒ½ä¼šå¯¼è‡´kafka å¯¹<code>.index</code>æ–‡ä»¶compactedå¤±è´¥ã€‚</p><h2 id="ç›¸å…³patch"><a href="#ç›¸å…³patch" class="headerlink" title="ç›¸å…³patch"></a>ç›¸å…³patch</h2><p><a href="https://issues.apache.org/jira/browse/KAFKA-1791">https://issues.apache.org/jira/browse/KAFKA-1791</a><br><a href="https://issues.apache.org/jira/browse/KAFKA-1554">https://issues.apache.org/jira/browse/KAFKA-1554</a><br>patch1554å¯¹å…¶è¿›è¡Œäº†ä¿®å¤ï¼Œä½†ä¿®å¤çš„é€»è¾‘ä¹Ÿå°±æŠŠç›¸å…³<code>.index</code>åˆ é™¤ï¼Œä»£ç å¦‚ä¸‹</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sanity check the index file of every segment to ensure we don&#x27;t proceed with a corrupt segment</span></span><br><span class="line"><span class="comment">// delete any corrupt index file. It will be rebuilt</span></span><br><span class="line"><span class="keyword">for</span> (s &lt;- logSegments) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    s.index.sanityCheck()</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">catch</span> &#123;</span><br><span class="line">    <span class="keyword">case</span> e: <span class="type">IllegalArgumentException</span> =&gt;</span><br><span class="line">      warn(<span class="string">&quot;Found a corrupt index file %s. Deleting it, will be rebuilt&quot;</span>.format(s.index.file.getAbsolutePath))</span><br><span class="line">      <span class="comment">// åˆ é™¤ç›¸å…³indexæ–‡ä»¶</span></span><br><span class="line">      s.index.delete()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>éœ€è¦æ³¨æ„çš„æ˜¯sanity checkçš„ä½ç½®å‘ç”Ÿäº†å˜åŒ–ï¼Œåœ¨åŠ è½½<code>.log</code>å’Œ<code>.index</code>æ–‡ä»¶ä¹‹å‰å…ˆè¿›è¡Œæ£€æŸ¥ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://tech.meituan.com/kafka-fs-design-theory.html">http://tech.meituan.com/kafka-fs-design-theory.html</a><br><a href="http://blog.csdn.net/jsky_studio/article/details/42012561">http://blog.csdn.net/jsky_studio/article/details/42012561</a><br><a href="http://zqhxuyuan.github.io/2016/01/10/2016-01-10-Kafka_LogAppend/#handleProducerRequest">http://zqhxuyuan.github.io/2016/01/10/2016-01-10-Kafka_LogAppend/#handleProducerRequest</a></p>]]></content>
      
      
      <categories>
          
          <category> Kafka </category>
          
      </categories>
      
      
        <tags>
            
            <tag> kafka </tag>
            
            <tag> è¿ç»´ </tag>
            
            <tag> big data </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åˆ©ç”¨zookeeperç›‘æ§flumeè¿›ç¨‹æŠ¥è­¦</title>
      <link href="/%E5%88%A9%E7%94%A8zookeeper%E7%9B%91%E6%8E%A7flume%E8%BF%9B%E7%A8%8B%E6%8A%A5%E8%AD%A6.html"/>
      <url>/%E5%88%A9%E7%94%A8zookeeper%E7%9B%91%E6%8E%A7flume%E8%BF%9B%E7%A8%8B%E6%8A%A5%E8%AD%A6.html</url>
      
        <content type="html"><![CDATA[<p>åˆ©ç”¨flumeè¿›è¡Œæ—¥å¿—é‡‡é›†å·²åœ¨ä¸šç•Œå¹¿æ³›ä½¿ç”¨ï¼Œå¦‚æœéœ€è¦é‡‡é›†çš„logæ¯”è¾ƒå¤šï¼Œå¹¶ä¸”åˆ†å¸ƒåœ¨å¤šä¸ªæœåŠ¡å™¨ä¸Šï¼Œé‚£ä¹ˆå¯¹flume agentçš„ç®¡ç†å°±æ˜¯ä¸€ä¸ªå¤´ç–¼çš„äº‹æƒ…ã€‚<br>æœ¬ç¯‡ä¸»è¦ä»‹ç»ä¸‹åˆ©ç”¨zookeeperå¯¹flumeè¿›ç¨‹è¿›è¡Œç›‘æ§ï¼Œå½“flumeå¼‚å¸¸é€€å‡ºæ—¶è¿›è¡ŒæŠ¥è­¦ï¼Œä»¥è‡³äºæˆ‘ä»¬èƒ½å¤ŸåŠæ—¶çš„å‘ç°æ•…éšœè§£å†³æ•…éšœã€‚</p><span id="more"></span><p>æ€è·¯å¾ˆç®€å•ï¼Œå…¶å®å¼€å‘èµ·æ¥ä¹Ÿå¾ˆç®€å•ï¼Œå˜¿å˜¿ã€‚ã€‚<br>ä¸»è¦æ˜¯åˆ©ç”¨äº†zookeeperä¸´æ—¶èŠ‚ç‚¹çš„åŠŸèƒ½ï¼Œå½“flume agentå¯åŠ¨æ—¶ä¸zkå»ºç«‹è¿æ¥åˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹ï¼Œå¹¶å‘¨æœŸçš„ä¸zkè¿›è¡Œå¿ƒè·³ï¼Œå½“flumeå‘ç”Ÿå¼‚å¸¸é€€å‡ºç¨‹åºæ—¶ï¼Œä¸zkçš„å¿ƒè·³å¤±è´¥ï¼Œå¯¼è‡´ä¸´æ—¶èŠ‚ç‚¹è¢«zkåˆ é™¤ï¼Œç›‘å¬åˆ°è¿™ä¸ªäº‹ä»¶ä¹‹åå°±å¯ä»¥è¿›è¡ŒæŠ¥è­¦ï¼Œè¾¾åˆ°ç›‘æ§çš„ç›®çš„ã€‚</p><p>æ˜¯ä¸æ˜¯å¾ˆç®€å•ï¼Œä½†æ˜¯å¦‚æœåªå°±è¿™æ ·å»å¼€å‘ä¸Šçº¿æ˜¯æœ‰ä¸ªbugçš„ï¼Œå½“ä½ æ­£å¸¸é€€å‡ºflumeè¿›ç¨‹æ—¶ï¼Œzkä¸Šçš„ä¸´æ—¶èŠ‚ç‚¹ä¹Ÿä¼šè¢«åˆ é™¤ï¼ŒåŒæ ·ä¼šç›‘å¬åˆ°æ­¤äº‹ä»¶ï¼Œä¹Ÿä¼šæŠ¥è­¦ã€‚<strong>å…¶å®æˆ‘ä»¬åº”è¯¥ç»™æ¯ä¸ªflume agentåœ¨zkä¸Šåˆ›å»ºä¸€ä¸ªä¸´æ—¶èŠ‚ç‚¹çš„åŒæ—¶ä¹Ÿåº”è¯¥åˆ›å»ºä¸€ä¸ªæ°¸ä¹…æ€§èŠ‚ç‚¹ï¼Œè¿™ä¸ªæ°¸ä¹…æ€§èŠ‚ç‚¹ç”¨æ¥æ ‡è¯†æ­¤agentçš„ä¿¡æ¯ï¼Œå½“agentå¼‚å¸¸é€€å‡ºæ—¶ï¼Œä¸´æ—¶æ€§èŠ‚ç‚¹ä¼šè¢«åˆ é™¤ä½†æ°¸ä¹…æ€§èŠ‚ç‚¹ä¸ä¼šè¢«åˆ é™¤ï¼Œè¿™æ ·å½“watcherç›‘å¬åˆ°ä¸´æ—¶èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œå¹¶ä¸”æ£€æµ‹åˆ°æ°¸ä¹…æ€§èŠ‚ç‚¹å¹¶æ²¡æœ‰è¢«åˆ é™¤ï¼Œé‚£å°±å¯ä»¥æ–­å®šagentæ˜¯å¼‚å¸¸é€€å‡ºï¼Œéœ€è¦æŠ¥è­¦ï¼Œå½“agentæ­£å¸¸é€€å‡ºæ—¶ï¼Œä¼šå°†æ°¸ä¹…æ€§èŠ‚ç‚¹åˆ é™¤ï¼ŒåŒæ ·ä¸´æ—¶èŠ‚ç‚¹ä¹Ÿä¼šè¢«åˆ é™¤ï¼Œè¿™æ ·watcherç›‘å¬åˆ°ä¸´æ—¶èŠ‚ç‚¹è¢«åˆ é™¤å»æ£€æµ‹æ°¸ä¹…æ€§èŠ‚ç‚¹æ—¶ï¼Œå‘ç°ä¹Ÿè¢«åˆ é™¤äº†ï¼Œå°±å¯ä»¥æ–­å®šæ­¤agentæ˜¯æ­£å¸¸é€€å‡ºï¼Œä¸éœ€è¦æŠ¥è­¦ã€‚</strong></p><p>æ­¤æ€è·¯å€Ÿé‰´äº†HDFS HAæœºåˆ¶ï¼Œä¹‹æ‰€ä»¥åˆ©ç”¨zookeeperæ¥è¿›è¡Œç›‘æ§æ˜¯å› ä¸ºæˆ‘ä»¬æ˜¯å°†flumeé‡‡é›†çš„logå†™å…¥kafkaï¼Œè¿™æ ·zookeeperå·²æ˜¯æˆ‘ä»¬çš„ç»„ä»¶ä¹‹ä¸€ï¼Œé‡å¤åˆ©ç”¨ç°æœ‰çš„ç»„ä»¶å¯ä»¥å‡å°‘æˆ‘ä»¬çš„ç»´æŠ¤é‡å’Œå¼€å‘é‡ï¼Œå¹¶ä¸”zookeeperé¿å…å•ç‚¹æ•…éšœï¼Œä¹Ÿä¸ç”¨æˆ‘ä»¬è‡ªå·±å¼€å‘å¿ƒè·³æ¨¡å—å’Œç›‘å¬æ¨¡å—ï¼Œå¼€å‘é‡å¾ˆå°ã€‚</p><p>æ‰¯äº†é‚£ä¹ˆå¤šæ¥ç‚¹å¹²è´§å§ã€‚</p><p>æˆ‘æ²¡æœ‰ç›´æ¥åœ¨agentçš„å¯åŠ¨æµç¨‹ä¸­æ·»åŠ ä¸zkçš„è¿æ¥ï¼Œæ„Ÿè§‰è¿™æ ·å¯¹flumeçš„ä¾µå…¥æ€§å¤ªå¤§äº†ï¼Œè€Œæ˜¯å¼•å…¥äº†<a href="https://github.com/cloudera/flume/blob/master/flume-core/src/main/java/com/cloudera/flume/watchdog/Watchdog.java">watchdog</a>,åœ¨watchdogä¸­æ·»åŠ ç›¸å…³ä»£ç ã€‚</p><blockquote><p>watchdog æ˜¯è€ç‰ˆflumeä¸­çš„ç»„ä»¶ï¼Œç”¨æ¥ç›‘æ§agentè¿›ç¨‹ï¼Œå½“agentå¼‚å¸¸é€€å‡ºä¹‹åè¿›è¡Œé‡å¯ã€‚watchdogçš„å…·ä½“ä»£ç å¯ä»¥å‚è€ƒgithubï¼Œæˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†ä¿®æ”¹ã€‚</p></blockquote><p>åœ¨watchdogçš„<code>startup</code>ä¸­ä¸zkå»ºç«‹è¿æ¥ï¼Œzk clientç”¨çš„æ˜¯<a href="http://curator.apache.org/">Curator</a> ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">startup</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">...</span><br><span class="line">    <span class="comment">// ä¸zkå»ºç«‹è¿æ¥</span></span><br><span class="line">CuratorFramework client = CuratorFrameworkFactory.newClient(ZK_ADDRESS, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">    client.start();</span><br><span class="line">    <span class="comment">// åˆ›å»ºæ°¸ä¹…èŠ‚ç‚¹</span></span><br><span class="line">    client.create().withMode(CreateMode.PERSISTENT).forPath(PATH_P + <span class="string">&quot;/test&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹</span></span><br><span class="line">    client.create().withMode(CreateMode.EPHEMERAL).forPath(PATH + <span class="string">&quot;/test&quot;</span>, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>]);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>agentç«¯çš„ä»£ç å°±ç®—ç»“æŸäº†ï¼Œæˆ‘ä»¬éœ€è¦å†èµ·ä¸€ä¸ªæœåŠ¡æ¥ç›‘å¬zkä¸ŠèŠ‚ç‚¹çš„ä¿¡æ¯ã€‚</p><p>ç›‘å¬æœåŠ¡æˆ‘ä½¿ç”¨çš„æ˜¯Curatorçš„<code>PathCache</code>æ¥ç›‘å¬ä¸€ä¸ªç›®å½•çš„æ‰€æœ‰å­èŠ‚ç‚¹çš„deleteäº‹ä»¶ã€‚æ­¤æœåŠ¡åœ¨ä¸zkå»ºç«‹è¿æ¥æ—¶æ³¨å†Œä¸€ä¸ªwatcherï¼Œä»£ç æ˜¯åœ¨PathCacheçš„exampleçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¿®æ”¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line"></span><br><span class="line">    CuratorFramework client = <span class="keyword">null</span>;</span><br><span class="line">    PathChildrenCache cache = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span></span><br><span class="line">    &#123;</span><br><span class="line">        client = CuratorFrameworkFactory.newClient(ZK_ADDRESS, <span class="keyword">new</span> ExponentialBackoffRetry(<span class="number">1000</span>, <span class="number">3</span>));</span><br><span class="line">        client.start();</span><br><span class="line">        <span class="comment">// path cache ç±»ä¼¼ zkä¸­çš„watcher</span></span><br><span class="line">        <span class="comment">// in this example we will cache data. Notice that this is optional.</span></span><br><span class="line">        cache = <span class="keyword">new</span> PathChildrenCache(client, PATH, <span class="keyword">true</span>);</span><br><span class="line">        cache.start();</span><br><span class="line">        <span class="comment">// ç»™cacheæ³¨å†Œç›‘å¬å™¨ï¼Œå¯¹ç›¸åº”äº‹ä»¶è¿›è¡Œå¤„ç†</span></span><br><span class="line">        addListener(cache);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">finally</span></span><br><span class="line">    &#123;</span><br><span class="line">        CloseableUtils.closeQuietly(cache);</span><br><span class="line">        CloseableUtils.closeQuietly(client);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addListener</span><span class="params">(PathChildrenCache cache)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">// a PathChildrenCacheListener is optional. Here, it&#x27;s used just to log changes</span></span><br><span class="line">    PathChildrenCacheListener listener = <span class="keyword">new</span> PathChildrenCacheListener()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception</span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            <span class="keyword">switch</span> ( event.getType() )</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="keyword">case</span> CHILD_ADDED:</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Node added: &quot;</span> + ZKPaths.getNodeFromPath(event.getData().getPath()));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> CHILD_UPDATED:</span><br><span class="line">                &#123;</span><br><span class="line">                    System.out.println(<span class="string">&quot;Node changed: &quot;</span> + ZKPaths.getNodeFromPath(event.getData().getPath()));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">case</span> CHILD_REMOVED:</span><br><span class="line">                &#123;</span><br><span class="line">                System.out.println(<span class="string">&quot;åˆ¤æ–­æ°¸ä¹…èŠ‚ç‚¹æ˜¯å¦å­˜åœ¨ï¼Œå†³å®šæ˜¯å¦æŠ¥è­¦&quot;</span>);</span><br><span class="line">                    System.out.println(<span class="string">&quot;Node removed: &quot;</span> + ZKPaths.getNodeFromPath(event.getData().getPath()));</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    cache.getListenable().addListener(listener);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæœåŠ¡æ¯”è¾ƒç®€å•ï¼Œå°±ä¸€ä¸ªç±»ï¼Œæ‰“ç®—éšåå°†å…¶é›†æˆåˆ°è‡ªåŠ¨åŒ–éƒ¨ç½²å¹³å°ä¸­ï¼Œä¸Šé¢åªæ˜¯ä¼ªä»£ç ï¼Œè¯¦ç»†ä»£ç ä»¥åæœ‰æ—¶é—´å†ä¸å…¨ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Flume </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Flume </tag>
            
            <tag> zookeeper </tag>
            
            <tag> ç›‘æ§ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo-nextä¸»é¢˜æ·»åŠ è¿‘æœŸæ–‡ç« ç‰ˆå—</title>
      <link href="/hexo-next%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0%E8%BF%91%E6%9C%9F%E6%96%87%E7%AB%A0%E7%89%88%E5%9D%97.html"/>
      <url>/hexo-next%E4%B8%BB%E9%A2%98%E6%B7%BB%E5%8A%A0%E8%BF%91%E6%9C%9F%E6%96%87%E7%AB%A0%E7%89%88%E5%9D%97.html</url>
      
        <content type="html"><![CDATA[<p>å‰å‡ å¤©çœ‹åˆ°åˆ«äººçš„åšå®¢æœ‰ä¸ªè¿‘æœŸæ–‡ç« ç‰ˆå—ï¼Œæ„Ÿè§‰æŒºå¥½ï¼Œäºæ˜¯å°±æƒ³ç»™è‡ªå·±çš„åšå®¢ä¹ŸåŠ è¿™ä¹ˆä¸ªåŠŸèƒ½ã€‚ç”±äºä½¿ç”¨çš„æ˜¯nextä¸»é¢˜ï¼Œè€Œnexté»˜è®¤æ˜¯æ²¡æœ‰è¿™ä¸ªç‰ˆå—çš„ï¼Œé‚£å°±è‡ªå·±æä¸€ä¸ªå§ã€‚åºŸè¯ä¸å¤šè¯´ï¼Œç›´æ¥ä¸Šä»£ç ï¼ŒæŒºç®€å•çš„ã€‚</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&#123;% if theme.recent_posts %&#125;</span><br><span class="line">    &lt;div class=&quot;links-of-blogroll motion-element &#123;&#123; &quot;links-of-blogroll-&quot; + theme.recent_posts_layout  &#125;&#125;&quot;&gt;</span><br><span class="line">      &lt;div class=&quot;links-of-blogroll-title&quot;&gt;</span><br><span class="line">        &lt;!-- modify icon to fire by szw --&gt;</span><br><span class="line">        &lt;i class=&quot;fa fa-history fa-&#123;&#123; theme.recent_posts_icon | lower &#125;&#125;&quot; aria-hidden=&quot;true&quot;&gt;&lt;/i&gt;</span><br><span class="line">        &#123;&#123; theme.recent_posts_title &#125;&#125;</span><br><span class="line">      &lt;/div&gt;</span><br><span class="line">      &lt;ul class=&quot;links-of-blogroll-list&quot;&gt;</span><br><span class="line">        &#123;% set posts = site.posts.sort(&#x27;-date&#x27;) %&#125;</span><br><span class="line">        &#123;% for post in posts.slice(&#x27;0&#x27;, &#x27;5&#x27;) %&#125;</span><br><span class="line">          &lt;li&gt;</span><br><span class="line">            &lt;a href=&quot;&#123;&#123; url_for(post.path) &#125;&#125;&quot; title=&quot;&#123;&#123; post.title &#125;&#125;&quot; target=&quot;_blank&quot;&gt;&#123;&#123; post.title &#125;&#125;&lt;/a&gt;</span><br><span class="line">          &lt;/li&gt;</span><br><span class="line">        &#123;% endfor %&#125;</span><br><span class="line">      &lt;/ul&gt;</span><br><span class="line">    &lt;/div&gt;</span><br><span class="line">&#123;% endif %&#125;  </span><br></pre></td></tr></table></figure><p>å°†æ­¤ä»£ç è´´åœ¨<code>next/layout/_macro/sidebar.swig</code>ä¸­çš„<code>if theme.links</code>å¯¹åº”çš„<code>endif</code>åé¢ï¼Œå°±okäº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚ã€‚ã€‚ã€‚<br>ä¸ºäº†é…ç½®æ–¹ä¾¿ï¼Œåœ¨ä¸»é¢˜çš„<code>_config.yml</code>ä¸­æ·»åŠ äº†å‡ ä¸ªå˜é‡ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">recent_posts_title: è¿‘æœŸæ–‡ç« </span><br><span class="line">recent_posts_layout: block</span><br><span class="line">recent_posts: true</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> next </tag>
            
            <tag> è¿‘æœŸæ–‡ç«  </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceåº”ç”¨å®ä¾‹--äºŒæ¬¡æ’åºä¹‹reduceå†…æœ‰åº</title>
      <link href="/MapReduce%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B--%E4%BA%8C%E6%AC%A1%E6%8E%92%E5%BA%8F%E4%B9%8Breduce%E5%86%85%E6%9C%89%E5%BA%8F.html"/>
      <url>/MapReduce%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B--%E4%BA%8C%E6%AC%A1%E6%8E%92%E5%BA%8F%E4%B9%8Breduce%E5%86%85%E6%9C%89%E5%BA%8F.html</url>
      
        <content type="html"><![CDATA[<p>MapReduceå¤©ç”Ÿå°±å…·æœ‰æ’åºçš„ç‰¹æ€§ï¼Œä½†æ˜¯é¢å¯¹ç¨å¾®å¤æ‚çš„æ’åºæ—¶æˆ‘ä»¬è¿˜æ˜¯å¸Œæœ›èƒ½å¤Ÿå……åˆ†åˆ©ç”¨å…¶è‡ªèº«çš„è®¾è®¡åŸç†æ¥è¾¾åˆ°æˆ‘ä»¬çš„ç›®çš„ã€‚å…¶ä¸­äºŒæ¬¡æ’åºå°±æ˜¯ä¸€ä¸ªå¾ˆå¥½çš„ä¾‹å­ï¼Œä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹äºŒæ¬¡æ’åºã€‚</p><p>äºŒæ¬¡æ’åºçš„åœºæ™¯æ˜¯ä¸ä»…éœ€è¦å¯¹keyæ’åºä¾ç„¶éœ€è¦å¯¹valueä¸­çš„æŸä¸ªå€¼è¿›è¡Œæ’åºï¼Œä¹Ÿå°±æ˜¯å…ˆå¯¹keyæ’åºç„¶åå¯¹ç›¸åŒkeyçš„recordå†å¯¹valueè¿›è¡Œæ’åºã€‚</p><p>å¯¹keyæ’åºæˆ‘ä»¬å¯ä»¥ä½¿ç”¨MRè‡ªèº«çš„æ’åºï¼Œä½†æ˜¯æ€ä¹ˆå¯¹valueä¸­çš„æŸä¸ªå€¼è¿›è¡Œæ’åºå‘¢ï¼Ÿ</p><p>MapReduceç•™å‡ºäº†å¾ˆå¤šå¯ä»¥è‡ªå®šä¹‰çš„æ¥å£ï¼Œæ¯”å¦‚partitionã€comparatorå’Œgroupç­‰ç­‰æ¥å£ï¼Œè¿™é‡Œåªéœ€ç”¨åˆ°è¿™ä¸‰ä¸ªï¼Œå…¶å®ƒä»¥åç”¨çš„æ¥å£å†ä»‹ç»ã€‚</p><span id="more"></span><blockquote><p>ä¹‹å‰æœ‰å‡ ç¯‡ä»‹ç»MapReduceæµç¨‹çš„blogï¼Œå¯ä»¥è‡ªè¡Œæœç´¢ï¼Œå…³é”®å­—ä¸º<em>MapReduceæºç è§£æ</em>ã€‚</p></blockquote><p>ç†Ÿæ‚‰MapReduceæµç¨‹çš„åŒå­¦ä¼šçŸ¥é“keyçš„<em>ç¬¬ä¸€æ¬¡æ’åº</em>å‘ç”Ÿåœ¨mapç«¯çš„sortAndSpillé˜¶æ®µï¼Œæ­¤é˜¶æ®µæ˜¯å°†<em>å†…å­˜ä¸­çš„æ•°æ®å…ˆæ ¹æ®partitionè¿›è¡Œæ’åºç„¶åå†å¯¹keyæ’åº(æ’åºç®—æ³•æ˜¯æ”¹è¿›çš„å¿«æ’)<em>ï¼Œ</em>ç¬¬äºŒæ¬¡æ’åº</em>å‘ç”Ÿåœ¨reduceç«¯çš„mergeé˜¶æ®µï¼Œæ­¤é˜¶æ®µæ˜¯å°†ä»mapç«¯copyæ¥çš„segment(<em>å±€éƒ¨æœ‰åºçš„æ•°æ®ï¼Œå±€éƒ¨æœ‰åºçš„åŸå› æ˜¯mapç«¯å·²å°†æ•°æ®æŒ‰keyæ’åºï¼Œreduce copyæ—¶ä»nä¸ªmapä¸­å°†æ­¤reduceéœ€è¦çš„æ•°æ®å¤åˆ¶è¿‡æ¥ï¼Œåˆ™æ¯ä¸ªmapå†…çš„æ•°æ®æ˜¯æœ‰åºçš„ï¼Œè€Œå„ä¸ªmapä¹‹é—´çš„æ•°æ®æ˜¯æ— åºçš„</em>)è¿›è¡Œå †æ’åºï¼Œä½¿æ•°æ®æŒ‰ç…§keyæœ‰åºã€‚(<em>è¿™é‡Œçš„ç¬¬äºŒæ¬¡æ’åºå…¶å®ä¹Ÿå¯ä»¥è¯´æ˜¯ç¬¬ä¸‰æ¬¡æ’åº</em>ï¼Œå› ä¸ºåœ¨mapç«¯ä¹Ÿä¼šæœ‰ä¸ªmergeé˜¶æ®µï¼Œå°†spillåˆ°ç£ç›˜çš„ä¸´æ—¶æ–‡ä»¶mergeæˆä¸€ä¸ªå¤§æ–‡ä»¶ï¼Œè¿™ä¸ªè¿‡ç¨‹å°†spillsæ–‡ä»¶ä¸­æŒ‰ç…§partitionå’Œkeyè¿›è¡Œæ’åº)</p><p>ç”±æ­¤å¯çŸ¥MapReduceæ•´ä¸ªæµç¨‹æ˜¯ä»¥keyæ’åºä¸ºæ ¸å¿ƒçš„ï¼Œé‚£ä¹ˆé’ˆå¯¹ä¸Šé¢çš„éœ€æ±‚æ˜¯å¦å¯ä»¥åœ¨keyä¸Šåšç‚¹æ–‡ç« å‘¢ï¼Ÿ</p><p>é’ˆå¯¹ä¸Šé¢éœ€æ±‚çš„è§£å†³æ–¹æ¡ˆæ˜¯<em>å°†éœ€è¦æ’åºçš„keyå’Œvalue1(valueä¸­çš„æŸä¸ªå±æ€§)ç»„æˆä¸€ä¸ªå¤åˆé”®compositeKeyï¼Œåœ¨mapç«¯æŒ‰ç…§keyåˆ†åŒºå’Œæ’åºï¼Œåˆ™ç›¸åŒçš„keyè¢«åˆ†åˆ°åŒä¸€ä¸ªreduceä¸­ï¼Œåœ¨reduceä¸­å¯¹ç›¸åŒkeyçš„value1è¿›è¡Œæ’åºï¼Œç„¶åæ ¹æ®keyè¿›è¡Œåˆ†ç»„ï¼Œä»¥ä¾¿å½¢æˆç›¸åŒkeyçš„Iteratorï¼Œè¿™æ—¶è¾“å‡ºçš„æ•°æ®å°±æ˜¯æŒ‰ç…§keyå’Œvalue1æ’åºçš„ã€‚</em></p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸‹ç”±äºpartitioné€‰æ‹©çš„æ–¹æ³•ä¸ä¸€æ ·ï¼Œå¯èƒ½ä¼šå¯¼è‡´æœ€ç»ˆçš„ç»“æœ<em>å¯èƒ½æ˜¯reduceå†…æœ‰åºå’Œå…¨å±€æœ‰åº</em>ã€‚</p></blockquote><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><p>é—®é¢˜å¦‚ä¸‹ï¼š<br>æœ‰ä¸¤ä¸ªæ–‡ä»¶a.txtå’Œb.txt<br>a.txtä¸­çš„å†…å®¹æ˜¯<br>1990 31<br>1991 20<br>1991 18<br>1991 33<br>1990 22<br>1990 17<br>b.txtä¸­çš„å†…å®¹æ˜¯<br>1992 31<br>1991 27<br>1993 18<br>1993 33<br>1992 22<br>1990 10<br>æƒ³è¦çš„æ’åºç»“æœæ˜¯<br>1990    10<br>1990    17<br>1990    22<br>1990    31<br>1991    18<br>1991    20<br>1991    27<br>1991    33<br>1992    22<br>1992    31<br>1993    18<br>1993    33</p><p>å…ˆæ¥çœ‹ä¸‹æ ¹æ®å¤åˆé”®compositeKeyä¸­çš„keyè¿›è¡Œhashåˆ†åŒºçš„ä»£ç </p><h2 id="hashåˆ†åŒºä»£ç ç¤ºä¾‹"><a href="#hashåˆ†åŒºä»£ç ç¤ºä¾‹" class="headerlink" title="hashåˆ†åŒºä»£ç ç¤ºä¾‹"></a>hashåˆ†åŒºä»£ç ç¤ºä¾‹</h2><p>å¤åˆé”®compositeKeyçš„å½¢æˆæœ‰ä¸¤ç§å½¢å¼ï¼šä¸€ç§æ˜¯å°†keyå’Œvalueæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œkeyå’Œvalueä¹‹å‰ç”¨ç‰¹æ®Šå­—ç¬¦åˆ†éš”ï¼Œå¦ä¸€ç§æ˜¯<em>å®ç°WritableComparableæ¥å£</em>è‡ªå·±å†™ä¸€ä¸ªæ–°çš„æ•°æ®ç±»å‹ã€‚</p><p>å…ˆæ¥ä¸ªç®€å•çš„ï¼Œå°†keyå’Œvalueæ‹¼æ¥ä¸ºä¸€ä¸ªå­—ç¬¦ä¸²</p><h3 id="keyå’Œvalueæ‹¼æ¥å­—ç¬¦ä¸²ä¸ºå¤åˆé”®"><a href="#keyå’Œvalueæ‹¼æ¥å­—ç¬¦ä¸²ä¸ºå¤åˆé”®" class="headerlink" title="keyå’Œvalueæ‹¼æ¥å­—ç¬¦ä¸²ä¸ºå¤åˆé”®"></a>keyå’Œvalueæ‹¼æ¥å­—ç¬¦ä¸²ä¸ºå¤åˆé”®</h3><p>keyå’Œvalueæ‹¼æ¥ä¸ºå­—ç¬¦ä¸²æ˜¯åœ¨mapä¸­æ‰§è¡Œçš„ï¼Œå…ˆçœ‹ä¸‹mapçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line"></span><br><span class="line">        String[] arr = value.toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å°†å†…å®¹key valueä½œä¸ºå¤åˆkeyè¾“å‡º</span></span><br><span class="line">        context.write(<span class="keyword">new</span> Text(arr[<span class="number">0</span>] + <span class="string">&quot; &quot;</span> + arr[<span class="number">1</span>]), <span class="keyword">new</span> IntWritable(Integer.parseInt(arr[<span class="number">1</span>])));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æºæ–‡ä»¶é‡Œçš„keyå’Œvalueæ˜¯ç”¨ç©ºæ ¼åˆ†éš”çš„ï¼Œåœ¨mapä¸­å°†keyå’Œvalueåˆ†éš”å¼€ç„¶åå°†keyå’Œvalueç»„åˆä¸ºä¸€ä¸ªæ–°çš„newKeyï¼Œå°†valueä¾ç„¶ä½œä¸ºvalueè¾“å‡ºã€‚</p><p>è¿™é‡Œæ—¢ç„¶çœ‹äº†mapçš„ä»£ç ï¼Œé‚£ä¹ˆä¸é˜²å†çœ‹ä¸‹reduceä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span></span></span><br><span class="line"><span class="class">        <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span></span><br><span class="line"><span class="params"><span class="function">                       Context context</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">            <span class="comment">// å°†å†…å®¹key valueä½œä¸ºå¤åˆkeyè¾“å‡º</span></span><br><span class="line">              context.write(key, NullWritable.get());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>reduceåªæ˜¯å°†key(<em>è¿™é‡Œçš„keyæ˜¯æŒ‡åœ¨mapä¸­ç»„åˆä¹‹åçš„å¤åˆé”®</em>)è¾“å‡ºï¼Œvalueæ˜¯<em>hadoopä¸­æä¾›çš„nullå¯¹è±¡NullWritable</em>ã€‚</p><p>è¿™é‡Œä¹‹æ‰€ä»¥åªæ˜¯ç›´æ¥å°†keyè¾“å‡ºæ˜¯å› ä¸ºæˆ‘ä»¬åœ¨**æ•´ä¸ªMRæµç¨‹ä¸­é€šè¿‡keyçš„ç¬¬ä¸€ä¸ªå­—æ®µè¿›è¡Œåˆ†åŒºå’Œåˆ†ç»„ï¼Œæ¯”è¾ƒä¸¤ä¸ªkeyçš„å¤§å°æ—¶æ˜¯å…ˆæ¯”è¾ƒkeyçš„ç¬¬ä¸€ä¸ªå­—æ®µï¼Œç›¸åŒæ—¶å†æ¯”è¾ƒç¬¬äºŒä¸ªå­—æ®µ(è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯æºæ–‡ä»¶ä¸­ç¬¬äºŒä¸ªå­—æ®µæ˜¯intï¼Œå¦‚æœç¬¬äºŒä¸ªå­—æ®µä¹Ÿæ˜¯stringç±»å‹çš„ï¼Œåˆ™å°±å¯ä»¥åˆ©ç”¨Textè‡ªèº«çš„æ¯”è¾ƒå™¨è¿›è¡Œä¸¤ä¸ªkeyçš„æ¯”è¾ƒ)**ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯ä½ å¯ä»¥è‡ªå®šä¹‰keyå’Œvalueä¹‹å‰çš„åˆ†éš”ç¬¦(è€Œä¸ç”¨é‡å†™outputFormaterå»å®šä¹‰keyå’Œvalueä¹‹é—´çš„åˆ†éš”ç¬¦)ï¼Œä½†ä¹Ÿæœ‰ä¸€äº›å±€é™æ€§ï¼Œå…·ä½“çœ‹è‡ªå·±éœ€æ±‚å§ã€‚</p><p>ä¸‹é¢æ¥çœ‹ä¸‹æˆ‘ä»¬æ˜¯æ€ä¹ˆå¯¹è¿™ä¸ªå¤åˆé”®è¿›è¡Œå¤„ç†çš„ã€‚é¦–å…ˆçœ‹ä¸‹åˆ†åŒºç­–ç•¥ï¼š</p><p>è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥æ—¶è¦ç»§æ‰¿<code>Partitioner</code>ç±»ï¼Œé‡å†™<code>getPartition</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FirstPartition</span> <span class="keyword">extends</span> <span class="title">Partitioner</span>&lt;<span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(Text text, IntWritable intWritable, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ‹¿åˆ°å¤åˆé”®ä¸­çš„ç¬¬ä¸€ä¸ªå€¼ï¼Œä¹Ÿå°±æ˜¯æºæ–‡ä»¶ä¸­çš„keyï¼Œ</span></span><br><span class="line">    <span class="comment">// ç„¶åæ ¹æ®å…¶å€¼è¿›è¡Œhashåˆ†åŒº</span></span><br><span class="line">        <span class="keyword">return</span> Math.abs(text.toString().split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>].hashCode() * <span class="number">127</span>) % i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹æ•°æ®åˆ†åŒºä¹‹åï¼Œå°±è¯¥å¯¹å¤åˆé”®è¿›è¡Œæ’åºäº†ï¼Œè¿™é‡Œçš„æ¯”è¾ƒåŸåˆ™æ˜¯å…ˆå°†å¤åˆé”®è¿›è¡Œåˆ‡åˆ†ï¼Œç„¶åå…ˆå¯¹ç¬¬ä¸€ä¸ªå­—æ®µè¿›è¡Œæ¯”è¾ƒï¼Œç›¸åŒä¹‹ååœ¨å¯¹ç¬¬äºŒä¸ªå­—æ®µè¿›è¡Œæ¯”è¾ƒã€‚<em>ç”±äºæºæ–‡ä»¶ä¸­keyæ˜¯stringï¼Œvalueæ˜¯intï¼Œå°†keyå’Œvalueç»„æˆTextç±»å‹çš„å¤åˆé”®æ—¶ï¼Œä¸èƒ½ä½¿ç”¨Textè‡ªèº«çš„æ¯”è¾ƒå™¨(å› ä¸ºvalueæ˜¯int)ï¼Œåˆ™è¿™é‡Œéœ€è¦è‡ªå®šä¹‰æ¯”è¾ƒå™¨</em>ã€‚</p><p>Hadoopä¸­è‡ªå®šä¹‰æ¯”è¾ƒå™¨è¦ç»§æ‰¿<code>WritableComparator</code>å¹¶ä¸”é‡è½½<code>compare(WritableComparable a, WritableComparable b)</code>æ–¹æ³•(<em>éœ€è¦ç‰¹åˆ«æ³¨æ„çš„æ˜¯ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªæ„é€ å‡½æ•°</em>)ï¼Œè‡ªå®šä¹‰æ¯”è¾ƒå™¨ä¹Ÿå¯ä»¥å®ç°<code>RawComparator</code>æ¥å£ã€‚è¿™é‡Œæ˜¯ç»§æ‰¿<code>WritableComparator</code>ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">KeyComparator</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// æ„é€ å‡½æ•°å¿…é¡»æœ‰</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">KeyComparator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Text.class, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¯¹å¤åˆé”®è¿›è¡Œåˆ‡åˆ†</span></span><br><span class="line">        String[] arr_a = a.toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        String[] arr_b = b.toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;=========KeyComparator=========&quot;</span>);</span><br><span class="line">        <span class="comment">// å…ˆæ¯”è¾ƒç¬¬ä¸€ä¸ªå­—æ®µç„¶åå†æ¯”è¾ƒç¬¬äºŒä¸ª</span></span><br><span class="line">        <span class="keyword">if</span> (arr_a[<span class="number">0</span>].compareTo(arr_b[<span class="number">0</span>]) != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> arr_a[<span class="number">0</span>].compareTo(arr_b[<span class="number">0</span>]);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Integer.parseInt(arr_a[<span class="number">1</span>]) - Integer.parseInt(arr_b[<span class="number">1</span>]);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//    æ„é€ å‡½æ•°æ˜¯å¿…é¡»çš„ï¼Œä½†å½“æ„é€ å‡½æ•°å’Œä¸‹é¢çš„æ–¹æ³•åŒæ—¶å­˜åœ¨çš„æ—¶å€™ï¼Œæ’åºä¼šå‡ºé—®é¢˜</span></span><br><span class="line"><span class="comment">//  å¦‚æœæ²¡æœ‰æ„é€ å‡½æ•°æ—¶ï¼Œæ‰§è¡Œçš„æ¯”è¾ƒæ–¹æ³•æ˜¯ä¸‹é¢çš„æ–¹æ³•ï¼Œä½†æ’åºè²Œä¼¼æœ‰é—®é¢˜</span></span><br><span class="line"><span class="comment">//    @Override</span></span><br><span class="line"><span class="comment">//    public int compare(byte[] b1, int s1, int l1, byte[] b2, int s2, int l2) &#123;</span></span><br><span class="line"><span class="comment">//        System.out.println(&quot;Key++++++++++++Comparator&quot;);</span></span><br><span class="line"><span class="comment">//        String str1 = new String(b1,s1,l1);</span></span><br><span class="line"><span class="comment">//        String str2 = new String(b1,s1,l1);</span></span><br><span class="line"><span class="comment">//        System.out.println(str1.split(&quot; &quot;)[0]);</span></span><br><span class="line"><span class="comment">////        byte[] bytes1 = str1.split(&quot; &quot;)[0].getBytes();</span></span><br><span class="line"><span class="comment">////        byte[] bytes2 = str2.split(&quot; &quot;)[0].getBytes();</span></span><br><span class="line"><span class="comment">//        if (!str1.split(&quot; &quot;)[0].equals(str2.split(&quot; &quot;)[0]))&#123;</span></span><br><span class="line"><span class="comment">//            return str1.split(&quot; &quot;)[0].compareTo(str2.split(&quot; &quot;)[0]);</span></span><br><span class="line"><span class="comment">//        &#125;else &#123;</span></span><br><span class="line"><span class="comment">//            return str1.split(&quot; &quot;)[1].compareTo(str2.split(&quot; &quot;)[1]);</span></span><br><span class="line"><span class="comment">//        &#125;</span></span><br><span class="line"><span class="comment">////        return str1.split(&quot; &quot;)[0].compareTo(str2.split(&quot; &quot;)[0]);</span></span><br><span class="line"><span class="comment">////        return this.compareBytes(b1, s1, l1, b2, s2, l2);</span></span><br><span class="line"><span class="comment">//    &#125;</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ°æ­¤ä»£ç å…¶å®å°±å·²ç»å®ç°äº†reduceè¾“å‡ºçš„å±€éƒ¨æœ‰åºï¼Œä½†æœ‰äº›åœºæ™¯ä¹Ÿéœ€è¦é‡å†™reduceç«¯çš„åˆ†ç»„ç­–ç•¥ï¼Œæ‰€ä»¥è¿™é‡Œä¹ŸåŠ ä¸Šè‡ªå®šä¹‰çš„åˆ†ç»„ç­–ç•¥ã€‚è‡ªå®šä¹‰åˆ†ç»„ç­–ç•¥æ—¶è¦<strong>å…¶å®ä¹Ÿæ˜¯é‡å†™ä¸€ä¸ªæ¯”è¾ƒå™¨</strong>ï¼Œè¿™é‡Œä¾ç„¶é‡‡ç”¨ç»§æ‰¿<code>WritableComparator</code>ç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">GroupComparator</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ç»§æ‰¿WritableComparatoræ—¶å¿…é¡»æœ‰æ„é€ æ–¹æ³•</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">GroupComparator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(Text.class, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</span><br><span class="line">        String[] arr_a = a.toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        String[] arr_b = b.toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;=========GroupComparator=========&quot;</span>);</span><br><span class="line">        <span class="comment">// æ ¹æ®å¤åˆé”®ä¸­çš„ç¬¬ä¸€ä¸ªå­—æ®µè¿›è¡Œåˆ†ç»„æ¯”è¾ƒ</span></span><br><span class="line">        <span class="keyword">return</span> arr_a[<span class="number">0</span>].compareTo(arr_b[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°±æ˜¯mainä¸»ç±»äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">    Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">    <span class="comment">// æœ¬åœ°ideè¿œç¨‹è¿æ¥é›†ç¾¤æ—¶ï¼Œéœ€è¦è®¾ç½®æ–‡ä»¶å­˜å‚¨æ ¼å¼</span></span><br><span class="line">    conf.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://192.168.244.131:9000&quot;</span>);</span><br><span class="line"></span><br><span class="line">    String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">    <span class="keyword">if</span> (otherArgs.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">        System.err.println(<span class="string">&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;</span>);</span><br><span class="line">        System.exit(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    Job job = Job.getInstance(conf, <span class="string">&quot;word count&quot;</span>);</span><br><span class="line">    job.setJarByClass(SecondSort.class);</span><br><span class="line">    job.setMapperClass(MyMapper.class);</span><br><span class="line">    job.setReducerClass(MyReducer.class);</span><br><span class="line">    <span class="comment">// è®¾ç½®äº†ä¸‹reduceçš„ä¸ªæ•°</span></span><br><span class="line">    job.setNumReduceTasks(<span class="number">2</span>);</span><br><span class="line">    <span class="comment">// ç”±äºmapå’Œreduceçš„è¾“å‡ºæ ¼å¼ä¸ä¸€æ ·ï¼Œéœ€è¦åˆ†åˆ«è®¾ç½®</span></span><br><span class="line">    job.setMapOutputKeyClass(Text.class);</span><br><span class="line">    job.setMapOutputValueClass(IntWritable.class);</span><br><span class="line">    job.setOutputKeyClass(Text.class);</span><br><span class="line">    job.setOutputValueClass(NullWritable.class);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// é‡å®šä¹‰partition</span></span><br><span class="line">    job.setPartitionerClass(FirstPartition.class);</span><br><span class="line">    <span class="comment">// é‡å†™æ’åºæ–¹æ³•</span></span><br><span class="line">    job.setSortComparatorClass(KeyComparator.class);</span><br><span class="line">    <span class="comment">// é‡å®šä¹‰åˆ†ç»„æ–¹æ³•</span></span><br><span class="line">    job.setGroupingComparatorClass(GroupComparator.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; otherArgs.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">        FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(otherArgs[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    FileOutputFormat.setOutputPath(job,</span><br><span class="line">            <span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]));</span><br><span class="line">    <span class="comment">// åˆ é™¤outè¾“å‡ºçš„å†…å®¹ï¼Œä»¥å…æ¯æ¬¡æ‰§è¡Œä¹‹å‰æ‰‹åŠ¨åˆ é™¤</span></span><br><span class="line">    FileSystem fs = FileSystem.get(conf);</span><br><span class="line">    <span class="keyword">if</span> (fs.exists(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>])))&#123;</span><br><span class="line">        fs.delete(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]), <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š<br>å› ä¸ºæœ‰ä¸¤ä¸ªreduceåˆ™æœ‰ä¸¤ä¸ªè¾“å‡ºï¼Œpart-r-00000å’Œpart-r-00001ã€‚<br>part-r-00000çš„å†…å®¹å¦‚ä¸‹ï¼š<br>1991 18<br>1991 20<br>1991 27<br>1991 33<br>1993 18<br>1993 33<br>part-r-00001çš„å†…å®¹å¦‚ä¸‹ï¼š<br>1990 10<br>1990 17<br>1990 22<br>1990 31<br>1992 22<br>1992 31</p><h3 id="è‡ªå®šä¹‰æ•°æ®ç±»å‹ä¸ºreduceçš„key"><a href="#è‡ªå®šä¹‰æ•°æ®ç±»å‹ä¸ºreduceçš„key" class="headerlink" title="è‡ªå®šä¹‰æ•°æ®ç±»å‹ä¸ºreduceçš„key"></a>è‡ªå®šä¹‰æ•°æ®ç±»å‹ä¸ºreduceçš„key</h3><p>å°†éœ€è¦æ’åºçš„å­—æ®µç»„åˆä¸ºä¸€ä¸ªæ–°çš„æ•°æ®ç±»å‹ï¼Œç”±æ­¤æ–°æ•°æ®ç±»å‹ä½œä¸ºkeyã€‚Hadoopè‡ªå®šä¹‰æ•°æ®ç±»å‹æ—¶éœ€è¦å®ç°<code>WritableComparable</code>æ¥å£ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityPair</span> <span class="keyword">implements</span> <span class="title">WritableComparable</span>&lt;<span class="title">EntityPair</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Text firstKey;</span><br><span class="line">    <span class="keyword">private</span> IntWritable secondKey;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Text <span class="title">getFirstKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> firstKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFirstKey</span><span class="params">(Text firstKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstKey = firstKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IntWritable <span class="title">getSecondKey</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> secondKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSecondKey</span><span class="params">(IntWritable secondKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.secondKey = secondKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EntityPair</span><span class="params">(Text firstKey, IntWritable secondKey)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.firstKey = firstKey;</span><br><span class="line">        <span class="keyword">this</span>.secondKey = secondKey;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EntityPair</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(EntityPair o)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.firstKey.compareTo(o.getFirstKey());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(DataOutput dataOutput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        dataOutput.writeUTF(firstKey.toString());</span><br><span class="line">        dataOutput.writeInt(secondKey.get());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">readFields</span><span class="params">(DataInput dataInput)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        firstKey = <span class="keyword">new</span> Text(dataInput.readUTF());</span><br><span class="line">        secondKey = <span class="keyword">new</span> IntWritable(dataInput.readInt());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.getFirstKey() + <span class="string">&quot; &quot;</span> + <span class="keyword">this</span>.getSecondKey();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ™åˆ†åŒºç­–ç•¥ã€æ¯”è¾ƒè§„åˆ™å’Œåˆ†ç»„ç­–ç•¥å’Œä¸Šä¸€èŠ‚çš„æ€è·¯å¤§ä½“ä¸€æ ·ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è‡ªå®šä¹‰åˆ†åŒºç­–ç•¥</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityPartition</span> <span class="keyword">extends</span> <span class="title">Partitioner</span>&lt;<span class="title">EntityPair</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(EntityPair text, IntWritable intWritable, <span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¾—åˆ°EntityPairä¸­çš„ç¬¬ä¸€ä¸ªfirstKey</span></span><br><span class="line">        <span class="keyword">return</span> Math.abs(text.getFirstKey().hashCode() * <span class="number">127</span>) % i;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰æ¯”è¾ƒå™¨</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityComparator</span> <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EntityComparator</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(EntityPair.class, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</span><br><span class="line">        EntityPair entityPair1 = (EntityPair) a;</span><br><span class="line">        EntityPair entityPair2 = (EntityPair) b;</span><br><span class="line">        System.out.println(<span class="string">&quot;=========Comparator=========&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!entityPair1.getFirstKey().toString().equals(entityPair2.getFirstKey().toString()))&#123;</span><br><span class="line">            <span class="keyword">return</span> entityPair1.getFirstKey().toString().compareTo(entityPair2.getFirstKey().toString());</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> entityPair1.getSecondKey().get() - entityPair2.getSecondKey().get();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// è‡ªå®šä¹‰åˆ†ç»„ç­–ç•¥</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityGroup</span>  <span class="keyword">extends</span> <span class="title">WritableComparator</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EntityGroup</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(EntityPair.class, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(WritableComparable a, WritableComparable b)</span> </span>&#123;</span><br><span class="line">        EntityPair entityPair1 = (EntityPair) a;</span><br><span class="line">        EntityPair entityPair2 = (EntityPair) b;</span><br><span class="line">        System.out.println(<span class="string">&quot;=========GroupComparator=========&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> entityPair1.getFirstKey().toString().compareTo(entityPair2.getFirstKey().toString());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢æ˜¯MRç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntitySecondSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = Logger.getLogger(EntitySecondSort.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span></span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">EntityPair</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String[] arr = value.toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†å†…å®¹key valueä½œä¸ºå¤åˆkeyè¾“å‡º</span></span><br><span class="line">            context.write(<span class="keyword">new</span> EntityPair(<span class="keyword">new</span> Text(arr[<span class="number">0</span>]), <span class="keyword">new</span> IntWritable(Integer.parseInt(arr[<span class="number">1</span>]))),</span><br><span class="line">                    <span class="keyword">new</span> IntWritable(Integer.parseInt(arr[<span class="number">1</span>])));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span></span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">EntityPair</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(EntityPair key, Iterable&lt;IntWritable&gt; values,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Context context</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">                <span class="comment">// åˆ†ç»„ä¹‹å</span></span><br><span class="line">                context.write(<span class="keyword">new</span> Text(key.getFirstKey()), val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        conf.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://192.168.244.131:9000&quot;</span>);</span><br><span class="line">        String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">        <span class="keyword">if</span> (otherArgs.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        Job job = Job.getInstance(conf, <span class="string">&quot;word count&quot;</span>);</span><br><span class="line">        job.setJarByClass(EntitySecondSort.class);</span><br><span class="line">        job.setMapperClass(MyMapper.class);</span><br><span class="line">        job.setReducerClass(MyReducer.class);</span><br><span class="line">        job.setNumReduceTasks(<span class="number">2</span>);</span><br><span class="line">        job.setMapOutputKeyClass(EntityPair.class);</span><br><span class="line">        job.setMapOutputValueClass(IntWritable.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line">        <span class="comment">// é‡å®šä¹‰partition</span></span><br><span class="line">        job.setPartitionerClass(EntityPartition.class);</span><br><span class="line">        <span class="comment">// é‡å†™æ’åºæ–¹æ³•</span></span><br><span class="line">        job.setSortComparatorClass(EntityComparator.class);</span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰åˆ†ç»„ç­–ç•¥</span></span><br><span class="line">        job.setGroupingComparatorClass(EntityGroup.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; otherArgs.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(otherArgs[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job,</span><br><span class="line">                <span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">        FileSystem fs = FileSystem.get(conf);</span><br><span class="line">        <span class="keyword">if</span> (fs.exists(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>])))&#123;</span><br><span class="line">            fs.delete(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œçš„åˆ†ç»„ç­–ç•¥ä¹Ÿä¸æ˜¯å¿…é¡»çš„ï¼Œ(åªæœ‰åœ¨reduceä¸­éœ€è¦å¯¹ç›¸åŒkeyçš„valuesè¿›è¡Œåˆå¹¶æ“ä½œæ—¶ï¼Œæ‰éœ€è¦å¯¹å…¶recordsæ ¹æ®å¤åˆé”®çš„ç¬¬ä¸€ä¸ªå€¼è¿›è¡Œåˆ†ç»„ã€‚)</p><p>ä¸Šé¢çš„reduceä»£ç è¾“å‡ºçš„æ˜¯é”®å€¼å¯¹ï¼Œä¹‹æ‰€ä»¥è¿™æ ·æ˜¯è€ƒè™‘åˆ°valueä¸­å¯èƒ½åŒ…å«å¾ˆå¤šå±æ€§ï¼Œè€Œåªéœ€è¦å¯¹å…¶ä¸­çš„æŸä¸€ä¸ªå±æ€§value1è¿›è¡Œæ’åºï¼Œåˆ™å°†å‰©ä½™çš„å±æ€§åˆ—å‡ºã€‚</p><blockquote><p>å…³äºäºŒæ¬¡æ’åºçš„ä¾‹å­Hadoopè‡ªå¸¦çš„MapReduceä¾‹å­ä¸­ä¹Ÿæœ‰æ ·ä¾‹ï¼Œç±»å<code>SecondarySort</code></p></blockquote><p>ä¸Šé¢çš„ä»£ç åªå®ç°äº†reduceå†…æœ‰åºï¼Œå„ä¸ªreduceä¹‹é—´æ˜¯æ— åºçš„ï¼Œ<strong>é‚£ä¹ˆå¦‚ä½•å¾—åˆ°ä¸€ä¸ªå…¨å±€æœ‰åºçš„ç»“æœå‘¢</strong>ï¼Ÿçœ‹<a href="http://bigdatadecode.top/MapReduce%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B--%E4%BA%8C%E6%AC%A1%E6%8E%92%E5%BA%8F%E4%B9%8B%E5%85%A8%E5%B1%80%E6%9C%89%E5%BA%8F.html">ä¸‹ç¯‡</a></p><h2 id="é™„åŠ -equalså’ŒhashCodeçš„å…³ç³»"><a href="#é™„åŠ -equalså’ŒhashCodeçš„å…³ç³»" class="headerlink" title="é™„åŠ : equalså’ŒhashCodeçš„å…³ç³»"></a>é™„åŠ : equalså’ŒhashCodeçš„å…³ç³»</h2><p>è¿™é‡Œè¡¥å……ä¸‹equalså’ŒhashCodeçš„å…³ç³»</p><p>equalså’ŒhashCodeéƒ½æ˜¯Objectç±»çš„æ–¹æ³•ï¼Œå¯ä»¥åœ¨ä»»åŠ¡ä¸€ä¸ªç±»ä¸­é‡å†™ï¼ŒObject<strong>é»˜è®¤</strong>çš„equalså®ç°æ˜¯<em>åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡çš„åœ°å€æ˜¯å¦ç›¸ç­‰</em>(å³ï¼Œæ˜¯å¦æ˜¯åŒä¸€ä¸ªå¯¹è±¡)æ¥åŒºåˆ†å®ƒä»¬æ˜¯å¦ç›¸ç­‰ï¼Œ**æ­¤æ—¶ç­‰ä»·äºâ€==â€**ã€‚ä½†æ˜¯equalsæ–¹æ³•å¾€å¾€è¢«ç±»é‡å†™ï¼Œç”¨æ¥åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡çš„å†…å®¹æ˜¯å¦ç›¸ç­‰ï¼Œå¦‚Stringç±»çš„equalsæ–¹æ³•ã€‚</p><p>hashCodeä¸»è¦æ˜¯ç”¨æ¥åˆ¤æ–­å¯¹è±¡åœ¨æ•£åˆ—è¡¨ä¸­çš„ä½ç½®ï¼Œåˆ™å¦‚æœä¸¤ä¸ªå¯¹è±¡ç›¸åŒåˆ™åœ¨æ•£åˆ—è¡¨ä¸­çš„ä½ç½®ä¹Ÿåº”è¯¥æ˜¯ç›¸åŒçš„ï¼Œä½†æ˜¯åˆ¤æ–­ä¸¤ä¸ªå¯¹è±¡æ˜¯å¦ç›¸åŒæ˜¯ç”±equalsåˆ¤æ–­çš„ï¼Œåˆ™*__å¦‚æœæŸä¸ªç±»çš„å¯¹è±¡è¦åœ¨æ•£åˆ—è¡¨ä¸­ä½¿ç”¨__ï¼Œé‡å†™equalsæ–¹æ³•æ—¶å¾€å¾€ä¹Ÿè¦é‡å†™hashCodeæ–¹æ³•ï¼Œä»¥ä¿è¯equalsä¸ºtrueæ—¶ï¼ŒhashCodeæ˜¯ç›¸åŒçš„*ã€‚å¦‚æœæŸä¸ªç±»ä¸ä¼šå‡ºç°åœ¨æ•£åˆ—è¡¨ä¸­ï¼Œåˆ™equalså’ŒhashCodeå¹¶æ²¡æœ‰ä»€ä¹ˆç›´æ¥çš„å…³ç³»ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> MapReduceåº”ç”¨å®ä¾‹ </tag>
            
            <tag> äºŒæ¬¡æ’åº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceæºç è§£æ--ç¯å½¢ç¼“å†²åŒº</title>
      <link href="/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2%E5%8C%BA.html"/>
      <url>/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--%E7%8E%AF%E5%BD%A2%E7%BC%93%E5%86%B2%E5%8C%BA.html</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰æœ‰ä¸¤ç¯‡æ–‡ä»¶åˆ†åˆ«åˆ†æäº†<a href="http://bigdatadecode.top/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Map%E8%A7%A3%E6%9E%90.html">Map</a>å’Œ<a href="http://bigdatadecode.top/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Reduce%E8%A7%A3%E6%9E%90.html">Reduce</a>é˜¶æ®µçš„æµç¨‹ï¼Œè¿™ç¯‡æ–‡ç« æŠŠMapé˜¶æ®µçš„<em>ç¯å½¢ç¼“å†²åŒº</em>å•ç‹¬æ‹¿å‡ºæ¥è¿›è¡Œåˆ†æï¼Œå¯¹ç¯å½¢ç¼“å†²åŒºçš„æ•°æ®ç»“æ„å’Œæ•°æ®è¿›å…¥ç¯å½¢ç¼“å†²åŒºç„¶åæº¢å†™åˆ°ç£ç›˜çš„æµç¨‹è¿›è¡Œåˆ†æã€‚</p><span id="more"></span><h2 id="ç¯å½¢ç¼“å†²åŒºæ•°æ®ç»“æ„"><a href="#ç¯å½¢ç¼“å†²åŒºæ•°æ®ç»“æ„" class="headerlink" title="ç¯å½¢ç¼“å†²åŒºæ•°æ®ç»“æ„"></a>ç¯å½¢ç¼“å†²åŒºæ•°æ®ç»“æ„</h2><p>Mapè¿‡ç¨‹ä¸­ç¯å½¢ç¼“å†²åŒºæ˜¯æŒ‡æ•°æ®è¢«mapå¤„ç†ä¹‹åä¼šå…ˆæ”¾å…¥å†…å­˜ï¼Œå†…å­˜ä¸­çš„è¿™ç‰‡åŒºåŸŸå°±æ˜¯ç¯å½¢ç¼“å†²åŒºã€‚</p><p>ç¯å½¢ç¼“å†²åŒºæ˜¯åœ¨<code>MapTask.MapOutputBuffer</code>ä¸­å®šä¹‰çš„ï¼Œç›¸å…³çš„å±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k/v accounting</span></span><br><span class="line"><span class="comment">// å­˜æ”¾metaæ•°æ®çš„IntBufferï¼Œéƒ½æ˜¯int entryï¼Œå 4byte</span></span><br><span class="line"><span class="keyword">private</span> IntBuffer kvmeta; <span class="comment">// metadata overlay on backing store</span></span><br><span class="line"><span class="keyword">int</span> kvstart;            <span class="comment">// marks origin of spill metadata</span></span><br><span class="line"><span class="keyword">int</span> kvend;              <span class="comment">// marks end of spill metadata</span></span><br><span class="line"><span class="keyword">int</span> kvindex;            <span class="comment">// marks end of fully serialized records</span></span><br><span class="line"><span class="comment">// åˆ†å‰²metaå’Œkey valueå†…å®¹çš„æ ‡è¯†   </span></span><br><span class="line"><span class="comment">// metaæ•°æ®å’Œkey valueå†…å®¹éƒ½å­˜æ”¾åœ¨åŒä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ‰€ä»¥éœ€è¦åˆ†éš”å¼€</span></span><br><span class="line"><span class="keyword">int</span> equator;            <span class="comment">// marks origin of meta/serialization</span></span><br><span class="line"><span class="keyword">int</span> bufstart;           <span class="comment">// marks beginning of spill</span></span><br><span class="line"><span class="keyword">int</span> bufend;             <span class="comment">// marks beginning of collectable</span></span><br><span class="line"><span class="keyword">int</span> bufmark;            <span class="comment">// marks end of record</span></span><br><span class="line"><span class="keyword">int</span> bufindex;           <span class="comment">// marks end of collected</span></span><br><span class="line"><span class="keyword">int</span> bufvoid;            <span class="comment">// marks the point where we should stop</span></span><br><span class="line">                        <span class="comment">// reading at the end of the buffer</span></span><br><span class="line"><span class="comment">// å­˜æ”¾key valueçš„byteæ•°ç»„ï¼Œå•ä½æ˜¯byteï¼Œæ³¨æ„ä¸kvmetaåŒºåˆ†</span></span><br><span class="line"><span class="keyword">byte</span>[] kvbuffer;        <span class="comment">// main output buffer</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] b0 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// key valueåœ¨kvbufferä¸­çš„åœ°å€å­˜æ”¾åœ¨åç§»kvindexçš„è·ç¦»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALSTART = <span class="number">0</span>;         <span class="comment">// val offset in acct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEYSTART = <span class="number">1</span>;         <span class="comment">// key offset in acct</span></span><br><span class="line"><span class="comment">// partitionä¿¡æ¯å­˜åœ¨kvmetaä¸­åç§»kvindexçš„è·ç¦»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PARTITION = <span class="number">2</span>;        <span class="comment">// partition offset in acct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALLEN = <span class="number">3</span>;           <span class="comment">// length of value</span></span><br><span class="line"><span class="comment">// ä¸€å¯¹key valueçš„metaæ•°æ®åœ¨kvmetaä¸­å ç”¨çš„ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NMETA = <span class="number">4</span>;            <span class="comment">// num meta ints</span></span><br><span class="line"><span class="comment">// ä¸€å¯¹key valueçš„metaæ•°æ®åœ¨kvmetaä¸­å ç”¨çš„byteæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> METASIZE = NMETA * <span class="number">4</span>; <span class="comment">// size in bytes</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¯å½¢ç¼“å†²åŒºå…¶å®æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­å­˜æ”¾ç€keyã€valueçš„åºåˆ—åŒ–æ•°æ®å’Œkeyã€valueçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œkey/valueçš„å…ƒæ•°æ®å­˜å‚¨çš„æ ¼å¼æ˜¯intç±»å‹ï¼Œæ¯ä¸ªkey/valueå¯¹åº”ä¸€ä¸ªå…ƒæ•°æ®ï¼Œå…ƒæ•°æ®ç”±4ä¸ªintç»„æˆï¼Œç¬¬ä¸€ä¸ªintå­˜æ”¾valueçš„èµ·å§‹ä½ç½®ï¼Œç¬¬äºŒä¸ªå­˜æ”¾keyçš„èµ·å§‹ä½ç½®ï¼Œç¬¬ä¸‰ä¸ªå­˜æ”¾partitionï¼Œæœ€åä¸€ä¸ªå­˜æ”¾valueçš„é•¿åº¦ã€‚</p><p>key/valueåºåˆ—åŒ–çš„æ•°æ®å’Œå…ƒæ•°æ®åœ¨ç¯å½¢ç¼“å†²åŒºä¸­çš„å­˜å‚¨æ˜¯ç”±<em>equator</em>åˆ†éš”çš„ï¼Œkey/valueæŒ‰ç…§<em>ç´¢å¼•é€’å¢</em>çš„æ–¹å‘å­˜å‚¨ï¼Œmetaåˆ™æŒ‰ç…§<em>ç´¢å¼•é€’å‡</em>çš„æ–¹å‘å­˜å‚¨ï¼Œå°†å…¶æ•°ç»„æŠ½è±¡ä¸ºä¸€ä¸ªç¯å½¢ç»“æ„ä¹‹åï¼Œ<em>ä»¥equatorä¸ºç•Œï¼Œkey/valueé¡ºæ—¶é’ˆå­˜å‚¨ï¼Œmetaé€†æ—¶é’ˆå­˜å‚¨</em>ã€‚</p><h2 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h2><p>ç¯å½¢ç¼“å†²åŒºçš„ç»“æ„åœ¨<code>MapOutputBuffer.init</code>ä¸­åˆ›å»ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(MapOutputCollector.Context context</span></span></span><br><span class="line"><span class="params"><span class="function">                )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">//MAP_SORT_SPILL_PERCENT = mapreduce.map.sort.spill.percent</span></span><br><span class="line">  <span class="comment">// map ç«¯bufferæ‰€å çš„ç™¾åˆ†æ¯”</span></span><br><span class="line">  <span class="comment">//sanity checks</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">float</span> spillper =</span><br><span class="line">    job.getFloat(JobContext.MAP_SORT_SPILL_PERCENT, (<span class="keyword">float</span>)<span class="number">0.8</span>);</span><br><span class="line">  <span class="comment">//IO_SORT_MB = &quot;mapreduce.task.io.sort.mb&quot;</span></span><br><span class="line">  <span class="comment">// map ç«¯bufferå¤§å°</span></span><br><span class="line">  <span class="comment">// mapreduce.task.io.sort.mb * mapreduce.map.sort.spill.percent æœ€å¥½æ˜¯16çš„æ•´æ•°å€</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> sortmb = job.getInt(JobContext.IO_SORT_MB, <span class="number">100</span>);</span><br><span class="line">  <span class="comment">// æ‰€æœ‰çš„spill index åœ¨å†…å­˜æ‰€å çš„å¤§å°çš„é˜ˆå€¼</span></span><br><span class="line">  indexCacheMemoryLimit = job.getInt(JobContext.INDEX_CACHE_MEMORY_LIMIT,</span><br><span class="line">                                     INDEX_CACHE_MEMORY_LIMIT_DEFAULT);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ’åºçš„å®ç°ç±»ï¼Œå¯ä»¥è‡ªå·±å®ç°ã€‚ è¿™é‡Œç”¨çš„æ˜¯æ”¹å†™çš„å¿«æ’</span></span><br><span class="line">  sorter = ReflectionUtils.newInstance(job.getClass(<span class="string">&quot;map.sort.class&quot;</span>,</span><br><span class="line">        QuickSort.class, IndexedSorter.class), job);</span><br><span class="line">  <span class="comment">// buffers and accounting</span></span><br><span class="line">  <span class="comment">// ä¸Šé¢IO_SORT_MBçš„å•ä½æ˜¯MBï¼Œå·¦ç§»20ä½å°†å•ä½è½¬åŒ–ä¸ºbyte</span></span><br><span class="line">  <span class="keyword">int</span> maxMemUsage = sortmb &lt;&lt; <span class="number">20</span>;</span><br><span class="line">  <span class="comment">// METASIZEæ˜¯å…ƒæ•°æ®çš„é•¿åº¦ï¼Œå…ƒæ•°æ®æœ‰4ä¸ªintå•å…ƒï¼Œåˆ†åˆ«ä¸º</span></span><br><span class="line">  <span class="comment">// VALSTARTã€KEYSTARTã€PARTITIONã€VALLENï¼Œè€Œintä¸º4ä¸ªbyteï¼Œ</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥METASIZEé•¿åº¦ä¸º16ã€‚ä¸‹é¢æ˜¯è®¡ç®—bufferä¸­æœ€å¤šæœ‰å¤šå°‘byteæ¥å­˜å…ƒæ•°æ®</span></span><br><span class="line">  maxMemUsage -= maxMemUsage % METASIZE;</span><br><span class="line">  <span class="comment">// å…ƒæ•°æ®æ•°ç»„  ä»¥byteä¸ºå•ä½</span></span><br><span class="line">  kvbuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[maxMemUsage];</span><br><span class="line">  bufvoid = kvbuffer.length;</span><br><span class="line">  <span class="comment">// å°†kvbufferè½¬åŒ–ä¸ºintå‹çš„kvmeta  ä»¥intä¸ºå•ä½ï¼Œä¹Ÿå°±æ˜¯4byte</span></span><br><span class="line">  kvmeta = ByteBuffer.wrap(kvbuffer)</span><br><span class="line">     .order(ByteOrder.nativeOrder())</span><br><span class="line">     .asIntBuffer();</span><br><span class="line">  <span class="comment">// è®¾ç½®bufå’Œkvmetaçš„åˆ†ç•Œçº¿</span></span><br><span class="line">  setEquator(<span class="number">0</span>);</span><br><span class="line">  bufstart = bufend = bufindex = equator;</span><br><span class="line">  kvstart = kvend = kvindex;</span><br><span class="line">  <span class="comment">// kvmetaä¸­å­˜æ”¾å…ƒæ•°æ®å®ä½“çš„æœ€å¤§ä¸ªæ•°</span></span><br><span class="line">  maxRec = kvmeta.capacity() / NMETA;</span><br><span class="line">  <span class="comment">// buffer spillæ—¶çš„é˜ˆå€¼ï¼ˆä¸å•å•æ˜¯sortmb*spillperï¼‰</span></span><br><span class="line">  <span class="comment">// æ›´åŠ ç²¾ç¡®çš„æ˜¯kvbuffer.length*spiller</span></span><br><span class="line">  softLimit = (<span class="keyword">int</span>)(kvbuffer.length * spillper);</span><br><span class="line">  <span class="comment">// æ­¤å˜é‡è¾ƒä¸ºé‡è¦ï¼Œä½œä¸ºspillçš„åŠ¨æ€è¡¡é‡æ ‡å‡†</span></span><br><span class="line">  bufferRemaining = softLimit;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// k/v serialization</span></span><br><span class="line">  comparator = job.getOutputKeyComparator();</span><br><span class="line">  keyClass = (Class&lt;K&gt;)job.getMapOutputKeyClass();</span><br><span class="line">  valClass = (Class&lt;V&gt;)job.getMapOutputValueClass();</span><br><span class="line">  serializationFactory = <span class="keyword">new</span> SerializationFactory(job);</span><br><span class="line">  keySerializer = serializationFactory.getSerializer(keyClass);</span><br><span class="line">  <span class="comment">// å°†bbä½œä¸ºkeyåºåˆ—åŒ–å†™å…¥çš„output</span></span><br><span class="line">  keySerializer.open(bb);</span><br><span class="line">  valSerializer = serializationFactory.getSerializer(valClass);</span><br><span class="line">  <span class="comment">// å°†bbä½œä¸ºvalueåºåˆ—åŒ–å†™å…¥çš„output</span></span><br><span class="line">  valSerializer.open(bb);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// combiner</span></span><br><span class="line">  ...</span><br><span class="line">  spillInProgress = <span class="keyword">false</span>;</span><br><span class="line">  <span class="comment">// æœ€åä¸€æ¬¡mergeæ—¶ï¼Œåœ¨æœ‰combinerçš„æƒ…å†µä¸‹ï¼Œè¶…è¿‡æ­¤é˜ˆå€¼æ‰æ‰§è¡Œcombiner</span></span><br><span class="line">  minSpillsForCombine = job.getInt(JobContext.MAP_COMBINE_MIN_SPILLS, <span class="number">3</span>);</span><br><span class="line">  spillThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">  spillThread.setName(<span class="string">&quot;SpillThread&quot;</span>);</span><br><span class="line">  spillLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    spillThread.start();</span><br><span class="line">    <span class="keyword">while</span> (!spillThreadRunning) &#123;</span><br><span class="line">      spillDone.await();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Spill thread failed to initialize&quot;</span>, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    spillLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sortSpillException != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Spill thread failed to initialize&quot;</span>,</span><br><span class="line">        sortSpillException);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initæ˜¯å¯¹ç¯å½¢ç¼“å†²åŒºè¿›è¡Œåˆå§‹åŒ–æ„é€ ï¼Œç”±<em>mapreduce.task.io.sort.mb</em>å†³å®šmapä¸­ç¯å½¢ç¼“å†²åŒºçš„å¤§å°sortmbï¼Œé»˜è®¤æ˜¯100Mã€‚</p><p>æ­¤ç¼“å†²åŒºä¹Ÿç”¨äºå­˜æ”¾metaï¼Œä¸€ä¸ªmetaå ç”¨METASIZE(16byte)ï¼Œåˆ™å…¶ä¸­ç”¨äºå­˜æ”¾æ•°æ®çš„å¤§å°æ˜¯<em>maxMemUsage -= sortmb &lt;&lt; 20 % METASIZE</em>(ç”±æ­¤å¯çŸ¥æœ€å¥½è®¾ç½®sortmbè½¬æ¢ä¸ºbyteä¹‹åæ˜¯16çš„æ•´æ•°å€)ï¼Œç„¶åç”¨maxMemUsageåˆå§‹åŒ–<em>kvbufferå­—èŠ‚æ•°ç»„</em>å’Œ<em>kvmetaæ•´å½¢æ•°ç»„</em>ï¼Œæœ€åè®¾ç½®æ•°ç»„çš„ä¸€äº›æ ‡è¯†ä¿¡æ¯ã€‚åˆ©ç”¨<code>setEquator(0)</code>è®¾ç½®kvbufferå’Œkvmetaçš„åˆ†ç•Œçº¿ï¼Œåˆå§‹åŒ–çš„æ—¶å€™ä»¥<strong>0</strong>ä¸ºåˆ†ç•Œçº¿ï¼Œkvindexä¸º<em>aligned - METASIZE + kvbuffer.length</em>ï¼Œå…¶ä½ç½®åœ¨ç¯å½¢æ•°ç»„ä¸­ç›¸å½“äºæŒ‰ç…§é€†æ—¶é’ˆæ–¹å‘å‡å»METASIZEï¼Œç”±kvindexè®¾ç½®<em>kvstart = kvend = kvindex</em>ï¼Œç”±equatorè®¾ç½®<em>bufstart = bufend = bufindex = equator</em>ï¼Œè¿˜å¾—è®¾ç½®<em>bufvoid = kvbuffer.length</em>ï¼Œbufvoidç”¨äºæ ‡è¯†ç”¨äºå­˜æ”¾æ•°æ®çš„æœ€å¤§ä½ç½®ã€‚</p><p>ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå½“bufferå ç”¨è¾¾åˆ°é˜ˆå€¼ä¹‹åï¼Œä¼šè¿›è¡Œspillï¼Œè¿™ä¸ªé˜ˆå€¼æ˜¯ç”±<em>bufferRemaining</em>è¿›è¡Œæ£€æŸ¥çš„ï¼ŒbufferRemainingç”±<code>softLimit = (int)(kvbuffer.length * spillper); bufferRemaining = softLimit;</code>è¿›è¡Œåˆå§‹åŒ–èµ‹å€¼ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯softLimitå¹¶ä¸æ˜¯_sortmb<em>spillper_ï¼Œè€Œæ˜¯_kvbuffer.length * spillper_ï¼Œå½“sortmb &lt;&lt; 20æ˜¯16çš„æ•´æ•°å€æ—¶ï¼Œæ‰å¯ä»¥è®¤ä¸ºsoftLimitæ˜¯sortmb</em>spillperã€‚</p><p>ä¸‹é¢æ˜¯setEquatorçš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// setEquator(0)çš„ä»£ç å¦‚ä¸‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setEquator</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">  equator = pos;</span><br><span class="line">  <span class="comment">// set index prior to first entry, aligned at meta boundary</span></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ª entryçš„æœ«å°¾ä½ç½®ï¼Œå³å…ƒæ•°æ®å’Œkvæ•°æ®çš„åˆ†ç•Œçº¿   å•ä½æ˜¯byte</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> aligned = pos - (pos % METASIZE);</span><br><span class="line">  <span class="comment">// Cast one of the operands to long to avoid integer overflow</span></span><br><span class="line">  <span class="comment">// å…ƒæ•°æ®ä¸­å­˜æ”¾æ•°æ®çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">  kvindex = (<span class="keyword">int</span>)</span><br><span class="line">    (((<span class="keyword">long</span>)aligned - METASIZE + kvbuffer.length) % kvbuffer.length) / <span class="number">4</span>;</span><br><span class="line">  LOG.info(<span class="string">&quot;(EQUATOR) &quot;</span> + pos + <span class="string">&quot; kvi &quot;</span> + kvindex +</span><br><span class="line">      <span class="string">&quot;(&quot;</span> + (kvindex * <span class="number">4</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>bufferåˆå§‹åŒ–ä¹‹åçš„æŠ½è±¡æ•°æ®ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/blogimgs/MapOutputBuffer/buffer_init.png" alt="ç¯å½¢ç¼“å†²åŒºæ•°æ®ç»“æ„å›¾" title="ç¯å½¢ç¼“å†²åŒºæ•°æ®ç»“æ„å›¾"></p><h2 id="å†™å…¥buffer"><a href="#å†™å…¥buffer" class="headerlink" title="å†™å…¥buffer"></a>å†™å…¥buffer</h2><p>Mapé€šè¿‡<code>NewOutputCollector.write</code>æ–¹æ³•è°ƒç”¨<code>collector.collect</code>å‘bufferä¸­å†™å…¥æ•°æ®ï¼Œæ•°æ®å†™å…¥ä¹‹å‰å·²åœ¨<code>NewOutputCollector.write</code>ä¸­å¯¹è¦å†™å…¥çš„æ•°æ®è¿›è¡Œé€æ¡åˆ†åŒºï¼Œä¸‹é¢çœ‹ä¸‹<em>collect</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MapOutputBuffer.collect</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(K key, V value, <span class="keyword">final</span> <span class="keyword">int</span> partition</span></span></span><br><span class="line"><span class="params"><span class="function">                                 )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ–°æ•°æ®collectæ—¶ï¼Œå…ˆå°†å‰©ä½™çš„ç©ºé—´å‡å»å…ƒæ•°æ®çš„é•¿åº¦ï¼Œä¹‹åè¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">  bufferRemaining -= METASIZE;</span><br><span class="line">  <span class="keyword">if</span> (bufferRemaining &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// start spill if the thread is not running and the soft limit has been</span></span><br><span class="line">    <span class="comment">// reached</span></span><br><span class="line">    spillLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–æ¬¡spillæ—¶ï¼ŒspillInProgressæ˜¯false</span></span><br><span class="line">        <span class="keyword">if</span> (!spillInProgress) &#123;</span><br><span class="line">          <span class="comment">// å¾—åˆ°kvindexçš„byteä½ç½®</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> kvbidx = <span class="number">4</span> * kvindex;</span><br><span class="line">          <span class="comment">// å¾—åˆ°kvendçš„byteä½ç½®</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> kvbend = <span class="number">4</span> * kvend;</span><br><span class="line">          <span class="comment">// serialized, unspilled bytes always lie between kvindex and</span></span><br><span class="line">          <span class="comment">// bufindex, crossing the equator. Note that any void space</span></span><br><span class="line">          <span class="comment">// created by a reset must be included in &quot;used&quot; bytes</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> bUsed = distanceTo(kvbidx, bufindex);</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">boolean</span> bufsoftlimit = bUsed &gt;= softLimit;</span><br><span class="line">          <span class="keyword">if</span> ((kvbend + METASIZE) % kvbuffer.length !=</span><br><span class="line">              equator - (equator % METASIZE)) &#123;</span><br><span class="line">            <span class="comment">// spill finished, reclaim space</span></span><br><span class="line">            resetSpill();</span><br><span class="line">            bufferRemaining = Math.min(</span><br><span class="line">                distanceTo(bufindex, kvbidx) - <span class="number">2</span> * METASIZE,</span><br><span class="line">                softLimit - bUsed) - METASIZE;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bufsoftlimit &amp;&amp; kvindex != kvend) &#123;</span><br><span class="line">            <span class="comment">// spill records, if any collected; check latter, as it may</span></span><br><span class="line">            <span class="comment">// be possible for metadata alignment to hit spill pcnt</span></span><br><span class="line">            startSpill();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> avgRec = (<span class="keyword">int</span>)</span><br><span class="line">              (mapOutputByteCounter.getCounter() /</span><br><span class="line">              mapOutputRecordCounter.getCounter());</span><br><span class="line">            <span class="comment">// leave at least half the split buffer for serialization data</span></span><br><span class="line">            <span class="comment">// ensure that kvindex &gt;= bufindex</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> distkvi = distanceTo(bufindex, kvbidx);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> newPos = (bufindex +</span><br><span class="line">              Math.max(<span class="number">2</span> * METASIZE - <span class="number">1</span>,</span><br><span class="line">                      Math.min(distkvi / <span class="number">2</span>,</span><br><span class="line">                               distkvi / (METASIZE + avgRec) * METASIZE)))</span><br><span class="line">              % kvbuffer.length;</span><br><span class="line">            setEquator(newPos);</span><br><span class="line">            bufmark = bufindex = newPos;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> serBound = <span class="number">4</span> * kvend;</span><br><span class="line">            <span class="comment">// bytes remaining before the lock must be held and limits</span></span><br><span class="line">            <span class="comment">// checked is the minimum of three arcs: the metadata space, the</span></span><br><span class="line">            <span class="comment">// serialization space, and the soft limit</span></span><br><span class="line">            bufferRemaining = Math.min(</span><br><span class="line">                <span class="comment">// metadata max</span></span><br><span class="line">                distanceTo(bufend, newPos),</span><br><span class="line">                Math.min(</span><br><span class="line">                  <span class="comment">// serialization max</span></span><br><span class="line">                  distanceTo(newPos, serBound),</span><br><span class="line">                  <span class="comment">// soft limit</span></span><br><span class="line">                  softLimit)) - <span class="number">2</span> * METASIZE;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      spillLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†key value åŠå…ƒæ•°æ®ä¿¡æ¯å†™å…¥ç¼“å†²åŒº</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// serialize key bytes into buffer</span></span><br><span class="line">    <span class="keyword">int</span> keystart = bufindex;</span><br><span class="line">    <span class="comment">// å°†keyåºåˆ—åŒ–å†™å…¥kvbufferä¸­ï¼Œå¹¶ç§»åŠ¨bufindex</span></span><br><span class="line">    keySerializer.serialize(key);</span><br><span class="line">    <span class="comment">// keyæ‰€å ç©ºé—´è¢«bufvoidåˆ†éš”ï¼Œåˆ™ç§»åŠ¨keyï¼Œ</span></span><br><span class="line">    <span class="comment">// å°†å…¶å€¼æ”¾åœ¨è¿ç»­çš„ç©ºé—´ä¸­ä¾¿äºsortæ—¶keyçš„å¯¹æ¯”</span></span><br><span class="line">    <span class="keyword">if</span> (bufindex &lt; keystart) &#123;</span><br><span class="line">      <span class="comment">// wrapped the key; must make contiguous</span></span><br><span class="line">      bb.shiftBufferedKey();</span><br><span class="line">      keystart = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// serialize value bytes into buffer</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> valstart = bufindex;</span><br><span class="line">    valSerializer.serialize(value);</span><br><span class="line">    <span class="comment">// It&#x27;s possible for records to have zero length, i.e. the serializer</span></span><br><span class="line">    <span class="comment">// will perform no writes. To ensure that the boundary conditions are</span></span><br><span class="line">    <span class="comment">// checked and that the kvindex invariant is maintained, perform a</span></span><br><span class="line">    <span class="comment">// zero-length write into the buffer. The logic monitoring this could be</span></span><br><span class="line">    <span class="comment">// moved into collect, but this is cleaner and inexpensive. For now, it</span></span><br><span class="line">    <span class="comment">// is acceptable.</span></span><br><span class="line">    bb.write(b0, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the record must be marked after the preceding write, as the metadata</span></span><br><span class="line">    <span class="comment">// for this record are not yet written</span></span><br><span class="line">    <span class="keyword">int</span> valend = bb.markRecord();</span><br><span class="line"></span><br><span class="line">    mapOutputRecordCounter.increment(<span class="number">1</span>);</span><br><span class="line">    mapOutputByteCounter.increment(</span><br><span class="line">        distanceTo(keystart, valend, bufvoid));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write accounting info</span></span><br><span class="line">    kvmeta.put(kvindex + PARTITION, partition);</span><br><span class="line">    kvmeta.put(kvindex + KEYSTART, keystart);</span><br><span class="line">    kvmeta.put(kvindex + VALSTART, valstart);</span><br><span class="line">    kvmeta.put(kvindex + VALLEN, distanceTo(valstart, valend));</span><br><span class="line">    <span class="comment">// advance kvindex</span></span><br><span class="line">    kvindex = (kvindex - NMETA + kvmeta.capacity()) % kvmeta.capacity();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (MapBufferTooSmallException e) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Record too large for in-memory buffer: &quot;</span> + e.getMessage());</span><br><span class="line">    spillSingleRecord(key, value, partition);</span><br><span class="line">    mapOutputRecordCounter.increment(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡å†™å…¥æ•°æ®æ—¶ï¼Œæ‰§è¡Œ<code>bufferRemaining -= METASIZE</code>ä¹‹åï¼Œæ£€æŸ¥<em>bufferRemaining</em>ï¼Œ</p><p>å¦‚æœå¤§äº0ï¼Œç›´æ¥å°†key/valueåºåˆ—åŒ–å¯¹å’Œå¯¹åº”çš„metaå†™å…¥bufferä¸­ï¼Œkey/valueæ˜¯åºåˆ—åŒ–ä¹‹åå†™å…¥çš„ï¼Œkey/valueç»è¿‡ä¸€äº›åˆ—çš„æ–¹æ³•è°ƒç”¨<code>Serializer.serialize(key/value) -&gt; WritableSerializer.serialize(key/value) -&gt; BytesWritable.write(dataOut) -&gt; DataOutputStream.write(bytes, 0, size) -&gt; MapOutputBuffer.Buffer.write(b, off, len)</code>ï¼Œæœ€åç”±<code>MapOutputBuffer.Buffer.write(b, off, len)</code>å°†æ•°æ®å†™å…¥<em>kvbuffer</em>ä¸­ï¼Œwriteæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// must always verify the invariant that at least METASIZE bytes are</span></span><br><span class="line">  <span class="comment">// available beyond kvindex, even when len == 0</span></span><br><span class="line">  bufferRemaining -= len;</span><br><span class="line">  <span class="keyword">if</span> (bufferRemaining &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// writing these bytes could exhaust available buffer space or fill</span></span><br><span class="line">    <span class="comment">// the buffer to soft limit. check if spill or blocking are necessary</span></span><br><span class="line">    <span class="keyword">boolean</span> blockwrite = <span class="keyword">false</span>;</span><br><span class="line">    spillLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        checkSpillException();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> kvbidx = <span class="number">4</span> * kvindex;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> kvbend = <span class="number">4</span> * kvend;</span><br><span class="line">        <span class="comment">// ser distance to key index</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> distkvi = distanceTo(bufindex, kvbidx);</span><br><span class="line">        <span class="comment">// ser distance to spill end index</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> distkve = distanceTo(bufindex, kvbend);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if kvindex is closer than kvend, then a spill is neither in</span></span><br><span class="line">        <span class="comment">// progress nor complete and reset since the lock was held. The</span></span><br><span class="line">        <span class="comment">// write should block only if there is insufficient space to</span></span><br><span class="line">        <span class="comment">// complete the current write, write the metadata for this record,</span></span><br><span class="line">        <span class="comment">// and write the metadata for the next record. If kvend is closer,</span></span><br><span class="line">        <span class="comment">// then the write should block if there is too little space for</span></span><br><span class="line">        <span class="comment">// either the metadata or the current write. Note that collect</span></span><br><span class="line">        <span class="comment">// ensures its metadata requirement with a zero-length write</span></span><br><span class="line">        blockwrite = distkvi &lt;= distkve</span><br><span class="line">          ? distkvi &lt;= len + <span class="number">2</span> * METASIZE</span><br><span class="line">          : distkve &lt;= len || distanceTo(bufend, kvbidx) &lt; <span class="number">2</span> * METASIZE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!spillInProgress) &#123;</span><br><span class="line">          <span class="keyword">if</span> (blockwrite) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((kvbend + METASIZE) % kvbuffer.length !=</span><br><span class="line">                equator - (equator % METASIZE)) &#123;</span><br><span class="line">              <span class="comment">// spill finished, reclaim space</span></span><br><span class="line">              <span class="comment">// need to use meta exclusively; zero-len rec &amp; 100% spill</span></span><br><span class="line">              <span class="comment">// pcnt would fail</span></span><br><span class="line">              resetSpill(); <span class="comment">// resetSpill doesn&#x27;t move bufindex, kvindex</span></span><br><span class="line">              bufferRemaining = Math.min(</span><br><span class="line">                  distkvi - <span class="number">2</span> * METASIZE,</span><br><span class="line">                  softLimit - distanceTo(kvbidx, bufindex)) - len;</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// we have records we can spill; only spill if blocked</span></span><br><span class="line">            <span class="keyword">if</span> (kvindex != kvend) &#123;</span><br><span class="line">              startSpill();</span><br><span class="line">              <span class="comment">// Blocked on this write, waiting for the spill just</span></span><br><span class="line">              <span class="comment">// initiated to finish. Instead of repositioning the marker</span></span><br><span class="line">              <span class="comment">// and copying the partial record, we set the record start</span></span><br><span class="line">              <span class="comment">// to be the new equator</span></span><br><span class="line">              setEquator(bufmark);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// We have no buffered records, and this record is too large</span></span><br><span class="line">              <span class="comment">// to write into kvbuffer. We must spill it directly from</span></span><br><span class="line">              <span class="comment">// collect</span></span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">int</span> size = distanceTo(bufstart, bufindex) + len;</span><br><span class="line">              setEquator(<span class="number">0</span>);</span><br><span class="line">              bufstart = bufend = bufindex = equator;</span><br><span class="line">              kvstart = kvend = kvindex;</span><br><span class="line">              bufvoid = kvbuffer.length;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> MapBufferTooSmallException(size + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (blockwrite) &#123;</span><br><span class="line">          <span class="comment">// wait for spill</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (spillInProgress) &#123;</span><br><span class="line">              reporter.progress();</span><br><span class="line">              spillDone.await();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">                  <span class="string">&quot;Buffer interrupted while waiting for the writer&quot;</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">while</span> (blockwrite);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      spillLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// here, we know that we have sufficient space to write</span></span><br><span class="line">  <span class="keyword">if</span> (bufindex + len &gt; bufvoid) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> gaplen = bufvoid - bufindex;</span><br><span class="line">    System.arraycopy(b, off, kvbuffer, bufindex, gaplen);</span><br><span class="line">    len -= gaplen;</span><br><span class="line">    off += gaplen;</span><br><span class="line">    bufindex = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  System.arraycopy(b, off, kvbuffer, bufindex, len);</span><br><span class="line">  bufindex += len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>writeæ–¹æ³•å°†key/valueå†™å…¥kvbufferä¸­ï¼Œå¦‚æœbufindex+lenè¶…è¿‡äº†bufvoidï¼Œåˆ™å°†å†™å…¥çš„å†…å®¹åˆ†å¼€å­˜å‚¨ï¼Œå°†ä¸€éƒ¨åˆ†å†™å…¥bufindexå’Œbufvoidä¹‹é—´ï¼Œç„¶åé‡ç½®bufindexï¼Œå°†å‰©ä½™çš„éƒ¨åˆ†å†™å…¥ï¼Œè¿™é‡Œä¸åŒºåˆ†keyå’Œvalueï¼Œå†™å…¥keyä¹‹åä¼šåœ¨collectä¸­åˆ¤æ–­<code>bufindex &lt; keystart</code>ï¼Œå½“bufindexå°æ—¶ï¼Œåˆ™keyè¢«åˆ†å¼€å­˜å‚¨ï¼Œæ‰§è¡Œ<code>bb.shiftBufferedKey()</code>ï¼Œvalueåˆ™ç›´æ¥å†™å…¥ï¼Œä¸ç”¨åˆ¤æ–­æ˜¯å¦è¢«åˆ†å¼€å­˜å‚¨ï¼Œkeyä¸èƒ½åˆ†å¼€å­˜å‚¨æ˜¯å› ä¸ºè¦å¯¹keyè¿›è¡Œæ’åºã€‚</p><p><em>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯è¦å†™å…¥çš„æ•°æ®å¤ªé•¿</em>ï¼Œå¹¶ä¸”_kvinde==kvend_ï¼Œåˆ™æŠ›å‡º<em>MapBufferTooSmallException</em>å¼‚å¸¸ï¼Œåœ¨collectä¸­æ•è·ï¼Œå°†æ­¤æ•°æ®ç›´æ¥spillåˆ°ç£ç›˜<code>spillSingleRecord</code>ï¼Œ<em>ä¹Ÿå°±æ˜¯å½“å•æ¡è®°å½•è¿‡é•¿æ—¶ï¼Œä¸å†™bufferï¼Œç›´æ¥å†™å…¥ç£ç›˜</em>ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹bb.shiftBufferedKey()ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BlockingBuffer.shiftBufferedKey</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">shiftBufferedKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// spillLock unnecessary; both kvend and kvindex are current</span></span><br><span class="line">  <span class="keyword">int</span> headbytelen = bufvoid - bufmark;</span><br><span class="line">  bufvoid = bufmark;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> kvbidx = <span class="number">4</span> * kvindex;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> kvbend = <span class="number">4</span> * kvend;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> avail =</span><br><span class="line">    Math.min(distanceTo(<span class="number">0</span>, kvbidx), distanceTo(<span class="number">0</span>, kvbend));</span><br><span class="line">  <span class="keyword">if</span> (bufindex + headbytelen &lt; avail) &#123;</span><br><span class="line">    System.arraycopy(kvbuffer, <span class="number">0</span>, kvbuffer, headbytelen, bufindex);</span><br><span class="line">    System.arraycopy(kvbuffer, bufvoid, kvbuffer, <span class="number">0</span>, headbytelen);</span><br><span class="line">    bufindex += headbytelen;</span><br><span class="line">    bufferRemaining -= kvbuffer.length - bufvoid;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">byte</span>[] keytmp = <span class="keyword">new</span> <span class="keyword">byte</span>[bufindex];</span><br><span class="line">    System.arraycopy(kvbuffer, <span class="number">0</span>, keytmp, <span class="number">0</span>, bufindex);</span><br><span class="line">    bufindex = <span class="number">0</span>;</span><br><span class="line">    out.write(kvbuffer, bufmark, headbytelen);</span><br><span class="line">    out.write(keytmp);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>shiftBufferedKeyæ—¶ï¼Œåˆ¤æ–­é¦–éƒ¨æ˜¯å¦æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜æ”¾keyï¼Œæœ‰æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™å…ˆå°†é¦–éƒ¨çš„éƒ¨åˆ†keyå†™å…¥keytmpä¸­ï¼Œç„¶ååˆ†ä¸¤æ¬¡å†™å…¥ï¼Œå†æ¬¡è°ƒç”¨Buffer.writeï¼Œå¦‚æœæœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ†ä¸¤æ¬¡copyï¼Œå…ˆå°†é¦–éƒ¨çš„éƒ¨åˆ†keyå¤åˆ¶åˆ°headbytelençš„ä½ç½®ï¼Œç„¶åå°†æœ«å°¾çš„éƒ¨åˆ†keyå¤åˆ¶åˆ°é¦–éƒ¨ï¼Œç§»åŠ¨bufindexï¼Œé‡ç½®bufferRemainingçš„å€¼ã€‚</p><p>key/valueå†™å…¥ä¹‹åï¼Œç»§ç»­å†™å…¥å…ƒæ•°æ®ä¿¡æ¯å¹¶é‡ç½®kvindexçš„å€¼ã€‚</p><h2 id="spill"><a href="#spill" class="headerlink" title="spill"></a>spill</h2><p>ä¸€æ¬¡å†™å…¥bufferç»“æŸï¼Œå½“å†™å…¥æ•°æ®æ¯”è¾ƒå¤šï¼Œ<em>bufferRemainingå°äºç­‰äº0</em>æ—¶ï¼Œå‡†å¤‡è¿›è¡Œspillï¼Œé¦–æ¬¡spillï¼ŒspillInProgressä¸ºfalseï¼Œæ­¤æ—¶æŸ¥çœ‹_bUsed = distanceTo(kvbidx, bufindex)_ï¼Œæ­¤æ—¶<em>bUsed &gt;= softLimit</em> å¹¶ä¸” <code>(kvbend + METASIZE) % kvbuffer.length == equator - (equator % METASIZE)</code>ï¼Œåˆ™è¿›è¡Œspillï¼Œè°ƒç”¨<code>startSpill</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSpill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å…ƒæ•°æ®çš„è¾¹ç•Œèµ‹å€¼</span></span><br><span class="line">  kvend = (kvindex + NMETA) % kvmeta.capacity();</span><br><span class="line">  <span class="comment">// key/valueçš„è¾¹ç•Œèµ‹å€¼</span></span><br><span class="line">  bufend = bufmark;</span><br><span class="line">  <span class="comment">// è®¾ç½®spillè¿è¡Œæ ‡è¯†</span></span><br><span class="line">  spillInProgress = <span class="keyword">true</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// åˆ©ç”¨é‡å…¥é”ï¼Œå¯¹spillçº¿ç¨‹è¿›è¡Œå”¤é†’</span></span><br><span class="line">  spillReady.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>startSpillå”¤é†’spillçº¿ç¨‹ä¹‹åï¼Œè¿›ç¨‹spillæ“ä½œï¼Œä½†æ­¤æ—¶mapå‘bufferçš„å†™å…¥æ“ä½œå¹¶æ²¡æœ‰é˜»å¡ï¼Œéœ€è¦é‡æ–°è¾¹ç•Œequatorå’ŒbufferRemainingçš„å€¼ï¼Œå…ˆæ¥çœ‹ä¸‹equatorå’ŒbufferRemainingå€¼çš„è®¾å®šï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// æ ¹æ®å·²ç»å†™å…¥çš„kvå¾—å‡ºæ¯ä¸ªrecordçš„å¹³å‡é•¿åº¦</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> avgRec = (<span class="keyword">int</span>) (mapOutputByteCounter.getCounter() /</span><br><span class="line">  mapOutputRecordCounter.getCounter());</span><br><span class="line"><span class="comment">// leave at least half the split buffer for serialization data</span></span><br><span class="line"><span class="comment">// ensure that kvindex &gt;= bufindex</span></span><br><span class="line"><span class="comment">// å¾—åˆ°ç©ºä½™ç©ºé—´çš„å¤§å°</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> distkvi = distanceTo(bufindex, kvbidx);</span><br><span class="line"><span class="comment">// å¾—å‡ºæ–°equatorçš„ä½ç½®</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> newPos = (bufindex +</span><br><span class="line">  Math.max(<span class="number">2</span> * METASIZE - <span class="number">1</span>,</span><br><span class="line">          Math.min(distkvi / <span class="number">2</span>,</span><br><span class="line">                   distkvi / (METASIZE + avgRec) * METASIZE)))</span><br><span class="line">  % kvbuffer.length;</span><br><span class="line">setEquator(newPos);</span><br><span class="line">bufmark = bufindex = newPos;</span><br><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> serBound = <span class="number">4</span> * kvend;</span><br><span class="line"><span class="comment">// bytes remaining before the lock must be held and limits</span></span><br><span class="line"><span class="comment">// checked is the minimum of three arcs: the metadata space, the</span></span><br><span class="line"><span class="comment">// serialization space, and the soft limit</span></span><br><span class="line">bufferRemaining = Math.min(</span><br><span class="line">    <span class="comment">// metadata max</span></span><br><span class="line">    distanceTo(bufend, newPos),</span><br><span class="line">    Math.min(</span><br><span class="line">      <span class="comment">// serialization max</span></span><br><span class="line">      distanceTo(newPos, serBound),</span><br><span class="line">      <span class="comment">// soft limit</span></span><br><span class="line">      softLimit)) - <span class="number">2</span> * METASIZE;</span><br><span class="line"></span><br></pre></td></tr></table></figure><p>**å› ä¸ºequatoræ˜¯kvbufferå’Œkvmetaçš„åˆ†ç•Œçº¿ï¼Œä¸ºäº†æ›´å¤šçš„ç©ºé—´å­˜å‚¨kvï¼Œåˆ™æœ€å¤šæ‹¿å‡ºdistkviçš„ä¸€åŠæ¥å­˜å‚¨metaï¼Œå¹¶ä¸”åˆ©ç”¨avgRecä¼°ç®—distkvièƒ½å­˜æ”¾å¤šå°‘ä¸ªrecordå’Œmetaå¯¹ï¼Œæ ¹æ®recordå’Œmetaå¯¹çš„ä¸ªæ•°ä¼°ç®—metaæ‰€å ç©ºé—´çš„å¤§å°ï¼Œä»distkvi/2å’Œmetaæ‰€å ç©ºé—´çš„å¤§å°ä¸­å–æœ€å°å€¼ï¼Œåˆå› ä¸ºdistkviä¸­æœ€å°‘å¾—å­˜æ”¾ä¸€ä¸ªmetaï¼Œæ‰€å ç©ºé—´ä¸ºMETASIZEï¼Œåœ¨é€‰å–kvindexæ—¶éœ€è¦æ±‚alignedï¼Œalignedæœ€å¤šä¸ºMETASIZE-1ï¼Œæ€»å’Œä¸Šè¿°å› ç´ ï¼Œæœ€ç»ˆé€‰å–equatorä¸º<code>(bufindex + Math.max(2 * METASIZE - 1, Math.min(distkvi / 2, distkvi / (METASIZE + avgRec) * METASIZE)))</code>**ã€‚equatoré€‰å–ä¹‹åï¼Œè®¾ç½®bufmark = bufindex = newPoså’Œkvindexï¼Œä½†æ­¤æ—¶å¹¶ä¸è®¾ç½®bufstartã€bufendå’Œkvstartã€kvendï¼Œå› ä¸ºè¿™å‡ ä¸ªå€¼è¦ç”¨æ¥è¡¨ç¤ºspillæ•°æ®çš„è¾¹ç•Œã€‚</p><p>spillä¹‹åï¼Œå¯ç”¨çš„ç©ºé—´å‡å°‘äº†ï¼Œåˆ™æ§åˆ¶spillçš„bufferRemainingä¹Ÿåº”è¯¥é‡æ–°è®¾ç½®ï¼ŒbufferRemainingå–ä¸‰ä¸ªå€¼çš„æœ€å°å€¼_å‡å»2*METASIZE_ï¼Œä¸‰ä¸ªå€¼åˆ†åˆ«æ˜¯metaå¯ç”¨å ç”¨çš„ç©ºé—´<code>distanceTo(bufend, newPos)</code>,kvå¯ç”¨ç©ºé—´<code>distanceTo(newPos, serBound)</code>å’ŒsoftLimitã€‚__è¿™é‡Œä¸ºä»€ä¹ˆè¦å‡å»2*METASIZEï¼Œä¸€ä¸ªæ˜¯spillä¹‹å‰kvendåˆ°kvindexçš„è·ç¦»ï¼Œå¦ä¸€ä¸ªæ˜¯å½“æ—¶çš„kvindexç©ºé—´ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ__æ­¤æ—¶ï¼Œå·²æœ‰ä¸€ä¸ªrecordè¦å†™å…¥bufferï¼Œéœ€è¦ä»bufferRemainingä¸­å‡å»å½“å‰recordçš„å…ƒæ•°æ®å ç”¨çš„ç©ºé—´ï¼Œå³å‡å»METASIZEï¼Œå¦ä¸€ä¸ªMETASIZEæ˜¯åœ¨è®¡ç®—equatoræ—¶ï¼Œæ²¡æœ‰åŒ…æ‹¬kvindexåˆ°kvend(spillä¹‹å‰)çš„è¿™æ®µMETASIZEï¼Œæ‰€ä»¥è¦å‡å»è¿™ä¸ªMETASIZEã€‚</p><p>æ¥ä¸‹æ¥è§£æä¸‹SpillThreadçº¿ç¨‹ï¼ŒæŸ¥çœ‹å…¶runæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  spillLock.lock();</span><br><span class="line">  spillThreadRunning = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      spillDone.signal();</span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨spillï¼Œfalseåˆ™æŒ‚èµ·SpillThreadçº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’</span></span><br><span class="line">      <span class="keyword">while</span> (!spillInProgress) &#123;</span><br><span class="line">        spillReady.await();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        spillLock.unlock();</span><br><span class="line">        <span class="comment">// å”¤é†’ä¹‹åï¼Œè¿›è¡Œæ’åºå’Œæº¢å†™åˆ°ç£ç›˜</span></span><br><span class="line">        sortAndSpill();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        sortSpillException = t;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        spillLock.lock();</span><br><span class="line">        <span class="keyword">if</span> (bufend &lt; bufstart) &#123;</span><br><span class="line">          bufvoid = kvbuffer.length;</span><br><span class="line">        &#125;</span><br><span class="line">        kvstart = kvend;</span><br><span class="line">        bufstart = bufend;</span><br><span class="line">        spillInProgress = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    spillLock.unlock();</span><br><span class="line">    spillThreadRunning = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>runä¸­ä¸»è¦æ˜¯<code>sortAndSpill</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sortAndSpill</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException,</span></span><br><span class="line"><span class="function">                                   InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">//approximate the length of the output file to be the length of the</span></span><br><span class="line">  <span class="comment">//buffer + header lengths for the partitions</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> size = distanceTo(bufstart, bufend, bufvoid) +</span><br><span class="line">              partitions * APPROX_HEADER_LENGTH;</span><br><span class="line">  FSDataOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// create spill file</span></span><br><span class="line">    <span class="comment">// ç”¨æ¥å­˜å‚¨indexæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">final</span> SpillRecord spillRec = <span class="keyword">new</span> SpillRecord(partitions);</span><br><span class="line">    <span class="comment">// åˆ›å»ºå†™å…¥ç£ç›˜çš„spillæ–‡ä»¶</span></span><br><span class="line">    <span class="keyword">final</span> Path filename =</span><br><span class="line">        mapOutputFile.getSpillFileForWrite(numSpills, size);</span><br><span class="line">    <span class="comment">// æ‰“å¼€æ–‡ä»¶æµ</span></span><br><span class="line">    out = rfs.create(filename);</span><br><span class="line">    <span class="comment">// kvend/4 æ˜¯æˆªæ­¢åˆ°å½“å‰ä½ç½®èƒ½å­˜æ”¾å¤šå°‘ä¸ªå…ƒæ•°æ®å®ä½“</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mstart = kvend / NMETA;</span><br><span class="line">    <span class="comment">// kvstart å¤„èƒ½å­˜æ”¾å¤šå°‘ä¸ªå…ƒæ•°æ®å®ä½“</span></span><br><span class="line">    <span class="comment">// å…ƒæ•°æ®åˆ™åœ¨mstartå’Œmendä¹‹é—´ï¼Œ(mstart - mend)åˆ™æ˜¯å…ƒæ•°æ®çš„ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mend = <span class="number">1</span> + <span class="comment">// kvend is a valid record</span></span><br><span class="line">      (kvstart &gt;= kvend</span><br><span class="line">      ? kvstart</span><br><span class="line">      : kvmeta.capacity() + kvstart) / NMETA;</span><br><span class="line">    <span class="comment">// æ’åº  åªå¯¹å…ƒæ•°æ®è¿›è¡Œæ’åº,åªè°ƒæ•´å…ƒæ•°æ®åœ¨kvmetaä¸­çš„é¡ºåº</span></span><br><span class="line">    <span class="comment">// æ’åºè§„åˆ™æ˜¯MapOutputBuffer.compareï¼Œ </span></span><br><span class="line">    <span class="comment">// å…ˆå¯¹partitionè¿›è¡Œæ’åºå…¶æ¬¡å¯¹keyå€¼æ’åº</span></span><br><span class="line">    sorter.sort(MapOutputBuffer.<span class="keyword">this</span>, mstart, mend, reporter);</span><br><span class="line">    <span class="keyword">int</span> spindex = mstart;</span><br><span class="line">    <span class="comment">// åˆ›å»ºrecï¼Œç”¨äºå­˜æ”¾è¯¥åˆ†åŒºåœ¨æ•°æ®æ–‡ä»¶ä¸­çš„ä¿¡æ¯</span></span><br><span class="line">    <span class="keyword">final</span> IndexRecord rec = <span class="keyword">new</span> IndexRecord();</span><br><span class="line">    <span class="keyword">final</span> InMemValBytes value = <span class="keyword">new</span> InMemValBytes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; partitions; ++i) &#123;</span><br><span class="line">      <span class="comment">// ä¸´æ—¶æ–‡ä»¶æ˜¯IFileæ ¼å¼çš„</span></span><br><span class="line">      IFile.Writer&lt;K, V&gt; writer = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> segmentStart = out.getPos();</span><br><span class="line">        FSDataOutputStream partitionOut = CryptoUtils.wrapIfNecessary(job, out);</span><br><span class="line">        writer = <span class="keyword">new</span> Writer&lt;K, V&gt;(job, partitionOut, keyClass, valClass, codec,</span><br><span class="line">                                  spilledRecordsCounter);</span><br><span class="line">        <span class="comment">// å¾€ç£ç›˜å†™æ•°æ®æ—¶å…ˆåˆ¤æ–­æ˜¯å¦æœ‰combiner</span></span><br><span class="line">        <span class="keyword">if</span> (combinerRunner == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// spill directly</span></span><br><span class="line">          DataInputBuffer key = <span class="keyword">new</span> DataInputBuffer();</span><br><span class="line">          <span class="comment">// å†™å…¥ç›¸åŒpartitionçš„æ•°æ®</span></span><br><span class="line">          <span class="keyword">while</span> (spindex &lt; mend &amp;&amp;</span><br><span class="line">              kvmeta.get(offsetFor(spindex % maxRec) + PARTITION) == i) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> kvoff = offsetFor(spindex % maxRec);</span><br><span class="line">            <span class="keyword">int</span> keystart = kvmeta.get(kvoff + KEYSTART);</span><br><span class="line">            <span class="keyword">int</span> valstart = kvmeta.get(kvoff + VALSTART);</span><br><span class="line">            key.reset(kvbuffer, keystart, valstart - keystart);</span><br><span class="line">            getVBytesForOffset(kvoff, value);</span><br><span class="line">            writer.append(key, value);</span><br><span class="line">            ++spindex;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> spstart = spindex;</span><br><span class="line">          <span class="keyword">while</span> (spindex &lt; mend &amp;&amp;</span><br><span class="line">              kvmeta.get(offsetFor(spindex % maxRec)</span><br><span class="line">                        + PARTITION) == i) &#123;</span><br><span class="line">            ++spindex;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Note: we would like to avoid the combiner if we&#x27;ve fewer</span></span><br><span class="line">          <span class="comment">// than some threshold of records for a partition</span></span><br><span class="line">          <span class="keyword">if</span> (spstart != spindex) &#123;</span><br><span class="line">            combineCollector.setWriter(writer);</span><br><span class="line">            RawKeyValueIterator kvIter =</span><br><span class="line">              <span class="keyword">new</span> MRResultIterator(spstart, spindex);</span><br><span class="line">            combinerRunner.combine(kvIter, combineCollector);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// close the writer</span></span><br><span class="line">        writer.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// record offsets</span></span><br><span class="line">        <span class="comment">// è®°å½•å½“å‰partition içš„ä¿¡æ¯å†™å…¥ç´¢æ–‡ä»¶recä¸­</span></span><br><span class="line">        rec.startOffset = segmentStart;</span><br><span class="line">        rec.rawLength = writer.getRawLength() + CryptoUtils.cryptoPadding(job);</span><br><span class="line">        rec.partLength = writer.getCompressedLength() + CryptoUtils.cryptoPadding(job);</span><br><span class="line">        <span class="comment">// spillRecä¸­å­˜æ”¾äº†spillä¸­partitionçš„ä¿¡æ¯ï¼Œä¾¿äºåç»­å †æ’åºæ—¶ï¼Œå–å‡ºpartitionç›¸å…³çš„æ•°æ®è¿›è¡Œæ’åº</span></span><br><span class="line">        spillRec.putIndex(rec, i);</span><br><span class="line"></span><br><span class="line">        writer = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != writer) writer.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å†…å­˜ä¸­çš„indexæ–‡ä»¶æ˜¯å¦è¶…å‡ºé˜ˆå€¼ï¼Œè¶…å‡ºåˆ™å°†indexæ–‡ä»¶å†™å…¥ç£ç›˜</span></span><br><span class="line">    <span class="comment">// å½“è¶…å‡ºé˜ˆå€¼æ—¶åªæ˜¯æŠŠå½“å‰indexå’Œä¹‹åçš„indexå†™å…¥ç£ç›˜</span></span><br><span class="line">    <span class="keyword">if</span> (totalIndexCacheMemory &gt;= indexCacheMemoryLimit) &#123;</span><br><span class="line">      <span class="comment">// create spill index file</span></span><br><span class="line">      <span class="comment">// åˆ›å»ºindexæ–‡ä»¶</span></span><br><span class="line">      Path indexFilename =</span><br><span class="line">          mapOutputFile.getSpillIndexFileForWrite(numSpills, partitions</span><br><span class="line">              * MAP_OUTPUT_INDEX_RECORD_LENGTH);</span><br><span class="line">      spillRec.writeToFile(indexFilename, job);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      indexCacheList.add(spillRec);</span><br><span class="line">      totalIndexCacheMemory +=</span><br><span class="line">        spillRec.size() * MAP_OUTPUT_INDEX_RECORD_LENGTH;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;Finished spill &quot;</span> + numSpills);</span><br><span class="line">    ++numSpills;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (out != <span class="keyword">null</span>) out.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>sortAndSpillä¸­ï¼Œæœ‰mstartå’Œmendå¾—åˆ°ä¸€å…±æœ‰å¤šå°‘æ¡recordéœ€è¦spillåˆ°ç£ç›˜ï¼Œè°ƒç”¨sorter.sortå¯¹metaè¿›è¡Œæ’åºï¼Œå…ˆå¯¹partitionè¿›è¡Œæ’åºï¼Œç„¶åæŒ‰keyæ’åºï¼Œæ’åºçš„ç»“æœåªè°ƒæ•´metaçš„é¡ºåºã€‚</p><p>æ’åºä¹‹åï¼Œåˆ¤æ–­æ˜¯å¦æœ‰combinerï¼Œæ²¡æœ‰åˆ™ç›´æ¥å°†recordå†™å…¥ç£ç›˜ï¼Œå†™å…¥æ—¶æ˜¯ä¸€ä¸ªpartitionä¸€ä¸ªIndexRecordï¼Œå¦‚æœæœ‰combinerï¼Œåˆ™å°†è¯¥partitionçš„recordå†™å…¥kvIterï¼Œç„¶åè°ƒç”¨combinerRunner.combineæ‰§è¡Œcombinerã€‚</p><p>å†™å…¥ç£ç›˜ä¹‹åï¼Œå°†spillx.outå¯¹åº”çš„spillRecæ”¾å…¥å†…å­˜*indexCacheList.add(spillRec)*ï¼Œå¦‚æœæ‰€å å†…å­˜totalIndexCacheMemoryè¶…è¿‡äº†indexCacheMemoryLimitï¼Œåˆ™åˆ›å»ºindexæ–‡ä»¶ï¼Œå°†æ­¤æ¬¡åŠä»¥åçš„spillRecå†™å…¥indexæ–‡ä»¶å­˜å…¥ç£ç›˜ã€‚</p><p>æœ€åspillæ¬¡æ•°é€’å¢ã€‚sortAndSpillç»“æŸä¹‹åï¼Œå›åˆ°runæ–¹æ³•ä¸­ï¼Œæ‰§è¡Œfinallyä¸­çš„ä»£ç ï¼Œå¯¹kvstartå’Œbufstartèµ‹å€¼ï¼Œ<code>kvstart = kvend</code>ï¼Œ<code>bufstart = bufend</code>ï¼Œè®¾ç½®spillInProgressçš„çŠ¶æ€ä¸ºfalseã€‚</p><p>åœ¨spillçš„åŒæ—¶ï¼Œmapå¾€bufferçš„å†™æ“ä½œå¹¶æ²¡æœ‰åœæ­¢ï¼Œä¾ç„¶åœ¨è°ƒç”¨collectï¼Œå†æ¬¡å›åˆ°collectæ–¹æ³•ä¸­ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MapOutputBuffer.collect</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(K key, V value, <span class="keyword">final</span> <span class="keyword">int</span> partition</span></span></span><br><span class="line"><span class="params"><span class="function">                                 )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ–°æ•°æ®collectæ—¶ï¼Œå…ˆå°†å‰©ä½™çš„ç©ºé—´å‡å»å…ƒæ•°æ®çš„é•¿åº¦ï¼Œä¹‹åè¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">  bufferRemaining -= METASIZE;</span><br><span class="line">  <span class="keyword">if</span> (bufferRemaining &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// start spill if the thread is not running and the soft limit has been</span></span><br><span class="line">    <span class="comment">// reached</span></span><br><span class="line">    spillLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–æ¬¡spillæ—¶ï¼ŒspillInProgressæ˜¯false</span></span><br><span class="line">        <span class="keyword">if</span> (!spillInProgress) &#123;</span><br><span class="line">          <span class="comment">// å¾—åˆ°kvindexçš„byteä½ç½®</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> kvbidx = <span class="number">4</span> * kvindex;</span><br><span class="line">          <span class="comment">// å¾—åˆ°kvendçš„byteä½ç½®</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> kvbend = <span class="number">4</span> * kvend;</span><br><span class="line">          <span class="comment">// serialized, unspilled bytes always lie between kvindex and</span></span><br><span class="line">          <span class="comment">// bufindex, crossing the equator. Note that any void space</span></span><br><span class="line">          <span class="comment">// created by a reset must be included in &quot;used&quot; bytes</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> bUsed = distanceTo(kvbidx, bufindex);</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">boolean</span> bufsoftlimit = bUsed &gt;= softLimit;</span><br><span class="line">          <span class="keyword">if</span> ((kvbend + METASIZE) % kvbuffer.length !=</span><br><span class="line">              equator - (equator % METASIZE)) &#123;</span><br><span class="line">            <span class="comment">// spill finished, reclaim space</span></span><br><span class="line">            resetSpill();</span><br><span class="line">            bufferRemaining = Math.min(</span><br><span class="line">                distanceTo(bufindex, kvbidx) - <span class="number">2</span> * METASIZE,</span><br><span class="line">                softLimit - bUsed) - METASIZE;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bufsoftlimit &amp;&amp; kvindex != kvend) &#123;</span><br><span class="line">            ...</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      spillLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ–°çš„recordéœ€è¦å†™å…¥bufferæ—¶ï¼Œåˆ¤æ–­<code>bufferRemaining -= METASIZE</code>ï¼Œæ­¤æ—¶çš„bufferRemainingæ˜¯åœ¨å¼€å§‹spillæ—¶è¢«é‡ç½®è¿‡çš„(æ­¤æ—¶çš„bufferRemainingåº”è¯¥æ¯”åˆå§‹çš„softLimitè¦å°)ï¼Œå½“bufferRemainingå°äºç­‰äº0æ—¶ï¼Œè¿›å…¥ifï¼Œæ­¤æ—¶spillInProgressçš„çŠ¶æ€ä¸ºfalseï¼Œè¿›å…¥if (!spillInProgress)ï¼ŒstartSpillæ—¶å¯¹kvendå’Œbufendè¿›è¡Œäº†é‡ç½®ï¼Œåˆ™æ­¤æ—¶<code>(kvbend + METASIZE) % kvbuffer.length != equator - (equator % METASIZE)</code>ï¼Œè°ƒç”¨<code>resetSpill()</code>ï¼Œå°†kvstartã€kvendå’Œbufstartã€bufendè®¾ç½®ä¸ºä¸Šæ¬¡startSpillæ—¶çš„ä½ç½®ã€‚æ­¤æ—¶bufferå·²å°†ä¸€éƒ¨åˆ†å†…å®¹å†™å…¥ç£ç›˜ï¼Œæœ‰å¤§é‡ç©ºä½™çš„ç©ºé—´ï¼Œåˆ™å¯¹bufferRemainingè¿›è¡Œé‡ç½®ï¼Œæ­¤æ¬¡ä¸spillã€‚</p><p>bufferRemainingå–å€¼ä¸º<code>Math.min(distanceTo(bufindex, kvbidx) - 2 * METASIZE, softLimit - bUsed) - METASIZE</code></p><p>æœ€åä¸€ä¸ªMETASIZEæ˜¯å½“å‰recordè¿›å…¥collectä¹‹åbufferRemainingå‡å»çš„é‚£ä¸ªMETASIZEï¼Œä¸ºä»€ä¹ˆè¦å‡å»2*METASIZEï¼Œä¸çŸ¥é“ã€‚ã€‚ã€‚ã€‚ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">resetSpill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> e = equator;</span><br><span class="line">  bufstart = bufend = e;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> aligned = e - (e % METASIZE);</span><br><span class="line">  <span class="comment">// set start/end to point to first meta record</span></span><br><span class="line">  <span class="comment">// Cast one of the operands to long to avoid integer overflow</span></span><br><span class="line">  kvstart = kvend = (<span class="keyword">int</span>)</span><br><span class="line">    (((<span class="keyword">long</span>)aligned - METASIZE + kvbuffer.length) % kvbuffer.length) / <span class="number">4</span>;</span><br><span class="line">  LOG.info(<span class="string">&quot;(RESET) equator &quot;</span> + e + <span class="string">&quot; kv &quot;</span> + kvstart + <span class="string">&quot;(&quot;</span> +</span><br><span class="line">    (kvstart * <span class="number">4</span>) + <span class="string">&quot;)&quot;</span> + <span class="string">&quot; kvi &quot;</span> + kvindex + <span class="string">&quot;(&quot;</span> + (kvindex * <span class="number">4</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“bufferRemainingå†æ¬¡å°äºç­‰äº0æ—¶ï¼Œè¿›è¡Œspillï¼Œè¿™ä»¥åå°±éƒ½æ˜¯å¥—è·¯äº†ã€‚ç¯å½¢ç¼“å†²åŒºåˆ†æåˆ°æ­¤ç»“æŸã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> MapReduce </tag>
            
            <tag> ç¯å½¢ç¼“å†²åŒº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceæºç è§£æ--Mapè§£æ</title>
      <link href="/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Map%E8%A7%A3%E6%9E%90.html"/>
      <url>/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Map%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<h2 id="MapReduceâ€“Map"><a href="#MapReduceâ€“Map" class="headerlink" title="MapReduceâ€“Map"></a>MapReduceâ€“Map</h2><p>MapReduceç”±Mapå’ŒReduceç»„æˆï¼Œè€ŒMapå’ŒReduceåˆå¯ä»¥åˆ†ä¸ºå¾ˆå¤šä¸ªå°phaseï¼Œä¸‹é¢å°±ä»æºç çš„è§’åº¦å»æ‰’ä¸‹Mapçš„æµç¨‹ã€‚<br>é€šè¿‡intellij ideaè¿›è¡Œdebugè°ƒè¯•ï¼Œåœ¨New APIçš„æµç¨‹å‘ç°Mapä¸­å…·ä½“æµç¨‹å¯ä»¥å¤§è‡´åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼šæœ‰Reduceå’Œæ²¡æœ‰Reduce</p><ul><li>æ²¡æœ‰Reduce</li></ul><blockquote><p>splitâ€“&gt;readâ€“map(ç”¨æˆ·è‡ªå®šä¹‰çš„mapå‡½æ•°)â€“&gt;write(æœªæ’åº)â€“&gt;output</p></blockquote><ul><li>æœ‰Reduce</li></ul><blockquote><p>splitâ€“&gt;readâ€“&gt;map(ç”¨æˆ·è‡ªå®šä¹‰çš„mapå‡½æ•°)â€“&gt;partitionâ€“&gt;collectâ€“&gt;bufferâ€“&gt;quicksortâ€“&gt;(combiner)â€“&gt;spillâ€“&gt;merge(heapsortã€combiner)â€“&gt;output</p></blockquote><p>æœ¬ç¯‡ä¸»è¦ä»‹ç»æœ‰Reduceçš„æƒ…å†µä¸‹Mapä¸­å„ä¸ªé˜¶æ®µçš„æµç¨‹ã€‚</p><span id="more"></span><p>è·Ÿè¸ªä»£ç åˆ°MapTask.runä¸­ï¼Œä»£ç ä¸­å…ˆæ ¹æ®æ˜¯å¦æœ‰Reduceå¯¹Mapé˜¶æ®µè¿›è¡Œåˆ†å‰²ï¼Œç„¶ååˆ¤æ–­Map Taskçš„ç±»å‹ï¼ˆMap Taskåˆ†ä¸ºjob setupã€job cleanupã€map taskã€task cleanupï¼‰ï¼Œä¸»è¦è·Ÿä¸‹map taskï¼Œè¿›å…¥<code>runNewMapper</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">final</span> JobConf job, <span class="keyword">final</span> TaskUmbilicalProtocol umbilical)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException, ClassNotFoundException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.umbilical = umbilical;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isMapTask()) &#123;</span><br><span class="line">    <span class="comment">// If there are no reducers then there won&#x27;t be any sort. Hence the map </span></span><br><span class="line">    <span class="comment">// phase will govern the entire attempt&#x27;s progress.</span></span><br><span class="line">    <span class="keyword">if</span> (conf.getNumReduceTasks() == <span class="number">0</span>) &#123;</span><br><span class="line">      mapPhase = getProgress().addPhase(<span class="string">&quot;map&quot;</span>, <span class="number">1.0f</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// If there are reducers then the entire attempt&#x27;s progress will be </span></span><br><span class="line">      <span class="comment">// split between the map phase (67%) and the sort phase (33%).</span></span><br><span class="line">      mapPhase = getProgress().addPhase(<span class="string">&quot;map&quot;</span>, <span class="number">0.667f</span>);</span><br><span class="line">      sortPhase  = getProgress().addPhase(<span class="string">&quot;sort&quot;</span>, <span class="number">0.333f</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  TaskReporter reporter = startReporter(umbilical);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> useNewApi = job.getUseNewMapper();</span><br><span class="line">  initialize(job, getJobID(), reporter, useNewApi);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// check if it is a cleanupJobTask</span></span><br><span class="line">  <span class="keyword">if</span> (jobCleanup) &#123;</span><br><span class="line">    runJobCleanupTask(umbilical, reporter);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (jobSetup) &#123;</span><br><span class="line">    runJobSetupTask(umbilical, reporter);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (taskCleanup) &#123;</span><br><span class="line">    runTaskCleanupTask(umbilical, reporter);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useNewApi) &#123;</span><br><span class="line">    runNewMapper(job, splitMetaInfo, umbilical, reporter);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    runOldMapper(job, splitMetaInfo, umbilical, reporter);</span><br><span class="line">  &#125;</span><br><span class="line">  done(umbilical, reporter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> &lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runNewMapper</span><span class="params">(<span class="keyword">final</span> JobConf job,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">final</span> TaskSplitIndex splitIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">final</span> TaskUmbilicalProtocol umbilical,</span></span></span><br><span class="line"><span class="params"><span class="function">                  TaskReporter reporter</span></span></span><br><span class="line"><span class="params"><span class="function">                  )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException,</span></span><br><span class="line"><span class="function">                           InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// make a task context so we can get the classes</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// make a mapper</span></span><br><span class="line">  <span class="comment">// é€šè¿‡åå°„å¾—åˆ°Mapperçš„å®ç°ç±»</span></span><br><span class="line">  org.apache.hadoop.mapreduce.Mapper&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt; mapper =</span><br><span class="line">    (org.apache.hadoop.mapreduce.Mapper&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;)</span><br><span class="line">      ReflectionUtils.newInstance(taskContext.getMapperClass(), job);</span><br><span class="line">  <span class="comment">// make the input format</span></span><br><span class="line">  org.apache.hadoop.mapreduce.InputFormat&lt;INKEY,INVALUE&gt; inputFormat =</span><br><span class="line">    (org.apache.hadoop.mapreduce.InputFormat&lt;INKEY,INVALUE&gt;)</span><br><span class="line">      ReflectionUtils.newInstance(taskContext.getInputFormatClass(), job);</span><br><span class="line">  <span class="comment">// rebuild the input split</span></span><br><span class="line">  org.apache.hadoop.mapreduce.InputSplit split = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// å¾—åˆ°mapå¯¹åº”çš„split</span></span><br><span class="line">  split = getSplitDetails(<span class="keyword">new</span> Path(splitIndex.getSplitLocation()),</span><br><span class="line">      splitIndex.getStartOffset());</span><br><span class="line">  LOG.info(<span class="string">&quot;Processing split: &quot;</span> + split);</span><br><span class="line">  <span class="comment">// å¾—åˆ°RecordReaderå¯¹è±¡ï¼Œç”¨äºè¯»å–splitä¸­çš„æ–‡æœ¬ï¼Œä½¿å…¶å˜ä¸ºkey valueçš„æ ¼å¼</span></span><br><span class="line">  org.apache.hadoop.mapreduce.RecordReader&lt;INKEY,INVALUE&gt; input =</span><br><span class="line">    <span class="keyword">new</span> NewTrackingRecordReader&lt;INKEY,INVALUE&gt;</span><br><span class="line">      (split, inputFormat, reporter, taskContext);</span><br><span class="line">  </span><br><span class="line">  job.setBoolean(JobContext.SKIP_RECORDS, isSkipping());</span><br><span class="line">  org.apache.hadoop.mapreduce.RecordWriter output = <span class="keyword">null</span>;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// get an output object</span></span><br><span class="line">  <span class="keyword">if</span> (job.getNumReduceTasks() == <span class="number">0</span>) &#123;</span><br><span class="line">  <span class="comment">// æ²¡æœ‰reduceæ—¶ï¼Œç›´æ¥è¾“å‡º</span></span><br><span class="line">    output = </span><br><span class="line">      <span class="keyword">new</span> NewDirectOutputCollector(taskContext, job, umbilical, reporter);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    output = <span class="keyword">new</span> NewOutputCollector(taskContext, job, umbilical, reporter);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  org.apache.hadoop.mapreduce.MapContext&lt;INKEY, INVALUE, OUTKEY, OUTVALUE&gt; </span><br><span class="line">  mapContext = </span><br><span class="line">    <span class="keyword">new</span> MapContextImpl&lt;INKEY, INVALUE, OUTKEY, OUTVALUE&gt;(job, getTaskID(), </span><br><span class="line">        input, output, </span><br><span class="line">        committer, </span><br><span class="line">        reporter, split);</span><br><span class="line"></span><br><span class="line">  org.apache.hadoop.mapreduce.Mapper&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;.Context </span><br><span class="line">      mapperContext = </span><br><span class="line">        <span class="keyword">new</span> WrappedMapper&lt;INKEY, INVALUE, OUTKEY, OUTVALUE&gt;().getMapContext(</span><br><span class="line">            mapContext);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// read split</span></span><br><span class="line">    input.initialize(split, mapperContext);</span><br><span class="line">    <span class="comment">// è°ƒç”¨ç”¨æˆ·ç»§æ‰¿çš„Mapperç±»ä¸­çš„æ–¹æ³•   ä¹Ÿå°±æ˜¯ç”¨æˆ·ç¼–å†™çš„mapé˜¶æ®µ</span></span><br><span class="line">    mapper.run(mapperContext);</span><br><span class="line">    mapPhase.complete();</span><br><span class="line">    <span class="comment">// SORTé˜¶æ®µï¼Œåœ¨æ­¤é˜¶æ®µè¿›è¡Œmerge ä¸´æ—¶æ–‡ä»¶</span></span><br><span class="line">    setPhase(TaskStatus.Phase.SORT);</span><br><span class="line">    statusUpdate(umbilical);</span><br><span class="line">    input.close();</span><br><span class="line">    input = <span class="keyword">null</span>;</span><br><span class="line">    output.close(mapperContext);</span><br><span class="line">    output = <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    closeQuietly(input);</span><br><span class="line">    closeQuietly(output, mapperContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Split"><a href="#Split" class="headerlink" title="Split"></a>Split</h2><p><code>runNewMapper</code>ä¸­åŒ…å«äº†æ•´ä¸ªMapçš„æ‰€æœ‰phaseï¼Œé¦–å…ˆé€šè¿‡<code>split = getSplitDetails()</code>å¾—åˆ°å½“å‰mapå¯¹åº”çš„splitï¼Œsplitæ˜¯åœ¨<code>JobSubmitter.submitJobInternal</code>ä¸­è°ƒç”¨<code>writeSplits</code>å¾—åˆ°çš„ï¼Œæœ‰å¤šå°‘ä¸ªsplitå°±å¯¹åº”å¤šå°‘ä¸ªmapã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T extends InputSplit&gt;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">writeNewSplits</span><span class="params">(JobContext job, Path jobSubmitDir)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">    InterruptedException, ClassNotFoundException </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">// é€šè¿‡InputFormatä»åŸæ–‡ä»¶ä¸­è¾¾åˆ°splits</span></span><br><span class="line">  List&lt;InputSplit&gt; splits = input.getSplits(job);</span><br><span class="line">  T[] array = (T[]) splits.toArray(<span class="keyword">new</span> InputSplit[splits.size()]);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// sort the splits into order based on size, so that the biggest</span></span><br><span class="line">  <span class="comment">// go first</span></span><br><span class="line">  Arrays.sort(array, <span class="keyword">new</span> SplitComparator());</span><br><span class="line">  JobSplitWriter.createSplitFiles(jobSubmitDir, conf, </span><br><span class="line">      jobSubmitDir.getFileSystem(conf), array);</span><br><span class="line">  <span class="keyword">return</span> array.length;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//FileInputFormat.getSplits</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> List&lt;InputSplit&gt; <span class="title">getSplits</span><span class="params">(JobContext job)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Stopwatch sw = <span class="keyword">new</span> Stopwatch().start();</span><br><span class="line">  <span class="keyword">long</span> minSize = Math.max(getFormatMinSplitSize(), getMinSplitSize(job));</span><br><span class="line">  <span class="keyword">long</span> maxSize = getMaxSplitSize(job);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// generate splits</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span> (FileStatus file: files) &#123;</span><br><span class="line">...</span><br><span class="line">    <span class="keyword">if</span> (length != <span class="number">0</span>) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span> (isSplitable(job, path)) &#123;</span><br><span class="line">        <span class="keyword">long</span> blockSize = file.getBlockSize();</span><br><span class="line">        <span class="comment">// å¾—åˆ°splitçš„å¤§å°ï¼Œæ­¤å‚æ•°å…³ç³»ç€mapçš„ä¸ªæ•°ï¼Œæ¯”è¾ƒé‡è¦</span></span><br><span class="line">        <span class="keyword">long</span> splitSize = computeSplitSize(blockSize, minSize, maxSize);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> bytesRemaining = length;</span><br><span class="line">        <span class="comment">// å¦‚æœå½“å‰fileçš„å¤§å°å°äºsplitSizeåˆ™ä¸è¿›å…¥whileå¾ªç¯ï¼Œå³ä¸å¯¹è¯¥fileè¿›è¡Œsplit</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå°±æ˜¯è¯´å¦‚æœå½“å‰mrä¸­åŒ…å«å¤§é‡çš„å°æ–‡ä»¶ï¼Œåˆ™è¯¥splitSizeä¸èƒ½å†³å®šmapçš„ä¸ªæ•°</span></span><br><span class="line">        <span class="keyword">while</span> (((<span class="keyword">double</span>) bytesRemaining)/splitSize &gt; SPLIT_SLOP) &#123;</span><br><span class="line">          <span class="keyword">int</span> blkIndex = getBlockIndex(blkLocations, length-bytesRemaining);</span><br><span class="line">          splits.add(makeSplit(path, length-bytesRemaining, splitSize,</span><br><span class="line">                      blkLocations[blkIndex].getHosts(),</span><br><span class="line">                      blkLocations[blkIndex].getCachedHosts()));</span><br><span class="line">          bytesRemaining -= splitSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bytesRemaining != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">int</span> blkIndex = getBlockIndex(blkLocations, length-bytesRemaining);</span><br><span class="line">          splits.add(makeSplit(path, length-bytesRemaining, bytesRemaining,</span><br><span class="line">                     blkLocations[blkIndex].getHosts(),</span><br><span class="line">                     blkLocations[blkIndex].getCachedHosts()));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// not splitable</span></span><br><span class="line">        splits.add(makeSplit(path, <span class="number">0</span>, length, blkLocations[<span class="number">0</span>].getHosts(),</span><br><span class="line">                    blkLocations[<span class="number">0</span>].getCachedHosts()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">      <span class="comment">//Create empty hosts array for zero length files</span></span><br><span class="line">      splits.add(makeSplit(path, <span class="number">0</span>, length, <span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> splits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ä»£ç å°†mrçš„è¾“å…¥æ–‡ä»¶è¿›è¡Œåˆ‡åˆ†ä¸ºsplitsï¼Œå…¶ä¸­<code>splitSize</code>å‚æ•°æ¯”è¾ƒé‡è¦ï¼Œåœ¨æ­¤å¯¹å…¶å–å€¼ä»£ç è¿›è¡Œè§£æä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">long</span> minSize = Math.max(getFormatMinSplitSize(), getMinSplitSize(job));</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">getFormatMinSplitSize</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getMinSplitSize</span><span class="params">(JobContext job)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// SPLIT_MINSIZE = &quot;mapreduce.input.fileinputformat.split.minsize&quot;</span></span><br><span class="line">  <span class="comment">// é»˜è®¤ä¸º0</span></span><br><span class="line">  <span class="keyword">return</span> job.getConfiguration().getLong(SPLIT_MINSIZE, <span class="number">1L</span>);</span><br><span class="line">&#125;</span><br><span class="line">minSize = Math.max(<span class="number">1</span>, <span class="number">1</span>)</span><br><span class="line"><span class="keyword">long</span> maxSize = getMaxSplitSize(job);</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">long</span> <span class="title">getMaxSplitSize</span><span class="params">(JobContext context)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// SPLIT_MAXSIZE = &quot;mapreduce.input.fileinputformat.split.maxsize&quot;</span></span><br><span class="line">  <span class="keyword">return</span> context.getConfiguration().getLong(SPLIT_MAXSIZE, </span><br><span class="line">                                            Long.MAX_VALUE);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// hadsä¸­å—çš„å¤§å°ï¼Œé»˜è®¤128M</span></span><br><span class="line"><span class="keyword">long</span> blockSize = file.getBlockSize();</span><br><span class="line"><span class="keyword">long</span> splitSize = computeSplitSize(blockSize, minSize, maxSize);</span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">long</span> <span class="title">computeSplitSize</span><span class="params">(<span class="keyword">long</span> blockSize, <span class="keyword">long</span> minSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">long</span> maxSize)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> Math.max(minSize, Math.min(maxSize, blockSize));</span><br><span class="line">&#125;</span><br><span class="line">splitSize = Math.max(max(<span class="number">1</span>, mapreduce.input.fileinputformat.split.minsize),</span><br><span class="line">min(mapreduce.input.fileinputformat.split.maxsize, blockSize));</span><br></pre></td></tr></table></figure><p>splitSizeçš„å¤§å°ç”±<code>split.minsize</code>ã€<code>split.maxsize</code>å’Œ<code>blocksize</code>è¿™ä¸‰ä¸ªå‚æ•°æ§åˆ¶ï¼Œå…¶ä¸­ä¸»è¦æ˜¯ç”±<code>split.minsize</code>å’Œ<code>blocksize</code>ä¸¤ä¸ªå‚æ•°å†³å®šï¼Œ_å–è¿™ä¸¤ä¸ªçš„è¾ƒå¤§å€¼_ã€‚</p><h2 id="read"><a href="#read" class="headerlink" title="read"></a>read</h2><p>å°†è¾“å…¥æ–‡ä»¶åˆ‡åˆ†ä¸ºsplitsä¹‹åï¼Œåœ¨MapTask.runNewMapperä¸­åŠ è½½ï¼Œç”±RecordReaderå¯¹è±¡è¿›è¡Œè¯»å–</p><h2 id="map-ç”¨æˆ·è‡ªå®šä¹‰çš„mapå‡½æ•°"><a href="#map-ç”¨æˆ·è‡ªå®šä¹‰çš„mapå‡½æ•°" class="headerlink" title="map(ç”¨æˆ·è‡ªå®šä¹‰çš„mapå‡½æ•°)"></a>map(ç”¨æˆ·è‡ªå®šä¹‰çš„mapå‡½æ•°)</h2><p>è¯»å–splitæ–‡ä»¶ä¹‹åï¼Œè°ƒç”¨<code>Mapper.run</code>æ–¹æ³•ï¼Œè¿›å…¥ç”¨æˆ·è‡ªå·±ç»§æ‰¿çš„Mapperç±»ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Mapper.run</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// æ‰§è¡Œç”¨æˆ·é‡å†™çš„setup</span></span><br><span class="line">  setup(context);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// è¿­ä»£</span></span><br><span class="line">    <span class="keyword">while</span> (context.nextKeyValue()) &#123;</span><br><span class="line">      <span class="comment">// æ‰§è¡Œç”¨æˆ·é‡å†™çš„mapå‡½æ•°</span></span><br><span class="line">      map(context.getCurrentKey(), context.getCurrentValue(), context);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    cleanup(context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ä»¥WordCountä»£ç ä¸ºä¾‹</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context</span></span></span><br><span class="line"><span class="params"><span class="function">)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">    StringTokenizer itr = <span class="keyword">new</span> StringTokenizer(value.toString());</span><br><span class="line">    <span class="keyword">while</span> (itr.hasMoreTokens()) &#123;</span><br><span class="line">        word.set(itr.nextToken());</span><br><span class="line">        context.write(word, one);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="collect"><a href="#collect" class="headerlink" title="collect"></a>collect</h2><p>mapé€»è¾‘å®Œä¹‹åï¼Œå°†mapçš„æ¯æ¡ç»“æœé€šè¿‡<code>context.write</code>è¿›è¡Œcollectã€‚æ­¤å¤„çš„<code>context.write</code>æœ€ç»ˆè°ƒç”¨çš„æ˜¯åœ¨<code>runNewMapper</code>ä¸­å®ä¾‹åŒ–çš„outputï¼ˆ<code>output = new NewOutputCollector(taskContext, job, umbilical, reporter)</code>ï¼‰å¯¹è±¡çš„<code>write</code>æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// NewOutputCollector.write</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(K key, V value)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  collector.collect(key, value,</span><br><span class="line">                    partitioner.getPartition(key, value, partitions));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="partition"><a href="#partition" class="headerlink" title="partition"></a>partition</h2><p>ç”±ä¸Šé¢çš„ä»£ç å¯ä»¥çœ‹å‡ºæ¯æ¡è¢«mapå¤„ç†ä¹‹åçš„ç»“æœåœ¨collectä¸­ï¼Œä¼šå¯¹å…ˆå¯¹å…¶è¿›è¡Œåˆ†åŒºå¤„ç†ï¼Œé»˜è®¤ä½¿ç”¨HashPartitioner.java</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(K key, V value,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">int</span> numReduceTasks)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> (key.hashCode() &amp; Integer.MAX_VALUE) % numReduceTasks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="buffer"><a href="#buffer" class="headerlink" title="buffer"></a>buffer</h2><p>å°†mapå¤„ç†ä¹‹åçš„key value è¿›è¡Œåˆ†åŒºä¹‹åï¼Œå†™å…¥bufferä¸­çš„_ç¯å½¢ç¼“å†²åŒº_ä¸­ã€‚<br>å…ˆæ¥çœ‹ä¸‹ç¯å½¢ç¼“å†²åŒºçš„æ•°æ®ç»“æ„ï¼Œç„¶åç†è§£å…¶æ•°æ®å†™å…¥å°±æ¯”è¾ƒå®¹æ˜“äº†ã€‚<br>ç¯å½¢ç¼“å†²åŒºåœ¨<code>MapTask.MapOutputBuffer</code>ä¸­å®šä¹‰ï¼Œç›¸å…³çš„å±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// k/v accounting</span></span><br><span class="line"><span class="comment">// å­˜æ”¾metaæ•°æ®çš„IntBufferï¼Œéƒ½æ˜¯int entryï¼Œå 4byte</span></span><br><span class="line"><span class="keyword">private</span> IntBuffer kvmeta; <span class="comment">// metadata overlay on backing store</span></span><br><span class="line"><span class="keyword">int</span> kvstart;            <span class="comment">// marks origin of spill metadata</span></span><br><span class="line"><span class="keyword">int</span> kvend;              <span class="comment">// marks end of spill metadata</span></span><br><span class="line"><span class="keyword">int</span> kvindex;            <span class="comment">// marks end of fully serialized records</span></span><br><span class="line"><span class="comment">// åˆ†å‰²metaå’Œkey valueå†…å®¹çš„æ ‡è¯†   </span></span><br><span class="line"><span class="comment">// metaæ•°æ®å’Œkey valueå†…å®¹éƒ½å­˜æ”¾åœ¨åŒä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼Œæ‰€ä»¥éœ€è¦åˆ†éš”å¼€</span></span><br><span class="line"><span class="keyword">int</span> equator;            <span class="comment">// marks origin of meta/serialization</span></span><br><span class="line"><span class="keyword">int</span> bufstart;           <span class="comment">// marks beginning of spill</span></span><br><span class="line"><span class="keyword">int</span> bufend;             <span class="comment">// marks beginning of collectable</span></span><br><span class="line"><span class="keyword">int</span> bufmark;            <span class="comment">// marks end of record</span></span><br><span class="line"><span class="keyword">int</span> bufindex;           <span class="comment">// marks end of collected</span></span><br><span class="line"><span class="keyword">int</span> bufvoid;            <span class="comment">// marks the point where we should stop</span></span><br><span class="line">                        <span class="comment">// reading at the end of the buffer</span></span><br><span class="line"><span class="comment">// å­˜æ”¾key valueçš„byteæ•°ç»„ï¼Œå•ä½æ˜¯byteï¼Œæ³¨æ„ä¸kvmetaåŒºåˆ†</span></span><br><span class="line"><span class="keyword">byte</span>[] kvbuffer;        <span class="comment">// main output buffer</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">byte</span>[] b0 = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line"><span class="comment">// key valueåœ¨kvbufferä¸­çš„åœ°å€å­˜æ”¾åœ¨åç§»kvindexçš„è·ç¦»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALSTART = <span class="number">0</span>;         <span class="comment">// val offset in acct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> KEYSTART = <span class="number">1</span>;         <span class="comment">// key offset in acct</span></span><br><span class="line"><span class="comment">// partitionä¿¡æ¯å­˜åœ¨kvmetaä¸­åç§»kvindexçš„è·ç¦»</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> PARTITION = <span class="number">2</span>;        <span class="comment">// partition offset in acct</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> VALLEN = <span class="number">3</span>;           <span class="comment">// length of value</span></span><br><span class="line"><span class="comment">// ä¸€å¯¹key valueçš„metaæ•°æ®åœ¨kvmetaä¸­å ç”¨çš„ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> NMETA = <span class="number">4</span>;            <span class="comment">// num meta ints</span></span><br><span class="line"><span class="comment">// ä¸€å¯¹key valueçš„metaæ•°æ®åœ¨kvmetaä¸­å ç”¨çš„byteæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> METASIZE = NMETA * <span class="number">4</span>; <span class="comment">// size in bytes</span></span><br><span class="line"></span><br></pre></td></tr></table></figure><p>ç¯å½¢ç¼“å†²åŒºçš„ç»“æ„åœ¨<code>MapOutputBuffer.init</code>ä¸­åˆ›å»ºã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(MapOutputCollector.Context context</span></span></span><br><span class="line"><span class="params"><span class="function">                )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException </span>&#123;</span><br><span class="line">...</span><br><span class="line">  <span class="comment">//MAP_SORT_SPILL_PERCENT = mapreduce.map.sort.spill.percent</span></span><br><span class="line">  <span class="comment">// map ç«¯bufferæ‰€å çš„ç™¾åˆ†æ¯”</span></span><br><span class="line">  <span class="comment">//sanity checks</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">float</span> spillper =</span><br><span class="line">    job.getFloat(JobContext.MAP_SORT_SPILL_PERCENT, (<span class="keyword">float</span>)<span class="number">0.8</span>);</span><br><span class="line">  <span class="comment">//IO_SORT_MB = &quot;mapreduce.task.io.sort.mb&quot;</span></span><br><span class="line">  <span class="comment">// map ç«¯bufferå¤§å°</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> sortmb = job.getInt(JobContext.IO_SORT_MB, <span class="number">100</span>);</span><br><span class="line">  <span class="comment">// æ‰€æœ‰çš„spill index åœ¨å†…å­˜æ‰€å çš„å¤§å°çš„é˜ˆå€¼</span></span><br><span class="line">  indexCacheMemoryLimit = job.getInt(JobContext.INDEX_CACHE_MEMORY_LIMIT,</span><br><span class="line">                                     INDEX_CACHE_MEMORY_LIMIT_DEFAULT);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ’åºçš„å®ç°ç±»ï¼Œå¯ä»¥è‡ªå·±å®ç°ã€‚ è¿™é‡Œç”¨çš„æ˜¯æ”¹å†™çš„å¿«æ’</span></span><br><span class="line">  sorter = ReflectionUtils.newInstance(job.getClass(<span class="string">&quot;map.sort.class&quot;</span>,</span><br><span class="line">        QuickSort.class, IndexedSorter.class), job);</span><br><span class="line">  <span class="comment">// buffers and accounting</span></span><br><span class="line">  <span class="comment">// ä¸Šé¢IO_SORT_MBçš„å•ä½æ˜¯MBï¼Œå·¦ç§»20ä½å°†å•ä½è½¬åŒ–ä¸ºbyte</span></span><br><span class="line">  <span class="keyword">int</span> maxMemUsage = sortmb &lt;&lt; <span class="number">20</span>;</span><br><span class="line">  <span class="comment">// METASIZEæ˜¯å…ƒæ•°æ®çš„é•¿åº¦ï¼Œå…ƒæ•°æ®æœ‰4ä¸ªintå•å…ƒï¼Œåˆ†åˆ«ä¸º</span></span><br><span class="line">  <span class="comment">// VALSTARTã€KEYSTARTã€PARTITIONã€VALLENï¼Œè€Œintä¸º4ä¸ªbyteï¼Œ</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥METASIZEé•¿åº¦ä¸º16ã€‚ä¸‹é¢æ˜¯è®¡ç®—bufferä¸­æœ€å¤šæœ‰å¤šå°‘byteæ¥å­˜å…ƒæ•°æ®</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶maxMemUsageæ˜¯METASIZEçš„æ•´æ•°å€</span></span><br><span class="line">  maxMemUsage -= maxMemUsage % METASIZE;</span><br><span class="line">  <span class="comment">// å…ƒæ•°æ®æ•°ç»„  ä»¥byteä¸ºå•ä½</span></span><br><span class="line">  kvbuffer = <span class="keyword">new</span> <span class="keyword">byte</span>[maxMemUsage];</span><br><span class="line">  bufvoid = kvbuffer.length;</span><br><span class="line">  <span class="comment">// å°†kvbufferè½¬åŒ–ä¸ºintå‹çš„kvmeta  ä»¥intä¸ºå•ä½ï¼Œä¹Ÿå°±æ˜¯4byte</span></span><br><span class="line">  kvmeta = ByteBuffer.wrap(kvbuffer)</span><br><span class="line">     .order(ByteOrder.nativeOrder())</span><br><span class="line">     .asIntBuffer();</span><br><span class="line">  <span class="comment">// è®¾ç½®bufå’Œkvmetaçš„åˆ†ç•Œçº¿</span></span><br><span class="line">  setEquator(<span class="number">0</span>);</span><br><span class="line">  bufstart = bufend = bufindex = equator;</span><br><span class="line">  kvstart = kvend = kvindex;</span><br><span class="line">  <span class="comment">// kvmetaä¸­å­˜æ”¾å…ƒæ•°æ®å®ä½“çš„æœ€å¤§ä¸ªæ•°</span></span><br><span class="line">  maxRec = kvmeta.capacity() / NMETA;</span><br><span class="line">  <span class="comment">// buffer spillæ—¶çš„é˜ˆå€¼ï¼ˆä¸å•å•æ˜¯sortmb*spillperï¼‰</span></span><br><span class="line">  <span class="comment">// æ›´åŠ ç²¾ç¡®çš„æ˜¯kvbuffer.length*spiller</span></span><br><span class="line">  softLimit = (<span class="keyword">int</span>)(kvbuffer.length * spillper);</span><br><span class="line">  <span class="comment">// æ­¤å˜é‡è¾ƒä¸ºé‡è¦ï¼Œä½œä¸ºspillçš„åŠ¨æ€è¡¡é‡æ ‡å‡†</span></span><br><span class="line">  bufferRemaining = softLimit;</span><br><span class="line">  LOG.info(JobContext.IO_SORT_MB + <span class="string">&quot;: &quot;</span> + sortmb);</span><br><span class="line">  LOG.info(<span class="string">&quot;soft limit at &quot;</span> + softLimit);</span><br><span class="line">  LOG.info(<span class="string">&quot;bufstart = &quot;</span> + bufstart + <span class="string">&quot;; bufvoid = &quot;</span> + bufvoid);</span><br><span class="line">  LOG.info(<span class="string">&quot;kvstart = &quot;</span> + kvstart + <span class="string">&quot;; length = &quot;</span> + maxRec);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// k/v serialization</span></span><br><span class="line">  comparator = job.getOutputKeyComparator();</span><br><span class="line">  keyClass = (Class&lt;K&gt;)job.getMapOutputKeyClass();</span><br><span class="line">  valClass = (Class&lt;V&gt;)job.getMapOutputValueClass();</span><br><span class="line">  serializationFactory = <span class="keyword">new</span> SerializationFactory(job);</span><br><span class="line">  keySerializer = serializationFactory.getSerializer(keyClass);</span><br><span class="line">  <span class="comment">// å°†bbä½œä¸ºkeyåºåˆ—åŒ–å†™å…¥çš„output</span></span><br><span class="line">  keySerializer.open(bb);</span><br><span class="line">  valSerializer = serializationFactory.getSerializer(valClass);</span><br><span class="line">  <span class="comment">// å°†bbä½œä¸ºvalueåºåˆ—åŒ–å†™å…¥çš„output</span></span><br><span class="line">  valSerializer.open(bb);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// combiner</span></span><br><span class="line">  ...</span><br><span class="line">  spillInProgress = <span class="keyword">false</span>;</span><br><span class="line">  <span class="comment">// æœ€åä¸€æ¬¡mergeæ—¶ï¼Œåœ¨æœ‰combinerçš„æƒ…å†µä¸‹ï¼Œè¶…è¿‡æ­¤é˜ˆå€¼æ‰æ‰§è¡Œcombiner</span></span><br><span class="line">  minSpillsForCombine = job.getInt(JobContext.MAP_COMBINE_MIN_SPILLS, <span class="number">3</span>);</span><br><span class="line">  spillThread.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">  spillThread.setName(<span class="string">&quot;SpillThread&quot;</span>);</span><br><span class="line">  spillLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    spillThread.start();</span><br><span class="line">    <span class="keyword">while</span> (!spillThreadRunning) &#123;</span><br><span class="line">      spillDone.await();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Spill thread failed to initialize&quot;</span>, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    spillLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (sortSpillException != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Spill thread failed to initialize&quot;</span>,</span><br><span class="line">        sortSpillException);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// setEquator(0)çš„ä»£ç å¦‚ä¸‹</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setEquator</span><span class="params">(<span class="keyword">int</span> pos)</span> </span>&#123;</span><br><span class="line">  equator = pos;</span><br><span class="line">  <span class="comment">// set index prior to first entry, aligned at meta boundary</span></span><br><span class="line">  <span class="comment">// ç¬¬ä¸€ä¸ª entryçš„æœ«å°¾ä½ç½®ï¼Œå³å…ƒæ•°æ®å’Œkvæ•°æ®çš„åˆ†ç•Œçº¿   å•ä½æ˜¯byte</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> aligned = pos - (pos % METASIZE);</span><br><span class="line">  <span class="comment">// Cast one of the operands to long to avoid integer overflow</span></span><br><span class="line">  <span class="comment">// å…ƒæ•°æ®ä¸­å­˜æ”¾æ•°æ®çš„èµ·å§‹ä½ç½®</span></span><br><span class="line">  kvindex = (<span class="keyword">int</span>)</span><br><span class="line">    (((<span class="keyword">long</span>)aligned - METASIZE + kvbuffer.length) % kvbuffer.length) / <span class="number">4</span>;</span><br><span class="line">  LOG.info(<span class="string">&quot;(EQUATOR) &quot;</span> + pos + <span class="string">&quot; kvi &quot;</span> + kvindex +</span><br><span class="line">      <span class="string">&quot;(&quot;</span> + (kvindex * <span class="number">4</span>) + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶ç¯å½¢ç¼“å†²åŒºå·²è¢«åˆå§‹åŒ–ï¼Œä½†å…¶å…·ä½“ç»“æ„åŠå…¶ä½¿ç”¨è¿˜ä¸å¤ªæ˜äº†ï¼Œç»§ç»­çœ‹ä¸‹é¢çš„ä»£ç ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MapOutputBuffer.collect</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">collect</span><span class="params">(K key, V value, <span class="keyword">final</span> <span class="keyword">int</span> partition</span></span></span><br><span class="line"><span class="params"><span class="function">                                 )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ–°æ•°æ®collectæ—¶ï¼Œå…ˆå°†å‰©ä½™çš„ç©ºé—´å‡å»å…ƒæ•°æ®çš„é•¿åº¦ï¼Œä¹‹åè¿›è¡Œåˆ¤æ–­</span></span><br><span class="line">  bufferRemaining -= METASIZE;</span><br><span class="line">  <span class="keyword">if</span> (bufferRemaining &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// start spill if the thread is not running and the soft limit has been</span></span><br><span class="line">    <span class="comment">// reached</span></span><br><span class="line">    spillLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        <span class="comment">// é¦–æ¬¡spillæ—¶ï¼ŒspillInProgressæ˜¯false</span></span><br><span class="line">        <span class="keyword">if</span> (!spillInProgress) &#123;</span><br><span class="line">          <span class="comment">// å¾—åˆ°kvindexçš„byteä½ç½®</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> kvbidx = <span class="number">4</span> * kvindex;</span><br><span class="line">          <span class="comment">// å¾—åˆ°kvendçš„byteä½ç½®</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> kvbend = <span class="number">4</span> * kvend;</span><br><span class="line">          <span class="comment">// serialized, unspilled bytes always lie between kvindex and</span></span><br><span class="line">          <span class="comment">// bufindex, crossing the equator. Note that any void space</span></span><br><span class="line">          <span class="comment">// created by a reset must be included in &quot;used&quot; bytes</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> bUsed = distanceTo(kvbidx, bufindex);</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">boolean</span> bufsoftlimit = bUsed &gt;= softLimit;</span><br><span class="line">          <span class="keyword">if</span> ((kvbend + METASIZE) % kvbuffer.length !=</span><br><span class="line">              equator - (equator % METASIZE)) &#123;</span><br><span class="line">            <span class="comment">// spill finished, reclaim space</span></span><br><span class="line">            resetSpill();</span><br><span class="line">            bufferRemaining = Math.min(</span><br><span class="line">                distanceTo(bufindex, kvbidx) - <span class="number">2</span> * METASIZE,</span><br><span class="line">                softLimit - bUsed) - METASIZE;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (bufsoftlimit &amp;&amp; kvindex != kvend) &#123;</span><br><span class="line">            <span class="comment">// spill records, if any collected; check latter, as it may</span></span><br><span class="line">            <span class="comment">// be possible for metadata alignment to hit spill pcnt</span></span><br><span class="line">            startSpill();</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> avgRec = (<span class="keyword">int</span>)</span><br><span class="line">              (mapOutputByteCounter.getCounter() /</span><br><span class="line">              mapOutputRecordCounter.getCounter());</span><br><span class="line">            <span class="comment">// leave at least half the split buffer for serialization data</span></span><br><span class="line">            <span class="comment">// ensure that kvindex &gt;= bufindex</span></span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> distkvi = distanceTo(bufindex, kvbidx);</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> newPos = (bufindex +</span><br><span class="line">              Math.max(<span class="number">2</span> * METASIZE - <span class="number">1</span>,</span><br><span class="line">                      Math.min(distkvi / <span class="number">2</span>,</span><br><span class="line">                               distkvi / (METASIZE + avgRec) * METASIZE)))</span><br><span class="line">              % kvbuffer.length;</span><br><span class="line">            setEquator(newPos);</span><br><span class="line">            bufmark = bufindex = newPos;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> serBound = <span class="number">4</span> * kvend;</span><br><span class="line">            <span class="comment">// bytes remaining before the lock must be held and limits</span></span><br><span class="line">            <span class="comment">// checked is the minimum of three arcs: the metadata space, the</span></span><br><span class="line">            <span class="comment">// serialization space, and the soft limit</span></span><br><span class="line">            bufferRemaining = Math.min(</span><br><span class="line">                <span class="comment">// metadata max</span></span><br><span class="line">                distanceTo(bufend, newPos),</span><br><span class="line">                Math.min(</span><br><span class="line">                  <span class="comment">// serialization max</span></span><br><span class="line">                  distanceTo(newPos, serBound),</span><br><span class="line">                  <span class="comment">// soft limit</span></span><br><span class="line">                  softLimit)) - <span class="number">2</span> * METASIZE;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">while</span> (<span class="keyword">false</span>);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      spillLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†key value åŠå…ƒæ•°æ®ä¿¡æ¯å†™å…¥ç¼“å†²åŒº</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// serialize key bytes into buffer</span></span><br><span class="line">    <span class="keyword">int</span> keystart = bufindex;</span><br><span class="line">    <span class="comment">// å°†keyåºåˆ—åŒ–å†™å…¥kvbufferä¸­ï¼Œå¹¶ç§»åŠ¨bufindex</span></span><br><span class="line">    keySerializer.serialize(key);</span><br><span class="line">    <span class="keyword">if</span> (bufindex &lt; keystart) &#123;</span><br><span class="line">      <span class="comment">// wrapped the key; must make contiguous</span></span><br><span class="line">      bb.shiftBufferedKey();</span><br><span class="line">      keystart = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// serialize value bytes into buffer</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> valstart = bufindex;</span><br><span class="line">    valSerializer.serialize(value);</span><br><span class="line">    <span class="comment">// It&#x27;s possible for records to have zero length, i.e. the serializer</span></span><br><span class="line">    <span class="comment">// will perform no writes. To ensure that the boundary conditions are</span></span><br><span class="line">    <span class="comment">// checked and that the kvindex invariant is maintained, perform a</span></span><br><span class="line">    <span class="comment">// zero-length write into the buffer. The logic monitoring this could be</span></span><br><span class="line">    <span class="comment">// moved into collect, but this is cleaner and inexpensive. For now, it</span></span><br><span class="line">    <span class="comment">// is acceptable.</span></span><br><span class="line">    bb.write(b0, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// the record must be marked after the preceding write, as the metadata</span></span><br><span class="line">    <span class="comment">// for this record are not yet written</span></span><br><span class="line">    <span class="keyword">int</span> valend = bb.markRecord();</span><br><span class="line"></span><br><span class="line">    mapOutputRecordCounter.increment(<span class="number">1</span>);</span><br><span class="line">    mapOutputByteCounter.increment(</span><br><span class="line">        distanceTo(keystart, valend, bufvoid));</span><br><span class="line"></span><br><span class="line">    <span class="comment">// write accounting info</span></span><br><span class="line">    kvmeta.put(kvindex + PARTITION, partition);</span><br><span class="line">    kvmeta.put(kvindex + KEYSTART, keystart);</span><br><span class="line">    kvmeta.put(kvindex + VALSTART, valstart);</span><br><span class="line">    kvmeta.put(kvindex + VALLEN, distanceTo(valstart, valend));</span><br><span class="line">    <span class="comment">// advance kvindex</span></span><br><span class="line">    kvindex = (kvindex - NMETA + kvmeta.capacity()) % kvmeta.capacity();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (MapBufferTooSmallException e) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Record too large for in-memory buffer: &quot;</span> + e.getMessage());</span><br><span class="line">    spillSingleRecord(key, value, partition);</span><br><span class="line">    mapOutputRecordCounter.increment(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¯æ¬¡mapçš„ç»“æœpartitionä¹‹åæ¥åˆ°collectæ—¶ï¼Œå…ˆä»å‰©ä½™çš„ç©ºé—´ä¸­å‡å»æ­¤æ¡æ•°æ®å…ƒæ•°æ®çš„é•¿åº¦<code>bufferRemaining -= METASIZE</code>ï¼Œç„¶ååˆ¤æ–­<code>bufferRemaining</code>æ˜¯å¦å°äº0ï¼Œ</p><ul><li><p>å¤§äº0åˆ™ç›´æ¥å°†key/valueå¯¹å’Œå…ƒæ•°æ®ä¿¡æ¯å†™å…¥ç¼“å†²åŒºä¸­ï¼Œkeyå’Œvalueæ˜¯é€šè¿‡<code>keySerializer.serialize</code>åºåˆ—åŒ–å¹¶é€šè¿‡ä¸€ç³»åˆ—çš„æ–¹æ³•è°ƒç”¨ï¼Œæœ€ç»ˆè°ƒç”¨_MapOutputBuffer_çš„å†…éƒ¨ç±»<code>Buffer.write</code>æ–¹æ³•å°†å…¶å†…å®¹å†™å…¥_kvbuffer_ä¸­ã€‚æ¥ä¸‹æ¥æ˜¯å°†å…ƒæ•°æ®ä¿¡æ¯å†™å…¥kvmetaä¸­ï¼Œå…ƒæ•°æ®ä¿¡æ¯åŒ…æ‹¬partitionã€keyçš„èµ·å§‹ä½ç½®ã€valueçš„èµ·å§‹ä½ç½®ä»¥åŠvalueçš„é•¿åº¦ã€‚</p></li><li><p>é¦–æ¬¡å°äºç­‰äº0è¿›å…¥ifè¯­å¥ï¼Œæ­¤æ—¶å‰©ä½™çš„ç©ºé—´ä¸è¶³ï¼Œå°†å¯åŠ¨spillçº¿ç¨‹ã€‚å…ˆå¾—åˆ°__å¯é‡å…¥é”__spillLockçš„é”ï¼Œå¹¶ä¸”æ­¤æ—¶å¹¶æ— æœ‰ä»»ä½•spillçº¿ç¨‹è¿è¡Œï¼Œæ‰€ä»¥<code>spillInProgress=false</code>ï¼Œè¿›å…¥<code>else if</code>è¯­å¥ä¸­ï¼Œæ‰§è¡Œ<code>startSpill()</code>ï¼Œå”¤é†’SpillThreadçº¿ç¨‹ï¼Œé‡æ–°è®¾ç½®_equator_å’Œ_bufferRemaining_ã€‚éšåæ­£å¸¸å°†key/valueå¯¹å†™å…¥kvbufferä¸­ï¼Œå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´å­˜å‚¨åˆ™åœ¨<code>Buffer.write</code>ä¸­é˜»å¡ã€‚<code>write</code>å’Œ<code>startSpill</code>çš„ä»£ç å¦‚ä¸‹ï¼š</p></li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// must always verify the invariant that at least METASIZE bytes are</span></span><br><span class="line">  <span class="comment">// available beyond kvindex, even when len == 0</span></span><br><span class="line">  bufferRemaining -= len;</span><br><span class="line">  <span class="keyword">if</span> (bufferRemaining &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// writing these bytes could exhaust available buffer space or fill</span></span><br><span class="line">    <span class="comment">// the buffer to soft limit. check if spill or blocking are necessary</span></span><br><span class="line">    <span class="keyword">boolean</span> blockwrite = <span class="keyword">false</span>;</span><br><span class="line">    spillLock.lock();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">do</span> &#123;</span><br><span class="line">        checkSpillException();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> kvbidx = <span class="number">4</span> * kvindex;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> kvbend = <span class="number">4</span> * kvend;</span><br><span class="line">        <span class="comment">// ser distance to key index</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> distkvi = distanceTo(bufindex, kvbidx);</span><br><span class="line">        <span class="comment">// ser distance to spill end index</span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> distkve = distanceTo(bufindex, kvbend);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// if kvindex is closer than kvend, then a spill is neither in</span></span><br><span class="line">        <span class="comment">// progress nor complete and reset since the lock was held. The</span></span><br><span class="line">        <span class="comment">// write should block only if there is insufficient space to</span></span><br><span class="line">        <span class="comment">// complete the current write, write the metadata for this record,</span></span><br><span class="line">        <span class="comment">// and write the metadata for the next record. If kvend is closer,</span></span><br><span class="line">        <span class="comment">// then the write should block if there is too little space for</span></span><br><span class="line">        <span class="comment">// either the metadata or the current write. Note that collect</span></span><br><span class="line">        <span class="comment">// ensures its metadata requirement with a zero-length write</span></span><br><span class="line">        blockwrite = distkvi &lt;= distkve</span><br><span class="line">          ? distkvi &lt;= len + <span class="number">2</span> * METASIZE</span><br><span class="line">          : distkve &lt;= len || distanceTo(bufend, kvbidx) &lt; <span class="number">2</span> * METASIZE;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!spillInProgress) &#123;</span><br><span class="line">          <span class="keyword">if</span> (blockwrite) &#123;</span><br><span class="line">            <span class="keyword">if</span> ((kvbend + METASIZE) % kvbuffer.length !=</span><br><span class="line">                equator - (equator % METASIZE)) &#123;</span><br><span class="line">              <span class="comment">// spill finished, reclaim space</span></span><br><span class="line">              <span class="comment">// need to use meta exclusively; zero-len rec &amp; 100% spill</span></span><br><span class="line">              <span class="comment">// pcnt would fail</span></span><br><span class="line">              resetSpill(); <span class="comment">// resetSpill doesn&#x27;t move bufindex, kvindex</span></span><br><span class="line">              bufferRemaining = Math.min(</span><br><span class="line">                  distkvi - <span class="number">2</span> * METASIZE,</span><br><span class="line">                  softLimit - distanceTo(kvbidx, bufindex)) - len;</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// we have records we can spill; only spill if blocked</span></span><br><span class="line">            <span class="keyword">if</span> (kvindex != kvend) &#123;</span><br><span class="line">              startSpill();</span><br><span class="line">              <span class="comment">// Blocked on this write, waiting for the spill just</span></span><br><span class="line">              <span class="comment">// initiated to finish. Instead of repositioning the marker</span></span><br><span class="line">              <span class="comment">// and copying the partial record, we set the record start</span></span><br><span class="line">              <span class="comment">// to be the new equator</span></span><br><span class="line">              setEquator(bufmark);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// We have no buffered records, and this record is too large</span></span><br><span class="line">              <span class="comment">// to write into kvbuffer. We must spill it directly from</span></span><br><span class="line">              <span class="comment">// collect</span></span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">int</span> size = distanceTo(bufstart, bufindex) + len;</span><br><span class="line">              setEquator(<span class="number">0</span>);</span><br><span class="line">              bufstart = bufend = bufindex = equator;</span><br><span class="line">              kvstart = kvend = kvindex;</span><br><span class="line">              bufvoid = kvbuffer.length;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> MapBufferTooSmallException(size + <span class="string">&quot; bytes&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ²¡æœ‰è¶³å¤Ÿçš„ç©ºé—´ï¼Œåˆ™é˜»å¡ç­‰å¾…spill</span></span><br><span class="line">        <span class="keyword">if</span> (blockwrite) &#123;</span><br><span class="line">          <span class="comment">// wait for spill</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">while</span> (spillInProgress) &#123;</span><br><span class="line">              reporter.progress();</span><br><span class="line">              spillDone.await();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">              <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">                  <span class="string">&quot;Buffer interrupted while waiting for the writer&quot;</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">while</span> (blockwrite);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      spillLock.unlock();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// here, we know that we have sufficient space to write</span></span><br><span class="line">  <span class="keyword">if</span> (bufindex + len &gt; bufvoid) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> gaplen = bufvoid - bufindex;</span><br><span class="line">    System.arraycopy(b, off, kvbuffer, bufindex, gaplen);</span><br><span class="line">    len -= gaplen;</span><br><span class="line">    off += gaplen;</span><br><span class="line">    bufindex = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  System.arraycopy(b, off, kvbuffer, bufindex, len);</span><br><span class="line">  bufindex += len;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startSpill</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  kvend = (kvindex + NMETA) % kvmeta.capacity();</span><br><span class="line">  bufend = bufmark;</span><br><span class="line">  spillInProgress = <span class="keyword">true</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å”¤é†’SpillThread</span></span><br><span class="line">  spillReady.signal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>spillReady.signal()</code>å”¤é†’SpillThreadçº¿ç¨‹ï¼ŒSpillThreadçš„runæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  spillLock.lock();</span><br><span class="line">  spillThreadRunning = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      spillDone.signal();</span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦åœ¨spillï¼Œfalseåˆ™æŒ‚èµ·SpillThreadçº¿ç¨‹ï¼Œç­‰å¾…å”¤é†’</span></span><br><span class="line">      <span class="keyword">while</span> (!spillInProgress) &#123;</span><br><span class="line">        spillReady.await();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        spillLock.unlock();</span><br><span class="line">        <span class="comment">// å”¤é†’ä¹‹åï¼Œè¿›è¡Œæ’åºå’Œæº¢å†™åˆ°ç£ç›˜</span></span><br><span class="line">        sortAndSpill();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">        sortSpillException = t;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        spillLock.lock();</span><br><span class="line">        <span class="keyword">if</span> (bufend &lt; bufstart) &#123;</span><br><span class="line">          bufvoid = kvbuffer.length;</span><br><span class="line">        &#125;</span><br><span class="line">        kvstart = kvend;</span><br><span class="line">        bufstart = bufend;</span><br><span class="line">        spillInProgress = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    Thread.currentThread().interrupt();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    spillLock.unlock();</span><br><span class="line">    spillThreadRunning = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">sortAndSpill</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException,</span></span><br><span class="line"><span class="function">                                   InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">//approximate the length of the output file to be the length of the</span></span><br><span class="line">  <span class="comment">//buffer + header lengths for the partitions</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> size = distanceTo(bufstart, bufend, bufvoid) +</span><br><span class="line">              partitions * APPROX_HEADER_LENGTH;</span><br><span class="line">  FSDataOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// create spill file</span></span><br><span class="line">    <span class="keyword">final</span> SpillRecord spillRec = <span class="keyword">new</span> SpillRecord(partitions);</span><br><span class="line">    <span class="keyword">final</span> Path filename =</span><br><span class="line">        mapOutputFile.getSpillFileForWrite(numSpills, size);</span><br><span class="line">    out = rfs.create(filename);</span><br><span class="line">    <span class="comment">// kvend/4 æ˜¯æˆªæ­¢åˆ°å½“å‰ä½ç½®èƒ½å­˜æ”¾å¤šå°‘ä¸ªå…ƒæ•°æ®å®ä½“</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mstart = kvend / NMETA;</span><br><span class="line">    <span class="comment">// kvstart å¤„èƒ½å­˜æ”¾å¤šå°‘ä¸ªå…ƒæ•°æ®å®ä½“</span></span><br><span class="line">    <span class="comment">// å…ƒæ•°æ®åˆ™åœ¨mstartå’Œmendä¹‹é—´ï¼Œ(mstart - mend)åˆ™æ˜¯å…ƒæ•°æ®çš„ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> mend = <span class="number">1</span> + <span class="comment">// kvend is a valid record</span></span><br><span class="line">      (kvstart &gt;= kvend</span><br><span class="line">      ? kvstart</span><br><span class="line">      : kvmeta.capacity() + kvstart) / NMETA;</span><br><span class="line">    <span class="comment">// æ’åº  åªå¯¹å…ƒæ•°æ®è¿›è¡Œæ’åº,åªè°ƒæ•´å…ƒæ•°æ®åœ¨kvmetaä¸­çš„é¡ºåº</span></span><br><span class="line">    <span class="comment">// æ’åºè§„åˆ™æ˜¯MapOutputBuffer.compareï¼Œ </span></span><br><span class="line">    <span class="comment">// å…ˆå¯¹partitionè¿›è¡Œæ’åºå…¶æ¬¡å¯¹keyå€¼æ’åº</span></span><br><span class="line">    sorter.sort(MapOutputBuffer.<span class="keyword">this</span>, mstart, mend, reporter);</span><br><span class="line">    <span class="keyword">int</span> spindex = mstart;</span><br><span class="line">    <span class="keyword">final</span> IndexRecord rec = <span class="keyword">new</span> IndexRecord();</span><br><span class="line">    <span class="keyword">final</span> InMemValBytes value = <span class="keyword">new</span> InMemValBytes();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; partitions; ++i) &#123;</span><br><span class="line">      <span class="comment">// ä¸´æ—¶æ–‡ä»¶æ˜¯IFileæ ¼å¼çš„</span></span><br><span class="line">      IFile.Writer&lt;K, V&gt; writer = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">long</span> segmentStart = out.getPos();</span><br><span class="line">        FSDataOutputStream partitionOut = CryptoUtils.wrapIfNecessary(job, out);</span><br><span class="line">        writer = <span class="keyword">new</span> Writer&lt;K, V&gt;(job, partitionOut, keyClass, valClass, codec,</span><br><span class="line">                                  spilledRecordsCounter);</span><br><span class="line">        <span class="comment">// å¾€ç£ç›˜å†™æ•°æ®æ—¶å…ˆåˆ¤æ–­æ˜¯å¦æœ‰combiner</span></span><br><span class="line">        <span class="keyword">if</span> (combinerRunner == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// spill directly</span></span><br><span class="line">          DataInputBuffer key = <span class="keyword">new</span> DataInputBuffer();</span><br><span class="line">          <span class="keyword">while</span> (spindex &lt; mend &amp;&amp;</span><br><span class="line">              kvmeta.get(offsetFor(spindex % maxRec) + PARTITION) == i) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">int</span> kvoff = offsetFor(spindex % maxRec);</span><br><span class="line">            <span class="keyword">int</span> keystart = kvmeta.get(kvoff + KEYSTART);</span><br><span class="line">            <span class="keyword">int</span> valstart = kvmeta.get(kvoff + VALSTART);</span><br><span class="line">            key.reset(kvbuffer, keystart, valstart - keystart);</span><br><span class="line">            getVBytesForOffset(kvoff, value);</span><br><span class="line">            writer.append(key, value);</span><br><span class="line">            ++spindex;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">int</span> spstart = spindex;</span><br><span class="line">          <span class="keyword">while</span> (spindex &lt; mend &amp;&amp;</span><br><span class="line">              kvmeta.get(offsetFor(spindex % maxRec)</span><br><span class="line">                        + PARTITION) == i) &#123;</span><br><span class="line">            ++spindex;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Note: we would like to avoid the combiner if we&#x27;ve fewer</span></span><br><span class="line">          <span class="comment">// than some threshold of records for a partition</span></span><br><span class="line">          <span class="keyword">if</span> (spstart != spindex) &#123;</span><br><span class="line">            combineCollector.setWriter(writer);</span><br><span class="line">            RawKeyValueIterator kvIter =</span><br><span class="line">              <span class="keyword">new</span> MRResultIterator(spstart, spindex);</span><br><span class="line">            combinerRunner.combine(kvIter, combineCollector);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// close the writer</span></span><br><span class="line">        writer.close();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// record offsets</span></span><br><span class="line">        rec.startOffset = segmentStart;</span><br><span class="line">        rec.rawLength = writer.getRawLength() + CryptoUtils.cryptoPadding(job);</span><br><span class="line">        rec.partLength = writer.getCompressedLength() + CryptoUtils.cryptoPadding(job);</span><br><span class="line">        spillRec.putIndex(rec, i);</span><br><span class="line"></span><br><span class="line">        writer = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != writer) writer.close();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å†…å­˜ä¸­çš„indexæ–‡ä»¶æ˜¯å¦è¶…å‡ºé˜ˆå€¼ï¼Œè¶…å‡ºåˆ™å°†indexæ–‡ä»¶å†™å…¥ç£ç›˜</span></span><br><span class="line">    <span class="comment">// å½“è¶…å‡ºé˜ˆå€¼æ—¶åªæ˜¯æŠŠå½“å‰indexå’Œä¹‹åçš„indexå†™å…¥ç£ç›˜</span></span><br><span class="line">    <span class="keyword">if</span> (totalIndexCacheMemory &gt;= indexCacheMemoryLimit) &#123;</span><br><span class="line">      <span class="comment">// create spill index file</span></span><br><span class="line">      Path indexFilename =</span><br><span class="line">          mapOutputFile.getSpillIndexFileForWrite(numSpills, partitions</span><br><span class="line">              * MAP_OUTPUT_INDEX_RECORD_LENGTH);</span><br><span class="line">      spillRec.writeToFile(indexFilename, job);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      indexCacheList.add(spillRec);</span><br><span class="line">      totalIndexCacheMemory +=</span><br><span class="line">        spillRec.size() * MAP_OUTPUT_INDEX_RECORD_LENGTH;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(<span class="string">&quot;Finished spill &quot;</span> + numSpills);</span><br><span class="line">    ++numSpills;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (out != <span class="keyword">null</span>) out.close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“ç”¨æˆ·è‡ªå®šä¹‰çš„mapè¿‡ç¨‹ç»“æŸä¹‹åï¼Œä»£ç å›åˆ°<code>runNewMapper</code>ä¸­ç»§ç»­æ‰§è¡Œï¼Œè¿›å…¥SORTé˜¶æ®µï¼Œä¹Ÿå¯ä»¥è¯´æ˜¯Mergeé˜¶æ®µã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runNewMapper</span><span class="params">(<span class="keyword">final</span> JobConf job,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">final</span> TaskSplitIndex splitIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">                  <span class="keyword">final</span> TaskUmbilicalProtocol umbilical,</span></span></span><br><span class="line"><span class="params"><span class="function">                  TaskReporter reporter</span></span></span><br><span class="line"><span class="params"><span class="function">                  )</span> <span class="keyword">throws</span> IOException, ClassNotFoundException,</span></span><br><span class="line"><span class="function">                           InterruptedException </span>&#123;</span><br><span class="line">  ...<span class="comment">// å®Œæ•´ä»£ç çœ‹ä¸Šæ–‡ï¼Œæ­¤å¤„åªåˆ—å‡ºå…³é”®ç‚¹</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    input.initialize(split, mapperContext);</span><br><span class="line">    mapper.run(mapperContext);</span><br><span class="line">    <span class="comment">// ç”¨æˆ·è‡ªå®šä¹‰çš„mapç»“æŸåï¼Œç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">    mapPhase.complete();</span><br><span class="line">    <span class="comment">// å¼€å¯SORTé˜¶æ®µï¼Œæ­¤å¤„çš„SORTæˆ‘æ„Ÿè§‰ç”¨mergeå¯èƒ½æ›´åŠ å‡†ç¡®</span></span><br><span class="line">    <span class="comment">// æ­¤é˜¶æ®µå°†spillçš„ä¸´æ—¶æ–‡ä»¶è¿›è¡Œå †æ’åºmergeæˆä¸€ä¸ªæœ€ç»ˆæ–‡ä»¶è¾“å‡º</span></span><br><span class="line">    setPhase(TaskStatus.Phase.SORT);</span><br><span class="line">    statusUpdate(umbilical);</span><br><span class="line">    input.close();</span><br><span class="line">    input = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// å †æ’åºmergeä¸´æ—¶æ–‡ä»¶çš„å…¥å£</span></span><br><span class="line">    output.close(mapperContext);</span><br><span class="line">    output = <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    closeQuietly(input);</span><br><span class="line">    closeQuietly(output, mapperContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// NewOutputCollector.close</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">(TaskAttemptContext context</span></span></span><br><span class="line"><span class="params"><span class="function">                  )</span> <span class="keyword">throws</span> IOException,InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    collector.flush();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (ClassNotFoundException cnf) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;can&#x27;t find class &quot;</span>, cnf);</span><br><span class="line">  &#125;</span><br><span class="line">  collector.close();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MapOutputBuffer.flush</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">flush</span><span class="params">()</span> <span class="keyword">throws</span> IOException, ClassNotFoundException,</span></span><br><span class="line"><span class="function">       InterruptedException </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;Starting flush of map output&quot;</span>);</span><br><span class="line">  spillLock.lock();</span><br><span class="line">  <span class="comment">// é¦–å…ˆå°†å†…å­˜ä¸­æ®‹ç•™çš„mapç»“æœspillåˆ°ç£ç›˜</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (spillInProgress) &#123;</span><br><span class="line">      reporter.progress();</span><br><span class="line">      spillDone.await();</span><br><span class="line">    &#125;</span><br><span class="line">    checkSpillException();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> kvbend = <span class="number">4</span> * kvend;</span><br><span class="line">    <span class="keyword">if</span> ((kvbend + METASIZE) % kvbuffer.length !=</span><br><span class="line">        equator - (equator % METASIZE)) &#123;</span><br><span class="line">      <span class="comment">// spill finished</span></span><br><span class="line">      resetSpill();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (kvindex != kvend) &#123;</span><br><span class="line">      kvend = (kvindex + NMETA) % kvmeta.capacity();</span><br><span class="line">      bufend = bufmark;</span><br><span class="line">      LOG.info(<span class="string">&quot;Spilling map output&quot;</span>);</span><br><span class="line">      LOG.info(<span class="string">&quot;bufstart = &quot;</span> + bufstart + <span class="string">&quot;; bufend = &quot;</span> + bufmark +</span><br><span class="line">               <span class="string">&quot;; bufvoid = &quot;</span> + bufvoid);</span><br><span class="line">      LOG.info(<span class="string">&quot;kvstart = &quot;</span> + kvstart + <span class="string">&quot;(&quot;</span> + (kvstart * <span class="number">4</span>) +</span><br><span class="line">               <span class="string">&quot;); kvend = &quot;</span> + kvend + <span class="string">&quot;(&quot;</span> + (kvend * <span class="number">4</span>) +</span><br><span class="line">               <span class="string">&quot;); length = &quot;</span> + (distanceTo(kvend, kvstart,</span><br><span class="line">                     kvmeta.capacity()) + <span class="number">1</span>) + <span class="string">&quot;/&quot;</span> + maxRec);</span><br><span class="line">      sortAndSpill();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Interrupted while waiting for the writer&quot;</span>, e);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    spillLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">assert</span> !spillLock.isHeldByCurrentThread();</span><br><span class="line">  <span class="comment">// shut down spill thread and wait for it to exit. Since the preceding</span></span><br><span class="line">  <span class="comment">// ensures that it is finished with its work (and sortAndSpill did not</span></span><br><span class="line">  <span class="comment">// throw), we elect to use an interrupt instead of setting a flag.</span></span><br><span class="line">  <span class="comment">// Spilling simultaneously from this thread while the spill thread</span></span><br><span class="line">  <span class="comment">// finishes its work might be both a useful way to extend this and also</span></span><br><span class="line">  <span class="comment">// sufficient motivation for the latter approach.</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    spillThread.interrupt();</span><br><span class="line">    spillThread.join();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Spill failed&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// release sort buffer before the merge</span></span><br><span class="line">  kvbuffer = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// mergeä¸´æ—¶æ–‡ä»¶ï¼ˆä½¿ç”¨å †æ’åºï¼‰</span></span><br><span class="line">  mergeParts();</span><br><span class="line">  Path outputPath = mapOutputFile.getOutputFile();</span><br><span class="line">  fileOutputByteCounter.increment(rfs.getFileStatus(outputPath).getLen());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// MapOutputBuffer.mergeParts</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">mergeParts</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException, </span></span><br><span class="line"><span class="function">                                 ClassNotFoundException </span>&#123;</span><br><span class="line">  <span class="comment">// get the approximate size of the final output/index files</span></span><br><span class="line">  <span class="keyword">long</span> finalOutFileSize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> finalIndexFileSize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">final</span> Path[] filename = <span class="keyword">new</span> Path[numSpills];</span><br><span class="line">  <span class="keyword">final</span> TaskAttemptID mapId = getTaskID();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSpills; i++) &#123;</span><br><span class="line">    filename[i] = mapOutputFile.getSpillFile(i);</span><br><span class="line">    finalOutFileSize += rfs.getFileStatus(filename[i]).getLen();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åªæœ‰ä¸€ä¸ªspillåˆ™ç›´æ¥å°†æ–‡ä»¶è¿›è¡Œé‡å‘½åï¼Œä¸è¿›è¡Œmerge</span></span><br><span class="line">  <span class="keyword">if</span> (numSpills == <span class="number">1</span>) &#123; <span class="comment">//the spill is the final output</span></span><br><span class="line">    ...</span><br><span class="line">    sortPhase.complete();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// read in paged indices</span></span><br><span class="line">  <span class="comment">// å°†ç£ç›˜ä¸­çš„indexæ–‡ä»¶åŠ è½½åˆ°å†…å­˜</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = indexCacheList.size(); i &lt; numSpills; ++i) &#123;</span><br><span class="line">    Path indexFileName = mapOutputFile.getSpillIndexFile(i);</span><br><span class="line">    indexCacheList.add(<span class="keyword">new</span> SpillRecord(indexFileName, job));</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//The output stream for the final single output file</span></span><br><span class="line">  FSDataOutputStream finalOut = rfs.create(finalOutputFile, <span class="keyword">true</span>, <span class="number">4096</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (numSpills == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">//create dummy files</span></span><br><span class="line">    ...</span><br><span class="line">    sortPhase.complete();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  &#123;</span><br><span class="line">    sortPhase.addPhases(partitions); <span class="comment">// Divide sort phase into sub-phases</span></span><br><span class="line">    </span><br><span class="line">    IndexRecord rec = <span class="keyword">new</span> IndexRecord();</span><br><span class="line">    <span class="keyword">final</span> SpillRecord spillRec = <span class="keyword">new</span> SpillRecord(partitions);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> parts = <span class="number">0</span>; parts &lt; partitions; parts++) &#123;</span><br><span class="line">      <span class="comment">//create the segments to be merged</span></span><br><span class="line">      List&lt;Segment&lt;K,V&gt;&gt; segmentList =</span><br><span class="line">        <span class="keyword">new</span> ArrayList&lt;Segment&lt;K, V&gt;&gt;(numSpills);</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSpills; i++) &#123;</span><br><span class="line">        <span class="comment">// ä»spillçš„indexæ–‡ä»¶ä¸­å¾—åˆ°å½“å‰spillä¸­æŸä¸ªpartitionçš„ä¿¡æ¯</span></span><br><span class="line">        IndexRecord indexRecord = indexCacheList.get(i).getIndex(parts);</span><br><span class="line"></span><br><span class="line">        Segment&lt;K,V&gt; s =</span><br><span class="line">          <span class="keyword">new</span> Segment&lt;K,V&gt;(job, rfs, filename[i], indexRecord.startOffset,</span><br><span class="line">                           indexRecord.partLength, codec, <span class="keyword">true</span>);</span><br><span class="line">        segmentList.add(i, s);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">          LOG.debug(<span class="string">&quot;MapId=&quot;</span> + mapId + <span class="string">&quot; Reducer=&quot;</span> + parts +</span><br><span class="line">              <span class="string">&quot;Spill =&quot;</span> + i + <span class="string">&quot;(&quot;</span> + indexRecord.startOffset + <span class="string">&quot;,&quot;</span> +</span><br><span class="line">              indexRecord.rawLength + <span class="string">&quot;, &quot;</span> + indexRecord.partLength + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ä¸´æ—¶æ–‡ä»¶è¶…è¿‡mapreduce.task.io.sort.factor æ—¶è¿›è¡Œæ’åº</span></span><br><span class="line">      <span class="keyword">int</span> mergeFactor = job.getInt(JobContext.IO_SORT_FACTOR, <span class="number">100</span>);</span><br><span class="line">      <span class="comment">// sort the segments only if there are intermediate merges</span></span><br><span class="line">      <span class="comment">// æ˜¯å¦æŒ‰ç…§é•¿åº¦å¯¹segmentè¿›è¡Œæ’åº</span></span><br><span class="line">      <span class="keyword">boolean</span> sortSegments = segmentList.size() &gt; mergeFactor;</span><br><span class="line">      <span class="comment">//merge</span></span><br><span class="line">      <span class="meta">@SuppressWarnings(&quot;unchecked&quot;)</span></span><br><span class="line">      <span class="comment">// å †æ’åºï¼ˆå°é¡¶å †ï¼‰ </span></span><br><span class="line">      <span class="comment">// sortSegmentsä¸ºtrueæ—¶å…ˆå°†segmentsæŒ‰ç…§æ–‡ä»¶å¤§å°è¿›è¡Œæ’åºç„¶åè¿›è¡Œå †æ’åº</span></span><br><span class="line">      <span class="comment">// å †æ’åºæ˜¯ä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—</span></span><br><span class="line">      <span class="comment">// kvIterä¾ç„¶æ˜¯é”®å€¼å¯¹çš„å½¢å¼å­˜åœ¨</span></span><br><span class="line">      RawKeyValueIterator kvIter = Merger.merge(job, rfs,</span><br><span class="line">                     keyClass, valClass, codec,</span><br><span class="line">                     segmentList, mergeFactor,</span><br><span class="line">                     <span class="keyword">new</span> Path(mapId.toString()),</span><br><span class="line">                     job.getOutputKeyComparator(), reporter, sortSegments,</span><br><span class="line">                     <span class="keyword">null</span>, spilledRecordsCounter, sortPhase.phase(),</span><br><span class="line">                     TaskType.MAP);</span><br><span class="line"></span><br><span class="line">      <span class="comment">//write merged output to disk</span></span><br><span class="line">      <span class="keyword">long</span> segmentStart = finalOut.getPos();</span><br><span class="line">      FSDataOutputStream finalPartitionOut = CryptoUtils.wrapIfNecessary(job, finalOut);</span><br><span class="line">      Writer&lt;K, V&gt; writer =</span><br><span class="line">          <span class="keyword">new</span> Writer&lt;K, V&gt;(job, finalPartitionOut, keyClass, valClass, codec,</span><br><span class="line">                           spilledRecordsCounter);</span><br><span class="line">      <span class="comment">// merge å¾€ç£ç›˜å†™æ•°æ®æ—¶ä¹Ÿä¼šæ£€æŸ¥ä¸‹æ˜¯å¦æœ‰combiner </span></span><br><span class="line">      <span class="comment">// æ³¨æ„æ­¤å¤„ä¸åªæ˜¯ç®€å•æ£€æŸ¥ä¸‹æ˜¯å¦æœ‰combinerï¼Œå‡å¦‚æœ‰combinerä¹Ÿä¸ä¸€å®šæ‰§è¡Œ</span></span><br><span class="line">      <span class="comment">// éœ€åœ¨numSpills&gt;mapreduce.map.combine.minspills(é»˜è®¤3) ä¸”æœ‰combineræ—¶æ‰æ‰§è¡Œcombiner</span></span><br><span class="line">      <span class="comment">// (mapé˜¶æ®µåªè¦å¾€ç£ç›˜ä¸Šå†™æ•°æ®éƒ½ä¼šæ£€æŸ¥ä¸‹æ˜¯å¦æœ‰combiner)</span></span><br><span class="line">      <span class="keyword">if</span> (combinerRunner == <span class="keyword">null</span> || numSpills &lt; minSpillsForCombine) &#123;</span><br><span class="line">        Merger.writeFile(kvIter, writer, reporter, job);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        combineCollector.setWriter(writer);</span><br><span class="line">        combinerRunner.combine(kvIter, combineCollector);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">//close</span></span><br><span class="line">      writer.close();</span><br><span class="line"></span><br><span class="line">      sortPhase.startNextPhase();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// record offsets</span></span><br><span class="line">      rec.startOffset = segmentStart;</span><br><span class="line">      rec.rawLength = writer.getRawLength() + CryptoUtils.cryptoPadding(job);</span><br><span class="line">      rec.partLength = writer.getCompressedLength() + CryptoUtils.cryptoPadding(job);</span><br><span class="line">      spillRec.putIndex(rec, parts);</span><br><span class="line">    &#125;</span><br><span class="line">    spillRec.writeToFile(finalIndexFile, job);</span><br><span class="line">    finalOut.close();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSpills; i++) &#123;</span><br><span class="line">      rfs.delete(filename[i],<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤mapæ•´ä¸ªé˜¶æ®µç»“æŸã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ•´ä¸ªMapé˜¶æ®µçš„æµç¨‹æ˜¯inputFileé€šè¿‡splitè¢«åˆ‡åˆ†ä¸ºå¤šä¸ªsplitæ–‡ä»¶ï¼Œé€šè¿‡RecordæŒ‰è¡Œè¯»å–å†…å®¹ç»™mapï¼ˆç”¨æˆ·è‡ªå·±å®ç°çš„ï¼‰è¿›è¡Œå¤„ç†ï¼Œæ•°æ®è¢«mapå¤„ç†ç»“æŸä¹‹åäº¤ç»™<code>context.write</code>ï¼Œç„¶åè°ƒç”¨<code>NewOutputCollector.write</code>ï¼Œå¯¹å…¶ç»“æœkeyè¿›è¡Œåˆ†åŒºï¼ˆé»˜è®¤ä½¿ç”¨hashåˆ†åŒºï¼‰ï¼Œç„¶åä¼ ç»™<code>MapOutputBuffer.collect</code>è¿›è¡Œkeyã€valueçš„åºåˆ—åŒ–å†™å…¥bufferï¼Œç”±<code>bufferRemaining</code>è®°å½•å‰©ä½™çš„å­—èŠ‚å¤§å°ï¼Œå°äºç­‰äº0æ—¶ï¼Œå¼€å§‹è¿›è¡Œspillï¼Œspillæ—¶å…ˆå¯¹bufferä¸­key/valueçš„å…ƒæ•°æ®è¿›è¡Œå¿«æ’ï¼Œä¹‹åå¼€å§‹å†™å…¥ç£ç›˜çš„ä¸´æ—¶æ–‡ä»¶ï¼ˆå†™ä¹‹å‰åˆ¤æ–­æ˜¯å¦æœ‰combinerï¼‰ï¼Œå½“æ•´ä¸ªæ•°æ®å¤„ç†ç»“æŸä¹‹åå¼€å§‹å¯¹ç£ç›˜ä¸­çš„ä¸´æ—¶æ–‡ä»¶è¿›è¡Œmergeï¼Œmergeæ—¶ä½¿ç”¨çš„æ˜¯å †æ’åºï¼ˆä½¿ç”¨ä¼˜å…ˆçº§é˜Ÿåˆ—å®ç°ï¼‰ï¼Œæ’åºç»“æŸä¹‹åå‡†å¤‡ä½œä¸ºæœ€ç»ˆæ–‡ä»¶å†™å…¥ç£ç›˜ï¼Œ<strong>åœ¨å†™å…¥ä¹‹å‰ä¾ç„¶ä¼šåˆ¤æ–­æ˜¯å¦æœ‰combinerï¼Œä½†æ­¤å¤„ä¼šå¤šä¸€ä¸ªæ¡ä»¶ï¼Œå¹¶ä¸æ˜¯åªè¦æœ‰combinerå°±ä¼šæ‰§è¡Œï¼Œåœ¨æœ‰combinerçš„æƒ…å†µä¸‹è¿˜éœ€æ»¡è¶³numSpills&gt;mapreduce.map.combine.minspillsæ‰ä¼šæ‰§è¡Œcombiner</strong></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> MapReduce </tag>
            
            <tag> Map </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceæºç è§£æ--TotalOrderPartitioner</title>
      <link href="/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--TotalOrderPartitioner.html"/>
      <url>/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--TotalOrderPartitioner.html</url>
      
        <content type="html"><![CDATA[<p>MRæœ¬èº«å°±å…·æœ‰æ’åºåŠŸèƒ½ï¼Œä½†æ˜¯å…¶åˆ†å¸ƒå¼çš„ç‰¹æ€§ä½¿å…¶æ— æ³•è¾ƒç†æƒ³çš„è¿›è¡Œå…¨å±€æ’åºã€‚éš¾é“è¦æƒ³ä½¿ç”¨MRè¿›è¡Œå…¨å±€æ’åºæ—¶åªèƒ½å°†å…¶ç»“æœéƒ½è¾“å…¥åˆ°ä¸€ä¸ªreduceä¸­ï¼Ÿé‚£è¿™ä¸å°±è¿èƒŒäº†å…¶åˆ†å¸ƒå¼çš„ç‰¹æ€§äº†å˜›ã€‚äºæ˜¯å¤§ç‰›ä»¬æƒ³åˆ°äº†åœ¨mapåˆ†åŒºæ—¶ä¿è¯åˆ†åŒºçš„æœ‰åºæ€§ï¼Œä½¿å…¶åˆ†é…åˆ°ç¬¬ä¸€ä¸ªreduceä¸­çš„keyä¸€å®šå°äºåˆ†é…åˆ°ç¬¬äºŒä¸ªreduceä¸­çš„keyï¼Œæ­¤åŠŸèƒ½å°±æ˜¯æœ¬ç¯‡è¦è§£æçš„åˆ†åŒºç±»<code>TotalOrderPartitioner</code>ã€‚</p><p><a href="http://bigdatadecode.top/MapReduce%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B--%E4%BA%8C%E6%AC%A1%E6%8E%92%E5%BA%8F%E4%B9%8B%E5%85%A8%E5%B1%80%E6%9C%89%E5%BA%8F.html">ä¸Šç¯‡</a>ä»åº”ç”¨çš„è§’åº¦å±•ç¤ºäº†<code>TotalOrderPartitioner</code>å¦‚ä½•è¿›è¡Œå…¨å±€æ’åºã€‚æœ¬ç¯‡ä»ä»£ç çš„è§’åº¦è§£æä¸‹<code>TotalOrderPartitioner</code>æ˜¯æ€ä¹ˆå®ç°çš„ï¼Œå…¶ä¸­åˆç”¨åˆ°äº†å“ªäº›é»‘ç§‘æŠ€ã€‚ã€‚ã€‚</p><p><em>TotalOrderPartitionerä¹‹æ‰€ä»¥èƒ½å¤Ÿå®ç°å…¨å±€æ’åºï¼Œæ˜¯å› ä¸ºå…¶åœ¨åˆ†åŒºæ—¶ä¾èµ–ä¸€ä¸ªåˆ†åŒºæ–‡ä»¶ï¼Œå…¶æ–‡ä»¶ä¸­è®°å½•äº†å°†keyè¿›è¡Œåˆ†åŒºçš„åˆ†ç•Œç‚¹ï¼Œæ˜¯è¿™äº›åˆ†ç•Œç‚¹èµ·åˆ°äº†å…³é”®ä½œç”¨ã€‚è¿™äº›åˆ†ç•Œç‚¹ä¿è¯äº†æŸä¸€åŒºé—´çš„keyåˆ†åˆ°åŒä¸€ä¸ªreduceä¸­ï¼Œè€ŒTotalOrderPartitioneråªæ˜¯å°†keyå’Œåˆ†ç•Œç‚¹æ¯”è¾ƒçš„è¿‡ç¨‹è¿›è¡Œäº†ä¼˜åŒ–ï¼Œä½¿å…¶åœ¨å¤§æ•°æ®è§„æ¨¡ä¸‹èƒ½å¤Ÿé«˜æ•ˆçš„è¿›è¡Œã€‚</em></p><span id="more"></span><h2 id="TotalOrderPartitionerå®ç°é«˜é€ŸæŸ¥è¯¢æ¶æ„"><a href="#TotalOrderPartitionerå®ç°é«˜é€ŸæŸ¥è¯¢æ¶æ„" class="headerlink" title="TotalOrderPartitionerå®ç°é«˜é€ŸæŸ¥è¯¢æ¶æ„"></a>TotalOrderPartitionerå®ç°é«˜é€ŸæŸ¥è¯¢æ¶æ„</h2><p>TotalOrderPartitionerå¯¹ä¸åŒKeyçš„æ•°æ®ç±»å‹æä¾›äº†ä¸¤ç§æ–¹æ¡ˆï¼š</p><ul><li><p>å¯¹äºåªèƒ½WritableComparableè€Œä¸èƒ½BinaryComparableç±»å‹çš„keyï¼Œä¹Ÿå¯ä»¥ç†è§£æˆæ•°å€¼ç±»å‹çš„æ•°æ®(<em>å¦‚IntWritableï¼Œåœ¨å®ç°æ—¶åªå®ç°äº†WritableComparableæ¥å£</em>)ï¼ŒTotalOrderPartitioneré‡‡ç”¨äºŒåˆ†æŸ¥æ‰¾æ¥ç¡®å®šå½“å‰keyæ‰€åœ¨çš„reduce indexã€‚<em>å…¶äºŒåˆ†æŸ¥æ‰¾æ˜¯é€šè¿‡è°ƒç”¨Arrays.binarySearchå®ç°çš„</em>ã€‚å…¶æ—¶é—´å¤æ‚åº¦æ˜¯O(log(reduce num))ã€‚</p></li><li><p>å¯¹äºå¯ä»¥BinaryComparableçš„keyï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºå­—ç¬¦ä¸²ç±»å‹æ•°æ®(<em>å¦‚Textï¼ŒBytesWritableï¼Œåœ¨å®ç°æ—¶ç»§æ‰¿äº†BinaryComparableçˆ¶ç±»</em>)ï¼Œåˆ™æ„å»ºä¸€ä¸ª<strong>Trieæ ‘</strong>ï¼Œä½¿å­—ç¬¦ä¸²æŒ‰ç…§å­—å…¸åºè¿›è¡Œæ’åºã€‚Trieæ ‘çš„æŸ¥æ‰¾æ—¶é—´å¤æ‚åº¦æ˜¯O(d)ï¼Œdä¸ºæ ‘çš„æ·±åº¦(<em>æ ¹çš„æ·±åº¦ä¸º1</em>)ï¼Œç©ºé—´å¤æ‚åº¦æ˜¯O(255^(d-1))ã€‚</p></li></ul><h2 id="TotalOrderPartitioneræºç è§£æ"><a href="#TotalOrderPartitioneræºç è§£æ" class="headerlink" title="TotalOrderPartitioneræºç è§£æ"></a>TotalOrderPartitioneræºç è§£æ</h2><p>TotalOrderPartitionerå®ç°äº†<em>Configurable</em>æ¥å£ï¼Œåœ¨<code>setConf</code>ä¸­è¿›è¡Œåˆå§‹åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setConf</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.conf = conf;</span><br><span class="line">        String parts = getPartitionFile(conf);</span><br><span class="line">        <span class="keyword">final</span> Path partFile = <span class="keyword">new</span> Path(parts);</span><br><span class="line">        <span class="keyword">final</span> FileSystem fs = (DEFAULT_PATH.equals(parts))</span><br><span class="line">                ? FileSystem.getLocal(conf)     <span class="comment">// assume in DistributedCache</span></span><br><span class="line">                : partFile.getFileSystem(conf);</span><br><span class="line"></span><br><span class="line">        Job job = <span class="keyword">new</span> Job(conf);</span><br><span class="line">        <span class="comment">// å¾—åˆ°map output keyçš„ç±»å‹ï¼Œ</span></span><br><span class="line">        <span class="comment">// å°†partition fileä¸­keyè¯»å–ä¸ºkeyClassç±»å‹</span></span><br><span class="line">        Class&lt;K&gt; keyClass = (Class&lt;K&gt;)job.getMapOutputKeyClass();</span><br><span class="line">        <span class="comment">// è¯»å–partition fileï¼Œæ­¤æ–‡ä»¶ä¸ºsequenceFile</span></span><br><span class="line">        K[] splitPoints = readPartitions(fs, partFile, keyClass, conf);</span><br><span class="line">        <span class="keyword">if</span> (splitPoints.length != job.getNumReduceTasks() - <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Wrong number of partitions in keyset&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¾—åˆ°jobä¸­è®¾ç½®çš„æ¯”è¾ƒå™¨ï¼Œ</span></span><br><span class="line">        <span class="comment">// æ­¤æ¯”è¾ƒå™¨ç”¨åœ¨åˆ¤æ–­partition fileä¸­keyæ˜¯å¦æŒ‰ç…§å‡åºæ’åˆ—ï¼Œ</span></span><br><span class="line">        <span class="comment">// å…¶æ¬¡æ˜¯åœ¨äºŒåˆ†æŸ¥æ‰¾ä¸­ç”¨ï¼Œ</span></span><br><span class="line">        RawComparator&lt;K&gt; comparator =</span><br><span class="line">                (RawComparator&lt;K&gt;) job.getSortComparator();</span><br><span class="line">        <span class="comment">// åˆ¤æ–­keyæ˜¯å¦å‡åº</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; splitPoints.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (comparator.compare(splitPoints[i], splitPoints[i+<span class="number">1</span>]) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Split points are out of order&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">boolean</span> natOrder =</span><br><span class="line">                conf.getBoolean(NATURAL_ORDER, <span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// å¯BinaryComparableå¹¶ä¸”æŒ‰ç…§å­—å…¸åºæ¯”è¾ƒåˆ™æ„å»ºTrieæ ‘è¿›è¡ŒæŸ¥æ‰¾</span></span><br><span class="line">        <span class="comment">// å¦åˆ™ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">        <span class="keyword">if</span> (natOrder &amp;&amp; BinaryComparable.class.isAssignableFrom(keyClass)) &#123;</span><br><span class="line">            partitions = buildTrie((BinaryComparable[])splitPoints, <span class="number">0</span>,</span><br><span class="line">                    splitPoints.length, <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">0</span>],</span><br><span class="line">                    <span class="comment">// Now that blocks of identical splitless trie nodes are</span></span><br><span class="line">                    <span class="comment">// represented reentrantly, and we develop a leaf for any trie</span></span><br><span class="line">                    <span class="comment">// node with only one split point, the only reason for a depth</span></span><br><span class="line">                    <span class="comment">// limit is to refute stack overflow or bloat in the pathological</span></span><br><span class="line">                    <span class="comment">// case where the split points are long and mostly look like bytes</span></span><br><span class="line">                    <span class="comment">// iii...iixii...iii   .  Therefore, we make the default depth</span></span><br><span class="line">                    <span class="comment">// limit large but not huge.</span></span><br><span class="line">                    conf.getInt(MAX_TRIE_DEPTH, <span class="number">200</span>));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            partitions = <span class="keyword">new</span> BinarySearchNode(splitPoints, comparator);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Can&#x27;t read partitions file&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>TotalOrderPartitioneræ„å»ºæˆåŠŸç”¨äºæŸ¥æ‰¾çš„æ•°æ®ç»“æ„ä¹‹åï¼Œåœ¨mapä¸­è°ƒç”¨<code>getPartition</code>å°±okäº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getPartition</span><span class="params">(K key, V value, <span class="keyword">int</span> numPartitions)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> partitions.findPartition(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡getPartitionè¿™ä¸ªå…¥å£ï¼Œå¯ä»¥æ ¹æ®keyåœ¨ä¸åŒçš„æ•°æ®ç»“æ„ä¸­å¿«é€ŸæŸ¥æ‰¾ã€‚ä¸‹é¢å°±æ¥çœ‹ä¸‹ä¸¤ç§æ•°æ®ç»“æ„æ˜¯å¦‚ä½•å®ç°çš„ã€‚å…ˆçœ‹è¾ƒç®€å•çš„äºŒåˆ†æŸ¥æ‰¾ã€‚</p><h3 id="äºŒåˆ†æŸ¥æ‰¾"><a href="#äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="äºŒåˆ†æŸ¥æ‰¾"></a>äºŒåˆ†æŸ¥æ‰¾</h3><p>partitionsæ˜¯Nodeç±»å‹çš„ï¼Œåœ¨setConfä¸­é€šè¿‡<em>æ„é€ ä¸€ä¸ªBinarySearchNode</em>æ¥å¯¹å…¶èµ‹å€¼ï¼Œç”±æ­¤å¯è§BinarySearchNodeè‚¯å®šå®ç°äº†Nodeæ¥å£ã€‚BinarySearchNodeæ¯”è¾ƒç®€å•ï¼Œåœ¨æ­¤è´´äº†å…¨éƒ¨ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BinarySearchNode</span> <span class="keyword">implements</span> <span class="title">Node</span>&lt;<span class="title">K</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> K[] splitPoints;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> RawComparator&lt;K&gt; comparator;</span><br><span class="line">    BinarySearchNode(K[] splitPoints, RawComparator&lt;K&gt; comparator) &#123;</span><br><span class="line">        <span class="keyword">this</span>.splitPoints = splitPoints;</span><br><span class="line">        <span class="keyword">this</span>.comparator = comparator;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findPartition</span><span class="params">(K key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> pos = Arrays.binarySearch(splitPoints, key, comparator1) + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">return</span> (pos &lt; <span class="number">0</span>) ? -pos : pos;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶æ„é€ æ–¹æ³•å°†<em>åˆ†ç•Œç‚¹æ•°ç»„å’Œæ¯”è¾ƒå™¨ä¼ å…¥</em>ï¼Œç„¶ååœ¨<code>findPartition</code>ä¸­è°ƒç”¨Arrays.binarySearchå¯¹ç›®æ ‡keyè¿›è¡ŒæŸ¥æ‰¾ã€‚åˆ™æŸ¥æ‰¾é€»è¾‘ä¸»è¦åœ¨Arrays.binarySearchä¸­å®ç°ï¼Œæˆ‘ä»¬çœ‹ä¸‹å…¶æºç å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T&gt; <span class="function"><span class="keyword">int</span> <span class="title">binarySearch0</span><span class="params">(T[] a, <span class="keyword">int</span> fromIndex, <span class="keyword">int</span> toIndex,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     T key, Comparator&lt;? <span class="keyword">super</span> T&gt; c)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¯”è¾ƒå™¨cä¸ºnullï¼Œåˆ™ä½¿ç”¨Arraysçš„é»˜è®¤æ¯”è¾ƒå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> binarySearch0(a, fromIndex, toIndex, key);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> low = fromIndex;</span><br><span class="line">    <span class="keyword">int</span> high = toIndex - <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high) &#123;</span><br><span class="line">        <span class="keyword">int</span> mid = (low + high) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        T midVal = a[mid];</span><br><span class="line">        <span class="keyword">int</span> cmp = c.compare(midVal, key);</span><br><span class="line">        <span class="keyword">if</span> (cmp &lt; <span class="number">0</span>)</span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (cmp &gt; <span class="number">0</span>)</span><br><span class="line">            high = mid - <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">return</span> mid; <span class="comment">// key found</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -(low + <span class="number">1</span>);  <span class="comment">// key not found.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯jdkçš„é»˜è®¤å®ç°ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯æœªæ‰¾åˆ°ç›®æ ‡keyæ—¶è¿”å›<code>-(low+1)</code>ï¼Œå…¶ä¸­lowæ˜¯è¯¥å…ƒç´ è¦æ’å…¥çš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯lowç´¢å¼•ä¹‹å‰çš„å…ƒç´ éƒ½æ¯”ç›®æ ‡keyè¦å°ï¼Œä½†æ˜¯ä¹‹æ‰€ä»¥è¿”å›<code>-(low+1)</code>è€Œä¸æ˜¯<code>-low</code>ï¼Œ<em>æ˜¯å› ä¸ºå‡å¦‚ç›®æ ‡keyæ¯”æ‰€æœ‰çš„å…ƒç´ éƒ½å°æ—¶ï¼Œé‚£ä¹ˆæœ€åä¸€æ¬¡æ¯”è¾ƒæ˜¯åœç•™åœ¨index=0çš„ä½ç½®ï¼Œè¿™æ—¶å€™low=0,é‚£ä¹ˆæˆ‘ä»¬è¿”å›ç»™è°ƒç”¨è€…çš„å€¼å°±æ˜¯0äº†ï¼Œ<strong>è€Œä¸æ˜¯ä¸€ä¸ªè´Ÿæ•°</strong>ï¼Œè¿™æ ·æˆ‘ä»¬æ‹¿åˆ°0å¹¶ä¸çŸ¥é“ä»–æ˜¯æ²¡åŒ¹é…åˆ°ï¼Œè¿˜æ˜¯è¯¥å…ƒç´ å°±åœ¨ç¬¬ä¸€ä¸ªå…ƒç´ ã€‚æ‰€ä»¥æˆ‘ä»¬è¦ä¿è¯å¦‚æœæ‰¾ä¸åˆ°å°±è¿”å›ä¸€ä¸ªè´Ÿæ•°ã€‚æ‰€ä»¥å°±å¤šå‡ä¸ª1 è¿™æ ·-1å°±è¡¨ç¤ºæ²¡æ‰¾åˆ°å¹¶ä¸”è¯¥å…ƒç´ å¿…é¡»æ’åˆ°0çš„ä½ç½®ä¸Š</em>ã€‚</p><p>å¯¹äºå¯ä»¥è¿›è¡Œæ•°å€¼æ¯”è¾ƒçš„keyä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ¯”è¾ƒç®€å•é«˜æ•ˆï¼Œä½†å¯¹äºå­—ç¬¦ç±»å‹çš„keyæ¯”è¾ƒæ—¶å¯ä»¥ä½¿ç”¨æ›´é«˜æ•ˆçš„Trieæ ‘æ¯”è¾ƒã€‚ä¸‹é¢çœ‹ä¸‹Trieæ ‘ã€‚</p><h3 id="Trieæ ‘"><a href="#Trieæ ‘" class="headerlink" title="Trieæ ‘"></a>Trieæ ‘</h3><p>Trieæ ‘åˆç§°å­—å…¸æ ‘ã€å‰ç¼€æ ‘ï¼Œæ˜¯ä¸€ç§æœ‰åºæ ‘ã€‚è·ŸHashMapçš„åŠŸèƒ½ç›¸ä¼¼ï¼Œéƒ½æ˜¯key-valueæ˜ å°„ï¼Œ<em>åªä¸è¿‡Trieå¸¸ç”¨äºæœ‰å…¬å…±å‰ç¼€çš„å­—ç¬¦ä¸²æ˜ å°„ï¼Œå¹¶ä¸”keyåªèƒ½æ˜¯å­—ç¬¦ä¸²</em>ã€‚<br>Trieæ ‘çš„æŸ¥è¯¢æ•ˆç‡è¾ƒé«˜ï¼Œæ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œ<em>nä¸ºå­—ç¬¦ä¸²çš„é•¿åº¦</em>ä¹Ÿå¯ä»¥ç†è§£æˆTrieæ ‘çš„æ·±åº¦ï¼Œ<em>ä¸Trieæ ‘ä¸­ä¿å­˜çš„å­—ç¬¦ä¸²ä¸ªæ•°æ— å…³</em>ã€‚åªæ˜¯å…¶ç©ºé—´å¤æ‚åº¦è¾ƒå¤§ï¼Œæ˜¯ä¸€ä¸ªå…¸å‹çš„æ‹¿ç©ºé—´æ¢æ—¶é—´çš„æ•°æ®ç»“æ„ã€‚</p><p>Trieæ ‘çš„åŸºæœ¬æ€§è´¨å¦‚ä¸‹ï¼š</p><ul><li>æ ¹èŠ‚ç‚¹ä¸åŒ…å«å­—ç¬¦ï¼Œé™¤æ ¹èŠ‚ç‚¹ä¹‹å¤–æ‰€æœ‰çš„èŠ‚ç‚¹<em>æœ€å¤š</em>åŒ…å«<em>ä¸€ä¸ªå­—ç¬¦</em>(ä¸æ˜¯ä¸€ä¸ªå­—ç¬¦ä¸²)ã€‚</li><li>æŠŠæ ¹èŠ‚ç‚¹åˆ°æŸä¸€èŠ‚ç‚¹çš„è·¯å¾„ä¸Šçš„å­—ç¬¦è¿æ¥èµ·æ¥å°±æ˜¯è¯¥èŠ‚ç‚¹å¯¹åº”çš„å­—ç¬¦ä¸²ã€‚</li><li>æ¯ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹åŒ…å«çš„å­—ç¬¦éƒ½ä¸ç›¸åŒï¼Œå¹¶ä¸”æ¯ä¸ªèŠ‚ç‚¹çš„æ‰€æœ‰å­èŠ‚ç‚¹éƒ½æœ‰ç›¸åŒçš„å‰ç¼€ã€‚</li><li>å¦‚æœå­—ç¬¦çš„ç§ç±»æ˜¯nï¼Œåˆ™æ¯ä¸ªèŠ‚ç‚¹<em>ä¸ç®¡å…¶å­èŠ‚ç‚¹ä¸Šæ˜¯å¦æœ‰å¯¹åº”çš„value</em>éƒ½ä¼šæœ‰nä¸ªå­èŠ‚ç‚¹ã€‚(è¿™å°±æµªè´¹äº†å¾ˆå¤šç©ºé—´)</li><li>æ’å…¥å’ŒæŸ¥æ‰¾çš„å¤æ‚åº¦æ˜¯O(n)ï¼Œnä¸ºå­—ç¬¦ä¸²çš„é•¿åº¦ã€‚</li></ul><p>åœ¨å¯¹TotalOrderPartitionä¸­Trieæ ‘çš„æ„é€ è¿‡ç¨‹è¿›è¡Œè§£æä¹‹å‰ï¼Œå…ˆå¯¹å…¶ä¸­ç›¸å…³çš„å†…éƒ¨ç±»è¿›è¡Œä¸‹ä»‹ç»ã€‚</p><p>Nodeæ˜¯ä¸€ä¸ªæ¥å£ï¼ŒTrieNodeæ˜¯æŠ½è±¡ç±»ï¼Œæ‰©å±•äº†Nodeæ¥å£(<em>BinarySearchNodeå®ç°äº†Nodeæ¥å£ï¼Œä½œä¸ºæ•°å€¼å‹æ•°æ®æ¯”è¾ƒèŠ‚ç‚¹</em>)ï¼Œä½œä¸ºTrieæ ‘ä¸­æŠ½è±¡å‡ºçš„èŠ‚ç‚¹ç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">Node</span>&lt;<span class="title">T</span>&gt; </span>&#123;</span><br><span class="line"><span class="comment">// æ‰€æœ‰æ–¹æ³•çš„è®¿é—®æƒé™è‡ªåŠ¨è¢«å£°æ˜ä¸ºpublicã€‚</span></span><br><span class="line"><span class="comment">// ç¡®åˆ‡çš„è¯´åªèƒ½ä¸ºpublicï¼Œå½“ç„¶ä½ å¯ä»¥æ˜¾ç¤ºçš„å£°æ˜ä¸ºprotectedã€privateï¼Œä½†æ˜¯ç¼–è¯‘ä¼šå‡ºé”™</span></span><br><span class="line"><span class="comment">// æ¥å£ä¸­å¯ä»¥å®šä¹‰&quot;æˆå‘˜å˜é‡&quot;ï¼Œæˆ–è€…è¯´æ˜¯ä¸å¯å˜çš„å¸¸é‡ï¼Œ</span></span><br><span class="line"><span class="comment">// å› ä¸ºæ¥å£ä¸­çš„&quot;æˆå‘˜å˜é‡&quot;ä¼šè‡ªåŠ¨å˜ä¸ºpublic static final</span></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">findPartition</span><span class="params">(T key)</span></span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// æŠ½è±¡ç±»å®ç°æ¥å£æ—¶ï¼Œä¸ç”¨å¿…é¡»å®ç°æ¥å£ä¸­çš„æ–¹æ³•</span></span><br><span class="line"><span class="comment">// TrieNode å¹¶æ²¡æœ‰å®ç°Nodeæ¥å£ä¸­çš„findPartitionæ–¹æ³•</span></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">TrieNode</span> <span class="keyword">implements</span> <span class="title">Node</span>&lt;<span class="title">BinaryComparable</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> level;</span><br><span class="line">    TrieNode(<span class="keyword">int</span> level) &#123;</span><br><span class="line">        <span class="keyword">this</span>.level = level;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getLevel</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> level;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥å£å’ŒæŠ½è±¡ç±»ä»‹ç»å®Œå°±å‰©ä¸‹Trieæ ‘ä¸­<em>æ ‡è¯†å„ä¸ªèŠ‚ç‚¹çŠ¶æ€çš„å¯¹è±¡ç±»</em>äº†ï¼ŒåŒ…æ‹¬<code>InnerTrieNode</code>(æœ‰keyçš„èŠ‚ç‚¹)ã€<code>UnsplitTrieNode</code>()ã€<code>SinglySplitTrieNode</code>(å•ä¸ªåˆ‡åˆ†èŠ‚ç‚¹ï¼Œå­˜æ”¾valueå€¼çš„èŠ‚ç‚¹)å’Œ<code>LeafTrieNode</code>()ã€‚</p><p>å¯¹Trieæ ‘æœ‰äº†åˆæ­¥çš„äº†è§£ï¼Œä¸‹é¢çœ‹ä¸‹Trieæ ‘çš„æ„é€ è¿‡ç¨‹ã€‚TotalOrderPartitionä¸­Trieæ ‘çš„æ„é€ æ˜¯ç±»ä¼¼æ·±åº¦éå†é‚£æ ·é€’å½’çš„å¯¹æ ‘è¿›è¡Œæ„å»ºã€‚</p><p>åœ¨æ„å»ºè¿‡ç¨‹ä¸­éœ€è¦æ³¨æ„å‡ ç‚¹ï¼š</p><ul><li><p><em>Trieæ ‘ä¸­èŠ‚ç‚¹åˆ†ä¸¤ç§æƒ…å†µï¼Œä¸€ç§æ˜¯ä¸å­˜æ”¾å­—ç¬¦çš„èŠ‚ç‚¹ï¼Œä¸€ç§æ˜¯å­˜æ”¾å­—ç¬¦çš„æƒ…å†µ</em>ã€‚å¯¹äºä¸å­˜æ”¾å­—ç¬¦çš„èŠ‚ç‚¹ä¸ç”¨ä¸ºå…¶æ„å»ºå­æ ‘ï¼Œå¯¹äºæœ¬ä¾‹ä¸­çš„æƒ…å†µï¼Œç”±äºæ­¤èŠ‚ç‚¹ä¸å­˜æ”¾å­—ç¬¦ä¹Ÿå°±ä¸ç”¨åˆ‡åˆ†ï¼Œåˆ™è¿™ç±»æƒ…å†µçš„èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯<code>UnsplitTrieNode</code>ã€‚å¯¹äºå­˜æ”¾å­—ç¬¦çš„èŠ‚ç‚¹åˆ™æ ¹æ®æ˜¯å¦æ˜¯å¶å­èŠ‚ç‚¹åˆåˆ†ä¸º<code>InnerTrieNode</code>(æ ¹èŠ‚ç‚¹ä¹Ÿæ˜¯InnerTrieNode)å’Œ<code>SinglySplitTrieNode</code>ã€‚</p></li><li><p>ç”±äºæœ¬ä¾‹ä¸­æ¯”è¾ƒçš„æ˜¯å­—ç¬¦ï¼Œåˆ™æ¯ä¸ªèŠ‚ç‚¹æœ€å¤šæœ‰256(asciiç 0-255è¡¨ç¤ºå­—ç¬¦)ä¸ªå­æ ‘ï¼Œä»å·¦åˆ°å³ä¾æ¬¡0-255ï¼Œæ¯ä¸ªå­—ç¬¦å­˜æ”¾åœ¨å¯¹åº”asciiç çš„å­æ ‘ä¸Šï¼Œå¦‚å­—ç¬¦1çš„asciiç æ˜¯49ï¼Œåˆ™å­˜æ”¾åœ¨æ ‡å·ä¸º49çš„å­æ ‘ä¸Šã€‚</p></li><li><p>partition fileä¸­çš„keyæ˜¯æŒ‰ç…§å‡åºæ’å¥½çš„ï¼Œ_ç›¸é‚»çš„å­—ç¬¦ä¼šæœ‰éƒ¨åˆ†å‰ç¼€ç›¸åŒï¼Œåˆ™æ— éœ€åˆ†åˆ«å¯¹å•ä¸ªkeyä¸­çš„å­—ç¬¦è¿›è¡Œæ„å»ºï¼Œè€Œæ˜¯æ¯æ¬¡å¯¹æ‰€æœ‰keyçš„ç¬¬iä¸ªå­—ç¬¦è¿›è¡Œæ„å»º_ï¼Œç”¨<code>currentBound</code>æ ‡è¯†æ˜¯å¯¹ç¬¬å‡ ä¸ªkeyä¸­çš„å­—ç¬¦è¿›è¡Œæ„å»ºã€‚</p></li></ul><p>æ„å»ºä»£ç å…¥å£å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°ä¸º splitPoints, 0, splitPoints.length, new byte[0], conf.getInt(MAX_TRIE_DEPTH, 200)</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> TrieNode <span class="title">buildTrieRec</span><span class="params">(BinaryComparable[] splits, <span class="keyword">int</span> lower,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">int</span> upper, <span class="keyword">byte</span>[] prefix, <span class="keyword">int</span> maxDepth, CarriedTrieNodeRef ref)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// å¯è§ä»£ç ä¸­æ ‘çš„æ·±åº¦ä¸åŒ…æ‹¬æ ¹èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// å‰ç¼€æ•°ç»„æ ‡è¯†äº†å½“å‰Trieæ ‘çš„æ·±åº¦</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> depth = prefix.length;</span><br><span class="line">    <span class="comment">// We generate leaves for a single split point as well as for</span></span><br><span class="line">    <span class="comment">// no split points.</span></span><br><span class="line">    <span class="comment">// ä¸ºå•ä¸ªåˆ‡åˆ†ç‚¹ç”Ÿæˆå¶å­èŠ‚ç‚¹ï¼Œå°±åƒä¸ºé‚£äº›æ— æ³•åˆ‡åˆ†ç‚¹ç”Ÿæˆå¶å­èŠ‚ç‚¹ä¸€æ ·</span></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹åªæœ‰ä¸€ä¸ªå­èŠ‚ç‚¹æœ‰å€¼æ—¶ï¼Œä¸ç”¨å¾ªç¯è®¾ç½®å­èŠ‚ç‚¹çš„çŠ¶æ€ï¼Œç›´æ¥å°†æ­¤èŠ‚ç‚¹å˜ä¸ºå¶å­èŠ‚ç‚¹</span></span><br><span class="line">    <span class="comment">// å½“å‰èŠ‚ç‚¹æœ‰å‡ ä¸ªå­èŠ‚ç‚¹æœ‰å€¼ï¼Œæ˜¯ç”±upper-loweræ¥æ ‡è¯†çš„</span></span><br><span class="line">    <span class="comment">// å¶å­èŠ‚ç‚¹åŒ…æ‹¬ UnsplitTrieNodeã€SinglySplitTrieNodeå’ŒLeafTrieNode</span></span><br><span class="line">    <span class="keyword">if</span> (depth &gt;= maxDepth || lower &gt;= upper - <span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// If we have two consecutive requests for an unsplit trie node, we</span></span><br><span class="line">        <span class="comment">// can deliver the same one the second time.</span></span><br><span class="line">        <span class="keyword">if</span> (lower == upper &amp;&amp; ref.content != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> ref.content;</span><br><span class="line">        &#125;</span><br><span class="line">        TrieNode  result = LeafTrieNodeFactory(depth, splits, lower, upper);</span><br><span class="line">        <span class="comment">// ä¸º ref.content é‡æ–°èµ‹å€¼</span></span><br><span class="line">        ref.content = lower == upper ? result : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœ‰æ•°å€¼çš„èŠ‚ç‚¹å£°æ˜ä¸ºInnerTrieNode</span></span><br><span class="line">    InnerTrieNode result = <span class="keyword">new</span> InnerTrieNode(depth);</span><br><span class="line">    <span class="comment">// å®éªŒæ•°ç»„</span></span><br><span class="line">    <span class="keyword">byte</span>[] trial = Arrays.copyOf(prefix, prefix.length + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// append an extra byte on to the prefix</span></span><br><span class="line">    <span class="keyword">int</span> currentBound = lower;</span><br><span class="line">    <span class="comment">// 0xFFä¸ºintçš„255ï¼Œæ˜¯byteç±»å‹çš„-1</span></span><br><span class="line">    <span class="comment">// ä¸ºå½“å‰èŠ‚ç‚¹ç”Ÿæˆ0-254å­èŠ‚ç‚¹çš„çŠ¶æ€</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> ch = <span class="number">0</span>; ch &lt; <span class="number">0xFF</span>; ++ch) &#123;</span><br><span class="line">        trial[depth] = (<span class="keyword">byte</span>) (ch + <span class="number">1</span>);</span><br><span class="line">        lower = currentBound;</span><br><span class="line">        <span class="keyword">while</span> (currentBound &lt; upper) &#123;</span><br><span class="line">        <span class="comment">// å¯¹ç¬¬currentBoundä¸ªkeyç¬¬trial.lengthä¸ªå­—ç¬¦è¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">        <span class="comment">// å½“splits[currentBound]å¤§æ—¶ï¼Œå½“å‰èŠ‚ç‚¹æ— å­—ç¬¦ï¼Œè·³å‡ºwhileå¾ªç¯ï¼Œ</span></span><br><span class="line">        <span class="comment">// å°†æ­¤èŠ‚ç‚¹å˜ä¸ºUnsplitTrieNodeçŠ¶æ€</span></span><br><span class="line">        <span class="comment">// å½“splits[currentBound]å°æ—¶ï¼Œæ¯”è¾ƒsplitsä¸­ä¸‹ä¸€ä¸ªkeyçš„ç¬¬trial.lengthå­—ç¬¦</span></span><br><span class="line">            <span class="keyword">if</span> (splits[currentBound].compareTo(trial, <span class="number">0</span>, trial.length) &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            currentBound += <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å­˜å‚¨å½“å‰å­—ç¬¦æ‰€åœ¨çš„èŠ‚ç‚¹ç´¢å¼•</span></span><br><span class="line">        trial[depth] = (<span class="keyword">byte</span>) ch;</span><br><span class="line">        <span class="comment">// é€’å½’çš„å¯¹å…¶èŠ‚ç‚¹æ„å»ºå­èŠ‚ç‚¹</span></span><br><span class="line">        result.child[<span class="number">0xFF</span> &amp; ch]</span><br><span class="line">                = buildTrieRec(splits, lower, currentBound, trial, maxDepth, ref);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// pick up the rest</span></span><br><span class="line">    <span class="comment">// é‡ç½®æœ€åä¸€å±‚çš„å€¼ï¼Œä¾¿äºæ„é€ ç¬¬255ä¸ªèŠ‚ç‚¹çš„å€¼</span></span><br><span class="line">    <span class="comment">// forå¾ªç¯åªæ˜¯å¯¹0-254è¿›è¡Œæ„å»º</span></span><br><span class="line">    trial[depth] = (<span class="keyword">byte</span>)<span class="number">0xFF</span>;</span><br><span class="line">    result.child[<span class="number">0xFF</span>]</span><br><span class="line">            = buildTrieRec(splits, lower, currentBound, trial, maxDepth, ref);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;                        </span><br></pre></td></tr></table></figure><p>é¦–æ¬¡<code>buildTrieRec</code>æ˜¯é€šè¿‡<code>buildTrie</code>ï¼Œä¼ å…¥çš„å‚æ•°æ˜¯å­˜æ”¾keyçš„æ•°ç»„splitPointsã€<strong>å¼€å§‹ç´¢å¼•lowerä¸º0ã€ç»“æŸç´¢å¼•upperä¸ºsplitPoints.length</strong>ã€prefixå‰ç¼€æ•°ç»„byte[0]å’Œæœ€å¤§æ·±åº¦é»˜è®¤æ˜¯200ã€‚<em>å…¶ä¸­å¼€å§‹ç´¢å¼•å’Œç»“æŸç´¢å¼•æ˜¯æŒ‡splitPointsä¸­ç¬¬iä¸ªå­—ç¬¦æ¯”å½“å‰å­æ ‘èŠ‚ç‚¹çš„æ ‡å·å°çš„é‚£äº›keyçš„ç´¢å¼•å€¼ï¼Œå¼€å§‹ç´¢å¼•æ˜¯æŒ‡å°äºæ­¤æ ‡å·çš„ç¬¬ä¸€ä¸ªkeyçš„ç´¢å¼•ï¼Œç»“æŸç´¢å¼•æ˜¯æŒ‡å°äºæ­¤æ ‡å·çš„æœ€åä¸€ä¸ªkeyçš„ç´¢å¼•ã€‚</em></p><p>é¦–æ¬¡è°ƒç”¨<code>buildTrieRec</code>æ—¶ï¼Œå¦‚æœsplitPointsçš„é•¿åº¦å¤§äº2ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªæ ¹èŠ‚ç‚¹ï¼Œæ ¹èŠ‚ç‚¹çš„çŠ¶æ€æ˜¯<code>InnerTrieNode</code>ï¼Œ<em>ä½†æ˜¯ä¸å­˜æ”¾ä»»ä½•å­—ç¬¦</em>ã€‚æ ¹èŠ‚ç‚¹åˆ›å»ºä¹‹åç”±ä¸€ä¸ªforå¾ªç¯ä¸ºå…¶254ä¸ªå­æ ‘åˆ›å»ºèŠ‚ç‚¹çš„çŠ¶æ€ï¼Œç¬¬255ä¸ªå­æ ‘ä½œä¸ºè¾¹ç•Œå€¼åœ¨forå¾ªç¯ä¹‹å¤–è¿›è¡Œåˆ›å»ºã€‚<em>åœ¨æ„å»ºå­æ ‘æ—¶æ˜¯æŒ‰ç…§æ·±åº¦ä¼˜å…ˆéå†çš„æ–¹å¼è¿›è¡Œæ„å»ºï¼Œè€Œå­æ ‘çš„æ„å»ºæ˜¯ç”±å­—ç¬¦æ¯”è¾ƒæ‰€å†³å®šçš„ï¼Œå¯¹ä¸åŒæ·±åº¦çš„å­æ ‘æ¯”è¾ƒçš„å­—ç¬¦ä¹Ÿä¸ä¸€æ ·ï¼Œåˆ™éœ€è¦è®°å½•å­æ ‘çš„æ·±åº¦å’Œæ­¤æ—¶æ¯”è¾ƒçš„å­—ç¬¦ï¼Œåˆç”±äºTrieæ ‘æ˜¯ä¸€å±‚ä¸€ä¸ªå­—ç¬¦ï¼Œåˆ™å°†å½“å‰æ¯”è¾ƒå­—ç¬¦åŠå…¶å‰ç¼€å­—ç¬¦ä¿å­˜åˆ°æ•°ç»„ï¼Œè¿™æ ·æ•°ç»„çš„é•¿åº¦å°±æ˜¯å­æ ‘çš„æ·±åº¦ï¼Œæ•°ç»„ä¸­çš„å…ƒç´ å€¼å°±æ˜¯æ‰€éœ€æ¯”è¾ƒçš„å­—ç¬¦ã€‚</em>ä¸Šé¢çš„ä»£ç ä¸­åˆ™æ˜¯åœ¨forå¾ªç¯ä¹‹å‰å°†å‰ç¼€æ•°ç»„å¤åˆ¶åˆ°trialæ•°ç»„(<em>å®éªŒæ•°ç»„</em>)ä¸­ï¼Œå°†loweråšä¸ºå­—ç¬¦æ¯”è¾ƒçš„ç¬¬ä¸€ä¸ªkeyï¼Œå°†å…¶èµ‹å€¼ç»™currentBoundï¼Œç”±currentBoundæ¥æ ‡è¯†æ¯”è¾ƒçš„æ˜¯å½“å‰é›†åˆä¸­çš„ç¬¬å‡ ä¸ªkeyã€‚</p><p>æ¯ä¸ªèŠ‚ç‚¹æœ‰256ä¸ªå­æ ‘ï¼Œä»0å¼€å§‹æ ‡å·ï¼Œå°†ç¬¬255ä¸ªå­æ ‘ä½œä¸ºè¾¹ç•Œå•ç‹¬å¤„ç†ï¼Œåˆ™åœ¨forå¾ªç¯ä¸­å¯¹0-254å­æ ‘è¿›è¡Œå¤„ç†(<code>for(int ch=0; ch&lt;0xFF; ch++)</code>)ï¼Œç”±currentBoundå†³å®šæ¯”è¾ƒçš„æ˜¯ç¬¬å‡ ä¸ªkeyï¼Œç”±trialæ•°ç»„çš„é•¿åº¦å†³å®šæ¯”è¾ƒkeyä¸­çš„ç¬¬å‡ ä¸ªå­—ç¬¦ï¼Œtrialæ•°ç»„ä¸­çš„æœ€åä¸€ä¸ªå˜é‡æ˜¯<code>ch</code>ï¼Œåœ¨forä¸­çš„whileå¾ªç¯é‡Œé€šè¿‡æ¯”è¾ƒkeyçš„ç¬¬trial.lengthä¸ªå­—ç¬¦ä¸chçš„å¤§å°ï¼Œæ‰¾åˆ°è¿™ä¸ªå­—ç¬¦åœ¨å­æ ‘ä¸­çš„åˆé€‚ä½ç½®ï¼Œå¹¶é€šè¿‡currentBoundçš„å€¼æ¥ç»Ÿè®¡å½“å‰keyçš„é›†åˆä¸­æœ‰å¤šå°‘ä¸ªkeyä¸­ç¬¬trial.lengthä¸ªå­—ç¬¦å¯ä»¥æ”¾åœ¨æ­¤å­æ ‘ä¸Šã€‚ç„¶åå¯¹è¯¥èŠ‚ç‚¹è¿›è¡Œé€’å½’çš„åˆ›å»ºå­æ ‘èŠ‚ç‚¹ã€‚<br>éšåè·³å‡ºforå¾ªç¯ï¼Œè®¾ç½®trialçš„å€¼ï¼Œ0xFF(byteç±»å‹ä¸ºæ•°å€¼-1)ï¼Œç„¶åå¯¹255èŠ‚ç‚¹è¿›è¡Œæ„å»º</p><p>ç”¨loweå’Œupperçš„å€¼æ¥åˆ¤æ–­buildçš„é€»è¾‘ï¼Œæ˜¯åˆ›å»ºå­æ ‘æˆ–è€…Unsplitæˆ–è€…SinglySplitã€‚buildé€»è¾‘å¦‚ä¸‹ï¼š</p><ul><li>å½“lowerå’Œupperçš„å·®å€¼å°äºç­‰äº1æ—¶ï¼Œåˆ™è¿›è¡Œæ˜¯æ„å»ºUnsplit(upper-lower==0)è¿˜æ˜¯SinglySplit(upper-lower==1)ã€‚</li><li>å½“å¤§äº1æ—¶ï¼Œåˆ™åˆ©ç”¨forå¾ªç¯æ„å»ºå­æ ‘ã€‚</li></ul><p>ä¸‹é¢çœ‹ä¸‹<code>UnsplitTrieNode</code>å’Œ<code>SinglySplitTrieNode</code>ä¸¤ä¸ªç±»ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">UnsplitTrieNode</span> <span class="keyword">extends</span> <span class="title">TrieNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> result;</span><br><span class="line"></span><br><span class="line">    UnsplitTrieNode(<span class="keyword">int</span> level, <span class="keyword">int</span> value) &#123;</span><br><span class="line">        <span class="keyword">super</span>(level);</span><br><span class="line">        <span class="keyword">this</span>.result = value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿”å›è¯¥èŠ‚ç‚¹ä¸Šçš„keyè¢«åˆ†é…åˆ°çš„reduce id</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findPartition</span><span class="params">(BinaryComparable key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>UnsplitTrieNodeä¸­<em>resultå±æ€§è®°å½•äº†è¯¥åˆ†æ”¯ä¸Šçš„keyåº”è¯¥è¢«åˆ†é…åˆ°å“ªä¸ªåˆ†åŒº</em>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SinglySplitTrieNode</span> <span class="keyword">extends</span> <span class="title">TrieNode</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span>               lower;</span><br><span class="line">    <span class="keyword">final</span> BinaryComparable  mySplitPoint;</span><br><span class="line"></span><br><span class="line">    SinglySplitTrieNode(<span class="keyword">int</span> level, BinaryComparable[] splitPoints, <span class="keyword">int</span> lower) &#123;</span><br><span class="line">        <span class="keyword">super</span>(level);</span><br><span class="line">        <span class="keyword">this</span>.lower = lower;</span><br><span class="line">        <span class="keyword">this</span>.mySplitPoint = splitPoints[lower];</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œå†³å®šäº†å½“keyç­‰äºmySplitPointæ—¶ï¼Œä¼šåˆ†é…åˆ°ä¸‹ä¸€ä¸ªreduceä¸­</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">findPartition</span><span class="params">(BinaryComparable key)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> lower + (key.compareTo(mySplitPoint) &lt; <span class="number">0</span> ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>SinglySplitTrieNodeä¸­lowerå±æ€§è®°å½•äº†å½“å‰keyåœ¨keyé›†åˆä¸­çš„ç´¢å¼•ï¼Œå±æ€§mySplitPointè®°å½•äº†åˆ†ç•Œç‚¹çš„å€¼ã€‚</em></p><p>è‡³æ­¤buildTrieçš„ä¸»è¦é€»è¾‘å·²åˆ†æå®Œæ¯•ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥ä¸ªä¾‹å­å®è·µä¸‹ã€‚<br>åˆ‡åˆ†èŠ‚ç‚¹ä¸º1983ã€1995ã€1999ã€2996ï¼Œåˆ©ç”¨æ­¤4ä¸ªåˆ‡åˆ†èŠ‚ç‚¹æ„å»ºTrieæ ‘å¦‚ä¸‹å›¾ï¼š</p><p><img src="/blogimgs/TotalOrderPartition/Trie.png" alt="Trieæ ‘ç»“æ„å›¾" title="Trieæ ‘ç»“æ„å›¾"></p><blockquote><p>å…¶ä¸­èŠ‚ç‚¹ä¸Šçš„æ•°å­—è¡¨ç¤ºæ¯ä¸ªèŠ‚ç‚¹çš„æ ‡å·ï¼ŒèŒƒå›´æ˜¯0-255ï¼Œä¹Ÿæ˜¯æ¯ä¸ªå­—ç¬¦çš„asciiç ã€‚</p></blockquote><p>å‡å¦‚keyä¸º1973ï¼Œåˆ™ç»è¿‡root-&gt;49-&gt;57ï¼Œç„¶å197æ¯”198å°ï¼Œåˆ™å°†å…¶åˆ†é…ç»™reduce 0<br>å‡å¦‚keyä¸º1983ï¼Œåˆ™ç»è¿‡root-&gt;49-&gt;57-&gt;56ï¼Œå°†å…¶åˆ†é…ç»™reduce 1<br>å‡å¦‚keyä¸º3ï¼Œå°†å…¶åˆ†é…ç»™reduce 3</p><h2 id="NOTE"><a href="#NOTE" class="headerlink" title="NOTE"></a>NOTE</h2><p>partition fileä¸­<em>keyæ˜¯å‡åºçš„</em>ï¼Œå› ä¸ºäºŒåˆ†æŸ¥æ‰¾éœ€è¦æ•°æ®é›†æ˜¯æœ‰åºçš„å’ŒTrieæ ‘çš„æ„å»ºéœ€è¦æ•°æ®æ˜¯æœ‰åºçš„<br>partition fileä¸­keyçš„æ•°æ®ç±»å‹å’Œmap output keyã€reduce input key ç›¸åŒ<br>partition fileä¸­keyçš„åˆ†å¸ƒå°½é‡å‡åŒ€é¿å…æ•°æ®å€¾æ–œ</p><h2 id="å½©è›‹"><a href="#å½©è›‹" class="headerlink" title="å½©è›‹"></a>å½©è›‹</h2><p>Hadoopä¸­æä¾›çš„partitionæ–¹æ³•</p><ol><li>HashPartitioneræ˜¯mapreduceçš„é»˜è®¤partitionerã€‚æ ¹æ®keyçš„hashç»“æœé€‰æ‹©reduceã€‚</li><li>BinaryPatitionerç»§æ‰¿äºPartitioner&lt;BinaryComparable ,V&gt;ï¼Œæ˜¯Partitionerçš„åç‰¹åŒ–å­ç±»ã€‚è¯¥ç±»æä¾›leftOffsetå’ŒrightOffsetï¼Œåœ¨è®¡ç®—which reduceræ—¶ä»…å¯¹é”®å€¼Kçš„[rightOffsetï¼ŒleftOffset]è¿™ä¸ªåŒºé—´å–hashã€‚</li><li>KeyFieldBasedPartitionerä¹Ÿæ˜¯åŸºäºhashçš„ä¸ªpartitionerã€‚KeyFieldBasedPartitionerå¯ä»¥çµæ´»è®¾ç½®keyä¸­ç”¨äºpartitionçš„å­—æ®µï¼Œè€Œä¸æ˜¯æŠŠæ•´ä¸ªkeyéƒ½ç”¨æ¥åšpartitionã€‚</li><li>TotalOrderPartitionerè¿™ä¸ªç±»å¯ä»¥å®ç°è¾“å‡ºçš„å…¨æ’åºã€‚ä¸åŒäºä»¥ä¸Š3ä¸ªpartitionerï¼Œè¿™ä¸ªç±»å¹¶ä¸æ˜¯åŸºäºhashçš„ã€‚</li></ol><!--num.map.output.key.fields è®¾ç½®mapè¾“å‡ºçš„å‰å‡ ä¸ªå­—æ®µä½œä¸ºkeymap.output.field.separator è®¾ç½®mapè¾“å‡ºçš„å­—æ®µåˆ†éš”ç¬¦mapred.text.key.partitioner.options=-k2,3 #ç”¨ç¬¬äºŒå’Œç¬¬ä¸‰ä¸ªfieldè¿›è¡Œåˆ†åŒº-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> å…¨å±€æ’åº </tag>
            
            <tag> MapReduce </tag>
            
            <tag> TotalOrderPartitioner </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceæºç è§£æ--JobSplit</title>
      <link href="/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--JobSplit.html"/>
      <url>/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--JobSplit.html</url>
      
        <content type="html"><![CDATA[<p>MapReduceå°±æ˜¯å°†ä¸€ä¸ªå¤§jobåˆ‡åˆ†ä¸ºnä¸ªtaskï¼Œç”±mapå’Œreduceåˆ†åˆ«å»æ‰§è¡Œï¼Œä½†æ˜¯åˆ‡åˆ†è§„åˆ™æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<em>å…¶å®jobçš„åˆ‡åˆ†ä¹Ÿå°±æ˜¯jobæ‰€éœ€æ–‡ä»¶çš„åˆ‡åˆ†</em>ã€‚</p><p>ä¸‹é¢å°±ä»æºç çš„è§’åº¦ç®€å•åˆ†æä¸‹ã€‚</p><h2 id="æ–‡ä»¶åˆ‡åˆ†"><a href="#æ–‡ä»¶åˆ‡åˆ†" class="headerlink" title="æ–‡ä»¶åˆ‡åˆ†"></a>æ–‡ä»¶åˆ‡åˆ†</h2><p>MRæ˜¯é€šè¿‡JobSubmitter.submitJobInternalæäº¤ç»™RMçš„ï¼Œåœ¨submitJobInternalä¸­é€šè¿‡<code>writeSplits(JobContext job, Path jobSubmitDir)</code>å°†jobçš„è¾“å…¥æ–‡ä»¶è¿›è¡Œsplitï¼ŒwriteSplitåªæ˜¯å¯¹æ–°æ—§apiè¿›è¡Œäº†ä¸‹å°è£…ï¼Œæ ¹æ®ä½ çš„ä»£ç é€‰æ‹©æ–°æ—§apiï¼Œè¿™é‡Œè°ƒç”¨<code>writeNewSplits</code>ä½¿ç”¨æ–°APIå¯¹fileè¿›è¡Œsplit</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;T extends InputSplit&gt;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">writeNewSplits</span><span class="params">(JobContext job, Path jobSubmitDir)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">    InterruptedException, ClassNotFoundException </span>&#123;</span><br><span class="line">  Configuration conf = job.getConfiguration();</span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªInputFormatï¼Œç”¨äºæŒ‡å®šæ–‡ä»¶çš„æ ¼å¼åŒ–æ ¼å¼ï¼Œé»˜è®¤æ˜¯FileInputFormat</span></span><br><span class="line">  InputFormat&lt;?, ?&gt; input =</span><br><span class="line">    ReflectionUtils.newInstance(job.getInputFormatClass(), conf);</span><br><span class="line">  <span class="comment">// ä»JobContextä¸­çš„INPUT_DIRä¸­æ‹¿åˆ°filesï¼Œç„¶åæ ¹æ®splitSizeå¯¹æ–‡ä»¶è¿›è¡Œåˆ‡åˆ†</span></span><br><span class="line">  List&lt;InputSplit&gt; splits = input.getSplits(job);</span><br><span class="line">  T[] array = (T[]) splits.toArray(<span class="keyword">new</span> InputSplit[splits.size()]);</span><br><span class="line">  <span class="comment">// sort the splits into order based on size, so that the biggest</span></span><br><span class="line">  <span class="comment">// go first</span></span><br><span class="line">  <span class="comment">// å¯¹splitsè¿›è¡Œæ’åºï¼ŒæŒ‰ç…§splitçš„å¤§å°è¿›è¡Œé€†åºæ’åºï¼Œå…ˆå¤„ç†å¤§çš„</span></span><br><span class="line">  Arrays.sort(array, <span class="keyword">new</span> SplitComparator());</span><br><span class="line">  <span class="comment">// å°†splitä¿¡æ¯å›ºåŒ–åˆ°æ–‡ä»¶ä¸­</span></span><br><span class="line">  JobSplitWriter.createSplitFiles(jobSubmitDir, conf, </span><br><span class="line">      jobSubmitDir.getFileSystem(conf), array);</span><br><span class="line">  <span class="keyword">return</span> array.length;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>writeNewSplitsæ ¹æ®å¾—åˆ°çš„InputFormatå®ä¾‹ï¼Œè°ƒç”¨getSplitså¯¹æ–‡ä»¶è¿›è¡Œåˆ‡åˆ†ï¼Œè¿™ä¹Ÿæ˜¯åˆ‡åˆ†çš„ä¸»è¦é€»è¾‘ï¼Œçœ‹ä¸‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;InputSplit&gt; <span class="title">getSplits</span><span class="params">(JobContext job)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// å¾—åˆ°splitçš„å¤§å°ï¼Œç”±mapreduce.input.fileinputformat.split.minsizeæ§åˆ¶</span></span><br><span class="line">  <span class="keyword">long</span> minSize = Math.max(getFormatMinSplitSize(), getMinSplitSize(job));</span><br><span class="line">  <span class="comment">// splitçš„æœ€å¤§å€¼ï¼Œé»˜è®¤æ˜¯Long.MAX_VALUE</span></span><br><span class="line">  <span class="keyword">long</span> maxSize = getMaxSplitSize(job);</span><br><span class="line">  <span class="comment">// generate splits</span></span><br><span class="line">  List&lt;InputSplit&gt; splits = <span class="keyword">new</span> ArrayList&lt;InputSplit&gt;();</span><br><span class="line">  <span class="comment">// å¤šçº¿ç¨‹å¾—åˆ°è¾“å…¥è·¯å¾„ä¸­çš„æ–‡ä»¶çŠ¶æ€</span></span><br><span class="line">  List&lt;FileStatus&gt; files = listStatus(job);</span><br><span class="line">  <span class="comment">// ä»¥æ–‡ä»¶ä¸ºå•ä½è¿›è¡Œåˆ‡åˆ†</span></span><br><span class="line">  <span class="keyword">for</span> (FileStatus file: files) &#123;</span><br><span class="line">    Path path = file.getPath();</span><br><span class="line">    <span class="keyword">long</span> length = file.getLen();</span><br><span class="line">    <span class="keyword">if</span> (length != <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// å¾—åˆ°fileæ‰€æœ‰blockçš„locationsä¿¡æ¯ï¼Œè¯¦æƒ…è¯·çœ‹BlockLocationsç±»</span></span><br><span class="line">      BlockLocation[] blkLocations;</span><br><span class="line">      <span class="keyword">if</span> (file <span class="keyword">instanceof</span> LocatedFileStatus) &#123;</span><br><span class="line">        blkLocations = ((LocatedFileStatus) file).getBlockLocations();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        FileSystem fs = path.getFileSystem(job.getConfiguration());</span><br><span class="line">        blkLocations = fs.getFileBlockLocations(file, <span class="number">0</span>, length);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// åˆ¤æ–­æ˜¯å¦å¯ä»¥åˆ‡åˆ†ï¼Œå‹ç¼©æ–‡ä»¶ä¸èƒ½åˆ‡åˆ†</span></span><br><span class="line">      <span class="keyword">if</span> (isSplitable(job, path)) &#123;</span><br><span class="line">      <span class="comment">// å¾—åˆ°å½“å‰fileçš„blockå¤§å°</span></span><br><span class="line">        <span class="keyword">long</span> blockSize = file.getBlockSize();</span><br><span class="line">        <span class="comment">// è®¡ç®—åˆ‡åˆ†å€¼ max(minSize, min(blockSize,maxSize))</span></span><br><span class="line">        <span class="comment">// å‡ºä¸å¯¹MRçš„ä¼˜åŒ–ï¼ŒminSizeé…ç½®çš„ä¸€èˆ¬éƒ½ç­‰äºblockSizeæˆ–è€…æ˜¯blockSizeçš„æ•´æ•°å€</span></span><br><span class="line">        <span class="comment">// å¦‚æœå¤§blockSizeï¼Œä¼šæœ‰åˆ«çš„blocké€šè¿‡ç½‘ç»œä¼ è¾“åˆ°mapèŠ‚ç‚¹ï¼Œé€ æˆç½‘ç»œå‹åŠ›</span></span><br><span class="line">        <span class="keyword">long</span> splitSize = computeSplitSize(blockSize, minSize, maxSize);</span><br><span class="line">        <span class="comment">// å¾ªç¯åˆ‡åˆ†ï¼Œè¿™é‡Œæœ‰ä¸ªå°ä¼˜åŒ–ï¼Œåœ¨å¤§æ•°æ®ä¸­é¿å…å‡ºç°å°æ–‡ä»¶ï¼Œ</span></span><br><span class="line">        <span class="comment">// å°†æœ€åå‰©ä¸‹ä¸€ä¸ªæ¯”splitSizeç¨å¾®å¤§ä¸€ç‚¹ä¸å†è¿›è¡Œåˆ‡åˆ†ï¼Œ</span></span><br><span class="line">        <span class="comment">// å› ä¸ºSPLIT_SLOP = 1.1ï¼Œè€Œä¸æ˜¯ 1</span></span><br><span class="line">        <span class="keyword">long</span> bytesRemaining = length;</span><br><span class="line">        <span class="keyword">while</span> (((<span class="keyword">double</span>) bytesRemaining)/splitSize &gt; SPLIT_SLOP) &#123;</span><br><span class="line">          <span class="comment">// æ ¹æ®åç§»é‡length-bytesRemainingï¼Œåœ¨blkLocationsä¸­æ‰¾åˆ°åç§»é‡æ‰€åœ¨blockçš„index</span></span><br><span class="line">          <span class="comment">// è¿™é‡Œåªæ˜¯èµ·å§‹blockçš„indexï¼Œè¯¥splitå¯èƒ½åŒ…å«å¤šä¸ªblock</span></span><br><span class="line">          <span class="comment">// lengthä¸º1100ï¼Œblockä¸º128ï¼ŒsplitSizeä¸º500ï¼Œåˆ™ç¬¬ä¸€ä¸ªsplitçš„indexä¸º0ï¼Œç¬¬äºŒä¸ªåˆ™æ˜¯4</span></span><br><span class="line">          <span class="keyword">int</span> blkIndex = getBlockIndex(blkLocations, length-bytesRemaining);</span><br><span class="line">          <span class="comment">// å°†æ–‡ä»¶çš„åˆ‡åˆ†ä¿¡æ¯é€šè¿‡makeSplitå†™å…¥FileSplitå¯¹è±¡ä¸­</span></span><br><span class="line">          <span class="comment">// åªæ˜¯å°†å½“å‰blkIndexçš„blockçš„ç›¸å…³ä¿¡æ¯æ”¾å…¥FileSplitä¸­</span></span><br><span class="line">          splits.add(makeSplit(path, length-bytesRemaining, splitSize,</span><br><span class="line">                      blkLocations[blkIndex].getHosts(),</span><br><span class="line">                      blkLocations[blkIndex].getCachedHosts()));</span><br><span class="line">          bytesRemaining -= splitSize;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bytesRemaining != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">int</span> blkIndex = getBlockIndex(blkLocations, length-bytesRemaining);</span><br><span class="line">          splits.add(makeSplit(path, length-bytesRemaining, bytesRemaining,</span><br><span class="line">                     blkLocations[blkIndex].getHosts(),</span><br><span class="line">                     blkLocations[blkIndex].getCachedHosts()));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123; <span class="comment">// not splitable</span></span><br><span class="line">        splits.add(makeSplit(path, <span class="number">0</span>, length, blkLocations[<span class="number">0</span>].getHosts(),</span><br><span class="line">                    blkLocations[<span class="number">0</span>].getCachedHosts()));</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; </span><br><span class="line">      <span class="comment">//Create empty hosts array for zero length files</span></span><br><span class="line">      splits.add(makeSplit(path, <span class="number">0</span>, length, <span class="keyword">new</span> String[<span class="number">0</span>]));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Save the number of input files for metrics/loadgen</span></span><br><span class="line">  job.getConfiguration().setLong(NUM_INPUT_FILES, files.size());</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> splits;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getSplitsä¸»è¦æ˜¯å°†filesçš„è¿›è¡Œåˆ‡ç‰‡ï¼Œå°†æ–‡ä»¶è·¯å¾„pathã€åç§»é‡(å³èµ·å§‹ä½ç½®ï¼Œæ˜¯è¯¥splitåœ¨æ•´ä¸ªæ–‡ä»¶ä¸­çš„èµ·å§‹ä½ç½®)ã€åˆ‡åˆ†å¤§å°splitSizeã€åç§»é‡æ‰€åœ¨blockçš„locationsä¿¡æ¯Hostå’Œåœ¨å†…å­˜ä¸­çš„hostä¿¡æ¯å†™å…¥<code>FileSplit</code>å¯¹è±¡ä¸­ï¼Œä¸€ä¸ªsplitå¯¹åº”ä¸€ä¸ªå¯¹è±¡ï¼Œæœ€åæ”¾å…¥splitsä¸­è¿”å›ã€‚</p><p>å…¶å®ƒè¯¦ç»†ä¿¡æ¯å·²åœ¨ä»£ç ä¸­è¿›è¡Œæ³¨é‡Šï¼Œ<strong>è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ç”±äºsplitSizeå¯èƒ½å¤§äºblockSizeï¼Œåˆ™åˆ‡åˆ†çš„splitå¯èƒ½æœ‰å¤šä¸ªblockç»„æˆï¼Œä»£ç ä¸­å¾—åˆ°çš„blockIndexåªæ˜¯åç§»é‡æ‰€åœ¨blockçš„indexï¼Œè€Œè®°å½•åœ¨FileSplitä¸­çš„Hostsä¿¡æ¯ä¹Ÿåªæ˜¯åç§»é‡æ‰€åœ¨blockçš„å‰¯æœ¬æ‰€åœ¨hosts</strong>ã€‚</p><p>writeNewSplitsä¸­input.getSplitså°†filesè¿›è¡Œåˆ‡åˆ†æ”¾å…¥listä¸­ï¼Œç„¶åå°†listè½¬æ¢ä¸ºarrayï¼Œå¯¹arrayä¸­çš„å…ƒç´ æ ¹æ®é•¿åº¦è¿›è¡Œé€†åºæ’åºã€‚æœ€åè°ƒç”¨<code>JobSplitWriter.createSplitFiles</code>å°†ä¿å­˜åˆ‡åˆ†ä¿¡æ¯çš„arrayè½åœ°åˆ°æ–‡ä»¶ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T extends InputSplit&gt; <span class="function"><span class="keyword">void</span> <span class="title">createSplitFiles</span><span class="params">(Path jobSubmitDir, </span></span></span><br><span class="line"><span class="params"><span class="function">    Configuration conf, FileSystem fs, T[] splits)</span> </span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡createFileåˆ›å»ºåˆ†ç‰‡æ–‡ä»¶å¹¶è·å–æ–‡ä»¶ç³»ç»Ÿæ•°æ®è¾“å‡ºæµFSDataOutputStreamå®ä¾‹outï¼Œ</span></span><br><span class="line">  FSDataOutputStream out = createFile(fs, </span><br><span class="line">      JobSubmissionFiles.getJobSplitFile(jobSubmitDir), conf);</span><br><span class="line">  <span class="comment">// å°†åˆ†ç‰‡æ•°æ®FileSplitå¯¹è±¡å†™å…¥åˆ†ç‰‡æ–‡ä»¶ï¼Œå¹¶è¿”å›splitçš„å…ƒæ•°æ®</span></span><br><span class="line">  SplitMetaInfo[] info = writeNewSplits(conf, splits, out);</span><br><span class="line">  out.close();</span><br><span class="line">  <span class="comment">// å°†splitçš„å…ƒæ•°æ®å†™å…¥åˆ†ç‰‡å…ƒæ•°æ®æ–‡ä»¶ä¸­</span></span><br><span class="line">  writeJobSplitMetaInfo(fs,JobSubmissionFiles.getJobSplitMetaFile(jobSubmitDir), </span><br><span class="line">      <span class="keyword">new</span> FsPermission(JobSubmissionFiles.JOB_FILE_PERMISSION), splitVersion,</span><br><span class="line">      info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createSplitFilesåˆ›å»ºçš„æ–‡ä»¶åŒ…æ‹¬ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯è®°å½•åˆ‡ç‰‡çš„åˆ‡ç‰‡æ–‡ä»¶å’Œè®°å½•åˆ‡ç‰‡å…ƒæ•°æ®çš„åˆ‡ç‰‡å…ƒæ•°æ®æ–‡ä»¶ï¼Œè¿™ä¸¤ä¸ªæ–‡ä»¶åˆ†åˆ«è®°å½•çš„æ˜¯ä»€ä¹ˆå†…å®¹ç»§ç»­åˆ†æä»£ç ã€‚</p><p>å…ˆçœ‹ä¸‹<code>createFile</code>ï¼Œè¯¥æ–¹æ³•é€šè¿‡<code>JobSubmissionFiles.getJobSplitFile(jobSubmitDir)</code>å¾—åˆ°åˆ‡ç‰‡æ–‡ä»¶çš„è·¯å¾„ï¼Œæ ¹æ®å…¶è·¯å¾„åˆ›å»ºä¸€ä¸ªæ•°æ®è¾“å‡ºæµ<code>FileSystem.create</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> FSDataOutputStream <span class="title">createFile</span><span class="params">(FileSystem fs, Path splitFile, </span></span></span><br><span class="line"><span class="params"><span class="function">    Configuration job)</span>  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// æ ¹æ®jobSubmitDir/job.splitçš„è·¯å¾„åˆ›å»ºæ•°æ®è¾“å‡ºæµ</span></span><br><span class="line">  FSDataOutputStream out = FileSystem.create(fs, splitFile, </span><br><span class="line">      <span class="keyword">new</span> FsPermission(JobSubmissionFiles.JOB_FILE_PERMISSION));</span><br><span class="line">  <span class="comment">// è®¾ç½®åˆ‡ç‰‡æ–‡ä»¶çš„å‰¯æœ¬æ•°ï¼Œé»˜è®¤æ˜¯10</span></span><br><span class="line">  <span class="keyword">int</span> replication = job.getInt(Job.SUBMIT_REPLICATION, <span class="number">10</span>);</span><br><span class="line">  fs.setReplication(splitFile, (<span class="keyword">short</span>)replication);</span><br><span class="line">  <span class="comment">// å°†åˆ‡ç‰‡æ–‡ä»¶çš„å¤´ä¿¡æ¯å†™å…¥åˆ‡ç‰‡æ–‡ä»¶ä¸­</span></span><br><span class="line">  <span class="comment">// å¤´ä¿¡æ¯ä¸º SPLIT_FILE_HEADER(å€¼ä¸ºSPL) å’Œ splitVersion(å€¼ä¸ºJobSplit.META_SPLIT_VERSION  1)</span></span><br><span class="line">  writeSplitHeader(out);</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†æ•°æ®è¾“å‡ºæµè¿”å›ï¼Œæ¥ç€è°ƒç”¨<code>writeNewSplits</code>å°†splitæ•°æ®å†™å…¥åˆ‡ç‰‡æ–‡ä»¶(<em>job.split</em>)ä¸­ï¼Œå¹¶è¿”å›åˆ‡ç‰‡çš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> &lt;T extends InputSplit&gt; </span><br><span class="line">SplitMetaInfo[] writeNewSplits(Configuration conf, </span><br><span class="line">    T[] array, FSDataOutputStream out)</span><br><span class="line"><span class="keyword">throws</span> IOException, InterruptedException &#123;</span><br><span class="line">  <span class="comment">// new å‡ºç”¨äºå­˜æ”¾å…ƒæ•°æ®ä¿¡æ¯çš„æ•°ç»„</span></span><br><span class="line">  SplitMetaInfo[] info = <span class="keyword">new</span> SplitMetaInfo[array.length];</span><br><span class="line">  <span class="keyword">if</span> (array.length != <span class="number">0</span>) &#123;</span><br><span class="line">    SerializationFactory factory = <span class="keyword">new</span> SerializationFactory(conf);</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// mapreduce.job.max.split.locations</span></span><br><span class="line">    <span class="comment">// è¯¥splitä¸­å¤šä¸ªblockå‰¯æœ¬æ‰€åœ¨çš„hostä¸ªæ•°ä¸èƒ½è¶…è¿‡è¯¥å€¼</span></span><br><span class="line">    <span class="keyword">int</span> maxBlockLocations = conf.getInt(MRConfig.MAX_BLOCK_LOCATIONS_KEY,</span><br><span class="line">        MRConfig.MAX_BLOCK_LOCATIONS_DEFAULT);</span><br><span class="line">    <span class="keyword">long</span> offset = out.getPos();</span><br><span class="line">    <span class="keyword">for</span>(T split: array) &#123;</span><br><span class="line">      <span class="keyword">long</span> prevCount = out.getPos();</span><br><span class="line">      <span class="comment">// å°†splitçš„ç±»å è¿™é‡Œå°±æ˜¯FileSplitå†™å…¥job.splitæ–‡ä»¶ä¸­</span></span><br><span class="line">      Text.writeString(out, split.getClass().getName());</span><br><span class="line">      Serializer&lt;T&gt; serializer = </span><br><span class="line">        factory.getSerializer((Class&lt;T&gt;) split.getClass());</span><br><span class="line">      serializer.open(out);</span><br><span class="line">      <span class="comment">// å°†splitæ•°æ®åºåˆ—åŒ–å†™å…¥job.splitä¸­</span></span><br><span class="line">      serializer.serialize(split);</span><br><span class="line">      <span class="keyword">long</span> currCount = out.getPos();</span><br><span class="line">      <span class="comment">// æ­¤å¤„å¾—åˆ°çš„locationsåªæ˜¯offsetæ‰€åœ¨blockçš„locationsï¼Ÿ</span></span><br><span class="line">      <span class="comment">// åº”è¯¥æ‹¿åˆ°çš„æ˜¯job.splitä¸­æ•°æ®çš„position</span></span><br><span class="line">      <span class="comment">// åŠ å…¥è¯¥splitæœ‰å¤šä¸ªblockç»„æˆï¼Œå…¶ä½™blockçš„locationåœ¨å“ªåˆå¹¶çš„ï¼Ÿ</span></span><br><span class="line">      String[] locations = split.getLocations();</span><br><span class="line">      <span class="keyword">if</span> (locations.length &gt; maxBlockLocations) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Max block location exceeded for split: &quot;</span></span><br><span class="line">            + split + <span class="string">&quot; splitsize: &quot;</span> + locations.length +</span><br><span class="line">            <span class="string">&quot; maxsize: &quot;</span> + maxBlockLocations);</span><br><span class="line">        locations = Arrays.copyOf(locations, maxBlockLocations);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å°†splitå…ƒæ•°æ®ä¿¡æ¯å†™å…¥SplitMetaInfoçš„æ•°ç»„ä¸­</span></span><br><span class="line">      <span class="comment">// å…ƒæ•°æ®åŒ…æ‹¬locationsã€offsetå’Œlength</span></span><br><span class="line">      info[i++] = </span><br><span class="line">        <span class="keyword">new</span> JobSplit.SplitMetaInfo( </span><br><span class="line">            locations, offset,</span><br><span class="line">            split.getLength());</span><br><span class="line">      offset += currCount - prevCount;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> info;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»ä»£ç ä¸­å¾—çŸ¥job.splitæ–‡ä»¶ä¸­çš„å†…å®¹ä¸ºå¤´ä¿¡æ¯(<em>SPLIT_FILE_HEADER</em> å€¼ä¸ºSPL å’Œ <em>splitVersion</em> å€¼ä¸ºJobSplit.META_SPLIT_VERSION  1)å’Œè‹¥å¹²ä¸ªsplitæ•°æ®ï¼Œsplitæ•°æ®ä¸ºsplitç±»å+FileSplitå¯¹è±¡åºåˆ—åŒ–åçš„å†…å®¹ã€‚</p><p>å†™å…¥job.splitä¹‹åå°†splitå…ƒæ•°æ®ä¿¡æ¯è¿”å›ï¼Œç»§ç»­è°ƒç”¨<code>writeJobSplitMetaInfo</code>å°†å…ƒæ•°æ®ä¿¡æ¯å†™å…¥job.splitmetainfoä¸­ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">writeJobSplitMetaInfo</span><span class="params">(FileSystem fs, Path filename, </span></span></span><br><span class="line"><span class="params"><span class="function">    FsPermission p, <span class="keyword">int</span> splitMetaInfoVersion, </span></span></span><br><span class="line"><span class="params"><span class="function">    JobSplit.SplitMetaInfo[] allSplitMetaInfo)</span> </span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// write the splits meta-info to a file for the job tracker</span></span><br><span class="line">  <span class="comment">// é€šè¿‡JobSubmissionFiles.getJobSplitMetaFileå¾—åˆ°å…ƒæ•°æ®çš„æ–‡ä»¶è·¯å¾„job.splitmetainfo</span></span><br><span class="line">  <span class="comment">// æ‰“å¼€æ•°æ®è¾“å‡ºæµ</span></span><br><span class="line">  FSDataOutputStream out = </span><br><span class="line">    FileSystem.create(fs, filename, p);</span><br><span class="line">  <span class="comment">// å°†å¤´ä¿¡æ¯å†™å…¥ &quot;META-SPL&quot;</span></span><br><span class="line">  out.write(JobSplit.META_SPLIT_FILE_HEADER);</span><br><span class="line">  <span class="comment">// å’Œjob.splitä¸€ä¸ªç‰ˆæœ¬å·</span></span><br><span class="line">  WritableUtils.writeVInt(out, splitMetaInfoVersion);</span><br><span class="line">  <span class="comment">// splitå…ƒæ•°æ®çš„ä¸ªæ•°ä¹Ÿå°±æ˜¯splitåˆ†ç‰‡çš„ä¸ªæ•°</span></span><br><span class="line">  WritableUtils.writeVInt(out, allSplitMetaInfo.length);</span><br><span class="line">  <span class="comment">// å°†å…ƒæ•°æ®ä¿¡æ¯SplitMetaInfoå¯¹è±¡å†™å…¥</span></span><br><span class="line">  <span class="keyword">for</span> (JobSplit.SplitMetaInfo splitMetaInfo : allSplitMetaInfo) &#123;</span><br><span class="line">    splitMetaInfo.write(out);</span><br><span class="line">  &#125;</span><br><span class="line">  out.close();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>splitå…ƒæ•°æ®ä¿¡æ¯å†™å…¥job.splitmetainfoï¼Œæ•°æ®æ ¼å¼ä¸ºå¤´ä¿¡æ¯(<em>META_SPLIT_FILE_HEADER</em> å€¼ä¸ºMETA-SPLã€ç‰ˆæœ¬å·1)ã€å…ƒæ•°æ®ä¸ªæ•°å’Œå…ƒæ•°æ®SplitMetaInfoå¯¹è±¡ã€‚</p><p>æ–‡ä»¶åˆ‡åˆ†å®Œä¹‹åï¼Œå°±æ˜¯å¯åŠ¨taskè¿›è¡Œå¤„ç†ï¼Œä¹Ÿå°±æ˜¯jobçš„åˆ‡åˆ†ï¼Œä¸‹é¢çœ‹ä¸‹jobåˆ‡åˆ†ã€‚</p><h2 id="jobåˆ‡åˆ†"><a href="#jobåˆ‡åˆ†" class="headerlink" title="jobåˆ‡åˆ†"></a>jobåˆ‡åˆ†</h2><p>MRåˆ‡åˆ†çš„ä»£ç åœ¨JobImpl.javaä¸­ï¼Œé¦–å…ˆç”±äº‹ä»¶<code>JobEventType.JOB_INIT</code>è§¦å‘è°ƒç”¨<code>InitTransition.transition</code>å¯¹jobè¿›è¡Œinit(<em>å¯¹äºyarnçš„äº‹ä»¶è°ƒç”¨å’ŒçŠ¶æ€è½¬æ¢å¯ä»¥çœ‹<a href="http://bigdatadecode.top/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BAsyncDispatcher%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%99%A8.html">AsyncDispatcheräº‹ä»¶è°ƒåº¦å™¨</a>å’Œ<a href="http://bigdatadecode.top/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BStateMachineFactory%E7%8A%B6%E6%80%81%E6%9C%BA.html">StateMachineFactoryçŠ¶æ€æœº</a>è¿™ä¸¤ç¯‡æ–‡ç« </em>)ï¼Œtransitionè°ƒç”¨createSplitså¯¹jobè¿›è¡Œåˆ‡åˆ†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">protected</span> TaskSplitMetaInfo[] createSplits(JobImpl job, JobId jobId) &#123;</span><br><span class="line">  TaskSplitMetaInfo[] allTaskSplitMetaInfo;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// è¯»å–splitçš„job.splitå’Œjob.splitmetainfoè¿›è¡Œåˆ‡åˆ†</span></span><br><span class="line">    allTaskSplitMetaInfo = SplitMetaInfoReader.readSplitMetaInfo(</span><br><span class="line">        job.oldJobId, job.fs, </span><br><span class="line">        job.conf, </span><br><span class="line">        job.remoteJobSubmitDir);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> allTaskSplitMetaInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡SplitMetaInfoReader.readSplitMetaInfoè¯»å–splitçš„åˆ‡ç‰‡ä¿¡æ¯ï¼Œå¯¹jobè¿›è¡Œåˆ‡åˆ†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> JobSplit.TaskSplitMetaInfo[] readSplitMetaInfo(</span><br><span class="line">    JobID jobId, FileSystem fs, Configuration conf, Path jobSubmitDir) </span><br><span class="line"><span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">long</span> maxMetaInfoSize = conf.getLong(MRJobConfig.SPLIT_METAINFO_MAXSIZE,</span><br><span class="line">      MRJobConfig.DEFAULT_SPLIT_METAINFO_MAXSIZE);</span><br><span class="line">  <span class="comment">// å¾—åˆ°job.splitmetainfoå’Œjob.splitçš„è·¯å¾„</span></span><br><span class="line">  Path metaSplitFile = JobSubmissionFiles.getJobSplitMetaFile(jobSubmitDir);</span><br><span class="line">  String jobSplitFile = JobSubmissionFiles.getJobSplitFile(jobSubmitDir).toString();</span><br><span class="line">  FileStatus fStatus = fs.getFileStatus(metaSplitFile);</span><br><span class="line">  <span class="keyword">if</span> (maxMetaInfoSize &gt; <span class="number">0</span> &amp;&amp; fStatus.getLen() &gt; maxMetaInfoSize) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Split metadata size exceeded &quot;</span> +</span><br><span class="line">        maxMetaInfoSize +<span class="string">&quot;. Aborting job &quot;</span> + jobId);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ‰“å¼€job.splitmetainfoçš„è¯»å–æ•°æ®æµ</span></span><br><span class="line">  FSDataInputStream in = fs.open(metaSplitFile);</span><br><span class="line">  <span class="keyword">byte</span>[] header = <span class="keyword">new</span> <span class="keyword">byte</span>[JobSplit.META_SPLIT_FILE_HEADER.length];</span><br><span class="line">  <span class="comment">// è¯»å–å¤´æ–‡ä»¶</span></span><br><span class="line">  in.readFully(header);</span><br><span class="line">  <span class="keyword">if</span> (!Arrays.equals(JobSplit.META_SPLIT_FILE_HEADER, header)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Invalid header on split file&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç‰ˆæœ¬å·</span></span><br><span class="line">  <span class="keyword">int</span> vers = WritableUtils.readVInt(in);</span><br><span class="line">  <span class="keyword">if</span> (vers != JobSplit.META_SPLIT_VERSION) &#123;</span><br><span class="line">    in.close();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unsupported split version &quot;</span> + vers);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åˆ‡ç‰‡çš„ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">int</span> numSplits = WritableUtils.readVInt(in); <span class="comment">//<span class="doctag">TODO:</span> check for insane values</span></span><br><span class="line">  JobSplit.TaskSplitMetaInfo[] allSplitMetaInfo = </span><br><span class="line">    <span class="keyword">new</span> JobSplit.TaskSplitMetaInfo[numSplits];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numSplits; i++) &#123;</span><br><span class="line">    JobSplit.SplitMetaInfo splitMetaInfo = <span class="keyword">new</span> JobSplit.SplitMetaInfo();</span><br><span class="line">    <span class="comment">// åˆ‡ç‰‡çš„å…ƒæ•°æ®ä¿¡æ¯</span></span><br><span class="line">    splitMetaInfo.readFields(in);</span><br><span class="line">    <span class="comment">// æ ¹æ®å…ƒæ•°æ®å’Œsplitæ•°æ®ä¿¡æ¯å¯¹jobè¿›è¡Œåˆ‡åˆ†</span></span><br><span class="line">    JobSplit.TaskSplitIndex splitIndex = <span class="keyword">new</span> JobSplit.TaskSplitIndex(</span><br><span class="line">        jobSplitFile, </span><br><span class="line">        splitMetaInfo.getStartOffset());</span><br><span class="line">    <span class="comment">// å°†åˆ‡åˆ†ä¹‹åçš„taskå…ƒæ•°æ®æ”¾å…¥æ•°ç»„</span></span><br><span class="line">    allSplitMetaInfo[i] = <span class="keyword">new</span> JobSplit.TaskSplitMetaInfo(splitIndex, </span><br><span class="line">        splitMetaInfo.getLocations(), </span><br><span class="line">        splitMetaInfo.getInputDataLength());</span><br><span class="line">  &#125;</span><br><span class="line">  in.close();</span><br><span class="line">  <span class="keyword">return</span> allSplitMetaInfo;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†åˆ‡åˆ†ä¹‹åçš„tasksè¿”å›ï¼Œåœ¨transtionä¸­è°ƒç”¨</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">createMapTasks(job, inputLength, taskSplitMetaInfo);</span><br><span class="line">createReduceTasks(job);</span><br></pre></td></tr></table></figure><p>è¿›è¡Œtaskçš„åˆ›å»ºï¼Œå…ˆçœ‹ä¸‹createMapTasksçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createMapTasks</span><span class="params">(JobImpl job, <span class="keyword">long</span> inputLength,</span></span></span><br><span class="line"><span class="params"><span class="function">                            TaskSplitMetaInfo[] splits)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; job.numMapTasks; ++i) &#123;</span><br><span class="line">  <span class="comment">// æ ¹æ®taskçš„å…ƒæ•°æ®ä¿¡æ¯è¿›è¡ŒTaskImplçš„å®ä¾‹åŒ–</span></span><br><span class="line">    TaskImpl task =</span><br><span class="line">        <span class="keyword">new</span> MapTaskImpl(job.jobId, i,</span><br><span class="line">            job.eventHandler, </span><br><span class="line">            job.remoteJobConfFile, </span><br><span class="line">            job.conf, splits[i], </span><br><span class="line">            job.taskAttemptListener, </span><br><span class="line">            job.jobToken, job.jobCredentials,</span><br><span class="line">            job.clock,</span><br><span class="line">            job.applicationAttemptId.getAttemptId(),</span><br><span class="line">            job.metrics, job.appContext);</span><br><span class="line">    <span class="comment">// å°†taskä¿¡æ¯ä¿å­˜åˆ°jobImplä¸­</span></span><br><span class="line">    job.addTask(task);</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">&quot;Input size for job &quot;</span> + job.jobId + <span class="string">&quot; = &quot;</span> + inputLength</span><br><span class="line">      + <span class="string">&quot;. Number of splits = &quot;</span> + splits.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>addTaskçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">addTask</span><span class="params">(Task task)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (tasksSyncHandle) &#123;</span><br><span class="line">    <span class="keyword">if</span> (lazyTasksCopyNeeded) &#123;</span><br><span class="line">      Map&lt;TaskId, Task&gt; newTasks = <span class="keyword">new</span> LinkedHashMap&lt;TaskId, Task&gt;();</span><br><span class="line">      newTasks.putAll(tasks);</span><br><span class="line">      tasks = newTasks;</span><br><span class="line">      lazyTasksCopyNeeded = <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†taskå’ŒtaskIDä½œä¸ºæ˜ å°„æ”¾å…¥tasksçš„mapä¸­</span></span><br><span class="line">  tasks.put(task.getID(), task);</span><br><span class="line">  <span class="comment">// å°†taskIDæ”¾å…¥setä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (task.getType() == TaskType.MAP) &#123;</span><br><span class="line">    mapTasks.add(task.getID());</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (task.getType() == TaskType.REDUCE) &#123;</span><br><span class="line">    reduceTasks.add(task.getID());</span><br><span class="line">  &#125;</span><br><span class="line">  metrics.waitingTask(task);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å°†taskåˆ‡åˆ†å¥½ä¹‹åå°±æ˜¯ç­‰å¾…è°ƒåº¦äº†ï¼Œä»£ç ä¸º<code>job.scheduleTasks(job.mapTasks, job.numReduceTasks == 0);</code>ï¼Œè¿™ä¸ªä¹Ÿæ˜¯ç”±äº‹ä»¶è§¦å‘çš„ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œéšåå¯èƒ½ä¼šå•ç‹¬ä»‹ç»ã€‚</p><!-- ## ç–‘æƒ‘å¯ä»¥è®¾ç½®â€œmapred.min.split.sizeâ€å‚æ•°ï¼Œä½¿å¾—Splitçš„å¤§å°å¤§äºä¸€ä¸ªBlockï¼Œè¿™æ—¶å€™FileInputFormatä¼šå°†è¿ç»­çš„è‹¥å¹²ä¸ªBlockåˆ†åœ¨ä¸€ä¸ªSplitä¸­ã€ä¹Ÿå¯èƒ½ä¼šå°†ä¸€ä¸ªBlockåˆ†åˆ«åˆ’åœ¨ä¸åŒçš„Splitä¸­ï¼ˆä½†æ˜¯å‰ææ˜¯ä¸€ä¸ªSplitå¿…é¡»åœ¨ä¸€ä¸ªæ–‡ä»¶ä¸­ï¼‰ã€‚Splitçš„Startã€Lengthéƒ½å¥½è¯´ï¼Œéƒ½æ˜¯åˆ’åˆ†å‰å°±å®šå¥½çš„ã€‚è€ŒSplitçš„Locationå°±éœ€è¦å¯¹æ‰€æœ‰åˆ’åœ¨å…¶ä¸­çš„Blockçš„Locationè¿›è¡Œæ•´åˆï¼Œå°½é‡å¯»æ‰¾å®ƒä»¬å…±æœ‰çš„Locationã€‚è€Œè¿™äº›Blockå¾ˆå¯èƒ½å¹¶æ²¡æœ‰å…±åŒçš„Locationï¼Œé‚£ä¹ˆå°±éœ€è¦æ‰¾ä¸€ä¸ªè·ç¦»è¿™äº›Blockæœ€è¿‘çš„Locationä½œä¸ºSplitçš„Locationã€‚   *ä»£ç åœ¨å“ªï¼Ÿï¼Ÿï¼Ÿï¼Ÿ  åˆ‡å…¥ç‚¹   TaskImpl task = new MapTaskImpl*-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> MapReduce </tag>
            
            <tag> JobSplit </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>mac/linuxä¸‹è‡ªåŠ¨è¾“å…¥å¯†ç ç™»å½•æœåŠ¡å™¨/è·³æ¿æœºè„šæœ¬</title>
      <link href="/mac%E4%B8%8B%E8%87%AA%E5%8A%A8%E8%BE%93%E5%85%A5%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E8%B7%B3%E6%9D%BF%E6%9C%BA%E8%84%9A%E6%9C%AC.html"/>
      <url>/mac%E4%B8%8B%E8%87%AA%E5%8A%A8%E8%BE%93%E5%85%A5%E5%AF%86%E7%A0%81%E7%99%BB%E5%BD%95%E8%B7%B3%E6%9D%BF%E6%9C%BA%E8%84%9A%E6%9C%AC.html</url>
      
        <content type="html"><![CDATA[<p>ç”¨winæ—¶ï¼Œæœ‰xshellä¹‹ç±»çš„å·¥å…·å¸®ä½ è®°å½•æœåŠ¡å™¨æˆ–è€…è·³æ¿æœºçš„å¯†ç ï¼Œä½†åˆ°mac/linuxä¸Šæ—¶è™½ç„¶ä¹Ÿæœ‰è¿™æ ·çš„è½¯ä»¶ï¼Œä½†macæœ¬èº«å°±æœ‰ç»ˆç«¯ï¼Œå†ç”¨è¿™æ ·è½¯ä»¶ä½¿ç”¨shellï¼Œæ„Ÿè§‰ä¸å¤ªèˆ’æœ(æˆ‘æœ‰ä¸ªæ€ªç™–ï¼Œå°±æ˜¯ç”µè„‘èƒ½ä¸è£…çš„è½¯ä»¶å†³ä¸å®‰è£…)ã€‚äºæ˜¯å°±æƒ³è‡ªå·±å†™ä¸ªè„šæœ¬å®ç°è¿™æ ·çš„åŠŸèƒ½ã€‚</p><p>é‚£å°±å¼€å§‹å¹²å§ï¼Œè¿™é‡Œè‡ªå·±ç»™è‡ªå·±åŸ‹äº†ä¸ªå‘ï¼Œé‚£å°±æ˜¯å½“åˆåœ¨winä¸Šç”Ÿæˆrsaæ—¶ï¼Œè¾“å…¥äº†å¯†ç ï¼Œç»“æœåœ¨macä¸Šæ‰§è¡Œssh-addæ·»åŠ å¯†é’¥æ—¶éœ€è¦è¾“å…¥å¯†ç ï¼Œè¿™å°±ä½¿è„šæœ¬ä¸å¤ªè‡ªåŠ¨åŒ–ï¼Œéœ€è¦æ‰‹åŠ¨è¾“å…¥å¯†ç ã€‚<br>äºæ˜¯åªèƒ½æ±‚åŠ©googleäº†ï¼Œå‘ç°äº†expectï¼Œäºæ˜¯å°±æŠŠè„šæœ¬å‡çº§äº†ä¸‹ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><blockquote><p>æ²¡æœ‰expectåˆ™åˆ©ç”¨brewå®‰è£…ï¼Œå‘½ä»¤<code>brew install expect</code></p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/usr/bin/expect</span></span><br><span class="line"></span><br><span class="line">spawn ssh -A -p port username@ip</span><br><span class="line"></span><br><span class="line">expect &#123;</span><br><span class="line">    <span class="string">&quot;*?ermission denied&quot;</span> &#123;</span><br><span class="line">        <span class="built_in">set</span> password <span class="string">&quot;ç”Ÿæˆrsaæ—¶çš„å¯†ç &quot;</span></span><br><span class="line">        spawn ssh-add /Users/hadoop/.ssh/id_rsa_2048</span><br><span class="line">        expect <span class="string">&quot;passphrase&quot;</span></span><br><span class="line">        send <span class="string">&quot;<span class="variable">$password</span>\n&quot;</span></span><br><span class="line">        interact</span><br><span class="line">        spawn ssh -A -p port username@ip</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="string">&quot;*?ast login*&quot;</span> &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">interact</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> mac/linux </tag>
            
            <tag> è‡ªåŠ¨è¾“å…¥å¯†ç  </tag>
            
            <tag> sshè„šæœ¬ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hive outer join ä¹‹è°“è¯ä¸‹æ”¾</title>
      <link href="/hive%20outer%20join%20%E4%B9%8B%E8%B0%93%E8%AF%8D%E4%B8%8B%E6%94%BE.html"/>
      <url>/hive%20outer%20join%20%E4%B9%8B%E8%B0%93%E8%AF%8D%E4%B8%8B%E6%94%BE.html</url>
      
        <content type="html"><![CDATA[<p>joinæ˜¯sqlä¸­å¸¸ç”¨çš„å…³é”®å­—ï¼ŒåŒæ ·åœ¨hiveä¸­ï¼Œjoinè¯­å¥ä¹Ÿç»å¸¸è¢«ç”¨åˆ°ï¼Œå°¤å…¶æ˜¯ä¸€äº›outer joinè¯­å¥ï¼Œä½†åœ¨ä½¿ç”¨è¿™æ ·outer joinè¯­å¥æ—¶ï¼Œä¸å°å¿ƒå°±ä¼šè¸©åˆ°å‘é‡Œï¼Œä½¿ç»“æœä¸é¢„æœŸçš„ä¸ä¸€æ ·ï¼Œæˆ–è€…ä½¿sqlæ‰§è¡Œä¸å¤Ÿé«˜æ•ˆã€‚</p><p>è¿™é‡Œå°±è¯¦ç»†ä»‹ç»ä¸‹hive outer joinã€‚</p><p>ä¸‹é¢å…ˆçœ‹å‡ ä¸ªæ¦‚å¿µï¼š</p><ul><li>ä¿ç•™è¡¨(Preserved Row table)</li></ul><p>åœ¨outer joinä¸­éœ€è¦_è¿”å›æ‰€æœ‰æ•°æ®çš„è¡¨_å«åšä¿ç•™è¡¨ï¼Œä¹Ÿå°±æ˜¯è¯´åœ¨left outer joinä¸­ï¼Œå·¦è¡¨éœ€è¦è¿”å›æ‰€æœ‰æ•°æ®ï¼Œåˆ™å·¦è¡¨æ˜¯ä¿ç•™è¡¨ï¼›right outer joinä¸­å³è¡¨åˆ™æ˜¯ä¿ç•™è¡¨ï¼›åœ¨full outer joinä¸­å·¦è¡¨å’Œå³è¡¨éƒ½è¦è¿”å›æ‰€æœ‰æ•°æ®ï¼Œåˆ™å·¦å³è¡¨éƒ½æ˜¯ä¿ç•™è¡¨ã€‚</p><ul><li>Null Supplying table(è¿™ä¸ªæ€ä¹ˆç¿»è¯‘ï¼Ÿ æ”¯æŒnullçš„è¡¨ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ)</li></ul><p>åœ¨outer joinä¸­å¯¹äºæ²¡æœ‰åŒ¹é…åˆ°çš„è¡Œéœ€è¦ç”¨nullæ¥å¡«å……çš„è¡¨ç§°ä¸ºNull Supplying tableã€‚åœ¨left outer joinä¸­ï¼Œå·¦è¡¨çš„æ•°æ®å…¨è¿”å›ï¼Œå¯¹äºå·¦è¡¨åœ¨å³è¡¨ä¸­æ— æ³•åŒ¹é…çš„æ•°æ®çš„ç›¸åº”åˆ—ç”¨nullè¡¨ç¤ºï¼Œåˆ™æ­¤æ—¶å³è¡¨æ˜¯Null Supplying tableï¼Œç›¸åº”çš„å¦‚æœæ˜¯right outer joinçš„è¯ï¼Œå·¦è¡¨æ˜¯Null Supplying tableã€‚_ä½†æ˜¯åœ¨full outer joinä¸­å·¦è¡¨å’Œå³è¡¨éƒ½æ˜¯Null Supplying table_ï¼Œå› ä¸ºå·¦è¡¨å’Œå³è¡¨éƒ½ä¼šç”¨nullæ¥å¡«å……æ— æ³•åŒ¹é…çš„æ•°æ®ã€‚</p><blockquote><p>æ­¤æ—¶ä½ ä¼šå‘ç°full outer joinå°±æ˜¯ä¸ªçŸ›ç›¾ä½“ï¼Œå› ä¸ºæ­¤æ—¶çš„å·¦è¡¨å’Œå³è¡¨å³ä½¿ä¿ç•™è¡¨åˆæ˜¯Null Supplying tableï¼Œè¿™å°±å¯¼è‡´åœ¨outer joinä¸­è°“è¯ä¸‹æ”¾æ—¶æœ‰ä¸€äº›é—®é¢˜ã€‚ </p></blockquote><ul><li>Joinä¸­çš„è°“è¯ </li></ul><p>Joinä¸­çš„è°“è¯æ˜¯æŒ‡ Join Onè¯­å¥ä¸­çš„è°“è¯ã€‚å¦‚ï¼šâ€™R1 join R2 on R1.x = 5â€™ the predicate â€˜R1.x = 5â€™æ˜¯Joinä¸­çš„è°“è¯</p><ul><li>Joinä¹‹åçš„è°“è¯</li></ul><p>whereè¯­å¥ä¸­çš„è°“è¯ç§°ä¹‹ä¸ºJoinä¹‹åçš„è°“è¯</p><span id="more"></span><p><strong>æœ€å¥½ä½¿ç”¨å­æŸ¥è¯¢çš„æ–¹å¼è¿›è¡Œjoin</strong></p><h2 id="è°“è¯ä¸‹æ”¾"><a href="#è°“è¯ä¸‹æ”¾" class="headerlink" title="è°“è¯ä¸‹æ”¾"></a>è°“è¯ä¸‹æ”¾</h2><blockquote><p>è°“è¯ï¼šè°“è¯æ˜¯ä¸€ä¸ªå±æ€§æˆ–æ˜¯ä¸€ä¸ªè¡¨ç¤ºâ€œæŒæœ‰â€æˆ–â€œä¸æŒæœ‰â€çš„è¡¨è¾¾å¼ï¼Œæ¢å¥è¯è¯´ï¼Œä¹Ÿå°±æ˜¯å–å€¼ä¸º TRUEã€FALSE æˆ– UNKNOWN çš„è¡¨è¾¾å¼ã€‚è°“è¯ç”¨äº WHERE å­å¥å’Œ HAVING å­å¥çš„æœç´¢æ¡ä»¶ä¸­ï¼Œè¿˜ç”¨äº FROM å­å¥çš„è”æ¥æ¡ä»¶ä»¥åŠéœ€è¦å¸ƒå°”å€¼çš„å…¶ä»–æ„é€ ä¸­ã€‚</p></blockquote><p>å¯¹äºouter joinä¸­çš„å‘ï¼Œä¸»è¦æ˜¯å¯¹è°“è¯ä¸‹æ”¾çš„è§„åˆ™ä¸ç†Ÿæ‚‰ï¼Œå¯¼è‡´ç†è§£çš„ä¸å¤Ÿå…¨é¢ï¼Œé€ æˆä¸€äº›å‘ã€‚<br>è°“è¯ä¸‹æ”¾çš„è§„åˆ™æœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«ä¸º</p><ol><li>Joinä¸­è°“è¯å¦‚æœæ˜¯ä¿ç•™è¡¨çš„ï¼Œåˆ™ä¸ä¼šä¸‹æ”¾ã€‚</li><li>Joinä¹‹åçš„è°“è¯å¦‚æœæ˜¯Null Supplying tablesçš„ï¼Œåˆ™ä¸ä¼šä¸‹æ”¾ã€‚</li></ol><p>ä¸‹é¢æ¥çœ‹å†™ä¾‹å­æ¥åŠ æ·±ç†è§£ã€‚</p><h2 id="æ —å­"><a href="#æ —å­" class="headerlink" title="æ —å­"></a>æ —å­</h2><blockquote><p>åˆ›å»ºä¸¤ä¸ªè¡¨</p></blockquote><p>create table t1 (id int, name string) ROW FORMAT DELIMITED FIELDS TERMINATED BY â€œ,â€;<br>create table t2 (id int, name string) ROW FORMAT DELIMITED FIELDS TERMINATED BY â€œ,â€;</p><p>t1é‡Œçš„æ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1,a</span><br><span class="line">1,b</span><br><span class="line">2,a</span><br><span class="line">2,b</span><br><span class="line">3,a</span><br><span class="line">3,b</span><br><span class="line">4,b</span><br></pre></td></tr></table></figure><p>t2é‡Œçš„æ•°æ®å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1,aa</span><br><span class="line">4,dd</span><br></pre></td></tr></table></figure><blockquote><p>åœ¨æ‰§è¡Œä¾‹å­ä¹‹å‰ï¼Œé¿å…map joinå½±å“åˆ°å„ä¸ªä¾‹å­çš„æ‰§è¡Œè®¡åˆ’ï¼Œå…ˆå…³é—­map joinï¼Œ<code>set hive.auto.convert.join=false;</code></p></blockquote><ul><li>case 1ï¼Œsqlå¦‚ä¸‹ï¼š<br><code>select t1.*,t2.name as name_t2 from t1 left outer join t2 on (t1.id=t2.id) where t1.name=&#39;a&#39; and t2.name=&#39;aa&#39;;</code><br>æ­¤sqlä¸­ï¼Œä¿ç•™è¡¨ä¸ºt1ï¼ŒNull Supplying tableä¸ºt2ï¼Œjoinä¸­è°“è¯åœ¨æ­¤sqlä¸­æ²¡æœ‰ï¼Œwhereä¸­çš„ä¸¤ä¸ªè°“è¯éƒ½æ˜¯joinä¹‹åçš„è°“è¯ã€‚<br>åˆ™æ ¹æ®è°“è¯ä¸‹æ”¾è§„åˆ™ï¼Œ<code>t1.name=&#39;a&#39;</code>æ˜¯ä¿ç•™è¡¨çš„å­—æ®µï¼Œåˆ™è¢«ä¸‹æ”¾ï¼Œè€Œ<code>t2.name=&#39;aa&#39;</code>æ˜¯Null Supplying tableçš„ï¼ŒNull Supplying tableä¸æ”¯æŒjoinä¹‹åçš„è°“è¯ä¸‹æ”¾ã€‚<br>é‚£ä¹ˆæ­¤æ—¶çš„sqlå°±ç­‰åŒäº</li></ul><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t.<span class="operator">*</span>,t2.name <span class="keyword">as</span> name_t2 </span><br><span class="line"><span class="keyword">from</span> (</span><br><span class="line"><span class="keyword">select</span> id, name <span class="keyword">from</span> t1 <span class="keyword">where</span> t1.name<span class="operator">=</span><span class="string">&#x27;a&#x27;</span></span><br><span class="line">) <span class="keyword">as</span> t <span class="keyword">left</span> <span class="keyword">outer</span> <span class="keyword">join</span> t2 <span class="keyword">on</span></span><br><span class="line">(t.id<span class="operator">=</span>t2.id) <span class="keyword">where</span> t2.name<span class="operator">=</span><span class="string">&#x27;aa&#x27;</span>;</span><br></pre></td></tr></table></figure><p>å…¶<strong>ç»“æœ</strong>ä¸º<code>1 a aa</code>ï¼Œ<strong>å¯èƒ½ä½ çš„æœŸæœ›ç»“æœæ˜¯</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1aaa</span><br><span class="line">2aNULL</span><br><span class="line">3aNULL</span><br></pre></td></tr></table></figure><p>é€ æˆè¿™æ ·çš„ç»“æœæ˜¯å› ä¸ºhiveä¸­outer joinè°“è¯ä¸‹æ”¾çš„è§„åˆ™ã€‚<br>case1 sqlä¸­çš„<code>t2.name=&#39;aa&#39;</code>æ˜¯joinä¹‹åçš„è°“è¯ï¼Œä¸ä¼šè¢«ä¸‹æ”¾åˆ°t2ä¸­(t2æ˜¯Null Supplying table)ï¼Œè€Œæ˜¯å¯¹<em>t1å’Œt2 joinçš„ç»“æœ</em>è¿›è¡Œfilterï¼Œfilterçš„æ¡ä»¶æ˜¯<code>t2.name=&#39;aa&#39;</code>ï¼Œäºæ˜¯å°±å‡ºç°äº†<code>1 a aa</code>ç»“æœï¼Œå› ä¸ºå…¶ä½™æ•°æ®çš„t2.nameçš„å€¼éƒ½ä¸ºNULLã€‚</p><p>ç°åœ¨æ¥è§£æä¸‹case1çš„æ‰§è¡Œè¿‡ç¨‹ã€‚<br>é¦–å…ˆsqlä¸­æœ‰ä¸¤ä¸ª<em>joinä¹‹åçš„è°“è¯</em>ï¼Œåˆ†åˆ«ä¸º<code>t1.name=&#39;a&#39; and t2.name=&#39;aa&#39;</code>ï¼Œå…¶ä¸­t1.nameæ˜¯ä¿ç•™è¡¨t1çš„ï¼Œä¼šè°“è¯ä¸‹æ”¾ï¼Œåœ¨scan t1è¡¨æ—¶ï¼Œå¯¹t1ä¸­çš„æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œt2.nameæ˜¯t2çš„ï¼Œ<em>t2ä¸æ˜¯ä¿ç•™è¡¨ï¼Œè°“è¯æ— æ³•ä¸‹æ”¾</em>ï¼Œè€Œwhereåˆæ˜¯åœ¨joinä¹‹åæ‰§è¡Œçš„(<strong>Joins occur BEFORE WHERE CLAUSES</strong>)ã€‚çœ‹ä¸‹sqlçš„æ‰§è¡Œè®¡åˆ’ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">STAGE DEPENDENCIES:</span><br><span class="line">  Stage-1 is a root stage</span><br><span class="line">  Stage-0 depends on stages: Stage-1</span><br><span class="line"></span><br><span class="line">STAGE PLANS:</span><br><span class="line">  Stage: Stage-1</span><br><span class="line">    Map Reduce</span><br><span class="line">      Map Operator Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t1</span><br><span class="line">            Statistics: Num rows: 5 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Filter Operator</span><br><span class="line">              predicate: (name = <span class="string">&#x27;a&#x27;</span>) (<span class="built_in">type</span>: boolean)</span><br><span class="line">              Statistics: Num rows: 2 Data size: 11 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              Reduce Output Operator</span><br><span class="line">                key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">                sort order: +</span><br><span class="line">                Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">                Statistics: Num rows: 2 Data size: 11 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t2</span><br><span class="line">            Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Reduce Output Operator</span><br><span class="line">              key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">              sort order: +</span><br><span class="line">              Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">      Reduce Operator Tree:</span><br><span class="line">        Join Operator</span><br><span class="line">          condition map:</span><br><span class="line">               Left Outer Join0 to 1</span><br><span class="line">          keys:</span><br><span class="line">            0 id (<span class="built_in">type</span>: int)</span><br><span class="line">            1 id (<span class="built_in">type</span>: int)</span><br><span class="line">          outputColumnNames: _col0, _col6</span><br><span class="line">          Statistics: Num rows: 2 Data size: 12 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">          Filter Operator</span><br><span class="line">            predicate: (_col6 = <span class="string">&#x27;aa&#x27;</span>) (<span class="built_in">type</span>: boolean)</span><br><span class="line">            Statistics: Num rows: 1 Data size: 6 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Select Operator</span><br><span class="line">              expressions: _col0 (<span class="built_in">type</span>: int), <span class="string">&#x27;a&#x27;</span> (<span class="built_in">type</span>: string), <span class="string">&#x27;aa&#x27;</span> (<span class="built_in">type</span>: string)</span><br><span class="line">              outputColumnNames: _col0, _col1, _col2</span><br><span class="line">              Statistics: Num rows: 1 Data size: 6 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              File Output Operator</span><br><span class="line">                compressed: <span class="literal">false</span></span><br><span class="line">                Statistics: Num rows: 1 Data size: 6 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">                table:</span><br><span class="line">                    input format: org.apache.hadoop.mapred.TextInputFormat</span><br><span class="line">                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</span><br><span class="line">                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage-0</span><br><span class="line">    Fetch Operator</span><br><span class="line">      <span class="built_in">limit</span>: -1</span><br><span class="line">      Processor Tree:</span><br><span class="line">        ListSink</span><br></pre></td></tr></table></figure><p>ä»sqlçš„æ‰§è¡Œè®¡åˆ’ä¸Šä¹Ÿå¯ä»¥çœ‹å‡ºï¼ŒTableScan t1æ—¶ä½¿ç”¨äº†<code>predicate: (name = &#39;a&#39;) (type: boolean)</code>å¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ï¼Œ(åˆ™è¿›å…¥mrçš„t1æ•°æ®ä¸æ˜¯å…¨è¡¨æ•°æ®ï¼Œè€Œæ˜¯è¿‡æ»¤è¿‡çš„æ•°æ®)ã€‚è€Œwhereå¯¹åº”çš„filter operatoræ˜¯åœ¨joinä¹‹åæ‰æ‰§è¡Œçš„ã€‚</p><ul><li>case 2ï¼Œsqlå¦‚ä¸‹ï¼š<br><code>select t1.*,t2.name as name_t2 from t1 left outer join t2 on (t1.id=t2.id and t2.name=&#39;aa&#39;) where t1.name=&#39;a&#39;;</code><br>æ‰§è¡Œç»“æœä¸º</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1aaa</span><br><span class="line">2aNULL</span><br><span class="line">3aNULL</span><br></pre></td></tr></table></figure><p>å…¶ä¸­t2.nameæ˜¯joinä¸­è°“è¯ï¼Œt1.nameæ˜¯joinä¹‹åè°“è¯ï¼Œæ ¹æ®è§„åˆ™joinä¸­è°“è¯èƒ½ä¸‹æ”¾åˆ°t2ä¸­ï¼Œjoinä¹‹åçš„è°“è¯èƒ½ä¸‹æ”¾åˆ°t1ä¸­ï¼Œåˆ™ä¸Šé¢sqlçš„æ„æ€æ˜¯å°†t1ä¸­nameä¸ºaçš„æ•°æ®ä¸t2ä¸­nameä¸ºaaçš„æ•°æ®è¿›è¡Œjoinï¼Œ<em>t1å’Œt2éƒ½ä¼šåœ¨table scanæ—¶è¿›è¡Œæ•°æ®è¿‡æ»¤</em>ã€‚sqlçš„æ‰§è¡Œè®¡åˆ’å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line">STAGE DEPENDENCIES:</span><br><span class="line">  Stage-1 is a root stage</span><br><span class="line">  Stage-0 depends on stages: Stage-1</span><br><span class="line"></span><br><span class="line">STAGE PLANS:</span><br><span class="line">  Stage: Stage-1</span><br><span class="line">    Map Reduce</span><br><span class="line">      Map Operator Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t1</span><br><span class="line">            Statistics: Num rows: 5 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Filter Operator</span><br><span class="line">              predicate: (name = <span class="string">&#x27;a&#x27;</span>) (<span class="built_in">type</span>: boolean)</span><br><span class="line">              Statistics: Num rows: 2 Data size: 11 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              Reduce Output Operator</span><br><span class="line">                key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">                sort order: +</span><br><span class="line">                Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">                Statistics: Num rows: 2 Data size: 11 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t2</span><br><span class="line">            Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Filter Operator</span><br><span class="line">              predicate: (name = <span class="string">&#x27;aa&#x27;</span>) (<span class="built_in">type</span>: boolean)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              Reduce Output Operator</span><br><span class="line">                key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">                sort order: +</span><br><span class="line">                Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">                Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">                value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">      Reduce Operator Tree:</span><br><span class="line">        Join Operator</span><br><span class="line">          condition map:</span><br><span class="line">               Left Outer Join0 to 1</span><br><span class="line">          keys:</span><br><span class="line">            0 id (<span class="built_in">type</span>: int)</span><br><span class="line">            1 id (<span class="built_in">type</span>: int)</span><br><span class="line">          outputColumnNames: _col0, _col6</span><br><span class="line">          Statistics: Num rows: 2 Data size: 12 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">          Select Operator</span><br><span class="line">            expressions: _col0 (<span class="built_in">type</span>: int), <span class="string">&#x27;a&#x27;</span> (<span class="built_in">type</span>: string), _col6 (<span class="built_in">type</span>: string)</span><br><span class="line">            outputColumnNames: _col0, _col1, _col2</span><br><span class="line">            Statistics: Num rows: 2 Data size: 12 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            File Output Operator</span><br><span class="line">              compressed: <span class="literal">false</span></span><br><span class="line">              Statistics: Num rows: 2 Data size: 12 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              table:</span><br><span class="line">                  input format: org.apache.hadoop.mapred.TextInputFormat</span><br><span class="line">                  output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</span><br><span class="line">                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage-0</span><br><span class="line">    Fetch Operator</span><br><span class="line">      <span class="built_in">limit</span>: -1</span><br><span class="line">      Processor Tree:</span><br><span class="line">        ListSink</span><br></pre></td></tr></table></figure><p>ä»æ‰§è¡Œè®¡åˆ’ä¸Šå¯ä»¥çœ‹å‡ºt1å’Œt2çš„TableScanä¸­éƒ½å­˜åœ¨Filter Operatoræ“ä½œï¼Œå¯¹æ•°æ®è¿›è¡Œè¿‡æ»¤ã€‚</p><ul><li>case 3ï¼Œsqlå¦‚ä¸‹ï¼š<br><code>select t1.*,t2.name as name_t2 from t1 left outer join t2 on (t1.id=t2.id and t1.name=&#39;a&#39; ) where t2.name=&#39;aa&#39;;</code><br>æ­¤sqlä¸­æœ‰ä¸¤ä¸ªè°“è¯ï¼Œä¸€ä¸ªæ˜¯joinä¸­è°“è¯<code>t1.name=&#39;a&#39;</code>å’Œjoinä¹‹åè°“è¯<code>t2.name=&#39;aa&#39;</code>ã€‚<br>è¿™é‡Œéœ€è¦æ˜ç™½ä¸€ç‚¹ï¼Œ<strong>joinä¸­è°“è¯å†³å®šäº†è¿›è¡Œjoinçš„æ•°æ®ï¼Œjoinä¹‹åè°“è¯å†³å®šäº†æœ€ç»ˆè¦å‘ˆç°çš„æ•°æ®</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´joinä¸­è°“è¯<code>t1.name=&#39;a&#39;</code>å†³å®šäº†t1è¡¨ä¸­nameä¸ºaçš„æ•°æ®æ‰å»å’Œt2è¿›è¡Œjoinï¼Œè€Œjoinä¹‹åè°“è¯<code>t2.name=&#39;aa&#39;</code>å†³å®šäº†æœ€ç»ˆçš„ç»“æœã€‚<br>æ‰§è¡Œç»“æœä¸ºï¼š<code>1    a    aa</code>ã€‚</li></ul><p>è¿™é‡Œçš„ç»“æœéšä¾¿å’Œcase 1çš„ç»“æœä¸€æ ·ï¼Œä½†æ˜¯æ‰§è¡Œçš„å†…éƒ¨é€»è¾‘æ˜¯ä¸ä¸€æ ·çš„ï¼Œcase3åœ¨æ‰§è¡Œwhere filterä¹‹å‰è¿”å›çš„æ•°æ®æ˜¯t1å…¨è¡¨çš„æ•°æ®ï¼Œè€Œcase1åœ¨æ‰§è¡Œwhere filterä¹‹å‰è¿”å›çš„æ•°æ®æ˜¯t1ä¸­nameä¸ºaçš„æ•°æ®ï¼Œå› ä¸ºcase3ä¸­joinä¸­è°“è¯<code>t1.name=&#39;a&#39;</code>å¹¶ä¸èƒ½å¯¹t1è¿›è¡Œä¸‹æ”¾ï¼Œè¿™é‡Œçš„è¯­ä¹‰æ˜¯<em>å¯¹t1è¿›è¡Œå…¨è¡¨æ‰«æï¼Œåªæ‹¿nameä¸ºaçš„æ•°æ®å’Œt2è¿›è¡Œjoinï¼ŒidåŒ¹é…æˆåŠŸåˆ™ä¸ºt2.nameçš„å€¼ï¼ŒåŒ¹é…ä¸æˆåŠŸå’Œnameä¸ä¸ºaçš„æ•°æ®ä¸­t2.nameçš„å€¼éƒ½ä¸ºNULL</em>ï¼Œjoinç»“æŸä¹‹åç”±where filterè¿‡æ»¤<code>t2.name=&#39;aa&#39;</code>ï¼Œå› æ­¤å°±å‡ºç°äº†ä¸Šé¢çš„ç»“æœ(å› ä¸ºæ²¡æœ‰åŒ¹é…æˆåŠŸçš„å’Œæ²¡æœ‰è¿›è¡ŒåŒ¹é…çš„æ•°æ®éƒ½æ˜¯NULLï¼Œè¢«è¿‡æ»¤)ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">STAGE DEPENDENCIES:</span><br><span class="line">  Stage-1 is a root stage</span><br><span class="line">  Stage-0 depends on stages: Stage-1</span><br><span class="line"></span><br><span class="line">STAGE PLANS:</span><br><span class="line">  Stage: Stage-1</span><br><span class="line">    Map Reduce</span><br><span class="line">      Map Operator Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t1</span><br><span class="line">            Statistics: Num rows: 1 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Reduce Output Operator</span><br><span class="line">              key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">              sort order: +</span><br><span class="line">              Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t2</span><br><span class="line">            Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Reduce Output Operator</span><br><span class="line">              key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">              sort order: +</span><br><span class="line">              Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">      Reduce Operator Tree:</span><br><span class="line">        Join Operator</span><br><span class="line">          condition map:</span><br><span class="line">               Left Outer Join0 to 1</span><br><span class="line">          filter predicates:</span><br><span class="line">            0 &#123;(VALUE._col0 = <span class="string">&#x27;a&#x27;</span>)&#125;</span><br><span class="line">            1</span><br><span class="line">          keys:</span><br><span class="line">            0 id (<span class="built_in">type</span>: int)</span><br><span class="line">            1 id (<span class="built_in">type</span>: int)</span><br><span class="line">          outputColumnNames: _col0, _col1, _col6</span><br><span class="line">          Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">          Filter Operator</span><br><span class="line">            predicate: (_col6 = <span class="string">&#x27;aa&#x27;</span>) (<span class="built_in">type</span>: boolean)</span><br><span class="line">            Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Select Operator</span><br><span class="line">              expressions: _col0 (<span class="built_in">type</span>: int), _col1 (<span class="built_in">type</span>: string), <span class="string">&#x27;aa&#x27;</span> (<span class="built_in">type</span>: string)</span><br><span class="line">              outputColumnNames: _col0, _col1, _col2</span><br><span class="line">              Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              File Output Operator</span><br><span class="line">                compressed: <span class="literal">false</span></span><br><span class="line">                Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">                table:</span><br><span class="line">                    input format: org.apache.hadoop.mapred.TextInputFormat</span><br><span class="line">                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</span><br><span class="line">                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage-0</span><br><span class="line">    Fetch Operator</span><br><span class="line">      <span class="built_in">limit</span>: -1</span><br><span class="line">      Processor Tree:</span><br><span class="line">        ListSink</span><br></pre></td></tr></table></figure><p>ä¸Šé¢æ˜¯case3çš„æ‰§è¡Œè®¡åˆ’ï¼Œå¯ä»¥çœ‹å‡ºä¸¤ä¸ªè¡¨åœ¨TableScanæ—¶éƒ½æ˜¯å…¨è¡¨æ‰«æï¼Œæ²¡æœ‰è¿›è¡Œfilterï¼Œåœ¨joinæ—¶æœ‰ä¸ªfilter<code>filter predicates</code>ï¼Œjoinç»“æŸä¹‹ååˆæœ‰ä¸ª<code>Filter Operator</code>å¯¹joinçš„ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚</p><ul><li>case 4ï¼Œsqlå¦‚ä¸‹:<br><code>select t1.*,t2.name as name_t2 from t1 left outer join t2 on (t1.id=t2.id and t1.name=&#39;a&#39; and t2.name=&#39;aa&#39;);</code><br>æ­¤sqlä¸­åªæœ‰joinä¸­è°“è¯ï¼Œæ ¹æ®è§„åˆ™t1.name=â€™aâ€™ä¸èƒ½ä¸‹æ”¾åˆ°t1ä¸­ï¼Œè€Œt2.name=â€™aaâ€™èƒ½å¤Ÿä¸‹æ”¾åˆ°t2ä¸­ï¼Œé‚£å°±æ˜¯è¯´æ‰«t1çš„å…¨è¡¨æ•°æ®ï¼Œç„¶åæ‹¿t1.nameä¸ºaçš„æ•°æ®å»å’Œt2ä¸­t2.nameä¸ºaaçš„æ•°æ®(t2åœ¨table scanæ—¶ä¼šè¿‡æ»¤nameä¸ºaaçš„æ•°æ®)è¿›è¡Œjoinï¼Œé‚£ä¹ˆt1ä¸­nameä¸ä¸ºaçš„æ•°æ®ä¸å’Œt2è¿›è¡Œjoinï¼Œç›´æ¥å°†t2.nameç½®ä¸ºNULLï¼Œè€Œt1ä¸­nameä¸ºaå´æ²¡æœ‰å’Œt2è¿›è¡ŒjoinæˆåŠŸçš„æ•°æ®ä¹Ÿä¸ºNULLï¼Œæ‰€ä»¥å…¶ç»“æœå¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1bNULL</span><br><span class="line">1aaa</span><br><span class="line">2bNULL</span><br><span class="line">2aNULL</span><br><span class="line">3bNULL</span><br><span class="line">3aNULL</span><br><span class="line">4bNULL</span><br></pre></td></tr></table></figure><blockquote><p>è¿™é‡Œéœ€è¦è¯´æ˜ä¸‹ï¼Œt1æ˜¯ä¿ç•™è¡¨ï¼Œjoinä¹‹åè¦è¿”å›å…¶è¡¨ä¸­æ‰€æœ‰çš„æ•°æ®ï¼Œå› ä¸ºåœ¨joinä¹‹åæ²¡æœ‰whereå¯¹å…¶ç»“æœè¿›è¡Œè¿‡æ»¤ï¼Œæ‰€ä»¥æ­¤å¤„æ˜¾ç¤ºçš„æ˜¯t1è¡¨çš„æ‰€æœ‰æ•°æ®ï¼Œä¸Šé¢çš„caseä¹‹æ‰€ä»¥æ²¡æœ‰è¿”å›t1çš„æ‰€æœ‰æ•°æ®æ˜¯å› ä¸ºä»–ä»¬è¦ä¹ˆåœ¨table scanæ—¶è¿›è¡Œäº†è¿‡æ»¤è¦ä¹ˆå°±æ˜¯åœ¨joinä¹‹åé€šè¿‡whereè¿›è¡Œäº†è¿‡æ»¤ã€‚  </p></blockquote><p>ä¸ºäº†éªŒè¯ä¸‹t1ä¸­åªæœ‰é‚£ä¹ˆä¸ºaçš„æ•°æ®ä¸t2è¿›è¡Œäº†joinï¼Œæˆ‘å¯¹t2ä¸­çš„æ•°æ®è¿›è¡Œäº†ä¿®æ”¹ï¼Œæ·»åŠ ä¸€æ¡æ•°æ®<code>4,aa</code>ï¼Œå…¶æ‰§è¡Œç»“æœæŒ‰ç…§ä¸Šé¢çš„é€»è¾‘åº”è¯¥ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå†æ¬¡æ‰§è¡Œcase4ï¼Œçœ‹ä¸‹è¿”å›çš„ç»“æœæ˜¯å¦ä¸€è‡´ã€‚å…¶ç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">1bNULL</span><br><span class="line">1aaa</span><br><span class="line">2bNULL</span><br><span class="line">2aNULL</span><br><span class="line">3bNULL</span><br><span class="line">3aNULL</span><br><span class="line">4bNULL</span><br></pre></td></tr></table></figure><p>ä¸ä¸Šé¢çš„ç»“æœä¸€è‡´ã€‚<br>æ­¤sqlçš„æ‰§è¡Œè®¡åˆ’å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">STAGE DEPENDENCIES:</span><br><span class="line">  Stage-1 is a root stage</span><br><span class="line">  Stage-0 depends on stages: Stage-1</span><br><span class="line"></span><br><span class="line">STAGE PLANS:</span><br><span class="line">  Stage: Stage-1</span><br><span class="line">    Map Reduce</span><br><span class="line">      Map Operator Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t1</span><br><span class="line">            Statistics: Num rows: 1 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Reduce Output Operator</span><br><span class="line">              key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">              sort order: +</span><br><span class="line">              Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t2</span><br><span class="line">            Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Filter Operator</span><br><span class="line">              predicate: (name = <span class="string">&#x27;aa&#x27;</span>) (<span class="built_in">type</span>: boolean)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              Reduce Output Operator</span><br><span class="line">                key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">                sort order: +</span><br><span class="line">                Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">                Statistics: Num rows: 1 Data size: 10 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">                value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">      Reduce Operator Tree:</span><br><span class="line">        Join Operator</span><br><span class="line">          condition map:</span><br><span class="line">               Left Outer Join0 to 1</span><br><span class="line">          filter predicates:</span><br><span class="line">            0 &#123;(VALUE._col0 = <span class="string">&#x27;a&#x27;</span>)&#125;</span><br><span class="line">            1</span><br><span class="line">          keys:</span><br><span class="line">            0 id (<span class="built_in">type</span>: int)</span><br><span class="line">            1 id (<span class="built_in">type</span>: int)</span><br><span class="line">          outputColumnNames: _col0, _col1, _col6</span><br><span class="line">          Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">          Select Operator</span><br><span class="line">            expressions: _col0 (<span class="built_in">type</span>: int), _col1 (<span class="built_in">type</span>: string), _col6 (<span class="built_in">type</span>: string)</span><br><span class="line">            outputColumnNames: _col0, _col1, _col2</span><br><span class="line">            Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            File Output Operator</span><br><span class="line">              compressed: <span class="literal">false</span></span><br><span class="line">              Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              table:</span><br><span class="line">                  input format: org.apache.hadoop.mapred.TextInputFormat</span><br><span class="line">                  output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</span><br><span class="line">                  serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage-0</span><br><span class="line">    Fetch Operator</span><br><span class="line">      <span class="built_in">limit</span>: -1</span><br><span class="line">      Processor Tree:</span><br><span class="line">        ListSink</span><br></pre></td></tr></table></figure><p>è¿™å››ä¸ªcaseä»‹ç»äº†left outer joinçš„æƒ…å†µï¼Œright outer joinä¸leftç±»ä¼¼ï¼Œåªæ˜¯ä¿ç•™è¡¨å’ŒNull Supplying tableæ¢ä¸‹ä½ç½®ï¼Œæ¯”è¾ƒç‰¹æ®Šçš„æ˜¯<strong>full outer join</strong>ï¼Œåœ¨full outer joinä¸­joinä¸­è°“è¯å’Œjoinä¹‹åè°“è¯éƒ½ä¸ä¼šè¢«ä¸‹æ”¾ï¼Œ(<strong>è¿™é‡Œè¯´ä¸ä¼šä¸‹æ”¾å¯èƒ½ä¸å¤ªå‡†å¤‡ï¼Œä¼šä¸‹æ”¾ï¼Œä½†æ˜¯ä¸‹æ”¾çš„ä½ç½®ä¸å¯¹ï¼Œä¸‹æ”¾å‰å’Œä¸‹æ”¾åçš„ä½ç½®æ˜¯ä¸€æ ·çš„ï¼Œå¼€å¯logå¯ä»¥æŸ¥çœ‹ã€‚</strong>)</p><p>ä¸‹æ”¾å‰çš„ä¸ä¸‹æ”¾åçš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">TS[0]-RS[2]-JOIN[4]-FIL[5]-SEL[6]-FS[7]</span><br><span class="line">TS[1]-RS[3]-JOIN[4]</span><br><span class="line"></span><br><span class="line">TS[0]-RS[2]-JOIN[4]-FIL[8]-SEL[6]-FS[7]</span><br><span class="line">TS[1]-RS[3]-JOIN[4]</span><br></pre></td></tr></table></figure><p>å› ä¸ºfull outer joinä¸­çš„ä¸¤ä¸ªè¡¨æ—¢æ˜¯ä¿ç•™è¡¨ä¹Ÿæ˜¯Null Supplying tableã€‚æ¥çœ‹ä¸ªfull outer joinçš„ä¾‹å­ï¼Œ<br><code>select t1.*,t2.name as name_t2 from t1 full outer join t2 on (t1.id=t2.id and t2.name=&#39;aa&#39;) where t1.name=&#39;a&#39;;</code><br>å…¶ç»“æœä¸º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1aaa</span><br><span class="line">2aNULL</span><br><span class="line">3aNULL</span><br></pre></td></tr></table></figure><!--select t1.*,t2.name as name_t2 from t1 full outer join t2 on (t1.id=t2.id and t2.name='aa')1    b    aa1    a    aa2    b    NULL2    a    NULL3    b    NULL3    a    NULL4    b    aaNULL    NULL    dd--><p>å…¶sqlçš„æ‰§è¡Œè®¡åˆ’å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">STAGE PLANS:</span><br><span class="line">  Stage: Stage-1</span><br><span class="line">    Map Reduce</span><br><span class="line">      Map Operator Tree:</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t1</span><br><span class="line">            Statistics: Num rows: 1 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Reduce Output Operator</span><br><span class="line">              key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">              sort order: +</span><br><span class="line">              Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 28 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">          TableScan</span><br><span class="line">            <span class="built_in">alias</span>: t2</span><br><span class="line">            Statistics: Num rows: 1 Data size: 15 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Reduce Output Operator</span><br><span class="line">              key expressions: id (<span class="built_in">type</span>: int)</span><br><span class="line">              sort order: +</span><br><span class="line">              Map-reduce partition columns: id (<span class="built_in">type</span>: int)</span><br><span class="line">              Statistics: Num rows: 1 Data size: 15 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              value expressions: name (<span class="built_in">type</span>: string)</span><br><span class="line">      Reduce Operator Tree:</span><br><span class="line">        Join Operator</span><br><span class="line">          condition map:</span><br><span class="line">               Outer Join 0 to 1</span><br><span class="line">          filter predicates:</span><br><span class="line">            0</span><br><span class="line">            1 &#123;(VALUE._col0 = <span class="string">&#x27;aa&#x27;</span>)&#125;</span><br><span class="line">          keys:</span><br><span class="line">            0 id (<span class="built_in">type</span>: int)</span><br><span class="line">            1 id (<span class="built_in">type</span>: int)</span><br><span class="line">          outputColumnNames: _col0, _col1, _col6</span><br><span class="line">          Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">          Filter Operator</span><br><span class="line">            predicate: (_col1 = <span class="string">&#x27;a&#x27;</span>) (<span class="built_in">type</span>: boolean)</span><br><span class="line">            Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">            Select Operator</span><br><span class="line">              expressions: _col0 (<span class="built_in">type</span>: int), <span class="string">&#x27;a&#x27;</span> (<span class="built_in">type</span>: string), _col6 (<span class="built_in">type</span>: string)</span><br><span class="line">              outputColumnNames: _col0, _col1, _col2</span><br><span class="line">              Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">              File Output Operator</span><br><span class="line">                compressed: <span class="literal">false</span></span><br><span class="line">                Statistics: Num rows: 1 Data size: 30 Basic stats: COMPLETE Column stats: NONE</span><br><span class="line">                table:</span><br><span class="line">                    input format: org.apache.hadoop.mapred.TextInputFormat</span><br><span class="line">                    output format: org.apache.hadoop.hive.ql.io.HiveIgnoreKeyTextOutputFormat</span><br><span class="line">                    serde: org.apache.hadoop.hive.serde2.lazy.LazySimpleSerDe</span><br><span class="line"></span><br><span class="line">  Stage: Stage-0</span><br><span class="line">    Fetch Operator</span><br><span class="line">      <span class="built_in">limit</span>: -1</span><br><span class="line">      Processor Tree:</span><br><span class="line">        ListSink</span><br></pre></td></tr></table></figure><p>ä»æ‰§è¡Œè®¡åˆ’ä¸­å¯ä»¥çœ‹å‡ºt1å’Œt2åœ¨scanæ—¶éƒ½æ²¡æœ‰è¿›è¡Œfilterè¿‡æ»¤ï¼Œä¹Ÿå°±æ˜¯è¯´joinä¸­è°“è¯å’Œjoinä¹‹åçš„è°“è¯éƒ½æ²¡æœ‰è¿›è¡Œä¸‹æ”¾ï¼Œjoinä¸­è°“è¯æ˜¯åœ¨<code>Join Operator</code>æ—¶é€šè¿‡<code>filter predicates</code>è¿›è¡Œè¿‡æ»¤joinï¼Œè€Œjoinä¹‹åè°“è¯æ˜¯åœ¨joinä¹‹åé€šè¿‡<code>Filter Operator</code>è¿›è¡Œè¿‡æ»¤çš„ã€‚</p><p>å¦‚æœt1å’Œt2æŸä¸ªè¡¨æ˜¯åˆ†åŒºè¡¨ï¼Œæ­¤æ—¶æƒ³åªfull outer joinæŸä¸ªåˆ†åŒºçš„æ•°æ®ï¼Œåº”è¯¥æ€ä¹ˆè¿‡æ»¤æ›´é«˜æ•ˆå‘¢ï¼Ÿ<br>æ­¤æ—¶åº”è¯¥ä½¿ç”¨å­æŸ¥è¯¢ï¼Œsqlä¸º<code>select t1.*,t2.name as name_t2 from t1 full outer join t2 on (t1.id=t2.id and t2.name=&#39;aa&#39;)</code></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> t.<span class="operator">*</span>,t2.name <span class="keyword">as</span> name_t2 </span><br><span class="line"><span class="keyword">from</span></span><br><span class="line">    ï¼ˆ<span class="keyword">select</span> <span class="operator">*</span> <span class="keyword">from</span> t1 <span class="keyword">where</span> <span class="keyword">day</span><span class="operator">=</span><span class="string">&#x27;20170411&#x27;</span>) t</span><br><span class="line">     <span class="keyword">full</span> <span class="keyword">outer</span> <span class="keyword">join</span>  t2</span><br><span class="line">     <span class="keyword">on</span> t.id<span class="operator">=</span>t2.id</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ç¯‡æ–‡ç« å…¶å®æƒ³è¯´çš„æœ‰ä¸¤ç‚¹ï¼Œ</p><ol><li>outer joinä¸­è°“è¯çš„ä¸‹æ”¾è§„åˆ™</li><li>join onå’Œwhereçš„åŒºåˆ«ï¼Œä»¥åŠæ‰§è¡Œé¡ºåº</li></ol><p>æ ¹æ®ä¸Šé¢çš„å››ä¸ªcaseæ€»ç»“ä¸‹outer joinä¸­è°“è¯çš„ä¸‹æ”¾è§„åˆ™<br>|  | ä¿ç•™è¡¨ | Null Supplying table |<br>|â€”â€”â€”-|â€”â€”â€”-|â€”â€”â€“|<br>| joinä¸­è°“è¯ | case3å’Œcase4ä¸ä¸‹æ”¾ | case2å’Œcase4ä¸‹æ”¾ |<br>| joinä¹‹åè°“è¯ | case1å’Œcase2ä¸‹æ”¾ | case1å’Œcase3ä¸ä¸‹æ”¾ |</p><p>join onå’Œwhereçš„åŒºåˆ«æ˜¯join onå†³å®šçš„æ˜¯ä»€ä¹ˆæ•°æ®å»è¿›è¡Œjoinæ“ä½œï¼Œç¬¦åˆæ¡ä»¶çš„æ•°æ®æ‰ä¼šè¿›è¡Œjoinï¼Œä¸ç¬¦åˆæ¡ä»¶çš„æ•°æ®ç›´æ¥èµ‹å€¼ä¸ºNULLï¼Œè€Œwhereæ˜¯å¯¹joinä¹‹åçš„ç»“æœè¿›è¡Œè¿‡æ»¤ï¼Œå†³å®šæœ€ç»ˆå±•ç¤ºçš„å†…å®¹ã€‚<br>whereä¸­çš„è°“è¯å¦‚æœæ²¡æœ‰è¢«ä¸‹æ”¾åˆ™åœ¨joinä¹‹åæ‰§è¡Œã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://cwiki.apache.org/confluence/display/Hive/OuterJoinBehavior#OuterJoinBehavior-Examples">Hive Outer Join Behavior</a><br><a href="https://community.mapr.com/docs/DOC-1193">Understanding Hive Outer Join Behavior</a></p><h2 id="é™„åŠ "><a href="#é™„åŠ " class="headerlink" title="é™„åŠ "></a>é™„åŠ </h2><p>hiveå¼€å¯debugçš„æ–¹å¼ï¼š</p><ol><li>å¯åŠ¨hive cliæ—¶ï¼Œæ‰§è¡Œ<code>hive --hiveconf hive.root.logger=DEBUG,console</code></li><li>ä¿®æ”¹hiveçš„log4jæ–‡ä»¶ï¼Œåœ¨${HIVE_HOME}/conf/hive-log4j.propertiesæ–‡ä»¶ä¸­æ‰¾åˆ°hive.root.loggerå±æ€§ï¼Œå¹¶å°†å…¶ä¿®æ”¹ä¸º<code>hive.root.logger=DEBUG,console</code></li></ol>]]></content>
      
      
      <categories>
          
          <category> Hive </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> Hive </tag>
            
            <tag> outer join </tag>
            
            <tag> PredicatePushDown </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>macä¸‹ç¼–è¯‘Hadoop</title>
      <link href="/mac%E4%B8%8B%E7%BC%96%E8%AF%91Hadoop.html"/>
      <url>/mac%E4%B8%8B%E7%BC%96%E8%AF%91Hadoop.html</url>
      
        <content type="html"><![CDATA[<p>ä»¥å‰éƒ½æ˜¯winä¸‹è£…ä¸ªcentosè™šæ‹Ÿæœºç¼–è¯‘hadoopï¼Œæœ€è¿‘æ¢äº†Macï¼Œä¸ç”¨å†è£…è™šæ‹Ÿæœºäº†ï¼Œç›´æ¥ç¼–è¯‘Hadoopï¼Œå¾ˆçˆ½ã€‚ä½†éœ€è¦é…ç½®ä¸‹hadoopçš„ç¼–è¯‘ç¯å¢ƒã€‚åœ¨æ­¤è®°å½•ä¸‹ã€‚</p><span id="more"></span><blockquote><p>findbugså®‰è£…</p></blockquote><p>ä¸‹è½½findbugs-3.0.1.tar.gzï¼Œè§£å‹<code>tar -zvxf findbugs-3.0.1.tar.gz</code>ï¼Œé…ç½®ç¯å¢ƒå˜é‡ã€‚<br>åœ¨<code>.bash_profile</code>ä¸­æ·»åŠ <code>FINDBUGS_HOME</code>ï¼Œå¹¶export</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">FINDBUGS_HOME=/Users/hadoop/soft/findbugs-3.0.1</span><br><span class="line">PATH=<span class="variable">$FINDBUGS_HOME</span>/bin</span><br><span class="line"><span class="built_in">export</span> FINDBUGS_HOME</span><br></pre></td></tr></table></figure><blockquote><p>protobufå®‰è£…</p></blockquote><p>å®‰è£…protobufä¹‹å‰éªŒè¯ä¸‹æ˜¯å¦æœ‰gccï¼Œå‘½ä»¤<code>gcc --version</code><br>è¿›å…¥protobuf-2.5.0ç›®å½•æ‰§è¡Œ<code>./configure --prefix=/Users/hadoop/soft/protobuf-2.5.0</code><br>ç„¶åå®‰è£…å°±å¯ä»¥äº†ï¼Œå‘½ä»¤<code>make &amp;&amp; make install</code><br>ä¸ºäº†ä½¿ç”¨protocå‘½ä»¤æ–¹ä¾¿ï¼Œå°†binç›®å½•æ·»åŠ åˆ°<code>.bash_porfile</code>ä¸­<br><code>PATH=/Users/hadoop/soft/protobuf-2.5.0/bin</code></p><blockquote><p>cmakeå®‰è£…</p></blockquote><p>è§£å‹cmake-3.0.0ï¼Œè¿›å…¥ç›®å½•ä¸­ï¼Œæ‰§è¡Œ<code>./bootstrap --prefix=/Users/hadoop/soft/cmake-3.0.0</code>è¿›è¡Œç¼–è¯‘<br>æ‰§è¡Œ<code>make &amp;&amp; make install</code>è¿›è¡Œ<br>ä¸ºäº†ä½¿ç”¨cmakeå‘½ä»¤æ–¹ä¾¿ï¼Œå°†binç›®å½•æ·»åŠ åˆ°<code>.bash_porfile</code>ä¸­<br><code>PATH=/Users/hadoop/soft/cmake-3.0.0/bin</code></p><p>macç¯å¢ƒä¸­ç”±äºå·²ç»å®‰è£…äº†xcode-selectåˆ™ï¼Œä¸ç”¨é¢å¤–å®‰è£…zlib-devel</p><blockquote><p>openssl-develå®‰è£…</p></blockquote><p>è¿™ä¸ªåœ¨macä¸Šæ²¡æœ‰è¿™ä¸ªä¾èµ–åŒ…ï¼Œåªæ˜¯è£…äº†opensslï¼Œä½†æ˜¯ç¼–è¯‘ä¸è¿‡å»ï¼ŒæŠ¥é”™ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[ERROR] Failed to execute goal org.apache.maven.plugins:maven-antrun-plugin:1.7:run (make) on project hadoop-pipes: An Ant BuildException has occured: <span class="built_in">exec</span> returned: 1</span><br><span class="line">[ERROR] around Ant part ...&lt;<span class="built_in">exec</span> dir=<span class="string">&quot;/Users/hadoop/bigdata/hadoop-2.6.0-src-eclipse/hadoop-tools/hadoop-pipes/target/native&quot;</span> executable=<span class="string">&quot;cmake&quot;</span> failonerror=<span class="string">&quot;true&quot;</span>&gt;... @ 5:141 <span class="keyword">in</span> /Users/hadoop/bigdata/hadoop-2.6.0-src-eclipse/hadoop-tools/hadoop-pipes/target/antrun/build-main.xml</span><br></pre></td></tr></table></figure><p>ç½‘ä¸Šå¤§éƒ¨åˆ†éƒ½è¯´æ˜¯ç¼ºå°‘openssl-develä¾èµ–åŒ…ï¼Œä½†è‹¦é€¼çš„æ˜¯macä¸Šæ²¡æœ‰æ­¤ä¾èµ–åŒ…ï¼Œç„¶åå°±ä¸‹è½½äº†opensslæºç è¿›è¡Œè‡ªç¼–è¯‘å®‰è£…å§ï¼Œå¯æ˜¯å°±æ˜¯ç¼–è¯‘ä¸è¿‡å»ï¼Œä¸‹è½½äº†å„ä¸ªç‰ˆæœ¬çš„opensslå°±æ˜¯æ— æ³•ç¼–è¯‘æˆåŠŸã€‚ç„¶åçœ‹errorä¿¡æ¯ï¼Œè²Œä¼¼æ˜¯å’Œantå’Œcmakeæœ‰å…³ï¼Œhadoopç°åœ¨çš„ç‰ˆæœ¬å·²ç»ä¸ç”¨antäº†å‘€ï¼Œè€Œä¸”contosä¸Šçš„ç¼–è¯‘ç¯å¢ƒä¹Ÿæ²¡æœ‰antå‘€ï¼Œéš¾é“æ˜¯cmakeçš„åŸå› ï¼Ÿé¦–å…ˆæƒ³åˆ°cmakeç‰ˆæœ¬é—®é¢˜ï¼Œæ¢äº†ä¸ªæ–°ç‰ˆä¹Ÿä¸æˆåŠŸï¼Œæœ€åå¿«è¦ç»æœ›æ—¶æœåˆ°äº†<a href="http://stackoverflow.com/questions/36818957/mac-hadoop-2-7-failed-to-execute-goal-org-apache-maven-pluginsmaven-antrun">ä¸€ç¯‡æ–‡ç« </a></p><p><em>ä¸Šé¢è¯´å¯ä»¥å»build-main.xmlä¸­æŸ¥çœ‹å…·ä½“å‡ºé”™çš„è¡Œï¼Œç”¨cmakeå•ç‹¬æ‰§è¡Œä¸‹ï¼Œçœ‹æŠ¥ä»€ä¹ˆé”™</em></p><p>å½“æˆ‘æ‰§è¡Œ<code>cmake /Users/hadoop/bigdata/hadoop-2.6.0-src-eclipse/hadoop-tools/hadoop-pipes/src/ -DJVM_ARCH_DATA_MODEL = 64</code>æ—¶ï¼Œé”™è¯¯ä¿¡æ¯æ˜¾ç¤ºå‡ºæ¥äº†ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Could NOT find OpenSSL, try to <span class="built_in">set</span> the path to OpenSSL root folder <span class="keyword">in</span> the System variable OPENSSL_ROOT_DIR (missing: OPENSSL_INCLUDE_DIR), suggesting that not found openssl suggested that the need to add environment variables</span><br></pre></td></tr></table></figure><p>ç„¶åæˆ‘å°±æŒ‰ç…§æ–‡ç« ä¸­ä»‹ç»çš„å°†<code>OPENSSL_INCLUDE_DIR</code>å’Œ<code>OPENSSL_ROOT_DIR</code>exportå‡ºï¼Œå†æ¬¡ç¼–è¯‘å°±æˆåŠŸäº†ã€‚</p><p>ç”±äºæˆ‘å¹¶ä¸çŸ¥é“macé»˜è®¤çš„opensslçš„å®‰è£…ç›®å½•ï¼Œæ‰€ä»¥æˆ‘ä½¿ç”¨<code>brew install openssl</code>é‡æ–°å®‰è£…äº†ä¸‹ï¼Œå®‰è£…æˆåŠŸä¼šæç¤ºopensslçš„å®‰è£…ç›®å½•</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">brew install openssl</span><br><span class="line">==&gt; Downloading https://homebrew.bintray.com/bottles/openssl-1.0.2k.sierra.bottle.tar.gz</span><br><span class="line">Already downloaded: /Users/netease/Library/Caches/Homebrew/openssl-1.0.2k.sierra.bottle.tar.gz</span><br><span class="line">==&gt; Pouring openssl-1.0.2k.sierra.bottle.tar.gz</span><br><span class="line">==&gt; Using the sandbox</span><br><span class="line">==&gt; Caveats</span><br><span class="line">A CA file has been bootstrapped using certificates from the SystemRoots</span><br><span class="line">keychain. To add additional certificates (e.g. the certificates added <span class="keyword">in</span></span><br><span class="line">the System keychain), place .pem files <span class="keyword">in</span></span><br><span class="line">  /usr/<span class="built_in">local</span>/etc/openssl/certs</span><br><span class="line"></span><br><span class="line">and run</span><br><span class="line">  /usr/<span class="built_in">local</span>/opt/openssl/bin/c_rehash</span><br><span class="line"></span><br><span class="line">This formula is keg-only, <span class="built_in">which</span> means it was not symlinked into /usr/<span class="built_in">local</span>.</span><br><span class="line"></span><br><span class="line">Apple has deprecated use of OpenSSL <span class="keyword">in</span> favor of its own TLS and crypto libraries</span><br><span class="line"></span><br><span class="line">If you need to have this software first <span class="keyword">in</span> your PATH run:</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;/usr/local/opt/openssl/bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br><span class="line"></span><br><span class="line">For compilers to find this software you may need to <span class="built_in">set</span>:</span><br><span class="line">    LDFLAGS:  -L/usr/<span class="built_in">local</span>/opt/openssl/lib</span><br><span class="line">    CPPFLAGS: -I/usr/<span class="built_in">local</span>/opt/openssl/include</span><br><span class="line">For pkg-config to find this software you may need to <span class="built_in">set</span>:</span><br><span class="line">    PKG_CONFIG_PATH: /usr/<span class="built_in">local</span>/opt/openssl/lib/pkgconfig</span><br><span class="line"></span><br><span class="line">==&gt; Summary</span><br><span class="line">ğŸº  /usr/<span class="built_in">local</span>/Cellar/openssl/1.0.2k: 1,696 files, 12MB</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">If you need to have this software first <span class="keyword">in</span> your PATH run:</span><br><span class="line">  <span class="built_in">echo</span> <span class="string">&#x27;export PATH=&quot;/usr/local/opt/openssl/bin:$PATH&quot;&#x27;</span> &gt;&gt; ~/.zshrc</span><br></pre></td></tr></table></figure><!--export OPENSSL_ROOT_DIR=/usr/local/Cellar/openssl/1.0.2kexport OPENSSL_INCLUDE_DIR=/usr/local/Cellar/openssl/1.0.2k/include--><blockquote><p>ç¼–è¯‘hadoop</p></blockquote><p>æ‰€éœ€çš„ä¾èµ–ç»„ä»¶éƒ½å®‰è£…å¥½ä¹‹åå°±å¯ä»¥æ­£ç¡®çš„ç¼–è¯‘hadoopäº†ï¼Œåœ¨hadoop_homeç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤<br><code>mvn clean package -DskipTests -Pdist,native -Dtar  -X</code></p><p>è¿™é‡Œè¿˜æœ‰ä¸ªå°æ’æ›²ï¼Œå°±æ˜¯ä¼šæŠ¥ä¸ªæ‰¾ä¸ç±»çš„é”™ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Exception <span class="keyword">in</span> thread â€œmainâ€ Java.lang.AssertionError: Missing tools.jar at: /Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home/Classes/classes.jar. Expression: file.exists()</span><br></pre></td></tr></table></figure><p>è§£å†³åŠæ³•å°±æ˜¯åœ¨JAVA_HOMEï¼Œä¹Ÿå³/Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Homeè·¯å¾„ä¸‹<em>æ–°å»ºç›®å½•Class</em>ï¼Œå¹¶æ‰§è¡Œåˆ›å»ºè½¯ç¬¦å·é“¾æ¥å‘½ä»¤ï¼š<br><code>sudo ln -s $JAVA_HOME/lib/tools.jar $JAVA_HOME/Classes/classes.jar</code></p><!--ç¼–è¯‘2.6æ—¶åˆ é™¤äº†ä¸€ä¸ªç±»Exception in thread "main" java.lang.AssertionError: Missing tools.jar at: /Library/Java/JavaVirtualMachines/jdk1.7.0_80.jdk/Contents/Home/Classes/classes.jar. Expression: file.exists()-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> build </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>gangliaéƒ¨ç½²ç›‘æ§flume</title>
      <link href="/ganglia%E9%83%A8%E7%BD%B2%E7%9B%91%E6%8E%A7flume.html"/>
      <url>/ganglia%E9%83%A8%E7%BD%B2%E7%9B%91%E6%8E%A7flume.html</url>
      
        <content type="html"><![CDATA[<p>debianç¯å¢ƒä¸‹ç¼–è¯‘éƒ¨ç½²gangliaï¼Œç”¨äºç›‘æ§flumeã€‚</p><h2 id="gangliaç¼–è¯‘éƒ¨ç½²"><a href="#gangliaç¼–è¯‘éƒ¨ç½²" class="headerlink" title="gangliaç¼–è¯‘éƒ¨ç½²"></a>gangliaç¼–è¯‘éƒ¨ç½²</h2><p>gangliaä¸»è¦åŒ…æ‹¬gmondå’Œgmetaï¼Œ</p><ul><li>gmondç”¨äºæ”¶é›†ç›‘æµ‹æ•°æ®ï¼Œå¯ä»¥å‘é€ä¹Ÿå¯ä»¥æ¥æ”¶åœ¨åŒä¸€ä¸ªç»„æ’­æˆ–å•æ’­é€šé“ä¸Šçš„ç»Ÿè®¡ä¿¡æ¯ã€‚gmondæœ‰ä¸¤ä¸ªè§’è‰²ï¼Œä¸€ä¸ªæ˜¯å‘é€è€…ï¼Œå¦ä¸€ä¸ªæ˜¯æ¥æ”¶è€…ã€‚å½“<code>mute=no</code>æ—¶ï¼Œgmondæ˜¯å‘é€è€…ï¼Œä¼šæ”¶é›†æœ¬èŠ‚ç‚¹ä¸Šçš„åŸºæœ¬æŒ‡æ ‡ï¼Œæ¯”å¦‚ç³»ç»Ÿè´Ÿè½½(load_one)ã€cpuå’Œmemoryåˆ©ç”¨ç‡ç­‰ï¼Œä¹Ÿå¯ä»¥å‘é€ç”¨æˆ·é€šè¿‡æ·»åŠ C/Pythonæ¨¡å—æ¥è‡ªå®šä¹‰çš„æŒ‡æ ‡ã€‚å½“<code>deaf=no</code>æ˜¯æ¥æ”¶è€…ï¼Œä¸»è¦ç”¨æ¥èšåˆæ‰€æœ‰ä»åˆ«çš„èŠ‚ç‚¹ä¸Šå‘æ¥çš„æŒ‡æ ‡(å¦‚flume agentå‘æ¥çš„metricsä¿¡æ¯)ï¼Œå¹¶æŠŠä»–ä»¬éƒ½ä¿å­˜åœ¨å†…å­˜ç¼“å†²åŒºä¸­ã€‚<em>gmondèŠ‚ç‚¹ä¹‹é—´é€šè¿‡UDPæ”¶é›†æ•°æ®ï¼Œgmetadé€šè¿‡TCPä»gmondèŠ‚ç‚¹è·å–æ•°æ®</em></li><li>gmetaå®šæœŸæ£€æŸ¥gmondï¼Œæ‹‰å–gmondä¸Šçš„æ•°æ®ï¼Œå¹¶å°†ä»–ä»¬çš„æŒ‡æ ‡å­˜å‚¨åœ¨RRDå­˜å‚¨å¼•æ“ä¸­ã€‚</li></ul><p>é™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸ªwebç»„ä»¶ç”¨äºæ˜¾ç¤ºç›‘æ§å›¾ï¼Œganglia-web(æˆ–è€…ganglia-webfrontend)</p><p>ä¸‹é¢å¼€å§‹ç¼–è¯‘gangliaï¼Œå®˜ç½‘ä¸Šgmondã€gmetaå’Œganglia-webæ˜¯åˆ†å¼€çš„ä¸¤ä¸ªå®‰è£…åŒ…ã€‚gangliaä¸­åªåŒ…æ‹¬gmondå’Œgmetaã€‚</p><span id="more"></span><h3 id="ç¼–è¯‘"><a href="#ç¼–è¯‘" class="headerlink" title="ç¼–è¯‘"></a>ç¼–è¯‘</h3><p><code>apt-get install make gawk gcc g++ pkg-config python-libxml2 libcogl-pango-dev python-dev libxml2-dev libxslt-dev libaprutil1-dev libpcre* libconfuse*</code><br>å¯èƒ½ä¸å…¨ï¼Œä½†ä¹Ÿå·®ä¸å¤šã€‚</p><p>ä¸Šé¢çš„ä¾èµ–åŒ…éƒ½å®‰è£…ä¹‹åè¿˜éœ€è¦<em>confuse</em>å’Œ<em>rrdtool</em>ï¼Œè¿™ä¸¤ä¸ªéœ€è¦ç¼–è¯‘å®‰è£…ï¼Œæ‰€ä»¥å•ç‹¬è¯´æ˜ä¸‹ã€‚</p><p>å®‰è£…confuse</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.savannah.gnu.org/releases/confuse/confuse-2.7.tar.gz</span><br><span class="line">tar -zxvf confuse-2.7.tar.gz </span><br><span class="line"><span class="built_in">cd</span> confuse-2.7 </span><br><span class="line">./configure CFLAGS=-fPIC --disable-nls --prefix=/home/hadoop/confuse-2.7</span><br><span class="line">make &amp;&amp; make install     <span class="comment">#rootç”¨æˆ·æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>å®‰è£…rrdtool</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">wget http://oss.oetiker.ch/rrdtool/pub/rrdtool-1.6.0.tar.gz</span><br><span class="line">./configure --prefix=/usr/<span class="built_in">local</span>   <span class="comment"># è²Œä¼¼å®‰è£…åˆ°åˆ«çš„ç›®å½•ï¼Œéœ€è¦å°†binä¸‹çš„å‘½ä»¤åŠ åˆ°ç¯å¢ƒå˜é‡ä¸­ï¼Œå¦åˆ™åé¢ç¼–è¯‘gangliaä¼šæŠ¥é”™</span></span><br><span class="line">make &amp;&amp; make install     <span class="comment">#rootç”¨æˆ·æ‰§è¡Œ</span></span><br></pre></td></tr></table></figure><p>ä¾èµ–å®‰è£…å®Œæ¯•ï¼Œè¿›å…¥<code>ganglia-3.7.2.tar.gz</code>çš„è§£å‹ç›®å½•ä¸­ï¼Œæ‰§è¡Œç¼–è¯‘å‘½ä»¤</p><p><code>./configure --prefix=/usr/local/ganglia --with-gmetad --with-librrd=/usr/local/lib --sysconfdir=/etc/ganglia --enable-gexec --enable-status</code></p><p><code>--prefix</code>ç”¨äºæŒ‡å®šgangliaç¼–è¯‘ä¹‹åçš„ç›®å½•ï¼Œ<code>--with-gmetad</code>åŒ…å«gmetaç»„ä»¶ï¼Œ<code>--with-librrd=/usr/local/lib</code>åŒ…å«rrdæ•°æ®åº“ï¼Œ<code>--sysconfdir=/etc/ganglia</code>å°†gmetaå’Œgmondçš„é…ç½®æ–‡ä»¶æ”¾åœ¨æ­¤ç›®å½•ã€‚</p><p>æˆåŠŸä¹‹åå°±å¯ä»¥æ‰§è¡Œ<code>make &amp;&amp; make install</code>å®‰è£…gangliaäº†ã€‚</p><blockquote><p>è¿˜éœ€è¦å®‰è£…<code>apt-get install ganglia-modules-linux ganglia-monitor ganglia-monitor-python ganglia-webfrontend libganglia1 libganglia1-dev</code>ï¼Œè¦ä¸ç„¶æ— æ³•æ”¶é›†æœºå™¨çš„åŸºç¡€å±æ€§ï¼Œä¹Ÿä¸èƒ½æ­£å¸¸æ˜¾ç¤ºå›¾ç‰‡(<em>ganglia-webfrontendä¸å®‰è£…æ— æ³•æ­£å¸¸æ˜¾ç¤ºå›¾ç‰‡</em>)ã€‚</p></blockquote><p>ä¸‹é¢æ¥ç¼–è¯‘ganglia-webï¼Œå…¶å®ä¸‹è½½çš„<code>ganglia-web-3.7.2.tar.gz</code>å·²ç»æ˜¯ç¼–è¯‘å¥½çš„ï¼Œç›´æ¥æ‰§è¡Œå®‰è£…å‘½ä»¤(<em>make &amp;&amp; make install</em>)å°±è¡Œäº†ã€‚ä½†æ˜¯ganglia-webéœ€è¦ä¾èµ–apacheä½œä¸ºæœåŠ¡å™¨ï¼Œåˆ™è¿˜éœ€è¦å®‰è£…ä¾èµ–<code>apt-get install apache2.2-bin apache2.2-common apache2 libapache2-mod-php5 php5 </code></p><!--mini-httpd--><blockquote><p>è¿™é‡Œä¹Ÿå¯ä»¥å¯¹ganglia-webçš„å®‰è£…ç›®å½•è¿›è¡Œç¨è®¸çš„é…ç½®ï¼Œé…ç½®åœ¨<em>Makefile</em>ä¸­</p></blockquote><p>ä¸»è¦æ”¹çš„é…ç½®é€‰é¡¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Location where gweb should be installed to (excluding conf, dwoo dirs).</span></span><br><span class="line"><span class="comment"># webé¡µé¢æ–‡ä»¶ï¼Œéœ€è¦æ”¾åœ¨apache webæ–‡ä»¶å¤¹é‡Œ</span></span><br><span class="line">GDESTDIR = /usr/share/ganglia-webfrontend</span><br><span class="line"></span><br><span class="line"><span class="comment"># Location where default apache configuration should be installed to.</span></span><br><span class="line">GCONFDIR = /etc/ganglia-web</span><br><span class="line"></span><br><span class="line"><span class="comment"># Gweb statedir (where conf dir and Dwoo templates dir are stored)</span></span><br><span class="line">GWEB_STATEDIR = /var/lib/ganglia-web</span><br><span class="line"></span><br><span class="line"><span class="comment"># Gmetad rootdir (parent location of rrd folder)</span></span><br><span class="line">GMETAD_ROOTDIR = /var/lib/ganglia</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„ç›®å½•é…ç½®çš„æœ‰ç‚¹æ•£ï¼Œå¯ä»¥å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼Œä½¿å…¶ä¾¿äºç®¡ç†ï¼Œä¿®æ”¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">GDESTDIR = /var/lib/ganglia/web</span><br><span class="line"></span><br><span class="line"><span class="comment"># Location where default apache configuration should be installed to.</span></span><br><span class="line">GCONFDIR = /var/lib/ganglia/etc/</span><br><span class="line"><span class="comment">#GCONFDIR = /etc/ganglia-web</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Gweb statedir (where conf dir and Dwoo templates dir are stored)</span></span><br><span class="line">GWEB_STATEDIR = var/lib/ganglia</span><br><span class="line"></span><br><span class="line"><span class="comment"># Gmetad rootdir (parent location of rrd folder)</span></span><br><span class="line">GMETAD_ROOTDIR = /var/lib/ganglia</span><br><span class="line"><span class="comment"># å¯æ”¹å¯ä¸æ”¹ï¼Œé»˜è®¤æ˜¯www-data</span></span><br><span class="line">APACHE_USER = hadoop_portal</span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥é€‰æ‹©<code>/var/lib/ganglia</code>è¿™ä¸ªç›®å½•ï¼Œæ˜¯å› ä¸º<em>rrd</em>åœ¨æ­¤ç›®å½•ä¸­ã€‚<strong>å¦‚æœä½ ç”¨çš„ç‰ˆæœ¬å’Œæˆ‘ä¸€æ ·ï¼Œå¯èƒ½ä¼šé‡åˆ°ä¸ªå°bugï¼Œå°†GDESTDIRå’ŒGWEB_STATEDIRè·¯å¾„ä¸­çš„ç¬¬ä¸€ä¸ª/å»æ‰</strong></p><h3 id="éƒ¨ç½²"><a href="#éƒ¨ç½²" class="headerlink" title="éƒ¨ç½²"></a>éƒ¨ç½²</h3><p>éƒ¨ç½²æ¯”è¾ƒç®€å•ï¼Œä¿®æ”¹ä¸¤ä¸ªé…ç½®æ–‡ä»¶å°±è¡Œï¼Œåˆ†åˆ«æ˜¯gmond.confå’Œgmeta.confï¼Œåœ¨ç›®å½•<code>/etc/ganglia</code>(æ­¤è·¯å¾„æ˜¯åœ¨ç¼–è¯‘gangliaæ—¶æŒ‡å®šçš„)ä¸­ã€‚</p><p>gmeta.confä¸­åªéœ€æ·»åŠ æ•°æ®æºå’ŒgmodèŠ‚ç‚¹å°±å¯ä»¥äº†ï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># è¯´æ˜ï¼šè¿™é‡Œçš„ &quot;flume&quot; è¡¨ç¤ºçš„æ˜¯é›†ç¾¤çš„åç§°ï¼Œä¸gmodä¸­çš„clusteråå­—ä¸€æ ·ï¼Œåé¢çš„å†…å®¹æ˜¯è¿™ä¸ªé›†ç¾¤ä¸­æ‰€åŒ…å«çš„ä¸»æœºä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯è¦ç›‘æ§çš„ä¸»æœºip</span></span><br><span class="line"><span class="comment"># è¿™é‡Œé‡‡ç”¨å•æ’­æ–¹å¼ï¼Œåˆ™åªæœ‰ä¸€ä¸ªèŠ‚ç‚¹ï¼Œå¹¶é…ä¸Šç«¯å£ï¼Œå¦‚æœä¸æŒ‡å®šç«¯å£ï¼Œé»˜è®¤æ˜¯8649</span></span><br><span class="line">data_source <span class="string">&quot;flume&quot;</span> 127.0.0.1:8666</span><br><span class="line"><span class="comment"># ç”±äºsetuidé»˜è®¤æ˜¯å¼€å¯çš„ï¼Œè€Œsetuid_usernameé»˜è®¤æ˜¯nobodyï¼Œå¯èƒ½ä¼šé‡åˆ°æƒé™é—®é¢˜ï¼Œåˆ™æ”¹ä¸ºå¯åŠ¨ç”¨æˆ·hadoop</span></span><br><span class="line">setuid_username <span class="string">&quot;hadoop&quot;</span></span><br></pre></td></tr></table></figure><p>å¯åŠ¨ä¹‹å‰éœ€è¦æ”¹ä¸‹rrdæ‰€åœ¨ç›®å½•çš„æƒé™ï¼Œæ”¹ä¸ºå¯åŠ¨gmetaçš„ç”¨æˆ·ï¼Œå‘½ä»¤<code>chown -R hadoop:hadoop /var/lib/ganglia</code>(å¦‚æœrrdsç›®å½•ä¸å­˜åœ¨ï¼Œåˆ™æ–°å»º/var/lib/ganglia/rrdsç›®å½•)</p><p>ç°åœ¨å°±å¯ä»¥å¯åŠ¨gmetaäº†ï¼Œå‘½ä»¤<code>/usr/local/ganglia/sbin/gmetad start</code>ã€‚(/usr/local/ganglia/æ˜¯åœ¨ç¼–è¯‘æ—¶ç”±â€“prefix=æŒ‡å®šçš„)</p><p>ç„¶åé€šè¿‡<code>ps -ef | grep gm</code>æŸ¥çœ‹æ˜¯å¦æœ‰gmetaè¿›ç¨‹ï¼Œå¦‚æœæ²¡æœ‰å°±ä»£è¡¨æ²¡æœ‰å¯åŠ¨æˆåŠŸï¼Œå¯ä»¥ä½¿ç”¨<code>gmetad --debug=4</code>(æˆ–è€…gmeta debug=10 log message)è¿›æ¥debugå¯åŠ¨ã€‚</p><p>gmond.confæ–‡ä»¶ä¿®æ”¹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">globals &#123;</span><br><span class="line">  daemonize = yes</span><br><span class="line">  setuid = yes</span><br><span class="line">  <span class="comment"># ä¸gmetaä¸­setuid_usernameç›¸åŒï¼Œå¯åŠ¨gmondçš„ç”¨æˆ·</span></span><br><span class="line">  user = hadoop</span><br><span class="line">  debug_level = 0</span><br><span class="line">  max_udp_msg_len = 1472</span><br><span class="line">  <span class="comment"># å‘é€è€…å¼€å…³</span></span><br><span class="line">  mute = no</span><br><span class="line">  <span class="comment"># æ¥æ”¶è€…å¼€å…³</span></span><br><span class="line">  deaf = no</span><br><span class="line">  host_dmax = 0 /*secs */</span><br><span class="line">  cleanup_threshold = 300 /*secs */</span><br><span class="line">  gexec = no</span><br><span class="line">  send_metadata_interval = 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">cluster &#123;</span><br><span class="line">  <span class="comment"># gmetaä¸­data_sourceä¸­çš„clusteråå­—</span></span><br><span class="line">  name = <span class="string">&quot;flume&quot;</span></span><br><span class="line">  owner = <span class="string">&quot;unspecified&quot;</span></span><br><span class="line">  latlong = <span class="string">&quot;unspecified&quot;</span></span><br><span class="line">  url = <span class="string">&quot;unspecified&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#å‘é€è€…channel</span></span><br><span class="line"><span class="comment"># å¦‚æœä¸ç”¨ç›‘è§†æœ¬èŠ‚ç‚¹åŸºç¡€æŒ‡æ ‡åˆ™ä¸ç”¨é…ç½®ï¼Œå¹¶è®¾ç½®muteä¸ºyes</span></span><br><span class="line">udp_send_channel &#123;</span><br><span class="line">  <span class="comment"># å¤šæ’­æ–¹å¼</span></span><br><span class="line">  /*mcast_join = 239.2.11.71 */</span><br><span class="line">  host = 127.0.0.1</span><br><span class="line">  port = 8666</span><br><span class="line">  ttl = 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment"># æ¥æ”¶è€…channel</span></span><br><span class="line">udp_recv_channel &#123;</span><br><span class="line">  /* mcast_join = 239.2.11.71 */</span><br><span class="line">  port = 8666</span><br><span class="line">  <span class="built_in">bind</span> = 127.0.0.1</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">tcp_accept_channel &#123;</span><br><span class="line">  port = 8666</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯åŠ¨gmondï¼Œå‘½ä»¤<code>/usr/local/ganglia/sbin/gmond start</code>ï¼Œæ²¡æœ‰å¯åŠ¨åˆ™ç”¨ä¸Šé¢ä»‹ç»çš„debugæ¨¡å¼å¯åŠ¨ï¼ŒæŸ¥æ‰¾é”™è¯¯åŸå› ã€‚</p><p>æœ€åå°±æ˜¯å¯åŠ¨ganglia-webï¼Œè¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œåªéœ€è¦å°†<em>GDESTDIR</em>æ‰€æŒ‡å®šçš„ç›®å½•æ”¾åˆ°<code>/var/www</code>ç›®å½•ä¸­å°±å¯ä»¥äº†ã€‚æˆ‘åœ¨è¿™å»ºäº†ä¸ªè½¯è¿<code>cd /var/www/ &amp;&amp; ln -s /usr/share/ganglia-webfrontend ganglia</code></p><p>å¯åŠ¨apacheå°±å¯ä»¥è®¿é—®äº†ï¼Œapacheå¯åŠ¨å‘½ä»¤<code>apache2ctl -k start</code></p><!-- æŸ¥çœ‹apacheç›‘å¬å“ªä¸ªç«¯å£ netstat -lnp |grep apache --><p>è¾“å…¥<code>127.0.0.1/ganglia</code>å°±å¯ä»¥æŸ¥çœ‹ç›‘æ§æŒ‡æ ‡äº†ã€‚</p><p>å¦‚æœæœåŠ¡å™¨åœ¨æœ¬åœ°ä¸èƒ½è®¿é—®ï¼Œå¯ä»¥ä½¿ç”¨<code>telnet localhost 8651</code>æ¥éªŒè¯ä¸‹gmetaæ˜¯å¦æˆåŠŸ(gmetaé»˜è®¤æ˜¯8651ç«¯å£)ã€‚</p><blockquote><p>æ›´æ”¹Apacheçš„é»˜è®¤ç«¯å£</p></blockquote><p>åœ¨debianç³»ç»Ÿä¸‹apacheé»˜è®¤å®‰è£…ç›®å½•æ˜¯<code>/etc/apache2/</code><br>æ›´æ”¹é»˜è®¤ç«¯å£éœ€è¦ä¿®æ”¹ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œåˆ†åˆ«ä¸º<code>/etc/apache2/ports.conf</code>å’Œ<code>/etc/apache2/sites-available/default</code></p><p>æ›´æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#ports.conf</span></span><br><span class="line">NameVirtualHost *:8001</span><br><span class="line">Listen 8001</span><br><span class="line"><span class="comment">#default</span></span><br><span class="line">VirtualHost *:8001</span><br></pre></td></tr></table></figure><p>ç„¶åé‡å¯å°±okäº†ã€‚å¯ä»¥ä½¿ç”¨å‘½ä»¤<code>netstat -lnp |grep apache</code>æŸ¥çœ‹é…ç½®æ˜¯å¦ç”Ÿæ•ˆã€‚æ˜¾ç¤ºå†…å®¹å¦‚ä¸‹åˆ™è¡¨ç¤ºç”Ÿæ•ˆ<br><code>tcp6       0      0 :::8001                 :::*                    LISTEN      8647/apache2</code></p><!--### é˜²ç«å¢™è½¬æ¥å£è¦å¤–ç½‘å¯ä»¥è®¿é—®è¿˜éœ€è¦ç»™é˜²ç«å¢™å¼€ä¸ª80ç«¯å£ï¼Œ/sbin/iptables -L --line-numberiptables -I net2fw 15 -p tcp --dport 80 -j ACCEPTiptables-saveiptables restart--><h2 id="flume-ç›‘æ§"><a href="#flume-ç›‘æ§" class="headerlink" title="flume ç›‘æ§"></a>flume ç›‘æ§</h2><p>ä½¿ç”¨gangliaç›‘æ§flumeè¾ƒä¸ºç®€å•ï¼Œåªè¦åœ¨å¯åŠ¨agentæ—¶æŒ‡å®šgangliaä¸­gmondçš„åœ°å€å’Œç«¯å£å°±okäº†ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š<br><code>/bin/bash $&#123;FLUME_PATH&#125;/bin/flume-ng agent -n a1 -c $&#123;FLUME_PATH&#125;/conf -f $&#123;FLUME_PATH&#125;/conf/flume.conf -Dflume.monitoring.type=ganglia -Dflume.monitoring.hosts=127.0.0.1:8666 &amp;</code></p>]]></content>
      
      
      <categories>
          
          <category> Flume </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Flume </tag>
            
            <tag> ganglia </tag>
            
            <tag> debian </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å•ä¾‹æ¨¡å¼å¼•å‘çš„æ€è€ƒ</title>
      <link href="/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83.html"/>
      <url>/%E5%8D%95%E4%BE%8B%E6%A8%A1%E5%BC%8F%E5%BC%95%E5%8F%91%E7%9A%84%E6%80%9D%E8%80%83.html</url>
      
        <content type="html"><![CDATA[<p>å•ä¾‹æ˜¯ä¸ªè€ç”Ÿå¸¸è°ˆçš„è¯é¢˜ï¼Œæœ‰å¾ˆå¤šç§å†™æ³•ï¼Œæ¯ä¸€ç§å†™èµ·æ¥ä»£ç éƒ½æ¯”è¾ƒç®€å•ï¼Œä½†æ˜¯æ¯ä¸€ç§èƒŒåè•´å«çš„çŸ¥è¯†å¯è°“æ˜¯ä¸€å±‚å¥—ä¸€å±‚ï¼Œå¥—è·¯å¾ˆæ·±å‘€ã€‚ã€‚ã€‚</p><p>æœ¬ç¯‡ä¸»è¦æ˜¯è®°å½•ä¸‹æˆ‘å¯¹å•ä¾‹çš„ç†è§£ã€‚</p><p>ç†Ÿæ‚‰å•ä¾‹çš„äººéƒ½çŸ¥é“å•ä¾‹ä¸€èˆ¬ä¼šæœ‰äº”ç§å†™æ³•ï¼Œåˆ†åˆ«ä¸º<em>æ‡’æ±‰æ³•(çº¿ç¨‹éå®‰å…¨)ã€çº¿ç¨‹å®‰å…¨çš„æ‡’æ±‰æ³•ã€é¥¿æ±‰æ³•ã€å†…éƒ¨ç±»æ³•å’Œæšä¸¾æ³•</em>ã€‚</p><span id="more"></span><h2 id="é¥¿æ±‰æ³•"><a href="#é¥¿æ±‰æ³•" class="headerlink" title="é¥¿æ±‰æ³•"></a>é¥¿æ±‰æ³•</h2><p>å…ˆè¯´ä¸ªintellij ideaä¸­å•ä¾‹æ¨¡æ¿ä»£ç (é¥¿æ±‰æ³•)ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonStatic</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonStatic singletonStatic = <span class="keyword">new</span> SingletonStatic();</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonStatic <span class="title">getSingletonThink</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">return</span> singletonStatic;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonStatic</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;construct function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>IDEä¸­æ¨èçš„æ˜¯é¥¿æ±‰æ³•ï¼Œä»£ç æ˜¯ä¸æ˜¯å¾ˆç®€å•ã€‚åˆ«çœ‹ä»£ç ç®€å•ï¼Œä½†åŠŸèƒ½é½å…¨ï¼Œæ­¤ä»£ç æ˜¯<strong>çº¿ç¨‹å®‰å…¨</strong>çš„ã€‚</p><blockquote><p>çº¿ç¨‹å®‰å…¨æ˜¯ä»€ä¹ˆï¼Ÿ<br>çº¿ç¨‹å®‰å…¨æ˜¯æŒ‡åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå½“å¤šæ¡è¯­å¥åœ¨æ“ä½œåŒä¸€ä¸ªçº¿ç¨‹çš„å…±äº«æ•°æ®æ—¶ï¼Œä¸€ä¸ªçº¿ç¨‹å¯¹å¤šæ¡è¯­å¥åªæ‰§è¡Œäº†ä¸€éƒ¨åˆ†ï¼Œè¿˜æ²¡æ‰§è¡Œå®Œï¼Œå¦ä¸€ä¸ªçº¿ç¨‹å‚ä¸è¿›æ¥æ‰§è¡Œï¼Œå¯¼è‡´å…±äº«æ•°æ®å‡ºé”™ã€‚<br>è§£å†³æ–¹æ³•ï¼šä¿è¯å¤šæ¡å…±äº«æ•°æ®çš„è¯­å¥ï¼Œåœ¨ä¸€ä¸ªçº¿ç¨‹å®Œå…¨æ‰§è¡Œå®Œä¹‹å‰ï¼Œå…¶ä»–çº¿ç¨‹ä¸å‚ä¸æ‰§è¡Œè¿‡ç¨‹ï¼Œä¹Ÿå°±æ˜¯åŠ é”æˆ–è€…å«åŒæ­¥ã€‚</p></blockquote><p>æ­¤æ–¹å¼çš„çº¿ç¨‹å®‰å…¨æ˜¯ä¾èµ–<strong>ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–</strong>å®ç°çš„ã€‚</p><blockquote><p>ç±»åŠ è½½ä¸åˆå§‹åŒ–<br><strong>ä¸€ä¸ªç±»åœ¨JVMä¸­è¢«å®ä¾‹åŒ–æˆä¸€ä¸ªå¯¹è±¡ï¼Œéœ€è¦ç»å†ä¸‰ä¸ªè¿‡ç¨‹ï¼šåŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–</strong>ã€‚</p></blockquote><ul><li><em>åŠ è½½</em>  ç±»åœ¨jvmä¸­çš„åŠ è½½éƒ½æ˜¯<em>åŠ¨æ€åŠ è½½</em>çš„ï¼Œåœ¨è¢«_é¦–æ¬¡è°ƒç”¨_æ—¶åŠ è½½åˆ°jvmä¸­ï¼Œç”±ç±»åŠ è½½å™¨å°†<code>.class</code>æ–‡ä»¶åŠ è½½jvmä¸­ã€‚</li><li><em>é“¾æ¥</em>  é“¾æ¥ç®€å•åœ°è¯´ï¼Œå°±æ˜¯å°†å·²ç»åŠ è½½çš„<code>.class</code>ç»„åˆåˆ°JVMè¿è¡ŒçŠ¶æ€ä¸­å»ã€‚åŒ…æ‹¬_éªŒè¯ã€å‡†å¤‡å’Œè§£æ_</li><li><em>åˆå§‹åŒ–</em>  æ‰§è¡Œç±»çš„staticå—å’Œåˆå§‹åŒ–ç±»å†…éƒ¨çš„é™æ€å±æ€§(<strong>staticå—å’Œé™æ€å±æ€§æ˜¯æŒ‰ç…§å£°æ˜çš„é¡ºåºåˆå§‹åŒ–çš„ï¼Œä¸”ä»…æ‰§è¡Œä¸€æ¬¡</strong>)ï¼Œç„¶åæ˜¯ç±»å†…éƒ¨å±æ€§ï¼Œæœ€åæ˜¯ç±»æ„é€ æ–¹æ³•ã€‚</li></ul><!-- ç±»å®ä¾‹åŒ–çš„å¯¹è±¡é€šè¿‡newæ“ä½œåˆ›å»ºï¼ŒJavaè™šæ‹Ÿæœºä¿è¯ä¸€ä¸ªç±»åœ¨newæ“ä½œå®ä¾‹åŒ–å…¶å¯¹è±¡ä¹‹å‰å·²ç»å®Œæˆäº†ç±»çš„åŠ è½½ã€é“¾æ¥å’Œåˆå§‹åŒ–ã€‚ä¹‹åJavaè™šæ‹Ÿæœºä¼šè°ƒç”¨<init>æ–¹æ³•å®Œæˆç±»å®ä¾‹åŒ–å¯¹è±¡çš„åˆå§‹åŒ–ã€‚è¿™ä¸ªæ–¹æ³•ä¼šä¼˜å…ˆæŒ‰ç…§ä»£ç ä¸­é¡ºåºå®Œæˆå¯¹ç±»å†…éƒ¨ä¸ªå±æ€§çš„åˆå§‹åŒ–ï¼Œä¹‹åå†è°ƒç”¨ç±»çš„æ„é€ å‡½æ•°ï¼ˆå¦‚æœæœ‰çˆ¶ç±»ï¼Œåˆ™ä¼˜å…ˆè°ƒç”¨çˆ¶ç±»çš„æ„é€ å‡½æ•°ï¼‰ã€‚ --><p>æ˜ç™½äº†ç±»çš„åŠ è½½å’Œåˆå§‹åŒ–å†çœ‹ä¸Šé¢çš„ä»£ç æ˜¯ä¸æ˜¯æ„Ÿè§‰æœ‰ç‚¹æ„Ÿè§‰äº†ã€‚</p><p>å½“<code>SingletonStatic.getSingletonThink()</code>åœ¨jvmä¸­è¢«ç¬¬ä¸€æ¬¡è°ƒç”¨æ—¶ï¼Œ<code>SingletonStatic.class</code>è¢«åŠ è½½åˆ°jvmä¸­ï¼Œç„¶åè¿›è¡Œåˆå§‹åŒ–ï¼Œç”±äº<code>singletonStatic</code>æ˜¯é™æ€å±æ€§ï¼Œåˆ™å…ˆè¢«åˆå§‹åŒ–ï¼Œæ­¤æ—¶singletonStaticå°±è¢«å®ä¾‹åŒ–ï¼Œé€šè¿‡getSingletonThinkè¿”å›ã€‚</p><p>åœ¨å¤šçº¿ç¨‹ä¸­ï¼Œå‡å¦‚thread1è°ƒç”¨<code>SingletonStatic.getSingletonThink()</code>ï¼Œåœ¨å…¶æœªè¿”å›æ—¶ï¼Œthread2ä¹Ÿè°ƒç”¨<code>SingletonStatic.getSingletonThink()</code>ï¼Œæ­¤æ—¶ï¼Œå› ä¸ºthread1å…ˆè°ƒç”¨<code>SingletonStatic</code>ï¼Œè¢«åŠ è½½åˆ°jvmä¸­ï¼Œåˆå§‹åŒ–ä¹‹å<code>singletonStatic</code>è¢«å®ä¾‹åŒ–ï¼Œæ­¤åˆ»thread2ä¹Ÿè°ƒç”¨<code>SingletonStatic.getSingletonThink()</code>ï¼Œjvmå‘ç°<code>SingletonStatic</code>å·²è¢«åŠ è½½ï¼Œå¹¶ä¸”<code>singletonStatic</code>æ˜¯é™æ€å±æ€§ï¼Œåªèƒ½è¢«åˆå§‹åŒ–ä¸€æ¬¡å¹¶ä¸”å·²åœ¨thread1è°ƒç”¨æ—¶è¢«åˆå§‹åŒ–ï¼Œåˆ™thread2è°ƒç”¨æ—¶å¹¶ä¸ä¼šå¯¹singletonStaticè¿›è¡Œå†æ¬¡åˆå§‹åŒ–ï¼Œthread1å’Œthread2ä½¿ç”¨çš„singletonStaticå¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨ã€‚</p><p>ä»£ç éªŒè¯å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName());</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                   SingletonStatic.getSingletonThink(Thread.currentThread().getName());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName());</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                   SingletonStatic.getSingletonThink(Thread.currentThread().getName());</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread-1</span><br><span class="line">Thread-0</span><br><span class="line">construct <span class="keyword">function</span></span><br><span class="line">Thread-1 invoke</span><br><span class="line">Thread-0 invoke</span><br></pre></td></tr></table></figure><p>å…¶ç»“æœæ˜¾ç¤ºæ„é€ æ–¹æ³•åªè¢«è°ƒç”¨äº†ä¸€æ¬¡ï¼Œä¹Ÿå°±æ˜¯è¯´singletonStaticè¢«åˆå§‹åŒ–äº†ä¸€æ¬¡ã€‚</p><h2 id="æ‡’æ±‰å¼"><a href="#æ‡’æ±‰å¼" class="headerlink" title="æ‡’æ±‰å¼"></a>æ‡’æ±‰å¼</h2><p>ä¸Šé¢çš„ä»£ç çŸ­å°ç²¾æ‚ï¼Œä½†å…¶æ˜¯é¥¿æ±‰å¼çš„ï¼Œå•ä¾‹singletonStaticä¼šåœ¨åŠ è½½SingletonStaticç±»ä¸€å¼€å§‹å°±è¢«åˆå§‹åŒ–ï¼Œå³ä½¿å®¢æˆ·ç«¯æ²¡æœ‰è°ƒç”¨getSingletonThink()æ–¹æ³•ï¼Œä¹Ÿä¼šè¢«åˆå§‹åŒ–ï¼Œè¿™å°±æœ‰ç‚¹ä¸å¤ªé«˜æ•ˆã€‚å…¶å®æˆ‘ä»¬æ˜¯æƒ³åœ¨ç”¨çš„æ—¶å€™æ‰åŠ è½½ï¼Œä¸‹é¢å°±è¯´ä¸‹æ‡’æ±‰å¼ã€‚</p><p>æ‡’æ±‰å¼ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonLazy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonLazy singletonLazy ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonLazy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;construct function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonLazy <span class="title">getSingletonLazy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (singletonLazy == <span class="keyword">null</span>)&#123;</span><br><span class="line">           singletonLazy = <span class="keyword">new</span> SingletonLazy();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singletonLazy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¹ŸæŒºçŸ­çš„å•Šã€‚é¥¿æ±‰å¼æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œé‚£æˆ‘ä»¬ä¹Ÿæ¥ä¸ªå¤šçº¿ç¨‹æ¥æµ‹è¯•ä¸‹ï¼Œå®ƒæ˜¯å¦å®‰å…¨ã€‚æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MainThread</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread thread1 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName());</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                   SingletonLazy.getSingletonLazy();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line">        Thread thread2 = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName());</span><br><span class="line">                    Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">                   SingletonLazy.getSingletonLazy();</span><br><span class="line">                &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        thread1.start();</span><br><span class="line">        thread2.start();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç»“æœå¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Thread-0</span><br><span class="line">Thread-1</span><br><span class="line">construct <span class="keyword">function</span></span><br><span class="line">construct <span class="keyword">function</span></span><br></pre></td></tr></table></figure><p>æ„é€ æ–¹æ³•è¢«è°ƒç”¨äº†ä¸¤æ¬¡ï¼Œéçº¿ç¨‹å®‰å…¨ã€‚é‚£ä¹ˆå¯ä»¥åŠ é”æ¥å®ç°çº¿ç¨‹å®‰å…¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonLazy</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> SingletonLazy singletonLazy ;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonLazy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;construct function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonLazy <span class="title">getSingletonLazy</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (SingletonLazy.class)&#123;</span><br><span class="line">            <span class="keyword">if</span> (singletonLazy == <span class="keyword">null</span>)&#123;</span><br><span class="line">                singletonLazy = <span class="keyword">new</span> SingletonLazy();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> singletonLazy;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™æ ·èƒ½ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œä½†æ˜¯åœ¨æ¯æ¬¡è°ƒç”¨<code>getSingletonLazy</code>æ—¶ï¼Œéƒ½ä¼šåŠ ä¸ªé”å»åˆ¤æ–­singletonLazyæ˜¯å¦ä¸ºnullï¼Œæœ‰ç‚¹ä¸é«˜æ•ˆå‘€ã€‚</p><p>ä½ è¯´æ¯æ¬¡åˆ¤æ–­æ˜¯å¦ä¸ºnulléƒ½åŠ é”ï¼Œä¸é«˜æ•ˆï¼Œé‚£å°±æŠŠsynchronizedæ”¾åˆ°ifé‡Œé¢ï¼Œè¿™æ ·å°±ä¸ç”¨æ¯æ¬¡å¤šåŠ é”å»åˆ¤æ–­æ˜¯å¦ä¸ºnulläº†ï¼Œä½†æ˜¯è¿™æ ·å¹¶ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œæœ‰å¯èƒ½thread1å’Œthread2åŒæ—¶åˆ¤æ–­singletonLazyä¸ºnullï¼Œç„¶ååˆ†åˆ«å¯¹singletonLazyè¿›è¡Œå®ä¾‹åŒ–ã€‚</p><p>è¿˜æœ‰ä¸€ç§æ–¹æ³•æ˜¯åœ¨synchronizedå¤–é¢å†åŠ ä¸ªifåˆ¤æ–­è¯­å¥ï¼Œè¿™æ ·æ¯æ¬¡åˆ¤æ–­singletonLazyæ˜¯å¦ä¸ºnullå°±ä¸ç”¨åŠ é”äº†ï¼Œè€Œä¸”å½“thread1å’Œthread2åŒæ—¶åˆ¤æ–­singletonLazyä¸ºnullï¼Œè€Œè¿›å»æœ€å¤–å±‚çš„ifè¯­å¥æ—¶ï¼Œå½“thread1æ‹¿åˆ°é”ä¹‹åï¼Œä¼šå†æ¬¡åˆ¤æ–­æ­¤æ—¶singletonLazyæ˜¯å¦ä¾ç„¶ä¸ºnullï¼Œä¸ºnullåˆ™è¿›è¡Œå®ä¾‹åŒ–ï¼Œå¾…singletonLazyå®ä¾‹åŒ–ä¹‹åï¼Œé‡Šæ”¾é”ï¼Œthread2æ‹¿åˆ°é”ï¼Œåˆ¤æ–­singletonLazyæ˜¯å¦ä¸ºnullï¼ŒsingletonLazyå·²åœ¨thread1ä¸­è¢«å®ä¾‹åŒ–ï¼Œénullï¼Œåˆ™åœ¨thread2ä¸­ä¸ä¼šè¿›è¡Œå®ä¾‹åŒ–ï¼Œæ‰€ä»¥çº¿ç¨‹å®‰å…¨äº†ã€‚æ­¤ç§æ–¹æ³•ä¹Ÿå«<strong>åŒé‡æ ¡éªŒé”</strong>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonLazy <span class="title">getSingletonLazy</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (singletonLazy == <span class="keyword">null</span>)&#123;</span><br><span class="line">       <span class="keyword">synchronized</span> (SingletonLazy.class)&#123;</span><br><span class="line">           <span class="keyword">if</span> (singletonLazy == <span class="keyword">null</span>)&#123;</span><br><span class="line">               singletonLazy = <span class="keyword">new</span> SingletonLazy();</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> singletonLazy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±ä¸‡äº‹å¤§å‰äº†å—ï¼Ÿéä¹Ÿï¼</p><p><code>singletonLazy = new SingletonLazy();</code>è¿™å¥è¯­ä¹‰å¹¶ä¸æ˜¯ä¸€ä¸ªåŸå­æ“ä½œï¼Œå¤§æ¦‚åŒ…æ‹¬3ä»¶äº‹ï¼Œåˆ†åˆ«ä¸ºï¼š</p><ol><li>ç»™singletonLazyåˆ†é…å†…å­˜</li><li>è°ƒç”¨singletonLazyçš„æ„é€ å‡½æ•°æ¥åˆå§‹åŒ–æˆå‘˜å˜é‡</li><li>å°†singletonLazyå¯¹è±¡æŒ‡å‘åˆ†é…çš„å†…å­˜ç©ºé—´(<em>æ‰§è¡Œå®Œè¿™æ­¥singletonLazyå°±ä¸ºénulläº†</em>)</li></ol><p>ä½†æ˜¯åœ¨JVMçš„å³æ—¶ç¼–è¯‘å™¨ä¸­å­˜åœ¨<strong>æŒ‡ä»¤é‡æ’åº</strong>çš„ä¼˜åŒ–ã€‚ä¹Ÿå°±æ˜¯è¯´ä¸Šé¢çš„ç¬¬äºŒæ­¥å’Œç¬¬ä¸‰æ­¥çš„é¡ºåºæ˜¯ä¸èƒ½ä¿è¯çš„ï¼Œæœ€ç»ˆçš„æ‰§è¡Œé¡ºåºå¯èƒ½æ˜¯1-2-3ä¹Ÿå¯èƒ½æ˜¯1-3-2ã€‚å¦‚æœæ˜¯åè€…ï¼Œåˆ™thread1åœ¨3æ‰§è¡Œå®Œæ¯•ã€2 æœªæ‰§è¡Œä¹‹å‰ï¼Œè¢«thread2æŠ¢å äº†ï¼Œè¿™æ—¶singletonLazyå·²ç»æ˜¯énulläº†(ä½†å´æ²¡æœ‰åˆå§‹åŒ–)ï¼Œæ‰€ä»¥thread2ä¼šç›´æ¥è¿”å›singletonLazyï¼Œç„¶åä½¿ç”¨ï¼Œä½†æ­¤æ—¶singletonLazyå¹¶æ²¡æœ‰è¢«åˆå§‹åŒ–æˆåŠŸï¼Œä¸èƒ½æ­£å¸¸ä½¿ç”¨ã€‚</p><p>å¯ä»¥åœ¨å£°æ˜singletonLazyé™æ€å˜é‡æ—¶ï¼Œä½¿ç”¨<code>volatile</code>å…³é”®å­—ï¼Œvolatileæ˜¯ä¸€ä¸ªè½»é‡çš„synchronizedï¼Œå…·æœ‰ä¸¤é‡è¯­ä¹‰ï¼Œç¬¬ä¸€æ˜¯<strong>å¯è§æ€§</strong>ï¼Œæ˜¯æŒ‡å…±äº«å˜é‡è¢«ä¿®æ”¹ä¹‹åï¼Œç«‹é©¬ä¼šä»æœ¬åœ°ç¼“å­˜ä¸­å†™å…¥ä¸»å†…å­˜ï¼Œä»¥å¯¹å…¶å®ƒçº¿ç¨‹å¯è§ã€‚ç¬¬äºŒæ˜¯<strong>ç¦æ­¢æŒ‡ä»¤é‡æ’åºä¼˜åŒ–</strong>ã€‚(<em>è¿™é‡Œå…¶å®æœ‰ç‚¹ä»¥åæ¦‚å…¨çš„æ„æ€ï¼Œå½“å¯¹volatileå†™æ—¶ï¼Œæ— è®ºå‰é¢çš„æ“ä½œæ˜¯ä»€ä¹ˆï¼Œéƒ½ä¸èƒ½é‡æ’åºï¼Œæœ‰çš„åœºæ™¯ä¸­æ˜¯å¯ä»¥é‡æ’åºçš„ï¼Œå…·ä½“åœ¨è¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œåªæ˜¯å¯¹volatileçš„å†™æ—¶ï¼Œå‰é¢çš„ä»£ç ç¦æ­¢é‡æ’åºã€‚</em>)è¿™é‡Œä½¿ç”¨çš„å°±æ˜¯ç¬¬äºŒç§è¯­ä¹‰ï¼Œç¦æ­¢é‡æ’åºã€‚</p><blockquote><p>çº¿ç¨‹å®‰å…¨æ‡’æ±‰å¼éœ€è¦æ³¨æ„çš„å‡ ç‚¹ï¼š</p></blockquote><ul><li>synchronizedå£°æ˜ä¸ºé™æ€å±æ€§ï¼Œä¸”ç”¨volatileä¿®é¥°</li><li>åŒé‡æ ¡éªŒé”(å…ˆifåˆ¤æ–­æ˜¯å¦ä¸ºnullï¼Œç„¶ååŠ é”ï¼Œæœ€åå†æ¬¡åˆ¤æ–­æ˜¯å¦ä¸ºnull)</li><li>æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„</li></ul><h2 id="å†…éƒ¨ç±»"><a href="#å†…éƒ¨ç±»" class="headerlink" title="å†…éƒ¨ç±»"></a>å†…éƒ¨ç±»</h2><p>å°†æ‡’æ±‰å¼çš„ä»£ç ä¿®è¡¥æˆçº¿ç¨‹å®‰å…¨ä¹‹åï¼Œå‘ç°ä»£ç ä¹Ÿä¸çŸ­äº†ï¼Œè€Œä¸”è¿˜æ¯”è¾ƒç»•ï¼Œé‚£ä¹ˆé¥¿æ±‰æ³•èƒ½ä¸èƒ½ä¼˜åŒ–ä¸ºæ‡’æ±‰å¼çš„å‘¢ï¼Ÿç­”æ¡ˆè‚¯å®šæ˜¯å¯ä»¥çš„ï¼Œé‚£å°±æ˜¯ä½¿ç”¨<em>å†…éƒ¨ç±»</em>ï¼Œä¹‹æ‰€ä»¥è¦æ”¹æˆæ‡’æ±‰å¼ï¼Œæ˜¯å› ä¸ºæŸäº›åœºæ™¯é¥¿æ±‰å¼ä¸èƒ½ä½¿ç”¨ï¼Œå¦‚singletonStaticå®ä¾‹çš„åˆ›å»ºæ˜¯ä¾èµ–å‚æ•°æˆ–è€…é…ç½®æ–‡ä»¶çš„ï¼Œåœ¨getSingletonStatic()ä¹‹å‰å¿…é¡»è°ƒç”¨æŸä¸ªæ–¹æ³•è®¾ç½®å‚æ•°ç»™å®ƒï¼Œé‚£æ ·è¿™ç§å•ä¾‹å†™æ³•å°±æ— æ³•ä½¿ç”¨äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SingletonInner</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Singleton</span> </span>&#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">static</span> SingletonInner singletonInner = <span class="keyword">new</span> SingletonInner();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> SingletonInner <span class="title">getSingletonInner</span><span class="params">()</span></span>&#123;</span><br><span class="line">    System.out.println(<span class="string">&quot;SingletonInner å·²è¢«åˆå§‹åŒ–&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> Singleton.singletonInner;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">SingletonInner</span><span class="params">()</span></span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;SingletonInner construct function&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç æ˜¯ä¸æ˜¯ä¾ç„¶å¾ˆçŸ­ï¼Œè€Œä¸”æ€è·¯ä¹Ÿæ¯”è¾ƒæ¸…æ™°ã€‚å°†<code>singletonInner</code>æ”¾åœ¨<code>Singleton</code>å†…éƒ¨ç±»ä¸­ï¼Œä½¿å…¶ä¸ä¼šåœ¨SingletonInneråˆå§‹åŒ–æ—¶ï¼Œè¢«å®ä¾‹åŒ–ï¼Œä»¥è¾¾åˆ°æ‡’åŠ è½½çš„æ•ˆæœã€‚</p><p>å¤šçº¿ç¨‹æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Thread-<span class="number">0</span></span><br><span class="line">Thread-<span class="number">1</span></span><br><span class="line">SingletonInner å·²è¢«åˆå§‹åŒ–</span><br><span class="line">SingletonInner å·²è¢«åˆå§‹åŒ–</span><br><span class="line">SingletonInner construct function</span><br></pre></td></tr></table></figure><p>ç”±ç»“æœå¯ä»¥æ¨æ–­ï¼ŒSingletonInnerè¢«åŠ è½½å¹¶åˆå§‹åŒ–æ—¶ï¼ŒsingletonInnerå¹¶æ²¡æœ‰è¢«å®ä¾‹åŒ–ï¼ŒsingletonInnerçš„å®ä¾‹åŒ–æ˜¯åœ¨è°ƒç”¨getSingletonInnerä¹‹åæ‰è°ƒç”¨æ„é€ æ–¹æ³•è¿›è¡Œçš„å®ä¾‹åŒ–ï¼Œç¡®å®æ˜¯æ‡’åŠ è½½æ¨¡å¼ã€‚å¹¶ä¸”æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h2 id="æšä¸¾å¼"><a href="#æšä¸¾å¼" class="headerlink" title="æšä¸¾å¼"></a>æšä¸¾å¼</h2><p>æšä¸¾åº”è¯¥æ˜¯æœ€ç®€å•çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">enum</span> <span class="title">EasySingleton</span></span>&#123;</span><br><span class="line">    INSTANCE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æšä¸¾è¿˜æ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå› ä¸ºé»˜è®¤æšä¸¾å®ä¾‹çš„åˆ›å»ºæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œ<em>ä½†æ˜¯åœ¨æšä¸¾ä¸­çš„å…¶ä»–ä»»ä½•æ–¹æ³•ç”±ç¨‹åºå‘˜è‡ªå·±è´Ÿè´£</em>ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>å®ç°å•ä¾‹çš„é€”å¾„è¿™ä¹ˆå¤šï¼Œé‚£ä¹ˆåº”è¯¥é¦–é€‰å“ªä¸ªå‘¢ï¼Ÿæˆ‘æ¯”è¾ƒæ¨èé¥¿æ±‰å¼(ä¹Ÿæ˜¯IDEé»˜è®¤æ¨èçš„)ï¼Œå¦‚æœä½¿ç”¨åœºæ™¯ä¸­éœ€è¦æ‡’åŠ è½½ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨å†…éƒ¨ç±»æ¥å®ç°å•ä¾‹ã€‚ä½†æ˜¯çº¿ç¨‹å®‰å…¨çš„æ‡’æ±‰å¼ä¹Ÿåº”è¯¥è®°ä½ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://www.oschina.net/question/2273217_217864">https://www.oschina.net/question/2273217_217864</a><br><a href="http://www.cnblogs.com/yahokuma/p/3668138.html">http://www.cnblogs.com/yahokuma/p/3668138.html</a><br><a href="http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/">http://wuchong.me/blog/2014/08/28/how-to-correctly-write-singleton-pattern/</a></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
            <tag> å•ä¾‹ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceåº”ç”¨å®ä¾‹--äºŒæ¬¡æ’åºä¹‹å…¨å±€æœ‰åº</title>
      <link href="/MapReduce%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B--%E4%BA%8C%E6%AC%A1%E6%8E%92%E5%BA%8F%E4%B9%8B%E5%85%A8%E5%B1%80%E6%9C%89%E5%BA%8F.html"/>
      <url>/MapReduce%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B--%E4%BA%8C%E6%AC%A1%E6%8E%92%E5%BA%8F%E4%B9%8B%E5%85%A8%E5%B1%80%E6%9C%89%E5%BA%8F.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/MapReduce%E5%BA%94%E7%94%A8%E5%AE%9E%E4%BE%8B--%E4%BA%8C%E6%AC%A1%E6%8E%92%E5%BA%8F%E4%B9%8Breduce%E5%86%85%E6%9C%89%E5%BA%8F.html">ä¸Šç¯‡</a>ä»‹ç»äº†äºŒæ¬¡æ’åºçš„åœºæ™¯å’Œè§£å†³æ–¹æ¡ˆï¼Œä½†æ˜¯æ— æ³•åšåˆ°å…¨å±€æœ‰åºï¼Œæœ¬ç¯‡å°±ä»‹ç»ä¸‹å¦‚ä½•è¿›è¡Œå…¨å±€äºŒæ¬¡æ’åºã€‚</p><span id="more"></span><h2 id="å…¨å±€æ’åº"><a href="#å…¨å±€æ’åº" class="headerlink" title="å…¨å±€æ’åº"></a>å…¨å±€æ’åº</h2><p>è®©æ•´ä¸ªMRç»“æœåšåˆ°å…¨å±€æœ‰åºï¼Œå…¶éš¾ç‚¹åœ¨partitionä¸Šï¼Œä¹Ÿå°±æ˜¯è¦ä¿è¯åˆ†é…ç»™reduceiçš„keyä¸€å®šæ¯”åˆ†é…ç»™reducejçš„keyå°(iå°äºj)ã€‚<em>é‚£ä¹ˆéš¾ç‚¹å°±åœ¨partitionè¾¹ç•Œçš„è®¾å®šä¸Šï¼Œè¾¹ç•Œå€¼è®¾ç½®çš„ä¸æ°å½“ï¼Œå¯èƒ½ä¼šå¯¼è‡´æ¯ä¸ªreduceä¸Šåˆ†é…çš„è®°å½•æ•°ä¸å‡åŒ€ï¼Œå‘ç”Ÿæ•°æ®å€¾æ–œä¼šå¯¼è‡´æ•´ä¸ªjobä¼šè¢«ä¸ªåˆ«taskæ‹–æ…¢</em>ã€‚</p><p>é‚£ä¹ˆæœ€ç†æƒ³çš„æ–¹å¼æ˜¯æ¯ä¸ªreduceä¸Šå¾—åˆ°çš„recordå°½å¯èƒ½çš„å‡åŒ€ï¼Œå¹¶ä¸”åœ¨å†³å®šæŸä¸ªrecordè¢«åˆ†é…åˆ°å“ªä¸ªreduceçš„æ—¶é—´åº”å°½å¯èƒ½çš„å¿«ï¼Œä¹Ÿå°±æ˜¯partitionæ–¹æ³•éœ€è¦å°½å¯èƒ½çš„æ»¡è¶³<em>ä½¿recordå¹³å‡åˆ†é…</em>å’Œ<em>åˆ†é…ç®—æ³•é«˜æ•ˆ</em>ã€‚</p><p>Hadoopæœ¬èº«æä¾›äº†<code>TotalOrderPartitioner</code>ç±»ï¼Œæ­¤åˆ†åŒºæ–¹æ³•ä¿è¯äº†ç›¸åŒkeyåˆ†é…åˆ°åŒä¸€ä¸ªreduceçš„å‰æä¸‹æ›´ä¿è¯äº†keyçš„å…¨å±€æœ‰åºã€‚åªæ˜¯æ­¤æ–¹æ³•ä¾èµ–ä¸€ä¸ªpartition fileï¼Œè¯¥fileæ˜¯ä¸€ä¸ªsequence fileï¼Œé‡Œé¢å­˜æ”¾è¿™æ¯ä¸ªreduceä¸­keyçš„åˆ†ç•Œç‚¹ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®çš„reducerä¸ªæ•°æ˜¯Nï¼Œé‚£ä¹ˆè¿™ä¸ªæ–‡ä»¶åŒ…å«(N-1)ä¸ªkeyåˆ†å‰²ç‚¹ï¼Œ<em>å¹¶ä¸”æ˜¯åŸºäºkey comparatoræ’å¥½åºçš„</em>ã€‚TotalOrderPartitionerå°†partition fileä¸­çš„keyæŒ‰ç…§æ˜¯<code>BinaryComparable</code>ç±»å‹çš„ï¼Œå¦‚æœæ˜¯åˆ™å°†keyæ„å»ºä¸€ä¸ªtrieæ ‘(æŸ¥æ‰¾çš„æ—¶é—´å¤æ‚åº¦æ˜¯O(n)ï¼Œnä¸ºtrieæ ‘çš„æ·±åº¦)ã€‚å¦‚æœæ˜¯é<code>BinaryComparable</code>ç±»å‹çš„ï¼Œåˆ™ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾(æ—¶é—´å¤æ‚åº¦ä¸ºO(log(n))ï¼Œnä¸ºreduceä¸ªæ•°)ã€‚å½“æŸ¥æ‰¾çš„æ•°æ®ç»“æ„æ„å»ºå¥½ä¹‹åï¼ŒTotalOrderPartitionerä¼šæ£€æŸ¥æ¯ä¸€ä¸ªkeyå±äºå“ªä¸€ä¸ªreducerçš„èŒƒå›´å†…ï¼Œç„¶åå†³å®šåˆ†å‘ç»™å“ªä¸€ä¸ªreducerã€‚</p><!-- partition fileé€šè¿‡**ï¼Ÿï¼Ÿï¼Ÿ**æ¥distribute keysï¼Œä¹Ÿå°±æ˜¯æ€ä¹ˆå°†æŸ¥æ‰¾çš„æ•°æ®ç»“æ„å¹¿æ’­åˆ°å„ä¸ªmapèŠ‚ç‚¹çš„ --><p>é‚£ä¹ˆé¢å¯¹å¤§é‡çš„æ•°æ®ï¼Œpartition fileå¦‚ä½•å¾—åˆ°ï¼ŸHadoopå¸®æˆ‘ä»¬æä¾›äº†<em>é‡‡æ ·å™¨</em>å¸®æˆ‘ä»¬é¢„ä¼°æ•´ä¸ªè¾¹ç•Œï¼Œä»¥ä½¿æ•°æ®çš„åˆ†é…å°½é‡å¹³å‡ã€‚Hadoopæä¾›çš„é‡‡æ ·å·¥å…·æœ‰<em>RandomSamplerã€InputSamplerå’ŒIntervalSampler</em>ã€‚</p><p>å…¶ä¸­</p><ul><li>RandomSampler&lt;K,V&gt;ä¸ºéå†æ‰€æœ‰æ•°æ®ï¼Œéšæœºé‡‡æ ·ï¼Œæ•ˆç‡æœ‰ç‚¹ä½ã€‚</li><li>SplitSampler&lt;K,V&gt;æ˜¯å¯¹å‰nä¸ªè®°å½•è¿›è¡Œé‡‡æ ·ï¼Œæ•ˆç‡æ˜¯è¿™ä¸‰ä¸ªé‡Œæœ€é«˜çš„ã€‚</li><li>IntervalSampler&lt;K,V&gt;æ˜¯å¯¹å›ºå®šé—´éš”é‡‡æ ·ï¼Œæ•ˆç‡è¾ƒé«˜ï¼Œä½†æ¯”è¾ƒé€‚åˆæœ‰åºçš„æ•°æ®é›†ã€‚</li></ul><p>å¯¹äºpartition fileçš„å€¼é™¤äº†ç”¨ä¸Šé¢çš„é‡‡æ ·æ–¹æ³•ä¹‹å¤–ï¼Œè¿˜å¯ä»¥æ ¹æ®ç‰¹å®šéœ€æ±‚è‡ªå·±å†™MRå¯¹æ•°æ®è¿›è¡Œåˆ’åˆ†ã€‚æœ¬ç¯‡é‡‡ç”¨<code>RandomSampler</code>å¯¹æ•°æ®è¿›è¡Œåˆ’åˆ†ã€‚</p><p>ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TotalSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = Logger.getLogger(TotalSort.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span></span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Text</span>, <span class="title">Text</span>, <span class="title">Text</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Text key, Text value, Context context</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="comment">// key å’Œ valueå½¢æˆç»„åˆé”®ï¼ŒåæœŸäºŒæ¬¡æ’åº</span></span><br><span class="line">            context.write(<span class="keyword">new</span> Text(key.toString() + <span class="string">&quot; &quot;</span> + value.toString()), </span><br><span class="line">            <span class="keyword">new</span> IntWritable(Integer.parseInt(value.toString())));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span></span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">Text</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">NullWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(Text key, Iterable&lt;IntWritable&gt; values,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Context context</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line">                <span class="comment">// å°†å†…å®¹key valueä½œä¸ºå¤åˆkeyè¾“å‡º</span></span><br><span class="line">                context.write(key, NullWritable.get());</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        conf.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://192.168.244.131:9000&quot;</span>);</span><br><span class="line">        <span class="comment">// è®¾ç½®æºæ–‡ä»¶ä¸­å­—æ®µä¹‹é—´çš„åˆ†éš”ç¬¦ï¼Œé»˜è®¤æ˜¯\t</span></span><br><span class="line">        <span class="comment">// æ­¤åˆ†éš”ç¬¦åœ¨ KeyValueTextInputFormat ä¸­ä½¿ç”¨</span></span><br><span class="line">        conf.set(<span class="string">&quot;mapreduce.input.keyvaluelinerecordreader.key.value.separator&quot;</span>, <span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">        <span class="keyword">if</span> (otherArgs.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// partition file åœ¨hdfsä¸Šçš„å­˜å‚¨è·¯å¾„</span></span><br><span class="line">        Path partitionFile = <span class="keyword">new</span> Path(<span class="string">&quot;hdfs://192.168.244.131:9000/secondPartition&quot;</span>);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨ RandomSampler é‡‡é›†å™¨å¯¹æ•°æ®è¿›è¡ŒæŠ½æ ·åˆ’åˆ†ç•Œé™</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œ RandomSampler&lt;&gt; å†…K Vçš„æ•°æ®ç±»å‹åœ¨æœ¬ä¾‹ä¸­æ— ç”¨ï¼Œå¯ä»¥éšä¾¿å†™ä¹Ÿå¯ä¸å†™</span></span><br><span class="line">        <span class="comment">// å› ä¸ºåœ¨ä»£ç ä¸­ä½¿ç”¨çš„æ•°æ®ç±»å‹æ˜¯ InputFormat çš„æ•°æ®ç±»å‹</span></span><br><span class="line">        InputSampler.RandomSampler&lt;NullWritable, NullWritable&gt; randomSampler</span><br><span class="line">                = <span class="keyword">new</span> InputSampler.RandomSampler&lt;NullWritable, NullWritable&gt;(<span class="number">0.5</span>, <span class="number">3</span>);</span><br><span class="line">        <span class="comment">// RandomSamplerçš„å¦ä¸€ä¸ªæ„é€ æ–¹æ³•ï¼Œå½“splitè¾ƒå¤šæ—¶ï¼Œå¯ä»¥ä½¿ç”¨</span></span><br><span class="line"><span class="comment">//                = new InputSampler.RandomSampler&lt;Text, Text&gt;(0.5, 3, 2);</span></span><br><span class="line">        TotalOrderPartitioner.setPartitionFile(conf, partitionFile);</span><br><span class="line"></span><br><span class="line">        Job job = Job.getInstance(conf, <span class="string">&quot;TotalSort&quot;</span>);</span><br><span class="line">        <span class="comment">// ä½¿ç”¨KeyValueTextInputFormatï¼Œé»˜è®¤æ˜¯FileInputFormat</span></span><br><span class="line">        job.setInputFormatClass(KeyValueTextInputFormat.class);</span><br><span class="line"></span><br><span class="line">        job.setJarByClass(SecondSort.class);</span><br><span class="line">        job.setMapperClass(MyMapper.class);</span><br><span class="line">        job.setReducerClass(MyReducer.class);</span><br><span class="line">        <span class="comment">// æ¨¡æ‹Ÿå…¨å±€æ’åºï¼Œè®¾ç½®reduceä¸ªæ•°å¤§äº1</span></span><br><span class="line">        job.setNumReduceTasks(<span class="number">2</span>);</span><br><span class="line">        job.setMapOutputKeyClass(Text.class);</span><br><span class="line">        job.setMapOutputValueClass(IntWritable.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(NullWritable.class);</span><br><span class="line">        <span class="comment">// å…¨å±€æ’åºåˆ†åŒº</span></span><br><span class="line">        job.setPartitionerClass(TotalOrderPartitioner.class);</span><br><span class="line">        <span class="comment">// é‡å†™æ’åºæ–¹æ³•</span></span><br><span class="line">        job.setSortComparatorClass(KeyComparator.class);</span><br><span class="line">        job.setGroupingComparatorClass(GroupComparator.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; otherArgs.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(otherArgs[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job,</span><br><span class="line">                <span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">        FileSystem fs = FileSystem.get(conf);</span><br><span class="line">        <span class="keyword">if</span> (fs.exists(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>])))&#123;</span><br><span class="line">            fs.delete(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å°†æ•°æ®çš„åˆ†ç•Œç‚¹å†™å…¥partition fileä¸­</span></span><br><span class="line">        InputSampler.writePartitionFile(job, randomSampler);</span><br><span class="line"></span><br><span class="line">        System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šé¢çš„demoæ˜¯åœ¨ä¹‹å‰äºŒæ¬¡æ’åºçš„åŸºç¡€ä¸ŠåŠ ä¸Šäº†å…¨å±€æ’åºï¼ŒäºŒæ¬¡æ’åºçš„æ€è·¯åœ¨ä¸Šç¯‡æ–‡ç« ä¸­ä»‹ç»è¿‡ï¼Œå…¨å±€æ’åºä½¿ç”¨çš„æ˜¯Hadoopè‡ªå¸¦çš„<code>TotalOrderPartitioner</code>åˆ†åŒºæ–¹æ³•ã€‚</p><p>è¿™é‡Œçš„éš¾ç‚¹æ˜¯ä½¿ç”¨é‡‡é›†å™¨RandomSamplerç”Ÿæˆpartition fileï¼Œ<em>è¿™é‡Œå®¹æ˜“å‡ºç°ç±»å‹ä¸åŒ¹é…çš„error</em>ã€‚<br>ä¹‹å‰ä»‹ç»partition fileä¸­å­˜å‚¨çš„æ˜¯keyçš„åˆ†ç•Œç‚¹ï¼Œæ ¹æ®åˆ†ç•Œç‚¹çš„å€¼å¯¹mapçš„è¾“å‡ºè¿›è¡Œåˆ†åŒºã€‚åˆ™partition fileä¸­å­˜å‚¨çš„keyåº”è¯¥å’Œmap outputçš„keyæ˜¯åŒä¸€ç±»å‹(<em>å› ä¸ºè¦è®©ä¸¤è€…è¿›è¡Œæ¯”è¾ƒ</em>)ï¼Œè€Œmapçš„output keyåˆæ˜¯reduceçš„input keyï¼Œ<strong>åˆ™partition fileä¸­çš„keyåº”è¯¥å’Œmap output keyã€reduce input keyçš„ç±»å‹ä¸€æ ·</strong>ã€‚é‚£ä¹ˆpartition fileä¸­çš„keyæ˜¯æ€ä¹ˆäº§ç”Ÿçš„å‘¢ï¼Ÿæœ¬demoæ˜¯ç”¨RandomSampleræ¥ç”Ÿæˆpartition fileï¼Œ<em>é‚£ä¹ˆä¹…åº”è¯¥è®©RandomSamplerç”Ÿæˆçš„partition fileä¸­çš„keyçš„ç±»å‹å’Œmap output keyã€reduce input keyçš„ç±»å‹ä¸€æ ·</em>ã€‚<br>åœ¨new RandomSamplerçš„æ—¶å€™ï¼Œå¯ä»¥è®¾ç½®K Vçš„æ•°æ®ç±»å‹ï¼Œè¿™é‡Œä½ å¯èƒ½ä¼šè®¤ä¸ºè¿™ä¸ªK Vçš„æ•°æ®ç±»å‹åº”è¯¥å°±æ˜¯è¾“å‡ºåˆ°partition fileä¸­çš„æ•°æ®ç±»å‹å§ï¼Œç„¶è€Œå¹¶ä¸æ˜¯ã€‚<em>ç¿»çœ‹ä»£ç å‘ç°è¾“å‡ºåˆ°partition fileçš„Kçš„æ•°æ®ç±»å‹æ˜¯ç”±InputFormatçš„Kå†³å®šçš„ï¼ŒVçš„æ•°æ®ç±»å‹åœ¨ä»£ç ä¸­å†™æ­»çš„ä¸ºNullWritable</em>ã€‚åˆå› ä¸ºInputFormat Kçš„æ•°æ®ç±»å‹å†³å®šäº†map input keyçš„æ•°æ®ç±»å‹ï¼Œ<em>åˆ™partition fileä¸­keyçš„æ•°æ®ç±»å‹åº”è¯¥å’ŒInputFormat Kã€map input keyçš„æ•°æ®ç±»å‹ä¸€æ ·</em>ã€‚<strong>è¿™ä¹Ÿå°±æ˜¯ä»£ç ä¸­è®¾ç½®InputFormatç±»å‹ä¸º<code>KeyValueTextInputFormat.class</code>çš„åŸå› </strong>ã€‚</p><p>ç»¼ä¸Šæ‰€è¿°ï¼Œ<em>å¦‚æœä½¿ç”¨RandomSamplerç”Ÿæˆpartition fileï¼Œåˆ™å¿…é¡»ä¿è¯partition file keyã€InputFormat Kã€map input keyã€map output keyå’Œreduce input keyçš„ç±»å‹ä¸€æ ·</em>ã€‚å¦‚æœ<strong>ä¸</strong>ä½¿ç”¨RandomSamplerç”Ÿæˆpartition file(å¯èƒ½æ˜¯è‡ªå·±å†™çš„MR)ï¼Œ<em>åˆ™åªéœ€ä¿è¯partition file keyã€map output keyå’Œreduce input keyçš„ç±»å‹ä¸€æ ·å³å¯</em>ï¼Œå› ä¸ºåœ¨è¯»partition fileæ—¶ï¼Œä¼šè°ƒç”¨<code>job.getMapOutputKeyClass()</code>è®¾ç½®è¯»å–çš„æ•°æ®ç±»å‹ã€‚</p><p>è¿è¡Œä¸Šé¢çš„ä»£ç ä¼šå…ˆå°†keyçš„åˆ†ç•Œç‚¹å†™å…¥partition fileä¸­ï¼Œå› ä¸ºpartition fileæ˜¯sequence fileï¼Œä½¿ç”¨hadoopå‘½ä»¤æŸ¥çœ‹<code>hadoop dfs -text /secondPartition</code>ï¼Œç»“æœä¸º</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># value ä¸ºnullæ˜¯å› ä¸ºåœ¨ä»£ç ä¸­è®¾ç½®ä¸ºNullWritableç±»å‹</span></span><br><span class="line">1993(null)</span><br></pre></td></tr></table></figure><p>ç„¶åæ ¹æ®å…¶åˆ†ç•Œç‚¹å¯¹mapçš„ç»“æœè¿›è¡Œåˆ†åŒºï¼ŒæŸ¥çœ‹å…¨å±€æ’åºçš„ç»“æœä¸ºï¼š<br>part-r-00000<br>1990 10<br>1990 17<br>1990 22<br>1990 31<br>1991 18<br>1991 20<br>1991 27<br>1991 33<br>1992 22<br>1992 31<br>part-r-00001<br>1993 18<br>1993 33</p><p>å¯è§å…¶ç»“æœæ˜¯å…¨å±€æ’åºå¹¶ä¸”æ˜¯å…ˆæŒ‰ç…§keyç„¶åæŒ‰ç…§valueæ’åºçš„ã€‚åªæ˜¯ç”±äºåˆ†ç•Œç‚¹é€‰æ‹©çš„é—®é¢˜ï¼Œå¯¼è‡´ä¸¤ä¸ªreduceå¤„ç†çš„æ•°æ®é‡ä¸ä¸€æ ·ï¼Œå‡ºç°äº†æ•°æ®å€¾æ–œã€‚</p><h2 id="è‡ªå®šä¹‰InputFormatClasså…¨å±€æ’åº"><a href="#è‡ªå®šä¹‰InputFormatClasså…¨å±€æ’åº" class="headerlink" title="è‡ªå®šä¹‰InputFormatClasså…¨å±€æ’åº"></a>è‡ªå®šä¹‰InputFormatClasså…¨å±€æ’åº</h2><p>ä¸Šé¢çš„demoä¸ºäº†ä¿è¯keyçš„æ•°æ®ç±»å‹ä¸€è‡´ï¼Œä½¿ç”¨äº†KeyValueTextInputFormat.classè®¾ç½®InputFormatClassï¼Œä½†æ˜¯å¦‚æœmap output keyä¸ºè‡ªå®šä¹‰çš„æ•°æ®ç±»å‹çš„è¯ï¼Œé‚£ä¹ˆInputFormatClassä¹Ÿå¿…é¡»è‡ªå®šä¹‰ã€‚è‡ªå®šä¹‰InputFormatæ—¶è¦é‡å†™<code>getSplits</code>å’Œ<code>createRecordReader</code>æ–¹æ³•ï¼Œæœ¬ä¾‹ä¸­çš„InputFormatæ–¹æ³•ç»§æ‰¿è‡ª<code>FileInputFormat</code>ï¼Œå› ä¸ºsplitçš„è§„åˆ™æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥åªæ˜¯é‡å†™äº†<code>createRecordReader</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntityPairInputFormat</span> <span class="keyword">extends</span> <span class="title">FileInputFormat</span>&lt;<span class="title">EntityPair</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> RecordReader&lt;EntityPair, Text&gt; <span class="title">createRecordReader</span></span></span><br><span class="line"><span class="function">            <span class="params">(InputSplit inputSplit, TaskAttemptContext taskAttemptContext)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        String delimiter = taskAttemptContext.getConfiguration().get(</span><br><span class="line">                <span class="string">&quot;textinputformat.record.delimiter&quot;</span>);</span><br><span class="line">        <span class="keyword">byte</span>[] recordDelimiterBytes = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != delimiter)</span><br><span class="line">            recordDelimiterBytes = delimiter.getBytes(Charsets.UTF_8);</span><br><span class="line">        <span class="comment">// æ¨¡ä»¿ TextInputFormat çš„å®ç°æ–¹å¼ å¹¶æ”¹å†™ LineRecordReader</span></span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰äº†è¡Œè¯»å–æ–¹æ³•</span></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> EntitypairLineRecordReader(recordDelimiterBytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// EntitypairLineRecordReader.java</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntitypairLineRecordReader</span> <span class="keyword">extends</span> <span class="title">RecordReader</span>&lt;<span class="title">EntityPair</span>, <span class="title">Text</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Log LOG = LogFactory.getLog(EntitypairLineRecordReader.class);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String MAX_LINE_LENGTH =</span><br><span class="line">            <span class="string">&quot;mapreduce.input.linerecordreader.line.maxlength&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> pos;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> end;</span><br><span class="line">    <span class="keyword">private</span> SplitLineReader in;</span><br><span class="line">    <span class="keyword">private</span> FSDataInputStream fileIn;</span><br><span class="line">    <span class="keyword">private</span> Seekable filePosition;</span><br><span class="line">    <span class="keyword">private</span> EntityPair key;</span><br><span class="line">    <span class="keyword">private</span> Text value;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> maxLineLength;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> isCompressedInput;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">byte</span>[] recordDelimiterBytes;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">EntitypairLineRecordReader</span><span class="params">(<span class="keyword">byte</span>[] recordDelimiterBytes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.recordDelimiterBytes = recordDelimiterBytes;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">initialize</span></span></span><br><span class="line"><span class="function">            <span class="params">(InputSplit inputSplit, TaskAttemptContext taskAttemptContext)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        FileSplit split = (FileSplit) inputSplit;</span><br><span class="line">        Configuration job = taskAttemptContext.getConfiguration();</span><br><span class="line">        <span class="keyword">this</span>.maxLineLength = job.getInt(MAX_LINE_LENGTH, Integer.MAX_VALUE);</span><br><span class="line">        start = split.getStart();</span><br><span class="line">        end = start + split.getLength();</span><br><span class="line">        <span class="keyword">final</span> Path file = split.getPath();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// open the file and seek to the start of the split</span></span><br><span class="line">        <span class="keyword">final</span> FileSystem fs = file.getFileSystem(job);</span><br><span class="line">        fileIn = fs.open(file);</span><br><span class="line"></span><br><span class="line">        fileIn.seek(start);</span><br><span class="line"></span><br><span class="line">        in = <span class="keyword">new</span> SplitLineReader(fileIn, job, <span class="keyword">this</span>.recordDelimiterBytes);</span><br><span class="line">        filePosition = fileIn;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// If this is not the first split, we always throw away first record</span></span><br><span class="line">        <span class="comment">// because we always (except the last split) read one extra line in</span></span><br><span class="line">        <span class="comment">// next() method.</span></span><br><span class="line">        <span class="keyword">if</span> (start != <span class="number">0</span>) &#123;</span><br><span class="line">            start += in.readLine(<span class="keyword">new</span> Text(), <span class="number">0</span>, maxBytesToConsume(start));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.pos = start;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">maxBytesToConsume</span><span class="params">(<span class="keyword">long</span> pos)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> isCompressedInput</span><br><span class="line">                ? Integer.MAX_VALUE</span><br><span class="line">                : (<span class="keyword">int</span>) Math.max(Math.min(Integer.MAX_VALUE, end - pos), maxLineLength);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ç»™keyå’Œvalueèµ‹å€¼</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKeyValue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">            key = <span class="keyword">new</span> EntityPair();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span>) &#123;</span><br><span class="line">            value = <span class="keyword">new</span> Text();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> newSize = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (getFilePosition() &lt;= end || in.needAdditionalRecordAfterSplit()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (pos == <span class="number">0</span>) &#123;</span><br><span class="line">                newSize = skipUtfByteOrderMark();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                newSize = in.readLine(value, maxLineLength, maxBytesToConsume(pos));</span><br><span class="line">                pos += newSize;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> ((newSize == <span class="number">0</span>) || (newSize &lt; maxLineLength)) &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// line too long. try again</span></span><br><span class="line">            LOG.info(<span class="string">&quot;Skipped line of size &quot;</span> + newSize + <span class="string">&quot; at pos &quot;</span> +</span><br><span class="line">                    (pos - newSize));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (newSize == <span class="number">0</span>) &#123;</span><br><span class="line">            key = <span class="keyword">null</span>;</span><br><span class="line">            value = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// æ‰“å°valueçš„å€¼ï¼Œå¯ä»¥çœ‹å‡ºvalueå°±æ˜¯æºæ–‡ä»¶ä¸­çš„æ•°æ®</span></span><br><span class="line">            LOG.info(<span class="string">&quot;====EntitypairLineRecordReader.value : &quot;</span> + value.toString());</span><br><span class="line">            key.set(<span class="keyword">new</span> Text(value.toString().split(<span class="string">&quot; &quot;</span>)[<span class="number">0</span>]),</span><br><span class="line">                    <span class="keyword">new</span> IntWritable(Integer.parseInt(value.toString().split(<span class="string">&quot; &quot;</span>)[<span class="number">1</span>])));</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">skipUtfByteOrderMark</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="comment">// Strip BOM(Byte Order Mark)</span></span><br><span class="line">        <span class="comment">// Text only support UTF-8, we only need to check UTF-8 BOM</span></span><br><span class="line">        <span class="comment">// (0xEF,0xBB,0xBF) at the start of the text stream.</span></span><br><span class="line">        <span class="keyword">int</span> newMaxLineLength = (<span class="keyword">int</span>) Math.min(<span class="number">3L</span> + (<span class="keyword">long</span>) maxLineLength,</span><br><span class="line">                Integer.MAX_VALUE);</span><br><span class="line">        <span class="keyword">int</span> newSize = in.readLine(value, newMaxLineLength, maxBytesToConsume(pos));</span><br><span class="line">        <span class="comment">// Even we read 3 extra bytes for the first line,</span></span><br><span class="line">        <span class="comment">// we won&#x27;t alter existing behavior (no backwards incompat issue).</span></span><br><span class="line">        <span class="comment">// Because the newSize is less than maxLineLength and</span></span><br><span class="line">        <span class="comment">// the number of bytes copied to Text is always no more than newSize.</span></span><br><span class="line">        <span class="comment">// If the return size from readLine is not less than maxLineLength,</span></span><br><span class="line">        <span class="comment">// we will discard the current line and read the next line.</span></span><br><span class="line">        pos += newSize;</span><br><span class="line">        <span class="keyword">int</span> textLength = value.getLength();</span><br><span class="line">        <span class="keyword">byte</span>[] textBytes = value.getBytes();</span><br><span class="line">        <span class="keyword">if</span> ((textLength &gt;= <span class="number">3</span>) &amp;&amp; (textBytes[<span class="number">0</span>] == (<span class="keyword">byte</span>)<span class="number">0xEF</span>) &amp;&amp;</span><br><span class="line">                (textBytes[<span class="number">1</span>] == (<span class="keyword">byte</span>)<span class="number">0xBB</span>) &amp;&amp; (textBytes[<span class="number">2</span>] == (<span class="keyword">byte</span>)<span class="number">0xBF</span>)) &#123;</span><br><span class="line">            <span class="comment">// find UTF-8 BOM, strip it.</span></span><br><span class="line">            LOG.info(<span class="string">&quot;Found UTF-8 BOM and skipped it&quot;</span>);</span><br><span class="line">            textLength -= <span class="number">3</span>;</span><br><span class="line">            newSize -= <span class="number">3</span>;</span><br><span class="line">            <span class="keyword">if</span> (textLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// It may work to use the same buffer and not do the copyBytes</span></span><br><span class="line">                textBytes = value.copyBytes();</span><br><span class="line">                value.set(textBytes, <span class="number">3</span>, textLength);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                value.clear();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> newSize;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> EntityPair <span class="title">getCurrentKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Text <span class="title">getCurrentValue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">this</span>.value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">float</span> <span class="title">getProgress</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (start == end) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">0.0f</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> Math.min(<span class="number">1.0f</span>, (getFilePosition() - start) / (<span class="keyword">float</span>)(end - start));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">getFilePosition</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> retVal;</span><br><span class="line">        <span class="keyword">if</span> (isCompressedInput &amp;&amp; <span class="keyword">null</span> != filePosition) &#123;</span><br><span class="line">            retVal = filePosition.getPos();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            retVal = pos;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> retVal;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        in.close();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨EntityPairInputFormatä¸­åˆnewäº†ä¸ªæ–°çš„<code>RecordReader</code>ï¼Œç”¨æ¥è¯»å–recordå½¢æˆEntityPair(K)å’ŒText(V)ã€‚æ–°çš„RecordReaderä¸º<code>EntitypairLineRecordReader</code>ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹å…¨å±€äºŒæ¬¡æ’åºçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">EntitySecondSort</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Logger log = Logger.getLogger(EntitySecondSort.class);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyMapper</span></span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">Mapper</span>&lt;<span class="title">Object</span>, <span class="title">Text</span>, <span class="title">EntityPair</span>, <span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">map</span><span class="params">(Object key, Text value, Context context</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            String[] arr = value.toString().split(<span class="string">&quot; &quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// å°†å†…å®¹key valueä½œä¸ºå¤åˆkeyè¾“å‡º</span></span><br><span class="line">            context.write(<span class="keyword">new</span> EntityPair(<span class="keyword">new</span> Text(arr[<span class="number">0</span>]), <span class="keyword">new</span> IntWritable(Integer.parseInt(arr[<span class="number">1</span>]))),</span><br><span class="line">                    <span class="keyword">new</span> IntWritable(Integer.parseInt(arr[<span class="number">1</span>])));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MyReducer</span></span></span><br><span class="line"><span class="class">            <span class="keyword">extends</span> <span class="title">Reducer</span>&lt;<span class="title">EntityPair</span>,<span class="title">IntWritable</span>,<span class="title">Text</span>,<span class="title">IntWritable</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">reduce</span><span class="params">(EntityPair key, Iterable&lt;IntWritable&gt; values,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Context context</span></span></span><br><span class="line"><span class="params"><span class="function">        )</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">            <span class="keyword">for</span> (IntWritable val : values) &#123;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// åˆ†ç»„ä¹‹å</span></span><br><span class="line">                context.write(<span class="keyword">new</span> Text(key.getFirstKey()), val);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line"></span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line">        conf.set(<span class="string">&quot;fs.defaultFS&quot;</span>, <span class="string">&quot;hdfs://192.168.244.131:9000&quot;</span>);</span><br><span class="line"></span><br><span class="line">        String[] otherArgs = <span class="keyword">new</span> GenericOptionsParser(conf, args).getRemainingArgs();</span><br><span class="line">        <span class="keyword">if</span> (otherArgs.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">            System.err.println(<span class="string">&quot;Usage: wordcount &lt;in&gt; [&lt;in&gt;...] &lt;out&gt;&quot;</span>);</span><br><span class="line">            System.exit(<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Path partitionFile = <span class="keyword">new</span> Path(<span class="string">&quot;hdfs://192.168.244.131:9000/secondPartition&quot;</span>);</span><br><span class="line">        InputSampler.RandomSampler randomSampler</span><br><span class="line">                = <span class="keyword">new</span> InputSampler.RandomSampler(<span class="number">0.5</span>, <span class="number">3</span>, <span class="number">2</span>);</span><br><span class="line">        TotalOrderPartitioner.setPartitionFile(conf, partitionFile);</span><br><span class="line"></span><br><span class="line">        Job job = Job.getInstance(conf, <span class="string">&quot;EntitySecondSort&quot;</span>);</span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰è¾“å…¥ç±»å‹</span></span><br><span class="line">        job.setInputFormatClass(EntityPairInputFormat.class);</span><br><span class="line">        job.setJarByClass(EntitySecondSort.class);</span><br><span class="line">        job.setMapperClass(MyMapper.class);</span><br><span class="line">        job.setReducerClass(MyReducer.class);</span><br><span class="line">        job.setNumReduceTasks(<span class="number">2</span>);</span><br><span class="line">        job.setMapOutputKeyClass(EntityPair.class);</span><br><span class="line">        job.setMapOutputValueClass(IntWritable.class);</span><br><span class="line">        job.setOutputKeyClass(Text.class);</span><br><span class="line">        job.setOutputValueClass(IntWritable.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å…¨å±€æ’åºåˆ†åŒº</span></span><br><span class="line">        job.setPartitionerClass(TotalOrderPartitioner.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// é‡å†™æ’åºæ–¹æ³•</span></span><br><span class="line">        job.setSortComparatorClass(EntityComparator.class);</span><br><span class="line">        <span class="comment">// è‡ªå®šä¹‰åˆ†ç»„ç®—æ³•</span></span><br><span class="line">        job.setGroupingComparatorClass(EntityGroup.class);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; otherArgs.length - <span class="number">1</span>; ++i) &#123;</span><br><span class="line">            FileInputFormat.addInputPath(job, <span class="keyword">new</span> Path(otherArgs[i]));</span><br><span class="line">        &#125;</span><br><span class="line">        FileOutputFormat.setOutputPath(job,</span><br><span class="line">                <span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]));</span><br><span class="line"></span><br><span class="line">        FileSystem fs = FileSystem.get(conf);</span><br><span class="line">        <span class="keyword">if</span> (fs.exists(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>])))&#123;</span><br><span class="line">            fs.delete(<span class="keyword">new</span> Path(otherArgs[otherArgs.length - <span class="number">1</span>]), <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InputSampler.writePartitionFile(job, randomSampler);</span><br><span class="line"></span><br><span class="line">        System.exit(job.waitForCompletion(<span class="keyword">true</span>) ? <span class="number">0</span> : <span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ç»“æœä¸ºï¼š<br>part-r-00000<br>1990    10<br>1990    17<br>1990    22<br>1990    31<br>part-r-00001<br>1991    18<br>1991    20<br>1991    27<br>1991    33<br>1992    22<br>1992    31<br>1993    18<br>1993    33</p><p>ä¸Šé¢è®²è¿‡ä½¿ç”¨RandomSamplerç”Ÿæˆpartition fileæ—¶å¿…é¡»ä¿è¯partition file keyã€InputFormat Kã€map input keyã€map output keyå’Œreduce input keyçš„ç±»å‹ä¸€æ ·ï¼Œåˆ™partition fileä¸­å­˜æ”¾çš„æ•°æ®ä¹Ÿæ˜¯EntityPairç±»å‹çš„keyï¼Œæ­¤æ—¶å¦‚æœç”¨<code>hadoop dfs -text /secondPartition</code>å‘½ä»¤æŸ¥çœ‹partition fileæ—¶ï¼Œä¼šæŠ¥é”™ï¼Œå› ä¸ºæ— æ³•è§£æEntityPairå¯¹è±¡ã€‚é‚£ä¹ˆå¦‚ä½•å»éªŒè¯keyçš„åˆ†ç•Œç‚¹æ˜¯1991å‘¢ï¼Ÿ</p><p>æˆ‘å¹¶æ²¡æœ‰å»æ‰‹åŠ¨ååºåˆ—partition fileï¼Œè€Œæ˜¯åœ¨<code>InputSampler</code>ä¸­å†™å…¥partition fileçš„ä»£ç å¤„æ‰“äº†ä¸‹logï¼Œå°†å†™å…¥çš„keyæ‰“å°å‡ºæ¥äº†ï¼Œæ—¥å¿—ä¸­æ˜¾ç¤ºåˆ†ç•Œç‚¹keyä¸º<code>1991 27</code>(ä¹‹æ‰€ä»¥æ˜¾ç¤ºè¿™ä¸ªæ ¼å¼ï¼Œæ˜¯å› ä¸ºæˆ‘é‡å†™äº†EntityPairçš„toStringæ–¹æ³•)ã€‚è¿™å°±éªŒè¯äº†åˆ†åŒºçš„ç»“æœã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬ç¯‡ä¸»è¦æ˜¯åˆ©ç”¨MRè¿›è¡Œå…¨å±€æ’åºï¼Œè€Œ<strong>å…¨å±€æ’åºçš„éš¾ç‚¹æ˜¯å¦‚æœå¯¹æ•°æ®è¿›è¡Œåˆ†åŒºï¼Œå¹¶ä¸”å°½é‡é¿å…æ•°æ®å€¾æ–œ</strong>ã€‚<br>æœ¬ä¾‹ä½¿ç”¨çš„æ˜¯Hadoopè‡ªèº«çš„<code>TotalOrderPartitioner</code>å¯¹æ•°æ®è¿›è¡Œåˆ†åŒºï¼ŒTotalOrderPartitionerä¼šæ ¹æ®åˆ†ç•Œç‚¹çš„keyå½¢æˆä¸€ä¸ªåˆ©äºæŸ¥æ‰¾çš„æ•°æ®ç»“æ„ï¼Œä½¿mapçš„è¾“å‡ºkeyåœ¨æ­¤æ•°æ®ç»“æ„ä¸­èƒ½å¤Ÿå¿«é€Ÿçš„å®šä½åˆ°ç›¸åº”çš„reduceä¸­ï¼Œå…³äºTotalOrderPartitionerçš„æ›´å¤šå†…å®¹éšåä¼šæœ‰ä¸€ç¯‡æ–‡ç« æ¥ä»æºç çš„è§’åº¦å±•å¼€åˆ†æã€‚<br>è€Œåˆ†ç•Œç‚¹keyæ˜¯é€šè¿‡RandomSamplerä»æºæ–‡ä»¶ä¸­éšæœºæŠ½å–çš„ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> MapReduceåº”ç”¨å®ä¾‹ </tag>
            
            <tag> äºŒæ¬¡æ’åº </tag>
            
            <tag> å…¨å±€æ’åº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Reverse Integer</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Reverse%20Integer.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Reverse%20Integer.html</url>
      
        <content type="html"><![CDATA[<p>å°†ä¸€ä¸ªintæ•°ç¿»è½¬æ•°å­—ï¼Œåªç¿»è½¬æ•°å­—ï¼Œç¬¦å·ä¸åšå¤„ç†ã€‚</p><p>exampleï¼š<br>x = 123, return 321<br>x = -123, return -321</p><blockquote><p>æ•°æ®è¶Šç•Œåˆ™è¿”å›0</p></blockquote><p>è¿™ä¸ªæ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å°†intçš„æœ€é«˜ä½å’Œæœ€ä½ä½ä¾æ¬¡è¿›è¡Œè°ƒæ¢ï¼Œå¦‚æœintä¸­çš„æ¯ä¸ªå­—ç¬¦éƒ½èƒ½æ‹¿åˆ°å…¶ç´¢å¼•å€¼ï¼Œé‚£ä¹ˆå°±å¯ä»¥æ ¹æ®ç´¢å¼•å€¼è¿›è¡Œä¾æ¬¡å¯¹è°ƒã€‚ä½†åœ¨æ±‚æ¯ä½ä¸Šçš„æ•°å­—æ—¶å‘ç°å¾—åˆ°ä¸ªä½ã€åä½ã€ç™¾ä½ç­‰ä¸Šçš„æ•°å­—çš„é¡ºåºå…¶å®å°±æ˜¯åœ¨ç»™intè¿›è¡Œåè½¬ï¼Œé‚£æˆ‘åªéœ€è¦å°†æ¯æ¬¡å¾—åˆ°çš„å€¼è¿›è¡Œä¾æ¬¡è®°å½•ï¼Œç„¶åé¡ºåºè¾“å‡ºå°±okäº†ã€‚</p><span id="more"></span><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> x)</span> </span>&#123;</span><br><span class="line"><span class="comment">// å…¶å®è¿™ä¸ªæ€è·¯è¿˜æœ‰ä¸€ç§æ›´ç®€å•çš„ï¼Œç›´æ¥å°†intè½¬ä¸ºstringï¼Œ</span></span><br><span class="line"><span class="comment">// ç„¶ååˆ©ç”¨stringä¸­å­—ç¬¦çš„ç´¢å¼•è¿›è¡Œäº¤æ¢å¾—åˆ°åè½¬å­—ç¬¦ä¸²ï¼Œç„¶åå†åˆ¤æ–­æ˜¯å¦è¶Šç•Œ</span></span><br><span class="line">    <span class="keyword">if</span> (x == <span class="number">0</span> || x == Integer.MIN_VALUE)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="keyword">if</span> (x &lt; <span class="number">0</span>)&#123;</span><br><span class="line">        stringBuffer.append(<span class="string">&quot;-&quot;</span>);</span><br><span class="line">        x = <span class="number">0</span> - x;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> (x &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">int</span> last = x % <span class="number">10</span>;</span><br><span class="line">        x = x / <span class="number">10</span>;</span><br><span class="line">        stringBuffer.append(last);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Double.parseDouble(stringBuffer.toString()) &gt; Integer.MAX_VALUE</span><br><span class="line">            || Double.parseDouble(stringBuffer.toString()) &lt; Integer.MIN_VALUE)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> Integer.parseInt(stringBuffer.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­å°†ç¬¦å·ä½å•ç‹¬æ‹¿å‡ºæ¥ï¼Œå› ä¸ºç¬¦å·ä½ä¸éœ€è¦åè½¬ã€‚ä½†åˆç‰ˆæ˜¯æœ‰bugçš„ï¼Œå‡½æ•°ä¼ å…¥çš„å‚æ•°æ˜¯intï¼Œè¿™è™½ç„¶èƒ½ä¿è¯åŸå§‹æ•°æ®ä¸è¶Šç•Œï¼Œä½†ä¸èƒ½ä¿è¯åè½¬ä¹‹åçš„æ•°å€¼ä¸è¶Šç•Œï¼Œæ‰€ä»¥æ­¤å¤„ç”¨doubleç±»å‹æ¥æ¥å—åè½¬ä¹‹åçš„æ•°å€¼ï¼Œç„¶åè¿›è¡Œåˆ¤æ–­æ˜¯å¦è¶Šç•Œã€‚</p><p>å…¶å®åˆ¤æ–­æ•°å€¼æ˜¯å¦è¶Šç•Œä¹Ÿä¸ç”¨è¿™ä¹ˆéº»çƒ¦ï¼Œå› ä¸º<em>ä¸€ä¸ªintæ•°å€¼è¶Šç•Œä¹‹åä¼šè¿”å›æ­£å¸¸ä½æ•°ä»¥å†…çš„æ•°å€¼</em>ã€‚é‚£ä¹ˆåˆ¤æ–­ä¸€ä¸ªintæ•°å€¼æ“ä½œçš„ç»“æœé›†æ˜¯å¦è¶Šç•Œåªéœ€åˆ¤æ–­æ“ä½œä¹‹åçš„ç»“æœå€¼æŒ‰ç…§<em>é€†æ“ä½œ</em>è€Œå¾—åˆ°çš„å€¼ä¸æ“ä½œä¹‹å‰çš„å€¼æ˜¯å¦ä¸€æ ·å°±å¯ä»¥äº†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">reverse</span><span class="params">(<span class="keyword">int</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> result = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (x != <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">int</span> tail = x % <span class="number">10</span>;</span><br><span class="line">        <span class="comment">// intæ“ä½œä¹‹åçš„å€¼å¦‚æœè¶Šç•Œæ€ä¹ˆå¤„ç†,ä»€ä¹ˆåŸåˆ™</span></span><br><span class="line">        <span class="keyword">int</span> newResult = result * <span class="number">10</span> + tail;</span><br><span class="line">        <span class="keyword">if</span> ((newResult - tail) / <span class="number">10</span> != result)</span><br><span class="line">        &#123; <span class="keyword">return</span> <span class="number">0</span>; &#125;</span><br><span class="line">        result = newResult;</span><br><span class="line">        x = x / <span class="number">10</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><p>intæœ€å¤§å€¼ä¸º<code>2147483647</code>ï¼Œç”¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸º<code>0111 1111 1111 1111 1111 1111 1111 1111</code>ï¼Œä½¿æœ€å¤§å€¼åŠ 1è¿ç®—ï¼Œå…¶ç»“æœç”¨äºŒè¿›åˆ¶è¡¨ç¤ºä¸º<code>1000 0000 0000 0000 0000 0000 0000 0000</code>ï¼Œç”±äºintçš„æœ€é«˜ä½æ˜¯ç¬¦å·ä½ï¼Œé‚£ä¹ˆè¿™ä¸ªç»“æœçš„æœ€é«˜ä½æ˜¯1ï¼Œç¼–ç ä¹‹åçš„å€¼ä¸º<code>-2147483648</code>ã€‚</p><p>å¦‚æœä¸è€ƒè™‘è¶Šç•Œ<code>2147483647 + 1</code>åº”è¯¥æ˜¯<code>2147483648</code>ï¼Œä½†æ˜¯è¶Šç•Œäº†ï¼ŒæŒ‰ç…§ç¼–ç è§„åˆ™ï¼Œ<code>2147483648</code>è¢«ç¼–ç ä¸º<code>-2147483648</code>ï¼Œé‚£ä¹ˆå°†<code>-2147483648</code>é€†è¿ç®—ä¹Ÿå°±æ˜¯å‡1å¾—åˆ°çš„ç»“æœè‚¯å®šä¸æ˜¯<code>2147483647</code></p>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> leetcode </tag>
            
            <tag> Reverse Integer </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode ZigZag Conversion</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20ZigZag%20Conversion.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20ZigZag%20Conversion.html</url>
      
        <content type="html"><![CDATA[<p>ZigZagè½¬æ¢å°±æ˜¯å°†å­—ç¬¦ä¸²æŒ‰ä¹‹å­—æ’åˆ—ï¼Œç„¶åæŒ‰è¡Œè¾“å‡ºã€‚å¦‚å­—ç¬¦ä¸²â€PAYPALISHIRINGâ€ï¼ŒZigZagè½¬æ¢ä¹‹åæ˜¯</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">P   A   H   N</span><br><span class="line">A P L S I I G</span><br><span class="line">Y   I   R</span><br></pre></td></tr></table></figure><p>æŒ‰è¡Œè¾“å‡ºä¹‹åçš„å­—ç¬¦ä¸²æ˜¯â€PAHNAPLSIIGYIRâ€ã€‚</p><p>ç”¨ç®—æ³•å®ç°ï¼Œå‚æ•°ä¸ºå­—ç¬¦ä¸²å’Œè¡Œæ•°ï¼Œè¿”å›æŒ‰è¡Œè¾“å‡ºçš„å­—ç¬¦ä¸²ã€‚</p><span id="more"></span><p>é¢˜ä¸­ç»™å‡ºäº†è¡Œæ•°æ˜¯å¥‡æ•°çš„æ’åˆ—æ–¹å¼ï¼Œé‚£ä¹ˆå…¶å¯¹ç«‹é¢å°±æ˜¯å¶æ•°ï¼Œå†™å‡ºå¶æ•°çš„æ’åˆ—æ–¹å¼</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">P     I     I</span><br><span class="line">A   L S   R N</span><br><span class="line">Y A   H I</span><br><span class="line">P     I</span><br></pre></td></tr></table></figure><p>ç„¶åç»“åˆå¥‡æ•°å’Œå¶æ•°çš„æ’åˆ—æ–¹å¼å¹¶æœª<em>æ¯ä¸ªå­—ç¬¦æŒ‰ç…§åœ¨åŸå­—ç¬¦ä¸²ä¸­çš„é¡ºåºæ ‡ä¸Šå·ä¹‹å</em>ï¼Œ<em>ï¼ˆå…¶å®ä½¿ç”¨æ•°å­—ä½œä¸ºå­—ç¬¦ä¸²è¿›è¡ŒZigZagè½¬æ¢çœ‹çš„æ›´æ¸…æ™°ï¼‰</em>å‘ç°å…¶æœ‰ä¸€ä¸ªæ•°å­¦è§„å¾‹ï¼Œæ¯ä¸¤ä¸ªä¸»åˆ—ä¸Šå­—ç¬¦ç´¢å¼•çš„å·®å€¼ä¸º2*row-2ï¼Œè€Œæ–œçº¿ä¸Šå­—ç¬¦çš„ç´¢å¼•ä¸éš¾çœ‹å‡ºæ˜¯<strong>ä¸‹ä¸€ä¸ªå­—ç¬¦çš„ç´¢å¼•å‡å»ä¸¤ä¸ªå½“å‰å­—ç¬¦æ‰€åœ¨è¡Œç´¢å¼•çš„å€¼</strong>ã€‚</p><p>å‘ç°è¿™ä¸ªæ™®éè§„å¾‹ä¹‹åå°±ä¸‡äº‹å¤§å‰ï¼Œå¯ä»¥å†™ä»£ç äº†å—ï¼Ÿ</p><p><strong>æˆ‘ä»¬å‘ç°äº†æ™®éçš„è§„å¾‹è¿˜åº”è¯¥å»å…³æ³¨ä¸‹ç‰¹æ®Šæƒ…å†µï¼Œä¹Ÿå°±æ˜¯å¸¸è¯´çš„è¾¹ç•Œå€¼</strong>ã€‚</p><p>è¾¹ç•Œå€¼è€ƒè™‘ï¼š</p><ul><li>ç¬¬ä¸€è¡Œå’Œæœ€åä¸€è¡Œä¸å­˜åœ¨æ–œçº¿ä¸Šçš„æ•°æ®</li><li>æœ€åçš„ä¸€ä¸ªä¹‹å­—å¯èƒ½ä¸å®Œæ•´ï¼Œå¦‚åªæœ‰æ–œçº¿ä¸Šçš„æ•°æ®</li></ul><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">convert</span><span class="params">(String str, <span class="keyword">int</span> numRows)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (numRows == <span class="number">1</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;numRows; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> ((str.length()-<span class="number">1</span>) &gt;= i) &#123;</span><br><span class="line">            stringBuffer.append(str.charAt(i));</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> index = i;</span><br><span class="line">        <span class="keyword">while</span> ((str.length()-<span class="number">1</span>) &gt;= (index+numRows+(numRows-<span class="number">2</span>)))&#123;</span><br><span class="line">            <span class="comment">// é¦–è¡Œ &amp;&amp; å°¾è¡Œ</span></span><br><span class="line">            <span class="comment">// æ³¨æ„è¾¹ç•Œå€¼</span></span><br><span class="line">            <span class="keyword">if</span> ((index+numRows+(numRows-<span class="number">2</span>) &gt; (index+numRows+(numRows-<span class="number">2</span>)-i-i)) &amp;&amp; ((index+numRows+(numRows-<span class="number">2</span>)-i-i) &gt; index) )&#123;</span><br><span class="line">                stringBuffer.append(str.charAt(index+numRows+(numRows-<span class="number">2</span>)-i-i));</span><br><span class="line">            &#125;</span><br><span class="line">            stringBuffer.append(str.charAt(index + numRows + (numRows - <span class="number">2</span>)));</span><br><span class="line">            index = index+numRows+(numRows-<span class="number">2</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (((str.length()-<span class="number">1</span>) &gt;= (index+numRows+(numRows-<span class="number">2</span>)-i-i)) &amp;&amp; ((index+numRows+(numRows-<span class="number">2</span>)-i-i) != index))&#123;</span><br><span class="line">            stringBuffer.append(str.charAt(index+numRows+(numRows-<span class="number">2</span>)-i-i));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•æ„Ÿè§‰å°±æ˜¯ç®€å•ç²—æš´ï¼Œä»æ’åˆ—ä¸­å½’çº³å‡ºè§„å¾‹ï¼ŒæŒ‰ç…§å…¬å¼è¿›è¡Œç¼–ç ã€‚</p><p>ä½†æ˜¯æ€»æ„Ÿè§‰åº”è¯¥æœ‰æ›´å¥½çš„æ–¹æ³•æˆ–è€…æ›´åŠ é«˜å¤§ä¸Šä¸€ç‚¹ï¼Œç„¶åå¹¶æ²¡æœ‰æ‰¾åˆ°ä»€ä¹ˆå¥½çš„ç®—æ³•ï¼Œæ™®ééƒ½æ˜¯è¿™ç§<em>åˆ©ç”¨è§„å¾‹</em>æ¥è§£ç­”ã€‚</p><p>å‰é¢è¯´æ²¡æœ‰å¥½çš„ç®—æ³•å¹¶ä¸ä»£è¡¨æ²¡æœ‰é‚£äº›ç‰¹ç«‹ç‹¬è¡Œçš„æ–¹æ³•ï¼Œå¦‚ä¸‹é¢è¿™ä¸ªå°±æ˜¯å¦‚æ­¤çš„<em>ç®€å•ç›´æ¥å’Œè‡ªä¿¡</em>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">conv</span><span class="params">(String str, <span class="keyword">int</span> row)</span></span>&#123;</span><br><span class="line">    StringBuffer[] sbArr = <span class="keyword">new</span> StringBuffer[row];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;row; i++)&#123;</span><br><span class="line">        sbArr[i] = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (i &lt; str.length())&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> rowIndex=<span class="number">0</span>;rowIndex&lt;row &amp;&amp; i&lt;str.length();rowIndex++)&#123;</span><br><span class="line">            sbArr[rowIndex].append(str.charAt(i++));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> rowIndex=row-<span class="number">2</span>;rowIndex&gt;=<span class="number">1</span> &amp;&amp; i&lt;str.length(); rowIndex--)&#123;</span><br><span class="line">            sbArr[rowIndex].append(str.charAt(i++));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> r=<span class="number">1</span>; r&lt;row; r++)&#123;</span><br><span class="line">        sbArr[<span class="number">0</span>].append(sbArr[r]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> sbArr[<span class="number">0</span>].toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¹‹æ‰€ä»¥è¯´è¿™ä¸ªä»£ç å†™å‡ºæ¥å¾ˆè‡ªä¿¡ï¼Œå°±è²Œä¼¼æœ‰äººè®©ä½ æ‰“å°10é<code>hello world</code>ï¼Œè€Œä½ å°±ç›´æ¥å†™äº†10éçš„<code>System.out.println(&quot;hello world&quot;);</code></p>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> leetcode </tag>
            
            <tag> igZag Conversion </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å®æ—¶æŠ“å–MySQLçš„æ›´æ–°æ•°æ®åˆ°Hadoop</title>
      <link href="/%E5%AE%9E%E6%97%B6%E6%8A%93%E5%8F%96MySQL%E7%9A%84%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%88%B0Hadoop.html"/>
      <url>/%E5%AE%9E%E6%97%B6%E6%8A%93%E5%8F%96MySQL%E7%9A%84%E6%9B%B4%E6%96%B0%E6%95%B0%E6%8D%AE%E5%88%B0Hadoop.html</url>
      
        <content type="html"><![CDATA[<p>å…³ç³»å‹æ•°æ®åº“å’ŒHadoopç”Ÿæ€çš„æ²Ÿé€šè¶Šæ¥è¶Šå¯†é›†ï¼Œæ—¶æ•ˆè¦æ±‚ä¹Ÿè¶Šæ¥è¶Šé«˜ã€‚æœ¬ç¯‡å°±æ¥è°ƒç ”ä¸‹å®æ—¶æŠ“å–MySQLæ›´æ–°æ•°æ®åˆ°HDFSã€‚</p><blockquote><p>æœ¬ç¯‡ä»…ä½œä¸ºè°ƒç ”æŠ¥å‘Šã€‚</p></blockquote><p>åˆæ­¥è°ƒç ”äº†canal(Ali)+kafka connect+kafkaã€maxwell(Zendesk)+kafkaå’Œmysql_streamer(Yelp)+kafkaã€‚<em>è¿™å‡ ä¸ªå·¥å…·æŠ“å–MySQLçš„æ–¹å¼éƒ½æ˜¯é€šè¿‡æ‰«æbinlogï¼Œæ¨¡æ‹ŸMySQL masterå’Œslave(Mysql Replicationæ¶æ„â€“è§£å†³äº†ï¼šæ•°æ®å¤šç‚¹å¤‡ä»½ï¼Œæé«˜æ•°æ®å¯ç”¨æ€§ï¼›è¯»å†™åˆ†æµï¼Œæé«˜é›†ç¾¤çš„å¹¶å‘èƒ½åŠ›ã€‚ï¼ˆå¹¶éæ˜¯è´Ÿè½½å‡è¡¡ï¼‰ï¼›è®©ä¸€äº›éå®æ—¶çš„æ•°æ®æ“ä½œï¼Œè½¬ç§»åˆ°slavesä¸Šè¿›è¡Œã€‚)ä¹‹é—´çš„åè®®æ¥å®ç°å®æ—¶æ›´æ–°çš„</em>ã€‚</p><span id="more"></span><p>å…ˆç§‘æ™®ä¸‹Canal</p><h2 id="Canalç®€ä»‹"><a href="#Canalç®€ä»‹" class="headerlink" title="Canalç®€ä»‹"></a>Canalç®€ä»‹</h2><h3 id="åŸç†"><a href="#åŸç†" class="headerlink" title="åŸç†"></a>åŸç†</h3><p><img src="/blogimgs/mysqlToHdfs/canal%E5%8E%9F%E7%90%86%E5%9B%BE.jpg" alt="CanalåŸç†å›¾" title="CanalåŸç†å›¾"><br>åŸç†ç›¸å¯¹æ¯”è¾ƒç®€å•ï¼š</p><ol><li>canalæ¨¡æ‹Ÿmysql slaveçš„äº¤äº’åè®®ï¼Œä¼ªè£…è‡ªå·±ä¸ºmysql slaveï¼Œå‘mysql masterå‘é€dumpåè®®</li><li>mysql masteræ”¶åˆ°dumpè¯·æ±‚ï¼Œå¼€å§‹æ¨é€(<em>slaveæ‹‰å–ï¼Œä¸æ˜¯masterä¸»åŠ¨pushç»™slaves</em>)binary logç»™slave(ä¹Ÿå°±æ˜¯canal)</li><li>canalè§£æbinary logå¯¹è±¡(åŸå§‹ä¸ºbyteæµ)</li></ol><h3 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h3><p><img src="/blogimgs/mysqlToHdfs/canal%E6%9E%B6%E6%9E%84%E5%9B%BE.jpg" alt="Canalæ¶æ„å›¾" title="Canalæ¶æ„å›¾"></p><p>ç»„ä»¶è¯´æ˜ï¼š</p><ol><li>serverä»£è¡¨ä¸€ä¸ªcanalè¿è¡Œå®ä¾‹ï¼Œå¯¹åº”äºä¸€ä¸ªjvm</li><li>instanceå¯¹åº”äºä¸€ä¸ªæ•°æ®é˜Ÿåˆ—(1ä¸ªserverå¯¹åº”1..nä¸ªinstance)</li></ol><p>è€Œinstanceæ¨¡å—åˆç”±eventParser(æ•°æ®æºæ¥å…¥ï¼Œæ¨¡æ‹Ÿslaveåè®®å’Œmasterè¿›è¡Œäº¤äº’ï¼Œåè®®è§£æ)ã€eventSink(Parserå’ŒStoreè¿æ¥å™¨ï¼Œè¿›è¡Œæ•°æ®è¿‡æ»¤ï¼ŒåŠ å·¥ï¼Œåˆ†å‘çš„å·¥ä½œ)ã€eventStore(æ•°æ®å­˜å‚¨)å’ŒmetaManager(å¢é‡è®¢é˜…&amp;æ¶ˆè´¹ä¿¡æ¯ç®¡ç†å™¨)ç»„æˆã€‚</p><ul><li><p>EventParseråœ¨å‘mysqlå‘é€dumpå‘½ä»¤ä¹‹å‰ä¼šå…ˆä»Log Positionä¸­è·å–ä¸Šæ¬¡è§£ææˆåŠŸçš„ä½ç½®(å¦‚æœæ˜¯ç¬¬ä¸€æ¬¡å¯åŠ¨ï¼Œåˆ™<strong>è·å–åˆå§‹æŒ‡å®šä½ç½®</strong>æˆ–è€…å½“å‰æ•°æ®æ®µbinlogä½ç‚¹)ã€‚mysqlæ¥å—åˆ°dumpå‘½ä»¤åï¼Œç”±EventParserä»mysqlä¸Špull binlogæ•°æ®è¿›è¡Œè§£æå¹¶ä¼ é€’ç»™EventSink(<em>ä¼ é€’ç»™EventSinkæ¨¡å—è¿›è¡Œæ•°æ®å­˜å‚¨ï¼Œæ˜¯ä¸€ä¸ªé˜»å¡æ“ä½œï¼Œç›´åˆ°å­˜å‚¨æˆåŠŸ</em>)ï¼Œä¼ é€æˆåŠŸä¹‹åæ›´æ–°Log Positionã€‚æµç¨‹å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/mysqlToHdfs/eventParser.jpg" alt="EventParseræµç¨‹å›¾" title="EventParseræµç¨‹å›¾"></p></li><li><p>EventSinkèµ·åˆ°ä¸€ä¸ªç±»ä¼¼channelçš„åŠŸèƒ½ï¼Œå¯ä»¥å¯¹æ•°æ®è¿›è¡Œ<em>è¿‡æ»¤ã€åˆ†å‘/è·¯ç”±(1:n)ã€å½’å¹¶(n:1)å’ŒåŠ å·¥</em>ã€‚EventSinkæ˜¯è¿æ¥EventParserå’ŒEventStoreçš„æ¡¥æ¢ã€‚</p></li><li><p>EventStoreå®ç°æ¨¡å¼æ˜¯å†…å­˜æ¨¡å¼ï¼Œå†…å­˜ç»“æ„ä¸ºç¯å½¢é˜Ÿåˆ—ï¼Œç”±ä¸‰ä¸ªæŒ‡é’ˆ(Putã€Getå’ŒAck)æ ‡è¯†æ•°æ®å­˜å‚¨å’Œè¯»å–çš„ä½ç½®ã€‚</p></li><li><p>MetaManageræ˜¯å¢é‡è®¢é˜…&amp;æ¶ˆè´¹ä¿¡æ¯ç®¡ç†å™¨ï¼Œå¢é‡è®¢é˜…å’Œæ¶ˆè´¹ä¹‹é—´çš„åè®®åŒ…æ‹¬get/ack/rollbackï¼Œåˆ†åˆ«ä¸ºï¼š</p></li></ul><blockquote><p>Message getWithoutAck(int batchSize)ï¼Œå…è®¸æŒ‡å®šbatchSizeï¼Œä¸€æ¬¡å¯ä»¥è·å–å¤šæ¡ï¼Œæ¯æ¬¡è¿”å›çš„å¯¹è±¡ä¸ºMessageï¼ŒåŒ…å«çš„å†…å®¹ä¸ºï¼šbatch id[å”¯ä¸€æ ‡è¯†]å’Œentries[å…·ä½“çš„æ•°æ®å¯¹è±¡]<br>void rollback(long batchId)ï¼Œé¡¾å‘½æ€è®®ï¼Œå›æ»šä¸Šæ¬¡çš„getè¯·æ±‚ï¼Œé‡æ–°è·å–æ•°æ®ã€‚åŸºäºgetè·å–çš„batchIdè¿›è¡Œæäº¤ï¼Œé¿å…è¯¯æ“ä½œ<br>void ack(long batchId)ï¼Œé¡¾å‘½æ€è®®ï¼Œç¡®è®¤å·²ç»æ¶ˆè´¹æˆåŠŸï¼Œé€šçŸ¥serveråˆ é™¤æ•°æ®ã€‚åŸºäºgetè·å–çš„batchIdè¿›è¡Œæäº¤ï¼Œé¿å…è¯¯æ“ä½œ</p></blockquote><p>å¢é‡è®¢é˜…å’Œæ¶ˆè´¹ä¹‹é—´çš„åè®®äº¤äº’å¦‚ä¸‹ï¼š<br><img src="/blogimgs/mysqlToHdfs/publishSubscribe.jpg" alt="å¢é‡è®¢é˜…å’Œæ¶ˆè´¹åè®®" title="å¢é‡è®¢é˜…å’Œæ¶ˆè´¹åè®®"></p><p>canalçš„get/ack/rollbackåè®®å’Œå¸¸è§„çš„jmsåè®®æœ‰æ‰€ä¸åŒï¼Œ<em>å…è®¸get/ackå¼‚æ­¥å¤„ç†</em>ï¼Œæ¯”å¦‚å¯ä»¥è¿ç»­è°ƒç”¨getå¤šæ¬¡ï¼Œåç»­å¼‚æ­¥æŒ‰é¡ºåºæäº¤ack/rollbackï¼Œé¡¹ç›®ä¸­ç§°ä¹‹ä¸ºæµå¼api.</p><p>æµå¼apiè®¾è®¡çš„å¥½å¤„ï¼š</p><ul><li>get/ackå¼‚æ­¥åŒ–ï¼Œå‡å°‘å› ackå¸¦æ¥çš„ç½‘ç»œå»¶è¿Ÿå’Œæ“ä½œæˆæœ¬ (99%çš„çŠ¶æ€éƒ½æ˜¯å¤„äºæ­£å¸¸çŠ¶æ€ï¼Œå¼‚å¸¸çš„rollbackå±äºä¸ªåˆ«æƒ…å†µï¼Œæ²¡å¿…è¦ä¸ºä¸ªåˆ«çš„caseç‰ºç‰²æ•´ä¸ªæ€§èƒ½)</li><li>getè·å–æ•°æ®åï¼Œä¸šåŠ¡æ¶ˆè´¹å­˜åœ¨ç“¶é¢ˆæˆ–è€…éœ€è¦å¤šè¿›ç¨‹/å¤šçº¿ç¨‹æ¶ˆè´¹æ—¶ï¼Œå¯ä»¥ä¸åœçš„è½®è¯¢getæ•°æ®ï¼Œä¸åœçš„å¾€åå‘é€ä»»åŠ¡ï¼Œæé«˜å¹¶è¡ŒåŒ–. (åœ¨å®é™…ä¸šåŠ¡ä¸­çš„ä¸€ä¸ªcaseï¼šä¸šåŠ¡æ•°æ®æ¶ˆè´¹éœ€è¦è·¨ä¸­ç¾ç½‘ç»œï¼Œæ‰€ä»¥ä¸€æ¬¡æ“ä½œåŸºæœ¬åœ¨200msä»¥ä¸Šï¼Œä¸ºäº†å‡å°‘å»¶è¿Ÿï¼Œæ‰€ä»¥éœ€è¦å®æ–½å¹¶è¡ŒåŒ–)</li></ul><p>æµå¼apiè®¾è®¡ç¤ºæ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/mysqlToHdfs/%E6%B5%81%E5%BC%8Fapi.jpg" alt="æµå¼api" title="æµå¼api"></p><ul><li>æ¯æ¬¡getæ“ä½œéƒ½ä¼šåœ¨metaä¸­äº§ç”Ÿä¸€ä¸ªmarkï¼Œmarkæ ‡è®°ä¼šé€’å¢ï¼Œä¿è¯è¿è¡Œè¿‡ç¨‹ä¸­markçš„å”¯ä¸€æ€§</li><li>æ¯æ¬¡çš„getæ“ä½œï¼Œéƒ½ä¼šåœ¨ä¸Šä¸€æ¬¡çš„markæ“ä½œè®°å½•çš„cursorç»§ç»­å¾€åå–ï¼Œå¦‚æœmarkä¸å­˜åœ¨ï¼Œåˆ™åœ¨last ack cursorç»§ç»­å¾€åå–</li><li>è¿›è¡Œackæ—¶ï¼Œéœ€è¦æŒ‰ç…§markçš„é¡ºåºè¿›è¡Œæ•°åºackï¼Œä¸èƒ½è·³è·ƒack. ackä¼šåˆ é™¤å½“å‰çš„markæ ‡è®°ï¼Œå¹¶å°†å¯¹åº”çš„markä½ç½®æ›´æ–°ä¸ºlast ack cusor</li><li>ä¸€æ—¦å‡ºç°å¼‚å¸¸æƒ…å†µï¼Œå®¢æˆ·ç«¯å¯å‘èµ·rollbackæƒ…å†µï¼Œé‡æ–°ç½®ä½ï¼šåˆ é™¤æ‰€æœ‰çš„mark, æ¸…ç†getè¯·æ±‚ä½ç½®ï¼Œä¸‹æ¬¡è¯·æ±‚ä¼šä»last ack cursorç»§ç»­å¾€åå–</li></ul><blockquote><p>è¿™ä¸ªæµå¼apiæ˜¯ä¸æ˜¯ç±»ä¼¼hdfs writeåœ¨pipelineä¸­ä¼ è¾“packetçš„å½¢å¼ï¼Œå…ˆå°†packetæ”¾å…¥dataQueueï¼Œç„¶åå‘ä¸‹æ¸¸ä¼ è¾“ï¼Œæ­¤æ—¶å°†packetæ”¾å…¥ackQueueç­‰åˆ°ä¸‹æ¸¸è¿”å›çš„ackï¼Œè¿™ä¹Ÿæ˜¯å¼‚æ­¥çš„ã€‚</p></blockquote><h3 id="HAæœºåˆ¶"><a href="#HAæœºåˆ¶" class="headerlink" title="HAæœºåˆ¶"></a>HAæœºåˆ¶</h3><p>canalæ˜¯æ”¯æŒHAçš„ï¼Œå…¶å®ç°æœºåˆ¶ä¹Ÿæ˜¯ä¾èµ–zookeeperæ¥å®ç°çš„ï¼Œç”¨åˆ°çš„ç‰¹æ€§æœ‰watcherå’ŒEPHEMERALèŠ‚ç‚¹(å’Œsessionç”Ÿå‘½å‘¨æœŸç»‘å®š)ï¼Œä¸HDFSçš„HAç±»ä¼¼ã€‚</p><p>canalçš„haåˆ†ä¸ºä¸¤éƒ¨åˆ†ï¼Œ<em>canal serverå’Œcanal clientåˆ†åˆ«æœ‰å¯¹åº”çš„haå®ç°</em></p><ul><li>canal server: ä¸ºäº†å‡å°‘å¯¹mysql dumpçš„è¯·æ±‚ï¼Œ<em>ä¸åŒ</em>serverä¸Šçš„instance(<em>ä¸åŒserverä¸Šçš„ç›¸åŒinstance</em>)è¦æ±‚åŒä¸€æ—¶é—´åªèƒ½æœ‰ä¸€ä¸ªå¤„äºrunningï¼Œå…¶ä»–çš„å¤„äºstandbyçŠ¶æ€(standbyæ˜¯instanceçš„çŠ¶æ€)ã€‚</li><li><em>canal client</em>: ä¸ºäº†ä¿è¯æœ‰åºæ€§ï¼Œä¸€ä»½instanceåŒä¸€æ—¶é—´åªèƒ½ç”±ä¸€ä¸ªcanal clientè¿›è¡Œget/ack/rollbackæ“ä½œï¼Œå¦åˆ™å®¢æˆ·ç«¯æ¥æ”¶æ— æ³•ä¿è¯æœ‰åºã€‚</li></ul><p>server haçš„æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/mysqlToHdfs/ha.jpg" alt="ha" title="ha"><br>å¤§è‡´æ­¥éª¤ï¼š</p><ol><li>canal serverè¦å¯åŠ¨æŸä¸ª<em>canal instance</em>æ—¶éƒ½å…ˆå‘zookeeper_è¿›è¡Œä¸€æ¬¡å°è¯•å¯åŠ¨åˆ¤æ–­_(å®ç°ï¼šåˆ›å»ºEPHEMERALèŠ‚ç‚¹ï¼Œè°åˆ›å»ºæˆåŠŸå°±å…è®¸è°å¯åŠ¨)</li><li>åˆ›å»ºzookeeperèŠ‚ç‚¹æˆåŠŸåï¼Œå¯¹åº”çš„canal serverå°±å¯åŠ¨å¯¹åº”çš„canal instanceï¼Œ_æ²¡æœ‰åˆ›å»ºæˆåŠŸçš„canal instanceå°±ä¼šå¤„äºstandbyçŠ¶æ€_ã€‚</li><li>ä¸€æ—¦zookeeperå‘ç°canal server Aåˆ›å»ºçš„_instanceèŠ‚ç‚¹_æ¶ˆå¤±åï¼Œç«‹å³é€šçŸ¥å…¶ä»–çš„canal serverå†æ¬¡è¿›è¡Œæ­¥éª¤1çš„æ“ä½œï¼Œé‡æ–°é€‰å‡ºä¸€ä¸ªcanal serverå¯åŠ¨instanceã€‚</li><li>canal clientæ¯æ¬¡è¿›è¡Œconnectæ—¶ï¼Œä¼šé¦–å…ˆå‘zookeeperè¯¢é—®å½“å‰æ˜¯è°å¯åŠ¨äº†canal instanceï¼Œç„¶åå’Œå…¶å»ºç«‹é“¾æ¥ï¼Œä¸€æ—¦é“¾æ¥ä¸å¯ç”¨ï¼Œä¼šé‡æ–°å°è¯•connectã€‚</li></ol><p><strong>Canal Clientçš„æ–¹å¼å’Œcanal serveræ–¹å¼ç±»ä¼¼ï¼Œä¹Ÿæ˜¯åˆ©ç”¨zookeeperçš„æŠ¢å EPHEMERALèŠ‚ç‚¹çš„æ–¹å¼è¿›è¡Œæ§åˆ¶.</strong></p><h2 id="Canaléƒ¨ç½²åŠä½¿ç”¨"><a href="#Canaléƒ¨ç½²åŠä½¿ç”¨" class="headerlink" title="Canaléƒ¨ç½²åŠä½¿ç”¨"></a>Canaléƒ¨ç½²åŠä½¿ç”¨</h2><h3 id="MySQLé…ç½®"><a href="#MySQLé…ç½®" class="headerlink" title="MySQLé…ç½®"></a>MySQLé…ç½®</h3><p>canalåŒæ­¥æ•°æ®éœ€è¦æ‰«æMySQLçš„binlogæ—¥å¿—ï¼Œè€Œbinlogé»˜è®¤æ˜¯å…³é—­çš„ï¼Œéœ€è¦å¼€å¯ï¼Œå¹¶ä¸”ä¸ºäº†ä¿è¯<em>åŒæ­¥æ•°æ®çš„ä¸€è‡´æ€§</em>ï¼Œä½¿ç”¨çš„æ—¥å¿—æ ¼å¼ä¸º*row-based replication(RBR)*ï¼Œåœ¨<code>my.conf</code>ä¸­å¼€å¯binlogï¼Œ</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">log-bin=mysql-bin <span class="comment">#æ·»åŠ è¿™ä¸€è¡Œå°±ok</span></span><br><span class="line"><span class="comment"># log-bin=/data/mysql/logs/mysql-bin.log # æŒ‡å®šlogåœ°å€</span></span><br><span class="line">binlog-format=ROW <span class="comment">#é€‰æ‹©rowæ¨¡å¼</span></span><br><span class="line">server_id=1 <span class="comment">#é…ç½®mysql replactionéœ€è¦å®šä¹‰ï¼Œä¸èƒ½å’Œcanalçš„slaveIdé‡å¤</span></span><br><span class="line"></span><br><span class="line"><span class="comment">######</span></span><br><span class="line">server_id=1</span><br><span class="line">log_bin=mysql-bin</span><br><span class="line">binlog_format=ROW</span><br><span class="line">expire_logs_days=30</span><br><span class="line">binlog_do_db=db_a</span><br><span class="line">binlog_do_db=db_b</span><br><span class="line"></span><br><span class="line"><span class="comment">#server_idï¼šMySQL5.7åŠä»¥ä¸Šç‰ˆæœ¬å¼€å¯binlogå¿…é¡»è¦é…ç½®è¿™ä¸ªé€‰é¡¹ã€‚å¯¹äºMySQLé›†ç¾¤ï¼Œä¸åŒèŠ‚ç‚¹çš„server_idå¿…é¡»ä¸åŒã€‚å¯¹äºå•å®ä¾‹éƒ¨ç½²åˆ™æ²¡æœ‰è¦æ±‚ã€‚</span></span><br><span class="line"><span class="comment">#log_binï¼šæŒ‡å®šbinlogæ–‡ä»¶åå’Œå‚¨å­˜ä½ç½®ã€‚å¦‚æœä¸æŒ‡å®šè·¯å¾„ï¼Œé»˜è®¤ä½ç½®ä¸º/var/lib/mysql/ã€‚</span></span><br><span class="line"><span class="comment">#binlog_formatï¼šbinlogæ ¼å¼ã€‚æœ‰3ä¸ªå€¼å¯ä»¥é€‰æ‹©ï¼šROWï¼šè®°å½•å“ªæ¡æ•°æ®è¢«ä¿®æ”¹å’Œä¿®æ”¹ä¹‹åçš„æ•°æ®ï¼Œä¼šäº§ç”Ÿå¤§é‡æ—¥å¿—ã€‚STATEMENTï¼šè®°å½•ä¿®æ”¹æ•°æ®çš„SQLï¼Œæ—¥å¿—é‡è¾ƒå°ã€‚MIXEDï¼šæ··åˆä½¿ç”¨ä¸Šè¿°ä¸¤ä¸ªæ¨¡å¼ã€‚CDCè¦æ±‚å¿…é¡»é…ç½®ä¸ºROWã€‚</span></span><br><span class="line"><span class="comment">#expire_logs_daysï¼šbin_logè¿‡æœŸæ—¶é—´ï¼Œè¶…è¿‡è¯¥æ—¶é—´çš„logä¼šè‡ªåŠ¨åˆ é™¤ã€‚</span></span><br><span class="line"><span class="comment">#binlog_do_dbï¼šbinlogè®°å½•å“ªäº›æ•°æ®åº“ã€‚å¦‚æœéœ€è¦é…ç½®å¤šä¸ªåº“ï¼Œå¦‚ä¾‹å­ä¸­é…ç½®å¤šé¡¹ã€‚åˆ‡å‹¿ä½¿ç”¨é€—å·åˆ†éš”ã€‚</span></span><br><span class="line"></span><br><span class="line">show variables like <span class="string">&#x27;%bin%&#x27;</span>;</span><br></pre></td></tr></table></figure><p>æ›´æ”¹my.confä¹‹åï¼Œéœ€è¦<em>é‡å¯MySQL</em>ï¼Œé‡å¯çš„æ–¹å¼æœ‰å¾ˆå¤šæ‰¾åˆ°åˆé€‚è‡ªå·±çš„å°±è¡Œã€‚</p><h3 id="Canalé…ç½®"><a href="#Canalé…ç½®" class="headerlink" title="Canalé…ç½®"></a>Canalé…ç½®</h3><p>ç”±ä¸Šé¢çš„ä»‹ç»å¾—çŸ¥Canalç”±<code>Server</code>å’Œ<code>Instance</code>ç»„æˆï¼Œè€ŒServerä¸­åˆå¯ä»¥åŒ…å«å¾ˆå¤šä¸ªInstanceï¼Œ<em>ä¸€ä¸ªInstanceå¯¹åº”ä¸€ä¸ªæ•°æ®åº“å®ä¾‹</em>ï¼Œåˆ™Canalå°†é…ç½®åˆ†ä¸ºä¸¤ç±»ï¼Œä¸€ç±»æ˜¯serverçš„é…ç½®ï¼Œåå­—ä¸º<code>canal.properties</code>ï¼Œå¦ä¸€ç±»æ˜¯instanceçš„é…ç½®ï¼Œåå­—ä¸º<code>instance.properties</code>ï¼Œä¸€èˆ¬ä¼šåœ¨confç›®å½•ä¸‹æ–°å»ºä¸€ä¸ªinstanceåŒåçš„ç›®å½•ï¼Œå°†å…¶æ”¾å…¥æ­¤ç›®å½•ä¸­ã€‚</p><p>å…ˆä»‹ç»canal.propertiesä¸­çš„å‡ ä¸ªå…³é”®å±æ€§</p><table><thead><tr><th>å‚æ•°åå­—</th><th>å‚æ•°è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>canal.destinations</td><td>å½“å‰serverä¸Šéƒ¨ç½²çš„instanceåˆ—è¡¨</td><td>æ— </td></tr><tr><td>canal.conf.dir</td><td>conf/ç›®å½•æ‰€åœ¨çš„è·¯å¾„</td><td>../conf</td></tr><tr><td>canal.instance.global.spring.xml</td><td>å…¨å±€çš„springé…ç½®æ–¹å¼çš„ç»„ä»¶æ–‡ä»¶</td><td>classpath:spring/file-instance.xml <br> (springç›®å½•ç›¸å¯¹äºcanal.conf.dir)</td></tr><tr><td>canal.zkServers</td><td>canal serveré“¾æ¥zookeeperé›†ç¾¤çš„é“¾æ¥ä¿¡æ¯</td><td>æ— </td></tr><tr><td>canal.zookeeper.flush.period</td><td>canalæŒä¹…åŒ–æ•°æ®åˆ°zookeeperä¸Šçš„æ›´æ–°é¢‘ç‡ï¼Œå•ä½æ¯«ç§’</td><td>1000</td></tr><tr><td>canal.file.data.dir</td><td>canalæŒä¹…åŒ–æ•°æ®åˆ°fileä¸Šçš„ç›®å½•</td><td>../conf (é»˜è®¤å’Œinstance.propertiesä¸ºåŒä¸€ç›®å½•ï¼Œæ–¹ä¾¿è¿ç»´å’Œå¤‡ä»½)</td></tr><tr><td>canal.file.flush.period</td><td>canalæŒä¹…åŒ–æ•°æ®åˆ°fileä¸Šçš„æ›´æ–°é¢‘ç‡ï¼Œå•ä½æ¯«ç§’</td><td>1000</td></tr><tr><td>canal.instance.memory.batch.mode</td><td>canalå†…å­˜storeä¸­æ•°æ®ç¼“å­˜æ¨¡å¼ <br> 1. ITEMSIZE : æ ¹æ®buffer.sizeè¿›è¡Œé™åˆ¶ï¼Œåªé™åˆ¶è®°å½•çš„æ•°é‡ <br> 2. MEMSIZE : æ ¹æ®buffer.size * buffer.memunitçš„å¤§å°ï¼Œé™åˆ¶ç¼“å­˜è®°å½•çš„å¤§å°</td><td>MEMSIZE</td></tr><tr><td>canal.instance.memory.buffer.size</td><td>canalå†…å­˜storeä¸­å¯ç¼“å­˜bufferè®°å½•æ•°ï¼Œéœ€è¦ä¸º2çš„æŒ‡æ•°</td><td>16384</td></tr><tr><td>canal.instance.memory.buffer.memunit</td><td>å†…å­˜è®°å½•çš„å•ä½å¤§å°ï¼Œé»˜è®¤1KBï¼Œå’Œbuffer.sizeç»„åˆå†³å®šæœ€ç»ˆçš„å†…å­˜ä½¿ç”¨å¤§å°</td><td>1024</td></tr></tbody></table><p>ä¸‹é¢çœ‹ä¸‹instance.propertiesï¼Œè¿™é‡Œçš„å±æ€§è¾ƒå°‘ï¼š</p><table><thead><tr><th>å‚æ•°åå­—</th><th>å‚æ•°è¯´æ˜</th><th>é»˜è®¤å€¼</th></tr></thead><tbody><tr><td>canal.instance.mysql.slaveId</td><td>mysqlé›†ç¾¤é…ç½®ä¸­çš„serverIdæ¦‚å¿µï¼Œéœ€è¦ä¿è¯å’Œå½“å‰mysqlé›†ç¾¤ä¸­idå”¯ä¸€</td><td>1234</td></tr><tr><td>canal.instance.master.address</td><td>mysqlä¸»åº“é“¾æ¥åœ°å€</td><td>127.0.0.1:3306</td></tr><tr><td>canal.instance.master.journal.name</td><td>mysqlä¸»åº“é“¾æ¥æ—¶èµ·å§‹çš„binlogæ–‡ä»¶</td><td>æ— </td></tr><tr><td>canal.instance.master.position</td><td>mysqlä¸»åº“é“¾æ¥æ—¶èµ·å§‹çš„binlogåç§»é‡</td><td>æ— </td></tr><tr><td>canal.instance.master.timestamp</td><td>mysqlä¸»åº“é“¾æ¥æ—¶èµ·å§‹çš„binlogçš„æ—¶é—´æˆ³</td><td>æ— </td></tr><tr><td>canal.instance.dbUsername</td><td>mysqlæ•°æ®åº“å¸å·</td><td>canal</td></tr><tr><td>canal.instance.dbPassword</td><td>mysqlæ•°æ®åº“å¯†ç </td><td>canal</td></tr><tr><td>canal.instance.defaultDatabaseName</td><td>mysqlé“¾æ¥æ—¶é»˜è®¤schema</td><td>æ— </td></tr><tr><td>canal.instance.connectionCharset</td><td>mysql æ•°æ®è§£æç¼–ç </td><td>UTF-8</td></tr><tr><td>canal.instance.filter.regex</td><td>mysql æ•°æ®è§£æå…³æ³¨çš„è¡¨ï¼ŒPerlæ­£åˆ™è¡¨è¾¾å¼. <br> å¤šä¸ªæ­£åˆ™ä¹‹é—´ä»¥é€—å·(,)åˆ†éš”ï¼Œè½¬ä¹‰ç¬¦éœ€è¦åŒæ–œæ </td><td>.*\\..*</td></tr></tbody></table><p>é™¤äº†ä¸Šé¢ä¸¤ä¸ªé…ç½®æ–‡ä»¶ï¼Œconfç›®å½•ä¸‹è¿˜æœ‰ä¸€ä¸ªç›®å½•éœ€è¦å¼ºè°ƒä¸‹ï¼Œé‚£å°±æ˜¯springç›®å½•ï¼Œé‡Œé¢å­˜æ”¾çš„æ˜¯instance.xmlé…ç½®æ–‡ä»¶ï¼Œç›®å‰é»˜è®¤æ”¯æŒçš„instance.xmlæœ‰<em>memory-instance.xmlã€file-instance.xmlã€default-instance.xmlå’Œgroup-instance.xml</em>ã€‚è¿™é‡Œä¸»è¦ç»´æŠ¤çš„å¢é‡è®¢é˜…å’Œæ¶ˆè´¹çš„å…³ç³»ä¿¡æ¯(<em>è§£æä½ç‚¹å’Œæ¶ˆè´¹ä½ç‚¹</em>)ã€‚</p><p>å¯¹åº”çš„ä¸¤ä¸ªä½ç‚¹ç»„ä»¶ï¼Œç›®å‰éƒ½æœ‰å‡ ç§å®ç°ï¼š</p><ul><li>memory (memory-instance.xmlä¸­ä½¿ç”¨)</li><li>zookeeper</li><li>mixed</li><li>file (file-instance.xmlä¸­ä½¿ç”¨ï¼Œé›†åˆäº†file+memoryæ¨¡å¼ï¼Œå…ˆå†™å†…å­˜ï¼Œå®šæ—¶åˆ·æ–°æ•°æ®åˆ°æœ¬åœ°fileä¸Š)</li><li>period (default-instance.xmlä¸­ä½¿ç”¨ï¼Œé›†åˆäº†zookeeper+memoryæ¨¡å¼ï¼Œå…ˆå†™å†…å­˜ï¼Œå®šæ—¶åˆ·æ–°æ•°æ®åˆ°zookeeperä¸Š)</li></ul><blockquote><p>åˆ†åˆ«ä»‹ç»ä¸‹è¿™å‡ ç§é…ç½®çš„åŠŸèƒ½</p></blockquote><ul><li>memory-instance.xmlï¼š</li></ul><p><em>æ‰€æœ‰çš„ç»„ä»¶(parser , sink , store)éƒ½é€‰æ‹©äº†å†…å­˜ç‰ˆæ¨¡å¼</em>ï¼Œè®°å½•ä½ç‚¹çš„éƒ½é€‰æ‹©äº†memoryæ¨¡å¼ï¼Œé‡å¯ååˆä¼šå›åˆ°åˆå§‹ä½ç‚¹è¿›è¡Œè§£æ</p><p>ç‰¹ç‚¹ï¼šé€Ÿåº¦æœ€å¿«ï¼Œä¾èµ–æœ€å°‘(ä¸éœ€è¦zookeeper)</p><p>åœºæ™¯ï¼šä¸€èˆ¬åº”ç”¨åœ¨quickstartï¼Œæˆ–è€…æ˜¯å‡ºç°é—®é¢˜åï¼Œè¿›è¡Œæ•°æ®åˆ†æçš„åœºæ™¯ï¼Œä¸åº”è¯¥å°†å…¶åº”ç”¨äºç”Ÿäº§ç¯å¢ƒ</p><ul><li>file-instance.xmlï¼š</li></ul><p>æ‰€æœ‰çš„ç»„ä»¶(parser , sink , store)éƒ½é€‰æ‹©äº†åŸºäºfileæŒä¹…åŒ–æ¨¡å¼(<em>ç»„ä»¶å†…å®¹æŒä¹…åŒ–çš„fileå­˜åœ¨å“ªé‡Œï¼Ÿï¼Ÿï¼Ÿ</em>)ï¼Œæ³¨æ„ï¼Œä¸æ”¯æŒHAæœºåˆ¶.</p><p>ç‰¹ç‚¹ï¼šæ”¯æŒå•æœºæŒä¹…åŒ–</p><p>åœºæ™¯ï¼šç”Ÿäº§ç¯å¢ƒï¼Œæ— HAéœ€æ±‚ï¼Œç®€å•å¯ç”¨.</p><ul><li>default-instance.xmlï¼š</li></ul><p>æ‰€æœ‰çš„ç»„ä»¶(parser , sink , store)éƒ½é€‰æ‹©äº†æŒä¹…åŒ–æ¨¡å¼ï¼Œç›®å‰æŒä¹…åŒ–çš„æ–¹å¼ä¸»è¦æ˜¯å†™å…¥zookeeperï¼Œä¿è¯æ•°æ®é›†ç¾¤å…±äº«.(<em>æ‰€æœ‰ç»„ä»¶æŒä¹…åŒ–çš„å†…å®¹åªæœ‰ä½ç½®ä¿¡æ¯å§ï¼Ÿï¼Ÿï¼Ÿ</em>)</p><p>ç‰¹ç‚¹ï¼šæ”¯æŒHA</p><p>åœºæ™¯ï¼šç”Ÿäº§ç¯å¢ƒï¼Œé›†ç¾¤åŒ–éƒ¨ç½².</p><ul><li>group-instance.xmlï¼š</li></ul><p>ä¸»è¦é’ˆå¯¹éœ€è¦è¿›è¡Œå¤šåº“åˆå¹¶æ—¶ï¼Œå¯ä»¥å°†å¤šä¸ªç‰©ç†instanceåˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘instanceï¼Œæä¾›å®¢æˆ·ç«¯è®¿é—®ã€‚</p><p>åœºæ™¯ï¼šåˆ†åº“ä¸šåŠ¡ã€‚ æ¯”å¦‚äº§å“æ•°æ®æ‹†åˆ†äº†4ä¸ªåº“ï¼Œæ¯ä¸ªåº“ä¼šæœ‰ä¸€ä¸ªinstanceï¼Œå¦‚æœä¸ç”¨groupï¼Œä¸šåŠ¡ä¸Šè¦æ¶ˆè´¹æ•°æ®æ—¶ï¼Œéœ€è¦å¯åŠ¨4ä¸ªå®¢æˆ·ç«¯ï¼Œåˆ†åˆ«é“¾æ¥4ä¸ªinstanceå®ä¾‹ã€‚ä½¿ç”¨groupåï¼Œå¯ä»¥åœ¨canal serverä¸Šåˆå¹¶ä¸ºä¸€ä¸ªé€»è¾‘instanceï¼Œåªéœ€è¦å¯åŠ¨1ä¸ªå®¢æˆ·ç«¯ï¼Œé“¾æ¥è¿™ä¸ªé€»è¾‘instanceå³å¯.</p><h3 id="canal-example-éƒ¨ç½²"><a href="#canal-example-éƒ¨ç½²" class="headerlink" title="canal example éƒ¨ç½²"></a>canal example éƒ¨ç½²</h3><ul><li>åœ¨éœ€è¦åŒæ­¥çš„MySQLæ•°æ®åº“ä¸­åˆ›å»ºä¸€ä¸ªç”¨æˆ·ï¼Œç”¨æ¥replicaæ•°æ®ï¼Œè¿™é‡Œæ–°å»ºçš„ç”¨æˆ·åå’Œå¯†ç éƒ½ä¸º<code>canal</code>ï¼Œå‘½ä»¤å¦‚ä¸‹ï¼š</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE USER canal IDENTIFIED BY <span class="string">&#x27;canal&#x27;</span>;  </span><br><span class="line">GRANT SELECT, REPLICATION SLAVE, REPLICATION CLIENT ON *.* TO <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span>;</span><br><span class="line">-- GRANT ALL PRIVILEGES ON *.* TO <span class="string">&#x27;canal&#x27;</span>@<span class="string">&#x27;%&#x27;</span> ;</span><br><span class="line">FLUSH PRIVILEGES;</span><br></pre></td></tr></table></figure><ul><li>Mysqlåˆ›å»º<code>canal</code>ç”¨æˆ·å¹¶ä¸ºå…¶èµ‹æ‰€éœ€æƒé™ä¹‹åï¼Œéœ€è¦å¯¹Canalçš„é…ç½®æ–‡ä»¶(<em>canal.propertieså’Œinstance.properties</em>)è¿›è¡Œè®¾ç½®ã€‚</li></ul><p>canal.propertieså’Œinstance.propertiesé‡Œé‡‡ç”¨é»˜è®¤é…ç½®å³å¯(<em>è¿™é‡Œåªæ˜¯è¿è¡Œä¸ªæ ·ä¾‹ï¼Œç”Ÿäº§ä¸­å¯ä»¥å‚è€ƒå…·ä½“çš„å‚æ•°å±æ€§è¿›è¡Œè®¾ç½®</em>)ï¼Œ</p><ul><li>Canalé…ç½®å¥½ä¹‹åï¼Œå¯åŠ¨Canal client(<em>clientçš„ä½œç”¨æ˜¯å°†Canalé‡Œçš„è§£æçš„binlogæ—¥å¿—å›ºåŒ–åˆ°å­˜å‚¨ä»‹è´¨ä¸­</em>)ã€‚</li></ul><p>clientç»„ä»¶Canalæœ¬èº«æ˜¯ä¸æä¾›çš„ï¼Œéœ€è¦æ ¹æ®apiè¿›è¡Œå¼€å‘ï¼Œè¿™é‡Œå°†å®˜æ–¹æä¾›çš„clientä»£ç æ‰“åŒ…æˆjarè¿›è¡Œæ¶ˆè´¹Canalä¿¡æ¯ã€‚</p><h3 id="canal-HAé…ç½®"><a href="#canal-HAé…ç½®" class="headerlink" title="canal HAé…ç½®"></a>canal HAé…ç½®</h3><p>canalçš„HAæœºåˆ¶æ˜¯ä¾èµ–zkæ¥å®ç°çš„ï¼Œéœ€è¦æ›´æ”¹canal.propertiesæ–‡ä»¶ï¼Œä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># zké›†ç¾¤åœ°å€</span></span><br><span class="line">canal.zkServers=10.20.144.51:2181</span><br><span class="line"><span class="comment"># é€‰æ‹©è®°å½•æ–¹å¼</span></span><br><span class="line">canal.instance.global.spring.xml = classpath:spring/default-instance.xml</span><br></pre></td></tr></table></figure><p>æ›´æ”¹ä¸¤å°canalæœºå™¨ä¸Šinstanceå®ä¾‹çš„é…ç½®instance.propertiesï¼Œä¿®æ”¹å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">canal.instance.mysql.slaveId = 1234 <span class="comment">##å¦å¤–ä¸€å°æœºå™¨æ”¹æˆ1235ï¼Œä¿è¯slaveIdä¸é‡å¤å³å¯</span></span><br><span class="line">canal.instance.master.address = 10.20.144.15:3306</span><br></pre></td></tr></table></figure><p>é…ç½®å¥½ä¹‹åå¯åŠ¨canalè¿›ç¨‹ï¼Œåœ¨ä¸¤å°æœåŠ¡å™¨ä¸Šæ‰§è¡Œ<code>sh bin/startup.sh</code></p><p>clientè¿›è¡Œæ¶ˆè´¹æ—¶ï¼Œå¯ä»¥ç›´æ¥æŒ‡å®šzookeeperåœ°å€å’Œinstance nameï¼Œä¹Ÿå¯ä»¥è®©canal clientä¼šè‡ªåŠ¨ä»zookeeperä¸­çš„runningèŠ‚ç‚¹ï¼Œè·å–å½“å‰æœåŠ¡çš„å·¥ä½œèŠ‚ç‚¹ï¼Œç„¶åä¸å…¶å»ºç«‹é“¾æ¥ã€‚</p><h2 id="maxwellç®€ä»‹"><a href="#maxwellç®€ä»‹" class="headerlink" title="maxwellç®€ä»‹"></a>maxwellç®€ä»‹</h2><p>maxwellå®æ—¶æŠ“å–mysqlæ•°æ®çš„åŸç†ä¹Ÿæ˜¯åŸºäºbinlogï¼Œå’Œcanalç›¸æ¯”ï¼Œmaxwellæ›´åƒæ˜¯<code>canal server + å®æ—¶client</code>ã€‚(æ•°æ®æŠ½å– + æ•°æ®è½¬æ¢)</p><p>maxwellé›†æˆäº†kafka producerï¼Œç›´æ¥ä»binlogè·å–æ•°æ®æ›´æ–°å¹¶å†™å…¥kafkaï¼Œè€Œcanalåˆ™<strong>éœ€è¦è‡ªå·±å¼€å‘å®æ—¶clientå°†canalè¯»å–çš„binlogå†…å®¹å†™å…¥kafkaä¸­</strong>ã€‚</p><p>maxwellç‰¹è‰²ï¼š</p><ul><li>æ”¯æŒbootstrapå¯åŠ¨ï¼ŒåŒæ­¥å†å²æ•°æ®</li><li>é›†æˆkafkaï¼Œç›´æ¥å°†æ•°æ®è½åœ°åˆ°kafka</li><li>å·²å°†binlogä¸­çš„DMLå’ŒDDLè¿›è¡Œäº†æ¨¡å¼åŒ¹é…ï¼Œå°†å…¶è§£ç ä¸ºæœ‰schemaçš„json(<em>æœ‰åˆ©äºåæœŸå°†å…¶é‡ç»„ä¸ºnosqlæ”¯æŒçš„è¯­è¨€</em>)<br>{â€œdatabaseâ€:â€testâ€,â€tableâ€:â€eâ€,â€typeâ€:â€updateâ€,â€tsâ€:1488857869,â€xidâ€:8924,â€commitâ€:true,â€dataâ€:{â€œidâ€:1,â€mâ€:5.556666,â€torvaldsâ€:null},â€oldâ€:{â€œmâ€:5.55}}</li></ul><p>ç¼ºç‚¹ï¼š</p><ul><li>ä¸€ä¸ªMySQLå®ä¾‹éœ€è¦å¯¹åº”ä¸€ä¸ªmaxwellè¿›ç¨‹</li><li>bootstrapçš„æ–¹æ¡ˆä½¿ç”¨çš„æ˜¯<code>select * </code></li></ul><p>maxwellçš„é…ç½®æ–‡ä»¶åªæœ‰ä¸€ä¸ª<em>config.properties</em>ï¼Œåœ¨homeç›®å½•ã€‚å…¶ä¸­é™¤äº†éœ€è¦é…ç½®mysql masterçš„åœ°å€ã€kafkaåœ°å€è¿˜éœ€è¦é…ç½®ä¸€ä¸ªç”¨äºå­˜æ”¾maxwellç›¸å…³ä¿¡æ¯çš„mysqlåœ°å€ï¼Œmaxwellä¼šæŠŠè¯»å–binlogå…³ç³»çš„ä¿¡æ¯ï¼Œå¦‚binlog nameã€positionã€‚</p><h2 id="å·¥å…·å¯¹æ¯”"><a href="#å·¥å…·å¯¹æ¯”" class="headerlink" title="å·¥å…·å¯¹æ¯”"></a>å·¥å…·å¯¹æ¯”</h2><p>ä»¥ä¸Šæ˜¯Canalçš„åŸç†åŠéƒ¨ç½²ï¼Œå…¶ä½™ç±»ä¼¼maxwellå’Œmysql_streamerå¯¹mysqlè¿›è¡Œå®æ—¶æ•°æ®æŠ“å–çš„åŸç†ä¸€æ ·å°±ä¸å†è¿›è¡Œä¸€ä¸€ä»‹ç»ï¼Œè¿™é‡Œåªå¯¹ä»–ä»¬è¿›è¡Œä¸‹å¯¹æ¯”ï¼š</p><table><thead><tr><th>ç‰¹è‰²</th><th>Canal</th><th>Maxwell</th><th>mysql_streamer</th></tr></thead><tbody><tr><td>è¯­è¨€</td><td>Java</td><td>Java</td><td>Python</td></tr><tr><td>æ´»è·ƒåº¦</td><td>æ´»è·ƒ</td><td>æ´»è·ƒ</td><td>ä¸æ´»è·ƒ</td></tr><tr><td>HA</td><td>æ”¯æŒ</td><td>å®šåˆ¶</td><td>æ”¯æŒ</td></tr><tr><td>æ•°æ®è½åœ°</td><td>å®šåˆ¶</td><td>è½åœ°åˆ°kafka</td><td>è½åœ°åˆ°kafka</td></tr><tr><td>åˆ†åŒº</td><td>æ”¯æŒ</td><td>ä¸æ”¯æŒ</td><td>ä¸æ”¯æŒ</td></tr><tr><td>bootstrap</td><td>ä¸æ”¯æŒ</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td></tr><tr><td>æ•°æ®æ ¼å¼</td><td>æ ¼å¼è‡ªç”±</td><td>json(æ ¼å¼å›ºå®š)</td><td>json(æ ¼å¼å›ºå®š)</td></tr><tr><td>æ–‡æ¡£</td><td>è¾ƒè¯¦ç»†</td><td>è¾ƒè¯¦ç»†</td><td>ç•¥ç²—</td></tr><tr><td>éšæœºè¯»</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td><td>æ”¯æŒ</td></tr></tbody></table><p><strong>ä»¥ä¸Šåªæ˜¯å°†mysqlé‡Œçš„å®æ—¶å˜åŒ–æ•°æ®çš„binlogä»¥åŒç§å½¢å¼åŒæ­¥åˆ°kafkaï¼Œä½†è¦å®æ—¶æ›´æ–°åˆ°hadoopè¿˜éœ€è¦ä½¿ç”¨ä¸€ä¸ªå®æ—¶æ•°æ®åº“æ¥å­˜å‚¨æ•°æ®ï¼Œå¹¶è‡ªå®šåˆ¶å¼€å‘å°†kafkaä¸­æ•°æ®è§£æä¸ºnosqlæ•°æ®åº“å¯ä»¥è¯†åˆ«çš„DMLè¿›è¡Œå®æ—¶æ›´æ–°Nosqlæ•°æ®åº“ï¼Œä½¿å…¶ä¸MySQLé‡Œçš„æ•°æ®å®æ—¶åŒæ­¥ã€‚</strong></p><h2 id="åŸºç¡€æ¶æ„"><a href="#åŸºç¡€æ¶æ„" class="headerlink" title="åŸºç¡€æ¶æ„"></a>åŸºç¡€æ¶æ„</h2><p>æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/mysqlToHdfs/%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="åŸºç¡€æ¶æ„å›¾" title="åŸºç¡€æ¶æ„å›¾"></p><blockquote><p>è™šçº¿æ¡†æ˜¯å¯é€‰çš„æ–¹æ¡ˆ</p></blockquote><h3 id="æ–¹æ¡ˆå¯¹æ¯”"><a href="#æ–¹æ¡ˆå¯¹æ¯”" class="headerlink" title="æ–¹æ¡ˆå¯¹æ¯”"></a>æ–¹æ¡ˆå¯¹æ¯”</h3><ol><li><em>æ–¹æ¡ˆ1</em>ä½¿ç”¨é˜¿é‡Œå¼€æºçš„Canalè¿›è¡ŒMysql binlogæ•°æ®çš„æŠ½å–ï¼Œå¦éœ€<strong>å¼€å‘ä¸€ä¸ªæ•°æ®è½¬æ¢å·¥å…·å°†ä»binlogä¸­è§£æå‡ºçš„æ•°æ®è½¬æ¢æˆè‡ªå¸¦schemaçš„jsonæ•°æ®å¹¶å†™å…¥kafkaä¸­</strong>ã€‚è€Œ<em>æ–¹æ¡ˆ2</em>ä½¿ç”¨maxwellå¯<strong>ç›´æ¥å®Œæˆ</strong>å¯¹mysql binlogæ•°æ®çš„æŠ½å–å’Œè½¬æ¢æˆè‡ªå¸¦schemaçš„jsonæ•°æ®å†™å…¥åˆ°kafkaä¸­ã€‚</li><li><em>æ–¹æ¡ˆ1</em>ä¸­ä¸æ”¯æŒè¡¨ä¸­å·²å­˜åœ¨çš„å†å²æ•°æ®è¿›è¡ŒåŒæ­¥ï¼Œæ­¤åŠŸèƒ½éœ€è¦å¼€å‘(å¦‚æœä½¿ç”¨sqoopè¿›è¡Œå†å²æ•°æ®åŒæ­¥ï¼Œä¸å¤Ÿçµæ´»ï¼Œä¼šä½¿ç»“æœè¡¨ä¸åŸå§‹è¡¨ç»“æ„ç›¸åŒï¼Œæœ‰åŒºåˆ«äºæ•°æ®äº¤æ¢å¹³å°æ‰€éœ€çš„schema)ã€‚<em>æ–¹æ¡ˆ2</em>æä¾›åŒæ­¥å†å²æ•°æ®çš„è§£å†³æ–¹æ¡ˆã€‚</li><li><em>æ–¹æ¡ˆ1</em>æ”¯æŒHAéƒ¨ç½²ï¼Œè€Œ<em>æ–¹æ¡ˆ2</em>ä¸æ”¯æŒHA</li></ol><p>æ–¹æ¡ˆ1å’Œæ–¹æ¡ˆ2çš„åŒºåˆ«åªåœ¨äºkafkaä¹‹å‰ï¼Œå½“æ•°æ®ç¼“å­˜åˆ°kafkaä¹‹åï¼Œéœ€è¦ä¸€ä¸ª<strong>å®šåˆ¶çš„æ•°æ®è·¯ç”±ç»„ä»¶</strong>æ¥å°†è‡ªå¸¦schemaçš„æ•°æ®è§£æåˆ°ç›®æ ‡å­˜å‚¨ä¸­ã€‚<br>æ•°æ®è·¯ç”±ç»„ä»¶ä¸»è¦è´Ÿè´£å°†kafkaä¸­çš„æ•°æ®å®æ—¶è¯»å‡ºï¼Œå†™å…¥åˆ°ç›®æ ‡å­˜å‚¨ä¸­ã€‚(å¦‚å°†æ‰€æœ‰æ—¥å¿—æ•°æ®ä¿å­˜åˆ°HDFSä¸­ï¼Œä¹Ÿå¯ä»¥å°†æ•°æ®è½åœ°åˆ°æ‰€æœ‰æ”¯æŒjdbcçš„æ•°æ®åº“ï¼Œè½åœ°åˆ°HBaseï¼ŒElasticsearchç­‰ã€‚)</p><!-- å¼€å‘bootstrapåŠŸèƒ½(æˆ–è€…ä½¿ç”¨sqoopå°†å†å²æ•°æ®è¿›è¡ŒåŒæ­¥ï¼Œç¼ºç‚¹æ˜¯ä»€ä¹ˆï¼Ÿä¸å¤Ÿçµæ´»ï¼Œåœ¨hbaseä¹‹ç±»çš„æ•°æ®åº“ä¸­å­˜å‚¨çš„å†…å®¹ä¼šæœ‰ä¸€ä¸ªæ ‡è¯†å±æ€§ï¼Œé˜²æ­¢é‡å¤æ“ä½œ) --><p>ç»¼ä¸Šï¼Œ<br>æ–¹æ¡ˆ1éœ€è¦å¼€å‘çš„åŠŸèƒ½æœ‰ï¼š</p><ul><li>bootstrapåŠŸèƒ½</li><li>å®æ—¶æ•°æ®è½¬æ¢å·¥å…·</li><li>æ•°æ®è·¯ç”±å·¥å…·</li></ul><p>æ–¹æ¡ˆ2éœ€è¦å¼€å‘çš„åŠŸèƒ½æœ‰ï¼š</p><ul><li>æ•°æ®è·¯ç”±å·¥å…·</li><li>HAæ¨¡å—(åˆæœŸå¯æš‚ä¸æ”¯æŒHAï¼Œæ‰€ä»¥å¼€å‘ç´§æ€¥åº¦ä¸é«˜)</li></ul><p>æ•°æ®è·¯ç”±å·¥å…·æ˜¯ä¸¤ä¸ªæ–¹æ¡ˆéƒ½éœ€è¦å¼€å‘çš„ï¼Œåˆ™æˆ‘æ¯”è¾ƒåå‘äºç¬¬äºŒç§æ–¹æ¡ˆï¼Œå› ä¸ºåœ¨åˆæœŸè¯•æ°´é˜¶æ®µå¯ä»¥çŸ­æœŸå‡ºæˆæœï¼Œå¯ä»¥è¾ƒå¿«çš„éªŒè¯æƒ³æ³•ï¼Œå¹¶åœ¨å°è¯•ä¸­èƒ½å¤Ÿè¾ƒå¿«çš„å‘ç°é—®é¢˜ï¼Œå¥½åŠæ—¶çš„è°ƒæ•´æ–¹æ¡ˆã€‚å³ä½¿æ–¹æ¡ˆ2ä¸­maxwellæœ€ç»ˆä¸èƒ½æ»¡è¶³éœ€æ±‚ï¼Œè€Œä½¿ç”¨canalçš„è¯ï¼Œæˆ‘ä»¬ä¹Ÿå¯èƒ½å°†å®æ—¶æ•°æ®è½¬æ¢å·¥å…·çš„æ•°æ®è¾“å‡ºæ¨¡å¼ä¸maxwellä¸€è‡´ï¼Œè¿™æ ·åˆå§‹æŠ•å…¥äººåŠ›å¼€å‘çš„æ•°æ®è·¯ç”±å·¥å…·ä¾ç„¶å¯ä»¥ç»§ç»­ä½¿ç”¨ï¼Œè€Œä¸éœ€è¦é‡æ–°å¼€å‘ã€‚</p><p>æŠŠå¢é‡çš„Logä½œä¸ºä¸€åˆ‡ç³»ç»Ÿçš„åŸºç¡€ã€‚åç»­çš„æ•°æ®ä½¿ç”¨æ–¹ï¼Œé€šè¿‡è®¢é˜…kafkaæ¥æ¶ˆè´¹logã€‚</p><p>æ¯”å¦‚ï¼š<br>å¤§æ•°æ®çš„ä½¿ç”¨æ–¹å¯ä»¥å°†æ•°æ®ä¿å­˜åˆ°Hiveè¡¨æˆ–è€…Parquetæ–‡ä»¶ç»™Hiveæˆ–SparkæŸ¥è¯¢ï¼›<br>æä¾›æœç´¢æœåŠ¡çš„ä½¿ç”¨æ–¹å¯ä»¥ä¿å­˜åˆ°Elasticsearchæˆ–HBase ä¸­ï¼›<br>æä¾›ç¼“å­˜æœåŠ¡çš„ä½¿ç”¨æ–¹å¯ä»¥å°†æ—¥å¿—ç¼“å­˜åˆ°Redisæˆ–alluxioä¸­ï¼›<br>æ•°æ®åŒæ­¥çš„ä½¿ç”¨æ–¹å¯ä»¥å°†æ•°æ®ä¿å­˜åˆ°è‡ªå·±çš„æ•°æ®åº“ä¸­ï¼›<br>ç”±äºkafkaçš„æ—¥å¿—æ˜¯å¯ä»¥é‡å¤æ¶ˆè´¹çš„ï¼Œå¹¶ä¸”ç¼“å­˜ä¸€æ®µæ—¶é—´ï¼Œå„ä¸ªä½¿ç”¨æ–¹å¯ä»¥é€šè¿‡æ¶ˆè´¹kafkaçš„æ—¥å¿—æ¥è¾¾åˆ°æ—¢èƒ½ä¿æŒä¸æ•°æ®åº“çš„ä¸€è‡´æ€§ï¼Œä¹Ÿèƒ½ä¿è¯å®æ—¶æ€§ï¼›</p><p>{â€œdatabaseâ€:â€testâ€,â€tableâ€:â€eâ€,â€typeâ€:â€updateâ€,â€tsâ€:1488857869,â€xidâ€:8924,â€commitâ€:true,â€dataâ€:{â€œidâ€:1,â€mâ€:5.556666,â€torvaldsâ€:null},â€oldâ€:{â€œmâ€:5.55}}</p><p>{â€œdatabaseâ€:â€testâ€,â€tableâ€:â€eâ€,â€typeâ€:â€insertâ€,â€tsâ€:1488857922,â€xidâ€:8932,â€commitâ€:true,â€dataâ€:{â€œidâ€:2,â€mâ€:4.2,â€torvaldsâ€:null}}</p><h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://github.com/alibaba/canal/wiki">canal</a><br><a href="http://maxwells-daemon.io/">maxwell</a><br><a href="https://github.com/Yelp/mysql_streamer">mysql_streamer</a></p>]]></content>
      
      
      <categories>
          
          <category> BigData </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> MySQL </tag>
            
            <tag> canal </tag>
            
            <tag> å®æ—¶ </tag>
            
            <tag> æ›´æ–°æ•°æ® </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HUEç¼–è¯‘ä¸éƒ¨ç½²</title>
      <link href="/HUE%E7%BC%96%E8%AF%91%E4%B8%8E%E9%83%A8%E7%BD%B2.html"/>
      <url>/HUE%E7%BC%96%E8%AF%91%E4%B8%8E%E9%83%A8%E7%BD%B2.html</url>
      
        <content type="html"><![CDATA[<p>Hueæ˜¯ä¸€ä¸ªå¼€æºçš„Apache Hadoop UIç³»ç»Ÿï¼Œæ˜¯åŸºäºPython Webæ¡†æ¶Djangoå®ç°çš„ã€‚Hueå¯ä»¥ä½¿å¼€å‘è€…åœ¨æµè§ˆå™¨ç«¯çš„Webæ§åˆ¶å°ä¸Šä¸Hadoopé›†ç¾¤è¿›è¡Œäº¤äº’æ¥åˆ†æå¤„ç†æ•°æ®ï¼Œä¾‹å¦‚æ“ä½œHDFSä¸Šçš„æ•°æ®ï¼Œè¿è¡ŒMapReduce Jobç­‰ç­‰ã€‚</p><p>æœ¬ç¯‡ä¸­ä½¿ç”¨çš„HUEç‰ˆæœ¬æ˜¯3.9.0ã€‚(åœ¨å®é™…ç”Ÿäº§ä¸­æœ€å¥½åˆ«ä½¿ç”¨3.9è¿™ä¸ªç‰ˆæœ¬ï¼Œå› ä¸ºè¿™ä¸ªç‰ˆæœ¬çš„ä»£ç ç»“æ„å’Œ3.7å’Œ3.10çš„ä»£ç éƒ½ä¸ä¸€æ ·)</p><span id="more"></span><h2 id="HUE-build"><a href="#HUE-build" class="headerlink" title="HUE build"></a>HUE build</h2><!-- åœ¨centosè™šæ‹Ÿæœºé‡Œç¼–è¯‘ï¼Œä¹Ÿå°±æ˜¯hadoopçš„ä¼ªåˆ†å¸ƒç¯å¢ƒä¸‹--><p>HUEåœ¨ä½¿ç”¨ä¹‹å‰è¦å…ˆå¯¹å…¶è¿›è¡Œç¼–è¯‘ï¼Œç¼–è¯‘æ—¶éœ€è¦å®‰è£…ä¸€äº›ä¾èµ–åŒ…ï¼Œæˆ‘çš„ç¯å¢ƒæ˜¯centosï¼Œå®‰è£…çš„ä¾èµ–åŒ…å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo yum install gcc gcc-c++ libffi-devel libxml2-devel libxslt-devel openldap-devel python-devel sqlite-devel openssl-devel gmp-devel cyrus-sasl-devel cyrus-sasl-gssapi cyrus-sasl-plain krb5-devel</span><br></pre></td></tr></table></figure><blockquote><p>mvn mysql mysql-devel JDK make ä¹‹å‰å·²ç¦»çº¿å®‰è£…<br>æŸ¥çœ‹ä¾èµ–åŒ…æ˜¯å¦å®‰è£…å¯ä»¥ä½¿ç”¨å‘½ä»¤<code>rpm -q ä¾èµ–åŒ…å</code></p></blockquote><p>æ›´è¯¦ç»†çš„ä¾èµ–åŒ…å¯ä»¥å‚è€ƒ<a href="https://github.com/cloudera/hue">æ­¤å¤„</a></p><p>ä¾èµ–åŒ…å®‰è£…å¥½ä¹‹åï¼Œè§£å‹HUEçš„ä»£ç åŒ…ï¼Œè¿›å…¥HUE_HOMEï¼Œæ‰§è¡Œå‘½ä»¤<code>make apps</code>ã€‚</p><blockquote><p>HUEé»˜è®¤æ˜¯ä½¿ç”¨python2.6è¿›è¡Œç¼–è¯‘ï¼Œå¦‚æœä½ æƒ³ä½¿ç”¨åˆ«çš„ç‰ˆæœ¬pythonè¿›è¡Œç¼–è¯‘ï¼Œåªéœ€æ›´æ”¹HUE_HOMEç›®å½•ä¸‹çš„<code>Makefile.vars</code>ï¼Œç»™å˜é‡<code>SYS_PYTHON</code>èµ‹å€¼ä¸º<code>python2.7</code>ï¼Œä»£ç ä¸º<code>SYS_PYTHON := python2.7</code></p></blockquote><h3 id="é‡åˆ°çš„é—®é¢˜"><a href="#é‡åˆ°çš„é—®é¢˜" class="headerlink" title="é‡åˆ°çš„é—®é¢˜"></a>é‡åˆ°çš„é—®é¢˜</h3><p>ç¼–è¯‘è¿‡ç¨‹ä¸­é‡åˆ°å‡ ä¸ªé—®é¢˜ï¼Œéƒ½ä¸æ˜¯ä»€ä¹ˆå¤§é—®é¢˜ï¼Œéƒ½æ˜¯å› ä¸ºç¼ºå°‘ä¾èµ–ï¼Œå®‰è£…ç›¸åº”çš„ä¾èµ–å³å¯ã€‚é”™è¯¯å¦‚ä¸‹ï¼š</p><ul><li>src/_fastmath.c:36:18: error: gmp.h: No such file or directory </li></ul><p>æ‰§è¡Œå‘½ä»¤ <code>sudo yum install gmp gmp-devel</code></p><ul><li>src/connection.h:33:21: error: sqlite3.h: No such file or directory</li></ul><p>æ‰§è¡Œå‘½ä»¤ <code>sudo yum install sqlite-devel</code></p><ul><li>Modules/errors.h:8:18: error: lber.h: No such file or directory<br>Modules/errors.h:9:18: error: ldap.h: No such file or directory</li></ul><p>æ‰§è¡Œå‘½ä»¤ <code>sudo yum install openldap-devel</code></p><h2 id="HUE-éƒ¨ç½²"><a href="#HUE-éƒ¨ç½²" class="headerlink" title="HUE éƒ¨ç½²"></a>HUE éƒ¨ç½²</h2><p>HUEçš„éƒ¨ç½²ä¹Ÿæ¯”è¾ƒç®€å•ï¼ŒHUEçš„é…ç½®æ–‡ä»¶åœ¨<code>~/hue-3.9.0/desktop/conf</code>ä¸­ï¼Œç”±äºç‰ˆæœ¬ä¸ä¸€æ ·ï¼Œæœ‰çš„é…ç½®æ–‡ä»¶åæ˜¯<em>pseudo-distributed.ini</em>ï¼Œæœ‰çš„åˆ™æ˜¯<em>hue.ini</em>ï¼Œ3.9.0çš„é…ç½®æ–‡ä»¶æ˜¯hue.iniã€‚</p><p>éœ€è¦é…ç½®çš„å±æ€§å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">[desktop]</span><br><span class="line">  <span class="comment"># Set this to a random string, the longer the better.</span></span><br><span class="line">  <span class="comment"># This is used for secure hashing in the session store.</span></span><br><span class="line">  <span class="comment"># éšæ„è¾“å…¥çš„å­—ç¬¦ï¼Œé•¿åº¦æ˜¯30-60</span></span><br><span class="line">  secret_key=iowerwerwjdsfkjfksjdfiowjeiorujfklsjdf234</span><br><span class="line">  <span class="comment"># HUEæ‰€åœ¨æœºå™¨çš„ipï¼Œä¹Ÿå°±æ˜¯è®¿é—®HUEçš„ipå’Œç«¯å£</span></span><br><span class="line">  http_host=192.168.244.131</span><br><span class="line">  http_port=8888</span><br><span class="line">  <span class="comment"># Time zone name</span></span><br><span class="line">  time_zone=Asia/Shanghai</span><br><span class="line">  <span class="comment"># è¿è¡Œhueè¿›ç¨‹çš„linuxç”¨æˆ·   </span></span><br><span class="line">  server_user=hadoop</span><br><span class="line">  server_group=hadoop</span><br><span class="line">  <span class="comment"># This should be the Hue admin and proxy user</span></span><br><span class="line">  default_user=hadoop</span><br><span class="line">  <span class="comment"># Hadoopé›†ç¾¤çš„ç®¡ç†å‘˜ç”¨æˆ·</span></span><br><span class="line">  default_hdfs_superuser=hadoop</span><br><span class="line"></span><br><span class="line">[hadoop]</span><br><span class="line">  <span class="comment"># Configuration for HDFS NameNode</span></span><br><span class="line">  <span class="comment"># ------------------------------------------------------------------------</span></span><br><span class="line">  [[hdfs_clusters]]</span><br><span class="line">    <span class="comment"># HA support by using HttpFs</span></span><br><span class="line">    [[[default]]]</span><br><span class="line">      <span class="comment"># Enter the filesystem uri</span></span><br><span class="line">      <span class="comment"># core-site.xmlé‡Œè®¾ç½®</span></span><br><span class="line">      fs_defaultfs=hdfs://centos:9000</span><br><span class="line">      <span class="comment"># Use WebHdfs/HttpFs as the communication mechanism.</span></span><br><span class="line">      <span class="comment"># Domain should be the NameNode or HttpFs host.</span></span><br><span class="line">      <span class="comment"># Default port is 14000 for HttpFs.</span></span><br><span class="line">      webhdfs_url=http://192.168.244.131:50070/webhdfs/v1</span><br><span class="line">      hadoop_conf_dir=<span class="variable">$HADOOP_CONF_DIR</span></span><br><span class="line">  [[yarn_clusters]]</span><br><span class="line">    [[[default]]]</span><br><span class="line">      <span class="comment"># Enter the host on which you are running the ResourceManager</span></span><br><span class="line">      resourcemanager_host=192.168.244.131</span><br><span class="line">      <span class="comment"># The port where the ResourceManager IPC listens on</span></span><br><span class="line">      resourcemanager_port=8032</span><br><span class="line">      <span class="comment"># Whether to submit jobs to this cluster</span></span><br><span class="line">      submit_to=True</span><br><span class="line"></span><br><span class="line">      <span class="comment"># URL of the ResourceManager API</span></span><br><span class="line">      resourcemanager_api_url=http://192.168.244.131:8088</span><br><span class="line">      <span class="comment"># URL of the HistoryServer API</span></span><br><span class="line">      history_server_api_url=http://192.168.244.131:19888</span><br><span class="line"></span><br><span class="line">[beeswax]</span><br><span class="line">  <span class="comment"># Host where HiveServer2 is running.</span></span><br><span class="line">  <span class="comment"># If Kerberos security is enabled, use fully-qualified domain name (FQDN).</span></span><br><span class="line">  <span class="comment"># hiveServer2æ‰€åœ¨çš„æœºå™¨ip</span></span><br><span class="line">  hive_server_host=192.168.244.131</span><br><span class="line">  <span class="comment"># Port where HiveServer2 Thrift server runs on.</span></span><br><span class="line">  hive_server_port=10000</span><br><span class="line">  <span class="comment"># Hive configuration directory, where hive-site.xml is located</span></span><br><span class="line">  hive_conf_dir=/home/hadoop/hive/conf</span><br><span class="line"></span><br><span class="line">[zookeeper]</span><br><span class="line">  [[clusters]]</span><br><span class="line">    [[[default]]]</span><br><span class="line">      <span class="comment"># Zookeeper ensemble. Comma separated list of Host/Port.</span></span><br><span class="line">      <span class="comment"># e.g. localhost:2181,localhost:2182,localhost:2183</span></span><br><span class="line">      host_ports=192.168.244.131:2181     </span><br></pre></td></tr></table></figure><p>é…ç½®å¥½ä¹‹åï¼Œå¹¶ä¸”hiveServer2ä¹Ÿå·²ç»å¯åŠ¨ï¼Œåˆ™å¯ä»¥å¯åŠ¨HUEï¼Œå‘½ä»¤ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HUE_HOMEç›®å½•ä¸‹</span></span><br><span class="line">build/env/bin/supervisor</span><br></pre></td></tr></table></figure><p>åˆ™å¯ä»¥é€šè¿‡192.168.244.131:8888è®¿é—®ã€‚</p><h3 id="HUEæ•°æ®åº“åˆ‡æ¢åˆ°Mysql"><a href="#HUEæ•°æ®åº“åˆ‡æ¢åˆ°Mysql" class="headerlink" title="HUEæ•°æ®åº“åˆ‡æ¢åˆ°Mysql"></a>HUEæ•°æ®åº“åˆ‡æ¢åˆ°Mysql</h3><p>HUEä¸­çš„ä¿¡æ¯ï¼Œæ¯”å¦‚è´¦å·ä¿¡æ¯ï¼Œé»˜è®¤æ˜¯å­˜å‚¨åœ¨sqlite3ä¸­çš„ï¼Œåœ¨å®é™…çš„ç”Ÿäº§ç¯å¢ƒä¸­ä¸ºäº†å®‰å…¨ä¸€èˆ¬éƒ½ä¼šåˆ‡æ¢æˆMysqlæ•°æ®åº“ã€‚åˆ‡æ¢mysqlæ•°æ®åº“çš„æ­¥éª¤å¦‚ä¸‹ï¼š</p><p>1ã€å…ˆåœæ­¢HUEï¼Œæ”¹é…ç½®æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[desktop]</span><br><span class="line">  [[database]]</span><br><span class="line">    <span class="comment"># Database engine is typically one of:</span></span><br><span class="line">    <span class="comment"># postgresql_psycopg2, mysql, sqlite3 or oracle.</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment"># Note that for sqlite3, &#x27;name&#x27;, below is a path to the filename. For other backends, it is the database name.</span></span><br><span class="line">    <span class="comment"># Note for Oracle, options=&#123;&quot;threaded&quot;:true&#125; must be set in order to avoid crashes.</span></span><br><span class="line">    <span class="comment"># Note for Oracle, you can use the Oracle Service Name by setting &quot;port=0&quot; and then &quot;name=&lt;host&gt;:&lt;port&gt;/&lt;service_name&gt;&quot;.</span></span><br><span class="line">    <span class="comment"># Note for MariaDB use the &#x27;mysql&#x27; engine.</span></span><br><span class="line">    engine=mysql</span><br><span class="line">    host=127.0.0.1</span><br><span class="line">    port=3306</span><br><span class="line">    user=root</span><br><span class="line">    password=root</span><br><span class="line">    <span class="comment">## ç”¨äºå­˜æ”¾hueä¿¡æ¯çš„æ•°æ®åº“å</span></span><br><span class="line">    name=hue</span><br></pre></td></tr></table></figure><p>2ã€å¤‡ä»½sqlite3ä¸­çš„æ•°æ®åº“</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## HUE_HOMEç›®å½•ä¸‹ï¼Œå¤‡ä»½çš„æ–‡ä»¶å¿…é¡»æ˜¯jsonæ ¼å¼çš„</span></span><br><span class="line">sudo build/env/bin/hue dumpdata &gt; hue.json</span><br></pre></td></tr></table></figure><p>å¤‡ä»½ä¹‹åï¼Œæ‰“å¼€hue.jsonå¹¶åˆ é™¤<em>modelå­—æ®µä¸­å¸¦æœ‰useradmin.userprofileçš„æ‰€æœ‰JSONå¯¹è±¡</em>ã€‚</p><p>3ã€åœ¨Mysqlä¸­åˆ›å»ºé…ç½®æ–‡ä»¶ä¸­çš„hueæ•°æ®åº“<code>create database hue;</code><br>4ã€åŒæ­¥è¡¨ç»“æ„</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo build/env/bin/hue syncdb --noinput </span><br><span class="line">sudo build/env/bin/hue migrate</span><br></pre></td></tr></table></figure><p>5ã€æŸ¥çœ‹æ˜¯å¦éœ€è¦åˆ é™¤å¤–é”®<br>åœ¨mysqlå‘½ä»¤è¡Œä¸­ï¼Œå…ˆæŸ¥çœ‹ä¸‹<em>auth_permission</em>çš„å»ºè¡¨è¯­å¥ï¼Œä½¿ç”¨å‘½ä»¤<code>show create table auth_permission;</code>ï¼Œå¦‚æœæ­¤è¡¨æ˜¯InnoDBï¼Œåˆ™åˆ é™¤å¤–é”®ï¼Œå‘½ä»¤ä¸º<em>ALTER TABLE auth_permission DROP FOREIGN KEY content_type_id_refs_id_XXXXXX;</em></p><p>6ã€åˆ é™¤<em>django_content_type</em>è¡¨ä¸­çš„æ•°æ®ï¼Œ<code>DELETE FROM hue.django_content_type;</code></p><p>7ã€åŠ è½½æ•°æ®<code>build/env/bin/hue loaddata hue.json</code></p><p>8ã€å¦‚æœæ­¥éª¤5ä¸­åˆ é™¤äº†å¤–é”®ï¼Œåˆ™éœ€è¦æ·»åŠ å¤–é”®ï¼Œå‘½ä»¤<code>ALTER TABLE auth_permission ADD FOREIGN KEY (</code>content_type_id<code>) REFERENCES </code>django_content_type<code> (</code>id<code>);</code></p><p>æ“ä½œå®Œå¹¶æ²¡æœ‰å‡ºç°é”™è¯¯åˆ™å¯åŠ¨HUEï¼Œæ­¤æ—¶æ•°æ®åº“ä»sqliteåˆ‡æ¢åˆ°äº†Mysqlä¸­ã€‚</p><h3 id="éƒ¨ç½²Mysql-Editor"><a href="#éƒ¨ç½²Mysql-Editor" class="headerlink" title="éƒ¨ç½²Mysql Editor"></a>éƒ¨ç½²Mysql Editor</h3><p>HUEä¸ä»…å¯ä»¥æ“ä½œHadoopç”Ÿæ€åœˆé‡Œçš„ç»„ä»¶ï¼Œè¿˜å¯ä»¥æ“ä½œå…³ç³»å‹æ•°æ®åº“ã€‚</p><p>æ“ä½œå…³ç³»å‹æ•°æ®åº“åªéœ€ä¿®æ”¹é…ç½®æ–‡ä»¶å³å¯ï¼Œä»¥Mysqlä¸ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[librdbms]</span><br><span class="line">  [[databases]]</span><br><span class="line">     [[[mysql]]]</span><br><span class="line">      <span class="comment"># Name to show in the UI.</span></span><br><span class="line">      nice_name=<span class="string">&quot;My SQL DB&quot;</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># For MySQL and PostgreSQL, name is the name of the database.</span></span><br><span class="line">      <span class="comment"># For Oracle, Name is instance of the Oracle server. For express edition</span></span><br><span class="line">      <span class="comment"># this is &#x27;xe&#x27; by default.</span></span><br><span class="line">      <span class="comment">## name=mysqldb</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Database backend to use. This can be:</span></span><br><span class="line">      <span class="comment"># 1. mysql</span></span><br><span class="line">      <span class="comment"># 2. postgresql</span></span><br><span class="line">      <span class="comment"># 3. oracle</span></span><br><span class="line">      engine=mysql</span><br><span class="line"></span><br><span class="line">      <span class="comment"># IP or hostname of the database to connect to.</span></span><br><span class="line">      <span class="comment">## host=localhost</span></span><br><span class="line"></span><br><span class="line">      <span class="comment"># Port the database server is listening to. Defaults are:</span></span><br><span class="line">      <span class="comment"># 1. MySQL: 3306</span></span><br><span class="line">      <span class="comment"># 2. PostgreSQL: 5432</span></span><br><span class="line">      <span class="comment"># 3. Oracle Express Edition: 1521</span></span><br><span class="line">      <span class="comment">## port=3306</span></span><br><span class="line">      <span class="comment"># Username to authenticate with when connecting to the database.</span></span><br><span class="line">      user=root</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Password matching the username to authenticate with when</span></span><br><span class="line">      <span class="comment"># connecting to the database.</span></span><br><span class="line">      password=root</span><br><span class="line"></span><br><span class="line">      <span class="comment"># Database options to send to the server when connecting.</span></span><br><span class="line">      <span class="comment"># https://docs.djangoproject.com/en/1.4/ref/databases/</span></span><br><span class="line">      <span class="comment">## options=&#123;&#125;        </span></span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> HUE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> HUE </tag>
            
            <tag> build </tag>
            
            <tag> éƒ¨ç½² </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HUEå¼€å‘ç¯å¢ƒéƒ¨ç½²åŠappäºŒæ¬¡å¼€å‘</title>
      <link href="/HUE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%8F%8Aapp%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91.html"/>
      <url>/HUE%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E9%83%A8%E7%BD%B2%E5%8F%8Aapp%E4%BA%8C%E6%AC%A1%E5%BC%80%E5%8F%91.html</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘ç»„é‡Œæœ‰ä¸ªå°éœ€æ±‚è¦ç®¡ç†æ•°å­—å­—å…¸ï¼Œæ•°ä»“çš„å­—å…¸åœ¨HUEä¸­èƒ½å¤ŸæŸ¥çœ‹ï¼Œä½†Mysqlçš„å­—å…¸å‘¢ï¼Ÿäºæ˜¯å°±æƒ³å¯¹HUEè¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼Œå¢åŠ ä¸€ä¸ªAppä½¿å…¶å¯¹Mysqlçš„æ•°å­—å­—å…¸è¿›è¡Œç®¡ç†ï¼Œä¹Ÿå°±æ˜¯ä¸€ä¸ªç±»ä¼¼METASTORE TABLEçš„åŠŸèƒ½ã€‚</p><span id="more"></span><h2 id="å‡†å¤‡å¼€å‘ç¯å¢ƒ"><a href="#å‡†å¤‡å¼€å‘ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡å¼€å‘ç¯å¢ƒ"></a>å‡†å¤‡å¼€å‘ç¯å¢ƒ</h2><blockquote><p>å¯¼å…¥IDEçš„HUEå·¥ç¨‹ä¸æ˜¯æºä»£ç ï¼Œè€Œæ˜¯å·²ç»buildæˆåŠŸçš„HUEå·¥ç¨‹ã€‚</p></blockquote><h3 id="eclipse-pydevæ’ä»¶å®‰è£…"><a href="#eclipse-pydevæ’ä»¶å®‰è£…" class="headerlink" title="eclipse pydevæ’ä»¶å®‰è£…"></a>eclipse pydevæ’ä»¶å®‰è£…</h3><p>æœ¬æ¥æƒ³ç”¨Intellij ideaçš„ï¼Œç”±äºIntellijæ˜¯åœ¨ç‰©ç†æœº(windows)ä¸Šå®‰è£…çš„ï¼Œä½†HUEåœ¨windowsä¸‹ç¼–è¯‘æ¯”è¾ƒè´¹åŠ²ï¼Œè€Œä¹‹å‰HUEå·²åœ¨è™šæ‹Ÿæœºä¸­ç¼–è¯‘æˆåŠŸï¼Œè™šæœºä¸­åˆåˆšå¥½æœ‰ä¸ªeclipseï¼Œå°±é€‰æ‹©ç”¨eclipseè¿›è¡Œå¼€å‘äº†ã€‚</p><p>IDEé€‰å¥½ï¼Œå°±æ˜¯ä¸ºeclipseå®‰è£…æ’ä»¶ä½¿å…¶èƒ½å¤Ÿè¿›è¡Œpythonå¼€å‘ï¼Œå®‰è£…çš„æ’ä»¶æ˜¯<a href="http://pydev.org/updates">pydev</a>ï¼Œå®‰è£…æ–¹æ³•åˆ†ä¸º<em>åœ¨çº¿</em>å’Œ<em>ç¦»çº¿</em>ä¸¤ç§ï¼Œåœ¨çº¿åœ¨è™šæœºä¸­çš„eclipseæ€»æ˜¯æœ‰ç‚¹é—®é¢˜ï¼Œæ˜¾ç¤ºæ’ä»¶å®‰è£…æˆåŠŸå¯æ˜¯æ€»æ˜¯æ‰¾ä¸åˆ°ï¼Œæ¢äº†nä¸ªç‰ˆæœ¬çš„eclipseä¾ç„¶ä¸è¡Œã€‚å°±åªå¥½ç¦»çº¿å®‰è£…äº†ï¼Œåœ¨<a href="http://sourceforge.net/projects/pydev/files/pydev/">http://sourceforge.net/projects/pydev/files/pydev/</a>ä¸‹è½½å®‰è£…åŒ…ï¼Œè§£å‹ä¹‹åå°†<em>features</em>å’Œ<em>plugins</em>å¤åˆ¶åˆ°eclipseçš„homeç›®å½•ä¸‹ã€‚</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -r /pydev_home/features /eclipse_home/</span><br><span class="line">cp -r /pydev_home/plugins /eclipse_home/</span><br></pre></td></tr></table></figure><h3 id="å°†HUEå¯¼å…¥IDE-eclipse"><a href="#å°†HUEå¯¼å…¥IDE-eclipse" class="headerlink" title="å°†HUEå¯¼å…¥IDE eclipse"></a>å°†HUEå¯¼å…¥IDE eclipse</h3><p>1ã€pythonæ’ä»¶å®‰è£…å¥½ä¹‹åï¼Œå°±æ˜¯<em>ä¸ºHUEå•ç‹¬è®¾ç½®pythonç¯å¢ƒ</em>ï¼Œä¹‹æ‰€ä»¥å•ç‹¬è®¾ç½®pythonç¯å¢ƒï¼Œæ˜¯å› ä¸ºHUEåœ¨buildçš„æ—¶å€™å·²ç»å°†æ‰€ä¾èµ–çš„pythonåŒ…ä¸‹è½½è‡³/HUE_HOME/build/env/ä¸­ï¼Œä¸ºHUEè®¾ç½®pythonç¯å¢ƒ</p><p>å•å‡»<code>Window-&gt;Preferences</code>ï¼Œæ‰¾åˆ°å®‰è£…å¥½çš„pythonæ’ä»¶<em>PyDev</em>ï¼Œé€šè¿‡å³ä¾§çš„newé€‰æ‹©*/home/hadoop/hue-3.9.0/build/env/bin/python*ï¼Œå¦‚å›¾<br>![HUE pythonç¯å¢ƒ](/blogimgs/HUE App/HUE_Python.png â€œHUE pythonç¯å¢ƒâ€)</p><p>2ã€åœ¨eclipseä¸­æ–°å»ºä¸€ä¸ªpython djangoé¡¹ç›®å¹¶å¯¼å…¥HUEå·¥ç¨‹<br>é€‰æ‹©djangoé¡¹ç›®<br>![æ–°å»ºdjangoé¡¹ç›®](/blogimgs/HUE App/new_project.png â€œæ–°å»ºdjangoé¡¹ç›®â€)</p><p>ä¸‹ä¸€æ­¥é€‰æ‹©HUEç›¸å…³çš„è®¾ç½®ï¼Œå¦‚ä¸‹å›¾ï¼š<br>![å¯¼å…¥HUE](/blogimgs/HUE App/new_project_2.png â€œå¯¼å…¥HUEâ€)<br>å…¶ä¸­<code>1</code>æ˜¯æ–°å»ºdjangoé¡¹ç›®çš„åå­—ï¼Œç”±äºè¦å¯¼å…¥å·²æœ‰é¡¹ç›®ï¼Œåˆ™å°†<code>2</code>å‹¾é€‰å»æ‰ï¼Œæ¥ç€åœ¨<code>3</code>å¤„é€‰æ‹©hueçš„å®‰è£…ç›®å½•(<em>æˆ‘è¿™ç¼–è¯‘ç›®å½•å’Œå®‰è£…ç›®å½•æ˜¯åŒä¸€ä¸ªç›®å½•</em>)ï¼Œåˆ«å¿˜äº†åœ¨<code>4</code>å¤„é€‰æ‹©ä¸Šä¸€æ­¥ä¸­å•ç‹¬ä¸ºhueè®¾ç½®çš„pythonç¯å¢ƒã€‚</p><p>3ã€è®¾ç½®myHueå·¥ç¨‹<br>è®¾ç½®é¡¹ç›®å±æ€§ï¼Œå†…å®¹å¦‚ä¸‹å›¾(<em>è®¾ç½®çš„ä¸¤ä¸ªæ–‡ä»¶éƒ½æç¤ºæœªæ‰¾åˆ°ï¼Œä¸çŸ¥ä½•åŸå› ï¼Œæ˜¯å¦æœ‰å½±å“</em>)ï¼Œ<br>![é¡¹ç›®å±æ€§](/blogimgs/HUE App/new_project_3.png â€œé¡¹ç›®å±æ€§â€)</p><p>4ã€debugå¯åŠ¨HUE<br>å•å‡»<code>run-&gt;DEBUG Configurations</code>ï¼ŒåŒå‡»<code>PyDev Django</code><br>![debugå¯åŠ¨](/blogimgs/HUE App/new_project_4.png â€œdebugå¯åŠ¨â€)</p><blockquote><p>ä¸»æ¨¡å—è®¾ä¸ºbuid/env/bin/hue,åœ¨æœ‰äº›eclipseä¸­ä¼šæŠ¥æ‰¾ä¸åˆ°è¯¥æ–‡ä»¶çš„æç¤ºï¼Œæ­¤æ—¶å¯ä»¥å°†hueæ‹·è´ä¸ºhue.py,åˆ·æ–°é¡¹ç›®åå†ç”¨Main Moduleå³è¾¹çš„BrowseæŒ‰æ‰­é€‰å–è¯¥hue.py,æˆ–ç›´æ¥è¾“å…¥${workspace_loc:hue/build/env/bin/hue.py}åšä¸ºä¸»æ¨¡å—ã€‚</p></blockquote><p>å¯åŠ¨hueæ—¶è¿˜éœ€è¾“å…¥å‚æ•°ï¼Œåœ¨<em>Arguements</em>é€‰é¡¹ä¸­è¾“å…¥<code>runcherrypyserver</code>ï¼Œå¦‚å›¾<br>![debugå¯åŠ¨](/blogimgs/HUE App/new_project_5.png â€œdebugå¯åŠ¨â€)</p><p>5ã€æœ€åè¿˜å¾—ä¿®æ”¹ä¸€å¤„ä»£ç ï¼Œåœ¨<code>desktop/core/src/desktop/appmanager.py</code>ä¸­çš„<code>_import_module_or_none</code>æ–¹æ³•<code>my_file = re.sub(r&#39;\.pyc&#39;,&#39;.py&#39;, __file__)</code>å¤„æ·»åŠ <code>return None</code>ï¼Œå°†åé¢çš„å†…å®¹æ³¨é‡Šæ‰ï¼Œå®Œæ•´ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_import_module_or_none</span>(<span class="params">module</span>):</span></span><br><span class="line">  <span class="string">&quot;&quot;&quot;Like import_module, but returns None if the module does not exist.</span></span><br><span class="line"><span class="string">  This will properly handle nested ImportErrors in such a way that, if the</span></span><br><span class="line"><span class="string">  module should exist but throws ImportError, we *will* raise through</span></span><br><span class="line"><span class="string">  that error.</span></span><br><span class="line"><span class="string">  &quot;&quot;&quot;</span></span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    <span class="built_in">__import__</span>(module)</span><br><span class="line">    <span class="keyword">return</span> sys.modules[module]</span><br><span class="line">  <span class="keyword">except</span> ImportError, ie:</span><br><span class="line">    <span class="comment"># If the exception came from us importing, we want to just</span></span><br><span class="line">    <span class="comment"># return None. We need to inspect the stack, though, so we properly</span></span><br><span class="line">    <span class="comment"># reraise in the case that the module we&#x27;re importing triggered</span></span><br><span class="line">    <span class="comment"># an import error itself.</span></span><br><span class="line">    tb = sys.exc_info()[<span class="number">2</span>]</span><br><span class="line">    top_frame = traceback.extract_tb(tb)[-<span class="number">1</span>]</span><br><span class="line">    err_file = re.sub(<span class="string">r&#x27;\.pyc&#x27;</span>,<span class="string">&#x27;.py&#x27;</span>, top_frame[<span class="number">0</span>])</span><br><span class="line">    my_file = re.sub(<span class="string">r&#x27;\.pyc&#x27;</span>,<span class="string">&#x27;.py&#x27;</span>, __file__)</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line"><span class="comment">#    if err_file == my_file:</span></span><br><span class="line"><span class="comment">#      return None</span></span><br><span class="line"><span class="comment">#    else:</span></span><br><span class="line"><span class="comment">#      LOG.error(&quot;Failed to import &#x27;%s&#x27;&quot; % (module,))</span></span><br><span class="line"><span class="comment">#      raise</span></span><br></pre></td></tr></table></figure><p><strong>éšåå°±å¯ä»¥åœ¨pythonä»£ç ä¸­è®¾ç½®æ–­ç‚¹ï¼Œå¯åŠ¨debugé…ç½®è¿›è¡Œè°ƒè¯•ã€‚</strong></p><h2 id="Appå¼€å‘demoå®ä¾‹"><a href="#Appå¼€å‘demoå®ä¾‹" class="headerlink" title="Appå¼€å‘demoå®ä¾‹"></a>Appå¼€å‘demoå®ä¾‹</h2><p>Appå¼€å‘å…¶å®ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œæ–‡æ¡£è¯´çš„è¿˜ç®—è¯¦ç»†ï¼Œä½†å¾€å¾€å®é™…æ“ä½œæ—¶éš¾å…ä¼šé‡åˆ°ä¸€äº›é”™è¯¯ï¼Œä¸‹é¢å°±æ¥çœ‹ä¸‹æˆ‘åœ¨å¼€å‘è¿™ä¸ªdemoçš„è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œ<em>æˆ‘ä½¿ç”¨çš„ç‰ˆæœ¬æ˜¯3.9.0ï¼Œç‰ˆæœ¬ä¸ä¸€æ ·é‡åˆ°çš„é—®é¢˜å¯èƒ½ä¹Ÿä¸ä¸€æ ·</em>ã€‚</p><p>1ã€åœ¨HUE_HOMEç›®å½•ä¸‹cdåˆ°appsç›®å½•ï¼Œ<em>ä¹‹æ‰€ä»¥è¦cdåˆ°appsç›®å½•ï¼Œå› ä¸ºéšåæ‰§è¡Œçš„åˆ›å»ºappçš„å‘½ä»¤ä¼šåœ¨å½“å‰ç›®å½•ä¸‹æ–°å»ºappç›®å½•ï¼Œä¸ºäº†å°†æ‰€æœ‰çš„appæ”¾åœ¨appsç›®å½•ä¸‹</em>ï¼Œæ‰€ä»¥è¦å…ˆcdåˆ°appsç›®å½•ã€‚</p><p>2ã€åœ¨appsç›®å½•ä¸‹æ‰§è¡Œæ–°å»ºå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../build/env/bin/hue create_desktop_app mytest</span><br></pre></td></tr></table></figure><p>æ–°å»ºä¹‹åï¼Œæ–‡æ¡£çš„ä¸‹ä¸€æ­¥æ˜¯æ‰§è¡Œæ³¨å†Œappï¼Œä½†æ˜¯ç»æˆ‘å®æµ‹ï¼Œ3.9.0è¿˜éœ€è¿›è¡Œä¸€äº›ä¿®æ”¹ï¼Œå¦‚ä¸‹ï¼š<br>3ã€ä¿®æ”¹æ–°å»ºApp mytestç›®å½•ä¸‹çš„Makefileï¼Œå¢åŠ <code>APP_NAME = mytest</code></p><p>4ã€æ›´æ”¹App mytestçš„staticçš„ç›®å½•ç»“æ„ã€‚è¿›å…¥<code>/home/hadoop/hue-3.9.0/apps/mytest/src/mytest/static</code>ç›®å½•ï¼Œæ–°å»ºAppåŒåçš„æ–‡ä»¶å¤¹mytestï¼Œå°†åŸstaticç›®å½•ä¸‹çš„æ–‡ä»¶ç§»åˆ°æ–°å»ºçš„mytestæ–‡ä»¶å¤¹ä¸­ã€‚å¦‚æœæ­¤æ­¥æ²¡æœ‰æ‰§è¡Œçš„è¯ï¼Œè¯¥Appçš„<em>ä¸€äº›é™æ€æ–‡ä»¶å°±ä¼šæ‰¾ä¸åˆ°ï¼Œå‡ºç°404é”™è¯¯</em>ï¼Œ<code>Http404: &quot;/home/hadoop/hue-3.9.0/build/static/mytest/art/icon_mytest_48.32900276221d.png&quot; ä¸å­˜åœ¨</code></p><p>5ã€å¯ä»¥åœ¨App mytestç›®å½•ä¸‹çš„setup.pyæ–‡ä»¶ä¸­ä¿®æ”¹ä¸‹è¯¥appçš„ä¸€äº›ä¿¡æ¯ï¼Œæ¯”å¦‚ æè¿°ä¿¡æ¯ã€ä½œè€…ç­‰ç­‰ã€‚ã€‚ã€‚</p><p>6ã€ä¿®æ”¹ä»£ç ã€‚ä¿®æ”¹mytestä¸­çš„shared_components.makoä»£ç ï¼Œå°†<code>&lt;img src=&quot;$&#123; static(mytest + &#39;/art/icon_mytest_48.png&#39;) &#125;&quot; class=&quot;app-icon&quot; /&gt;</code><br>ä¸­çš„myteståŠ ä¸Šå¼•å·ï¼Œå¦åˆ™ä¼šæŠ¥<code>TypeError: unsupported operand type(s) for +: &#39;Undefined&#39; and &#39;str&#39;</code></p><p>7ã€æ¥ä¸‹æ¥å°±æ˜¯æ³¨å†ŒAppï¼Œä¾ç„¶æ˜¯åœ¨appsç›®å½•ä¸‹æ‰§è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">../build/env/bin/python ../tools/app_reg/app_reg.py --install mytest --relative-paths</span><br></pre></td></tr></table></figure><blockquote><p>å¯ä»¥ä½¿ç”¨å‘½ä»¤<code>build/env/bin/python tools/app_reg/app_reg.py --list</code> æŸ¥çœ‹å·²å®‰è£…appçš„ä¿¡æ¯ã€‚</p></blockquote><!-- build/env/bin/python tools/app_reg/app_reg.py --list 2>&1 | grep mytest --><p>ç°åœ¨å°±å¯ä»¥æ­£å¸¸è®¿é—®é¡µé¢äº†ã€‚æ­¤æ—¶åªæ˜¯ä¸€ä¸ªç±»ä¼¼hello-worldçš„åŠŸèƒ½ï¼Œæˆ‘ä»¬åœ¨æ­¤åŸºç¡€ä¸Šå†å¢åŠ ä¸€ç‚¹å°åŠŸèƒ½ï¼Œä¸€ä¸ªå°å°çš„è®¡ç®—å™¨ã€‚</p><p>8ã€HUEçš„templateè¯­è¨€æ˜¯ç”¨makoå†™çš„ï¼Œåˆ™ä¿®æ”¹<code>mytest/src/mytest/templates/index.mako</code>æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">&lt;%!<span class="keyword">from</span> desktop.views <span class="keyword">import</span> commonheader, commonfooter %&gt;</span><br><span class="line">&lt;%namespace name=<span class="string">&quot;shared&quot;</span> file=<span class="string">&quot;shared_components.mako&quot;</span> /&gt;</span><br><span class="line"></span><br><span class="line">$&#123;commonheader(<span class="string">&quot;mytest&quot;</span>, <span class="string">&quot;mytest&quot;</span>, user, <span class="string">&quot;100px&quot;</span>) | n,unicode&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## Main body</span></span><br><span class="line"></span><br><span class="line">&lt;div <span class="class"><span class="keyword">class</span>=&quot;<span class="title">container</span>-<span class="title">fluid</span>&quot;&gt;</span></span><br><span class="line"><span class="class">% <span class="title">if</span> <span class="title">op</span>:</span></span><br><span class="line">&lt;span&gt;$&#123;a&#125; $&#123;op&#125; $&#123;b&#125; = $&#123;result&#125;&lt;/span&gt;</span><br><span class="line">% endif</span><br><span class="line">&lt;form action=$&#123;url(<span class="string">&quot;mytest.views.index&quot;</span>)&#125; method=POST&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> name=<span class="string">&quot;a&quot;</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;add&quot;</span>&gt;+&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;subtract&quot;</span>&gt;-&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;multiply&quot;</span>&gt;*&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;divide&quot;</span>&gt;/&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> name=<span class="string">&quot;b&quot;</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Calculate&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br><span class="line">&lt;/div&gt;</span><br><span class="line">$&#123;commonfooter(messages) | n,unicode&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨é¡µé¢å·²ç»å†™å¥½ï¼Œæ¥ä¸‹æ¥å°±æ˜¯viewsé‡Œçš„è®¡ç®—é€»è¾‘äº†ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> desktop.lib.django_util <span class="keyword">import</span> render</span><br><span class="line"><span class="keyword">import</span> operator</span><br><span class="line"></span><br><span class="line">OPS=<span class="built_in">dict</span>(add=operator.add, subtract=operator.sub, multiply=operator.mul, divide=operator.truediv)</span><br><span class="line">OP_STRING=<span class="built_in">dict</span>(add=<span class="string">&quot;+&quot;</span>, subtract=<span class="string">&quot;-&quot;</span>, multiply=<span class="string">&quot;*&quot;</span>, divide=<span class="string">&quot;/&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">index</span>(<span class="params">request</span>):</span></span><br><span class="line">    <span class="keyword">if</span> <span class="string">&quot;op&quot;</span> <span class="keyword">not</span> <span class="keyword">in</span> request.REQUEST:</span><br><span class="line">        <span class="keyword">return</span> render(<span class="string">&#x27;index.mako&#x27;</span>, request, <span class="built_in">dict</span>())</span><br><span class="line">    a = <span class="built_in">float</span>(request.REQUEST[<span class="string">&quot;a&quot;</span>])</span><br><span class="line">    b = <span class="built_in">float</span>(request.REQUEST[<span class="string">&quot;b&quot;</span>])</span><br><span class="line">    op = request.REQUEST[<span class="string">&quot;op&quot;</span>]</span><br><span class="line">    result = OPS[op](a, b)</span><br><span class="line">    <span class="keyword">return</span> render(<span class="string">&#x27;index.mako&#x27;</span>, request,</span><br><span class="line"><span class="built_in">dict</span>(a=a, b=b, op=OP_STRING[op], result=result))</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶å°±å¯ä»¥å»æµ‹è¯•ä¸‹mytestçš„æ–°åŠŸèƒ½äº†ï¼Œå¾ˆä¸å¹¸æŠ¥é”™äº†ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CSRF Error (403)</span><br><span class="line">Sorry, your session is invalid or has expired. Please go back, refresh the page, and try your submission again.</span><br></pre></td></tr></table></figure><p>CSRF(Cross-site request forgery è·¨ç«™è¯·æ±‚ä¼ªé€ )å¤±è´¥ï¼Œåœ¨index.makoä¸­æ·»åŠ <code>$&#123; csrf_token(request) | n,unicode &#125;</code>å³å¯ï¼Œæ­£ç¡®ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;form action=$&#123;url(<span class="string">&quot;mytest.views.index&quot;</span>)&#125; method=POST&gt;</span><br><span class="line">    $&#123; csrf_token(request) | n,unicode &#125;</span><br><span class="line">    &lt;<span class="built_in">input</span> name=<span class="string">&quot;a&quot;</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;add&quot;</span>&gt;+&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;subtract&quot;</span>&gt;-&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;multiply&quot;</span>&gt;*&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;radio&quot;</span> name=<span class="string">&quot;op&quot;</span> value=<span class="string">&quot;divide&quot;</span>&gt;/&lt;/<span class="built_in">input</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> name=<span class="string">&quot;b&quot;</span>&gt;</span><br><span class="line">    &lt;<span class="built_in">input</span> <span class="built_in">type</span>=<span class="string">&quot;submit&quot;</span> value=<span class="string">&quot;Calculate&quot;</span>&gt;</span><br><span class="line">&lt;/form&gt;</span><br></pre></td></tr></table></figure><p>æœ€åçœ‹ä¸‹é¡µé¢å§ï¼Œ<br>![app_demo](/blogimgs/HUE App/app_demo_done.png â€œapp_demoâ€)</p><p>Doneã€‚ã€‚ã€‚ã€‚</p><h2 id="Mysqlå…ƒæ•°æ®ç®¡ç†Appå¼€å‘"><a href="#Mysqlå…ƒæ•°æ®ç®¡ç†Appå¼€å‘" class="headerlink" title="Mysqlå…ƒæ•°æ®ç®¡ç†Appå¼€å‘"></a>Mysqlå…ƒæ•°æ®ç®¡ç†Appå¼€å‘</h2><p>Mysqlå…ƒæ•°æ®ç®¡ç†åŠŸèƒ½æ˜¯ä¸€ä¸ªç±»ä¼¼hiveå…ƒæ•°æ®ç®¡ç†çš„ç®¡ç†æ¨¡å—ï¼Œå¯ä»¥æŸ¥çœ‹mysqlæ•°æ®åº“ä¸­çš„databaseså’Œtablesä»¥åŠä¿®æ”¹ä»–ä»¬çš„COMMENTä¿¡æ¯ã€‚å…·ä½“å®ç°æ˜¯æ‹·è´hiveå…ƒæ•°æ®ç®¡ç†çš„ä»£ç ï¼Œåœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†ä¿®æ”¹ï¼Œå®Œæˆæ­¤åŠŸèƒ½çš„ï¼Œç›®å‰åªæ”¯æŒmysqlï¼Œä¸”è¦ä½¿ç”¨æ­¤åŠŸèƒ½æ—¶éœ€è¦é…ç½®DB queryåŠŸèƒ½ã€‚</p><blockquote><p>æ­¤åŠŸèƒ½æ˜¯åœ¨hue3.7ç‰ˆæœ¬ä¸Šå¼€å‘çš„ã€‚</p></blockquote><p>ä¸‹é¢å°±çœ‹å‡ ä¸ªé¡µé¢å§ï¼Œä»£ç éšåæ•´ç†ä¸‹ä¼šæŠŠé“¾æ¥æ”¾å‡ºæ¥ã€‚<br>![msyql_01](/blogimgs/HUE App/mysql_01.png â€œmysql_01â€)<br>![mysql_02](/blogimgs/HUE App/mysql_02.png â€œmysql_02â€)</p><p>å¼€å‘èµ·æ¥éš¾åº¦ä¸æ˜¯å¾ˆå¤§ï¼Œä¸èƒ½ä¸è¯´å¤§ç¥å†™çš„ä»£ç å°±æ˜¯å¼ºï¼Œæœ‰äº›ä»£ç è™½ç„¶çœ‹ä¸æ‡‚ï¼Œä½†ä¸€æ”¹å°±å®ç°äº†æƒ³è¦çš„åŠŸèƒ½ï¼Œæ¥å£æ€§ç‰¹åˆ«å¼ºã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://wanshi.iteye.com/blog/2173415">http://wanshi.iteye.com/blog/2173415</a><br><a href="http://cloudera.github.io/hue/docs-3.7.0/sdk/sdk.html#fast-guide-to-creating-a-new-hue-application">http://cloudera.github.io/hue/docs-3.7.0/sdk/sdk.html#fast-guide-to-creating-a-new-hue-application</a></p>]]></content>
      
      
      <categories>
          
          <category> HUE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> HUE </tag>
            
            <tag> å¼€å‘ç¯å¢ƒ </tag>
            
            <tag> appäºŒæ¬¡å¼€å‘ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSç§Ÿçº¦è§£æ</title>
      <link href="/HDFS%E7%A7%9F%E7%BA%A6%E8%A7%A3%E6%9E%90.html"/>
      <url>/HDFS%E7%A7%9F%E7%BA%A6%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p>ç§Ÿçº¦(Lease)æ˜¯ä¸€ç§å¹¿æ³›åº”ç”¨ä¸åˆ†å¸ƒå¼ç³»ç»Ÿé¢†åŸŸçš„åè®®ï¼Œä¸»è¦ç”¨æ¥ç»´æŠ¤åˆ†å¸ƒå¼ç³»ç»Ÿçš„ä¸€è‡´æ€§ã€‚</p><p>ç§Ÿçº¦æ˜¯åœ¨è§£å†³ç¼“å­˜ä¸€è‡´æ€§æ—¶è¢«æå‡ºçš„ã€‚æ‰€è°“ç§Ÿçº¦ï¼Œå…¶å®å°±æ˜¯ä¸€ä¸ª_åˆåŒ_ï¼Œå³æœåŠ¡å™¨ç»™äºˆ_å®¢æˆ·ç«¯_åœ¨_ä¸€å®šæœŸé™_å†…å¯ä»¥_æ§åˆ¶ä¿®æ”¹æ“ä½œ_çš„æƒåŠ›ã€‚_å¦‚æœæœåŠ¡å™¨è¦ä¿®æ”¹æ•°æ®ï¼Œé¦–å…ˆè¦å¾æ±‚æ‹¥æœ‰è¿™å—æ•°æ®çš„ç§Ÿçº¦çš„å®¢æˆ·ç«¯çš„åŒæ„ï¼Œä¹‹åæ‰å¯ä»¥ä¿®æ”¹ã€‚_å®¢æˆ·ç«¯ä»æœåŠ¡å™¨è¯»å–æ•°æ®æ—¶å¾€å¾€å°±åŒæ—¶è·å–ç§Ÿçº¦ï¼Œåœ¨ç§Ÿçº¦æœŸé™å†…ï¼Œå¦‚æœæ²¡æœ‰æ”¶åˆ°æœåŠ¡å™¨çš„ä¿®æ”¹è¯·æ±‚ï¼Œå°±å¯ä»¥ä¿è¯å½“å‰ç¼“å­˜ä¸­çš„å†…å®¹å°±æ˜¯æœ€æ–°çš„ã€‚å¦‚æœåœ¨ç§Ÿçº¦æœŸé™å†…æ”¶åˆ°äº†ä¿®æ”¹æ•°æ®çš„è¯·æ±‚å¹¶ä¸”åŒæ„äº†ï¼Œå°±éœ€è¦æ¸…ç©ºç¼“å­˜ã€‚åœ¨ç§Ÿçº¦è¿‡ æœŸä»¥åï¼Œå®¢æˆ·ç«¯å¦‚æœè¿˜è¦ä»ç¼“å­˜è¯»å–æ•°æ®ï¼Œå°±å¿…é¡»é‡æ–°è·å–ç§Ÿçº¦ï¼Œæˆ‘ä»¬ç§°è¿™ä¸ªæ“ä½œä¸ºç»­çº¦ã€‚</p><span id="more"></span><h2 id="ç§Ÿçº¦ç‰¹æ€§"><a href="#ç§Ÿçº¦ç‰¹æ€§" class="headerlink" title="ç§Ÿçº¦ç‰¹æ€§"></a>ç§Ÿçº¦ç‰¹æ€§</h2><p>ç§Ÿçº¦çš„ä¸€ä¸ªé‡è¦çš„å±æ€§å°±æ˜¯<em>æœŸé™</em>ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œåº”å½“é€‰æ‹©è¾ƒçŸ­çš„ç§Ÿçº¦æœŸé™ã€‚ä¸é•¿ç§Ÿçº¦ç›¸æ¯”ï¼ŒçŸ­ç§Ÿçº¦æœ‰ä¸‰ä¸ªä¼˜ç‚¹ã€‚é¦–å…ˆï¼Œåœ¨å¤±æ•ˆæƒ…å†µä¸‹ä¿®æ”¹æ“ä½œå¾€å¾€éœ€è¦ç­‰å¾…ç§Ÿçº¦è¿‡æœŸï¼Œå› æ­¤çŸ­ç§Ÿçº¦å°±æ„å‘³ç€æ›´çŸ­çš„å¤±æ•ˆå»¶è¿Ÿ ã€‚å…¶æ¬¡ï¼Œ<em>å°±ç®—ä¸€ä¸ªå®¢æˆ·ç«¯å·²ç»ä¸å†éœ€è¦è¯»å–æ•°æ®ï¼Œä½†åœ¨å…¶ç§Ÿçº¦è¿‡æœŸå‰ï¼Œä»»ä½•çš„ä¿®æ”¹æ“ä½œä»ç„¶éœ€è¦å¾æ±‚å®ƒçš„åŒæ„ï¼Œè¿™ç§æƒ…å†µå«åšâ€œå‡å…±äº«â€</em>ï¼Œæ˜¾ç„¶ç§Ÿçº¦æœŸé™è¶Šé•¿ï¼Œè¿™ä¸ªé—®é¢˜å°±è¶Šä¸¥é‡ã€‚æœ€åï¼ŒçŸ­ç§Ÿçº¦ä¹Ÿä½¿å¾—æœåŠ¡å™¨è¦ç»´æŠ¤çš„å®¢æˆ·ç«¯ä¿¡æ¯æ›´å°‘ã€‚ç„¶è€ŒçŸ­ç§Ÿçº¦ä¹Ÿæ„å‘³ç€æ›´å¤§çš„ç»­çº¦å¼€é”€ï¼Œå› æ­¤å¯¹äºè¦åå¤è¯»å–å´å¾ˆå°‘ä¿®æ”¹çš„æ•°æ®ï¼Œé•¿ç§Ÿçº¦ä¼šæ›´æœ‰æ•ˆã€‚å› æ­¤ï¼Œå¯¹ç§Ÿçº¦æœŸçš„é€‰æ‹©è¦æƒè¡¡å¤±æ•ˆå»¶è¿Ÿã€å‡å…±äº«å¼€é”€å’Œç»­çº¦å¼€é”€ç­‰å¤šä¸ªå› ç´ ï¼ŒæœåŠ¡å™¨å¯ä»¥æ ¹æ®æ•°æ®è®¿é—®ç‰¹æ€§å’Œå®¢æˆ·ç«¯çš„æ€§è´¨çµæ´»è®¾ç½®æœŸé™ã€‚äº‹å®ä¸Šï¼Œå¦‚æœæˆ‘ä»¬æŠŠç§Ÿçº¦æœŸé™è®¾ä¸ºé›¶ï¼Œå°±ç›¸å½“äº<em>è½®è¯¢</em>ï¼Œæ­¤æ—¶ä¿®æ”¹æ“ä½œéšæ—¶å¯ä»¥è¿›è¡Œï¼Œè€Œè¯»å–æ•°æ®æ€»æ˜¯è¦è”ç³»æœåŠ¡å™¨ã€‚å¦‚æœæŠŠç§Ÿçº¦æœŸ é™è®¾ä¸ºæ— é™é•¿ï¼Œå°±ç›¸å½“äº<em>å›è°ƒ</em>ã€‚</p><p>é™¤äº†æœŸé™çš„é€‰æ‹©ï¼Œè¿˜æœ‰å¾ˆå¤šç®¡ç†é€‰é¡¹ã€‚å¯¹å®¢æˆ·ç«¯æ¥è¯´ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦ç»­çº¦ã€ä½•æ—¶ç»­çº¦ä»¥åŠæ˜¯å¦åŒæ„ä¿®æ”¹ç­‰ã€‚æ¯”å¦‚ä¸ºäº†å‡å°‘è¯»å–å»¶è¿Ÿï¼Œå®¢æˆ·ç«¯å¯ä»¥åœ¨ç§Ÿçº¦è¿‡æœŸå‰å°±ç»­çº¦ï¼Œä¸è¿‡è¿™æ ·å¯èƒ½åŠ é‡æœåŠ¡å™¨çš„è´Ÿæ‹…ã€‚å¯¹æœåŠ¡å™¨æ¥è¯´ï¼Œå¯ä»¥é€‰æ‹©æ˜¯å¦å‘æ”¾ç§Ÿçº¦ã€ç§Ÿçº¦è¦†ç›–ç²’åº¦ä»¥åŠå¯¹å¦‚ä½•è¿›è¡Œä¿®æ”¹æ“ä½œã€‚æ¯”å¦‚åœ¨æ”¶åˆ°ä¿®æ”¹è¯·æ±‚åï¼ŒæœåŠ¡å™¨å¯ä»¥ä¸å¾æ±‚å®¢æˆ·ç«¯åŒæ„ï¼Œè€Œæ˜¯ç®€å•çš„ç­‰å¾…æ‰€æœ‰ç§Ÿçº¦è¿‡æœŸï¼ˆç­‰å¾…æ—¶ä¸å†å‘æ”¾æ–°ç§Ÿçº¦ä»¥é¿å…æ— é™æœŸçš„å»¶è¿Ÿï¼‰ã€‚å¯¹äºâ€œå®‰è£…æ–‡ä»¶â€ï¼Œä¹Ÿå°±æ˜¯ä¿®æ”¹æå°‘çš„æ–‡ä»¶ï¼ˆæ¯”å¦‚å¤´æ–‡ä»¶ã€åº“æ–‡ä»¶ï¼‰ï¼ŒæœåŠ¡å™¨å¯ä»¥ç”¨ä¸€ä¸ªç§Ÿçº¦æ¥è¦†ç›–ä¸€æ‰¹æ–‡ä»¶ï¼ŒåŒæ—¶å®šæœŸå¹¿æ’­ç»­çº¦é€šçŸ¥æ¥èŠ‚çœå¼€é”€ï¼Œå¦‚æœéœ€è¦ä¿®æ”¹æ•°æ®ï¼Œå°±åœæ­¢å¹¿æ’­å¹¶ç­‰å¾…ç§Ÿçº¦è¿‡æœŸå³å¯ã€‚</p><p>åœ¨å¾ˆå¤šæ—¶å€™ï¼Œç§Ÿçº¦çš„å®šä¹‰ä¼¼ä¹å¾ˆæ¨¡ç³Šï¼Œæœ‰çš„æ—¶å€™ç§Ÿçº¦ç±»ä¼¼<em>å¿ƒè·³</em>ï¼Œæœ‰çš„æ—¶å€™åˆç±»ä¼¼äº<em>é”(è¯»é”å’Œå†™é”)<em>ã€‚åˆ°åº•ç§Ÿçº¦çš„æœ¬è´¨æ˜¯ä»€ä¹ˆå‘¢ï¼Ÿ<br>å›åˆ°ç§Ÿçº¦æœ€åŸå§‹çš„å®šä¹‰ï¼š<strong>ç§Ÿçº¦å°±æ˜¯åœ¨ä¸€å®šæœŸé™å†…ç»™äºˆæŒæœ‰è€…ç‰¹å®šæƒåŠ›çš„åè®®</strong>ã€‚æˆ‘è§‰å¾—è¿™é‡Œçš„æœŸé™å°±æ˜¯ç§Ÿçº¦çš„æ ¹æœ¬ç‰¹æ€§ï¼Œæ­£æ˜¯è¿™ä¸€ç‰¹æ€§ä½¿å¾—ç§Ÿçº¦å¯ä»¥å®¹å¿æœºå™¨å¤±æ•ˆå’Œç½‘ç»œåˆ†å‰²ã€‚åœ¨æœŸé™ä¹‹å†…ï¼Œç§Ÿçº¦å…¶å®å°±æ˜¯æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ä¹‹é—´çš„åè®®ï¼Œè€Œè¿™ä¸ªåè®®çš„å†…å®¹å¯ä»¥äº”èŠ±å…«é—¨ã€‚</em>å¦‚æœåè®®å†…å®¹æ˜¯æœåŠ¡å™¨ç¡®è®¤å®¢æˆ·ç«¯è¿˜å­˜æ´»ï¼Œé‚£ä¹ˆè¿™ä¸ªç§Ÿçº¦çš„åŠŸèƒ½å°±ç›¸å½“äºå¿ƒè·³</em>ï¼›<em>å¦‚æœåè®®å†…å®¹æ˜¯æœåŠ¡å™¨ä¿è¯å†…å®¹ä¸ä¼šè¢«ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ªç§Ÿçº¦å°±ç›¸å½“äºè¯»é”</em>ï¼›<em>å¦‚æœåè®®å†…å®¹æ˜¯æœåŠ¡å™¨ä¿è¯å†…å®¹åªèƒ½è¢«è¿™ä¸ªå®¢æˆ·ç«¯ä¿®æ”¹ï¼Œé‚£ä¹ˆè¿™ä¸ªç§Ÿçº¦å°±ç›¸å½“äºå†™é”</em>ã€‚ç§Ÿçº¦è¿™ç§çµæ´»æ€§å’Œå®¹é”™æ€§ï¼Œä½¿å…¶æˆä¸ºäº†ç»´æŠ¤åˆ†å¸ƒå¼ç³»ç»Ÿä¸€è‡´æ€§çš„æœ‰æ•ˆå·¥å…·ã€‚</p><h2 id="ç§Ÿçº¦åœ¨HDFSä¸­çš„åº”ç”¨â€“å†™é”"><a href="#ç§Ÿçº¦åœ¨HDFSä¸­çš„åº”ç”¨â€“å†™é”" class="headerlink" title="ç§Ÿçº¦åœ¨HDFSä¸­çš„åº”ç”¨â€“å†™é”"></a>ç§Ÿçº¦åœ¨HDFSä¸­çš„åº”ç”¨â€“å†™é”</h2><p>hdfsæ”¯æŒwrite-once-read-manyï¼Œä¹Ÿå°±æ˜¯è¯´ä¸æ”¯æŒå¹¶è¡Œå†™ï¼Œé‚£ä¹ˆå¯¹è¯»å†™çš„äº’æ–¥åŒæ­¥å°±æ˜¯é Leaseå®ç°çš„ã€‚Leaseè¯´ç™½äº†å°±æ˜¯ä¸€ä¸ªæœ‰æ—¶é—´çº¦æŸçš„é”ã€‚å®¢æˆ·ç«¯å†™æ–‡ä»¶æ—¶éœ€è¦å…ˆç”³è¯·ä¸€ä¸ªLeaseï¼ŒæŒæœ‰è¯¥ç§Ÿçº¦çš„å®¢æˆ·ç«¯æ‰å¯ä»¥å¯¹ç›¸åº”çš„æ–‡ä»¶è¿›è¡Œå—çš„æ·»åŠ ã€‚</p><p>ä¸ç§Ÿçº¦ç›¸å…³çš„ç±»æœ‰ï¼š</p><p>Serverç«¯ï¼š<br>LeaseManager â€“ ç®¡ç†å†™æ–‡ä»¶ç›¸å…³çš„ç§Ÿçº¦<br>LeaseManager.Monitor â€“ ç›‘æ§ç§Ÿçº¦æ˜¯å¦è¿‡æœŸ(ä¸»è¦æ£€æŸ¥hardLimit)<br>LeaseManager.Lease â€“ ç§Ÿçº¦å®ä½“ç±»ï¼Œç®¡ç†æŸä¸ªå®¢æˆ·ç«¯æŒæœ‰çš„æ‰€ä»¥å†™é”</p><p>Clientç«¯ï¼š<br>LeaseRenewer â€“ å®¢æˆ·ç«¯ç»­çº¦æ›´æ–°ç±»<br>ä¸‹é¢å…ˆç®€å•ä»‹ç»ä¸‹å„ç±»çš„å†…éƒ¨ç»“æ„</p><h3 id="Lease"><a href="#Lease" class="headerlink" title="Lease"></a>Lease</h3><p>Leaseæ˜¯LeaseManagerçš„å†…éƒ¨ç±»ï¼Œå…¶å®ä¾‹å¯¹åº”ä¸€ä¸ªç§Ÿçº¦ï¼Œç§Ÿçº¦ä¸­åŒ…å«æŒæœ‰è€…ä¿¡æ¯ã€ç§Ÿçº¦æœŸé™å’Œè¯¥ç§Ÿçº¦å¯¹åº”çš„æ–‡ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Lease</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Lease</span>&gt; </span>&#123;</span><br><span class="line">  <span class="comment">// ç§Ÿçº¦æŒæœ‰è€…(æŒæœ‰ç§Ÿçº¦çš„å®¢æˆ·ç«¯åå­—)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> String holder;</span><br><span class="line">  <span class="comment">// ç§Ÿçº¦æ›´æ–°çš„æ—¶é—´</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">long</span> lastUpdate;</span><br><span class="line">  <span class="comment">// è¯¥ç§Ÿçº¦ä¸­åŒ…å«çš„æ–‡ä»¶(åŒ…å«æŒæœ‰è¯¥ç§Ÿçº¦çš„å®¢æˆ·ç«¯æ‰€æ‰“å¼€çš„æ‰€æœ‰æ–‡ä»¶)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> Collection&lt;String&gt; paths = <span class="keyword">new</span> TreeSet&lt;String&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸€ä¸ªå®¢æˆ·ç«¯å¯¹åº”ä¸€ä¸ªç§Ÿçº¦ï¼Œä¸€ä¸ªå®¢æˆ·ç«¯å¯ä»¥åŒæ—¶å†™å¾ˆå¤šä¸ªæ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶æ”¾åœ¨<code>paths</code>ä¸­ï¼Œç§Ÿçº¦ç»´æŠ¤ç€è¿™äº›æ–‡ä»¶çš„å†™æƒé™ï¼Œå¹¶<em>å¯¹è¿™äº›æ–‡ä»¶ç»Ÿä¸€ç»­çº¦ï¼Œå¹¶ä¸æ˜¯å¯¹æŸä¸ªæ–‡ä»¶å•ç‹¬ç»­çº¦</em>ï¼Œä¸éœ€è¦å¯¹æŸä¸ªæ–‡ä»¶è¿›è¡Œæ“ä½œä¹‹åç›´æ¥ä»<code>paths</code>ä¸­ç§»é™¤ï¼Œå¦‚æœ<code>paths</code>ä¸ºnullï¼Œåˆ™å›æ”¶æ­¤ç§Ÿçº¦ã€‚</p><h3 id="LeaseManager"><a href="#LeaseManager" class="headerlink" title="LeaseManager"></a>LeaseManager</h3><p>LeaseManageræ˜¯ç§Ÿçº¦ç®¡ç†ç±»ï¼Œå…¶å†…éƒ¨ä¸»è¦ç»´æŠ¤äº†3ä¸ªé›†åˆåˆ—è¡¨(leasesã€sortedLeaseså’ŒsortedLeasesByPath)å’Œä¸¤ä¸ªå˜é‡(softLimitå’ŒhardLimit)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è½¯é™åˆ¶å°±æ˜¯å†™æ–‡ä»¶æ—¶è§„å®šçš„ç§Ÿçº¦è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤æ˜¯60s</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> softLimit = HdfsConstants.LEASE_SOFTLIMIT_PERIOD;</span><br><span class="line"><span class="comment">// ç¡¬é™åˆ¶åˆ™æ˜¯è€ƒè™‘åˆ°æ–‡ä»¶closeæ—¶æœªæ¥å¾—åŠé‡Šæ”¾leaseçš„æƒ…å†µå¼ºåˆ¶å›æ”¶ç§Ÿçº¦ï¼Œé»˜è®¤æ˜¯1h</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> hardLimit = HdfsConstants.LEASE_HARDLIMIT_PERIOD;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// Used for handling lock-leases</span></span><br><span class="line"><span class="comment">// Mapping: leaseHolder -&gt; Lease</span></span><br><span class="line"><span class="comment">// ç§Ÿçº¦æŒæœ‰è€…å’Œç§Ÿçº¦çš„æ˜ å°„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SortedMap&lt;String, Lease&gt; leases = <span class="keyword">new</span> TreeMap&lt;String, Lease&gt;();</span><br><span class="line"><span class="comment">// Set of: Lease</span></span><br><span class="line"><span class="comment">// å­˜å‚¨nnæ‰€å‘æ”¾çš„æ‰€æœ‰ç§Ÿçº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SortedSet&lt;Lease&gt; sortedLeases = <span class="keyword">new</span> TreeSet&lt;Lease&gt;();</span><br><span class="line"></span><br><span class="line"><span class="comment">// </span></span><br><span class="line"><span class="comment">// Map path names to leases. It is protected by the sortedLeases lock.</span></span><br><span class="line"><span class="comment">// The map stores pathnames in lexicographical order.</span></span><br><span class="line"><span class="comment">// è·¯å¾„å’Œç§Ÿçº¦çš„æ˜ å°„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> SortedMap&lt;String, Lease&gt; sortedLeasesByPath = <span class="keyword">new</span> TreeMap&lt;String, Lease&gt;();</span><br></pre></td></tr></table></figure><p>åœ¨softLimitæœŸé™å†…ï¼Œè¯¥å®¢æˆ·ç«¯æ‹¥æœ‰å¯¹è¿™ä¸ªæ–‡ä»¶çš„ç‹¬ç«‹è®¿é—®æƒï¼Œå…¶ä»–å®¢æˆ·ç«¯ä¸èƒ½å‰¥å¤ºè¯¥å®¢æˆ·ç«¯ç‹¬å å†™è¿™ä¸ªæ–‡ä»¶çš„æƒåˆ©ã€‚<br>softLimitè¿‡æœŸåï¼Œä»»ä½•ä¸€ä¸ªå®¢æˆ·ç«¯éƒ½å¯ä»¥å›æ”¶leaseï¼Œç»§è€Œå¾—åˆ°è¿™ä¸ªæ–‡ä»¶çš„leaseï¼Œè·å¾—å¯¹è¿™ä¸ªæ–‡ä»¶çš„ç‹¬å è®¿é—®æƒã€‚<br>hardLimitè¿‡æœŸåï¼Œnamenodeå¼ºåˆ¶å…³é—­æ–‡ä»¶ï¼Œæ’¤é”€leaseã€‚</p><p>sortedLeasesä¸­å­˜æ”¾è¿™ä»nnå‘å‡ºçš„æ‰€æœ‰ç§Ÿçº¦ï¼Œå…¶ä¸­LeaseæŒ‰ç…§æ—¶é—´é¡ºåºæ’åºï¼ŒMonitoræ£€æŸ¥hardLimitæ—¶ï¼Œä»sortedLeasesä¸­æŒ‰ç…§é¡ºåºæ‹¿å‡ºLeaseæ£€æŸ¥å°±å¯ä»¥äº†ã€‚</p><h3 id="Monitor"><a href="#Monitor" class="headerlink" title="Monitor"></a>Monitor</h3><p>Monitoræ˜¯ä¸€ä¸ªRunnableç±»ï¼Œä¸»è¦ç”¨æ¥æ£€æµ‹Lease<em>æ˜¯å¦è¶…è¿‡äº†hardLimitæœŸé™</em>ã€‚åœ¨runä¸­è°ƒç”¨LeaseManager.checkLeasesæ–¹æ³•è¿›è¡Œæ£€æµ‹ã€‚å…¶å‘¨æœŸæ€§æ˜¯(2s)</p><h3 id="LeaseRenewer"><a href="#LeaseRenewer" class="headerlink" title="LeaseRenewer"></a>LeaseRenewer</h3><p>LeaseReneweræ˜¯clientç«¯æ›´æ–°è‡ªå·±ç§Ÿçº¦ã€‚å…¶ä¸­æœ‰ä¸ª<em>çº¿ç¨‹æ£€æµ‹ç§Ÿçº¦çš„softLimitæœŸé™</em>ï¼Œå…¶å‘¨æœŸæ€§(1s)çš„è°ƒç”¨LeaseRenewer.run()æ–¹æ³•å¯¹ç§Ÿçº¦è¿‡åŠçš„leaseè¿›è¡Œç»­çº¦ã€‚</p><p>LeaseReneweræ˜¯ä¸€ä¸ªå•ä¾‹ï¼Œå¹¶é€šè¿‡å·¥å‚æ¥å®ä¾‹åŒ–ã€‚è¿™é‡Œçš„å•ä¾‹æ˜¯ä¸€ä¸ªuserä¸€ä¸ªLeaseRenewerï¼Œä½†æ˜¯æœåŠ¡å™¨ç«¯æ˜¯ä¸€ä¸ªDFSClientå¯¹åº”ä¸€ä¸ªleaseï¼Œ<em>ä¸€ä¸ªuserå¯èƒ½ä¼šå®ä¾‹åŒ–å¤šä¸ªDFSClientï¼Œåˆ™LeaseRenewerä¼šæœ‰ä¸ªlistå±æ€§æ¥å­˜å‚¨å¤šä¸ªDFSClientï¼Œè¿™ä¸ªlistå°±æ˜¯dfsclients</em>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">LeaseRenewer</span> </span>&#123;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> Log LOG = LogFactory.getLog(LeaseRenewer.class);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> LEASE_RENEWER_GRACE_DEFAULT = <span class="number">60</span>*<span class="number">1000L</span>;</span><br><span class="line">  <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> LEASE_RENEWER_SLEEP_DEFAULT = <span class="number">1000L</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** Get a &#123;<span class="doctag">@link</span> LeaseRenewer&#125; instance */</span></span><br><span class="line">  <span class="comment">// é€šè¿‡é™æ€æ–¹æ³•è°ƒç”¨å·¥å‚ç±»å¾—åˆ°ä¸€ä¸ªuserå¯¹åº”çš„LeaseRenewerå®ä¾‹</span></span><br><span class="line">  <span class="function"><span class="keyword">static</span> LeaseRenewer <span class="title">getInstance</span><span class="params">(<span class="keyword">final</span> String authority,</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">final</span> UserGroupInformation ugi, <span class="keyword">final</span> DFSClient dfsc)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> LeaseRenewer r = Factory.INSTANCE.get(authority, ugi);</span><br><span class="line">    r.addClient(dfsc);</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/** </span></span><br><span class="line"><span class="comment">   * A factory for sharing &#123;<span class="doctag">@link</span> LeaseRenewer&#125; objects</span></span><br><span class="line"><span class="comment">   * among &#123;<span class="doctag">@link</span> DFSClient&#125; instances</span></span><br><span class="line"><span class="comment">   * so that there is only one renewer per authority per user.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// å·¥å‚ç±»ï¼Œå®ä¾‹åŒ–LeaseRenewer</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Factory</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Factory INSTANCE = <span class="keyword">new</span> Factory();</span><br><span class="line">    <span class="comment">// ç”±å­˜æ”¾namenodeä¿¡æ¯çš„authorityå’Œuserä¿¡æ¯çš„ugiå”¯ä¸€æ ‡è¯†LeaseRenewerå®ä¾‹</span></span><br><span class="line">    <span class="comment">// å³ä¸€ä¸ªuserä¸€ä¸ªLeaseRenewer</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Key</span> </span>&#123;</span><br><span class="line">      <span class="comment">/** Namenode info */</span></span><br><span class="line">      <span class="keyword">final</span> String authority;</span><br><span class="line">      <span class="comment">/** User info */</span></span><br><span class="line">      <span class="keyword">final</span> UserGroupInformation ugi;</span><br><span class="line"></span><br><span class="line">      <span class="function"><span class="keyword">private</span> <span class="title">Key</span><span class="params">(<span class="keyword">final</span> String authority, <span class="keyword">final</span> UserGroupInformation ugi)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (authority == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> HadoopIllegalArgumentException(<span class="string">&quot;authority == null&quot;</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (ugi == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> HadoopIllegalArgumentException(<span class="string">&quot;ugi == null&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">this</span>.authority = authority;</span><br><span class="line">        <span class="keyword">this</span>.ugi = ugi;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** A map for per user per namenode renewers. */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Map&lt;Key, LeaseRenewer&gt; renewers = <span class="keyword">new</span> HashMap&lt;Key, LeaseRenewer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Get a renewer. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> LeaseRenewer <span class="title">get</span><span class="params">(<span class="keyword">final</span> String authority,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">final</span> UserGroupInformation ugi)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> Key k = <span class="keyword">new</span> Key(authority, ugi);</span><br><span class="line">      LeaseRenewer r = renewers.get(k);</span><br><span class="line">      <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">        r = <span class="keyword">new</span> LeaseRenewer(k);</span><br><span class="line">        renewers.put(k, r);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> r;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Remove the given renewer. */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">remove</span><span class="params">(<span class="keyword">final</span> LeaseRenewer r)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> LeaseRenewer stored = renewers.get(r.factorykey);</span><br><span class="line">      <span class="comment">//Since a renewer may expire, the stored renewer can be different.</span></span><br><span class="line">      <span class="keyword">if</span> (r == stored) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!r.clientsRunning()) &#123;</span><br><span class="line">          renewers.remove(r.factorykey);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å•ä¾‹æ¨¡å¼ä¸­ï¼Œæ„é€ æ–¹æ³•ç§æœ‰</span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="title">LeaseRenewer</span><span class="params">(Factory.Key factorykey)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.factorykey = factorykey;</span><br><span class="line">    unsyncSetGraceSleepPeriod(LEASE_RENEWER_GRACE_DEFAULT);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="ç§Ÿçº¦-â€“-å†™é”æµç¨‹"><a href="#ç§Ÿçº¦-â€“-å†™é”æµç¨‹" class="headerlink" title="ç§Ÿçº¦ â€“ å†™é”æµç¨‹"></a>ç§Ÿçº¦ â€“ å†™é”æµç¨‹</h2><h3 id="æ–°å¢å†™ç§Ÿçº¦"><a href="#æ–°å¢å†™ç§Ÿçº¦" class="headerlink" title="æ–°å¢å†™ç§Ÿçº¦"></a>æ–°å¢å†™ç§Ÿçº¦</h3><p>å……å½“å†™é”çš„ç§Ÿçº¦æ˜¯clientå‘èµ·å†™è¯·æ±‚æ—¶ï¼Œä¸€èµ·è·Ÿnnç”³è¯·çš„(å…¶å…·ä½“çš„å†™æ“ä½œæµç¨‹è¯·çœ‹ä¹‹å‰çš„æ–‡ç« [HDFS writeè§£æ](<a href="http://bigdatadecode.top/HDFS">http://bigdatadecode.top/HDFS</a> writeè§£æ.html))ï¼Œclientå‘nnç”³è¯·å†™æ“ä½œçš„æµç¨‹ä¸ºï¼š<br><code>FileSystem.create() --&gt; DistributedFileSystem.create() --&gt; FileSystemLinkResolver.resolve() --&gt; doCall() --&gt; dfs.create() --&gt; DFSOutputStream.newStreamForCreate() --&gt; dfsClient.namenode.create() --&gt; namesystem.startFile() -&gt; startFileInt() -&gt; startFileInternal()</code>ã€‚åœ¨startFileInternalä¸­é€šè¿‡<code>newNode = dir.addFile(src, permissions, replication, blockSize, holder, clientMachine);</code>å‘namenodeä¸­æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†clientnameå¯¹srcçš„ç§Ÿçº¦è¿›è¡Œå­˜å‚¨<code>leaseManager.addLease(newNode.getFileUnderConstructionFeature().getClientName(), src);</code>ï¼Œè¿™é‡ŒaddLeaseå°±æ˜¯clientç”³è¯·ç§Ÿçº¦ï¼Œçœ‹ä¸‹ä»£ç é€»è¾‘ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LeaseManager.class</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> Lease <span class="title">addLease</span><span class="params">(String holder, String src)</span> </span>&#123;</span><br><span class="line">  Lease lease = getLease(holder);</span><br><span class="line">  <span class="keyword">if</span> (lease == <span class="keyword">null</span>) &#123;</span><br><span class="line">    lease = <span class="keyword">new</span> Lease(holder);</span><br><span class="line">    leases.put(holder, lease);</span><br><span class="line">    sortedLeases.add(lease);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    renewLease(lease);</span><br><span class="line">  &#125;</span><br><span class="line">  sortedLeasesByPath.put(src, lease);</span><br><span class="line">  lease.paths.add(src);</span><br><span class="line">  <span class="keyword">return</span> lease;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨nnç«¯ä¸€ä¸ªLeaseå¯¹åº”ä¸€ä¸ªDFSClient(DFSClientæ˜¯ç”±ugiæ„é€ çš„ï¼Œä¸æ˜¯æŒ‡hadoopé›†ç¾¤çš„clienté‚£å°æœºå™¨)ï¼ŒLeaseæ˜¯ç”±holderæ ‡è¯†çš„ï¼Œholderçš„å€¼å°±æ˜¯DFSClient.clientNameï¼ŒclientNameåœ¨DFSClientçš„æ„é€ å‡½æ•°ä¸­åˆå§‹åŒ–ï¼Œä»£ç å¦‚ä¸‹:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">taskId = conf.get(<span class="string">&quot;mapreduce.task.attempt.id&quot;</span>, <span class="string">&quot;NONMAPREDUCE&quot;</span>);</span><br><span class="line"><span class="keyword">this</span>.clientName = <span class="string">&quot;DFSClient_&quot;</span> + dfsClientConf.taskId + <span class="string">&quot;_&quot;</span> + </span><br><span class="line">        DFSUtil.getRandom().nextInt()  + <span class="string">&quot;_&quot;</span> + Thread.currentThread().getId();     </span><br></pre></td></tr></table></figure><p>clientNameæ˜¯ç”±taskIdã€éšæœºæ•°å’ŒcurrentThread.Idæ‹¼èµ·æ¥çš„ï¼Œæ‰€ä»¥<em>æ¯æ¬¡å†™è¯·æ±‚çš„clientNameæ˜¯ä¸ä¸€æ ·çš„ï¼Œåˆ™Leaseä¹Ÿæ˜¯ä¸ä¸€æ ·çš„</em>ã€‚</p><p>addLeaseçš„é€»è¾‘æ˜¯å…ˆä»LeaseManager.leases(holderå’Œleaseæ˜ å°„)ä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨holderå¯¹åº”çš„leaseï¼Œä¸å­˜åœ¨åˆ™ç”±LeaseManageråˆ›å»ºä¸€ä¸ªleaseï¼Œå­˜åœ¨åˆ™æ›´æ–°leaseã€‚LeaseManageré€šè¿‡å®ä¾‹åŒ–Leaseç±»æ¥åˆ›å»ºç§Ÿçº¦ï¼ŒLeaseçš„æ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">Lease</span><span class="params">(String holder)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.holder = holder;</span><br><span class="line">  renew();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.lastUpdate = now();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>newå‡ºleaseåï¼Œå°†å…¶æ”¾å…¥LeaseManagerä¸­çš„ä¸‰ä¸ªé›†åˆä¸­ï¼Œå¹¶æŠŠæ­¤ç§Ÿçº¦å¯¹åº”çš„pathæ”¾å…¥leaseçš„pathsä¸­ã€‚</p><p>ç§Ÿçº¦æ·»åŠ å®Œæˆã€‚</p><h3 id="å®¢æˆ·ç«¯ç»­çº¦"><a href="#å®¢æˆ·ç«¯ç»­çº¦" class="headerlink" title="å®¢æˆ·ç«¯ç»­çº¦"></a>å®¢æˆ·ç«¯ç»­çº¦</h3><p>å®¢æˆ·ç«¯åœ¨dfs.create()ä¸­è°ƒç”¨beginFileLease()å¯¹ç§Ÿçº¦è¿›è¡Œç»­çº¦ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beginFileLease</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> inodeId, <span class="keyword">final</span> DFSOutputStream out)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  getLeaseRenewer().put(inodeId, out, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ç»­çº¦æ˜¯é€šè¿‡LeaseReneweræ¥å®ç°çš„ï¼ŒLeaseReneweræ˜¯ç”±å­˜æ”¾namenodeä¿¡æ¯çš„authorityå’Œuserä¿¡æ¯çš„ugiæ¥å®ä¾‹åŒ–çš„ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DFSClient.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> LeaseRenewer <span class="title">getLeaseRenewer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> LeaseRenewer.getInstance(authority, ugi, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// LeaseRenewer.class</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> LeaseRenewer <span class="title">getInstance</span><span class="params">(<span class="keyword">final</span> String authority,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> UserGroupInformation ugi, <span class="keyword">final</span> DFSClient dfsc)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> LeaseRenewer r = Factory.INSTANCE.get(authority, ugi);</span><br><span class="line">  r.addClient(dfsc);</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// LeassRenewer.Factory.class</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> LeaseRenewer <span class="title">get</span><span class="params">(<span class="keyword">final</span> String authority,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> UserGroupInformation ugi)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Key k = <span class="keyword">new</span> Key(authority, ugi);</span><br><span class="line">  LeaseRenewer r = renewers.get(k);</span><br><span class="line">  <span class="keyword">if</span> (r == <span class="keyword">null</span>) &#123;</span><br><span class="line">    r = <span class="keyword">new</span> LeaseRenewer(k);</span><br><span class="line">    renewers.put(k, r);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LeaseRenewerçš„å®ä¾‹åŒ–æ˜¯é€šè¿‡Factoryå®ä¾‹åŒ–çš„ï¼ŒFactoryå…ˆå»renewersä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰å½“å‰userçš„LeaseRenewerï¼Œæ²¡æœ‰åˆ™newä¸€ä¸ªï¼Œæœ‰åˆ™ç›´æ¥è¿”å›å·²æœ‰çš„LeaseRenewerï¼Œç„¶ååœ¨getInstanceä¸­ï¼Œå°†DFSClientçš„å®ä¾‹dfscæ”¾å…¥LeaseRenewerçš„dfsclientsçš„listä¸­ã€‚userå¯¹åº”çš„LeaseRenewerå¯¹è±¡åˆå§‹åŒ–å®Œæ¯•ã€‚</p><p>ç„¶åè°ƒç”¨putæ–¹æ³•å°†<em>æ–‡ä»¶æ ‡è¯†Idã€å¯¹åº”çš„æ–‡ä»¶æµå’ŒDFSClientå®ä¾‹</em>ä¼ å…¥LeaseRenewerä¸­ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> inodeId, <span class="keyword">final</span> DFSOutputStream out,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DFSClient dfsc)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (dfsc.isClientRunning()) &#123;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­daemonæ˜¯å¦åœ¨è¿è¡Œï¼Œ</span></span><br><span class="line">    <span class="comment">// æˆ–è€…æ£€æŸ¥dfsclientsä¸ºç©ºä¹‹åçš„æ—¶é—´æ˜¯å¦è¶…è¿‡äº†gracePeriod</span></span><br><span class="line">    <span class="comment">// å¦‚æœdaemonæ²¡æœ‰è¿è¡Œæˆ–è€…ä¸ºç©ºçš„æ—¶é—´è¶…è¿‡äº†gracePeriodåˆ™æ–°newä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">if</span> (!isRunning() || isRenewerExpired()) &#123;</span><br><span class="line">      <span class="comment">//start a new deamon with a new id.</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> id = ++currentId;</span><br><span class="line">      daemon = <span class="keyword">new</span> Daemon(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;Lease renewer daemon for &quot;</span> + clientsString()</span><br><span class="line">                  + <span class="string">&quot; with renew id &quot;</span> + id + <span class="string">&quot; started&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            LeaseRenewer.<span class="keyword">this</span>.run(id);</span><br><span class="line">          &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(LeaseRenewer.<span class="keyword">this</span>.getClass().getSimpleName()</span><br><span class="line">                  + <span class="string">&quot; is interrupted.&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(LeaseRenewer.<span class="keyword">this</span>) &#123;</span><br><span class="line">              Factory.INSTANCE.remove(LeaseRenewer.<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;Lease renewer daemon for &quot;</span> + clientsString()</span><br><span class="line">                  + <span class="string">&quot; with renew id &quot;</span> + id + <span class="string">&quot; exited&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> String.valueOf(LeaseRenewer.<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      daemon.start();</span><br><span class="line">    &#125;</span><br><span class="line">    dfsc.putFileBeingWritten(inodeId, out);</span><br><span class="line">    emptyTime = Long.MAX_VALUE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨putä¸­æœ‰ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œåœ¨å®ˆæŠ¤çº¿ç¨‹ä¸­è°ƒç”¨<code>LeaseRenewer.run</code>æ–¹æ³•å¯¹ç§Ÿçº¦è¿›è¡Œcheckç„¶årenewï¼Œè¿™é‡Œ<em>checkçš„æ˜¯softLimit</em>ã€‚<em>å®ˆæŠ¤çº¿ç¨‹åªæœ‰åœ¨daemonä¸ºnullæˆ–è€…dfsclientsä¸ºç©ºçš„æ—¶é—´è¶…è¿‡äº†gracePeriodæ—¶æ‰éœ€è¦é‡æ–°newä¸€ä¸ªdaemonçº¿ç¨‹</em>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> id)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">long</span> lastRenewed = Time.now(); !Thread.interrupted();</span><br><span class="line">      Thread.sleep(getSleepPeriod())) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">long</span> elapsed = Time.now() - lastRenewed;</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦è¶…è¿‡äº†softLimitçš„ä¸€åŠ</span></span><br><span class="line">    <span class="keyword">if</span> (elapsed &gt;= getRenewalTime()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ç»­çº¦</span></span><br><span class="line">        renew();</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// æ›´æ–°ç»­çº¦æ—¶é—´</span></span><br><span class="line">        lastRenewed = Time.now();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (SocketTimeoutException ie) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>runä¸­è°ƒç”¨renew()è¿›è¡Œç»­çº¦ï¼Œè¿™é‡Œç»­çº¦æ˜¯å¯¹å½“å‰userçš„æ‰€æœ‰DFSClient(<em>ä¹Ÿå°±æ˜¯å½“å‰userçš„æ‰€æœ‰Lease</em>)è¿›è¡Œç»­çº¦ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> List&lt;DFSClient&gt; copies;</span><br><span class="line">  <span class="keyword">synchronized</span>(<span class="keyword">this</span>) &#123;</span><br><span class="line">    copies = <span class="keyword">new</span> ArrayList&lt;DFSClient&gt;(dfsclients);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//sort the client names for finding out repeated names.</span></span><br><span class="line">  Collections.sort(copies, <span class="keyword">new</span> Comparator&lt;DFSClient&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(<span class="keyword">final</span> DFSClient left, <span class="keyword">final</span> DFSClient right)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> left.getClientName().compareTo(right.getClientName());</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line">  String previousName = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; copies.size(); i++) &#123;</span><br><span class="line">    <span class="keyword">final</span> DFSClient c = copies.get(i);</span><br><span class="line">    <span class="comment">//skip if current client name is the same as the previous name.</span></span><br><span class="line">    <span class="keyword">if</span> (!c.getClientName().equals(previousName)) &#123;</span><br><span class="line">      <span class="comment">// ç»­çº¦</span></span><br><span class="line">      <span class="keyword">if</span> (!c.renewLease()) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">          LOG.debug(<span class="string">&quot;Did not renew lease for client &quot;</span> +</span><br><span class="line">              c);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      previousName = c.getClientName();</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨renewä¸­ï¼Œå…ˆå¯¹dfsclientsä¸­çš„DFSClientè¿›è¡Œæ’åºï¼Œä¸»è¦æ˜¯ä¸ºäº†å°†é‡å¤å‘clientNameæ”¾åœ¨ä¸€èµ·ï¼Œrenewæ—¶åªå¯¹å…¶ä¸­ä¸€ä¸ªclientNameè¿›è¡Œæ›´æ–°ï¼Œè°ƒç”¨c.renewLeaseè¿›è¡Œç»­çº¦</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">renewLease</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (clientRunning &amp;&amp; !isFilesBeingWrittenEmpty()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// rpcè°ƒç”¨LeaseManager.renewLease</span></span><br><span class="line">      namenode.renewLease(clientName);</span><br><span class="line">      updateLastLeaseRenewal();</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      <span class="comment">// Abort if the lease has already expired. </span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> elapsed = Time.now() - getLastLeaseRenewal();</span><br><span class="line">      <span class="keyword">if</span> (elapsed &gt; HdfsConstants.LEASE_HARDLIMIT_PERIOD) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Failed to renew lease for &quot;</span> + clientName + <span class="string">&quot; for &quot;</span></span><br><span class="line">            + (elapsed/<span class="number">1000</span>) + <span class="string">&quot; seconds (&gt;= hard-limit =&quot;</span></span><br><span class="line">            + (HdfsConstants.LEASE_HARDLIMIT_PERIOD/<span class="number">1000</span>) + <span class="string">&quot; seconds.) &quot;</span></span><br><span class="line">            + <span class="string">&quot;Closing all files being written ...&quot;</span>, e);</span><br><span class="line">        closeAllFilesBeingWritten(<span class="keyword">true</span>);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// Let the lease renewer handle it and retry.</span></span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨renewLeaseä¸­è¿œç¨‹è°ƒç”¨LeaseManager.renewLeaseï¼Œå…¶è°ƒç”¨æµç¨‹ä¸º<code>NameNodeRpcServer.renewLease --&gt; FSNamesystem.renewLease --&gt; LeaseManager.renewLease(holder)</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LeaseManager.class</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">renewLease</span><span class="params">(String holder)</span> </span>&#123;</span><br><span class="line">  renewLease(getLease(holder));</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">renewLease</span><span class="params">(Lease lease)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (lease != <span class="keyword">null</span>) &#123;</span><br><span class="line">    sortedLeases.remove(lease);</span><br><span class="line">    lease.renew();</span><br><span class="line">    sortedLeases.add(lease);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// LeaseManager.Lease.class</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">renew</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.lastUpdate = now();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯é€šè¿‡LeaseRenewerè°ƒç”¨LeaseManager.renewLeaseè¿›è¡Œç»­çº¦ï¼Œç»­çº¦é€»è¾‘æ˜¯å…ˆä»leasesä¸­getåˆ°clientNameå¯¹åº”çš„leaseï¼Œç„¶åä»sortedLeasesä¸­ç§»é™¤è¯¥leaseï¼Œè°ƒç”¨lease.renewå¯¹leaseçš„lastUpdateè¿›è¡Œæ›´æ–°ï¼Œæœ€åå°†leaseå†æ”¾å…¥sortedLeasesä¸­ã€‚sortedLeasesä¸­çš„leaseæ˜¯æŒ‰ç…§leaseçš„lastUpdateè¿›è¡Œæ’åºçš„ï¼Œåˆ°æ­¤å®¢æˆ·ç«¯ç»­çº¦çš„æµç¨‹ç»“æŸã€‚</p><h3 id="nnç«¯å‘¨æœŸæ€§check-lease"><a href="#nnç«¯å‘¨æœŸæ€§check-lease" class="headerlink" title="nnç«¯å‘¨æœŸæ€§check lease"></a>nnç«¯å‘¨æœŸæ€§check lease</h3><p>nnç«¯ç”±LeaseManager.Monitorå‘¨æœŸæ€§check leaseæ˜¯å¦è¶…æœŸï¼Œè¿™é‡Œcheck hardLimitã€‚Monitorçš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œä¸»è¦é€»è¾‘æ˜¯åœ¨å…¶runæ–¹æ³•ä¸­ã€‚Monitoræ˜¯ä¸€ä¸ªRunnableç±»ï¼Œåœ¨active nnå¯åŠ¨çš„æ—¶å€™è°ƒç”¨<code>leaseManager.startMonitor()</code>å¯åŠ¨ä¸€ä¸ªMonitorçš„å®ˆæŠ¤çº¿ç¨‹ã€‚å…¶runæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">for</span>(; shouldRunMonitor &amp;&amp; fsnamesystem.isRunning(); ) &#123;</span><br><span class="line">    <span class="keyword">boolean</span> needSync = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      fsnamesystem.writeLockInterruptibly();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!fsnamesystem.isInSafeMode()) &#123;</span><br><span class="line">          <span class="comment">// æ£€æŸ¥æ˜¯å¦è¶…æœŸ</span></span><br><span class="line">          needSync = checkLeases();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        fsnamesystem.writeUnlock();</span><br><span class="line">        <span class="comment">// lease reassignments should to be sync&#x27;ed.</span></span><br><span class="line">        <span class="keyword">if</span> (needSync) &#123;</span><br><span class="line">          fsnamesystem.getEditLog().logSync();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// sleep NAMENODE_LEASE_RECHECK_INTERVALåå†æ¬¡checkï¼Œé»˜è®¤2000ms</span></span><br><span class="line">      Thread.sleep(HdfsServerConstants.NAMENODE_LEASE_RECHECK_INTERVAL);</span><br><span class="line">    &#125; <span class="keyword">catch</span>(InterruptedException ie) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>runä¸­è°ƒç”¨checkLeasesè¿›è¡ŒhardLimitæ£€æŸ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LeaseManager.class</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">checkLeases</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> needSync = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">assert</span> fsnamesystem.hasWriteLock();</span><br><span class="line">  <span class="keyword">for</span>(; sortedLeases.size() &gt; <span class="number">0</span>; ) &#123;</span><br><span class="line">  <span class="comment">// ä»sortedLeasesä¸­å–å‡ºç¬¬ä¸€ä¸ªleaseï¼Œ</span></span><br><span class="line">  <span class="comment">// ä¹Ÿå°±æ˜¯æ—¶é—´æœ€ä¹…çš„lease</span></span><br><span class="line">    <span class="keyword">final</span> Lease oldest = sortedLeases.first();</span><br><span class="line">    <span class="comment">// æ£€æŸ¥leaseæ˜¯å¦è¶…è¿‡hardLimit</span></span><br><span class="line">    <span class="comment">// æ²¡æœ‰è¶…è¿‡åˆ™returnï¼Œè¶…è¿‡ä¸è¿›if</span></span><br><span class="line">    <span class="comment">// now() - lastUpdate &gt; hardLimit</span></span><br><span class="line">    <span class="keyword">if</span> (!oldest.expiredHardLimit()) &#123;</span><br><span class="line">      <span class="keyword">return</span> needSync;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    LOG.info(oldest + <span class="string">&quot; has expired hard limit&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> List&lt;String&gt; removing = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span><br><span class="line">    <span class="comment">// need to create a copy of the oldest lease paths, becuase </span></span><br><span class="line">    <span class="comment">// internalReleaseLease() removes paths corresponding to empty files,</span></span><br><span class="line">    <span class="comment">// i.e. it needs to modify the collection being iterated over</span></span><br><span class="line">    <span class="comment">// causing ConcurrentModificationException</span></span><br><span class="line">    String[] leasePaths = <span class="keyword">new</span> String[oldest.getPaths().size()];</span><br><span class="line">    oldest.getPaths().toArray(leasePaths);</span><br><span class="line">    <span class="comment">// å¯¹è¶…è¿‡hardLimitçš„ç§Ÿçº¦ä¸­çš„pathsè¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">for</span>(String p : leasePaths) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å¯¹è¶…è¿‡hardLimitçš„ç§Ÿçº¦ä¸­çš„æ–‡ä»¶è¿›è¡Œé‡Šæ”¾</span></span><br><span class="line">        <span class="keyword">boolean</span> completed = fsnamesystem.internalReleaseLease(oldest, p,</span><br><span class="line">            HdfsServerConstants.NAMENODE_LEASE_HOLDER);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// If a lease recovery happened, we need to sync later.</span></span><br><span class="line">        <span class="keyword">if</span> (!needSync &amp;&amp; !completed) &#123;</span><br><span class="line">          needSync = <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Cannot release the path &quot;</span> + p + <span class="string">&quot; in the lease &quot;</span></span><br><span class="line">            + oldest, e);</span><br><span class="line">        removing.add(p);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(String p : removing) &#123;</span><br><span class="line">      removeLease(oldest, p);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> needSync;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="é‡Šæ”¾ç§Ÿçº¦orç§Ÿçº¦å›æ”¶orç§Ÿçº¦æ¢å¤"><a href="#é‡Šæ”¾ç§Ÿçº¦orç§Ÿçº¦å›æ”¶orç§Ÿçº¦æ¢å¤" class="headerlink" title="é‡Šæ”¾ç§Ÿçº¦orç§Ÿçº¦å›æ”¶orç§Ÿçº¦æ¢å¤"></a>é‡Šæ”¾ç§Ÿçº¦orç§Ÿçº¦å›æ”¶orç§Ÿçº¦æ¢å¤</h3><p>å¯¹äºè¶…è¿‡hardLimitçš„ç§Ÿçº¦è¿›è¡Œé‡Šæ”¾ï¼Œå¯¹äºç§Ÿçº¦çš„é‡Šæ”¾ä¸èƒ½ç®€å•çš„removeæ‰ï¼Œé€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œæœ‰çš„éœ€è¦blockæ¢å¤ï¼Œå…¶å…·ä½“å®ç°æ–¹æ³•æ˜¯<code>internalReleaseLease</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">internalReleaseLease</span><span class="params">(Lease lease, String src, </span></span></span><br><span class="line"><span class="params"><span class="function">    String recoveryLeaseHolder)</span> <span class="keyword">throws</span> AlreadyBeingCreatedException, </span></span><br><span class="line"><span class="function">    IOException, UnresolvedLinkException </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;Recovering &quot;</span> + lease + <span class="string">&quot;, src=&quot;</span> + src);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å¾—åˆ°srcå¯¹åº”çš„INodeFileä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">final</span> INodesInPath iip = dir.getLastINodeInPath(src);</span><br><span class="line">  <span class="keyword">final</span> INodeFile pendingFile = iip.getINode(<span class="number">0</span>).asFile();</span><br><span class="line">  <span class="keyword">int</span> nrBlocks = pendingFile.numBlocks();</span><br><span class="line">  BlockInfo[] blocks = pendingFile.getBlocks();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> nrCompleteBlocks;</span><br><span class="line">  BlockInfo curBlock = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// æ‰¾åˆ°æ­¤fileä¸­æœªå®Œæˆçš„block</span></span><br><span class="line">  <span class="keyword">for</span>(nrCompleteBlocks = <span class="number">0</span>; nrCompleteBlocks &lt; nrBlocks; nrCompleteBlocks++) &#123;</span><br><span class="line">    curBlock = blocks[nrCompleteBlocks];</span><br><span class="line">    <span class="keyword">if</span>(!curBlock.isComplete())</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">assert</span> blockManager.checkMinReplication(curBlock) :</span><br><span class="line">            <span class="string">&quot;A COMPLETE block is not minimally replicated in &quot;</span> + src;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If there are no incomplete blocks associated with this file,</span></span><br><span class="line">  <span class="comment">// then reap lease immediately and close the file.</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥çš„blockéƒ½å®Œæˆï¼Œåˆ™ç›´æ¥å…³é—­æ–‡ä»¶é‡Šæ”¾ç§Ÿçº¦</span></span><br><span class="line">  <span class="keyword">if</span>(nrCompleteBlocks == nrBlocks) &#123;</span><br><span class="line">    finalizeINodeFileUnderConstruction(src, pendingFile,</span><br><span class="line">        iip.getLatestSnapshotId());</span><br><span class="line">    NameNode.stateChangeLog.warn(<span class="string">&quot;BLOCK*&quot;</span></span><br><span class="line">      + <span class="string">&quot; internalReleaseLease: All existing blocks are COMPLETE,&quot;</span></span><br><span class="line">      + <span class="string">&quot; lease removed, file closed.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;  <span class="comment">// closed!</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Only the last and the penultimate blocks may be in non COMPLETE state.</span></span><br><span class="line">  <span class="comment">// If the penultimate block is not COMPLETE, then it must be COMMITTED.</span></span><br><span class="line">  <span class="comment">// å‡å¦‚å­˜åœ¨æœªå®Œæˆçš„blockï¼Œåˆ™æ­¤blockåªèƒ½æ˜¯æœ€åä¸€ä¸ªblockæˆ–è€…å€’æ•°ç¬¬äºŒä¸ªblock</span></span><br><span class="line">  <span class="comment">// å½“æœªå®Œæˆçš„blockæ˜¯å€’æ•°ç¬¬äºŒä¸ªblockæ—¶ï¼Œå€’æ•°ç¬¬äºŒä¸ªblockçš„çŠ¶æ€å¿…é¡»æ˜¯COMMITTED</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¸æ˜¯è¿™ä¸¤ç§æƒ…å†µï¼Œå³å­˜åœ¨åˆ«çš„blockæœªå®Œæˆï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨checkLeasesä¸­æ•è·</span></span><br><span class="line">  <span class="keyword">if</span>(nrCompleteBlocks &lt; nrBlocks - <span class="number">2</span> ||</span><br><span class="line">     nrCompleteBlocks == nrBlocks - <span class="number">2</span> &amp;&amp;</span><br><span class="line">       curBlock != <span class="keyword">null</span> &amp;&amp;</span><br><span class="line">       curBlock.getBlockUCState() != BlockUCState.COMMITTED) &#123;</span><br><span class="line">    <span class="keyword">final</span> String message = <span class="string">&quot;DIR* NameSystem.internalReleaseLease: &quot;</span></span><br><span class="line">      + <span class="string">&quot;attempt to release a create lock on &quot;</span></span><br><span class="line">      + src + <span class="string">&quot; but file is already closed.&quot;</span>;</span><br><span class="line">    NameNode.stateChangeLog.warn(message);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(message);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The last block is not COMPLETE, and</span></span><br><span class="line">  <span class="comment">// that the penultimate block if exists is either COMPLETE or COMMITTED</span></span><br><span class="line">  <span class="keyword">final</span> BlockInfo lastBlock = pendingFile.getLastBlock();</span><br><span class="line">  BlockUCState lastBlockState = lastBlock.getBlockUCState();</span><br><span class="line">  BlockInfo penultimateBlock = pendingFile.getPenultimateBlock();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If penultimate block doesn&#x27;t exist then its minReplication is met</span></span><br><span class="line">  <span class="keyword">boolean</span> penultimateBlockMinReplication = penultimateBlock == <span class="keyword">null</span> ? <span class="keyword">true</span> :</span><br><span class="line">      blockManager.checkMinReplication(penultimateBlock);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">switch</span>(lastBlockState) &#123;</span><br><span class="line">  <span class="keyword">case</span> COMPLETE:</span><br><span class="line">    <span class="keyword">assert</span> <span class="keyword">false</span> : <span class="string">&quot;Already checked that the last block is incomplete&quot;</span>;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> COMMITTED:</span><br><span class="line">    <span class="comment">// Close file if committed blocks are minimally replicated</span></span><br><span class="line">    <span class="keyword">if</span>(penultimateBlockMinReplication &amp;&amp;</span><br><span class="line">        blockManager.checkMinReplication(lastBlock)) &#123;</span><br><span class="line">      finalizeINodeFileUnderConstruction(src, pendingFile,</span><br><span class="line">          iip.getLatestSnapshotId());</span><br><span class="line">      NameNode.stateChangeLog.warn(<span class="string">&quot;BLOCK*&quot;</span></span><br><span class="line">        + <span class="string">&quot; internalReleaseLease: Committed blocks are minimally replicated,&quot;</span></span><br><span class="line">        + <span class="string">&quot; lease removed, file closed.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;  <span class="comment">// closed!</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Cannot close file right now, since some blocks </span></span><br><span class="line">    <span class="comment">// are not yet minimally replicated.</span></span><br><span class="line">    <span class="comment">// This may potentially cause infinite loop in lease recovery</span></span><br><span class="line">    <span class="comment">// if there are no valid replicas on data-nodes.</span></span><br><span class="line">    String message = <span class="string">&quot;DIR* NameSystem.internalReleaseLease: &quot;</span> +</span><br><span class="line">        <span class="string">&quot;Failed to release lease for file &quot;</span> + src +</span><br><span class="line">        <span class="string">&quot;. Committed blocks are waiting to be minimally replicated.&quot;</span> +</span><br><span class="line">        <span class="string">&quot; Try again later.&quot;</span>;</span><br><span class="line">    NameNode.stateChangeLog.warn(message);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> AlreadyBeingCreatedException(message);</span><br><span class="line">  <span class="keyword">case</span> UNDER_CONSTRUCTION:</span><br><span class="line">  <span class="keyword">case</span> UNDER_RECOVERY:</span><br><span class="line">    <span class="keyword">final</span> BlockInfoUnderConstruction uc = (BlockInfoUnderConstruction)lastBlock;</span><br><span class="line">    <span class="comment">// setup the last block locations from the blockManager if not known</span></span><br><span class="line">    <span class="keyword">if</span> (uc.getNumExpectedLocations() == <span class="number">0</span>) &#123;</span><br><span class="line">      uc.setExpectedLocations(blockManager.getStorages(lastBlock));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (uc.getNumExpectedLocations() == <span class="number">0</span> &amp;&amp; uc.getNumBytes() == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// There is no datanode reported to this block.</span></span><br><span class="line">      <span class="comment">// may be client have crashed before writing data to pipeline.</span></span><br><span class="line">      <span class="comment">// This blocks doesn&#x27;t need any recovery.</span></span><br><span class="line">      <span class="comment">// We can remove this block and close the file.</span></span><br><span class="line">      pendingFile.removeLastBlock(lastBlock);</span><br><span class="line">      finalizeINodeFileUnderConstruction(src, pendingFile,</span><br><span class="line">          iip.getLatestSnapshotId());</span><br><span class="line">      NameNode.stateChangeLog.warn(<span class="string">&quot;BLOCK* internalReleaseLease: &quot;</span></span><br><span class="line">          + <span class="string">&quot;Removed empty last block and closed file.&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// start recovery of the last block for this file</span></span><br><span class="line">    <span class="keyword">long</span> blockRecoveryId = nextGenerationStamp(isLegacyBlock(uc));</span><br><span class="line">    lease = reassignLease(lease, src, recoveryLeaseHolder, pendingFile);</span><br><span class="line">    uc.initializeBlockRecovery(blockRecoveryId);</span><br><span class="line">    leaseManager.renewLease(lease);</span><br><span class="line">    <span class="comment">// Cannot close file right now, since the last block requires recovery.</span></span><br><span class="line">    <span class="comment">// This may potentially cause infinite loop in lease recovery</span></span><br><span class="line">    <span class="comment">// if there are no valid replicas on data-nodes.</span></span><br><span class="line">    NameNode.stateChangeLog.warn(</span><br><span class="line">              <span class="string">&quot;DIR* NameSystem.internalReleaseLease: &quot;</span> +</span><br><span class="line">              <span class="string">&quot;File &quot;</span> + src + <span class="string">&quot; has not been closed.&quot;</span> +</span><br><span class="line">             <span class="string">&quot; Lease recovery is in progress. &quot;</span> +</span><br><span class="line">              <span class="string">&quot;RecoveryId = &quot;</span> + blockRecoveryId + <span class="string">&quot; for block &quot;</span> + lastBlock);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ–¹æ³•ä¸»è¦æ˜¯æ£€æŸ¥æ˜¯å¦éœ€è¦çœŸæ­£çš„è¿›å…¥block recoveryé˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µéœ€è¦datanodeçš„å‚ä¸ã€‚ä¸‹é¢å‡½æ•°çš„ä¸»è¦é€»è¾‘</p><ol><li>å…ˆæ£€æŸ¥æ­¤fileçš„blockæ˜¯å¦éƒ½æ˜¯completedçŠ¶æ€ï¼Œå¦‚æœéƒ½æ˜¯completedï¼Œåˆ™ç›´æ¥è°ƒç”¨finalizeINodeFileUnderConstruction(fileæ­£å¸¸å…³é—­çš„é€»è¾‘ï¼Œåœ¨ä¸‹ä¸€èŠ‚çš„ç§Ÿçº¦å…³é—­ä¸­ä¼šä»‹ç»)å…³é—­fileï¼Œreturn trueã€‚å¦‚æœæœ‰æœªcompletedçš„ï¼Œåˆ™æ‰§è¡Œç¬¬äºŒæ­¥</li><li>åˆ¤æ–­æœªcompletedçš„blockçš„ç´¢å¼•ã€‚å¦‚æœå­˜åœ¨æœªå®Œæˆçš„blockï¼Œåˆ™æ­¤blockåªèƒ½æ˜¯æœ€åä¸€ä¸ªblockæˆ–è€…å€’æ•°ç¬¬äºŒä¸ªblockï¼Œå½“æœªå®Œæˆçš„blockæ˜¯å€’æ•°ç¬¬äºŒä¸ªblockæ—¶ï¼Œå€’æ•°ç¬¬äºŒä¸ªblockçš„çŠ¶æ€å¿…é¡»æ˜¯COMMITTEDï¼Œç¬¦åˆæ­¤æ¡ä»¶æ‰§è¡Œç¬¬ä¸‰æ­¥ã€‚å¦‚æœä¸æ˜¯è¿™ä¸¤ç§æƒ…å†µï¼Œå³å­˜åœ¨åˆ«çš„blockæœªå®Œæˆï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ï¼Œåœ¨checkLeasesä¸­æ•è·ã€‚</li><li>åœ¨switchä¸­åˆ¤æ–­æœ€åä¸€ä¸ªblockçš„çŠ¶æ€ï¼Œå¦‚æœæ˜¯<code>COMMITTED</code>ï¼Œå¹¶ä¸”è¯¥æ–‡ä»¶çš„æœ€åä¸¤ä¸ªblockéƒ½æ»¡è¶³æœ€å°å‰¯æœ¬æ•°è¦æ±‚ï¼Œåˆ™è°ƒç”¨finalizeINodeFileUnderConstructionå…³é—­æ–‡ä»¶ï¼Œreturn trueã€‚å¦åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚å¦‚æœæ˜¯<code>UNDER_CONSTRUCTION</code>æˆ–è€…<code>UNDER_RECOVERY</code>ï¼Œå¹¶ä¸”æœ€åä¸€ä¸ªblockæ²¡æœ‰ä»»ä½•datanodeæ±‡æŠ¥ä¸Šæ¥ï¼Œå¾ˆæœ‰å¯èƒ½æ˜¯pipelineè¿˜æ²¡å»ºç«‹èµ·æ¥ï¼Œå®¢æˆ·ç«¯å°±å®•æœºäº†ï¼Œè¿™ç§æƒ…å†µä¸‹ï¼Œåªéœ€è¦æŠŠæœ€åä¸€ä¸ªblockä»INodeä¸­ç§»å‡ºï¼Œå¹¶ä¸”å…³é—­æ–‡ä»¶ã€‚å¦åˆ™çš„è¯è¿›å…¥block recoveryé˜¶æ®µ(è¿™ä¸€é˜¶æ®µå†æ¬¡å¤„ä¸å±•å¼€ï¼Œä»¥åå†åˆ†æ)ã€‚</li></ol><h3 id="å…³é—­ç§Ÿçº¦"><a href="#å…³é—­ç§Ÿçº¦" class="headerlink" title="å…³é—­ç§Ÿçº¦"></a>å…³é—­ç§Ÿçº¦</h3><p>æ–‡ä»¶å†™å®Œä¹‹åè°ƒç”¨<code>FSDataOutputStream.close()</code>å…³é—­å†™å…¥æµï¼ŒFSDataOutputStream.close()çš„å…·ä½“å®ç°æ˜¯ç”±å…¶å‡ ä¸ªå­ç±»å®ç°çš„ï¼Œè¿™é‡Œçœ‹ä¸‹<code>DFSOutputStream.close()</code>ï¼Œcloseä¸­è°ƒç”¨<code>completeFile --&gt; NameNodeRpcServer.complete --&gt; FSNamesystem.completeFile --&gt; completeFileInternal --&gt; finalizeINodeFileUnderConstruction --&gt; leaseManager.removeLease</code>ï¼Œåœ¨finalizeINodeFileUnderConstructionä¸­è°ƒç”¨leaseManager.removeLeaseå…³é—­ç§Ÿçº¦ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">removeLease</span><span class="params">(String holder, String src)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å¾—åˆ°è¯¥holderçš„lease</span></span><br><span class="line">  Lease lease = getLease(holder);</span><br><span class="line">  <span class="keyword">if</span> (lease != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// ä»é›†åˆä¸­å°†è¯¥srcçš„é”removeæ‰</span></span><br><span class="line">    removeLease(lease, src);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Removing non-existent lease! holder=&quot;</span> + holder +</span><br><span class="line">        <span class="string">&quot; src=&quot;</span> + src);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">removeLease</span><span class="params">(Lease lease, String src)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å°†è¯¥srcä»sortedLeasesByPathä¸­ç§»é™¤ </span></span><br><span class="line">  sortedLeasesByPath.remove(src);</span><br><span class="line">  <span class="comment">// å°†srcä»leaseçš„pathsä¸­ç§»é™¤</span></span><br><span class="line">  <span class="keyword">if</span> (!lease.removePath(src)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">      LOG.debug(src + <span class="string">&quot; not found in lease.paths (=&quot;</span> + lease.paths + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœleaseçš„pathsä¸­ç§»é™¤è¯¥srcåï¼Œpathsä¸ºnull</span></span><br><span class="line">  <span class="comment">// åˆ™è¯´æ˜è¯¥ç§Ÿçº¦ä¸­æ²¡æœ‰æ–‡ä»¶è¢«æ‰“å¼€ï¼Œå°†è¯¥ç§Ÿçº¦ä»leasesä¸­ç§»é™¤ï¼Œ</span></span><br><span class="line">  <span class="comment">// ä¹Ÿå°±æ˜¯å…³é—­è¯¥ç§Ÿçº¦ï¼Œå…³é—­ä¹‹åä»sortedLeasesä¸­ç§»é™¤</span></span><br><span class="line">  <span class="keyword">if</span> (!lease.hasPath()) &#123;</span><br><span class="line">    leases.remove(lease.holder);</span><br><span class="line">    <span class="keyword">if</span> (!sortedLeases.remove(lease)) &#123;</span><br><span class="line">      LOG.error(lease + <span class="string">&quot; not found in sortedLeases&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>å…³é—­ç§Ÿçº¦çš„é€»è¾‘æ¯”è¾ƒç®€å•ï¼Œåªæ˜¯å…³é—­ç§Ÿçº¦æ—¶å¹¶ä¸æ˜¯ç®€å•çš„æŠŠè¯¥ç§Ÿçº¦ä»å„ä¸ªé›†åˆä¸­ç§»é™¤ï¼Œè€Œæ˜¯åªæ˜¯å°†å…³é—­srcçš„è®°å½•ä»å„ä¸ªé›†åˆä¸­ç§»é™¤ï¼Œ<em>å¦‚æœç§Ÿçº¦leaseçš„pathsä¸­çš„srcè®°å½•éƒ½è¢«ç§»é™¤æ‰ï¼Œåˆ™è¯¥ç§Ÿçº¦å°±å¯ä»¥å…³é—­</em>ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œå®¢æˆ·ç«¯å‘é›†ç¾¤å†™æ–‡ä»¶å‰éœ€è¦å‘NameNodeçš„LeaseManagerç”³è¯·Leaseï¼›å†™æ–‡ä»¶è¿‡ç¨‹ä¸­å®šæœŸæ›´æ–°Leaseæ—¶é—´ï¼Œä»¥é˜²Leaseè¿‡æœŸï¼Œå‘¨æœŸä¸softLimitç›¸å…³ï¼›å†™å®Œæ•°æ®åç”³è¯·é‡Šæ”¾Leaseã€‚</p><p>æ•´ä¸ªè¿‡ç¨‹å¯èƒ½å‘ç”Ÿä¸¤ç±»é—®é¢˜ï¼šï¼ˆ1ï¼‰å†™æ–‡ä»¶è¿‡ç¨‹ä¸­å®¢æˆ·ç«¯æ²¡æœ‰åŠæ—¶æ›´æ–°Leaseæ—¶é—´ï¼›ï¼ˆ2ï¼‰å†™å®Œæ–‡ä»¶åæ²¡æœ‰æˆåŠŸé‡Šæ”¾Leaseã€‚ä¸¤ä¸ªé—®é¢˜åˆ†åˆ«å¯¹åº”ä¸ºsoftLimitå’ŒhardLimitã€‚<em>ä¸¤ç§åœºæ™¯éƒ½ä¼šè§¦å‘LeaseManagerå¯¹Leaseè¶…æ—¶å¼ºåˆ¶å›æ”¶</em>ã€‚å¦‚æœå®¢æˆ·ç«¯å†™æ–‡ä»¶è¿‡ç¨‹ä¸­æ²¡æœ‰åŠæ—¶æ›´æ–°Leaseè¶…è¿‡softLimitæ—¶é—´åï¼Œå¦ä¸€å®¢æˆ·ç«¯å°è¯•å¯¹åŒä¸€æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶è§¦å‘Leaseè½¯è¶…æ—¶å¼ºåˆ¶å›æ”¶ï¼›å¦‚æœå®¢æˆ·ç«¯å†™æ–‡ä»¶å®Œæˆä½†æ˜¯æ²¡æœ‰æˆåŠŸé‡Šæ”¾Leaseï¼Œåˆ™ä¼šç”±LeaseManagerçš„åå°çº¿ç¨‹LeaseManager.Monitoræ£€æŸ¥æ˜¯å¦ç¡¬è¶…æ—¶åç»Ÿä¸€è§¦å‘è¶…æ—¶å›æ”¶ã€‚<em>ä¸ç®¡æ˜¯softLimitè¿˜æ˜¯hardLimitè¶…æ—¶è§¦å‘çš„å¼ºåˆ¶Leaseå›æ”¶ï¼Œå¤„ç†é€»è¾‘éƒ½ä¸€æ ·ï¼šFSNamesystem.internalReleaseLease</em>ï¼Œé€»è¾‘æœ¬èº«æ¯”è¾ƒå¤æ‚ï¼Œå·²åœ¨ä¸Šé¢è¯¦ç»†ä»‹ç»ã€‚ç®€å•çš„è¯´å…ˆå¯¹Leaseè¿‡æœŸå‰æœ€åä¸€æ¬¡å†™å…¥çš„Blockè¿›è¡Œæ£€æŸ¥å’Œä¿®å¤ï¼Œä¹‹åé‡Šæ”¾è¶…æ—¶æŒæœ‰çš„Leaseï¼Œä¿è¯åé¢å…¶ä»–å®¢æˆ·ç«¯çš„å†™å…¥èƒ½å¤Ÿæ­£å¸¸ç”³è¯·åˆ°è¯¥æ–‡ä»¶çš„Leaseã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Lease </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceæºç è§£æ--Reduceä¸­valuesçš„Iteratorçš„ç”Ÿæˆ</title>
      <link href="/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Reduce%E4%B8%ADvalues%E7%9A%84Iterator%E7%9A%84%E7%94%9F%E6%88%90.html"/>
      <url>/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Reduce%E4%B8%ADvalues%E7%9A%84Iterator%E7%9A%84%E7%94%9F%E6%88%90.html</url>
      
        <content type="html"><![CDATA[<p>ä¼—æ‰€å‘¨çŸ¥Reduceä¸­çš„valuesæ˜¯ä¸€ä¸ªIteratorï¼Œä½†æ˜¯valueçš„æ•°æ®å¹¶ä¸æ˜¯ä¸€ä¸‹å…¨éƒ¨åŠ è½½åˆ°è¿™ä¸ªIterator(<em>ä¹Ÿå°±æ˜¯å¯¹valueæ ¹æ®keyè¿›è¡Œåˆ†ç»„ï¼Œè¿™ä¸ªåˆ†ç»„æ¯”è¾ƒå™¨å¯ä»¥é‡å†™ï¼ŒäºŒæ¬¡æ’åºä¸­å¯èƒ½ä¼šéœ€è¦é‡å†™ï¼Œé»˜è®¤æ˜¯æŒ‰ç…§keyè¿›è¡Œåˆ†ç»„</em>)ï¼Œé‚£ä¹ˆvaluesçš„Iteratoræ˜¯æ€ä¹ˆå½¢æˆçš„ï¼Œæ˜¯æ€ä¹ˆè¢«åŠ è½½çš„å‘¢ï¼Ÿ</p><p>ä¸‹é¢ä»æºç çš„è§’åº¦å»æ¢ç§˜ä¸€ä¸‹å§ï¼Œå› ä¸ºæºç æ‰æ˜¯æœ€å¥½çš„æ•™ç§‘ä¹¦ã€‚</p><span id="more"></span><p>å†™Reduceå‡½æ•°æ—¶éƒ½ä¼šç»§æ‰¿Reduceç±»ç„¶åé‡å†™reduceå‡½æ•°ï¼Œåœ¨Reduce.runä¸­å¾ªç¯è°ƒç”¨reduceï¼Œreduceå‡½æ•°ä¼ è¿›å»çš„å‚æ•°valueså·²ç»æ˜¯ä¸€ä¸ªIteratorï¼Œåˆ™æ­¤Iteratorçš„å½¢æˆåªèƒ½åœ¨è°ƒç”¨reduceä¹‹å‰ï¼Œå¼€å§‹å¾ªç¯è°ƒç”¨reduceä¹‹åã€‚çœ‹ä¸‹runçš„ä»£ç å¯èƒ½æ›´æ¸…æ™°ä¸€äº›ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  setup(context);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// while å¾ªç¯è°ƒç”¨reduce</span></span><br><span class="line">    <span class="keyword">while</span> (context.nextKey()) &#123;</span><br><span class="line">      <span class="comment">// reduceä¼ å…¥çš„å‚æ•°context.getValues()åªæ˜¯è¿”å›ä¸€ä¸ªIterator</span></span><br><span class="line">      reduce(context.getCurrentKey(), context.getValues(), context);</span><br><span class="line">      <span class="comment">// If a back up store is used, reset it</span></span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    cleanup(context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä»£ç å¾ˆç®€å•ï¼Œcontext.nextKeyæ£€æŸ¥æ˜¯å¦æœ‰ä¸‹ä¸€ä¸ªkeyï¼Œæœ‰åˆ™è¿›å…¥å¾ªç¯ï¼Œè°ƒç”¨context.getValuesè¿”å›ä¸€ä¸ªValueIterableå¯¹è±¡ï¼Œç¬¬ä¸€æ„Ÿè§‰å°±æ˜¯æ‰¾åˆ°è¿™ä¸ªValueIterableå¯¹è±¡åœ¨å“ªè¢«èµ‹å€¼äº†ï¼Œé‚£ä¹ˆé—®é¢˜å°±è§£å†³äº†ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯ã€‚è¿™ä¸ªValueIterableå¯¹è±¡ç”±è¿”å›ä¸€ä¸ªIteratorå¯¹è±¡ï¼Œè€Œè¿™ä¸ªIteratorå¯¹è±¡åªæ˜¯åœ¨ValueIterableä¸­è¢«åˆå§‹åŒ–äº†ä¸€ä¸ªç©ºå¯¹è±¡ï¼Œé‚£ä¹ˆIteratorå¯¹è±¡ä¸­çš„æ•°æ®æ˜¯åœ¨å‘¢è¢«èµ‹å€¼çš„å‘¢ï¼Ÿéš¾é“æ˜¯åœ¨context.nextKey()ä¸­ï¼Ÿ</p><p>ä¸‹é¢çœ‹ä¸‹context.nextKey()çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ReduceContextImpl.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException,InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (hasMore &amp;&amp; nextKeyIsSame) &#123;</span><br><span class="line">    nextKeyValue();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasMore) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputKeyCounter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      inputKeyCounter.increment(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextKeyValue();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸¤ä¸ªå±æ€§<code>hasMore</code>å’Œ<code>nextKeyIsSame</code>ï¼ŒhasMoreåˆæ¬¡æ˜¯åœ¨ReduceContextImplçš„æ„é€ æ–¹æ³•ä¸­è¢«<code>hasMore = input.next()</code>èµ‹å€¼(<em>inputæ˜¯<code>RawKeyValueIterator</code>ï¼Œæ˜¯mapç«¯mergeæ•°æ®çš„è¾“å‡ºç±»å‹</em>)ï¼Œæœ‰ä¸‹ä¸€è¡Œæ•°æ®åˆ™ä¸ºtrueã€‚nextKeyIsSameåˆå§‹åŒ–ä¸ºfalseï¼Œéšåä¼šåœ¨nextKeyValueä¸­è¢«èµ‹å€¼ã€‚</p><p>åˆ™å½“reduceåˆšå¯åŠ¨æ—¶ï¼ŒhasMoreä¸ºtrueï¼ŒnextKeyIsSameä¸ºfalseï¼Œä¸è¿›whileå¾ªç¯ï¼Œè¿›ifè¯­å¥ï¼Œé¦–å…ˆå¯¹keyè¿›è¡Œç»Ÿè®¡ï¼Œç„¶åè°ƒç”¨<code>nextKeyValue</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKeyValue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ˜¯å¦çš„ä¸€ä¸ªå€¼æ ‡è¯†</span></span><br><span class="line">  firstValue = !nextKeyIsSame;</span><br><span class="line">  <span class="comment">// ä»inputä¸­æ‹¿åˆ°keyå€¼</span></span><br><span class="line">  DataInputBuffer nextKey = input.getKey();</span><br><span class="line">  currentRawKey.set(nextKey.getData(), nextKey.getPosition(), </span><br><span class="line">                    nextKey.getLength() - nextKey.getPosition());</span><br><span class="line">  buffer.reset(currentRawKey.getBytes(), <span class="number">0</span>, currentRawKey.getLength());</span><br><span class="line">  <span class="comment">// keyå€¼ååºåˆ—</span></span><br><span class="line">  key = keyDeserializer.deserialize(key);</span><br><span class="line">  <span class="comment">// ä»inputä¸­æ‹¿åˆ°valueå€¼</span></span><br><span class="line">  DataInputBuffer nextVal = input.getValue();</span><br><span class="line">  buffer.reset(nextVal.getData(), nextVal.getPosition(), nextVal.getLength()</span><br><span class="line">      - nextVal.getPosition());</span><br><span class="line">  <span class="comment">// valueååºåˆ—</span></span><br><span class="line">  value = valueDeserializer.deserialize(value);</span><br><span class="line"></span><br><span class="line">  currentKeyLength = nextKey.getLength() - nextKey.getPosition();</span><br><span class="line">  currentValueLength = nextVal.getLength() - nextVal.getPosition();</span><br><span class="line">  <span class="comment">// mark resetåŠŸèƒ½æ˜¯å¦å¼€å¯ï¼Œå¼€å¯ä¹‹åå¯ä»¥å¤šæ¬¡éå†valuesä¸­çš„å€¼</span></span><br><span class="line">  <span class="keyword">if</span> (isMarked) &#123;</span><br><span class="line">    backupStore.write(nextKey, nextVal);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  hasMore = input.next();</span><br><span class="line">  <span class="keyword">if</span> (hasMore) &#123;</span><br><span class="line">    nextKey = input.getKey();</span><br><span class="line">    <span class="comment">// åˆ¤æ–­å½“å‰keyæ˜¯å¦å’Œä¸‹ä¸€ä¸ªkeyç›¸åŒ</span></span><br><span class="line">    nextKeyIsSame = comparator.compare(currentRawKey.getBytes(), <span class="number">0</span>, </span><br><span class="line">                                   currentRawKey.getLength(),</span><br><span class="line">                                   nextKey.getData(),</span><br><span class="line">                                   nextKey.getPosition(),</span><br><span class="line">                                   nextKey.getLength() - nextKey.getPosition()</span><br><span class="line">                                       ) == <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextKeyIsSame = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯¹valueçš„ä¸ªæ•°è¿›è¡Œç»Ÿè®¡</span></span><br><span class="line">  inputValueCounter.increment(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>nextKeyValueå¹¶æ²¡æœ‰ç»™Iteratorèµ‹å€¼ï¼Œä½†æ˜¯ä»¤äººé«˜å…´çš„æ˜¯è¿™é‡ŒæŠŠkeyå’Œvalueä»inputä¸­è¯»å–å‡ºæ¥ï¼Œååºåˆ—åŒ–æ”¾å…¥keyå’Œvalueä¸­ï¼Œé‚£ä¹ˆvalueå’Œkeyéƒ½æ˜¯åœ¨å“ªè¢«è°ƒç”¨å‘¢ï¼ŒæŸ¥çœ‹ä»£ç å‘ç°æ˜¯åœ¨<code>ValueIterator</code>çš„<code>next</code>æ–¹æ³•ä¸­valueè¢«returnï¼ŒValueIteratorå°±æ˜¯ä¸Šæ–‡ä¸­è¿”å›çš„Iteratorå¯¹è±¡ã€‚ValueIteratoræ˜¯ReduceContextImplçš„å†…éƒ¨ç±»å®ç°äº†Iteratoræ¥å£ã€‚çœ‹ä¸‹nextæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> VALUEIN <span class="title">next</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// if this is the first record, we don&#x27;t need to advance</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ˜¯ç¬¬ä¸€ä¸ªvalueï¼Œå€¼ç›´æ¥è¿”å›åœ¨nextKeyValueä¸­è¢«èµ‹å€¼çš„value</span></span><br><span class="line">  <span class="keyword">if</span> (firstValue) &#123;</span><br><span class="line">    firstValue = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// if this isn&#x27;t the first record and the next key is different, they</span></span><br><span class="line">  <span class="comment">// can&#x27;t advance it here.</span></span><br><span class="line">  <span class="keyword">if</span> (!nextKeyIsSame) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NoSuchElementException(<span class="string">&quot;iterate past last value&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// otherwise, go to the next key/value pair</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœä¸æ˜¯ç¬¬ä¸€ä¸ªå€¼ï¼Œåˆ™è°ƒç”¨nextKeyValueè¯»å–valueå€¼</span></span><br><span class="line">    nextKeyValue();</span><br><span class="line">    <span class="comment">// å°†ä¸Šé¢è¯»å–çš„valueå€¼è¿”å›</span></span><br><span class="line">    <span class="keyword">return</span> value;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;next value iterator failed&quot;</span>, ie);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">    <span class="comment">// this is bad, but we can&#x27;t modify the exception list of java.util</span></span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;next value iterator interrupted&quot;</span>, ie);        </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±nextæ–¹æ³•å¯è§ï¼ŒIteratoråˆæœŸåªæ˜¯ä¸ªnullå¯¹è±¡ï¼Œé€šè¿‡<code>firstValue</code>å’Œ<code>nextKeyIsSame</code>æ¥æ§åˆ¶ï¼Œæ˜¯å¦è¿˜æœ‰å€¼ï¼Œå¹¶è¿›è¡Œè¯»å–ã€‚æ¯è¯»å–ä¸€æ¬¡éƒ½æ˜¯ç›´æ¥ä»inputä¸­è¯»å–å€¼ï¼Œè¿™æ ·å‡å°‘äº†å†…å­˜çš„åˆ©ç”¨ï¼Œinputå¯ä»¥åœ¨å†…å­˜ä¹Ÿå¯ä»¥åœ¨ç£ç›˜ã€‚</p><p>ä¸‹é¢æ¥è¯´ä¸‹Reduceè¯»å–valueçš„æ•´ä½“æµç¨‹ã€‚</p><blockquote><p>é¦–å…ˆåœ¨Reduce.runä¸­è°ƒç”¨context.nextKey()å†³å®šæ˜¯å¦è¿›å…¥whileï¼ŒnextKeyå¯¹keyçš„ä¸ªæ•°è¿›è¡Œç»Ÿè®¡ï¼Œç„¶åè°ƒç”¨nextKeyValueå°†key/valueçš„å€¼ä»inputä¸­è¯»å‡ºï¼Œå¹¶å¯¹firstValueã€hashMoreå’ŒnextKeyIsSameçš„å€¼è¿›è¡Œæ›´æ–°ã€‚</p></blockquote><blockquote><p>å…¶æ¬¡é€šè¿‡context.getValueså°†Iteratorä¼ å…¥reduceä¸­ï¼Œåœ¨reduceä¸­é€šè¿‡Iterator.hasNextæŸ¥çœ‹æ­¤keyæ˜¯å¦æœ‰ä¸‹ä¸ªvalueï¼Œç„¶åé€šè¿‡Iterator.nextè°ƒç”¨nextKeyValueå»inputä¸­è¯»å–valueã€‚</p></blockquote><p>hasNextä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">hasNext</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (inReset &amp;&amp; backupStore.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; </span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    e.printStackTrace();</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;hasNext failed&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç¬¬ä¸€æ¬¡è°ƒç”¨hasNextæ—¶ï¼ŒfirstValueåœ¨nextKeyValueä¸­è¢«èµ‹å€¼ä¸ºtrueï¼Œ</span></span><br><span class="line">  <span class="comment">// å¹¶ä¸”å¦‚æœå’Œä¸‹ä¸€ä¸ªkeyç›¸åŒï¼Œåˆ™nextKeyIsSameä¹Ÿä¸ºtrue</span></span><br><span class="line">  <span class="comment">// å½“è°ƒç”¨è¿‡next()ä¹‹åï¼ŒfirstValueä¼šåœ¨nextä¸­è¢«èµ‹å€¼ä¸ºfalseï¼Œnextæ–¹æ³•ç›´æ¥è¿”å›</span></span><br><span class="line">  <span class="comment">// æ­¤æ—¶nextKeyIsSameä¾ç„¶æ˜¯åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨nextKeyValueä¸­è¢«èµ‹å€¼çš„true</span></span><br><span class="line">  <span class="keyword">return</span> firstValue || nextKeyIsSame;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>ç„¶åå¾ªç¯è¿­ä»£Iteratorï¼Œè¯»å–inputä¸­ç›¸åŒkeyçš„valueã€‚</p></blockquote><p>è¯»å–å½“å‰keyçš„valueè¯»å–ç»“æŸä¹‹åï¼Œå†æ¬¡è°ƒç”¨context.nextKeyã€‚</p><p><strong>ä¹Ÿå°±æ˜¯è¯´reduceä¸­ç›¸åŒkeyçš„valueå€¼åœ¨Iterator.nextä¸­é€šè¿‡nextKeyValueè¯»å–çš„ï¼Œæ¯è°ƒç”¨ä¸€æ¬¡nextå°±ä»inputä¸­è¯»ä¸€ä¸ªvalueã€‚æ­¤æ—¶æœ‰çš„åŒå­¦ä¼šé—®å‡å¦‚æˆ‘åœ¨è¯»Iteratorçš„å¾ªç¯ä¸­ä¸­é€”breakå‘¢ï¼Œå‰©ä¸‹çš„valueæ˜¯åœ¨å“ªè¢«æ¶ˆè´¹å‘¢ï¼Ÿå¦‚æœä¸æ¶ˆè´¹æˆ‘å†æ¬¡å¾ªç¯çš„æ—¶å€™æ€ä¹ˆè¯»åˆ°ä¸‹ä¸€ä¸ªkeyçš„valueã€‚</strong></p><p>ä¸‹é¢çœ‹ä¸‹context.nextKeyçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException,InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (hasMore &amp;&amp; nextKeyIsSame) &#123;</span><br><span class="line">    nextKeyValue();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasMore) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputKeyCounter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      inputKeyCounter.increment(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextKeyValue();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰æ²¡æœ‰æ³¨æ„åˆ°æ–¹æ³•å¼€å§‹æœ‰ä¸ªwhileå¾ªç¯ï¼Œå½“ä½ ä¸­é€”breakä¹‹åï¼Œå†æ¬¡è¿›å…¥runä¸­çš„whileå¾ªç¯æ—¶ï¼ŒnextKeyä¼šç»§ç»­æŠŠæ²¡æœ‰è¯»å®Œçš„valueè¯»å®Œï¼Œç„¶åé€’å¢keyçš„ä¸ªæ•°ï¼Œè°ƒç”¨nextKeyValueå»è¯»å–ä¸‹ä¸€ä¸ªä¸åŒçš„keyã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> MapReduce </tag>
            
            <tag> Reduce </tag>
            
            <tag> Iterator </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>MapReduceæºç è§£æ--Reduceè§£æ</title>
      <link href="/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Reduce%E8%A7%A3%E6%9E%90.html"/>
      <url>/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Reduce%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<h2 id="MapReduceâ€“Reduce"><a href="#MapReduceâ€“Reduce" class="headerlink" title="MapReduceâ€“Reduce"></a>MapReduceâ€“Reduce</h2><p><a href="http://bigdatadecode.top/MapReduce%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90--Map%E8%A7%A3%E6%9E%90.html">ä¸Šç¯‡</a>ä¸»è¦æ‰’äº†ä¸‹Mapé˜¶æ®µçš„ä»£ç ï¼Œå¹¶æ ¹æ®ä»£ç æŠŠMapé˜¶æ®µçš„æµç¨‹ä¸²äº†ä¸‹ï¼Œæœ¬ç¯‡ä¸»è¦æ‰’ä¸‹Reduceé˜¶æ®µçš„ä»£ç ï¼Œé¡ºä¾¿ä¸²ä¸‹Reduceé˜¶æ®µçš„æµç¨‹ã€‚<br>Reduceå¤§è‡´åˆ†ä¸ºcopyã€sortã€reduceä¸‰ä¸ªé˜¶æ®µï¼Œé‡ç‚¹åœ¨å‰ä¸¤ä¸ªé˜¶æ®µã€‚Reduce Taskå’ŒMap Taskä¸€æ ·ï¼ŒåŒæ ·ä¹Ÿæœ‰å››ä¸­ä»»åŠ¡ç±»å‹ï¼Œåˆ†åˆ«ä¸ºjob setupã€job cleanupã€reduce taskã€task cleanupã€‚Reduceé˜¶æ®µçš„ä»£ç å…¥å£æ˜¯<code>ReduceTask.java</code>ç±»ä¸­çš„<code>run</code>æ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(JobConf job, <span class="keyword">final</span> TaskUmbilicalProtocol umbilical)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException, InterruptedException, ClassNotFoundException </span>&#123;</span><br><span class="line">  job.setBoolean(JobContext.SKIP_RECORDS, isSkipping());</span><br><span class="line">  <span class="comment">// Reduceé˜¶æ®µçš„ä¸‰ä¸ªå°é˜¶æ®µ</span></span><br><span class="line">  <span class="keyword">if</span> (isMapOrReduce()) &#123;</span><br><span class="line">    copyPhase = getProgress().addPhase(<span class="string">&quot;copy&quot;</span>);</span><br><span class="line">    sortPhase  = getProgress().addPhase(<span class="string">&quot;sort&quot;</span>);</span><br><span class="line">    reducePhase = getProgress().addPhase(<span class="string">&quot;reduce&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// start thread that will handle communication with parent</span></span><br><span class="line">  TaskReporter reporter = startReporter(umbilical);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">boolean</span> useNewApi = job.getUseNewReducer();</span><br><span class="line">  initialize(job, getJobID(), reporter, useNewApi);</span><br><span class="line">  <span class="comment">// Reduce Task çš„å››ç§ç±»å‹</span></span><br><span class="line">  <span class="comment">// check if it is a cleanupJobTask</span></span><br><span class="line">  <span class="keyword">if</span> (jobCleanup) &#123;</span><br><span class="line">    runJobCleanupTask(umbilical, reporter);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (jobSetup) &#123;</span><br><span class="line">    runJobSetupTask(umbilical, reporter);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (taskCleanup) &#123;</span><br><span class="line">    runTaskCleanupTask(umbilical, reporter);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Initialize the codec</span></span><br><span class="line">  <span class="comment">// åˆå§‹åŒ–å‹ç¼©ç±»å‹</span></span><br><span class="line">  codec = initCodec();</span><br><span class="line">  RawKeyValueIterator rIter = <span class="keyword">null</span>;</span><br><span class="line">  ShuffleConsumerPlugin shuffleConsumerPlugin = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// reduce é˜¶æ®µä¾ç„¶è¦ç”¨åˆ°combiner</span></span><br><span class="line">  Class combinerClass = conf.getCombinerClass();</span><br><span class="line">  CombineOutputCollector combineCollector = </span><br><span class="line">    (<span class="keyword">null</span> != combinerClass) ? </span><br><span class="line">   <span class="keyword">new</span> CombineOutputCollector(reduceCombineOutputCounter, reporter, conf) : <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// å¾—åˆ°shuffleé˜¶æ®µçš„æ’ä»¶ï¼ˆæ­¤å¤„å°†shuffleé˜¶æ®µå½“åšä¸€ä¸ªæœåŠ¡æ’ä»¶ï¼‰</span></span><br><span class="line">  Class&lt;? extends ShuffleConsumerPlugin&gt; clazz =</span><br><span class="line">        job.getClass(MRConfig.SHUFFLE_CONSUMER_PLUGIN, Shuffle.class, ShuffleConsumerPlugin.class);</span><br><span class="line"></span><br><span class="line">  shuffleConsumerPlugin = ReflectionUtils.newInstance(clazz, job);</span><br><span class="line">  LOG.info(<span class="string">&quot;Using ShuffleConsumerPlugin: &quot;</span> + shuffleConsumerPlugin);</span><br><span class="line"></span><br><span class="line">  ShuffleConsumerPlugin.Context shuffleContext = </span><br><span class="line">    <span class="keyword">new</span> ShuffleConsumerPlugin.Context(getTaskID(), job, FileSystem.getLocal(job), umbilical, </span><br><span class="line">                <span class="keyword">super</span>.lDirAlloc, reporter, codec, </span><br><span class="line">                combinerClass, combineCollector, </span><br><span class="line">                spilledRecordsCounter, reduceCombineInputCounter,</span><br><span class="line">                shuffledMapsCounter,</span><br><span class="line">                reduceShuffleBytes, failedShuffleCounter,</span><br><span class="line">                mergedMapOutputsCounter,</span><br><span class="line">                taskStatus, copyPhase, sortPhase, <span class="keyword">this</span>,</span><br><span class="line">                mapOutputFile, localMapFiles);</span><br><span class="line">  <span class="comment">// shuffleConsumerPluginåˆå§‹åŒ–</span></span><br><span class="line">  shuffleConsumerPlugin.init(shuffleContext);</span><br><span class="line">  <span class="comment">// copy sort mergeéƒ½åœ¨æ­¤é˜¶æ®µæ‰§è¡Œ</span></span><br><span class="line">  rIter = shuffleConsumerPlugin.run();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// free up the data structures</span></span><br><span class="line">  mapOutputFilesOnDisk.clear();</span><br><span class="line">  </span><br><span class="line">  sortPhase.complete();                         <span class="comment">// sort is complete</span></span><br><span class="line">  setPhase(TaskStatus.Phase.REDUCE); </span><br><span class="line">  statusUpdate(umbilical);</span><br><span class="line">  Class keyClass = job.getMapOutputKeyClass();</span><br><span class="line">  Class valueClass = job.getMapOutputValueClass();</span><br><span class="line">  RawComparator comparator = job.getOutputValueGroupingComparator();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (useNewApi) &#123;</span><br><span class="line">    runNewReducer(job, umbilical, reporter, rIter, comparator, </span><br><span class="line">                  keyClass, valueClass);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    runOldReducer(job, umbilical, reporter, rIter, comparator, </span><br><span class="line">                  keyClass, valueClass);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢çš„<code>run</code>ä»£ç æ®µå¯ä»¥çœ‹å‡º_copy_å’Œ_sort_æ˜¯ä¸»è¦åœ¨<code>shuffleConsumerPlugin.run()</code>ä¸­æ‰§è¡Œï¼Œæ­¤æ–¹æ³•ç»“æŸä¹‹ååˆ™è¿›å…¥reduceé˜¶æ®µï¼Œæ‰§è¡Œ<code>runNewReucer()</code>ã€‚åˆ™ä¸‹é¢å…ˆçœ‹ä¸‹<code>shuffleConsumerPlugin</code>çš„é€»è¾‘ï¼Œä»<code>shuffleConsumerPlugin.init(shuffleContext)</code>å¼€å§‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Shuffle.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ShuffleConsumerPlugin.Context context)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// ä¸»è¦ç”¨æ¥å­˜æ”¾mapç­‰ç›¸å…³ä¿¡æ¯ï¼Œä¹ŸåŒ…å«fetcherç›¸å…³çš„è°ƒåº¦</span></span><br><span class="line">  scheduler = <span class="keyword">new</span> ShuffleSchedulerImpl&lt;K, V&gt;(jobConf, taskStatus, reduceId,</span><br><span class="line">      <span class="keyword">this</span>, copyPhase, context.getShuffledMapsCounter(),</span><br><span class="line">      context.getReduceShuffleBytes(), context.getFailedShuffleCounter());</span><br><span class="line">  <span class="comment">// new å‡ºä¸€ä¸ªMergeManagerImplå¯¹è±¡ï¼Œåœ¨è¯¥å¯¹è±¡ä¸­åˆ›å»º</span></span><br><span class="line">  <span class="comment">// mergeçº¿ç¨‹ï¼ŒåŒ…å«inMemoryMergerï¼ˆå†…å­˜mergeåˆ°ç£ç›˜ï¼‰ã€onDiskMergerï¼ˆç£ç›˜mergeï¼‰</span></span><br><span class="line">  merger = createMergeManager(context);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>createMergeManager</code>newå‡ºä¸€ä¸ªMergeManagerImplå¯¹è±¡ï¼Œè¯¥å¯¹è±¡çš„æ„é€ å‡½æ•°ä¸»è¦æ„å»ºå‡ ä¸ªMergeçº¿ç¨‹ï¼Œå¹¶ä¸ºä¸€äº›å‚æ•°è®¾ç½®é˜ˆå€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MergeManagerImpl</span><span class="params">(TaskAttemptID reduceId, JobConf jobConf, </span></span></span><br><span class="line"><span class="params"><span class="function">                    FileSystem localFS,</span></span></span><br><span class="line"><span class="params"><span class="function">                    LocalDirAllocator localDirAllocator,  </span></span></span><br><span class="line"><span class="params"><span class="function">                    Reporter reporter,</span></span></span><br><span class="line"><span class="params"><span class="function">                    CompressionCodec codec,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Class&lt;? extends Reducer&gt; combinerClass,</span></span></span><br><span class="line"><span class="params"><span class="function">                    CombineOutputCollector&lt;K,V&gt; combineCollector,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Counters.Counter spilledRecordsCounter,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Counters.Counter reduceCombineInputCounter,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Counters.Counter mergedMapOutputsCounter,</span></span></span><br><span class="line"><span class="params"><span class="function">                    ExceptionReporter exceptionReporter,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Progress mergePhase, MapOutputFile mapOutputFile)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// SHUFFLE_INPUT_BUFFER_PERCENT = &quot;mapreduce.reduce.shuffle.input.buffer.percent&quot;</span></span><br><span class="line">  <span class="comment">// é»˜è®¤æ˜¯0.7 Reduceé˜¶æ®µå†…å­˜ç¼“å†²åŒºä¸­ç”¨äºshuffleçš„ç™¾åˆ†æ¯”</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">float</span> maxInMemCopyUse =</span><br><span class="line">    jobConf.getFloat(MRJobConfig.SHUFFLE_INPUT_BUFFER_PERCENT,</span><br><span class="line">        MRJobConfig.DEFAULT_SHUFFLE_INPUT_BUFFER_PERCENT);</span><br><span class="line">  <span class="keyword">if</span> (maxInMemCopyUse &gt; <span class="number">1.0</span> || maxInMemCopyUse &lt; <span class="number">0.0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid value for &quot;</span> +</span><br><span class="line">        MRJobConfig.SHUFFLE_INPUT_BUFFER_PERCENT + <span class="string">&quot;: &quot;</span> +</span><br><span class="line">        maxInMemCopyUse);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Allow unit tests to fix Runtime memory</span></span><br><span class="line">  <span class="comment">// REDUCE_MEMORY_TOTAL_BYTES = &quot;mapreduce.reduce.memory.totalbytes&quot;</span></span><br><span class="line">  <span class="comment">// ç”¨äºshuffleçš„bufferå¤§å°</span></span><br><span class="line">  <span class="comment">// æ­¤å€¼æ˜¯ç”±Reduceè¿è¡Œæ—¶çš„å†…å­˜*shuffleç™¾åˆ†æ¯”å¾—åˆ°çš„</span></span><br><span class="line">  <span class="keyword">this</span>.memoryLimit = </span><br><span class="line">    (<span class="keyword">long</span>)(jobConf.getLong(MRJobConfig.REDUCE_MEMORY_TOTAL_BYTES,</span><br><span class="line">        Math.min(Runtime.getRuntime().maxMemory(), Integer.MAX_VALUE))</span><br><span class="line">      * maxInMemCopyUse);</span><br><span class="line">  <span class="keyword">this</span>.ioSortFactor = jobConf.getInt(MRJobConfig.IO_SORT_FACTOR, <span class="number">100</span>);</span><br><span class="line">  <span class="comment">// SHUFFLE_MEMORY_LIMIT_PERCENT = &quot;mapreduce.reduce.shuffle.memory.limit.percent&quot;</span></span><br><span class="line">  <span class="comment">// å•ä¸ªshuffleçš„å†…å­˜é™åˆ¶ï¼Œé»˜è®¤æ˜¯0.25</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">float</span> singleShuffleMemoryLimitPercent =</span><br><span class="line">      jobConf.getFloat(MRJobConfig.SHUFFLE_MEMORY_LIMIT_PERCENT,</span><br><span class="line">          DEFAULT_SHUFFLE_MEMORY_LIMIT_PERCENT);</span><br><span class="line">  <span class="keyword">if</span> (singleShuffleMemoryLimitPercent &lt;= <span class="number">0.0f</span></span><br><span class="line">      || singleShuffleMemoryLimitPercent &gt; <span class="number">1.0f</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Invalid value for &quot;</span></span><br><span class="line">        + MRJobConfig.SHUFFLE_MEMORY_LIMIT_PERCENT + <span class="string">&quot;: &quot;</span></span><br><span class="line">        + singleShuffleMemoryLimitPercent);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  usedMemory = <span class="number">0L</span>;</span><br><span class="line">  commitMemory = <span class="number">0L</span>;</span><br><span class="line">  <span class="comment">// singleShuffleMemoryLimitPercent = mapreduce.reduce.shuffle.memory.limit.percent</span></span><br><span class="line">  <span class="comment">// æ¯æ¬¡å†™å…¥æ—¶çš„æœ€å¤§é™åˆ¶ï¼Œè¶…è¿‡åˆ™ç›´æ¥å†™å…¥disk</span></span><br><span class="line">  <span class="keyword">this</span>.maxSingleShuffleLimit = </span><br><span class="line">    (<span class="keyword">long</span>)(memoryLimit * singleShuffleMemoryLimitPercent);</span><br><span class="line">  <span class="comment">// åœ¨å†…å­˜ä¸­mergeçš„é˜ˆå€¼ï¼Œè¯¥é˜ˆå€¼åªæœ‰åœ¨å¼€å¯å†…å­˜mergeåŠŸèƒ½æ‰æœ‰ç”¨</span></span><br><span class="line">  <span class="comment">// å†…å­˜mergeçš„å¼€å…³æ˜¯mapreduce.reduce.merge.memtomem.enabledï¼Œé»˜è®¤å…³é—­</span></span><br><span class="line">  <span class="keyword">this</span>.memToMemMergeOutputsThreshold = </span><br><span class="line">          jobConf.getInt(MRJobConfig.REDUCE_MEMTOMEM_THRESHOLD, ioSortFactor);</span><br><span class="line">  <span class="comment">// SHUFFLE_MERGE_PERCENT = &quot;mapreduce.reduce.shuffle.merge.percent&quot;      </span></span><br><span class="line">  <span class="comment">// mergeé˜ˆå€¼ï¼Œç”¨äºshuffleçš„å†…å­˜*mapreduce.reduce.shuffle.merge.percent</span></span><br><span class="line">  <span class="keyword">this</span>.mergeThreshold = (<span class="keyword">long</span>)(<span class="keyword">this</span>.memoryLimit * </span><br><span class="line">                        jobConf.getFloat(MRJobConfig.SHUFFLE_MERGE_PERCENT, </span><br><span class="line">                                         <span class="number">0.90f</span>));</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å†…å­˜mergeåŠŸèƒ½æ˜¯å¦å¼€å¯</span></span><br><span class="line">  <span class="keyword">boolean</span> allowMemToMemMerge = </span><br><span class="line">    jobConf.getBoolean(MRJobConfig.REDUCE_MEMTOMEM_ENABLED, <span class="keyword">false</span>);</span><br><span class="line">  <span class="keyword">if</span> (allowMemToMemMerge) &#123;</span><br><span class="line">    <span class="keyword">this</span>.memToMemMerger = </span><br><span class="line">      <span class="keyword">new</span> IntermediateMemoryToMemoryMerger(<span class="keyword">this</span>,</span><br><span class="line">                                           memToMemMergeOutputsThreshold);</span><br><span class="line">    <span class="keyword">this</span>.memToMemMerger.start();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.memToMemMerger = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯åŠ¨å†…å­˜mergeåˆ°Diskçš„mergerçº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">this</span>.inMemoryMerger = createInMemoryMerger();</span><br><span class="line">  <span class="keyword">this</span>.inMemoryMerger.start();</span><br><span class="line">  <span class="comment">// å¯åŠ¨disk mergeçº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">this</span>.onDiskMerger = <span class="keyword">new</span> OnDiskMerger(<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">this</span>.onDiskMerger.start();</span><br><span class="line">  <span class="keyword">this</span>.mergePhase = mergePhase;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initç»“æŸä¹‹åï¼Œå°±æ˜¯<code>shuffleConsumerPlugin.run()</code>ä¹Ÿå°±æ˜¯<code>Shuffle.run</code>ã€‚runçš„æ‰§è¡Œä¹Ÿæ ‡å¿—ç€Reduceé˜¶æ®µçš„å¼€å§‹ï¼Œrunä¸­å¯åŠ¨ä¸€ä¸ªæŠ“å–Completion Mapçš„çº¿ç¨‹EventFetcherå’Œcopyæ•°æ®çš„çº¿ç¨‹Fetcherï¼Œç­‰copyç»“æŸä¹‹åæ•°æ®è¿›è¡Œmerge sortã€‚ä»£ç è§£æå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RawKeyValueIterator <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="comment">// Scale the maximum events we fetch per RPC call to mitigate OOM issues</span></span><br><span class="line">  <span class="comment">// on the ApplicationMaster when a thundering herd of reducers fetch events</span></span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This should not be necessary after HADOOP-8942</span></span><br><span class="line">  <span class="keyword">int</span> eventsPerReducer = Math.max(MIN_EVENTS_TO_FETCH,</span><br><span class="line">      MAX_RPC_OUTSTANDING_EVENTS / jobConf.getNumReduceTasks());</span><br><span class="line">  <span class="comment">// æ¯æ¬¡ä»Completion Mapçš„listä¸­æŠ“å–å¤šå°‘ä¸ªMap</span></span><br><span class="line">  <span class="keyword">int</span> maxEventsToFetch = Math.min(MAX_EVENTS_TO_FETCH, eventsPerReducer);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Start the map-completion events fetcher thread</span></span><br><span class="line">  <span class="comment">// æŠ“å–Mapçº¿ç¨‹</span></span><br><span class="line">  <span class="keyword">final</span> EventFetcher&lt;K,V&gt; eventFetcher = </span><br><span class="line">    <span class="keyword">new</span> EventFetcher&lt;K,V&gt;(reduceId, umbilical, scheduler, <span class="keyword">this</span>,</span><br><span class="line">        maxEventsToFetch);</span><br><span class="line">  eventFetcher.start();  </span><br><span class="line">  <span class="comment">// Start the map-output fetcher threads</span></span><br><span class="line">  <span class="keyword">boolean</span> isLocal = localMapFiles != <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// Fetcherçº¿ç¨‹çš„ä¸ªæ•°ï¼ˆåˆ†æœ¬åœ°å’Œè¿œç¨‹ä¸¤ç§æƒ…å†µï¼‰</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numFetchers = isLocal ? <span class="number">1</span> :</span><br><span class="line">    jobConf.getInt(MRJobConfig.SHUFFLE_PARALLEL_COPIES, <span class="number">5</span>);</span><br><span class="line">  Fetcher&lt;K,V&gt;[] fetchers = <span class="keyword">new</span> Fetcher[numFetchers];</span><br><span class="line">  <span class="keyword">if</span> (isLocal) &#123;</span><br><span class="line">  <span class="comment">// æ–‡ä»¶åœ¨æœ¬åœ°åˆ™å¯åŠ¨LocalFetcherçº¿ç¨‹</span></span><br><span class="line">    fetchers[<span class="number">0</span>] = <span class="keyword">new</span> LocalFetcher&lt;K, V&gt;(jobConf, reduceId, scheduler,</span><br><span class="line">        merger, reporter, metrics, <span class="keyword">this</span>, reduceTask.getShuffleSecret(),</span><br><span class="line">        localMapFiles);</span><br><span class="line">    fetchers[<span class="number">0</span>].start();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// å¾ªç¯å¯åŠ¨è¿œç¨‹Fetcherçº¿ç¨‹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i &lt; numFetchers; ++i) &#123;</span><br><span class="line">      fetchers[i] = <span class="keyword">new</span> Fetcher&lt;K,V&gt;(jobConf, reduceId, scheduler, merger, </span><br><span class="line">                                     reporter, metrics, <span class="keyword">this</span>, </span><br><span class="line">                                     reduceTask.getShuffleSecret());</span><br><span class="line">      fetchers[i].start();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Wait for shuffle to complete successfully</span></span><br><span class="line">  <span class="keyword">while</span> (!scheduler.waitUntilDone(PROGRESS_FREQUENCY)) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  copyPhase.complete(); <span class="comment">// copy is already complete</span></span><br><span class="line">  taskStatus.setPhase(TaskStatus.Phase.SORT);</span><br><span class="line">  reduceTask.statusUpdate(umbilical);</span><br><span class="line">  <span class="comment">// Finish the on-going merges...</span></span><br><span class="line">  RawKeyValueIterator kvIter = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// copyç»“æŸä¹‹åè¿›è¡Œmerge sort</span></span><br><span class="line">    kvIter = merger.close();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ShuffleError(<span class="string">&quot;Error while doing final merge &quot;</span> , e);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> kvIter;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>runä¸­ä¸»è¦å®Œæˆäº†reduceå‰æœŸçš„å·¥ä½œï¼Œå…¶ä¸­å…ˆæ¥çœ‹ä¸‹_EventFetcher_çº¿ç¨‹çš„runä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> failures = <span class="number">0</span>;</span><br><span class="line">  LOG.info(reduce + <span class="string">&quot; Thread started: &quot;</span> + getName());  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (!stopped &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> numNewMaps = getMapCompletionEvents();</span><br><span class="line">        failures = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (numNewMaps &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          LOG.info(reduce + <span class="string">&quot;: &quot;</span> + <span class="string">&quot;Got &quot;</span> + numNewMaps + <span class="string">&quot; new map-outputs&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        LOG.debug(<span class="string">&quot;GetMapEventsThread about to sleep for &quot;</span> + SLEEP_TIME);</span><br><span class="line">        <span class="keyword">if</span> (!Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">          Thread.sleep(SLEEP_TIME);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) </span><br><span class="line">        ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) </span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getMapCompletionEvents</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> numNewMaps = <span class="number">0</span>;</span><br><span class="line">  TaskCompletionEvent events[] = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="comment">// rpc è°ƒç”¨</span></span><br><span class="line">    MapTaskCompletionEventsUpdate update =</span><br><span class="line">        umbilical.getMapCompletionEvents(</span><br><span class="line">            (org.apache.hadoop.mapred.JobID)reduce.getJobID(),</span><br><span class="line">            fromEventIdx,</span><br><span class="line">            maxEventsToFetch,</span><br><span class="line">            (org.apache.hadoop.mapred.TaskAttemptID)reduce);</span><br><span class="line">    events = update.getMapTaskCompletionEvents();</span><br><span class="line">    LOG.debug(<span class="string">&quot;Got &quot;</span> + events.length + <span class="string">&quot; map completion events from &quot;</span> +</span><br><span class="line">             fromEventIdx);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">assert</span> !update.shouldReset() : <span class="string">&quot;Unexpected legacy state&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Update the last seen event ID</span></span><br><span class="line">    fromEventIdx += events.length;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Process the TaskCompletionEvents:</span></span><br><span class="line">    <span class="comment">// 1. Save the SUCCEEDED maps in knownOutputs to fetch the outputs.</span></span><br><span class="line">    <span class="comment">// 2. Save the OBSOLETE/FAILED/KILLED maps in obsoleteOutputs to stop</span></span><br><span class="line">    <span class="comment">//    fetching from those maps.</span></span><br><span class="line">    <span class="comment">// 3. Remove TIPFAILED maps from neededOutputs since we don&#x27;t need their</span></span><br><span class="line">    <span class="comment">//    outputs at all.</span></span><br><span class="line">    <span class="keyword">for</span> (TaskCompletionEvent event : events) &#123;</span><br><span class="line">      scheduler.resolve(event);</span><br><span class="line">      <span class="keyword">if</span> (TaskCompletionEvent.Status.SUCCEEDED == event.getTaskStatus()) &#123;</span><br><span class="line">        ++numNewMaps;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (events.length == maxEventsToFetch);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> numNewMaps;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>EventFetcher</code>ä¸»è¦æ˜¯é€šè¿‡<code>getMapCompletionEvents</code>æ–¹æ³•çš„rpcæ‹¿åˆ°Completion Mapï¼Œç„¶åå¯¹_scheduler_çš„ç›¸å…³listè¿›è¡Œèµ‹å€¼ã€‚<code>umbilical</code>æ˜¯rpcåè®®<code>TaskUmbilicalProtocol</code>ï¼ŒRPCçš„å®ç°ç±»æ˜¯<code>TaskAttemptListenerImpl</code>ï¼Œåˆ™<code>umbilical.getMapCompletionEvents</code>å®é™…ä¸Šè°ƒç”¨çš„æ˜¯<code>TaskAttemptListenerImpl.getMapCompletionEvents</code>,ç„¶åç»§ç»­è°ƒç”¨<code>JobImpl.getMapAttemptCompletionEvents</code>æ–¹æ³•ï¼Œå¾—åˆ°å·²å®Œæˆçš„eventsï¼Œå¹¶å°†å…¶æ”¾å…¥schedulerä¸­ç›¸åº”çš„mapæ˜ å°„ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å¾—åˆ°events</span></span><br><span class="line"><span class="keyword">public</span> TaskCompletionEvent[] getMapAttemptCompletionEvents(</span><br><span class="line">    <span class="keyword">int</span> startIndex, <span class="keyword">int</span> maxEvents) &#123;</span><br><span class="line">  TaskCompletionEvent[] events = EMPTY_TASK_COMPLETION_EVENTS;</span><br><span class="line">  readLock.lock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (mapAttemptCompletionEvents.size() &gt; startIndex) &#123;</span><br><span class="line">      <span class="comment">// ä»mapAttemptCompletionEventsä¸­æˆªå–maxEventçš„map</span></span><br><span class="line">      <span class="keyword">int</span> actualMax = Math.min(maxEvents,</span><br><span class="line">          (mapAttemptCompletionEvents.size() - startIndex));</span><br><span class="line">      events = mapAttemptCompletionEvents.subList(startIndex,</span><br><span class="line">          actualMax + startIndex).toArray(events);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> events;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    readLock.unlock();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// å°†å¾—åˆ°çš„eventsæ”¾å…¥schedulerå¯¹åº”çš„mapæ˜ å°„ä¸­</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">resolve</span><span class="params">(TaskCompletionEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span> (event.getTaskStatus()) &#123;</span><br><span class="line">  <span class="keyword">case</span> SUCCEEDED:</span><br><span class="line">    URI u = getBaseURI(reduceId, event.getTaskTrackerHttp());</span><br><span class="line">    addKnownMapOutput(u.getHost() + <span class="string">&quot;:&quot;</span> + u.getPort(),</span><br><span class="line">        u.toString(),</span><br><span class="line">        event.getTaskAttemptId());</span><br><span class="line">    maxMapRuntime = Math.max(maxMapRuntime, event.getTaskRunTime());</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> FAILED:</span><br><span class="line">  <span class="keyword">case</span> KILLED:</span><br><span class="line">  <span class="keyword">case</span> OBSOLETE:</span><br><span class="line">    obsoleteMapOutput(event.getTaskAttemptId());</span><br><span class="line">    LOG.info(<span class="string">&quot;Ignoring obsolete output of &quot;</span> + event.getTaskStatus() +</span><br><span class="line">        <span class="string">&quot; map-task: &#x27;&quot;</span> + event.getTaskAttemptId() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> TIPFAILED:</span><br><span class="line">    tipFailed(event.getTaskAttemptId().getTaskID());</span><br><span class="line">    LOG.info(<span class="string">&quot;Ignoring output of failed map TIP: &#x27;&quot;</span> +</span><br><span class="line">        event.getTaskAttemptId() + <span class="string">&quot;&#x27;&quot;</span>);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>EventFetcher</code>åˆ°æ­¤åˆ†æå®Œæ¯•ï¼Œæ¥ä¸‹æ¥åˆ†æ<code>Fetcher</code>çº¿ç¨‹ã€‚<code>Fetcher</code>çº¿ç¨‹æœ‰ä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯<code>LocalFetcher</code>å’Œ<code>Fetcher</code>,é¡¾åæ€ä¹‰<code>LocalFetcher</code>æ˜¯fetcheræœ¬åœ°æ–‡ä»¶ç”¨çš„ï¼Œæ²¡æœ‰ç”¨åˆ°httpæœåŠ¡ã€‚<code>Fethcer</code>æ˜¯é€šè¿‡ http Get ä»è¿œç¨‹nodemanagerä¸Šfetcher mapè¾“å‡ºã€‚è¿™é‡Œä¸»è¦åˆ†æ<code>Fetcher</code>çº¿ç¨‹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (!stopped &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">      MapHost host = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// If merge is on, block</span></span><br><span class="line">        <span class="comment">// å­˜åœ¨å†…å­˜åˆ°ç£ç›˜çš„mergeï¼Œåˆ™Fetcherè¢«block</span></span><br><span class="line">        <span class="comment">// ä¸åƒmapperç«¯çš„ç¯å½¢ç¼“å†²åŒºä¸€æ ·ï¼Œå¯ä»¥ä¸€è¾¹å‘ç£ç›˜å†™ï¼Œä¸€è¾¹ç»§ç»­å‘å†…å­˜å†™æ•°æ®</span></span><br><span class="line">        <span class="comment">// è¿™é‡Œå½“å­˜åœ¨MemToDiskçš„mergeæ—¶ï¼Œfetchæ“ä½œè¢«é˜»å¡</span></span><br><span class="line">        <span class="comment">// memToDiskè§¦å‘çš„æ¡ä»¶æ˜¯å†…å­˜ä¸­çš„å æ¯”è¶…è¿‡90%</span></span><br><span class="line">        merger.waitForResource();</span><br><span class="line">        <span class="comment">// Get a host to shuffle from</span></span><br><span class="line">        <span class="comment">// éšæœºå¾—åˆ°ä¸€ä¸ªHost</span></span><br><span class="line">        host = scheduler.getHost();</span><br><span class="line">        metrics.threadBusy();</span><br><span class="line">        <span class="comment">// Shuffle</span></span><br><span class="line">        copyFromHost(host);</span><br><span class="line">      &#125; </span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">copyFromHost</span><span class="params">(MapHost host)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Get completed maps on &#x27;host&#x27;</span></span><br><span class="line">  <span class="comment">// å¾—åˆ°map listï¼Œæœ€å¤šæ‹¿åˆ°MAX_MAPS_AT_ONCEï¼ˆé»˜è®¤æ˜¯20ï¼‰</span></span><br><span class="line">  List&lt;TaskAttemptID&gt; maps = scheduler.getMapsForHost(host);</span><br><span class="line">  <span class="comment">// Sanity check to catch hosts with only &#x27;OBSOLETE&#x27; maps, </span></span><br><span class="line">  <span class="comment">// especially at the tail of large jobs</span></span><br><span class="line">  <span class="keyword">if</span> (maps.size() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// List of maps to be fetched yet</span></span><br><span class="line">  Set&lt;TaskAttemptID&gt; remaining = <span class="keyword">new</span> HashSet&lt;TaskAttemptID&gt;(maps);</span><br><span class="line">  <span class="comment">// Construct the url and connect</span></span><br><span class="line">  DataInputStream input = <span class="keyword">null</span>;</span><br><span class="line">  URL url = getMapOutputURL(host, maps);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// é€šè¿‡jettyæœåŠ¡å™¨åˆ›å»ºhttpè¿æ¥</span></span><br><span class="line">    setupConnectionsWithRetry(host, remaining, url);</span><br><span class="line">    <span class="keyword">if</span> (stopped) &#123;</span><br><span class="line">      abortConnect(host, remaining);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ ¹æ®httpåˆ›å»ºä¸€ä¸ªinputæµ</span></span><br><span class="line">  input = <span class="keyword">new</span> DataInputStream(connection.getInputStream()); </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Loop through available map-outputs and fetch them</span></span><br><span class="line">    <span class="comment">// On any error, faildTasks is not null and we exit</span></span><br><span class="line">    <span class="comment">// after putting back the remaining maps to the </span></span><br><span class="line">    <span class="comment">// yet_to_be_fetched list and marking the failed tasks.</span></span><br><span class="line">    TaskAttemptID[] failedTasks = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (!remaining.isEmpty() &amp;&amp; failedTasks == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å¤åˆ¶map</span></span><br><span class="line">        failedTasks = copyMapOutput(host, input, remaining, fetchRetryEnabled);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Setup connection again if disconnected by NM</span></span><br><span class="line">        connection.disconnect();</span><br><span class="line">        <span class="comment">// Get map output from remaining tasks only.</span></span><br><span class="line">        url = getMapOutputURL(host, remaining);        </span><br><span class="line">        <span class="comment">// Connect with retry as expecting host&#x27;s recovery take sometime.</span></span><br><span class="line">        setupConnectionsWithRetry(host, remaining, url);</span><br><span class="line">        <span class="keyword">if</span> (stopped) &#123;</span><br><span class="line">          abortConnect(host, remaining);</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        input = <span class="keyword">new</span> DataInputStream(connection.getInputStream());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> TaskAttemptID[] copyMapOutput(MapHost host,</span><br><span class="line">                              DataInputStream input,</span><br><span class="line">                              Set&lt;TaskAttemptID&gt; remaining,</span><br><span class="line">                              <span class="keyword">boolean</span> canRetry) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  ...  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">long</span> startTime = Time.monotonicNow();</span><br><span class="line">    <span class="keyword">int</span> forReduce = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">//Read the shuffle header</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ShuffleHeader header = <span class="keyword">new</span> ShuffleHeader();</span><br><span class="line">      <span class="comment">// è¯»å–å†…å®¹åˆ°inputæµä¸­</span></span><br><span class="line">      header.readFields(input);</span><br><span class="line">      mapId = TaskAttemptID.forName(header.mapId);</span><br><span class="line">      compressedLength = header.compressedLength;</span><br><span class="line">      decompressedLength = header.uncompressedLength;</span><br><span class="line">      forReduce = header.forReduce;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    InputStream is = input;</span><br><span class="line">    is = CryptoUtils.wrapIfNecessary(jobConf, is, compressedLength);</span><br><span class="line">    compressedLength -= CryptoUtils.cryptoPadding(jobConf);</span><br><span class="line">    decompressedLength -= CryptoUtils.cryptoPadding(jobConf);</span><br><span class="line">    ...    </span><br><span class="line">    <span class="comment">// Get the location for the map output - either in-memory or on-disk</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æ ¹æ®å†…å®¹å¤§å°ç”³è¯·èµ„æºï¼Œæ­¤å¤„å†³å®šå†™å…¥çš„ç›®çš„åœ° mem or disk</span></span><br><span class="line">      mapOutput = merger.reserve(mapId, decompressedLength, id);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Check if we can shuffle *now* ...</span></span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰å†…å­˜ä½¿ç”¨è¶…è¿‡memoryLimitï¼Œåˆ™merger.reserve è¿”å›null</span></span><br><span class="line">    <span class="comment">// æ­¤æ—¶ä¸èƒ½shuffle</span></span><br><span class="line">    <span class="keyword">if</span> (mapOutput == <span class="keyword">null</span>) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;fetcher#&quot;</span> + id + <span class="string">&quot; - MergeManager returned status WAIT ...&quot;</span>);</span><br><span class="line">        <span class="comment">//Not an error but wait to process data.</span></span><br><span class="line">        <span class="keyword">return</span> EMPTY_ATTEMPT_ID_ARRAY;</span><br><span class="line">    &#125; </span><br><span class="line">       </span><br><span class="line">    <span class="comment">// The codec for lz0,lz4,snappy,bz2,etc. throw java.lang.InternalError</span></span><br><span class="line">    <span class="comment">// on decompression failures. Catching and re-throwing as IOException</span></span><br><span class="line">    <span class="comment">// to allow fetch failure logic to be processed</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Go!</span></span><br><span class="line">      LOG.info(<span class="string">&quot;fetcher#&quot;</span> + id + <span class="string">&quot; about to shuffle output of map &quot;</span></span><br><span class="line">          + mapOutput.getMapId() + <span class="string">&quot; decomp: &quot;</span> + decompressedLength</span><br><span class="line">          + <span class="string">&quot; len: &quot;</span> + compressedLength + <span class="string">&quot; to &quot;</span> + mapOutput.getDescription());</span><br><span class="line">      <span class="comment">// å°†æ•°æ®å†™å…¥mem æˆ–è€… disk</span></span><br><span class="line">      mapOutput.shuffle(host, is, compressedLength, decompressedLength,</span><br><span class="line">          metrics, reporter);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (java.lang.InternalError e) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Failed to shuffle for fetcher#&quot;</span>+id, e);</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Inform the shuffle scheduler</span></span><br><span class="line">    <span class="keyword">long</span> endTime = Time.monotonicNow();</span><br><span class="line">    <span class="comment">// Reset retryStartTime as map task make progress if retried before.</span></span><br><span class="line">    retryStartTime = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    scheduler.copySucceeded(mapId, host, compressedLength, </span><br><span class="line">                            startTime, endTime, mapOutput);</span><br><span class="line">    <span class="comment">// Note successful shuffle</span></span><br><span class="line">    remaining.remove(mapId);</span><br><span class="line">    metrics.successFetch();</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>Fetcher</code>çº¿ç¨‹çš„runæ–¹æ³•ä¸­å…ˆåˆ¤æ–­æ˜¯å¦æœ‰_merge_ï¼Œå¦‚æœæœ‰åˆ™blockå½“å‰<code>Fetcher</code>çº¿ç¨‹ï¼Œè¿™é‡Œåªåˆ¤æ–­æ˜¯å¦_å­˜åœ¨å†…å­˜åˆ°ç£ç›˜çš„merge_ã€‚éšåä»_Host_åˆ—è¡¨ä¸­_éšæœº_é€‰å‡ºä¸€ä¸ª_Host_ï¼ˆéšæœºæ–¹æ³•å¯æŸ¥çœ‹<code>scheduler.getHost()</code>ä»£ç ï¼‰ï¼Œè¿›è¡Œcopyï¼Œcopyçš„å…¥å£æ˜¯<code>copyFromHost</code>ï¼Œ<code>copyFromHost</code>çš„ä¸»è¦å·¥ä½œæ˜¯å»ºç«‹_httpè¿æ¥_ï¼Œç„¶åå¾ªç¯è°ƒç”¨<code>copyMapOutput</code>å¯¹_æŸä¸ªmap_çš„è¾“å‡ºè¿›è¡Œcopyã€‚åœ¨<code>copyMapOutput</code>ä¸­ä¼šåˆ¤æ–­å½“å‰çš„å†…å®¹æ˜¯è¾“å‡ºåˆ°memè¿˜æ˜¯diskï¼Œæ­¤å¤„çš„é€»è¾‘åˆ¤æ–­åœ¨<code>merger.reserve()</code>ä¸­ï¼Œçœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> MapOutput&lt;K,V&gt; <span class="title">reserve</span><span class="params">(TaskAttemptID mapId, </span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">long</span> requestedSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                                           <span class="keyword">int</span> fetcher</span></span></span><br><span class="line"><span class="params"><span class="function">                                           )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­å½“å‰å†…å®¹å¤§å°æ˜¯å¦èƒ½å†™å…¥Memoryï¼Œä¸èƒ½åˆ™ç›´æ¥å†™å…¥disk</span></span><br><span class="line">  <span class="comment">// requestedSize &lt; maxSingleShuffleLimit ä¸ºtrue</span></span><br><span class="line">  <span class="comment">// memoryLimit * mapreduce.reduce.shuffle.memory.limit.percent</span></span><br><span class="line">  <span class="keyword">if</span> (!canShuffleToMemory(requestedSize)) &#123;</span><br><span class="line">    LOG.info(mapId + <span class="string">&quot;: Shuffling to disk since &quot;</span> + requestedSize + </span><br><span class="line">             <span class="string">&quot; is greater than maxSingleShuffleLimit (&quot;</span> + </span><br><span class="line">             maxSingleShuffleLimit + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> OnDiskMapOutput&lt;K,V&gt;(mapId, reduceId, <span class="keyword">this</span>, requestedSize,</span><br><span class="line">                                    jobConf, mapOutputFile, fetcher, <span class="keyword">true</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Stall shuffle if we are above the memory limit</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸‹é¢è¿™æ®µè‹±è¯­çš„æ„æ€æ˜¯è¯´ï¼š</span></span><br><span class="line">  <span class="comment">// å¦‚æœå°†(usedMemory &gt; memoryLimit) æ”¹ä¸º (usedMemory + requestedSize &gt; memoryLimit)</span></span><br><span class="line">  <span class="comment">// ä¼šå‡ºç°æ‰€æœ‰çš„Fetcherçº¿ç¨‹è¢«æ­»å¾ªç¯</span></span><br><span class="line">  <span class="comment">// å½“used size &lt; mergeThreshold &amp;&amp; requested size &lt; singleShuffleLimit </span></span><br><span class="line">  <span class="comment">// &amp;&amp; usedMemory + requestedSize &gt; memoryLimit åˆ™å†™æ“ä½œæš‚åœï¼Œä½†æ­¤æ—¶å¹¶æ²¡æœ‰</span></span><br><span class="line">  <span class="comment">// è¶…è¿‡mergeThresholdï¼Œå¹¶ä¸ä¼šè§¦å‘merge Threadï¼Œåˆ™å‡å¦‚æ‰€æœ‰çš„Fetcherçš„requested size éƒ½æ»¡è¶³</span></span><br><span class="line">  <span class="comment">// usedMemory + requestedSize &gt; memoryLimitï¼Œåˆ™æ­¤æ—¶all threads could just be stalling and not </span></span><br><span class="line">  <span class="comment">// make progress at all.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// It is possible that all threads could just be stalling and not make</span></span><br><span class="line">  <span class="comment">// progress at all. This could happen when:</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// requested size is causing the used memory to go above limit &amp;&amp;</span></span><br><span class="line">  <span class="comment">// requested size &lt; singleShuffleLimit &amp;&amp;</span></span><br><span class="line">  <span class="comment">// current used size &lt; mergeThreshold (merge will not get triggered)</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// To avoid this from happening, we allow exactly one thread to go past</span></span><br><span class="line">  <span class="comment">// the memory limit. We check (usedMemory &gt; memoryLimit) and not</span></span><br><span class="line">  <span class="comment">// (usedMemory + requestedSize &gt; memoryLimit). When this thread is done</span></span><br><span class="line">  <span class="comment">// fetching, this will automatically trigger a merge thereby unlocking</span></span><br><span class="line">  <span class="comment">// all the stalled threads</span></span><br><span class="line">  <span class="comment">// å¦‚æœusedMemory &gt; memoryLimit åˆ™è¿”å›nullï¼Œæš‚å®šshuffleï¼Œç­‰å¾…memToDisk</span></span><br><span class="line">  <span class="keyword">if</span> (usedMemory &gt; memoryLimit) &#123;</span><br><span class="line">    LOG.debug(mapId + <span class="string">&quot;: Stalling shuffle since usedMemory (&quot;</span> + usedMemory</span><br><span class="line">        + <span class="string">&quot;) is greater than memoryLimit (&quot;</span> + memoryLimit + <span class="string">&quot;).&quot;</span> + </span><br><span class="line">        <span class="string">&quot; CommitMemory is (&quot;</span> + commitMemory + <span class="string">&quot;)&quot;</span>); </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Allow the in-memory shuffle to progress</span></span><br><span class="line">  LOG.debug(mapId + <span class="string">&quot;: Proceeding with shuffle since usedMemory (&quot;</span></span><br><span class="line">      + usedMemory + <span class="string">&quot;) is lesser than memoryLimit (&quot;</span> + memoryLimit + <span class="string">&quot;).&quot;</span></span><br><span class="line">      + <span class="string">&quot;CommitMemory is (&quot;</span> + commitMemory + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">  <span class="comment">// usedMemory += requestedSize and new InMemoryMapOutput </span></span><br><span class="line">  <span class="keyword">return</span> unconditionalReserve(mapId, requestedSize, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±<code>merger.reserve()</code>å¾—åˆ°_OnDiskMapOutput_æˆ–è€…_InMemoryMapOutput_ä¹‹åï¼Œè°ƒç”¨<code>mapOutput.shuffle</code>å°†å†…å®¹é€šè¿‡è¾“å‡ºæµå†™å…¥Memoryæˆ–è€…Diskã€‚éšåç”±<code>scheduler.copySucceeded</code>è¿›è¡Œæ”¶å°¾å·¥ä½œï¼Œä¸»è¦åŒ…æ‹¬å°†å·²å®Œæˆcopyçš„mapçŠ¶æ€è®¾ç½®ä¸ºtrueï¼ˆmap copyçš„çŠ¶æ€å­˜å‚¨åœ¨<code>finishedMaps</code>çš„booleanæ•°ç»„ä¸­ï¼ŒmapIndexä¸ºæ•°ç»„çš„idï¼Œå®Œæˆåˆ™ä¸ºtrueï¼‰ï¼Œå®Œæˆä¸€äº›ç»Ÿè®¡ä¿¡æ¯ï¼Œä»¥åŠç”±<code>output.commit()</code>æäº¤å¹¶å…³é—­mapOutputæµï¼Œåœ¨å…³é—­çš„è¿‡ç¨‹ä¸­ä¼šåˆ¤æ–­æ˜¯å¦éœ€è¦_merge_ã€‚ä¸‹é¢çœ‹ä¸‹ä»£ç ï¼Œé‡ç‚¹çœ‹ä¸‹<code>output.commit</code>ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">copySucceeded</span><span class="params">(TaskAttemptID mapId,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       MapHost host,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="keyword">long</span> bytes,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="keyword">long</span> startMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       <span class="keyword">long</span> endMillis,</span></span></span><br><span class="line"><span class="params"><span class="function">                                       MapOutput&lt;K,V&gt; output</span></span></span><br><span class="line"><span class="params"><span class="function">                                       )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// å¯¹å®Œæˆçš„mapè¿›è¡Œä¸€äº›çŠ¶æ€ä¿®æ”¹                                      </span></span><br><span class="line">  failureCounts.remove(mapId);</span><br><span class="line">  hostFailures.remove(host.getHostName());</span><br><span class="line">  <span class="keyword">int</span> mapIndex = mapId.getTaskID().getId();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!finishedMaps[mapIndex]) &#123;</span><br><span class="line">    <span class="comment">// æäº¤å¹¶å…³é—­mapOutputæµ å¹¶ åˆ¤æ–­æ˜¯å¦è§¦å‘mergeçº¿ç¨‹</span></span><br><span class="line">    output.commit();</span><br><span class="line">    <span class="comment">// finishedMapsä¸­å¯¹åº”çš„mapçš„çŠ¶æ€è®¾ç½®ä¸ºtrue</span></span><br><span class="line">    finishedMaps[mapIndex] = <span class="keyword">true</span>;</span><br><span class="line">    shuffledMapsCounter.increment(<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span> (--remainingMaps == <span class="number">0</span>) &#123;</span><br><span class="line">      notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update single copy task status</span></span><br><span class="line">    <span class="comment">// å®Œæˆç»Ÿè®¡ä¿¡æ¯</span></span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// InMemoryMapOutput.commit</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  merger.closeInMemoryFile(<span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// OnDiskMapOutput.commit</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">commit</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  fs.rename(tmpOutputPath, outputPath);</span><br><span class="line">  CompressAwarePath compressAwarePath = <span class="keyword">new</span> CompressAwarePath(outputPath,</span><br><span class="line">      getSize(), <span class="keyword">this</span>.compressedSize);</span><br><span class="line">  merger.closeOnDiskFile(compressAwarePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±<code>merger.reserve()</code>å¾—åˆ°mapOutputæœ‰ä¸¤ç§æƒ…å†µï¼Œåˆ™å…ˆæ¥çœ‹<code>InMemoryMapOutput.commit</code>ï¼Œå…¶å†…è°ƒç”¨äº†<code>closeInMemoryFile</code>ï¼Œè§‚å…¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">closeInMemoryFile</span><span class="params">(InMemoryMapOutput&lt;K,V&gt; mapOutput)</span> </span>&#123; </span><br><span class="line">  inMemoryMapOutputs.add(mapOutput);</span><br><span class="line">  LOG.info(<span class="string">&quot;closeInMemoryFile -&gt; map-output of size: &quot;</span> + mapOutput.getSize()</span><br><span class="line">      + <span class="string">&quot;, inMemoryMapOutputs.size() -&gt; &quot;</span> + inMemoryMapOutputs.size()</span><br><span class="line">      + <span class="string">&quot;, commitMemory -&gt; &quot;</span> + commitMemory + <span class="string">&quot;, usedMemory -&gt;&quot;</span> + usedMemory);</span><br><span class="line">  <span class="comment">// æ›´æ–°å†…å­˜ä½¿ç”¨é‡</span></span><br><span class="line">  commitMemory+= mapOutput.getSize();</span><br><span class="line">  <span class="comment">// åˆ¤æ–­å½“å‰ä½¿ç”¨é‡æ˜¯å¦è¶…è¿‡mergeThreshold  mapreduce.reduce.shuffle.merge.percent</span></span><br><span class="line">  <span class="comment">// Can hang if mergeThreshold is really low.</span></span><br><span class="line">  <span class="keyword">if</span> (commitMemory &gt;= mergeThreshold) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Starting inMemoryMerger&#x27;s merge since commitMemory=&quot;</span> +</span><br><span class="line">        commitMemory + <span class="string">&quot; &gt; mergeThreshold=&quot;</span> + mergeThreshold + </span><br><span class="line">        <span class="string">&quot;. Current usedMemory=&quot;</span> + usedMemory);</span><br><span class="line">    <span class="comment">// inMemoryMergedMapOutputs æ˜¯ç”±memTomemæ›´æ–°çš„</span></span><br><span class="line">    inMemoryMapOutputs.addAll(inMemoryMergedMapOutputs);</span><br><span class="line">    inMemoryMergedMapOutputs.clear();</span><br><span class="line">    <span class="comment">// è§¦å‘MergeThreadè¿›è¡Œmerge</span></span><br><span class="line">    inMemoryMerger.startMerge(inMemoryMapOutputs);</span><br><span class="line">    commitMemory = <span class="number">0L</span>;  <span class="comment">// Reset commitMemory.</span></span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (memToMemMerger != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inMemoryMapOutputs.size() &gt;= memToMemMergeOutputsThreshold) &#123; </span><br><span class="line">      memToMemMerger.startMerge(inMemoryMapOutputs);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†æ¥çœ‹ä¸‹<code>OnDiskMapOutput.commit</code>ï¼Œå°†è¾“å‡ºçš„ä¸´æ—¶æ–‡ä»¶é‡å‘½åï¼Œç„¶åè°ƒç”¨<code>closeOnDiskFile</code>ï¼ŒæŸ¥å…¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">closeOnDiskFile</span><span class="params">(CompressAwarePath file)</span> </span>&#123;</span><br><span class="line">  onDiskMapOutputs.add(file);</span><br><span class="line">  <span class="comment">// æ˜¯å¦æ»¡è¶³Disk mergeæ¡ä»¶</span></span><br><span class="line">  <span class="keyword">if</span> (onDiskMapOutputs.size() &gt;= (<span class="number">2</span> * ioSortFactor - <span class="number">1</span>)) &#123;</span><br><span class="line">    <span class="comment">// è§¦å‘MergeThreadè¿›è¡Œmerge</span></span><br><span class="line">    onDiskMerger.startMerge(onDiskMapOutputs);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ä¸¤ä¸ª<code>commit</code>é‡Œéƒ½æ˜¯é€šè¿‡<code>startMerge</code>è§¦å‘MergeThreadçš„ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MergeThread.startMerge</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startMerge</span><span class="params">(Set&lt;T&gt; inputs)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!closed) &#123;</span><br><span class="line">    <span class="comment">// æ ‡è¯†è§¦å‘mergeçš„æ¬¡æ•°</span></span><br><span class="line">    numPending.incrementAndGet();</span><br><span class="line">    List&lt;T&gt; toMergeInputs = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">    Iterator&lt;T&gt; iter=inputs.iterator();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> ctr = <span class="number">0</span>; iter.hasNext() &amp;&amp; ctr &lt; mergeFactor; ++ctr) &#123;</span><br><span class="line">      toMergeInputs.add(iter.next());</span><br><span class="line">      iter.remove();</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.info(getName() + <span class="string">&quot;: Starting merge with &quot;</span> + toMergeInputs.size() + </span><br><span class="line">             <span class="string">&quot; segments, while ignoring &quot;</span> + inputs.size() + <span class="string">&quot; segments&quot;</span>);</span><br><span class="line">    <span class="keyword">synchronized</span>(pendingToBeMerged) &#123;</span><br><span class="line">      <span class="comment">// å°†å¾…mergeçš„outputæ”¾å…¥pendingToBeMergedä¸­</span></span><br><span class="line">      <span class="comment">// pendingToBeMerged æ˜¯LinkedList</span></span><br><span class="line">      pendingToBeMerged.addLast(toMergeInputs);</span><br><span class="line">      pendingToBeMerged.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆ<code>numPending</code>è®°å½•äº†è§¦å‘mergeçš„æ¬¡æ•°ï¼Œ_numPending_ä¼šåœ¨<code>MergeThread.waitForMerge()</code>å’Œ<code>MergeThread.run</code>ä¸­ç”¨åˆ°ï¼Œ<code>MergeThread.waitForMerge()</code>åœ¨<code>Fetcher.run</code>é€šè¿‡<code>merger.waitForResource()</code> è°ƒç”¨ï¼Œåˆ¤æ–­å½“å‰æ˜¯å¦æœ‰mergeçº¿ç¨‹ï¼Œæœ‰åˆ™é˜»å¡Fetcherçº¿ç¨‹ã€‚åœ¨<code>MergeThread.run</code>ä¸­å¦‚æœmergeæˆåŠŸåˆ™è°ƒç”¨<code>numPending.decrementAndGet();notifyAll();</code>æ›´æ–°_numPending_çš„çŠ¶æ€å¹¶é€šçŸ¥æ‰€æœ‰è¢«<code>MergeThread.wait()</code>é˜»å¡çš„çº¿ç¨‹ã€‚<br><code>pendingToBeMerged</code>æ˜¯_LinkedList_ç±»å‹çš„ï¼Œå°†éœ€è¦mergeçš„listæ·»åŠ åˆ°_pendingToBeMerged_æœ«å°¾ï¼Œåœ¨<code>MergeThread.run</code>ä¸­ä»é“¾è¡¨çš„å¤´å–å‡ºéœ€è¦mergeçš„listã€‚<code>MergeThread.run</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    List&lt;T&gt; inputs = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Wait for notification to start the merge...</span></span><br><span class="line">      <span class="keyword">synchronized</span> (pendingToBeMerged) &#123;</span><br><span class="line">        <span class="comment">// pendingToBeMergedä¸­æ²¡æœ‰æ—¶mergeThreadé˜»å¡</span></span><br><span class="line">        <span class="keyword">while</span>(pendingToBeMerged.size() &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">          pendingToBeMerged.wait();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// Pickup the inputs to merge.</span></span><br><span class="line">        inputs = pendingToBeMerged.removeFirst();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Merge</span></span><br><span class="line">      <span class="comment">// å…·ä½“çš„mergeï¼Œç”±InMemoryMapOutputå’ŒOnDiskMapOutputå®ç°</span></span><br><span class="line">      merge(inputs);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">      numPending.set(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(Throwable t) &#123;</span><br><span class="line">      numPending.set(<span class="number">0</span>);</span><br><span class="line">      reporter.reportException(t);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="comment">// mergeæˆåŠŸå¹¶é€šçŸ¥è¢«é˜»å¡çš„çº¿ç¨‹</span></span><br><span class="line">        numPending.decrementAndGet();</span><br><span class="line">        notifyAll();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±<code>MergeThread.startMerge</code>æ¿€æ´»<code>MergeThread</code>çº¿ç¨‹ä¹‹åï¼Œä»<code>pendingToBeMerged</code>ä¸­å–å‡ºé“¾å¤´çš„å…ƒç´ ï¼Œé€šè¿‡ä¸åŒç±»å®ç°çš„<code>merge()</code>æ–¹æ³•è¿›è¡Œå…·ä½“çš„mergeè¿‡ç¨‹ï¼Œæœ€åæ›´æ–°_mumPending_çš„çŠ¶æ€ã€‚è¿™é‡Œä¸»è¦åˆ†æä¸‹_InMemoryMapOutput_å’Œ_OnDiskMapOutput_å®ç°çš„mergeæ–¹æ³•ã€‚å…ˆçœ‹<code>InMemoryMapOutput.merge</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(List&lt;InMemoryMapOutput&lt;K,V&gt;&gt; inputs)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (inputs == <span class="keyword">null</span> || inputs.size() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//name this output file same as the name of the first file that is </span></span><br><span class="line">  <span class="comment">//there in the current list of inmem files (this is guaranteed to</span></span><br><span class="line">  <span class="comment">//be absent on the disk currently. So we don&#x27;t overwrite a prev. </span></span><br><span class="line">  <span class="comment">//created spill). Also we need to create the output file now since</span></span><br><span class="line">  <span class="comment">//it is not guaranteed that this file will be present after merge</span></span><br><span class="line">  <span class="comment">//is called (we delete empty files as soon as we see them</span></span><br><span class="line">  <span class="comment">//in the merge method)</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//figure out the mapId </span></span><br><span class="line">  TaskAttemptID mapId = inputs.get(<span class="number">0</span>).getMapId();</span><br><span class="line">  TaskID mapTaskId = mapId.getTaskID();</span><br><span class="line"></span><br><span class="line">  List&lt;Segment&lt;K, V&gt;&gt; inMemorySegments = <span class="keyword">new</span> ArrayList&lt;Segment&lt;K, V&gt;&gt;();</span><br><span class="line">  <span class="keyword">long</span> mergeOutputSize = </span><br><span class="line">    createInMemorySegments(inputs, inMemorySegments,<span class="number">0</span>);</span><br><span class="line">  <span class="keyword">int</span> noInMemorySegments = inMemorySegments.size();</span><br><span class="line"></span><br><span class="line">  Path outputPath = </span><br><span class="line">    mapOutputFile.getInputFileForWrite(mapTaskId,</span><br><span class="line">                                       mergeOutputSize).suffix(</span><br><span class="line">                                           Task.MERGED_OUTPUT_PREFIX);</span><br><span class="line"></span><br><span class="line">  FSDataOutputStream out = CryptoUtils.wrapIfNecessary(jobConf, rfs.create(outputPath));</span><br><span class="line">  Writer&lt;K, V&gt; writer = <span class="keyword">new</span> Writer&lt;K, V&gt;(jobConf, out,</span><br><span class="line">      (Class&lt;K&gt;) jobConf.getMapOutputKeyClass(),</span><br><span class="line">      (Class&lt;V&gt;) jobConf.getMapOutputValueClass(), codec, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  RawKeyValueIterator rIter = <span class="keyword">null</span>;</span><br><span class="line">  CompressAwarePath compressAwarePath;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Initiating in-memory merge with &quot;</span> + noInMemorySegments + </span><br><span class="line">             <span class="string">&quot; segments...&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    rIter = Merger.merge(jobConf, rfs,</span><br><span class="line">                         (Class&lt;K&gt;)jobConf.getMapOutputKeyClass(),</span><br><span class="line">                         (Class&lt;V&gt;)jobConf.getMapOutputValueClass(),</span><br><span class="line">                         inMemorySegments, inMemorySegments.size(),</span><br><span class="line">                         <span class="keyword">new</span> Path(reduceId.toString()),</span><br><span class="line">                         (RawComparator&lt;K&gt;)jobConf.getOutputKeyComparator(),</span><br><span class="line">                         reporter, spilledRecordsCounter, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == combinerClass) &#123;</span><br><span class="line">      Merger.writeFile(rIter, writer, reporter, jobConf);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      combineCollector.setWriter(writer);</span><br><span class="line">      combineAndSpill(rIter, reduceCombineInputCounter);</span><br><span class="line">    &#125;</span><br><span class="line">    writer.close();</span><br><span class="line">    compressAwarePath = <span class="keyword">new</span> CompressAwarePath(outputPath,</span><br><span class="line">        writer.getRawLength(), writer.getCompressedLength());</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123; </span><br><span class="line">    <span class="comment">//make sure that we delete the ondisk file that we created </span></span><br><span class="line">    <span class="comment">//earlier when we invoked cloneFileAttributes</span></span><br><span class="line">    localFS.delete(outputPath, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Note the output of the merge</span></span><br><span class="line">  closeOnDiskFile(compressAwarePath);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>InMemoryMapOutput.merge</code>ä¸»è¦æ˜¯è°ƒç”¨äº†<code>Merger.merge</code>å¯¹å„ä¸ªæ–‡ä»¶è¿›è¡Œå †æ’åºï¼Œè¿™é‡Œè¿˜è¦åˆ¤æ–­ä¸‹æ˜¯å¦æœ‰<code>combiner</code>ï¼ˆ__åªæœ‰mem to diskæ—¶æ‰ä¼šåˆ¤æ–­__ï¼‰ï¼Œæ–¹æ³•çš„ç»“å°¾ä¼šè°ƒç”¨<code>closeOnDiskFile</code>ï¼Œæ£€æŸ¥ä¸‹å†…å­˜çš„æ–‡ä»¶mergeåˆ°diskä¹‹åï¼Œæ˜¯å¦æ»¡è¶³disk mergeçš„æ¡ä»¶ã€‚<code>InMemoryMapOutput.merge</code>åˆ°æ­¤ç»“æŸï¼Œæ¥ä¸‹æ¥çœ‹ä¸‹<code>OnDiskMapOutput.merge</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">merge</span><span class="params">(List&lt;CompressAwarePath&gt; inputs)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// sanity check</span></span><br><span class="line">  <span class="keyword">if</span> (inputs == <span class="keyword">null</span> || inputs.isEmpty()) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;No ondisk files to merge...&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">long</span> approxOutputSize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> bytesPerSum = </span><br><span class="line">    jobConf.getInt(<span class="string">&quot;io.bytes.per.checksum&quot;</span>, <span class="number">512</span>);</span><br><span class="line">  </span><br><span class="line">  LOG.info(<span class="string">&quot;OnDiskMerger: We have  &quot;</span> + inputs.size() + </span><br><span class="line">           <span class="string">&quot; map outputs on disk. Triggering merge...&quot;</span>);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// 1. Prepare the list of files to be merged. </span></span><br><span class="line">  <span class="keyword">for</span> (CompressAwarePath file : inputs) &#123;</span><br><span class="line">    approxOutputSize += localFS.getFileStatus(file).getLen();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// add the checksum length</span></span><br><span class="line">  approxOutputSize += </span><br><span class="line">    ChecksumFileSystem.getChecksumLength(approxOutputSize, bytesPerSum);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 2. Start the on-disk merge process</span></span><br><span class="line">  Path outputPath = </span><br><span class="line">    localDirAllocator.getLocalPathForWrite(inputs.get(<span class="number">0</span>).toString(), </span><br><span class="line">        approxOutputSize, jobConf).suffix(Task.MERGED_OUTPUT_PREFIX);</span><br><span class="line"></span><br><span class="line">  FSDataOutputStream out = CryptoUtils.wrapIfNecessary(jobConf, rfs.create(outputPath));</span><br><span class="line">  Writer&lt;K, V&gt; writer = <span class="keyword">new</span> Writer&lt;K, V&gt;(jobConf, out,</span><br><span class="line">      (Class&lt;K&gt;) jobConf.getMapOutputKeyClass(),</span><br><span class="line">      (Class&lt;V&gt;) jobConf.getMapOutputValueClass(), codec, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  RawKeyValueIterator iter  = <span class="keyword">null</span>;</span><br><span class="line">  CompressAwarePath compressAwarePath;</span><br><span class="line">  Path tmpDir = <span class="keyword">new</span> Path(reduceId.toString());</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    iter = Merger.merge(jobConf, rfs,</span><br><span class="line">                        (Class&lt;K&gt;) jobConf.getMapOutputKeyClass(),</span><br><span class="line">                        (Class&lt;V&gt;) jobConf.getMapOutputValueClass(),</span><br><span class="line">                        codec, inputs.toArray(<span class="keyword">new</span> Path[inputs.size()]), </span><br><span class="line">                        <span class="keyword">true</span>, ioSortFactor, tmpDir, </span><br><span class="line">                        (RawComparator&lt;K&gt;) jobConf.getOutputKeyComparator(), </span><br><span class="line">                        reporter, spilledRecordsCounter, <span class="keyword">null</span>, </span><br><span class="line">                        mergedMapOutputsCounter, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">    Merger.writeFile(iter, writer, reporter, jobConf);</span><br><span class="line">    writer.close();</span><br><span class="line">    compressAwarePath = <span class="keyword">new</span> CompressAwarePath(outputPath,</span><br><span class="line">        writer.getRawLength(), writer.getCompressedLength());</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    localFS.delete(outputPath, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">throw</span> e;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  closeOnDiskFile(compressAwarePath);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>OnDiskMapOutput.merge</code>ä¹Ÿæ˜¯è°ƒç”¨<code>Merger.merge</code>å¯¹æ–‡ä»¶è¿›è¡Œå †æ’åºï¼Œç„¶åwriteåˆ°æœ¬åœ°ï¼Œæœ€åä¾ç„¶ä¼šè°ƒç”¨<code>closeOnDiskFile</code>æ£€æŸ¥mergeä¹‹åæ˜¯å¦ä¾ç„¶æ»¡è¶³disk mergeæ¡ä»¶ã€‚<br>_Fetcher_çº¿ç¨‹åˆ†æç»“æŸï¼Œä»£ç å›åˆ°<code>Shuffle.run</code>ä¸­ï¼Œæ­¤æ—¶copyé˜¶æ®µç»“æŸï¼Œæ‰§è¡Œ<code>copyPhase.complete()</code>,æ ‡è¯†_SORT_é˜¶æ®µï¼Œæ‰§è¡Œ<code>taskStatus.setPhase(TaskStatus.Phase.SORT)</code>,çœŸæ­£çš„sorté€»è¾‘æ˜¯åœ¨<code>merger.close()</code>ï¼Œä¹‹æ‰€ä»¥æŠŠæŠŠæ­¤é˜¶æ®µç§°ä¸º__SORTé˜¶æ®µ__ï¼Œå¯èƒ½æ˜¯å› ä¸ºåœ¨æ­¤é˜¶æ®µæ˜¯çº¯ç²¹çš„SORTå§ï¼Œè€Œä¸æºæ‚åˆ«çš„æ“ä½œï¼Œè¿™å°±å¯ä»¥è§£é‡Šä¸ºä»€ä¹ˆåœ¨ä¹‹å‰çš„_COPYé˜¶æ®µ_è™½ç„¶ä¹Ÿå­˜åœ¨SORTï¼Œä½†å¹¶æ²¡æœ‰å°†SORTé˜¶æ®µä»æ­¤å¤„å¼€å§‹ã€‚ä¸‹é¢è·Ÿä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RawKeyValueIterator <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> finalMerge(jobConf, rfs, memory, disk);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> RawKeyValueIterator <span class="title">finalMerge</span><span class="params">(JobConf job, FileSystem fs,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     List&lt;InMemoryMapOutput&lt;K,V&gt;&gt; inMemoryMapOutputs,</span></span></span><br><span class="line"><span class="params"><span class="function">                                     List&lt;CompressAwarePath&gt; onDiskMapOutputs</span></span></span><br><span class="line"><span class="params"><span class="function">                                     )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// æ¯ä¸ªreduceæœ€å¤§çš„bufferå ç™¾åˆ†æ¯”</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">float</span> maxRedPer =</span><br><span class="line">    job.getFloat(MRJobConfig.REDUCE_INPUT_BUFFER_PERCENT, <span class="number">0f</span>);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// reduceç”¨äºå­˜å‚¨bufferçš„æœ€å¤§å†…å­˜</span></span><br><span class="line">  <span class="keyword">int</span> maxInMemReduce = (<span class="keyword">int</span>)Math.min(</span><br><span class="line">      Runtime.getRuntime().maxMemory() * maxRedPer, Integer.MAX_VALUE);</span><br><span class="line">  <span class="comment">// merge config params</span></span><br><span class="line">  Class&lt;K&gt; keyClass = (Class&lt;K&gt;)job.getMapOutputKeyClass();</span><br><span class="line">  Class&lt;V&gt; valueClass = (Class&lt;V&gt;)job.getMapOutputValueClass();</span><br><span class="line">  <span class="keyword">boolean</span> keepInputs = job.getKeepFailedTaskFiles();</span><br><span class="line">  <span class="keyword">final</span> Path tmpDir = <span class="keyword">new</span> Path(reduceId.toString());</span><br><span class="line">  <span class="keyword">final</span> RawComparator&lt;K&gt; comparator =</span><br><span class="line">    (RawComparator&lt;K&gt;)job.getOutputKeyComparator();</span><br><span class="line">  <span class="comment">// segments required to vacate memory</span></span><br><span class="line">  List&lt;Segment&lt;K,V&gt;&gt; memDiskSegments = <span class="keyword">new</span> ArrayList&lt;Segment&lt;K,V&gt;&gt;();</span><br><span class="line">  <span class="keyword">long</span> inMemToDiskBytes = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// æ ‡è¯†æ˜¯å¦è¿›è¡ŒmergePhaseæ˜¯å¦å®Œæˆï¼Œæ˜¯å¦æ‰§è¡Œå†…éƒ¨mergeï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  <span class="keyword">boolean</span> mergePhaseFinished = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">if</span> (inMemoryMapOutputs.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    TaskID mapId = inMemoryMapOutputs.get(<span class="number">0</span>).getMapId().getTaskID();</span><br><span class="line">    inMemToDiskBytes = createInMemorySegments(inMemoryMapOutputs, </span><br><span class="line">                                              memDiskSegments,</span><br><span class="line">                                              maxInMemReduce);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numMemDiskSegments = memDiskSegments.size();</span><br><span class="line">    <span class="comment">// ä¸ç¬¦åˆæ¡ä»¶å°±èµ°åˆ°äº†ifåº•</span></span><br><span class="line">    <span class="comment">// å†…å­˜ä¸­æœ‰æ•°æ®ï¼Œç£ç›˜ä¸­çš„æ–‡ä»¶å°‘ï¼Œ</span></span><br><span class="line">    <span class="keyword">if</span> (numMemDiskSegments &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">          ioSortFactor &gt; onDiskMapOutputs.size()) &#123;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// If we reach here, it implies that we have less than io.sort.factor</span></span><br><span class="line">      <span class="comment">// disk segments and this will be incremented by 1 (result of the </span></span><br><span class="line">      <span class="comment">// memory segments merge). Since this total would still be </span></span><br><span class="line">      <span class="comment">// &lt;= io.sort.factor, we will not do any more intermediate merges,</span></span><br><span class="line">      <span class="comment">// the merge of all these disk segments would be directly fed to the</span></span><br><span class="line">      <span class="comment">// reduce method</span></span><br><span class="line">      </span><br><span class="line">      mergePhaseFinished = <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">// must spill to disk, but can&#x27;t retain in-mem for intermediate merge</span></span><br><span class="line">      <span class="keyword">final</span> Path outputPath = </span><br><span class="line">        mapOutputFile.getInputFileForWrite(mapId,</span><br><span class="line">                                           inMemToDiskBytes).suffix(</span><br><span class="line">                                               Task.MERGED_OUTPUT_PREFIX);</span><br><span class="line">      <span class="keyword">final</span> RawKeyValueIterator rIter = Merger.merge(job, fs,</span><br><span class="line">          keyClass, valueClass, memDiskSegments, numMemDiskSegments,</span><br><span class="line">          tmpDir, comparator, reporter, spilledRecordsCounter, <span class="keyword">null</span>, </span><br><span class="line">          mergePhase);</span><br><span class="line"></span><br><span class="line">      FSDataOutputStream out = CryptoUtils.wrapIfNecessary(job, fs.create(outputPath));</span><br><span class="line">      Writer&lt;K, V&gt; writer = <span class="keyword">new</span> Writer&lt;K, V&gt;(job, out, keyClass, valueClass,</span><br><span class="line">          codec, <span class="keyword">null</span>, <span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Merger.writeFile(rIter, writer, reporter, job);</span><br><span class="line">        writer.close();</span><br><span class="line">        onDiskMapOutputs.add(<span class="keyword">new</span> CompressAwarePath(outputPath,</span><br><span class="line">            writer.getRawLength(), writer.getCompressedLength()));</span><br><span class="line">        writer = <span class="keyword">null</span>;</span><br><span class="line">        <span class="comment">// add to list of final disk outputs.</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != outputPath) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            fs.delete(outputPath, <span class="keyword">true</span>);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">            <span class="comment">// NOTHING</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> != writer) &#123;</span><br><span class="line">          writer.close();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      LOG.info(<span class="string">&quot;Merged &quot;</span> + numMemDiskSegments + <span class="string">&quot; segments, &quot;</span> +</span><br><span class="line">               inMemToDiskBytes + <span class="string">&quot; bytes to disk to satisfy &quot;</span> +</span><br><span class="line">               <span class="string">&quot;reduce memory limit&quot;</span>);</span><br><span class="line">      inMemToDiskBytes = <span class="number">0</span>;</span><br><span class="line">      memDiskSegments.clear();</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (inMemToDiskBytes != <span class="number">0</span>) &#123;</span><br><span class="line">      LOG.info(<span class="string">&quot;Keeping &quot;</span> + numMemDiskSegments + <span class="string">&quot; segments, &quot;</span> +</span><br><span class="line">               inMemToDiskBytes + <span class="string">&quot; bytes in memory for &quot;</span> +</span><br><span class="line">               <span class="string">&quot;intermediate, on-disk merge&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// segments on disk</span></span><br><span class="line">  List&lt;Segment&lt;K,V&gt;&gt; diskSegments = <span class="keyword">new</span> ArrayList&lt;Segment&lt;K,V&gt;&gt;();</span><br><span class="line">  <span class="keyword">long</span> onDiskBytes = inMemToDiskBytes;</span><br><span class="line">  <span class="keyword">long</span> rawBytes = inMemToDiskBytes;</span><br><span class="line">  CompressAwarePath[] onDisk = onDiskMapOutputs.toArray(</span><br><span class="line">      <span class="keyword">new</span> CompressAwarePath[onDiskMapOutputs.size()]);</span><br><span class="line">  <span class="keyword">for</span> (CompressAwarePath file : onDisk) &#123;</span><br><span class="line">    <span class="keyword">long</span> fileLength = fs.getFileStatus(file).getLen();</span><br><span class="line">    onDiskBytes += fileLength;</span><br><span class="line">    rawBytes += (file.getRawDataLength() &gt; <span class="number">0</span>) ? file.getRawDataLength() : fileLength;</span><br><span class="line"></span><br><span class="line">    LOG.debug(<span class="string">&quot;Disk file: &quot;</span> + file + <span class="string">&quot; Length is &quot;</span> + fileLength);</span><br><span class="line">    diskSegments.add(<span class="keyword">new</span> Segment&lt;K, V&gt;(job, fs, file, codec, keepInputs,</span><br><span class="line">                                       (file.toString().endsWith(</span><br><span class="line">                                           Task.MERGED_OUTPUT_PREFIX) ?</span><br><span class="line">                                        <span class="keyword">null</span> : mergedMapOutputsCounter), file.getRawDataLength()</span><br><span class="line">                                      ));</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">&quot;Merging &quot;</span> + onDisk.length + <span class="string">&quot; files, &quot;</span> +</span><br><span class="line">           onDiskBytes + <span class="string">&quot; bytes from disk&quot;</span>);</span><br><span class="line">  <span class="comment">// å®‰è£…é•¿åº¦å¤§å°è¿›è¡Œæ’åºï¼Œæ–¹ä¾¿è¿›è¡Œæœ€å°å †æ’åºï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  Collections.sort(diskSegments, <span class="keyword">new</span> Comparator&lt;Segment&lt;K,V&gt;&gt;() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Segment&lt;K, V&gt; o1, Segment&lt;K, V&gt; o2)</span> </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (o1.getLength() == o2.getLength()) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> o1.getLength() &lt; o2.getLength() ? -<span class="number">1</span> : <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// build final list of segments from merged backed by disk + in-mem</span></span><br><span class="line">  List&lt;Segment&lt;K,V&gt;&gt; finalSegments = <span class="keyword">new</span> ArrayList&lt;Segment&lt;K,V&gt;&gt;();</span><br><span class="line">  <span class="keyword">long</span> inMemBytes = createInMemorySegments(inMemoryMapOutputs, </span><br><span class="line">                                           finalSegments, <span class="number">0</span>);</span><br><span class="line">  LOG.info(<span class="string">&quot;Merging &quot;</span> + finalSegments.size() + <span class="string">&quot; segments, &quot;</span> +</span><br><span class="line">           inMemBytes + <span class="string">&quot; bytes from memory into reduce&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (<span class="number">0</span> != onDiskBytes) &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> numInMemSegments = memDiskSegments.size();</span><br><span class="line">    diskSegments.addAll(<span class="number">0</span>, memDiskSegments);</span><br><span class="line">    memDiskSegments.clear();</span><br><span class="line">    <span class="comment">// Pass mergePhase only if there is a going to be intermediate</span></span><br><span class="line">    <span class="comment">// merges. See comment where mergePhaseFinished is being set</span></span><br><span class="line">    Progress thisPhase = (mergePhaseFinished) ? <span class="keyword">null</span> : mergePhase; </span><br><span class="line">    RawKeyValueIterator diskMerge = Merger.merge(</span><br><span class="line">        job, fs, keyClass, valueClass, codec, diskSegments,</span><br><span class="line">        ioSortFactor, numInMemSegments, tmpDir, comparator,</span><br><span class="line">        reporter, <span class="keyword">false</span>, spilledRecordsCounter, <span class="keyword">null</span>, thisPhase);</span><br><span class="line">    diskSegments.clear();</span><br><span class="line">    <span class="keyword">if</span> (<span class="number">0</span> == finalSegments.size()) &#123;</span><br><span class="line">      <span class="keyword">return</span> diskMerge;</span><br><span class="line">    &#125;</span><br><span class="line">    finalSegments.add(<span class="keyword">new</span> Segment&lt;K,V&gt;(</span><br><span class="line">          <span class="keyword">new</span> RawKVIteratorReader(diskMerge, onDiskBytes), <span class="keyword">true</span>, rawBytes));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> Merger.merge(job, fs, keyClass, valueClass,</span><br><span class="line">               finalSegments, finalSegments.size(), tmpDir,</span><br><span class="line">               comparator, reporter, spilledRecordsCounter, <span class="keyword">null</span>,</span><br><span class="line">               <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤é˜¶æ®µçš„ä¸»è¦é€»è¾‘åœ¨<code>finalMerge</code>ä¸­å®ç°ï¼Œè¿™é‡Œçš„ä»£ç é€»è¾‘æ˜¯å…ˆåˆ¤æ–­å†…å­˜ä¸­çš„æ•°æ®å’Œç£ç›˜ä¸­çš„æ–‡ä»¶ä¸ªæ•°çš„å¤šå°‘ï¼ˆioSortFactor &gt; onDiskMapOutputs.size()ï¼‰ï¼Œç¬¦åˆæ¡ä»¶åˆ™è¿›è¡Œå†…å­˜ä¸­çš„æ–‡ä»¶è¿›è¡Œmergeï¼Œè¾“å‡ºåˆ°diskä¸­ã€‚éšåå¯¹diskä¸­çš„æ–‡ä»¶è¿›è¡Œmergeï¼Œæ­¤å¤„å¤¹æ‚ä¸€è¡Œä»£ç <code>Collections.sort</code>ï¼Œå¯¹diskä¸­çš„æ–‡ä»¶è¿›è¡Œé•¿åº¦çš„æ’åºï¼Œå½¢æˆä¸€ä¸ªå°é¡¶å †è¿›è¡Œmergeï¼Œå°†å†…å­˜å’Œç£ç›˜æœ€ç»ˆçš„mergeæ–‡ä»¶æ”¾å…¥finalSegmentsä¸­è¿›è¡Œæœ€ç»ˆçš„mergeã€‚åˆ™shuffle.runç»“æŸã€‚å‡†å¤‡è¿›å…¥ä¸‹ä¸€é˜¶æ®µ_Reduceé˜¶æ®µ_ã€‚å›åˆ°ReduceTask.runä¸­ï¼Œæ ¹æ®apiæ‰§è¡Œ<code>runNewReducer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> &lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">runNewReducer</span><span class="params">(JobConf job,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">final</span> TaskUmbilicalProtocol umbilical,</span></span></span><br><span class="line"><span class="params"><span class="function">                   <span class="keyword">final</span> TaskReporter reporter,</span></span></span><br><span class="line"><span class="params"><span class="function">                   RawKeyValueIterator rIter,</span></span></span><br><span class="line"><span class="params"><span class="function">                   RawComparator&lt;INKEY&gt; comparator,</span></span></span><br><span class="line"><span class="params"><span class="function">                   Class&lt;INKEY&gt; keyClass,</span></span></span><br><span class="line"><span class="params"><span class="function">                   Class&lt;INVALUE&gt; valueClass</span></span></span><br><span class="line"><span class="params"><span class="function">                   )</span> <span class="keyword">throws</span> IOException,InterruptedException, </span></span><br><span class="line"><span class="function">                            ClassNotFoundException </span>&#123;</span><br><span class="line">  <span class="comment">// wrap value iterator to report progress.</span></span><br><span class="line">  <span class="keyword">final</span> RawKeyValueIterator rawIter = rIter;</span><br><span class="line">  rIter = <span class="keyword">new</span> RawKeyValueIterator() &#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">close</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      rawIter.close();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataInputBuffer <span class="title">getKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> rawIter.getKey();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Progress <span class="title">getProgress</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> rawIter.getProgress();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> DataInputBuffer <span class="title">getValue</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> rawIter.getValue();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">next</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">boolean</span> ret = rawIter.next();</span><br><span class="line">      reporter.setProgress(rawIter.getProgress().getProgress());</span><br><span class="line">      <span class="keyword">return</span> ret;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="comment">// make a task context so we can get the classes</span></span><br><span class="line">  org.apache.hadoop.mapreduce.TaskAttemptContext taskContext =</span><br><span class="line">    <span class="keyword">new</span> org.apache.hadoop.mapreduce.task.TaskAttemptContextImpl(job,</span><br><span class="line">        getTaskID(), reporter);</span><br><span class="line">  <span class="comment">// make a reducer</span></span><br><span class="line">  org.apache.hadoop.mapreduce.Reducer&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt; reducer =</span><br><span class="line">    (org.apache.hadoop.mapreduce.Reducer&lt;INKEY,INVALUE,OUTKEY,OUTVALUE&gt;)</span><br><span class="line">      ReflectionUtils.newInstance(taskContext.getReducerClass(), job);</span><br><span class="line">  org.apache.hadoop.mapreduce.RecordWriter&lt;OUTKEY,OUTVALUE&gt; trackedRW = </span><br><span class="line">    <span class="keyword">new</span> NewTrackingRecordWriter&lt;OUTKEY, OUTVALUE&gt;(<span class="keyword">this</span>, taskContext);</span><br><span class="line">  job.setBoolean(<span class="string">&quot;mapred.skip.on&quot;</span>, isSkipping());</span><br><span class="line">  job.setBoolean(JobContext.SKIP_RECORDS, isSkipping());</span><br><span class="line">  org.apache.hadoop.mapreduce.Reducer.Context </span><br><span class="line">       reducerContext = createReduceContext(reducer, job, getTaskID(),</span><br><span class="line">                                             rIter, reduceInputKeyCounter, </span><br><span class="line">                                             reduceInputValueCounter, </span><br><span class="line">                                             trackedRW,</span><br><span class="line">                                             committer,</span><br><span class="line">                                             reporter, comparator, keyClass,</span><br><span class="line">                                             valueClass);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    reducer.run(reducerContext);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    trackedRW.close(reducerContext);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨è¿™é‡Œè¦è¯´ä¸‹reduceä¸­çš„value-listæ˜¯æ€ä¹ˆå½¢æˆçš„ã€‚<br>å…¥å£åœ¨<code>rudecer.run(reducerContext)</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">(Context context)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  setup(context);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (context.nextKey()) &#123;</span><br><span class="line">      reduce(context.getCurrentKey(), context.getValues(), context);</span><br><span class="line">      <span class="comment">// If a back up store is used, reset it</span></span><br><span class="line">      Iterator&lt;VALUEIN&gt; iter = context.getValues().iterator();</span><br><span class="line">      <span class="keyword">if</span>(iter <span class="keyword">instanceof</span> ReduceContext.ValueIterator) &#123;</span><br><span class="line">        ((ReduceContext.ValueIterator&lt;VALUEIN&gt;)iter).resetBackupStore();        </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    cleanup(context);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç åœ¨whileå¾ªç¯å¤„è°ƒç”¨ç”¨æˆ·è‡ªå®šä¹‰çš„reduceï¼Œåˆ™value-liståº”è¯¥å†whileçš„åˆ¤æ–­è¯­å¥ä¸­å®ç°ï¼Œåˆ™æŸ¥çœ‹<code>context.nextKey</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// WrappedReducer.nextKey()</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> reduceContext.nextKey();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ReduceContextImpl.nextKey</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKey</span><span class="params">()</span> <span class="keyword">throws</span> IOException,InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (hasMore &amp;&amp; nextKeyIsSame) &#123;</span><br><span class="line">    nextKeyValue();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (hasMore) &#123;</span><br><span class="line">    <span class="keyword">if</span> (inputKeyCounter != <span class="keyword">null</span>) &#123;</span><br><span class="line">      inputKeyCounter.increment(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> nextKeyValue();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ReduceContextImpl.nextKeyValue</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">nextKeyValue</span><span class="params">()</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!hasMore) &#123;</span><br><span class="line">    key = <span class="keyword">null</span>;</span><br><span class="line">    value = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  firstValue = !nextKeyIsSame;</span><br><span class="line">  DataInputBuffer nextKey = input.getKey();</span><br><span class="line">  currentRawKey.set(nextKey.getData(), nextKey.getPosition(), </span><br><span class="line">                    nextKey.getLength() - nextKey.getPosition());</span><br><span class="line">  buffer.reset(currentRawKey.getBytes(), <span class="number">0</span>, currentRawKey.getLength());</span><br><span class="line">  key = keyDeserializer.deserialize(key);</span><br><span class="line">  DataInputBuffer nextVal = input.getValue();</span><br><span class="line">  buffer.reset(nextVal.getData(), nextVal.getPosition(), nextVal.getLength()</span><br><span class="line">      - nextVal.getPosition());</span><br><span class="line">  value = valueDeserializer.deserialize(value);</span><br><span class="line"></span><br><span class="line">  currentKeyLength = nextKey.getLength() - nextKey.getPosition();</span><br><span class="line">  currentValueLength = nextVal.getLength() - nextVal.getPosition();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isMarked) &#123;</span><br><span class="line">    backupStore.write(nextKey, nextVal);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  hasMore = input.next();</span><br><span class="line">  <span class="keyword">if</span> (hasMore) &#123;</span><br><span class="line">    nextKey = input.getKey();</span><br><span class="line">    nextKeyIsSame = comparator.compare(currentRawKey.getBytes(), <span class="number">0</span>, </span><br><span class="line">                                   currentRawKey.getLength(),</span><br><span class="line">                                   nextKey.getData(),</span><br><span class="line">                                   nextKey.getPosition(),</span><br><span class="line">                                   nextKey.getLength() - nextKey.getPosition()</span><br><span class="line">                                       ) == <span class="number">0</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    nextKeyIsSame = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  inputValueCounter.increment(<span class="number">1</span>);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸»è¦åŠŸèƒ½æ˜¯åœ¨<code>ReduceContextImpl.nextKey</code>ä»£ç ä¸­å®ç°çš„ã€‚å½“æœ‰ä¸‹ä¸€ä¸ªé”®å€¼å¯¹å¹¶ä¸”keyå€¼ä¸€æ ·æ—¶ï¼ˆ<code>hasMore &amp;&amp; nextKeyIsSame</code>ï¼‰ï¼Œæ‰§è¡Œ<code>nextKeyValue</code>ï¼Œå¦‚æœä¸‹ä¸€ä¸ªé”®å€¼å¯¹çš„keyå€¼ä¸ä¸€æ ·ï¼Œåˆ™å¢åŠ keyçš„ä¸ªæ•°ç„¶åæ‰§è¡Œ<code>nextKeyValue</code></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>Reduceé˜¶æ®µå¤§è‡´åˆ†ä¸ºcopyã€sortå’Œreduceé˜¶æ®µï¼Œè€Œ_copyé˜¶æ®µåˆåˆ†ä¸ºshuffleå’Œmergeé˜¶æ®µ_ï¼Œcopyé˜¶æ®µåŒ…å«ä¸€ä¸ªeventFetcheræ¥è·å–å·²å®Œæˆçš„mapåˆ—è¡¨ï¼Œç”±Fetcherçº¿ç¨‹å»copyæ•°æ®ï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ä¼šå¯åŠ¨ä¸¤ä¸ªmergeçº¿ç¨‹ï¼Œåˆ†åˆ«ä¸ºinMemoryMergerå’ŒonDiskMergerï¼Œåˆ†åˆ«å°†å†…å­˜ä¸­çš„æ•°æ®mergeåˆ°ç£ç›˜å’Œå°†ç£ç›˜ä¸­çš„æ•°æ®è¿›è¡Œmergeï¼Œï¼ˆå…¶ä¸­è¿˜åº”æ³¨æ„mergeçš„æ¡ä»¶å’Œæ•°æ®å¾€å†…å­˜ä¸­å†™å…¥æ—¶çš„æƒ…å†µï¼‰ã€‚å¸¦æ•°æ®copyå®Œæˆä¹‹åï¼Œcopyé˜¶æ®µå°±å®Œæˆäº†ï¼Œå¼€å§‹è¿›è¡Œsorté˜¶æ®µï¼Œsorté˜¶æ®µä¸»è¦æ˜¯æ‰§è¡ŒfinalMergeæ“ä½œï¼Œçº¯ç²¹çš„sorté˜¶æ®µï¼Œå®Œæˆä¹‹åå°±æ˜¯reduceé˜¶æ®µã€‚</p><!-- Merger.mergesegment  IFileä¸€ä¸ªsegmentå¯¹åº”ä¸€ä¸ªmapçš„partitionè¾“å‡ºreduceçš„keyè¾“å‡ºä¸æ˜¯æœ‰åºçš„ï¼Œä¸ºä»€ä¹ˆï¼Ÿ reduceçš„keyè¾“å…¥æ˜¯ä¸æ˜¯æœ‰åºçš„ï¼Ÿ å¦‚æœreduceçš„è¾“å…¥ä¸æ˜¯æœ‰åºçš„ï¼Œé‚£ç›¸åŒçš„keyåˆæ˜¯æ€ä¹ˆå½’åˆ°ä¸€èµ·çš„å•ä¸ªreduceå†…keyçš„è¾“å‡ºæ˜¯æœ‰åºçš„ï¼Œåªæ˜¯valueä¸æ˜¯æœ‰åºçš„ï¼ŒäºŒæ¬¡æ’åºæ˜¯å¯¹valueä¸­çš„æŸä¸ªå€¼è¿›è¡Œæ’åºã€‚ä¹‹æ‰€ä»¥reduceä¸­keyçš„è¾“å‡ºæ˜¯æœ‰åºçš„ï¼Œæ˜¯å› ä¸ºreduceçš„keyè¾“å…¥å°±æ˜¯æœ‰åºçš„ï¼Œæ˜¯ç»è¿‡Merger.mergeæ’åºä¹‹åçš„ï¼Œæ’åºä¹‹åæ‰å¯ä»¥å¯¹å…¶è¿›è¡Œåˆ†ç»„ã€‚-->]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> MapReduce </tag>
            
            <tag> Reduce </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>JavaåŒæ­¥é”è§£æ</title>
      <link href="/Java%E5%90%8C%E6%AD%A5%E9%94%81%E8%A7%A3%E6%9E%90.html"/>
      <url>/Java%E5%90%8C%E6%AD%A5%E9%94%81%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p><em>synchronizedæ˜¯ç”¨æ¥æ§åˆ¶çº¿ç¨‹åŒæ­¥çš„ï¼Œæ˜¯ä¸€ä¸ªåŒæ­¥é”</em>ï¼Œé˜²æ­¢åœ¨å¤šçº¿ç¨‹çš„ç¯å¢ƒä¸‹ï¼ŒæŸäº›èµ„æºè¢«å¤šçº¿ç¨‹åŒæ—¶æ“ä½œã€‚å°†ä¸èƒ½åŒæ—¶æ“ä½œçš„èµ„æºç”¨synchronizedé”ä½ï¼Œ<em>å½“æŸä¸ªçº¿ç¨‹è¦æ‰§è¡Œè¢«synchronizedå…³é”®å­—é”ä½çš„ä»£ç ç‰‡æ®µçš„æ—¶å€™ï¼Œå°†é¦–å…ˆæ£€æŸ¥é”æ˜¯å¦å¯ç”¨ï¼Œç„¶åè·å–é”ï¼Œæ‰§è¡Œä»£ç ï¼Œæœ€åé‡Šæ”¾é”ã€‚</em>synchronizedå¯ç”¨äºä¸€æ®µä»£ç ä¸Š(åŒæ­¥è¯­å¥å—)ï¼Œä¹Ÿå¯ç”¨äºæ–¹æ³•ä¸Š(åŒæ­¥æ–¹æ³•)ã€‚</p><p><strong>synchronizedé”ä½çš„æ˜¯å¯¹è±¡è€Œä¸æ˜¯æŸæ®µä»£ç </strong>ï¼Œæ‰€ä»¥è¦å°†ä¸èƒ½è¢«åŒæ—¶è®¿é—®çš„èµ„æºå°è£…åˆ°ä¸€ä¸ªå¯¹è±¡é‡Œï¼Œç„¶åå°†æ‰€æœ‰è¦è®¿é—®è¿™ä¸ªèµ„æºçš„æ–¹æ³•æ ‡è®°ä¸ºsynchronizedã€‚<br>å¦‚æœæŸä¸ªçº¿ç¨‹å¤„äºä¸€ä¸ªå¯¹aå¯¹è±¡ä¸­æ ‡è®°ä¸ºsynchronizedçš„æ–¹æ³•çš„è°ƒç”¨ä¸­ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªçº¿ç¨‹ä»è¯¥æ–¹æ³•è¿”å›ä¹‹å‰ï¼Œå…¶ä»–æ‰€æœ‰è¦è°ƒç”¨è¯¥å¯¹è±¡ä¸­ä»»ä½•æ ‡è®°ä¸ºsynchronizedæ–¹æ³•çš„çº¿ç¨‹éƒ½ä¼šè¢«é˜»å¡ã€‚æ‰€æœ‰å¯¹è±¡éƒ½è‡ªåŠ¨å«æœ‰å•ä¸€çš„é”ï¼Œå½“åœ¨å¯¹è±¡ä¸Šè°ƒç”¨èµ·ä»»æ„synchronizedæ–¹æ³•çš„æ—¶å€™ï¼Œæ­¤å¯¹è±¡å°±è¢«åŠ é”ï¼Œè¿™æ—¶è¯¥å¯¹è±¡ä¸Šå…¶ä»–synchronizedæ–¹æ³•åªæœ‰ç­‰åˆ°å‰ä¸€ä¸ªå¸¦æœ‰synchronizedçš„æ–¹æ³•è°ƒç”¨å®Œæ¯•å¹¶é‡Šæ”¾é”ä¹‹åæ‰èƒ½è¢«è°ƒç”¨ã€‚ä¾‹å¦‚ï¼š</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">     <span class="function"><span class="keyword">synchronized</span> <span class="title">f1</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">     <span class="function"><span class="keyword">synchronized</span> <span class="title">f2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">A a = <span class="keyword">new</span> A();</span><br></pre></td></tr></table></figure><p>å½“thread1è°ƒç”¨äº†a.f1ï¼Œå½“thread2è¦è°ƒç”¨a.f2æ—¶ï¼Œå°±ä¼šè¢«é˜»å¡ï¼Œå¾—ç­‰åˆ°thread1å®Œæˆå¯¹a.f1çš„è°ƒç”¨ä¹‹åæ‰èƒ½è°ƒç”¨a.f2ã€‚</p><blockquote><p>å†çœ‹å¦ä¸€ç§æƒ…å†µï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">A</span></span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="title">f1</span><span class="params">()</span></span>&#123;</span><br><span class="line">     f2();</span><br><span class="line">&#125;</span><br><span class="line">    <span class="function"><span class="keyword">synchronized</span> <span class="title">f2</span><span class="params">()</span></span>&#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">A a = <span class="keyword">new</span> A();</span><br></pre></td></tr></table></figure><p>å½“thread1è°ƒç”¨a.f1æ—¶ï¼Œå› ä¸ºf1åŠ äº†synchronizedï¼Œåˆ™thread1è·å¾—äº†å¯¹è±¡açš„é”ï¼Œè€Œè¿™æ—¶f1ä¸­åˆè°ƒç”¨äº†f2ï¼Œè€Œf2æ˜¯synchronizedï¼Œä¹Ÿéœ€è¦è·å¾—ä¸€ä¸ªé”ï¼Œå› ä¸ºæ­¤æ—¶çš„f1å’Œf2éƒ½æ˜¯Aä¸­çš„æ–¹æ³•ï¼Œæ‰€ä»¥å½“å‰çº¿ç¨‹thread1è¦è·å¾—çš„f2é”çš„å¯¹è±¡ä¹Ÿæ˜¯aã€‚ç”±äºå½“å‰çº¿ç¨‹thread1åœ¨æ‰§è¡Œf1æ—¶å·²ç»æŒæœ‰äº†aå¯¹è±¡çš„é”ï¼Œå› æ­¤è¿™ä¸ªæ—¶å€™è°ƒç”¨f2æ˜¯æ²¡æœ‰ä»»ä½•å½±å“çš„ï¼Œç›¸å½“äºæ–¹æ³•f2ä¸Šæ²¡æœ‰åŠ synchronizedã€‚</p><p>ä¸‹é¢çœ‹ä¸ªdemo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testå¼€å§‹..&quot;</span>);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;testç»“æŸ..&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Sync sync = <span class="keyword">new</span> Sync();</span><br><span class="line">        sync.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> MyThread();</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºæ˜¯ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>å¼€å§‹..</span><br><span class="line"><span class="built_in">test</span>å¼€å§‹..</span><br><span class="line"><span class="built_in">test</span>å¼€å§‹..</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..</span><br></pre></td></tr></table></figure><p>ç”±ç»“æœçœ‹å‡ºå¸¦synchronizedçš„testæ–¹æ³•å¹¶æ²¡æœ‰é”ä½(<em>å…¶å®ä¸åº”è¯¥è¯´æ²¡æœ‰é”ä½ï¼Œè€Œæ˜¯è¿™ä¸ªé”å¹¶æ²¡æœ‰è¾¾åˆ°é¢„è®¡çš„ç›®æ ‡</em>)ã€‚å›çœ‹ä»£ç ï¼Œå‘ç°mainçº¿ç¨‹èµ·äº†3çº¿çº¿ç¨‹ï¼Œ<em>åœ¨çº¿ç¨‹çš„runæ–¹æ³•ä¸­å¯¹testæ–¹æ³•è°ƒç”¨ã€‚åœ¨runä¸­newäº†ä¸€ä¸ªsyncå¯¹è±¡ï¼Œè¿™ä¸ªsyncå¯¹è±¡æ¯ä¸ªçº¿ç¨‹éƒ½ä¼šnewä¸€ä¸ªå…¨æ–°çš„ï¼Œæ‰€ä»¥å½“è°ƒç”¨sync.testæ—¶ï¼Œæ¯ä¸ªçº¿ç¨‹è°ƒç”¨çš„éƒ½ä¸æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„test</em>ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰èµ·åˆ°é¢„æœŸé”çš„ä½œç”¨ã€‚</p><p>ä¿®æ”¹ä¸Šè¿°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;testå¼€å§‹..&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;testç»“æŸ..&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Sync sync;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(Sync sync, String nameNo)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.sync = sync;</span><br><span class="line">        <span class="keyword">this</span>.setName(nameNo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        sync.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        Sync sync = <span class="keyword">new</span> Sync();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">        <span class="comment">// 3ä¸ªçº¿ç¨‹éƒ½æ˜¯åŒä¸€ä¸ªSyncå¯¹è±¡</span></span><br><span class="line">            Thread thread = <span class="keyword">new</span> MyThread(sync, <span class="string">&quot;name&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>å¼€å§‹..name0</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..name0</span><br><span class="line"><span class="built_in">test</span>å¼€å§‹..name2</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..name2</span><br><span class="line"><span class="built_in">test</span>å¼€å§‹..name1</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..name1</span><br></pre></td></tr></table></figure><p>ä¿®æ”¹ä¹‹åçš„ä»£ç ä¸­ï¼Œå¤šä¸ªçº¿ç¨‹æ“ä½œçš„æ˜¯åŒä¸€ä¸ªå¯¹è±¡çš„sync.testæ–¹æ³•ï¼Œæ‰€ä»¥å½“name0è°ƒç”¨sync.testæ—¶ï¼Œå…¶å®ƒçº¿ç¨‹è¢«é˜»å¡ã€‚</p><p>å¯è§åœ¨è¿™ç§æƒ…å†µä¸‹synchronizedé”ä½çš„æ˜¯å¯¹è±¡è€Œä¸æ˜¯testæ–¹æ³•ä¸­çš„ä»£ç ã€‚å½“synchronizedé”ä½ä¸€ä¸ªå¯¹è±¡åï¼Œåˆ«çš„çº¿ç¨‹å¦‚æœä¹Ÿæƒ³æ‹¿åˆ°è¿™ä¸ªå¯¹è±¡çš„é”ï¼Œå°±å¿…é¡»ç­‰å¾…è¿™ä¸ªçº¿ç¨‹æ‰§è¡Œå®Œå¹¶é‡Šæ”¾é”ï¼Œæ‰èƒ½å†æ¬¡ç»™å¯¹è±¡åŠ é”ï¼Œè¿™æ ·æ‰è¾¾åˆ°çº¿ç¨‹åŒæ­¥çš„ç›®çš„ã€‚<em>å³ä½¿ä¸åŒçš„ä»£ç æ®µï¼Œéƒ½è¦é”åŒä¸€ä¸ªå¯¹è±¡ï¼Œåœ¨è°ƒç”¨è¯¥å¯¹è±¡ä¸­è¿™ä¸¤ä¸ªä»£ç æ®µæ—¶ï¼Œè¿™ä¸¤ä¸ªä»£ç æ®µä¹Ÿä¸èƒ½åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸‹åŒæ—¶è¿è¡Œ</em>ã€‚</p><p><em>æ‰€ä»¥åœ¨ç”¨synchronizedå…³é”®å­—çš„æ—¶å€™ï¼Œèƒ½ç¼©å°ä»£ç æ®µçš„èŒƒå›´å°±å°½é‡ç¼©å°ï¼Œèƒ½åœ¨ä»£ç æ®µä¸ŠåŠ åŒæ­¥çš„å°±ä¸è¦åœ¨æ•´ä¸ªæ–¹æ³•ä¸ŠåŠ åŒæ­¥</em>ã€‚è¿™å«<strong>å‡å°é”çš„ç²’åº¦ï¼Œä½¿ä»£ç æ›´å¤§ç¨‹åº¦çš„å¹¶å‘</strong>ã€‚(å¦‚æœåœ¨functionä¸­åªæœ‰Aä»£ç éœ€è¦åŠ åŒæ­¥é”synchronizedï¼Œè€Œåœ¨Aä»£ç ä¹‹å‰ä¼šæœ‰ä¸€äº›é¢å¤–çš„æ“ä½œå¦‚å‡†å¤‡å·¥ä½œï¼Œè€Œè¿™æ®µå·¥ä½œåˆéœ€è¦ä¸€äº›æ—¶é—´ï¼Œé‚£ä¹ˆä½ å°†æ•´ä¸ªfunctioné”ä½ï¼Œé‚£å…¶ä»–çº¿ç¨‹ä¼šéƒ½é˜»å¡åœ¨functionæ–¹æ³•ä¸Šï¼Œè€Œä½ å¦‚æœåªå°†Aä»£ç é”ä½ï¼Œé‚£å…¶å®ƒçº¿ç¨‹å¯ä»¥å…ˆå°†Aä»£ç ä¹‹å‰çš„å·¥ä½œæ‰§è¡Œå®Œï¼Œé˜»å¡åœ¨Aä»£ç å¤„ï¼Œè¿™æ ·å‡å°‘äº†ç¨‹åºæ‰§è¡Œçš„æ—¶é—´ï¼Œ<em>æé«˜çš„ä»£ç çš„å¹¶å‘</em>ã€‚)</p><p>ä¸‹é¢çœ‹ä¸ªåŒæ­¥è¯­å¥å—çš„demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line"><span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">System.out.println(<span class="string">&quot;testå¼€å§‹..&quot;</span> + Thread.currentThread().getName());</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">System.out.println(<span class="string">&quot;testç»“æŸ..&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> Sync sync;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">(Sync sync, String nameNo)</span></span>&#123;</span><br><span class="line"><span class="keyword">this</span>.sync = sync;</span><br><span class="line">     <span class="keyword">this</span>.setName(nameNo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">sync.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">Sync sync = <span class="keyword">new</span> Sync();</span><br><span class="line"> <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">Thread thread = <span class="keyword">new</span> MyThread(sync, <span class="string">&quot;name&quot;</span> + i);</span><br><span class="line"> thread.start();</span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œä¸Šé¢çš„ä»£ç å‡ ä¹ä¸€æ ·ï¼Œåªæ˜¯å°†synchronizedä»æ–¹æ³•ä¸Šæ¢åˆ°äº†ä»£ç å—ä¸Šï¼Œsynchronized(this)é”ä½ä¹Ÿæ˜¯<em>å¯¹è±¡æœ¬èº«</em>ã€‚è¾“å‡ºç»“æœä¸ä¸Šé¢çš„ä¸€æ ·ã€‚</p><p>ä»¥ä¸ŠåŠ é”çš„æ–¹æ³•éƒ½æ˜¯å°†åŒæ­¥é”ä½œç”¨äºä¸€ä¸ªå®ä¾‹å¯¹è±¡ä¸Šï¼Œä»»ä½•æ—¶åˆ»éƒ½åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥<em>è¯¥å¯¹è±¡</em>çš„å®ä¾‹åŒæ­¥æ–¹æ³•æˆ–å®ä¾‹åŒæ­¥è¯­å¥å—ã€‚<em>å½“ä¸€ä¸ªçº¿ç¨‹è®¿é—®å®ä¾‹å¯¹è±¡çš„ä¸€ä¸ªå®ä¾‹åŒæ­¥æ–¹æ³•æˆ–å®ä¾‹åŒæ­¥è¯­å¥å—æ—¶ï¼Œå…¶å®ƒçº¿ç¨‹å¯¹è¯¥å®ä¾‹ä¸­çš„å…¶å®ƒæ‰€æœ‰å®ä¾‹åŒæ­¥æ–¹æ³•å’Œå®ä¾‹åŒæ­¥è¯­å¥å—çš„è®¿é—®éƒ½è¢«é˜»å¡</em>ã€‚ä½†æ˜¯å…¶å®ƒçº¿ç¨‹å¯ä»¥è®¿é—®è¯¥ç±»çš„<em>å…¶å®ƒå®ä¾‹å¯¹è±¡çš„å®ä¾‹åŒæ­¥æ–¹æ³•å’Œå®ä¾‹åŒæ­¥è¯­å¥å—</em>ã€‚</p><p>ä¸‹é¢å°±æ¥çœ‹ä¸€ä¸ªåœ¨<strong>ç±»ä¸­é”éæœ¬ç±»çš„å®ä¾‹å¯¹è±¡</strong>çš„demo</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calulation</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Calulation</span><span class="params">(<span class="keyword">long</span> count)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç±»ä¸­éæœ¬ç±»çš„å®ä¾‹å¯¹è±¡(ä¹Ÿå¯ä»¥ç†è§£æˆä¸€ä¸ªä¸“é—¨çš„é”å¯¹è±¡)</span></span><br><span class="line">    <span class="comment">// ä¹Ÿå¯ä»¥ä¸“é—¨å£°æ˜ä¸€ä¸ªé”å¯¹è±¡</span></span><br><span class="line">    <span class="keyword">private</span> Long count;   <span class="comment">// è¿™é‡Œæ˜¯Longè€Œä¸æ˜¯longï¼Œsynchronizedé”ä½çš„æ˜¯å¯¹è±¡ï¼Œä¸èƒ½ç”¨long int ã€‚ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> value)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.count) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;count å¼€å§‹ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name : &quot;</span>+ Thread.currentThread().getName());</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            <span class="keyword">this</span>.count += value;</span><br><span class="line">            System.out.println(<span class="string">&quot;count ç»“æŸ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name :&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sub</span><span class="params">(<span class="keyword">long</span> value)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.count)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;count å¼€å§‹ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name : &quot;</span>+ Thread.currentThread().getName());</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">this</span>.count -= value;</span><br><span class="line">            System.out.println(<span class="string">&quot;count ç»“æŸ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name :&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculationTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Calulation cal = <span class="keyword">new</span> Calulation(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)&#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;start...&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        cal.add(<span class="number">5</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.setName(<span class="string">&quot;add&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> finalI = i;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;start...&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        cal.sub(finalI);  <span class="comment">// è¿™é‡Œå¿…é¡»ä¼ è¿›å»ä¸€ä¸ªfianlç±»å‹çš„æ•°æ®</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.setName(<span class="string">&quot;sub&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add0start...</span><br><span class="line">count å¼€å§‹ : 0 name : add0</span><br><span class="line">add1start...</span><br><span class="line">sub0start...</span><br><span class="line">sub1start...</span><br><span class="line">count ç»“æŸ : 5 name :add0</span><br><span class="line">count å¼€å§‹ : 5 name : sub1</span><br><span class="line">count ç»“æŸ : 4 name :sub1</span><br><span class="line">count å¼€å§‹ : 4 name : sub0</span><br><span class="line">count ç»“æŸ : 4 name :sub0</span><br><span class="line">count å¼€å§‹ : 4 name : add1</span><br><span class="line">count ç»“æŸ : 9 name :add1</span><br></pre></td></tr></table></figure><p>Calulationä¸­æœ‰ä¸¤ä¸ªæ–¹æ³•addå’Œsubï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•éƒ½å¯¹countåŠ é”ï¼Œé‚£ä¹ˆå¦‚æœæŸä¸ªçº¿ç¨‹è°ƒç”¨éœ€è¦å¾—åˆ°countå®ä¾‹å¯¹è±¡é”çš„æŸä¸ªæ–¹æ³•æ—¶ï¼Œ<em>é‚£ä¹ˆå…¶å®ƒçº¿ç¨‹è°ƒç”¨éœ€è¦å¾—åˆ°è¯¥å¯¹è±¡é”çš„ä»»ä½•ä¸€ä¸ªæ–¹æ³•éƒ½å°†é˜»å¡</em>ã€‚æŸ¥çœ‹è¾“å‡ºï¼Œadd0çº¿ç¨‹startï¼Œè°ƒç”¨cal.addï¼Œaddä¸­æœ‰sleepï¼ˆæ¨¡æ‹Ÿä»£ç æ‰§è¡Œæ¶ˆè€—çš„æ—¶é—´ï¼‰ï¼Œsleepæ—¶ï¼Œadd1ã€sub0å’Œsub1éƒ½ç›¸ç»§startï¼Œä½†æ²¡æœ‰æ‹¿åˆ°countçš„é”ï¼Œéƒ½è¢«é˜»å¡ã€‚</p><blockquote><p>æ€è€ƒï¼šsynchronized(this)ä¸synchronized(å®ä¾‹å¯¹è±¡å±æ€§)çš„åŒºåˆ«ï¼Ÿï¼Ÿ</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Calulation</span></span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Calulation</span><span class="params">(<span class="keyword">long</span> count)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.count = count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">private</span> Long count;   <span class="comment">// è¿™é‡Œæ˜¯Longè€Œä¸æ˜¯longï¼Œsynchronizedé”ä½çš„æ˜¯å¯¹è±¡ï¼Œä¸èƒ½ç”¨long int ã€‚ã€‚</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">add</span><span class="params">(<span class="keyword">long</span> value)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// å¾—åˆ°å®ä¾‹å¯¹è±¡countçš„é”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>.count) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;count å¼€å§‹ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name : &quot;</span>+ Thread.currentThread().getName());</span><br><span class="line">            Thread.sleep(<span class="number">10000</span>);</span><br><span class="line">            <span class="keyword">this</span>.count += value;</span><br><span class="line">            System.out.println(<span class="string">&quot;count ç»“æŸ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name :&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sub</span><span class="params">(<span class="keyword">long</span> value)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">    <span class="comment">// å¾—åˆ°æœ¬ç±»å¯¹è±¡çš„é”</span></span><br><span class="line">        <span class="keyword">synchronized</span> (<span class="keyword">this</span>)&#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;count å¼€å§‹ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name : &quot;</span>+ Thread.currentThread().getName());</span><br><span class="line">            Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            <span class="keyword">this</span>.count -= value;</span><br><span class="line">            System.out.println(<span class="string">&quot;count ç»“æŸ : &quot;</span> + <span class="keyword">this</span>.count + <span class="string">&quot; name :&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CalculationTest</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Calulation cal = <span class="keyword">new</span> Calulation(<span class="number">0</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)&#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;start...&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        cal.add(<span class="number">5</span>);</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.setName(<span class="string">&quot;add&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">long</span> i=<span class="number">0</span>; i&lt;<span class="number">2</span>; i++)&#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="keyword">long</span> finalI = i;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    System.out.println(Thread.currentThread().getName() + <span class="string">&quot;start...&quot;</span>);</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        cal.sub(finalI);  <span class="comment">// è¿™é‡Œå¿…é¡»ä¼ è¿›å»ä¸€ä¸ªfianlç±»å‹çš„æ•°æ®</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            thread.setName(<span class="string">&quot;sub&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">add1start...</span><br><span class="line">add0start...</span><br><span class="line">count å¼€å§‹ : 0 name : add1</span><br><span class="line">sub0start...</span><br><span class="line">count å¼€å§‹ : 0 name : sub0</span><br><span class="line">sub1start...</span><br><span class="line">count ç»“æŸ : 0 name :sub0</span><br><span class="line">count å¼€å§‹ : 0 name : sub1</span><br><span class="line">count ç»“æŸ : -1 name :sub1</span><br><span class="line">count ç»“æŸ : 4 name :add1</span><br><span class="line">count å¼€å§‹ : 4 name : add0</span><br><span class="line">count ç»“æŸ : 9 name :add0</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°ä»£ç ä¸­addä¸­æ˜¯synchronized(this.count)ï¼Œé”ä½çš„æ˜¯countå¯¹è±¡ï¼Œè€Œsubä¸­æ˜¯synchronized(this)ï¼Œé”ä½çš„Calulationå¯¹è±¡calï¼Œåˆ™å½“add1.startæ—¶ï¼Œå¾—åˆ°äº†countçš„é”ï¼Œå°†synchronized(this.count)çš„ä»£ç æ®µé”ä½ï¼Œåˆ™å½“add0 startä¹‹åæ— æ³•å¾—åˆ°countçš„é”ï¼Œåˆ™add0é˜»å¡ã€‚<br>ç„¶è€Œsub0å¯åŠ¨ä¹‹åï¼Œè°ƒç”¨çš„æ˜¯cal.subæ–¹æ³•ï¼Œåœ¨æ­¤æ–¹æ³•ä¸­çš„åŒæ­¥ä»£ç å—ä¸­éœ€è¦çš„æ˜¯å¯¹è±¡calçš„é”ï¼Œè€Œä¸æ˜¯å¯¹è±¡countçš„é”ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰å°†sub0é˜»å¡ï¼Œä½†æ˜¯sub0å°†calé”ä½ï¼Œå¯¼è‡´sub1é˜»å¡ï¼ŒåŒæ ·å¯¹addä¹Ÿæ²¡æœ‰å½±å“ã€‚</p><p>ä»ä¸Šçš„å®éªŒå¯ä»¥å¾—å‡ºï¼Œ<em>ä¸€èˆ¬é”å®šä¸€ä¸ªå±æ€§è¿›è¡Œå®ä¾‹èŒƒå›´çš„åŒæ­¥ï¼Œä»»ä½•æ—¶åˆ»åªæœ‰ä¸€ä¸ªçº¿ç¨‹å¯ä»¥è¿›å…¥é”å®šè¯¥å±æ€§å®ä¾‹çš„ä»£ç å—ï¼Œå…¶ä»–çº¿ç¨‹è®¿é—®é”å®šåŒä¸€ä¸ªå±æ€§å®ä¾‹çš„ä»£ç å—å°†è¢«é˜»å¡ï¼ŒåŒæ—¶è¯¥å±æ€§å®ä¾‹ä¸­çš„å®ä¾‹åŒæ­¥æ–¹æ³•å’Œå®ä¾‹åŒæ­¥ä»£ç å—ä¹Ÿå°†ç»„å¡</em>ã€‚</p><p>ä¸Šè¿°å‡ ä¸ªä¾‹å­éƒ½æ˜¯å¯¹å®ä¾‹å¯¹è±¡åŠ é”ï¼Œä¸‹é¢å±•ç¤ºå‡ ä¸ªå¯¹<em>ç±»åŠ é”</em>çš„ä¾‹å­(<em>ä¹Ÿæ˜¯ä¸€ç§å…¨å±€é”</em>)ã€‚</p><p><em>å¯¹ç±»åŠ é”æ˜¯æŒ‡å°†åŒæ­¥ä½œç”¨äºä¸€ä¸ªç±»ä¸Šï¼Œåˆ™è¯¥ç±»æ‰€æœ‰çš„å®ä¾‹å¯¹è±¡ï¼Œä»»ä½•æ—¶åˆ»éƒ½åªæœ‰ä¸€ä¸ªçº¿ç¨‹è¿›å…¥æŸä¸ªå®ä¾‹çš„ç±»åŒæ­¥æ–¹æ³•æˆ–ç±»åŒæ­¥è¯­å¥å—</em>ã€‚å¸¸è§çš„ä¸¤ç§æ–¹æ³•æ˜¯ï¼š</p><ol><li>åœ¨<strong>é™æ€æ–¹æ³•</strong>ä¸ŠåŠ synchronizedå…³é”®å­—ï¼Œå£°æ˜è¿™ä¸ªé™æ€æ–¹æ³•æ˜¯åŒæ­¥çš„</li><li>åœ¨åŒæ­¥è¯­å¥å—ä¸Šæ·»åŠ synchronized(ClassName.class){}</li><li>åŒæ ·ä¹Ÿå¯ä»¥å¯¹æŸä¸ªå±æ€§è¿›è¡Œç±»èŒƒå›´çš„åŒæ­¥synchronized(fieldName.getClass())</li></ol><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Sync</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">test</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (Sync.class) &#123;</span><br><span class="line">            System.out.println(<span class="string">&quot;testå¼€å§‹..&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">            &#125;</span><br><span class="line">            System.out.println(<span class="string">&quot;testç»“æŸ..&quot;</span> + Thread.currentThread().getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">MyThread</span> <span class="keyword">extends</span> <span class="title">Thread</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyThread</span><span class="params">( String nameNo)</span></span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.setName(nameNo);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// æ¯ä¸ªçº¿ç¨‹éƒ½æ˜¯ä¸€ä¸ªæ–°çš„Syncå¯¹è±¡</span></span><br><span class="line">        Sync sync = <span class="keyword">new</span> Sync();</span><br><span class="line">        sync.test();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Main</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span><br><span class="line">            Thread thread = <span class="keyword">new</span> MyThread(<span class="string">&quot;name&quot;</span> + i);</span><br><span class="line">            thread.start();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¾“å‡ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">test</span>å¼€å§‹..name2</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..name2</span><br><span class="line"><span class="built_in">test</span>å¼€å§‹..name0</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..name0</span><br><span class="line"><span class="built_in">test</span>å¼€å§‹..name1</span><br><span class="line"><span class="built_in">test</span>ç»“æŸ..name1</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­è™½ç„¶åœ¨<em>æ¯ä¸ªçº¿ç¨‹ä¸­éƒ½newäº†ä¸€ä¸ªå…¨æ–°çš„Syncå¯¹è±¡</em>ï¼Œ<strong>ä½†æ˜¯testä¸­æ˜¯å¯¹Sync.classç±»åŠ é”ï¼Œæ‰€ä»¥ä¼šé˜»å¡å…¶å®ƒçº¿ç¨‹å¯¹è¯¥ç±»ä»»ä½•å®ä¾‹å¯¹è±¡åŒæ­¥æ–¹æ³•çš„è°ƒç”¨</strong>ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> synchronized </tag>
            
            <tag> åŒæ­¥é” </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaä¼˜å…ˆçº§é˜Ÿåˆ—è§£æ</title>
      <link href="/Java%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97%E8%A7%A3%E6%9E%90.html"/>
      <url>/Java%E4%BC%98%E5%85%88%E7%BA%A7%E9%98%9F%E5%88%97%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨çœ‹ä»£ç è¿‡ç¨‹ä¸­ï¼Œä¼˜å…ˆçº§é˜Ÿåˆ—(PriorityQueue)å‡ºç°çš„æ¬¡æ•°å¾ˆå¤šï¼ŒPriorityQueueæ˜¯åŸºäºä¼˜å…ˆå †(å®Œå…¨äºŒå‰å †)çš„ä¸€ä¸ªæ— ç•Œé˜Ÿåˆ—ã€‚</p><p>ä¼˜å…ˆçº§é˜Ÿåˆ—æ˜¯ä¸åŒäºå…ˆè¿›å…ˆå‡ºé˜Ÿåˆ—çš„å¦ä¸€ç§é˜Ÿåˆ—ã€‚æ¯æ¬¡ä»é˜Ÿåˆ—ä¸­å–å‡ºçš„æ˜¯å…·æœ‰æœ€é«˜ä¼˜å…ˆæƒçš„å…ƒç´ ã€‚æ¯æ¬¡éƒ½å–æœ€é«˜ä¼˜å…ˆæƒçš„åŸç†æ˜¯é€šè¿‡åœ¨å†…éƒ¨ç»´æŠ¤ä¸€ä¸ªå †æ¥å®ç°çš„ã€‚</p><p>ä¸‹é¢å…ˆæä¸ªå°demoæ¥æ„Ÿå—ä¸‹PriorityQueueï¼Œæ¥ä¸ªå¸¸è§çš„é¢è¯•é¢˜ï¼Œ<em>æ±‚topN</em>é—®é¢˜ã€‚</p><span id="more"></span><h2 id="æ±‚topN"><a href="#æ±‚topN" class="headerlink" title="æ±‚topN"></a>æ±‚topN</h2><p>ä¸€ç»„æ•°16,7,3,20,17,8,2,1,30ï¼Œæ±‚top6ã€‚<br>ä½¿ç”¨PriorityQueueä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestPriorityQueue</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span></span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] arr = &#123;<span class="number">16</span>,<span class="number">7</span>,<span class="number">3</span>,<span class="number">20</span>,<span class="number">17</span>,<span class="number">8</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">30</span>&#125;;</span><br><span class="line">        Object[] result = topN(arr, <span class="number">6</span>);</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=result.length-<span class="number">1</span>; i&gt;=<span class="number">0</span>; i--) &#123;</span><br><span class="line">            System.out.println(result[i].toString());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Object[] topN(<span class="keyword">int</span>[] arr,<span class="keyword">int</span> n)&#123;</span><br><span class="line">        PriorityQueue&lt;Integer&gt; priorityQueue = <span class="keyword">new</span> PriorityQueue&lt;Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;arr.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (priorityQueue.size() &lt; n)&#123;</span><br><span class="line">                priorityQueue.add(arr[i]);</span><br><span class="line">            &#125;<span class="keyword">else</span> <span class="keyword">if</span> (arr[i] &gt; priorityQueue.peek())&#123;</span><br><span class="line">                priorityQueue.poll();</span><br><span class="line">                priorityQueue.add(arr[i]);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Object[] result = priorityQueue.toArray();</span><br><span class="line">        Arrays.sort(result);</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="PriorityQueueå¿…å¤‡çŸ¥è¯†"><a href="#PriorityQueueå¿…å¤‡çŸ¥è¯†" class="headerlink" title="PriorityQueueå¿…å¤‡çŸ¥è¯†"></a>PriorityQueueå¿…å¤‡çŸ¥è¯†</h2><ul><li>ä¼˜å…ˆé˜Ÿåˆ—ä¸­çš„å…ƒç´ å¯ä»¥é»˜è®¤è‡ªç„¶æ’åºæˆ–è€…é€šè¿‡æä¾›çš„Comparatoråœ¨é˜Ÿåˆ—å®ä¾‹åŒ–çš„æ—¶æ’åºã€‚</li><li>ä¼˜å…ˆé˜Ÿåˆ—çš„å¤§å°æ˜¯ä¸å—é™åˆ¶çš„ï¼Œä½†åœ¨åˆ›å»ºæ—¶å¯ä»¥æŒ‡å®šåˆå§‹å¤§å°ã€‚å½“æˆ‘ä»¬å‘ä¼˜å…ˆé˜Ÿåˆ—å¢åŠ å…ƒç´ çš„æ—¶å€™ï¼Œé˜Ÿåˆ—å¤§å°ä¼šè‡ªåŠ¨å¢åŠ ã€‚</li><li>ä¼˜å…ˆé˜Ÿåˆ—ä¸å…è®¸ç©ºå€¼ï¼Œè€Œä¸”ä¸æ”¯æŒnon-comparableçš„å¯¹è±¡</li><li>ä¸æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚å¦‚æœå¤šä¸ªçº¿ç¨‹ä¸­çš„ä»»æ„çº¿ç¨‹ä»ç»“æ„ä¸Šä¿®æ”¹äº†queueï¼Œåˆ™è¿™äº›çº¿ç¨‹ä¸åº”åŒæ—¶è®¿é—®PriorityQueue å®ä¾‹ï¼Œè¿™æ—¶è¯·ä½¿ç”¨<em>çº¿ç¨‹å®‰å…¨çš„PriorityBlockingQueueç±»</em>ã€‚</li><li>add(offer)å’Œpollæ–¹æ³•æä¾›O(log(n))æ—¶é—´ï¼›ä¸ºremove(Object)å’Œcontains(Object)æ–¹æ³•æä¾›çº¿æ€§æ—¶é—´ï¼›ä¸ºæ£€ç´¢æ–¹æ³•(peekã€elementå’Œsize)æä¾›å›ºå®šæ—¶é—´ã€‚</li><li>æ–¹æ³•iterator()ä¸­æä¾›çš„è¿­ä»£å™¨å¹¶ä¸ä¿è¯ä»¥æœ‰åºçš„æ–¹å¼éå†ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­çš„å…ƒç´ ã€‚å¦‚æœéœ€è¦æŒ‰é¡ºåºéå†ï¼Œè¯·è€ƒè™‘ä½¿ç”¨ Arrays.sort(pq.toArray())ã€‚</li></ul><h2 id="PriorityQueueä»£ç å®ç°"><a href="#PriorityQueueä»£ç å®ç°" class="headerlink" title="PriorityQueueä»£ç å®ç°"></a>PriorityQueueä»£ç å®ç°</h2><p>ä¸‹é¢ä»£ç å±‚æ¬¡è§£è¯»ä¸‹PriorityQueueã€‚</p><p>é¦–å…ˆæ¥çœ‹ä¸‹å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// PriorityQueueé»˜è®¤å¤§å°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DEFAULT_INITIAL_CAPACITY = <span class="number">11</span>;</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Priority queue represented as a balanced binary heap: the two</span></span><br><span class="line"><span class="comment"> * children of queue[n] are queue[2*n+1] and queue[2*(n+1)].  The</span></span><br><span class="line"><span class="comment"> * priority queue is ordered by comparator, or by the elements&#x27;</span></span><br><span class="line"><span class="comment"> * natural ordering, if comparator is null: For each node n in the</span></span><br><span class="line"><span class="comment"> * heap and each descendant d of n, n &lt;= d.  The element with the</span></span><br><span class="line"><span class="comment"> * lowest value is in queue[0], assuming the queue is nonempty.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="comment">// æ•°ç»„æ¥å­˜æ”¾å…ƒç´  </span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> Object[] queue;</span><br><span class="line"><span class="comment">// PriorityQueueä¸­å…ƒç´ çš„ä¸ªæ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">int</span> size = <span class="number">0</span>;</span><br><span class="line"><span class="comment">// åˆå§‹åŒ–PriorityQueueæ—¶ä¼ å…¥æ¯”è¾ƒå™¨çš„æ¥æ”¶è€…</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> Comparator&lt;? <span class="keyword">super</span> E&gt; comparator;</span><br><span class="line"><span class="comment">// PriorityQueueè¢«æ“ä½œçš„æ¬¡æ•°</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">transient</span> <span class="keyword">int</span> modCount = <span class="number">0</span>;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨PriorityQueueçš„æ„é€ å‡½æ•°è¿›è¡Œåˆå§‹åŒ–ï¼Œè°ƒç”¨æ„é€ å‡½æ•°å¯ä»¥ä¸ä¼ ä»»ä½•å‚æ•°ï¼Œæ­¤æ—¶ç”¨é»˜è®¤æ•°ç»„å¤§å°å’Œé»˜è®¤æ’åºæ–¹æ³•åˆå§‹åŒ–PriorityQueueï¼Œä¹Ÿå¯ä»¥ä¼ å…¥åˆå§‹åŒ–çš„å¤§å°æˆ–è€…è‡ªå®šä¹‰çš„æ¯”è¾ƒå™¨ã€‚</p><h3 id="add-å…¥é˜Ÿåˆ—"><a href="#add-å…¥é˜Ÿåˆ—" class="headerlink" title="add å…¥é˜Ÿåˆ—"></a>add å…¥é˜Ÿåˆ—</h3><p>åˆå§‹åŒ–ä¹‹åè°ƒç”¨addå°†å…ƒç´ æ”¾å…¥queueä¸­ï¼Œaddåˆè°ƒç”¨offerï¼Œåœ¨offerä¸­è°ƒç”¨siftUpå¯¹å…ƒç´ è¿›è¡Œè°ƒæ•´ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> offer(e);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">offer</span><span class="params">(E e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (e == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException();</span><br><span class="line">    <span class="comment">// æ¯æ¬¡æ“ä½œmodCountéƒ½ä¼šé€’å¢</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// iæ˜¯å³å°†æ’å…¥å…ƒç´ çš„ç´¢å¼•ï¼Œsizeæ˜¯queueä¸­å…ƒç´ çš„ä¸ªæ•°</span></span><br><span class="line">    <span class="keyword">int</span> i = size;</span><br><span class="line">    <span class="comment">// è¾¾åˆ°å®¹é‡ä¸Šé™ï¼Œåˆ™è°ƒç”¨growæ‰©å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (i &gt;= queue.length)</span><br><span class="line">        grow(i + <span class="number">1</span>);</span><br><span class="line">    <span class="comment">// queueä¸­å…ƒç´ çš„ä¸ªæ•°æ›´æ–°    </span></span><br><span class="line">    size = i + <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (i == <span class="number">0</span>)</span><br><span class="line">        queue[<span class="number">0</span>] = e;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        <span class="comment">// queueä¸­å·²å­˜åœ¨å…ƒç´ ï¼Œåˆ™è°ƒç”¨siftUpæ‰¾åˆ°å…ƒç´ eåœ¨queueä¸­çš„ä½ç½®</span></span><br><span class="line">        siftUp(i, e);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftUp</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line"><span class="comment">// æ ¹æ®æ¯”è¾ƒç­–ç•¥é€‰æ‹©ä¸åŒçš„æ–¹æ³•</span></span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="keyword">null</span>)</span><br><span class="line">        siftUpUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftUpComparable(k, x);</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure><p>PriorityQueueä¸­çš„å…ƒç´ é»˜è®¤æ˜¯æŒ‰ç…§å°é¡¶å †å­˜æ”¾çš„ï¼Œä¸€ä¸ªæ–°çš„å…ƒç´ æ”¾å…¥queueä¸­ï¼Œéœ€è¦è°ƒæ•´æ•´ä¸ªå †çš„é¡ºåºï¼ŒPriorityQueueè°ƒç”¨siftUpæ ¹æ®åˆå§‹åŒ–æ—¶æ˜¯å¦å¯¹æ¯”è¾ƒå™¨è¿›è¡Œåˆå§‹åŒ–æ¥é€‰æ‹©ä¸åŒçš„è°ƒæ•´ç­–ç•¥ï¼Œé»˜è®¤æƒ…å†µä¸‹å®‰è£…å¯¹è±¡æœ¬èº«çš„æ’åºè§„åˆ™è¿›è¡Œæ¯”è¾ƒ(<em>è¿™å°±è¦æ±‚æ”¾å…¥PriorityQueueä¸­çš„å…ƒç´ å¿…é¡»æ˜¯å¯æ¯”è¾ƒçš„</em>)ã€‚</p><p>é»˜è®¤æ¯”è¾ƒè§„åˆ™æ˜¯siftUpComparableï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°kæ˜¯queueä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹ä¸€ä¸ªç´¢å¼•</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftUpComparable</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line"><span class="comment">// å…ƒç´ xå®ç°äº†Comparableæ¥å£</span></span><br><span class="line">    Comparable&lt;? <span class="keyword">super</span> E&gt; key = (Comparable&lt;? <span class="keyword">super</span> E&gt;) x;</span><br><span class="line">    <span class="comment">// å¾ªç¯ä½¿keyå’Œkçš„çˆ¶èŠ‚ç‚¹è¿›è¡Œæ¯”è¾ƒï¼Œåˆ™kåªè¦å¤§äº0å°±å­˜åœ¨çˆ¶èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">    <span class="comment">// å°äºç­‰äº0åˆ™ä¸å­˜åœ¨çˆ¶èŠ‚ç‚¹ï¼Œå¾ªç¯ç»“æŸã€‚</span></span><br><span class="line">    <span class="keyword">while</span> (k &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// rootçš„ç´¢å¼•æ˜¯0ï¼Œæ±‚å‡ºkçš„çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•</span></span><br><span class="line">        <span class="keyword">int</span> parent = (k - <span class="number">1</span>) &gt;&gt;&gt; <span class="number">1</span>;</span><br><span class="line">        Object e = queue[parent];</span><br><span class="line">        <span class="comment">// ç”±äºqueueæ˜¯å°é¡¶å †ï¼Œåˆ™å¾ªç¯è·³å‡ºçš„æ¡ä»¶æ˜¯keyæ¯”çˆ¶èŠ‚ç‚¹å¤§</span></span><br><span class="line">        <span class="keyword">if</span> (key.compareTo((E) e) &gt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// keyæ¯”çˆ¶èŠ‚ç‚¹å°åˆ™å’Œçˆ¶èŠ‚ç‚¹äº¤æ¢ä½ç½®ï¼Œç»§ç»­æŸ¥æ‰¾</span></span><br><span class="line">        queue[k] = e;</span><br><span class="line">        k = parent;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†keyæ”¾å…¥åˆé€‚çš„ä½ç½®</span></span><br><span class="line">    queue[k] = key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ”¾å…¥æ–°çš„å…ƒç´ å¯¹å°é¡¶å †çš„è°ƒæ•´æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯å‡è®¾å°†å…ƒç´ eæ”¾å…¥queueä¸­æœ€åä¸€ä¸ªå…ƒç´ çš„ä¸‹ä¸€ä¸ªä½ç½®iï¼Œæ ¹æ®iæ‰¾åˆ°å…¶çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•jï¼Œæ¯”è¾ƒeå’Œqueue[j]çš„å¤§å°ï¼Œå¦‚æœeå°ï¼Œåˆ™å°†queue[j]ä»jæ¢åˆ°iå¤„ï¼Œåˆ™jçš„ä½ç½®å°±ç»™eç©ºäº†å‡ºæ¥ï¼Œç„¶åç»§ç»­å¾ªç¯æ‰¾åˆ°jçš„çˆ¶èŠ‚ç‚¹çš„ç´¢å¼•ï¼Œå†æ¬¡è¿›è¡Œæ¯”è¾ƒï¼Œ<em>ç›´åˆ°jæ²¡æœ‰çˆ¶èŠ‚ç‚¹ï¼Œæˆ–è€…eå°äºçˆ¶èŠ‚ç‚¹çš„å€¼</em>ã€‚</p><p><code>siftUpUsingComparator</code>å’Œ<code>siftUpComparable</code>é€»è¾‘ä¸€æ ·ï¼Œåªæ˜¯ä¸¤ä¸ªå…ƒç´ è¿›è¡Œæ¯”è¾ƒæ—¶è°ƒç”¨çš„æ–¹æ³•ä¸ä¸€æ ·ï¼ŒsiftUpUsingComparatorè°ƒç”¨çš„æ˜¯å¯¹åº”æ¯”è¾ƒå™¨<code>comparator.compare(x, (E) e)</code>çš„æ–¹æ³•ã€‚</p><h3 id="grow-æ‰©å®¹"><a href="#grow-æ‰©å®¹" class="headerlink" title="grow æ‰©å®¹"></a>grow æ‰©å®¹</h3><p>addå…ƒç´ åˆ°é˜Ÿåˆ—å½“å®¹é‡æ»¡æ—¶ï¼Œè°ƒç”¨growè¿›è¡Œæ‰©å®¹ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">grow</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">int</span> oldCapacity = queue.length;</span><br><span class="line">    <span class="comment">// Double size if small; else grow by 50%</span></span><br><span class="line">    <span class="comment">// oldCapacityå°äº64åˆ™å®¹é‡ç¿»å€ï¼›å¦åˆ™å¢é•¿50%ï¼›</span></span><br><span class="line">    <span class="comment">// oldCapacityæ˜¯æ”¾å…¥æ–°å…ƒç´ ä¹‹å‰çš„å¤§å°ï¼Œç¿»å€çš„è¯ä¹Ÿåº”è¯¥åŠ ä¸Šæ–°å…ƒç´ ç¿»å€çš„ä¸ªæ•°2</span></span><br><span class="line">    <span class="keyword">int</span> newCapacity = oldCapacity + ((oldCapacity &lt; <span class="number">64</span>) ?</span><br><span class="line">                                     (oldCapacity + <span class="number">2</span>) :</span><br><span class="line">                                     (oldCapacity &gt;&gt; <span class="number">1</span>));</span><br><span class="line">    <span class="comment">// æ‰©å®¹ä¹‹åçš„å®¹é‡å¤§äºMAX_ARRAY_SIZEï¼Œåˆ™å°†å®¹é‡è®¾ä¸ºMAX_ARRAY_SIZE</span></span><br><span class="line">    <span class="comment">// é¿å…æ— é™åˆ¶çš„æ‰©å±•</span></span><br><span class="line">    <span class="keyword">if</span> (newCapacity - MAX_ARRAY_SIZE &gt; <span class="number">0</span>)</span><br><span class="line">        newCapacity = hugeCapacity(minCapacity);</span><br><span class="line">    queue = Arrays.copyOf(queue, newCapacity);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hugeCapacity</span><span class="params">(<span class="keyword">int</span> minCapacity)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (minCapacity &lt; <span class="number">0</span>) <span class="comment">// overflow</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> OutOfMemoryError();</span><br><span class="line">    <span class="keyword">return</span> (minCapacity &gt; MAX_ARRAY_SIZE) ?</span><br><span class="line">        Integer.MAX_VALUE :</span><br><span class="line">        MAX_ARRAY_SIZE;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="poll-å‡ºé˜Ÿåˆ—"><a href="#poll-å‡ºé˜Ÿåˆ—" class="headerlink" title="poll å‡ºé˜Ÿåˆ—"></a>poll å‡ºé˜Ÿåˆ—</h3><p>å‡ºé˜Ÿåˆ—æ—¶è°ƒç”¨pollï¼Œå¯¹queueä¸­çš„sizeè¿›è¡Œæ›´æ–°ï¼Œå°†å †é¡¶å…ƒç´ ç§»é™¤queueï¼Œè°ƒç”¨siftDownè¿›è¡Œè°ƒæ•´ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">poll</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// queueä¸­å…ƒç´ ä¸ªæ•°å‡ä¸€ï¼Œä¹Ÿå°±æ˜¯æœ€åä¸€ä¸ªå…ƒç´ çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> s = --size;</span><br><span class="line">    <span class="comment">// æ“ä½œæ¬¡æ•°é€’å¢</span></span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="comment">// å¾—åˆ°å †é¡¶å…ƒç´ </span></span><br><span class="line">    E result = (E) queue[<span class="number">0</span>];</span><br><span class="line">    <span class="comment">// å¾—åˆ°queueä¸­çš„æœ€åä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    E x = (E) queue[s];</span><br><span class="line">    queue[s] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// queueä¸­çš„å…ƒç´ ä¸ªæ•°ä¸ä¸º0ï¼Œåˆ™è°ƒæ•´å †</span></span><br><span class="line">    <span class="keyword">if</span> (s != <span class="number">0</span>)</span><br><span class="line">        siftDown(<span class="number">0</span>, x);</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDown</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (comparator != <span class="keyword">null</span>)</span><br><span class="line">        siftDownUsingComparator(k, x);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">        siftDownComparable(k, x);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>siftDownçš„è°ƒæ•´ç­–ç•¥å’ŒsiftUpä¸€æ ·ä¹Ÿæ˜¯ä¸¤ç§ï¼Œå…·ä½“çš„è°ƒæ•´æ€è·¯æ˜¯æ‹¿æœ€åä¸€ä¸ªå…ƒç´ ä»ä¸Šå‘ä¸‹è¿›è¡Œè°ƒæ•´ã€‚é»˜è®¤è°ƒæ•´ç­–ç•¥çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å‚æ•°kå§‹ç»ˆæ˜¯0ï¼Œä»ä¸Šå‘ä¸‹è°ƒæ•´</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">siftDownComparable</span><span class="params">(<span class="keyword">int</span> k, E x)</span> </span>&#123;</span><br><span class="line">    Comparable&lt;? <span class="keyword">super</span> E&gt; key = (Comparable&lt;? <span class="keyword">super</span> E&gt;)x;</span><br><span class="line">    <span class="comment">// åªéœ€å¾ªç¯èŠ‚ç‚¹ä¸ªæ•°çš„ä¸€åŠ</span></span><br><span class="line">    <span class="keyword">int</span> half = size &gt;&gt;&gt; <span class="number">1</span>;        <span class="comment">// loop while a non-leaf</span></span><br><span class="line">    <span class="keyword">while</span> (k &lt; half) &#123;</span><br><span class="line">    <span class="comment">// rootä¸º0ï¼Œkä¹˜ä»¥2åŠ 1æ‰¾åˆ°kçš„å·¦å­©å­</span></span><br><span class="line">        <span class="keyword">int</span> child = (k &lt;&lt; <span class="number">1</span>) + <span class="number">1</span>; <span class="comment">// assume left child is least</span></span><br><span class="line">        Object c = queue[child];</span><br><span class="line">        <span class="comment">// å³å­æ•°çš„ç´¢å¼•</span></span><br><span class="line">        <span class="keyword">int</span> right = child + <span class="number">1</span>;</span><br><span class="line">        <span class="comment">// åœ¨å·¦å³å­æ ‘ä¸­æ‰¾åˆ°è¾ƒå°çš„å­æ ‘</span></span><br><span class="line">        <span class="comment">// è¦æ³¨æ„rightè¦å°äºsizeï¼Œé¿å…è¶Šç•Œ</span></span><br><span class="line">        <span class="keyword">if</span> (right &lt; size &amp;&amp;</span><br><span class="line">            ((Comparable&lt;? <span class="keyword">super</span> E&gt;) c).compareTo((E) queue[right]) &gt; <span class="number">0</span>)</span><br><span class="line">            <span class="comment">// åˆå§‹å‡è®¾queue[child]è¾ƒå°</span></span><br><span class="line">            <span class="comment">// å°†è¾ƒå°å€¼çš„ç´¢å¼•èµ‹å€¼ç»™childï¼Œå¹¶æŠŠå…ƒç´ å€¼èµ‹å€¼ç»™c</span></span><br><span class="line">            c = queue[child = right];</span><br><span class="line">        <span class="comment">// å°†æœ€åä¸€ä¸ªå…ƒç´ å’Œè¾ƒå°çš„å­æ ‘cè¿›è¡Œæ¯”è¾ƒï¼Œæœ€åä¸€ä¸ªå…ƒç´ å°åˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line">        <span class="keyword">if</span> (key.compareTo((E) c) &lt;= <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="comment">// å¦‚æœæœ€åä¸€ä¸ªå…ƒç´  æ¯” è¾ƒå°çš„å­æ ‘cå¤§ï¼Œ</span></span><br><span class="line">        <span class="comment">// åˆ™ç”¨è¾ƒå°çš„å­æ ‘å‘ä¸Šå»å¡«ç§»å‡ºçš„çˆ¶èŠ‚ç‚¹    </span></span><br><span class="line">        queue[k] = c;</span><br><span class="line">        k = child;</span><br><span class="line">    &#125;</span><br><span class="line">    queue[k] = key;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>siftDownæ—¶çš„è°ƒæ•´æ€è·¯æœ‰ç‚¹ç»•ï¼Œå¤§è‡´æ€è·¯æ˜¯å †é¡¶å…ƒç´ ç§»é™¤ä¹‹åï¼Œå°†æœ€åä¸€ä¸ªå…ƒç´ ä½œä¸ºæŒ‡æ ‡å¯¹å †å†…çš„å…ƒç´ è¿›è¡Œè°ƒæ•´ï¼Œè°ƒæ•´æ—¶<em>å…ˆæ‰¾åˆ°å·¦å³å­æ ‘çš„è¾ƒå°å€¼</em>ï¼Œç„¶åè·Ÿæœ€åä¸€ä¸ªå…ƒç´ è¿›è¡Œæ¯”è¾ƒï¼Œå­æ ‘çš„è¾ƒå°å€¼æ¯”æœ€åä¸€ä¸ªå…ƒç´ å°åˆ™å°†è¾ƒå°å€¼å‘ä¸Šç§»åŠ¨ï¼Œå¦åˆ™å°†æœ€åä¸€ä¸ªå…ƒç´ å¡«è¡¥ç©ºç¼ºçš„ä½ç½®ã€‚</p><h3 id="remove"><a href="#remove" class="headerlink" title="remove"></a>remove</h3><p>ç§»é™¤queueä¸­çš„æŒ‡å®šå…ƒç´ ï¼Œå®ç°ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">remove</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line"><span class="comment">// è°ƒç”¨indexOfæ‰¾åˆ°oåœ¨queueä¸­çš„ç´¢å¼•</span></span><br><span class="line">    <span class="keyword">int</span> i = indexOf(o);</span><br><span class="line">    <span class="keyword">if</span> (i == -<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// ç§»é™¤ç¬¬iä¸ªå…ƒç´ </span></span><br><span class="line">        removeAt(i);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç§»é™¤å…ƒç´ æ—¶å…ˆåœ¨queueä¸­æ‰¾åˆ°(<em>é¡ºåºéå†å…ƒç´ ï¼Œå› ä¸ºqueueä¸­çš„å…ƒç´ å¹¶æ²¡æœ‰é¡ºåºï¼Œåˆ™åªèƒ½é¡ºåºéå†</em>)oçš„ç´¢å¼•ï¼Œç„¶åè°ƒç”¨removeAtç§»é™¤ç¬¬iä¸ªå…ƒç´ ã€‚</p><p>indexOfçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">indexOf</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (o != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// forå¾ªç¯éå†ï¼Œqueueä¸­çš„å…ƒç´ æ— åº</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++)</span><br><span class="line">            <span class="keyword">if</span> (o.equals(queue[i]))</span><br><span class="line">                <span class="keyword">return</span> i;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨removeAtç§»é™¤ç¬¬iä¸ªå…ƒç´ ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">removeAt</span><span class="params">(<span class="keyword">int</span> i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">assert</span> i &gt;= <span class="number">0</span> &amp;&amp; i &lt; size;</span><br><span class="line">    modCount++;</span><br><span class="line">    <span class="keyword">int</span> s = --size;</span><br><span class="line">    <span class="comment">// å¦‚æœç§»é™¤çš„å…ƒç´ æ˜¯æœ€åä¸€ä¸ªå…ƒç´ åˆ™ç›´æ¥å¯¹queue[i]èµ‹å€¼ä¸ºnull</span></span><br><span class="line">    <span class="keyword">if</span> (s == i) <span class="comment">// removed last element</span></span><br><span class="line">        queue[i] = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// æœ€åä¸€ä¸ªå…ƒç´ èµ‹å€¼ç»™moved</span></span><br><span class="line">        E moved = (E) queue[s];</span><br><span class="line">        <span class="comment">// å°†æœ€åä¸€ä¸ªå…ƒç´ ç½®nullï¼Œä¹Ÿå°±æ˜¯æ¸…é™¤ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">        queue[s] = <span class="keyword">null</span>;</span><br><span class="line">        siftDown(i, moved);</span><br><span class="line">        <span class="comment">// å¦‚æœmovedæ¯”içš„å­æ ‘è¦å°ï¼Œå°†movedæ”¾åœ¨äº†iå¤„ï¼Œ</span></span><br><span class="line">        <span class="comment">// åˆ™å­˜åœ¨movedå¯èƒ½æ¯”å°äºiçš„å…ƒç´ è¿˜è¦å°ï¼Œç»§ç»­è¿›è¡Œå‘ä¸Šè°ƒæ•´</span></span><br><span class="line">        <span class="keyword">if</span> (queue[i] == moved) &#123;</span><br><span class="line">            siftUp(i, moved);</span><br><span class="line">            <span class="keyword">if</span> (queue[i] != moved)</span><br><span class="line">                <span class="keyword">return</span> moved;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="çŸ¥è¯†æ‰©å±•"><a href="#çŸ¥è¯†æ‰©å±•" class="headerlink" title="çŸ¥è¯†æ‰©å±•"></a>çŸ¥è¯†æ‰©å±•</h2><h3 id="Comparableå’ŒComparatorçš„åŒºåˆ«"><a href="#Comparableå’ŒComparatorçš„åŒºåˆ«" class="headerlink" title="Comparableå’ŒComparatorçš„åŒºåˆ«"></a>Comparableå’ŒComparatorçš„åŒºåˆ«</h3><ul><li>Comparableå’ŒComparatoréƒ½æ˜¯ç”¨æ¥æ’åºçš„ã€‚</li><li>Comparableåªèƒ½æä¾›ä¸€ç§æ¯”è¾ƒæ–¹æ³•ï¼ŒComparatorå¯ä»¥å£°æ˜ä¸åŒçš„æ¯”è¾ƒå™¨å®ç°å¤šç§æ¯”è¾ƒæ–¹æ³•ã€‚</li><li>ä½¿ç”¨Comparableæ—¶ï¼Œè‡ªå®šä¹‰çš„ç±»å¿…é¡»å®ç°è¯¥æ¥å£ï¼Œè€ŒComparatoråˆ™ä¸ç”¨è®©è‡ªå®šä¹‰çš„ç±»å®ç°Comparatoræ¥å£ï¼Œä¸ç”¨å¯¹è‡ªå®šä¹‰çš„ç±»è¿›è¡Œä»»ä½•ä¿®æ”¹ã€‚</li><li>Comparableæ¥å£åœ¨java.langåŒ…ä¸­ï¼Œè€ŒComparatoræ¥å£åœ¨java.utilåŒ…ä¸­ã€‚</li><li>ä½¿ç”¨Comparableæ—¶ï¼Œä¸ç”¨åœ¨å®¢æˆ·ç«¯è¿›è¡Œä¿®æ”¹ï¼ŒArrays.sort()æˆ–è€…Collection.sort()è‡ªåŠ¨è°ƒç”¨Comparable.compareToæ–¹æ³•ã€‚è€ŒComparatoråˆ™éœ€è¦ä¿®æ”¹ï¼Œæä¾›Comparatorç±»ï¼Œè°ƒç”¨Comparator.compare()æ–¹æ³•</li></ul><blockquote><p>Comparable</p></blockquote><p>å…³äºè‡ªå®šä¹‰çš„ç±»ï¼Œå¦‚æœæƒ³ä½¿ç”¨Arraysæˆ–è€…Collectionsçš„æ’åºæ–¹æ³•åˆ™è‡ªå®šä¹‰çš„ç±»å¯ä»¥<em>å®ç°Comparableæ¥å£ï¼Œé‡å†™compareTo(T obj)æ–¹æ³•</em>ï¼Œè¯¥æ–¹æ³•çš„è¿”å›å€¼å¯ä»¥ä¸ºæ­£æ•°(å¤§äº)ã€é›¶(ç­‰äº)æˆ–è€…è´Ÿæ•°(å°äº)ã€‚</p><p>demoå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> <span class="keyword">implements</span> <span class="title">Comparable</span>&lt;<span class="title">Employee</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> salary;</span><br><span class="line">    ... <span class="comment">// getter setter method</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(<span class="keyword">int</span> id, String name, <span class="keyword">int</span> age, <span class="keyword">int</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compareTo</span><span class="params">(Employee emp)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//let&#x27;s sort the employee based on id in ascending order</span></span><br><span class="line">        <span class="comment">//returns a negative integer, zero, or a positive integer as this employee id</span></span><br><span class="line">        <span class="comment">//is less than, equal to, or greater than the specified object.</span></span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">this</span>.id - emp.id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//this is required to print the user friendly information about the Employee</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[id=&quot;</span> + <span class="keyword">this</span>.id + <span class="string">&quot;, name=&quot;</span> + <span class="keyword">this</span>.name + <span class="string">&quot;, age=&quot;</span> + <span class="keyword">this</span>.age + <span class="string">&quot;, salary=&quot;</span> +</span><br><span class="line">                <span class="keyword">this</span>.salary + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// main method</span></span><br><span class="line"><span class="comment">//sorting object array</span></span><br><span class="line">Employee[] empArr = <span class="keyword">new</span> Employee[<span class="number">4</span>];</span><br><span class="line">empArr[<span class="number">0</span>] = <span class="keyword">new</span> Employee(<span class="number">10</span>, <span class="string">&quot;Mikey&quot;</span>, <span class="number">25</span>, <span class="number">10000</span>);</span><br><span class="line">empArr[<span class="number">1</span>] = <span class="keyword">new</span> Employee(<span class="number">20</span>, <span class="string">&quot;Arun&quot;</span>, <span class="number">29</span>, <span class="number">20000</span>);</span><br><span class="line">empArr[<span class="number">2</span>] = <span class="keyword">new</span> Employee(<span class="number">5</span>, <span class="string">&quot;Lisa&quot;</span>, <span class="number">35</span>, <span class="number">5000</span>);</span><br><span class="line">empArr[<span class="number">3</span>] = <span class="keyword">new</span> Employee(<span class="number">1</span>, <span class="string">&quot;Pankaj&quot;</span>, <span class="number">32</span>, <span class="number">50000</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//sorting employees array using Comparable interface implementation</span></span><br><span class="line">Arrays.sort(empArr);</span><br><span class="line">System.out.println(<span class="string">&quot;Default Sorting of Employees list:\n&quot;</span>+Arrays.toString(empArr));</span><br></pre></td></tr></table></figure><p>æ’åºçš„ç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Default Sorting of Employees list:</span><br><span class="line">[[id=1, name=Pankaj, age=32, salary=50000], [id=5, name=Lisa, age=35, salary=5000], [id=10, name=Mikey, age=25, salary=10000], [id=20, name=Arun, age=29, salary=20000]]</span><br></pre></td></tr></table></figure><p>ä½¿ç”¨Comparableæ¥å£å¯ä»¥å®ç°è‡ªå®šä¹‰ç±»çš„æ’åºï¼Œ<em>ä½†æ˜¯å¦‚æœæ’åºæ—¶å¯èƒ½ä¸åŒçš„éœ€æ±‚éœ€è¦æ ¹æ®è‡ªå®šä¹‰ç±»ä¸­çš„ä¸åŒå±æ€§è¿›è¡Œæ’åºï¼Œä»¥ä¸Šé¢çš„Employeesä¸ºä¾‹ï¼Œæœ‰äººæƒ³æ ¹æ®salaryè¿›è¡Œæ’åºï¼Œæœ‰äººæƒ³æ ¹æ®ageæ’åºï¼Œæ­¤æ—¶Comparableä¸èƒ½å®ç°ï¼Œå› ä¸ºComparable.compareTo(Object o)ä¸èƒ½é€‰æ‹©è‡ªå®šä¹‰ç±»çš„å±æ€§</em>ã€‚è¿™é‡Œå°±ç”¨åˆ°äº†Comparatoræ¥å£ã€‚</p><blockquote><p>Comparator</p></blockquote><p>ä½¿ç”¨Comparatoræ¥å£æ—¶éœ€è¦é‡å†™compare(Object o1, Object o2)æ–¹æ³•ï¼Œæ–¹æ³•ä¼ å…¥ä¸¤ä¸ªéœ€è¦æ¯”è¾ƒçš„å¯¹è±¡ï¼Œè¿”å›å€¼å¯ä»¥ä¸ºæ­£æ•°(o1å¤§äºo2)ã€é›¶(ç­‰äº)æˆ–è€…è´Ÿæ•°(å°äº)ã€‚</p><p>ä¸‹é¢å°±æ¥çœ‹ä¸‹Employeeç±»ä¸­ä¸åŒComparatorçš„å®ç°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Comparator;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Employee</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> id;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> age;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> salary;</span><br><span class="line">    ... <span class="comment">// getter setter methods</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Employee</span><span class="params">(<span class="keyword">int</span> id, String name, <span class="keyword">int</span> age, <span class="keyword">int</span> salary)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.id = id;</span><br><span class="line">        <span class="keyword">this</span>.name = name;</span><br><span class="line">        <span class="keyword">this</span>.age = age;</span><br><span class="line">        <span class="keyword">this</span>.salary = salary;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="comment">//this is required to print the user friendly information about the Employee</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;[id=&quot;</span> + <span class="keyword">this</span>.id + <span class="string">&quot;, name=&quot;</span> + <span class="keyword">this</span>.name + <span class="string">&quot;, age=&quot;</span> + <span class="keyword">this</span>.age + <span class="string">&quot;, salary=&quot;</span> +</span><br><span class="line">                <span class="keyword">this</span>.salary + <span class="string">&quot;]&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>mainç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.Arrays;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">JavaObjectSorting</span> </span>&#123;</span><br><span class="line"><span class="comment">// åœ¨å®¢æˆ·ç«¯ä¿®æ”¹</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Comparator to sort employees list or array in order of Salary</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// salaryæ¯”è¾ƒå™¨</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Comparator&lt;Employee&gt; SalaryComparator = <span class="keyword">new</span> Comparator&lt;Employee&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Employee e1, Employee e2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> (<span class="keyword">int</span>) (e1.getSalary() - e2.getSalary());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Comparator to sort employees list or array in order of Age</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Comparator&lt;Employee&gt; AgeComparator = <span class="keyword">new</span> Comparator&lt;Employee&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Employee e1, Employee e2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> e1.getAge() - e2.getAge();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Comparator to sort employees list or array in order of Name</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Comparator&lt;Employee&gt; NameComparator = <span class="keyword">new</span> Comparator&lt;Employee&gt;() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Employee e1, Employee e2)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">return</span> e1.getName().compareTo(e2.getName());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//sorting custom object array</span></span><br><span class="line">        Employee[] empArr = <span class="keyword">new</span> Employee[<span class="number">4</span>];</span><br><span class="line">        empArr[<span class="number">0</span>] = <span class="keyword">new</span> Employee(<span class="number">10</span>, <span class="string">&quot;Mikey&quot;</span>, <span class="number">25</span>, <span class="number">10000</span>);</span><br><span class="line">        empArr[<span class="number">1</span>] = <span class="keyword">new</span> Employee(<span class="number">20</span>, <span class="string">&quot;Arun&quot;</span>, <span class="number">29</span>, <span class="number">20000</span>);</span><br><span class="line">        empArr[<span class="number">2</span>] = <span class="keyword">new</span> Employee(<span class="number">5</span>, <span class="string">&quot;Lisa&quot;</span>, <span class="number">35</span>, <span class="number">5000</span>);</span><br><span class="line">        empArr[<span class="number">3</span>] = <span class="keyword">new</span> Employee(<span class="number">1</span>, <span class="string">&quot;Pankaj&quot;</span>, <span class="number">32</span>, <span class="number">50000</span>);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//sort employees array using Comparator by Salary</span></span><br><span class="line">        <span class="comment">// è°ƒç”¨sortæ–¹æ³•æ—¶ï¼Œä¼ å…¥æ¯”è¾ƒå™¨</span></span><br><span class="line">        Arrays.sort(empArr, JavaObjectSorting.SalaryComparator);</span><br><span class="line">        System.out.println(<span class="string">&quot;Employees list sorted by Salary:\n&quot;</span>+Arrays.toString(empArr));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//sort employees array using Comparator by Age</span></span><br><span class="line">        Arrays.sort(empArr, JavaObjectSorting.AgeComparator);</span><br><span class="line">        System.out.println(<span class="string">&quot;Employees list sorted by Age:\n&quot;</span>+Arrays.toString(empArr));</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//sort employees array using Comparator by Name</span></span><br><span class="line">        Arrays.sort(empArr, JavaObjectSorting.NameComparator);</span><br><span class="line">        System.out.println(<span class="string">&quot;Employees list sorted by Name:\n&quot;</span>+Arrays.toString(empArr));</span><br><span class="line">        </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Java-transientå…³é”®å­—"><a href="#Java-transientå…³é”®å­—" class="headerlink" title="Java transientå…³é”®å­—"></a>Java transientå…³é”®å­—</h3><p>æˆ‘ä»¬éƒ½çŸ¥é“ä¸€ä¸ªå¯¹è±¡åªè¦å®ç°äº†Serilizableæ¥å£ï¼Œè¿™ä¸ªå¯¹è±¡å°±å¯ä»¥è¢«åºåˆ—åŒ–ï¼Œç„¶è€Œåœ¨å®é™…å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬å¸¸å¸¸ä¼šé‡åˆ°è¿™æ ·çš„é—®é¢˜ï¼Œ<em>è¿™ä¸ªç±»çš„æœ‰äº›å±æ€§éœ€è¦åºåˆ—åŒ–ï¼Œè€Œå…¶ä»–å±æ€§ä¸éœ€è¦è¢«åºåˆ—åŒ–</em>ï¼Œæ‰“ä¸ªæ¯”æ–¹ï¼Œå¦‚æœä¸€ä¸ªç”¨æˆ·æœ‰ä¸€äº›æ•æ„Ÿä¿¡æ¯ï¼ˆå¦‚å¯†ç ï¼Œé“¶è¡Œå¡å·ç­‰ï¼‰ï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œ<em>ä¸å¸Œæœ›åœ¨ç½‘ç»œæ“ä½œï¼ˆä¸»è¦æ¶‰åŠåˆ°åºåˆ—åŒ–æ“ä½œï¼Œæœ¬åœ°åºåˆ—åŒ–ç¼“å­˜ä¹Ÿé€‚ç”¨ï¼‰ä¸­è¢«ä¼ è¾“</em>ï¼Œè¿™äº›ä¿¡æ¯å¯¹åº”çš„å˜é‡å°±å¯ä»¥åŠ ä¸Štransientå…³é”®å­—ã€‚æ¢å¥è¯è¯´ï¼Œ<em>è¿™ä¸ªå­—æ®µçš„ç”Ÿå‘½å‘¨æœŸä»…å­˜äºè°ƒç”¨è€…çš„å†…å­˜ä¸­è€Œä¸ä¼šå†™åˆ°ç£ç›˜é‡ŒæŒä¹…åŒ–</em>ã€‚</p><p>å½“å¯¹è±¡è¢«åºåˆ—åŒ–æ—¶ï¼ˆå†™å…¥å­—èŠ‚åºåˆ—åˆ°ç›®æ ‡æ–‡ä»¶ï¼‰æ—¶ï¼Œ<em>transienté˜»æ­¢å®ä¾‹ä¸­é‚£äº›ç”¨æ­¤å…³é”®å­—å£°æ˜çš„å˜é‡æŒä¹…åŒ–</em>ï¼›å½“å¯¹è±¡è¢«ååºåˆ—åŒ–æ—¶ï¼ˆä»æºæ–‡ä»¶è¯»å–å­—èŠ‚åºåˆ—è¿›è¡Œé‡æ„ï¼‰ï¼Œè¿™æ ·çš„å®ä¾‹å˜é‡å€¼ä¸ä¼šè¢«æŒä¹…åŒ–å’Œæ¢å¤ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> PriorityQueue </tag>
            
            <tag> topN </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹åŠ¨æ€è§„åˆ’</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8B%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8B%E5%8A%A8%E6%80%81%E8%A7%84%E5%88%92.html</url>
      
        <content type="html"><![CDATA[<p>åŠ¨æ€è§„åˆ’çš„åŸºæœ¬æ€æƒ³ä¸åˆ†æ²»æ³•ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†<em>å¾…æ±‚è§£çš„é—®é¢˜åˆ†è§£ä¸ºè‹¥å¹²ä¸ªå­é—®é¢˜(é˜¶æ®µ)<em>ã€‚æŒ‰é¡ºåºæ±‚è§£å­é˜¶æ®µï¼Œ</em>å‰ä¸€å­é—®é¢˜çš„è§£ï¼Œä¸ºåä¸€å­é—®é¢˜çš„æ±‚è§£æä¾›äº†æœ‰ç”¨çš„ä¿¡æ¯</em>ã€‚åœ¨<strong>æ±‚è§£ä»»ä¸€å­é—®é¢˜æ—¶ï¼Œåˆ—å‡ºå„ç§å¯èƒ½çš„å±€éƒ¨è§£ï¼Œé€šè¿‡å†³ç­–ä¿ç•™é‚£äº›æœ‰å¯èƒ½è¾¾åˆ°æœ€ä¼˜çš„å±€éƒ¨è§£ï¼Œä¸¢å¼ƒå…¶ä»–å±€éƒ¨æœ€ä¼˜è§£</strong>ã€‚ä¾æ¬¡è§£å†³å„å­é—®é¢˜ï¼Œæœ€åä¸€ä¸ªå­é—®é¢˜å°±æ˜¯åˆå§‹é—®é¢˜çš„è§£ã€‚</p><p>åŠ¨æ€è§„åˆ’æ˜¯é€šè¿‡<em>æ‹†åˆ†é—®é¢˜</em>ï¼Œå®šä¹‰<em>é—®é¢˜çŠ¶æ€å’ŒçŠ¶æ€ä¹‹é—´çš„å…³ç³»</em>ï¼Œä½¿å¾—é—®é¢˜èƒ½å¤Ÿä»¥<em>é€’æ¨</em>çš„æ–¹å¼å»è§£å†³ã€‚åˆ™<em>åŠ¨æ€è§„åˆ’çš„æœ¬è´¨</em>æ˜¯<strong>çŠ¶æ€çš„å®šä¹‰</strong>å’Œ<strong>çŠ¶æ€è½¬ç§»æ–¹ç¨‹</strong></p><p>åŠ¨æ€è§„åˆ’é€šè¿‡æ‹†åˆ†é—®é¢˜ï¼Œå°†åŸå§‹é—®é¢˜æ‹†åˆ†ä¸ºå­é—®é¢˜ï¼Œè€Œå„å­é—®é¢˜ä¹‹é—´çš„å…³ç³»æ˜¯<em>åä¸€å­é—®é¢˜çš„è§£å¾€å¾€ç”±å‰ä¸€å­é—®é¢˜çš„è§£æ±‚å‡º</em>ï¼Œåˆ™**å­é—®é¢˜ä¹‹é—´æ˜¯é‡å çš„(åˆ™ä¸æ˜¯ç›¸äº’ç‹¬ç«‹çš„)**ï¼Œä¸ºå‡å°‘é‡å¤è®¡ç®—ï¼Œå¯¹æ¯ä¸€ä¸ªå­é—®é¢˜åªè§£ä¸€æ¬¡ï¼Œå°†å…¶ä¸åŒé˜¶æ®µçš„ä¸åŒçŠ¶æ€ä¿å­˜åœ¨ä¸€ä¸ªäºŒç»´æ•°ç»„ä¸­ã€‚</p><blockquote><p>åŠ¨æ€è§„åˆ’ä¸åˆ†æ²»æ³•<em>æœ€å¤§çš„å·®åˆ«</em>æ˜¯:é€‚åˆäºç”¨åŠ¨æ€è§„åˆ’æ³•æ±‚è§£çš„é—®é¢˜ï¼Œç»åˆ†è§£åå¾—åˆ°çš„å­é—®é¢˜å¾€å¾€<em>ä¸æ˜¯äº’ç›¸ç‹¬ç«‹</em>çš„ï¼ˆå³ä¸‹ä¸€ä¸ªå­é˜¶æ®µçš„æ±‚è§£æ˜¯å»ºç«‹åœ¨ä¸Šä¸€ä¸ªå­é˜¶æ®µçš„è§£çš„åŸºç¡€ä¸Šï¼Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ±‚è§£ï¼‰ã€‚</p></blockquote><blockquote><p>åŠ¨æ€è§„åˆ’ä¸è´ªå¿ƒæ³•çš„åŒºåˆ«</p></blockquote><p>åŠ¨æ€è§„åˆ’å…¶å®æ˜¯è´ªå¿ƒæ³•çš„ä¸€èˆ¬æƒ…å†µï¼Œè€Œ<em>è´ªå¿ƒæ³•æ˜¯åŠ¨æ€è§„åˆ’çš„ç‰¹æ®Šæƒ…å†µ</em>ï¼Œä¸ºä»€ä¹ˆè¿™ä¹ˆè¯´å‘¢ï¼Œä¸‹é¢å°±æ¥è§£é‡Šä¸‹ï¼Œ</p><span id="more"></span><p>ç”¨åŠ¨æ€è§„åˆ’æ¥æ±‚è§£æ—¶æ€»æ˜¯å°†é—®é¢˜æ‹†åˆ†ï¼Œæ‰¾åˆ°é€’æ¨å…¬å¼ï¼Œåˆ™å°†å„ä¸ªçŠ¶æ€å®šä¹‰ä¸ºdp[i],ç»“æœä¸ºresultï¼ŒåŠ¨æ€è§„åˆ’æ±‚è§£çš„æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/blogimgs/dp/greedy.png"></p><p>ä½†æ˜¯åœ¨å¤§å¤šæ•°åŠ¨æ€è§„åˆ’æ±‚è§£çš„è¿‡ç¨‹ä¸­åä¸€å­é—®é¢˜ä¸€èˆ¬æ˜¯ä»å‰é¢å¤šä¸ªå­é—®é¢˜ä¸­å¾—å‡ºçš„(ä¹Ÿå¯èƒ½æ˜¯å‰é¢æ‰€æœ‰çš„å­é—®é¢˜)ï¼Œåˆ™æµç¨‹å›¾å¦‚ä¸‹ï¼š</p><p><img src="/blogimgs/dp/dp.png"></p><p>è€Œè´ªå¿ƒç®—æ³•å¾€å¾€åªæ˜¯æœ‰å‰ä¸€å­é—®é¢˜è€Œå¾—å‡ºåä¸€å­é—®é¢˜çš„ï¼Œåˆ™ä»ä¸Šé¢çš„ä¸¤ä¸ªå›¾ä¸­å¯ä»¥å¾—å‡ºåŠ¨æ€è§„åˆ’ä¸è´ªå¿ƒç®—æ³•çš„å…³ç³»ï¼Œ<strong>å¦‚æœåä¸€å­é—®é¢˜åªæ˜¯ç”±å‰ä¸€å­é—®é¢˜æ¨å‡ºï¼Œåˆ™ä¸ºè´ªå¿ƒï¼Œå¦‚æœåä¸€å­é—®é¢˜ç”±å‰é¢å¤šä¸ªå­é—®é¢˜æ¨å‡ºï¼Œåˆ™ä¸ºåŠ¨æ€è§„åˆ’ï¼Œæ‰€ä»¥è¯´è´ªå¿ƒæ˜¯åŠ¨æ€è§„åˆ’çš„ç‰¹æ®Šæƒ…å†µ</strong>ã€‚</p><h2 id="åŠ¨æ€è§„åˆ’å¸¸è§é—®é¢˜"><a href="#åŠ¨æ€è§„åˆ’å¸¸è§é—®é¢˜" class="headerlink" title="åŠ¨æ€è§„åˆ’å¸¸è§é—®é¢˜"></a>åŠ¨æ€è§„åˆ’å¸¸è§é—®é¢˜</h2><h3 id="æœ€é•¿å­ä¸²"><a href="#æœ€é•¿å­ä¸²" class="headerlink" title="æœ€é•¿å­ä¸²"></a>æœ€é•¿å­ä¸²</h3><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°æ²¡æœ‰é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²çš„é•¿åº¦ã€‚</p><p>ä¾‹å¦‚:<br>å­—ç¬¦ä¸²â€abcabcbbâ€, æœ€é•¿éé‡å¤å­ä¸²é•¿åº¦æ˜¯3(â€œabcâ€).<br>å­—ç¬¦ä¸²â€pwwkewâ€, æœ€é•¿éé‡å¤å­ä¸²é•¿åº¦æ˜¯3(â€œwkeâ€).</p><p>å…·ä½“è§£æ³•ç§»æ­¥[æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Longest Substring](<a href="http://bigdatadecode.top/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode">http://bigdatadecode.top/æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode</a> Longest Substring.html)</p><h3 id="æœ€é•¿å›æ–‡"><a href="#æœ€é•¿å›æ–‡" class="headerlink" title="æœ€é•¿å›æ–‡"></a>æœ€é•¿å›æ–‡</h3><p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ±‚æœ€é•¿å›æ–‡å­ä¸²(å‡è®¾å­—ç¬¦ä¸²ä¸­åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªæœ€é•¿å›æ–‡å­ä¸²)ã€‚</p><p>ä¾‹å¦‚ï¼š<br>å­—ç¬¦ä¸²â€bananasâ€, æœ€é•¿å›æ–‡ä¸ºâ€ananaâ€<br>å­—ç¬¦ä¸²â€aaaâ€, æœ€é•¿å›æ–‡ä¸ºâ€aaaâ€</p><p>å…·ä½“è§£æ³•ç§»æ­¥[æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Longest Palindromic](<a href="http://bigdatadecode.top/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode">http://bigdatadecode.top/æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode</a> Longest Palindromic.html)</p>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> åŠ¨æ€è§„åˆ’ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Spark Streaming æ¶ˆè´¹kafkaåˆ°HDFS</title>
      <link href="/Spark%20Streaming%20%E6%B6%88%E8%B4%B9kafka%E5%88%B0HDFS.html"/>
      <url>/Spark%20Streaming%20%E6%B6%88%E8%B4%B9kafka%E5%88%B0HDFS.html</url>
      
        <content type="html"><![CDATA[<p>å…ˆè¯´ä¸‹ç¨‹åºåŠŸèƒ½ï¼Œä½¿ç”¨Spark Streaming å®æ—¶æ¶ˆè´¹kafkaï¼Œå¹¶å°†messageå†™å…¥HDFSä¸ŠæŒ‡å®šçš„topicç›®å½•ä¸­ã€‚<br>æ¶ˆè´¹kafkaä½¿ç”¨çš„æ˜¯Sparkæä¾›çš„<em>Direct Approach</em>æ–¹æ³•ï¼Œç„¶ååˆ©ç”¨HDFS APIå°†ä¸åŒtopicä¸‹çš„messageå†™åˆ°å„è‡ªtopicç›®å½•ä¸‹ã€‚</p><span id="more"></span><h2 id="Spark-Streamingç®€ä»‹"><a href="#Spark-Streamingç®€ä»‹" class="headerlink" title="Spark Streamingç®€ä»‹"></a>Spark Streamingç®€ä»‹</h2><p>Spark Streamingæ˜¯Sparkçš„æ‰©å±•ï¼Œèƒ½å¤Ÿæ‰©å±•çš„ã€‚é«˜ååã€å®¹é”™çš„å¤„ç†å®æ—¶æ•°æ®æµã€‚Spark Streamingçš„å·¥ä½œæµç¨‹æ˜¯å°†æ¥å—åˆ°å®æ—¶çš„æ•°æ®åˆ’åˆ†åˆ°ä¸åŒçš„batchä¸­ï¼Œç„¶åç”±Spark Engineå¤„ç†å¹¶ç”Ÿæˆç»“æœbatchã€‚å¦‚ä¸‹å›¾ï¼š<br><img src="/blogimgs/SparkStreamingconsumerKafka/streaming-flow.png" alt="Spark Streamingå·¥ä½œæµ" title="Spark Streamingå·¥ä½œæµ"></p><p>Spark Streamingæä¾›äº†ä¸€ä¸ªé«˜çº§çš„æŠ½è±¡æ¨¡å‹ï¼Œå«åšdiscretized streamæˆ–è€…å«åšDStream,å®ƒä»£è¡¨äº†ä¸€ä¸ªæŒç»­çš„æ•°æ®æµã€‚</p><p>Saprk Streamingä¸­çš„Contextæ˜¯StreamingContextï¼ŒStreamingContextæ˜¯æ‰€æœ‰åŠŸèƒ½çš„ä¸»å…¥å£ï¼Œå¯ä»¥é€šè¿‡ä¸¤ç§æ–¹æ³•createï¼Œ</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// first</span></span><br><span class="line"><span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(appName).setMaster(master)</span><br><span class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(conf, <span class="type">Seconds</span>(<span class="number">1</span>))</span><br><span class="line"><span class="comment">// second</span></span><br><span class="line"><span class="keyword">val</span> sc = ...                <span class="comment">// existing SparkContext</span></span><br><span class="line"><span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sc, <span class="type">Seconds</span>(<span class="number">1</span>))</span><br></pre></td></tr></table></figure><p>ç„¶åç”±ssc(StreamingContext)åˆ›å»ºä¸€ä¸ªDStreamï¼ŒDStreamå¯ä»¥æŒ‡å®šæ•°æ®è¾“å…¥æºï¼ˆDStreamæ”¯æŒå¾ˆå¤šæ•°æ®æºï¼Œå¦‚kakfaã€flumeã€twitterã€TCP socketdï¼‰ï¼Œè¿™é‡Œæ¥ä¸ªç®€å•çš„TCP socketä¾‹å­</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Create a DStream that will connect to hostname:port, like localhost:9999</span></span><br><span class="line"><span class="keyword">val</span> lines = ssc.socketTextStream(<span class="string">&quot;localhost&quot;</span>, <span class="number">9999</span>)</span><br></pre></td></tr></table></figure><p>linesçš„ç±»å‹æ˜¯DStreamï¼Œä»£è¡¨ä»æ•°æ®æœåŠ¡å™¨ä¸Šæ¥å—åˆ°çš„æ•°æ®æµã€‚linesä¸­çš„æ¯ä¸€æ¡è®°å½•æ˜¯ä¸€è¡Œæ–‡æœ¬ã€‚å¯ä»¥å¯¹å…¶è¿›è¡Œä¸€äº›é«˜çº§æ“ä½œå¦‚mapã€reduceã€joinå’Œwindowï¼Œ_éœ€è¦æ³¨æ„çš„æ˜¯æœ‰äº›RDDæ“ä½œå¹¶æ²¡æœ‰å¯¹DStreamå¼€æ”¾ï¼Œå¦‚æœæƒ³ä½¿ç”¨é‚£äº›APIï¼Œåˆ™éœ€è¦è¿›è¡ŒTransform Operation_ï¼Œtransform Operationå°±æ˜¯è®²DStreamè½¬æ¢ä¸ºRDDï¼Œæ–¹æ³•è°ƒç”¨ä¸º<code>dStream.transform</code>ï¼Œä»£ç ç¤ºä¾‹</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> dStreamToRdd = dStream.transform(rdd =&gt; &#123;</span><br><span class="line">  ...</span><br><span class="line">  rdd</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Spark Streamingä»…ä»…è®¾ç½®è¿™äº›è®¡ç®—ï¼Œ å®ƒå¹¶æ²¡æœ‰é©¬ä¸Šè¢«æ‰§è¡Œã€‚å½“æ‰€æœ‰çš„è®¡ç®—è®¾ç½®å®Œåï¼Œæˆ‘ä»¬å¯ä»¥è°ƒç”¨ä¸‹é¢çš„ä»£ç å¯åŠ¨å¤„ç†</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ssc.start()             <span class="comment">// Start the computation</span></span><br><span class="line">ssc.awaitTermination()  <span class="comment">// Wait for the computation to terminate</span></span><br></pre></td></tr></table></figure><h2 id="Spark-Streaming-Demo"><a href="#Spark-Streaming-Demo" class="headerlink" title="Spark Streaming Demo"></a>Spark Streaming Demo</h2><p>æ¥ä¸ªç®€å•çš„Demoçœ‹çœ‹ï¼Œæ­¤Demoå¯ä»¥åœ¨<code>$&#123;SPARK_HOME&#125;/examples/src/main/scala/org/apache/spark/examples/streaming</code>ä¸­æ‰¾åˆ°</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.storage.<span class="type">StorageLevel</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Counts words in UTF8 encoded, &#x27;\n&#x27; delimited text received from the network every second.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Usage: NetworkWordCount &lt;hostname&gt; &lt;port&gt;</span></span><br><span class="line"><span class="comment"> * &lt;hostname&gt; and &lt;port&gt; describe the TCP server that Spark Streaming would connect to receive data.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * To run this on your local machine, you need to first run a Netcat server</span></span><br><span class="line"><span class="comment"> *    `$ nc -lk 9999`</span></span><br><span class="line"><span class="comment"> * and then run the example</span></span><br><span class="line"><span class="comment"> *    `$ bin/run-example org.apache.spark.examples.streaming.NetworkWordCount localhost 9999`</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">NetworkWordCount</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="type">System</span>.err.println(<span class="string">&quot;Usage: NetworkWordCount &lt;hostname&gt; &lt;port&gt;&quot;</span>)</span><br><span class="line">      <span class="type">System</span>.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">StreamingExamples</span>.setStreamingLogLevels()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create the context with a 1 second batch size</span></span><br><span class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;NetworkWordCount&quot;</span>)</span><br><span class="line">    <span class="comment">// å¾—åˆ°ä¸€ä¸ªspark streamingçš„contextï¼Œä¸ºspark streamingçš„ä¸»å…¥å£</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sparkConf, <span class="type">Seconds</span>(<span class="number">1</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create a socket stream on target ip:port and count the</span></span><br><span class="line">    <span class="comment">// words in input stream of \n delimited text (eg. generated by &#x27;nc&#x27;)</span></span><br><span class="line">    <span class="comment">// Note that no duplication in storage level only for running locally.</span></span><br><span class="line">    <span class="comment">// Replication necessary in distributed scenario for fault tolerance.</span></span><br><span class="line">    <span class="comment">// ç”±sscåˆ›å»ºä¸€ä¸ªTCP socketçš„DStreamï¼ŒDStreamå­˜æ”¾çš„å°±æ˜¯æ¥æ”¶çš„æ•°æ®æµ</span></span><br><span class="line">    <span class="keyword">val</span> lines = ssc.socketTextStream(args(<span class="number">0</span>), args(<span class="number">1</span>).toInt, <span class="type">StorageLevel</span>.<span class="type">MEMORY_AND_DISK_SER</span>)</span><br><span class="line">    <span class="keyword">val</span> words = lines.flatMap(_.split(<span class="string">&quot; &quot;</span>))</span><br><span class="line">    <span class="keyword">val</span> wordCounts = words.map(x =&gt; (x, <span class="number">1</span>)).reduceByKey(_ + _)</span><br><span class="line">    wordCounts.print()</span><br><span class="line">    <span class="comment">// è°ƒç”¨startä¹‹åï¼Œæ‰èƒ½è¿›è¡ŒçœŸæ­£çš„è®¡ç®—</span></span><br><span class="line">    ssc.start()</span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ‰“å¼€ä¸¤ä¸ªç»ˆç«¯ABï¼Œåœ¨Aè¾“å…¥<code>nc -lk 9999</code>å‘½ä»¤ï¼Œåœ¨Bè¿›å…¥sparkçš„homeç›®å½•è¿è¡Œ<code>./bin/run-example streaming.NetworkWordCount localhost 9999</code>å‘½ä»¤ã€‚åœ¨Aä¸­è¾“å…¥ä¸€äº›æµ‹è¯•æ•°æ®ï¼Œå°±å¯ä»¥åœ¨BæŸ¥çœ‹è®¡ç®—ç»“æœã€‚</p><h2 id="Spark-Streaming-æ¶ˆè´¹Kafka"><a href="#Spark-Streaming-æ¶ˆè´¹Kafka" class="headerlink" title="Spark Streaming æ¶ˆè´¹Kafka"></a>Spark Streaming æ¶ˆè´¹Kafka</h2><p>Sparkæ¶ˆè´¹kafkaæœ‰ä¸¤ç§æ–¹å¼ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ç¬¬äºŒç§_Direct Approach (No Receivers)_</p><blockquote><p>Direct Approachå°†kafkaæ•°æ®æºåŒ…è£¹æˆäº†ä¸€ä¸ªKafkaRDDï¼ŒRDDé‡Œçš„partition å¯¹åº”çš„æ•°æ®æºä¸ºkafkaçš„partitionï¼ˆæœ‰åˆ©äºå¹¶è¡Œçš„è¯»å–kafka messageï¼‰ã€‚<br>kafka messageå¹¶ä¸æ˜¯ç«‹é©¬è¢«è¯»å…¥sparkå†…å­˜ï¼Œè€Œæ˜¯åœ¨Kafkaå­˜ç€å‘¢ï¼Œç›´åˆ°æœ‰å®é™…çš„Actionè¢«è§¦å‘ï¼Œæ‰ä¼šå»kafkaä¸»åŠ¨æ‹‰æ•°æ®ã€‚<br>Direct Approachä½¿ç”¨çš„æ˜¯kafka simple consumer apiï¼Œè¿™æ ·å¯ä»¥æŒ‡å®šä»æŸä¸ªoffsetå¤„è¿›è¡Œè¯»å–ï¼Œæœ‰åˆ©äºæ•…éšœæ¢å¤ã€‚</p></blockquote><h2 id="Spark-Streaming-consumer-Kafka-to-HDFS"><a href="#Spark-Streaming-consumer-Kafka-to-HDFS" class="headerlink" title="Spark Streaming consumer Kafka to HDFS"></a>Spark Streaming consumer Kafka to HDFS</h2><p>æœ¬ç¯‡æ–‡ç« ä¸»è¦å°†kafkaä¸­çš„messageé€šè¿‡spark streamingæ ¹æ®ä¸åŒçš„topicå†™åˆ°ä¸åŒçš„hdfsæ–‡ä»¶ä¸­ï¼Œå¹¶ä¸”èƒ½å¤Ÿè®°å½•æ¶ˆè´¹messageçš„offsetï¼Œä»¥æ”¯æŒæ•…éšœæ¢å¤ã€‚</p><h3 id="offsetå­˜å‚¨æ–¹æ¡ˆé€‰æ‹©"><a href="#offsetå­˜å‚¨æ–¹æ¡ˆé€‰æ‹©" class="headerlink" title="offsetå­˜å‚¨æ–¹æ¡ˆé€‰æ‹©"></a>offsetå­˜å‚¨æ–¹æ¡ˆé€‰æ‹©</h3><ul><li>åˆ©ç”¨checkpointå°†offsetå­˜å‚¨åœ¨hdfs<br>ç®€å•å®¹æ˜“å®ç°ï¼Œæ ¹æ®éœ€æ±‚æœ‰ä¸€å®šçš„å±€é™ï¼Œæ— æ³•æ›´å¥½çš„æ»¡è¶³éœ€æ±‚</li><li>å°†offsetå­˜å‚¨åœ¨HDFS<br>ä¸€å¼€å§‹ä¸ºäº†å°½é‡å‡å°‘ä¾èµ–çš„ç»„ä»¶ï¼Œå‡å°‘ç»„ä»¶åŸå› é€ æˆåº”ç”¨æ•…éšœï¼Œä½¿ç”¨é€‰æ‹©å°†offsetå­˜å‚¨åœ¨hdfsä¸Šï¼Œä½†åœ¨å¼€å‘ä¸­è€ƒè™‘åˆ°offsetæ–‡ä»¶éœ€è¦é¢‘ç¹çš„è¯»å†™æ“ä½œï¼Œå¯èƒ½ä¼šåœ¨æ€§èƒ½ä¸Šæœ‰æ‰€å½±å“</li><li>å°†offsetå­˜å‚¨åœ¨zk<br>è·ŸKafka high-level consumer APIä¸€æ ·å°†offsetå­˜å‚¨åœ¨zkä¸Šï¼Œä»£ç é€»è¾‘å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/SparkStreamingconsumerKafka/spark-kafka-direct-api.png" alt="Kafka direct API with zk" title="Kafka direct API with zk"><br>ç”±Spark driverè®¡ç®—ä¸‹ä¸ªbatchçš„offsetsï¼ŒæŒ‡å¯¼executoræ¶ˆè´¹å¯¹åº”çš„topicså’Œpartitionsã€‚ä½¿æ¶ˆè´¹Kafkaæ¶ˆæ¯ï¼Œå°±åƒæ¶ˆè´¹æ–‡ä»¶ç³»ç»Ÿæ–‡ä»¶ä¸€æ ·ã€‚</li></ul><h3 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h3><p>Spark Streamingé€šè¿‡Direct Approachæ¥æ”¶æ•°æ®çš„å…¥å£è‡ªç„¶æ˜¯KafkaUtils.createDirectStream äº†ã€‚åœ¨è°ƒç”¨è¯¥æ–¹æ³•æ—¶ï¼Œä¼šå…ˆåˆ›å»º<code>KafkaCluster</code>ï¼Œå¾—åˆ°offset</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">createDirectStream</span></span>[</span><br><span class="line">  <span class="type">K</span>: <span class="type">ClassTag</span>,</span><br><span class="line">  <span class="type">V</span>: <span class="type">ClassTag</span>,</span><br><span class="line">  <span class="type">KD</span> &lt;: <span class="type">Decoder</span>[<span class="type">K</span>]: <span class="type">ClassTag</span>,</span><br><span class="line">  <span class="type">VD</span> &lt;: <span class="type">Decoder</span>[<span class="type">V</span>]: <span class="type">ClassTag</span>] (</span><br><span class="line">    ssc: <span class="type">StreamingContext</span>,</span><br><span class="line">    kafkaParams: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>],</span><br><span class="line">    topics: <span class="type">Set</span>[<span class="type">String</span>]</span><br><span class="line">): <span class="type">InputDStream</span>[(<span class="type">K</span>, <span class="type">V</span>)] = &#123;</span><br><span class="line">  <span class="keyword">val</span> messageHandler = (mmd: <span class="type">MessageAndMetadata</span>[<span class="type">K</span>, <span class="type">V</span>]) =&gt; (mmd.key, mmd.message)</span><br><span class="line">  <span class="keyword">val</span> kc = <span class="keyword">new</span> <span class="type">KafkaCluster</span>(kafkaParams)</span><br><span class="line">  <span class="keyword">val</span> fromOffsets = getFromOffsets(kc, kafkaParams, topics)</span><br><span class="line">  <span class="keyword">new</span> <span class="type">DirectKafkaInputDStream</span>[<span class="type">K</span>, <span class="type">V</span>, <span class="type">KD</span>, <span class="type">VD</span>, (<span class="type">K</span>, <span class="type">V</span>)](</span><br><span class="line">    ssc, kafkaParams, fromOffsets, messageHandler)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p><code>KafkaCluster</code>æ˜¯æ“ä½œkafkaçš„ä¸€ä¸ªå…³é”®ç±»ï¼Œä½†ç”±äºå…¶æ˜¯privateçš„ï¼Œè¦æƒ³åœ¨è‡ªå·±çš„ä»£ç ä¸­ä½¿ç”¨è¯¥ç±»å¾—é‡å†™è¯¥ç±»ã€‚</p></blockquote><p>åˆ›å»ºKafkaManagerç±»ï¼Œå…¶ä¸­ä¸»è¦åŒ…å«ä¸‰ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯æ ¹æ®offsetåˆ›å»ºä¸€ä¸ªDStreamã€å¾—åˆ°offsetã€æ›´æ–°zkä¸Šçš„offsetï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kafka.common.<span class="type">TopicAndPartition</span></span><br><span class="line"><span class="keyword">import</span> kafka.message.<span class="type">MessageAndMetadata</span></span><br><span class="line"><span class="keyword">import</span> kafka.serializer.<span class="type">Decoder</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkException</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.rdd.<span class="type">RDD</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.<span class="type">StreamingContext</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.dstream.<span class="type">InputDStream</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka.<span class="type">KafkaCluster</span>.<span class="type">LeaderOffset</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka.&#123;<span class="type">HasOffsetRanges</span>, <span class="type">KafkaCluster</span>, <span class="type">KafkaUtils</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.reflect.<span class="type">ClassTag</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Created by hunhun on 2016/5/27.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">KafkaManager</span>(<span class="params">val kafkaParams: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>]</span>) </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// KafkaCluster in Spark is overwrited by myself</span></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> kc = <span class="keyword">new</span> <span class="type">KafkaCluster</span>(kafkaParams)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ ¹æ®offsetåˆ›å»ºä¸€ä¸ªDStream</span></span><br><span class="line">  <span class="comment">// return key message topic</span></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">createDirectStream</span></span>[<span class="type">K</span>: <span class="type">ClassTag</span>, <span class="type">V</span>: <span class="type">ClassTag</span>, <span class="type">KD</span> &lt;: <span class="type">Decoder</span>[<span class="type">K</span>]: <span class="type">ClassTag</span>, <span class="type">VD</span> &lt;: <span class="type">Decoder</span>[<span class="type">V</span>]: <span class="type">ClassTag</span>]</span><br><span class="line">    (ssc: <span class="type">StreamingContext</span>, kafkaParams: <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>], topics: <span class="type">Set</span>[<span class="type">String</span>]): <span class="type">InputDStream</span>[(<span class="type">K</span>, <span class="type">V</span>, <span class="type">String</span>)] = &#123;</span><br><span class="line">    <span class="keyword">val</span> groupId = kafkaParams.get(<span class="string">&quot;group.id&quot;</span>).get</span><br><span class="line">    <span class="comment">// åœ¨zookeeperä¸Šè¯»å–offsetså‰å…ˆæ ¹æ®å®é™…æƒ…å†µæ›´æ–°offsets</span></span><br><span class="line">    setOrUpdateOffsets(topics, groupId)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä»zookeeperä¸Šè¯»å–offsetå¼€å§‹æ¶ˆè´¹message</span></span><br><span class="line">    <span class="keyword">val</span> messages = &#123;</span><br><span class="line">      <span class="comment">// Either ç±»å‹</span></span><br><span class="line">      <span class="keyword">val</span> partitionsE = kc.getPartitions(topics)</span><br><span class="line">      <span class="keyword">if</span> (partitionsE.isLeft)</span><br><span class="line">        <span class="comment">// s&quot;xx $&#123;&#125;&quot; å­—ç¬¦ä¸²æ’å€¼</span></span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s&quot;get kafka partition failed: <span class="subst">$&#123;partitionsE.left.get&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">val</span> partitions = partitionsE.right.get</span><br><span class="line">      <span class="keyword">val</span> consumerOffsetsE = kc.getConsumerOffsets(groupId, partitions)</span><br><span class="line">      <span class="keyword">if</span> (consumerOffsetsE.isLeft)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s&quot;get kafka consumer offsets failed: <span class="subst">$&#123;consumerOffsetsE.left.get&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">val</span> consumerOffsets = consumerOffsetsE.right.get</span><br><span class="line">      <span class="comment">// ä»æŒ‡å®šoffsetså¤„æ¶ˆè´¹kafka</span></span><br><span class="line">      <span class="comment">// messageHandler = (mmd: MessageAndMetadata[String, String]) =&gt; (mmd.key(), mmd.message())</span></span><br><span class="line">      <span class="comment">// MessageAndMetadataé‡ŒåŒ…å«messageçš„topic message ç­‰ç­‰ä¿¡æ¯</span></span><br><span class="line">      <span class="type">KafkaUtils</span>.createDirectStream[<span class="type">K</span>, <span class="type">V</span>, <span class="type">KD</span>, <span class="type">VD</span>, (<span class="type">K</span>, <span class="type">V</span>, <span class="type">String</span>)](</span><br><span class="line">        ssc, kafkaParams, consumerOffsets, (mmd: <span class="type">MessageAndMetadata</span>[<span class="type">K</span>, <span class="type">V</span>]) =&gt; ( mmd.key, mmd.message, mmd.topic))</span><br><span class="line">    &#125;</span><br><span class="line">    messages</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">def</span> <span class="title">setOrUpdateOffsets</span></span>(topics: <span class="type">Set</span>[<span class="type">String</span>], groupId: <span class="type">String</span>): <span class="type">Unit</span> = &#123;</span><br><span class="line">    topics.foreach(topic =&gt; &#123;</span><br><span class="line">      <span class="keyword">var</span> hasConsumed = <span class="literal">true</span></span><br><span class="line">      <span class="keyword">val</span> partitionsE = kc.getPartitions(<span class="type">Set</span>(topic))</span><br><span class="line">      <span class="keyword">if</span> (partitionsE.isLeft)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s&quot;get kafka partition failed: <span class="subst">$&#123;partitionsE.left.get&#125;</span>&quot;</span>)</span><br><span class="line">      <span class="keyword">val</span> partitions = partitionsE.right.get</span><br><span class="line">      <span class="keyword">val</span> consumerOffsetsE = kc.getConsumerOffsets(groupId, partitions)</span><br><span class="line">      <span class="keyword">if</span> (consumerOffsetsE.isLeft) hasConsumed = <span class="literal">false</span></span><br><span class="line">      <span class="comment">// æŸä¸ªgroupidé¦–æ¬¡æ²¡æœ‰offsetä¿¡æ¯ï¼Œä¼šæŠ¥é”™ï¼Œä»å¤´å¼€å§‹è¯»</span></span><br><span class="line">      <span class="keyword">if</span> (hasConsumed) &#123;<span class="comment">// æ¶ˆè´¹è¿‡</span></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">          * å¦‚æœstreamingç¨‹åºæ‰§è¡Œçš„æ—¶å€™å‡ºç°kafka.common.OffsetOutOfRangeExceptionï¼Œ</span></span><br><span class="line"><span class="comment">          * è¯´æ˜zkä¸Šä¿å­˜çš„offsetså·²ç»è¿‡æ—¶äº†ï¼Œå³kafkaçš„å®šæ—¶æ¸…ç†ç­–ç•¥å·²ç»å°†åŒ…å«è¯¥offsetsçš„æ–‡ä»¶åˆ é™¤ã€‚</span></span><br><span class="line"><span class="comment">          * é’ˆå¯¹è¿™ç§æƒ…å†µï¼Œåªè¦åˆ¤æ–­ä¸€ä¸‹zkä¸Šçš„consumerOffsetså’ŒearliestLeaderOffsetsçš„å¤§å°ï¼Œ</span></span><br><span class="line"><span class="comment">          * å¦‚æœconsumerOffsetsæ¯”earliestLeaderOffsetsè¿˜å°çš„è¯ï¼Œè¯´æ˜consumerOffsetså·²è¿‡æ—¶,</span></span><br><span class="line"><span class="comment">          * è¿™æ—¶æŠŠconsumerOffsetsæ›´æ–°ä¸ºearliestLeaderOffsets</span></span><br><span class="line"><span class="comment">          */</span></span><br><span class="line">        <span class="keyword">val</span> earliestLeaderOffsetsE = kc.getEarliestLeaderOffsets(partitions)</span><br><span class="line">        <span class="keyword">if</span> (earliestLeaderOffsetsE.isLeft)</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s&quot;get earliest leader offsets failed: <span class="subst">$&#123;earliestLeaderOffsetsE.left.get&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> earliestLeaderOffsets = earliestLeaderOffsetsE.right.get</span><br><span class="line">        <span class="keyword">val</span> consumerOffsets = consumerOffsetsE.right.get</span><br><span class="line"></span><br><span class="line">        <span class="comment">// å¯èƒ½åªæ˜¯å­˜åœ¨éƒ¨åˆ†åˆ†åŒºconsumerOffsetsè¿‡æ—¶ï¼Œæ‰€ä»¥åªæ›´æ–°è¿‡æ—¶åˆ†åŒºçš„consumerOffsetsä¸ºearliestLeaderOffsets</span></span><br><span class="line">        <span class="keyword">var</span> offsets: <span class="type">Map</span>[<span class="type">TopicAndPartition</span>, <span class="type">Long</span>] = <span class="type">Map</span>()</span><br><span class="line">        consumerOffsets.foreach(&#123; <span class="keyword">case</span>(tp, n) =&gt;</span><br><span class="line">          <span class="keyword">val</span> earliestLeaderOffset = earliestLeaderOffsets(tp).offset</span><br><span class="line">          <span class="keyword">if</span> (n &lt; earliestLeaderOffset) &#123;</span><br><span class="line">            println(<span class="string">&quot;consumer group:&quot;</span> + groupId + <span class="string">&quot;,topic:&quot;</span> + tp.topic + <span class="string">&quot;,partition:&quot;</span> + tp.partition +</span><br><span class="line">              <span class="string">&quot; offsetså·²ç»è¿‡æ—¶ï¼Œæ›´æ–°ä¸º&quot;</span> + earliestLeaderOffset)</span><br><span class="line">            offsets += (tp -&gt; earliestLeaderOffset)</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">        <span class="keyword">if</span> (!offsets.isEmpty) &#123;</span><br><span class="line">          kc.setConsumerOffsets(groupId, offsets)</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;<span class="comment">// æ²¡æœ‰æ¶ˆè´¹è¿‡</span></span><br><span class="line">      <span class="keyword">val</span> reset = kafkaParams.get(<span class="string">&quot;auto.offset.reset&quot;</span>).map(_.toLowerCase)</span><br><span class="line">        <span class="keyword">var</span> leaderOffsets: <span class="type">Map</span>[<span class="type">TopicAndPartition</span>, <span class="type">LeaderOffset</span>] = <span class="literal">null</span></span><br><span class="line">        <span class="keyword">if</span> (reset == <span class="type">Some</span>(<span class="string">&quot;smallest&quot;</span>)) &#123;<span class="comment">// ä»å¤´æ¶ˆè´¹</span></span><br><span class="line">          <span class="keyword">val</span> leaderOffsetsE = kc.getEarliestLeaderOffsets(partitions)</span><br><span class="line">          <span class="keyword">if</span> (leaderOffsetsE.isLeft)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s&quot;get earliest leader offsets failed: <span class="subst">$&#123;leaderOffsetsE.left.get&#125;</span>&quot;</span>)</span><br><span class="line">          leaderOffsets = leaderOffsetsE.right.get</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// ä»æœ€æ–°offsetå¤„æ¶ˆè´¹</span></span><br><span class="line">          <span class="keyword">val</span> leaderOffsetsE = kc.getLatestLeaderOffsets(partitions)</span><br><span class="line">          <span class="keyword">if</span> (leaderOffsetsE.isLeft)</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="type">SparkException</span>(<span class="string">s&quot;get latest leader offsets failed: <span class="subst">$&#123;leaderOffsetsE.left.get&#125;</span>&quot;</span>)</span><br><span class="line">          leaderOffsets = leaderOffsetsE.right.get</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> offsets = leaderOffsets.map &#123;</span><br><span class="line">          <span class="keyword">case</span> (tp, offset) =&gt; (tp, offset.offset)</span><br><span class="line">        &#125;</span><br><span class="line">        kc.setConsumerOffsets(groupId, offsets)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">updateZKOffsets</span></span>(rdd: <span class="type">RDD</span>[(<span class="type">String</span>, <span class="type">String</span>, <span class="type">String</span>)]) : <span class="type">Unit</span> = &#123;</span><br><span class="line">    <span class="keyword">val</span> groupId = kafkaParams.get(<span class="string">&quot;group.id&quot;</span>).get</span><br><span class="line">    <span class="keyword">val</span> offsetsList = rdd.asInstanceOf[<span class="type">HasOffsetRanges</span>].offsetRanges</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (offsets &lt;- offsetsList) &#123;</span><br><span class="line">      <span class="keyword">val</span> topicAndPartition = <span class="type">TopicAndPartition</span>(offsets.topic, offsets.partition)</span><br><span class="line">      <span class="keyword">val</span> o = kc.setConsumerOffsets(groupId, <span class="type">Map</span>((topicAndPartition, offsets.untilOffset)))</span><br><span class="line">      <span class="keyword">if</span> (o.isLeft) &#123;</span><br><span class="line">        println(<span class="string">s&quot;Error updating the offset to Kafka cluster: <span class="subst">$&#123;o.left.get&#125;</span>&quot;</span>)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ›å»ºä¸»ç±»SparkConsumerKafka</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kafka.serializer.<span class="type">StringDecoder</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.&#123;<span class="type">FSDataOutputStream</span>, <span class="type">Path</span>, <span class="type">FileSystem</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> scala.collection.mutable.<span class="type">ListBuffer</span></span><br><span class="line"><span class="keyword">import</span> scala.util.<span class="type">Random</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Created by hunhun on 2016/5/23.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">SparkConsumerKafka</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">4</span>) &#123;</span><br><span class="line">      <span class="type">System</span>.err.println( <span class="string">s&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                             |Usage: DirectKafkaWordCount &lt;brokers&gt; &lt;topics&gt; &lt;groupid&gt;</span></span><br><span class="line"><span class="string">                             |  &lt;brokers&gt; is a list of one or more Kafka brokers</span></span><br><span class="line"><span class="string">                             |  &lt;topics&gt; is a list of one or more kafka topics to consume from</span></span><br><span class="line"><span class="string">                             |  &lt;groupid&gt; is a consume group</span></span><br><span class="line"><span class="string">                             |  &lt;hdfspath&gt; is a HDFS Path, like /user/admin/scalapath</span></span><br><span class="line"><span class="string">                             |</span></span><br><span class="line"><span class="string">        &quot;</span><span class="string">&quot;&quot;</span>.stripMargin)</span><br><span class="line">      <span class="type">System</span>.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> <span class="type">Array</span>(brokers, topics, groupId, hdfsPath) = args</span><br><span class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;SparkConsumerKafka&quot;</span>)</span><br><span class="line">    <span class="comment">// spark.streaming.kafka.maxRatePerPartition é™é€Ÿ</span></span><br><span class="line">    <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sparkConf, <span class="type">Seconds</span>(<span class="number">60</span>))</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create direct kafka stream with brokers and topics</span></span><br><span class="line">    <span class="keyword">val</span> topicsSet = topics.split(<span class="string">&quot;,&quot;</span>).toSet</span><br><span class="line">    <span class="keyword">val</span> kafkaParams = <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>](</span><br><span class="line">      <span class="string">&quot;metadata.broker.list&quot;</span> -&gt; brokers,</span><br><span class="line">      <span class="string">&quot;group.id&quot;</span> -&gt; groupId,</span><br><span class="line">      <span class="string">&quot;auto.offset.reset&quot;</span> -&gt; <span class="string">&quot;smallest&quot;</span></span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> km = <span class="keyword">new</span> <span class="type">KafkaManager</span>(kafkaParams)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> messages = km.createDirectStream[<span class="type">String</span>, <span class="type">String</span>, <span class="type">StringDecoder</span>, <span class="type">StringDecoder</span>](ssc,</span><br><span class="line">      kafkaParams, topicsSet)</span><br><span class="line">    <span class="comment">// foreachRDDæ˜¯DStreamçš„outputæ“ä½œ</span></span><br><span class="line">    messages.foreachRDD( rdd =&gt; &#123;</span><br><span class="line">      <span class="keyword">if</span> (!rdd.isEmpty())&#123;</span><br><span class="line">        rdd.foreachPartition&#123; partitionOfRecords =&gt;</span><br><span class="line">          <span class="comment">// å¾—åˆ°HDFSçš„æ“ä½œclient</span></span><br><span class="line">          <span class="comment">// æ­¤ä»£ç å¿…é¡»æ”¾åœ¨workerä¸­åˆ›å»ºï¼Œå¦‚æœåœ¨driverä¸­åˆ›å»ºï¼Œåˆ™å°†ä¼šè¢«åºåˆ—åŒ–åˆ°workerä¸­</span></span><br><span class="line">          <span class="comment">// åœ¨workerä¸­æ“ä½œæ—¶ä¼šæŠ¥é”™ã€‚</span></span><br><span class="line">          <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">Configuration</span>()</span><br><span class="line">          <span class="keyword">val</span> fs = <span class="type">FileSystem</span>.get(conf)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">var</span> messageList = <span class="keyword">new</span> <span class="type">ListBuffer</span>[<span class="type">String</span>]</span><br><span class="line">          <span class="keyword">var</span> topic = <span class="string">&quot;&quot;</span></span><br><span class="line">          <span class="comment">// æ­¤å¤„ä»£ç åªä¸ºå¾—åˆ°topic</span></span><br><span class="line">          <span class="comment">// ä¹‹æ‰€ä»¥å°†messageæ”¾å…¥messageListä¸­æ˜¯å› ä¸ºpartitionOfRecordså˜ä¸ºlistä¹‹å</span></span><br><span class="line">          <span class="comment">// æ‹¿åˆ°ä¸€ä¸ªrecordçš„topicä¹‹åï¼ŒpartitionOfRecordsä¸­çš„å†…å®¹å°†æ¶ˆå¤±ï¼Œå…·ä½“åŸå› ä¸çŸ¥é“</span></span><br><span class="line">          <span class="comment">// ä»£ç å¦‚ä¸‹ï¼š</span></span><br><span class="line">          <span class="comment">// val topic = partitionOfRecords.toList(0)._3</span></span><br><span class="line">          <span class="comment">// ç„¶åå†™å…¥hdfsæ—¶è°ƒç”¨</span></span><br><span class="line">          <span class="comment">// partitionOfRecords.foreach(record =&gt; outputStream.write((record._2 + &quot;\n&quot;).getBytes(&quot;UTF-8&quot;)))</span></span><br><span class="line">          <span class="comment">// æ­¤æ—¶å†™å…¥hdfsçš„å†…å®¹ä¸ºnullï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆä¸ºnull</span></span><br><span class="line">          <span class="comment">// æ‰€ä»¥åªå¥½åœ¨å¾—åˆ°topicçš„åŒæ—¶æŠŠmessageå…ˆå­˜å…¥messageList</span></span><br><span class="line">          partitionOfRecords.foreach(record =&gt; &#123;</span><br><span class="line">            messageList += record._2</span><br><span class="line">            <span class="keyword">if</span> (topic == <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">              topic = record._3</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;)</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (topic != <span class="string">&quot;&quot;</span>)&#123;</span><br><span class="line">            <span class="comment">// æ‹¼å‡ºå„ä¸ªtopic messageçš„æ–‡ä»¶åœ°å€</span></span><br><span class="line">            <span class="keyword">val</span> path = <span class="keyword">new</span> <span class="type">Path</span>(hdfsPath + <span class="string">&quot;/&quot;</span> + topic + <span class="string">&quot;/&quot;</span> + <span class="type">Random</span>.nextInt(<span class="number">100</span>) + topic</span><br><span class="line">                          + <span class="type">System</span>.currentTimeMillis())</span><br><span class="line">            <span class="comment">// åˆ›å»ºä¸€ä¸ªHDFS outputStreamæµ</span></span><br><span class="line">            <span class="keyword">val</span> outputStream = <span class="keyword">if</span> (fs.exists(path))&#123;</span><br><span class="line">              fs.append(path)</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">              fs.create(path)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// å°†messageé€æ¡å†™å…¥</span></span><br><span class="line">            messageList.foreach(message =&gt; outputStream.write((message + <span class="string">&quot;\n&quot;</span>).getBytes(<span class="string">&quot;UTF-8&quot;</span>)))</span><br><span class="line">            outputStream.close()</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// æ›´æ–°zkä¸Šçš„offset</span></span><br><span class="line">        km.updateZKOffsets(rdd)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    ssc.start()</span><br><span class="line">    ssc.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é™„åŠ "><a href="#é™„åŠ " class="headerlink" title="é™„åŠ "></a>é™„åŠ </h2><p>å°†offsetå†™å…¥checkpointä¸­</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> kafka.serializer.<span class="type">StringDecoder</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.conf.<span class="type">Configuration</span></span><br><span class="line"><span class="keyword">import</span> org.apache.hadoop.fs.&#123;<span class="type">FSDataOutputStream</span>, <span class="type">Path</span>, <span class="type">FileSystem</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.<span class="type">SparkConf</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.sql.catalyst.expressions.<span class="type">Second</span></span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.kafka.&#123;<span class="type">HasOffsetRanges</span>, <span class="type">OffsetRange</span>, <span class="type">KafkaUtils</span>&#125;</span><br><span class="line"><span class="keyword">import</span> org.apache.spark.streaming.&#123;<span class="type">Seconds</span>, <span class="type">StreamingContext</span>&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">  * Created by hunhun on 2016/5/26.</span></span><br><span class="line"><span class="comment">  */</span></span><br><span class="line"><span class="class"><span class="keyword">object</span> <span class="title">WriteToHdfsWithCheckpoint</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">def</span> <span class="title">main</span></span>(args: <span class="type">Array</span>[<span class="type">String</span>]) &#123;</span><br><span class="line">    <span class="keyword">if</span> (args.length &lt; <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="type">System</span>.err.println(<span class="string">s&quot;&quot;</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">                            |Usage: DirectKafkaWordCount &lt;brokers&gt; &lt;topics&gt;</span></span><br><span class="line"><span class="string">                            |  &lt;brokers&gt; is a list of one or more Kafka brokers</span></span><br><span class="line"><span class="string">                            |  &lt;topics&gt; is a list of one or more kafka topics to consume from</span></span><br><span class="line"><span class="string">                            |</span></span><br><span class="line"><span class="string">        &quot;</span><span class="string">&quot;&quot;</span>.stripMargin)</span><br><span class="line">      <span class="type">System</span>.exit(<span class="number">1</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">val</span> <span class="type">Array</span>(brokers, topics) = args</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create context with 2 second batch interval</span></span><br><span class="line">    <span class="keyword">val</span> sparkConf = <span class="keyword">new</span> <span class="type">SparkConf</span>().setAppName(<span class="string">&quot;ConsumerKafkaToHdfsWithCheckPoint&quot;</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create direct kafka stream with brokers and topics</span></span><br><span class="line">    <span class="keyword">val</span> topicsSet = topics.split(<span class="string">&quot;,&quot;</span>).toSet</span><br><span class="line">    <span class="keyword">val</span> kafkaParams = <span class="type">Map</span>[<span class="type">String</span>, <span class="type">String</span>](<span class="string">&quot;metadata.broker.list&quot;</span> -&gt; brokers,</span><br><span class="line">      <span class="string">&quot;auto.offset.reset&quot;</span> -&gt; <span class="string">&quot;smallest&quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> checkpointPath = <span class="string">&quot;hdfs://127.0.0.1:8020/spark_checkpoint&quot;</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">functionToCreateContext</span></span>(): <span class="type">StreamingContext</span> = &#123;</span><br><span class="line">      <span class="keyword">val</span> ssc = <span class="keyword">new</span> <span class="type">StreamingContext</span>(sparkConf, <span class="type">Seconds</span>(<span class="number">2</span>))</span><br><span class="line">      <span class="keyword">val</span> messages = <span class="type">KafkaUtils</span>.createDirectStream[<span class="type">String</span>, <span class="type">String</span>, <span class="type">StringDecoder</span>, <span class="type">StringDecoder</span>](ssc, kafkaParams, topicsSet)</span><br><span class="line">      <span class="comment">// checkpoint åœ¨å“ªä¿å­˜ï¼Ÿ è¿™æ ·ä¼šä¸ä¼šå‡ºç°offsetä¿å­˜äº†ä½†æ²¡æœ‰æˆåŠŸå†™å…¥hdfs</span></span><br><span class="line">      <span class="comment">// checkpointè°ƒç”¨çš„ä½ç½®ä¼šæœ‰å½±å“å—ï¼Ÿ</span></span><br><span class="line">      ssc.checkpoint(checkpointPath)</span><br><span class="line"></span><br><span class="line">      messages.map(_._2).foreachRDD(rdd =&gt; &#123;</span><br><span class="line">        rdd.foreachPartition&#123; partitionOfRecords =&gt;</span><br><span class="line">          <span class="keyword">val</span> conf = <span class="keyword">new</span> <span class="type">Configuration</span>()</span><br><span class="line">          <span class="keyword">val</span> fs = <span class="type">FileSystem</span>.get(conf)</span><br><span class="line">          <span class="keyword">val</span> path = <span class="keyword">new</span> <span class="type">Path</span>(<span class="string">&quot;/user/admin/scalapath/test&quot;</span> + <span class="type">System</span>.currentTimeMillis())</span><br><span class="line">          <span class="keyword">val</span> outputStream : <span class="type">FSDataOutputStream</span> = <span class="keyword">if</span> (fs.exists(path))&#123;</span><br><span class="line">            fs.append(path)</span><br><span class="line">          &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            fs.create(path)</span><br><span class="line">          &#125;</span><br><span class="line">          partitionOfRecords.foreach(record =&gt; outputStream.write((record + <span class="string">&quot;\n&quot;</span>).getBytes(<span class="string">&quot;UTF-8&quot;</span>)))</span><br><span class="line">          outputStream.close()</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">      ssc</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å†³å®šå¦åˆ›å»ºæ–°çš„Context</span></span><br><span class="line">    <span class="comment">// æ²¡æœ‰checkpointå°±åˆ›å»ºä¸€ä¸ªæ–°çš„StreamingContextå³åˆæ¬¡å¯åŠ¨åº”ç”¨</span></span><br><span class="line">    <span class="comment">// å¦‚æœæœ‰checkpointåˆ™checkpointä¸­è®°å½•çš„ä¿¡æ¯æ¢å¤StreamingContext</span></span><br><span class="line">    <span class="keyword">val</span> context = <span class="type">StreamingContext</span>.getOrCreate(checkpointPath, functionToCreateContext _)</span><br><span class="line"></span><br><span class="line">    context.start()</span><br><span class="line">    context.awaitTermination()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Spark </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Spark </tag>
            
            <tag> Streaming </tag>
            
            <tag> kafka </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Flumeç®€ä»‹åŠåˆæ¬¡ä½¿ç”¨</title>
      <link href="/Flume%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%88%9D%E6%AC%A1%E4%BD%BF%E7%94%A8.html"/>
      <url>/Flume%E7%AE%80%E4%BB%8B%E5%8F%8A%E5%88%9D%E6%AC%A1%E4%BD%BF%E7%94%A8.html</url>
      
        <content type="html"><![CDATA[<p>æœ€è¿‘è¦æ­å»ºä¸€ä¸ªæ—¥å¿—åˆ†æå¹³å°ï¼Œæ•´ä½“æ¶æ„æ€è·¯æ˜¯é€šè¿‡flumeé‡‡é›†æ—¥å¿—åˆ°kafkaä¸­ï¼Œä»kafkaä¹‹ååˆ†ä¸¤æ¡è·¯èµ°ï¼Œä¸€æ¡æ˜¯å®æ—¶ï¼Œä¸€æ¡æ˜¯ç¦»çº¿ã€‚å®æ—¶ä¼šç”¨sparkæˆ–è€…stormï¼ˆè¿˜æ²¡å¼€å§‹åšï¼‰ï¼Œç¦»çº¿ç”¨hadoop+hiveï¼Œå°†kafkaä¸­çš„æ•°æ®æ¶ˆè´¹åˆ°hdfsä¸Šï¼Œé€šè¿‡mrå¤„ç†è¿›hiveï¼Œè¿›è¡Œç»Ÿè®¡åˆ†æã€‚</p><blockquote><p>é‡‡ç”¨flumeçš„ç†ç”±ï¼š<br>flumeæ˜¯javaå¼€å‘çš„ï¼Œåˆ©äºç»´æŠ¤å’ŒäºŒæ¬¡å¼€å‘<br>flumeå¯æ‰©å±•ï¼Œä¹Ÿæœ‰è¾ƒå¥½çš„å®¹é”™æ€§ï¼Œæ€§èƒ½ä¹Ÿä¸é”™<br>flumeæ”¯æŒå¯¹ç°æœ‰åº”ç”¨æ— ç¼æ¥å…¥ï¼Œå¯¹è¾ƒè€çš„åº”ç”¨ç¨‹åºä¾µå…¥æ€§è¾ƒä½</p></blockquote><p>æœ¬ç¯‡ä¸»è¦ç®€å•ä»‹ç»ä¸‹flumeï¼Œå› ä¸ºflumeæ˜¯åˆæ¬¡ä½¿ç”¨æ‰€ä»¥ç®€å•è®°å½•ä¸‹ã€‚</p><span id="more"></span><h2 id="Flumeç‰ˆæœ¬æ¼”å˜"><a href="#Flumeç‰ˆæœ¬æ¼”å˜" class="headerlink" title="Flumeç‰ˆæœ¬æ¼”å˜"></a>Flumeç‰ˆæœ¬æ¼”å˜</h2><p>Flume æ˜¯ cloudera å¼€å‘çš„å®æ—¶æ—¥å¿—æ”¶é›†ç³»ç»Ÿï¼Œå…¶å¯ä»¥å®æ—¶çš„å°†åˆ†å¸ƒåœ¨ä¸åŒèŠ‚ç‚¹ã€æœºå™¨ä¸Šçš„æ—¥å¿—æ”¶é›†åˆ°ä¸€ä¸ªå­˜å‚¨è®¾å¤‡ä¸­ã€‚ç›®å‰Flumeå­˜åœ¨ä¸¤ä¸ªå¤§ç‰ˆæœ¬ï¼Œå…¶ä¸€ä¸ºåˆå§‹å‘è¡Œç‰ˆæœ¬ç›®å‰è¢«ç»Ÿç§°ä¸º <em>Flume OGï¼ˆoriginal generationï¼‰</em>ï¼Œå±äº clouderaã€‚å…¶äºŒä¸ºé‡æ„åçš„ç‰ˆæœ¬ç»Ÿç§°ä¸º<em>Flume NGï¼ˆnext generationï¼‰</em>ã€‚Flume NGå¯¹OGçš„æ ¸å¿ƒç»„ä»¶ã€æ ¸å¿ƒé…ç½®ä»¥åŠä»£ç æ¶æ„è¿›è¡Œäº†é‡æ„ã€‚</p><h2 id="Flume-OGç®€ä»‹"><a href="#Flume-OGç®€ä»‹" class="headerlink" title="Flume OGç®€ä»‹"></a>Flume OGç®€ä»‹</h2><p>OGçš„æ¶æ„ä¸ºæ¯”è¾ƒæµè¡Œçš„ä¸»ä»æ¶æ„ï¼Œåˆ†ä¸ºmasterå’Œnodeï¼Œä½†è§’è‰²åˆ†ä¸º3ç§ï¼Œåˆ†åˆ«ä¸ºagentã€collectorå’Œmasterï¼Œagentå’Œcollectoréƒ¨ç½²åœ¨nodeä¸Šï¼Œnodeçš„è§’è‰²æ ¹æ®é…ç½®çš„ä¸åŒåˆåˆ†ä¸º logical nodeï¼ˆé€»è¾‘èŠ‚ç‚¹ï¼‰ã€physical nodeï¼ˆç‰©ç†èŠ‚ç‚¹ï¼‰ã€‚</p><p>æ•°æ®æµæ˜¯ç”±agentæ”¶é›†æ—¥å¿—æ•°æ®ï¼Œé›†ä¸­åˆ°collectorï¼Œå†ç”±collectoræ±‡å…¥å­˜å‚¨ç»ˆç«¯ï¼Œmasteråœ¨æ­¤è¿‡ç¨‹ä¸­çš„ä½œç”¨æ˜¯ç®¡ç†agentå’Œcollectorçš„æ´»åŠ¨ã€‚</p><p>agentå’Œcollectorå†…éƒ¨ç»„ä»¶ç›¸åŒï¼Œéƒ½æ˜¯ç”±sourceè¯»å–æ•°æ®åˆ°channelï¼Œç„¶åsinkæ¶ˆè´¹channelä¸­çš„æ•°æ®åˆ°å­˜å‚¨ç»ˆç«¯æˆ–ä¸‹ä¸€ä¸ªsourceã€‚</p><h2 id="Flume-NGç®€ä»‹"><a href="#Flume-NGç®€ä»‹" class="headerlink" title="Flume NGç®€ä»‹"></a>Flume NGç®€ä»‹</h2><p>Flume NGåªæœ‰ä¸€ä¸ªagentè§’è‰²èŠ‚ç‚¹ï¼Œè¾ƒä¹‹OGï¼Œå°†collectorå’ŒmasterèŠ‚ç‚¹åˆ é™¤ï¼Œå¹¶å»æ‰äº†nodeæ¦‚å¿µï¼Œä½†agentçš„å†…éƒ¨ç»„ä»¶ä¾ç„¶æ˜¯sourceã€channelå’Œsinkã€‚</p><blockquote><p>Flume NGä¸»è¦æœ‰ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š</p></blockquote><ul><li>Eventï¼šä¸€ä¸ªæ•°æ®å•å…ƒï¼Œå¸¦æœ‰ä¸€ä¸ªå¯é€‰çš„æ¶ˆæ¯å¤´</li><li>Flowï¼šEventä»æºç‚¹åˆ°è¾¾ç›®çš„èŠ‚ç‚¹çš„è¿ç§»çš„æŠ½è±¡</li><li>Clientï¼šæ“ä½œä½äºæºç‚¹å¤„çš„Eventï¼Œå°†å…¶å‘é€åˆ°Flume Agent ï¼ˆExecSourceæ˜¯ä¸€ä¸ªclientï¼Œå°†æœ¬åœ°æ–‡ä»¶ä½œä¸ºflumeçš„è¾“å…¥ï¼‰</li><li>Agentï¼šä¸€ä¸ªç‹¬ç«‹çš„jvmè¿›ç¨‹ï¼ŒåŒ…å«ç»„ä»¶Sourceã€Channelã€Sink</li><li>Sourceï¼šç”¨æ¥æ¶ˆè´¹ä¼ é€’åˆ°è¯¥ç»„ä»¶çš„Event</li><li>Channelï¼šä¸­è½¬Eventçš„ä¸€ä¸ªä¸´æ—¶å­˜å‚¨ï¼Œä¿å­˜æœ‰Sourceç»„ä»¶ä¼ é€’è¿‡æ¥çš„Event</li><li>Sinkï¼šä»Channelä¸­è¯»å–ï¼Œå°†Eventä¼ é€’åˆ°å­˜å‚¨è®¾å¤‡ä¸­æˆ–Flow Pipelineä¸­çš„ä¸‹ä¸€ä¸ªAgentï¼ˆå¦‚æœæœ‰çš„è¯ï¼‰ï¼Œç„¶åç§»é™¤Event</li></ul><p>Flumeé‡‡é›†æ•°æ®çš„å¤§è‡´æµç¨‹æ˜¯clientå°†eventä¼ é€åˆ°flume agentï¼Œåœ¨agentä¸­é€šè¿‡sourceå°†eventæ”¾å…¥channelï¼Œç„¶åsinkå»channelä¸­å–æ•°æ®å­˜å‚¨åˆ°å­˜å‚¨è®¾å¤‡ä¸­æˆ–è€…flow pipelineã€‚</p><h2 id="NGæ ¸å¿ƒç»„ä»¶"><a href="#NGæ ¸å¿ƒç»„ä»¶" class="headerlink" title="NGæ ¸å¿ƒç»„ä»¶"></a>NGæ ¸å¿ƒç»„ä»¶</h2><h3 id="source"><a href="#source" class="headerlink" title="source"></a>source</h3><p>sourceæ˜¯ä¸»è¦ä½œç”¨æ˜¯ä»å¤–éƒ¨clientå¤„æ¥æ”¶æ•°æ®å¹¶å°†è¿™äº›æ•°æ®å­˜å‚¨åœ¨é…ç½®å¥½çš„channelä¸­ã€‚sourceæ”¯æŒçš„å¤–éƒ¨clientåŒ…æ‹¬avroï¼Œlog4jï¼Œsyslog å’Œ http post(bodyä¸ºjsonæ ¼å¼)ã€‚Flumeè¿˜æ”¯æŒæ— ç¼æ¥å…¥ç°æœ‰ç¨‹åºï¼Œä½¿å…¶ç›´æ¥è¯»å–ç¨‹åºçš„åŸå§‹æ—¥å¿—æ–‡ä»¶ï¼Œæœ‰ä¸¤ç§æ–¹å¼å¯ä»¥å®ç°ï¼š</p><ul><li>ExecSource: ä»¥è¿è¡Œ Linux å‘½ä»¤çš„æ–¹å¼ï¼ŒæŒç»­çš„è¾“å‡ºæœ€æ–°çš„æ•°æ®ï¼Œå¦‚ <em>tail -f æ–‡ä»¶å</em> æŒ‡ä»¤ï¼Œåœ¨è¿™ç§æ–¹å¼ä¸‹ï¼Œå–çš„æ–‡ä»¶åå¿…é¡»æ˜¯æŒ‡å®šçš„ã€‚ ExecSource å¯ä»¥å®ç°å¯¹æ—¥å¿—çš„å®æ—¶æ”¶é›†ï¼Œä½†æ˜¯å­˜åœ¨Flumeä¸è¿è¡Œæˆ–è€…æŒ‡ä»¤æ‰§è¡Œå‡ºé”™æ—¶ï¼Œå°†æ— æ³•æ”¶é›†åˆ°æ—¥å¿—æ•°æ®ï¼Œæ— æ³•ä¿è¯æ—¥å¿—æ•°æ®çš„å®Œæ•´æ€§ã€‚</li><li>SpoolSource: ç›‘æµ‹é…ç½®çš„ç›®å½•ä¸‹æ–°å¢çš„æ–‡ä»¶ï¼Œå¹¶å°†æ–‡ä»¶ä¸­çš„æ•°æ®è¯»å–å‡ºæ¥ã€‚éœ€è¦æ³¨æ„ä¸¤ç‚¹ï¼š<em>æ‹·è´åˆ° spool ç›®å½•ä¸‹çš„æ–‡ä»¶ä¸å¯ä»¥å†æ‰“å¼€ç¼–è¾‘ï¼›spool ç›®å½•ä¸‹ä¸å¯åŒ…å«ç›¸åº”çš„å­ç›®å½•</em>ã€‚</li></ul><h3 id="channel"><a href="#channel" class="headerlink" title="channel"></a>channel</h3><p>channelæ˜¯agentå­˜å‚¨eventsçš„é˜Ÿåˆ—ï¼Œsourceå‘å…¶ä¸­åŠ å…¥eventsï¼Œsinkåˆ™ä»å…¶ä¸­æ¶ˆè´¹eventsã€‚<br>å¸¸ç”¨çš„channelæœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯Memory Channel å’ŒFile Channel</p><ul><li>Memory Channelå°†eventså­˜åœ¨å†…å­˜é˜Ÿåˆ—ä¸­ï¼ˆé˜Ÿåˆ—çš„å¤§å°å¯ä»¥åœ¨é…ç½®æ–‡ä»¶ä¸­æŒ‡å®šï¼‰ã€‚Memory Channelä¸»è¦ç”¨éœ€è¦é«˜ååé‡çš„ï¼Œå¹¶å…è®¸å­˜åœ¨ä¸¢å¤±æ•°æ®é£é™©çš„æƒ…å†µä¸‹ã€‚</li><li>File Channelå°†eventså†™å…¥æ–‡ä»¶ä¸­ï¼ŒæŒä¹…åŒ–æ‰€æœ‰äº‹ä»¶ã€‚ä¼˜ç‚¹æ˜¯å®¹é‡è¾ƒå¤§ä¸”æ­»æ‰æ—¶æ•°æ®å¯æ¢å¤ã€‚ç¼ºç‚¹æ˜¯é€Ÿåº¦è¾ƒæ…¢ã€‚</li></ul><h3 id="sink"><a href="#sink" class="headerlink" title="sink"></a>sink</h3><p>sinkå°†eventsä»channelä¸­å–å‡ºï¼Œå¯¼å‘ä¸‹ä¸€ä¸ªagentæˆ–è€…æ–‡ä»¶ç³»ç»Ÿï¼ˆå¯ä»¥æ˜¯hdfsã€kafkaï¼‰ï¼Œå¯ä»¥é’ˆå¯¹ä¸åŒçš„å­˜å‚¨è®¾å¤‡å¼€å‘è‡ªå®šä¹‰çš„sink</p><h2 id="flume-kafkaä½¿ç”¨"><a href="#flume-kafkaä½¿ç”¨" class="headerlink" title="flume+kafkaä½¿ç”¨"></a>flume+kafkaä½¿ç”¨</h2><p>æœ€è¿‘è¦æ­å»ºä¸€ä¸ªæ—¥å¿—åˆ†æå¹³å°ï¼Œæ•´ä½“æ¶æ„æ€è·¯æ˜¯é€šè¿‡flumeé‡‡é›†æ—¥å¿—åˆ°kafkaä¸­ï¼Œä»kafkaä¹‹ååˆ†ä¸¤æ¡è·¯èµ°ï¼Œä¸€æ¡æ˜¯å®æ—¶ï¼Œä¸€æ¡æ˜¯ç¦»çº¿ã€‚å®æ—¶ä¼šç”¨sparkæˆ–è€…stormï¼ˆè¿˜æ²¡å¼€å§‹åšï¼‰ï¼Œç¦»çº¿ç”¨hadoop+hiveï¼Œå°†kafkaä¸­çš„æ•°æ®æ¶ˆè´¹åˆ°hdfsä¸Šï¼Œé€šè¿‡mrå¤„ç†è¿›hiveï¼Œè¿›è¡Œç»Ÿè®¡åˆ†æã€‚æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/Flume/%E6%97%A5%E5%BF%97%E5%88%86%E6%9E%90%E7%B3%BB%E7%BB%9F%E6%9E%B6%E6%9E%84%E5%9B%BE.png" alt="æ—¥å¿—åˆ†æç³»ç»Ÿæ¶æ„å›¾" title="æ—¥å¿—åˆ†æç³»ç»Ÿæ¶æ„å›¾"></p><h3 id="ç¼–è¯‘flume"><a href="#ç¼–è¯‘flume" class="headerlink" title="ç¼–è¯‘flume"></a>ç¼–è¯‘flume</h3><p>ç”±äºéœ€è¦å¯¹kafka sinkè¿›è¡Œç¨å¾®æ”¹åŠ¨æ·»åŠ ä¸€ä¸ªå°†logå†…å®¹æŒ‰éœ€æ‹¼æ¥ä¸ºjsonç„¶åsinkåˆ°kafkaçš„åŠŸèƒ½ï¼Œæ‰€ä»¥è¿™é‡Œä¸‹è½½flumeæºç åŒ…ï¼Œå¯¹å…¶è¿›è¡Œä¿®æ”¹å¹¶ç¼–è¯‘ã€‚æ­¥éª¤å¦‚ä¸‹ï¼š</p><ul><li>ä¿®æ”¹ä»£ç </li></ul><p>æ›´æ”¹KafkaSink.javaä»£ç ï¼Œä¸ºäº†æ‰©å±•æ€§ï¼Œæ–°å»ºä¸€ä¸ªç±»SzwKafkaSink.javaï¼Œå¯¹eventå®ä½“è¿›è¡Œä¿®æ”¹ï¼ŒxxSinkéƒ½ç»§æ‰¿AbstractSinkï¼Œéœ€è¦å®ç°processæ–¹æ³•ï¼Œå…·ä½“çš„å¤„ç†é€»è¾‘ä¹Ÿåœ¨æ­¤æ–¹æ³•ä¸­ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Status <span class="title">process</span><span class="params">()</span> <span class="keyword">throws</span> EventDeliveryException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">long</span> processedEvents = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    transaction = channel.getTransaction();</span><br><span class="line">    transaction.begin();</span><br><span class="line"></span><br><span class="line">    messageList.clear();</span><br><span class="line">    <span class="keyword">for</span> (; processedEvents &lt; batchSize; processedEvents += <span class="number">1</span>) &#123;</span><br><span class="line">      event = channel.take();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (event == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// no events available in channel</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// logå†…å®¹çš„byteæ•°ç»„</span></span><br><span class="line">      <span class="keyword">byte</span>[] eventBody = event.getBody();</span><br><span class="line">      Map&lt;String, String&gt; headers = event.getHeaders();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((eventTopic = headers.get(TOPIC_HDR)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">        eventTopic = topic;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      eventKey = headers.get(KEY_HDR);</span><br><span class="line">   ...</span><br><span class="line">      <span class="comment">// string to json for by szw</span></span><br><span class="line">      <span class="comment">// æ·»åŠ ä¸€ä¸ªæ–¹æ³•ï¼Œå°†string æ ¹æ®éœ€æ±‚æ‹¼æ¥ä¸ºjson</span></span><br><span class="line">      eventBody = SzwKafkaSink.stringToJson(eventBody);</span><br><span class="line">      <span class="keyword">if</span> (eventBody != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// create a message and add to buffer</span></span><br><span class="line">        KeyedMessage&lt;String, <span class="keyword">byte</span>[]&gt; data = <span class="keyword">new</span> KeyedMessage&lt;String, <span class="keyword">byte</span>[]&gt;</span><br><span class="line">                (eventTopic, eventKey, eventBody);</span><br><span class="line">        messageList.add(data);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// publish batch and commit.</span></span><br><span class="line">    <span class="keyword">if</span> (processedEvents &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">long</span> startTime = System.nanoTime();</span><br><span class="line">      <span class="comment">// è°ƒç”¨kafka api å‘é€events</span></span><br><span class="line">      producer.send(messageList);</span><br><span class="line">      <span class="keyword">long</span> endTime = System.nanoTime();</span><br><span class="line">      counter.addToKafkaEventSendTimer((endTime-startTime)/(<span class="number">1000</span>*<span class="number">1000</span>));</span><br><span class="line">      counter.addToEventDrainSuccessCount(Long.valueOf(messageList.size()));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    transaction.commit();</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception ex) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">byte</span>[] stringToJson(<span class="keyword">byte</span>[] bytes) <span class="keyword">throws</span> UnsupportedEncodingException &#123;</span><br><span class="line">  String str = <span class="keyword">new</span> String(bytes, <span class="string">&quot;UTF-8&quot;</span>);</span><br><span class="line">  Map&lt;String, Object&gt; map = <span class="keyword">new</span> HashMap&lt;String, Object&gt;();</span><br><span class="line">  String[] array = &#123;&#125;;</span><br><span class="line">  <span class="keyword">int</span> index = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">if</span> ((index = str.indexOf(<span class="string">&quot;[SESSIONID-&quot;</span>)) &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">    str = str.substring(index + <span class="number">1</span>);</span><br><span class="line">    array = str.split(<span class="string">&quot;\\] \\[&quot;</span>);</span><br><span class="line">    <span class="keyword">int</span> len = array.length;</span><br><span class="line">    array[len-<span class="number">1</span>] = array[len-<span class="number">1</span>].substring(<span class="number">0</span>, array[len-<span class="number">1</span>].length()-<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;len; i++)&#123;</span><br><span class="line">      String[] kvArr = array[i].split(<span class="string">&quot;-&quot;</span>, <span class="number">2</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        map.put(kvArr[<span class="number">0</span>], <span class="keyword">new</span> JSONObject(kvArr[<span class="number">1</span>]));</span><br><span class="line">      &#125; <span class="keyword">catch</span> (JSONException e) &#123;</span><br><span class="line">        map.put(kvArr[<span class="number">0</span>], kvArr[<span class="number">1</span>]);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (map.size() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    JSONObject json = <span class="keyword">new</span> JSONObject(map);</span><br><span class="line">    <span class="keyword">return</span> json.toString().getBytes();</span><br><span class="line">  &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºå°†stringæ‹¼æ¥ä¸ºjsonéœ€è¦ä¾èµ–jsonçš„jaråŒ…ï¼Œåˆ™å°†æ‰€ä¾èµ–çš„jaråŒ…æ·»åŠ åˆ°mavençš„pomæ–‡ä»¶ä¸­ï¼Œå¦åˆ™éšåçš„mvnè¿‡ç¨‹ä¸­ä¼šå‘ç”Ÿé”™è¯¯ã€‚pomæ–‡ä»¶ä½äºflume-ng-kafka-sinkç›®å½•ä¸‹ï¼Œæ·»åŠ å†…å®¹å¦‚ä¸‹ï¼Œversionå¯ä»¥å»mavenç½‘ç«™ä¸ŠæŸ¥æ‰¾åˆ«çš„ç‰ˆæœ¬ã€‚</p><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.json<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>json<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">version</span>&gt;</span>20090211<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure><ul><li>ç¼–è¯‘flume</li></ul><p>åœ¨å‘½ä»¤è¡Œè¾“å…¥<code>mvn clean install -DskipTests</code>ï¼Œå¦‚æœæŠ¥oomçš„é”™è¯¯ï¼Œåˆ™è¾“å…¥<code>export MAVEN_OPTS=&quot;-Xmx1024m -XX:MaxPermSize=512m&quot;</code>ï¼Œç„¶åå†æ¬¡æ‰§è¡Œmvnå‘½ä»¤ã€‚</p><!-- mvn clean package -DskipTests ä¸æ£€æŸ¥æ ¼å¼--><h3 id="éƒ¨ç½²flume"><a href="#éƒ¨ç½²flume" class="headerlink" title="éƒ¨ç½²flume"></a>éƒ¨ç½²flume</h3><p>è§£å‹ç¼–è¯‘å¥½çš„flumeï¼Œåœ¨å…¶homeç›®å½•ä¸‹çš„confæ–‡ä»¶å¤¹ä¸­çš„<em>flume-env.sh</em>æ–‡ä»¶ä¸­è®¾ç½®ä¸‹<code>$JAVA_HOME</code>ã€‚</p><p>ä¾ç„¶åœ¨confæ–‡ä»¶å¤¹ä¸­æ–°å»ºä¸€ä¸ªconfæ–‡ä»¶ï¼Œåœ¨å…¶å†…è®¾ç½®sourceã€channelå’Œsinkç›¸å…³é…ç½®ï¼Œæ­¤å¤„æ˜¯è¦å°†logæ–‡ä»¶sinkåˆ°kafkaä¸­ï¼Œåˆ™åˆ›å»º_flume-kafka.conf_æ–‡ä»¶ï¼Œæ–‡ä»¶å†…å®¹å¦‚ä¸‹ï¼š</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">agent1.sources = r1</span><br><span class="line">agent1.channels = c1</span><br><span class="line">agent1.sinks = k1</span><br><span class="line"><span class="meta">#</span><span class="bash"> For each one of the sources, the <span class="built_in">type</span> is defined</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> execSource è¯»å–æŸä¸ª<span class="built_in">log</span>æ–‡æœ¬</span></span><br><span class="line">agent1.sources.r1.type = exec</span><br><span class="line">agent1.sources.r1.command=tail -f /home/hadoop/flume-test-log/flumetest.log</span><br><span class="line"><span class="meta">#</span><span class="bash"> å¦‚æœ<span class="built_in">command</span>ä¸­æœ‰ç®¡é“ç¬¦ ä¾‹å¦‚ tail -f /home/hadoop/flume-test-log/flumetest.log | grep xx</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> åˆ™åŠ ä¸Šä¸‹é¢çš„å±æ€§</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> agent1.sources.r1.shell = /bin/bash -c</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> The channel can be defined as follows.</span></span><br><span class="line">agent1.sources.r1.channels = c1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Each sink<span class="string">&#x27;s type must be defined</span></span></span><br><span class="line">agent1.sinks.k1.type = org.apache.flume.sink.kafka.SzwKafkaSink</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">agent1.sinks.k1.type = org.apache.flume.sink.kafka.KafkaSink</span></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> kafka topic</span></span></span><br><span class="line">agent1.sinks.k1.topic = test</span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> kafka åœ°å€</span></span></span><br><span class="line">agent1.sinks.k1.brokerList = 127.0.0.1:9092</span><br><span class="line">agent1.sinks.k1.requiredAcks = 1</span><br><span class="line">agent1.sinks.k1.batchSize = 50</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string">Specify the channel the sink should use</span></span></span><br><span class="line">agent1.sinks.k1.channel = c1</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"><span class="string"> Each channel&#x27;</span>s <span class="built_in">type</span> is defined.</span></span><br><span class="line">agent1.channels.c1.type = memory</span><br><span class="line"><span class="meta"></span></span><br><span class="line"><span class="meta">#</span><span class="bash"> Other config values specific to each <span class="built_in">type</span> of channel(sink or <span class="built_in">source</span>)</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> can be defined as well</span></span><br><span class="line"><span class="meta">#</span><span class="bash"> In this <span class="keyword">case</span>, it specifies the capacity of the memory channel</span></span><br><span class="line">agent1.channels.c1.capacity = 1000</span><br><span class="line">agent1.channels.c1.transactionCapacity = 100</span><br></pre></td></tr></table></figure><h3 id="è¿è¡Œflume-agent"><a href="#è¿è¡Œflume-agent" class="headerlink" title="è¿è¡Œflume agent"></a>è¿è¡Œflume agent</h3><blockquote><p>è¿è¡ŒFlume agentå¯ä»¥ä½¿ç”¨<code>supervise</code>ï¼Œå‘½ä»¤å¯åŠ¨ï¼Œè¿™æ ·å½“agentæŒ‚æ‰ä¹‹åä¼šè‡ªåŠ¨é‡å¯agentã€‚</p></blockquote><p>åœ¨è¿è¡Œå‘½ä»¤ä¹‹å‰æœ€å¥½ç°åœ¨kafkaé›†ç¾¤ä¸Šåˆ›å»ºå¥½topicï¼Œåˆ›å»ºå‘½ä»¤<code>bin/kafka-topics.sh --create --zookeeper hadoop02:2181/kafka --replication-factor 1 --partitions 1 --topic szwtest</code>ï¼Œå¦åˆ™ä¼šè‡ªåŠ¨åˆ›å»ºä¸€ä¸ªtopicï¼Œ<em>replication-factor</em>å’Œ<em>partitions</em>ä¼šè¿›è¡Œé»˜è®¤è®¾ç½®ï¼Œéƒ½æ˜¯1ã€‚<br>å‘½ä»¤è¡Œè¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bin/flume-ng agent --conf conf/ -f conf/flume-kafka.conf -n agent1 -Dflume.root.logger=DEBUG,console</span><br></pre></td></tr></table></figure><p>åå°è¿è¡Œ</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nohup bin/flume-ng agent --conf conf/ -f conf/flume-kafka.conf -n agent1 &gt;out.log &amp;</span><br></pre></td></tr></table></figure><h2 id="Flumeç®€å•æ€§èƒ½æµ‹è¯•"><a href="#Flumeç®€å•æ€§èƒ½æµ‹è¯•" class="headerlink" title="Flumeç®€å•æ€§èƒ½æµ‹è¯•"></a>Flumeç®€å•æ€§èƒ½æµ‹è¯•</h2><ul><li>å†™ä¸ªshellè„šæœ¬å¾ªç¯å¾€logé‡Œæ’å…¥æ–‡æœ¬1ç™¾ä¸‡æ¡ï¼ˆå¤§æ¦‚ä¸åˆ°3åˆ†é’Ÿæ’å®Œï¼‰</li><li>åœ¨æ’å…¥çš„è¿‡ç¨‹ä¸­å¯åŠ¨agentæ”¶é›†æ—¥å¿—ï¼ˆå…ˆæœ‰logæ–‡æœ¬å†å¯åŠ¨agentï¼Œå¤§æ¦‚3åˆ†é’Ÿå¤šç‚¹æ”¶é›†ç»“æŸï¼‰</li></ul><blockquote><p>æ”¶é›†logä½¿ç”¨çš„linuxå‘½ä»¤<code>tail -f xx.log</code>ï¼Œå¦‚æœå…ˆå¯åŠ¨agentï¼Œlogæ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨tailå‘½ä»¤å°±æ— æ³•è¯»å–å†…å®¹ï¼Œagentä¹Ÿå°±æ•è·ä¸åˆ°æ ‡å‡†è¾“å‡ºï¼Œä¸è¿‡å¯ä»¥ä½¿ç”¨<code>tail --follow=name --retry xx.log</code>ï¼Œè¿™æ ·å½“logä¸å­˜åœ¨æ—¶å°±ä¼šè¿›è¡Œé‡è¯•ã€‚</p></blockquote><p>æµ‹è¯•ç»“æœå¦‚ä¸‹ï¼š<br><img src="/blogimgs/Flume/info11.png" alt="cpu/memç»“æœå›¾1" title="cpu/memç»“æœå›¾1"><br><img src="/blogimgs/Flume/info21.png" alt="cpu/memç»“æœå›¾2" title="cpu/memç»“æœå›¾2"><br><img src="/blogimgs/Flume/info31.png" alt="cpu/memç»“æœå›¾3" title="cpu/memç»“æœå›¾3"><br>æœºå™¨é…ç½®ä¸ºè™šæ‹Ÿæœº8æ ¸ã€8Gå†…å­˜ã€‚</p><p>æ­¤æ¬¡æµ‹è¯•ä¹Ÿå°±æ˜¯3minså·¦å³çš„æ—¶é—´å†™å…¥1000000æ¡logï¼Œagentè¿›è¡Œå®æ—¶æ”¶é›†æ—¶ä½¿ç”¨çš„cpuå’Œmemæƒ…å†µã€‚<br>agentçš„å †å†…å­˜çš„è®¾ç½®æ˜¯<code>export JAVA_OPTS=&quot;-Xms256m -Xmx512m&quot;</code><br>åœ¨æ­¤è¿‡ç¨‹ä¸­çœ‹å‡ºcpuæ¯”è¾ƒå¹³ç¼“ï¼Œç»´æŒåœ¨5%ä»¥ä¸‹ï¼Œä½¿ç”¨çš„å †å¤§å°ç»´æŒåœ¨100Mä»¥ä¸‹ï¼Œä½†æ˜¯åœ¨agentå¯åŠ¨åˆæœŸcpuå’Œmemä¼šæœ‰ä¸€ä¸ªæ¯”è¾ƒå¤§çš„æ³¢åŠ¨ï¼Œå¯èƒ½æ˜¯å› ä¸ºå¯åŠ¨åˆæœŸä¼šæœ‰å¤§é‡çš„logè¿›å…¥å†…å­˜ï¼Œéšåéšç€sinkçš„æ¶ˆè´¹cpuæ¶ˆè€—å¤„äºå¹³ç¼“çŠ¶æ€ï¼Œmemä¼šæœ‰æ‰€æ³¢åŠ¨ä½†ä¼šç»´æŒåœ¨100Mä»¥ä¸‹ã€‚</p><p>cpuå’Œmemçš„ä¿¡æ¯æ˜¯ç”¨jvisualvm.exeç›‘æ§çš„ï¼Œåœ¨_flume-env.sh_ä¸­åŠ å…¥<br><code>export JAVA_OPTS=&quot;-Dcom.sun.management.jmxremote.port=9999 -Dcom.sun.management.jmxremote.ssl=false -Dcom.sun.management.jmxremote.authenticate=false&quot;</code>ã€‚</p><h2 id="è¿œç¨‹debugè°ƒå¼flume-agent"><a href="#è¿œç¨‹debugè°ƒå¼flume-agent" class="headerlink" title="è¿œç¨‹debugè°ƒå¼flume agent"></a>è¿œç¨‹debugè°ƒå¼flume agent</h2><ul><li>å°†flumeæºç å¯¼å…¥ideä¸­ï¼ˆæˆ‘å¯¼å…¥çš„æ˜¯intellij ideaï¼‰</li><li>åœ¨flumeéƒ¨ç½²ç›®å½•çš„binä¸‹æ‰¾åˆ°flume-ngæ–‡ä»¶ï¼Œåœ¨<code>run_flume()</code>ä¸­æ·»åŠ å¦‚ä¸‹ä»£ç ï¼š<br><code>FLUME_JAVA_OPTS=&quot;-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=8000&quot;</code></li><li>åœ¨ideä¸­è¿›è¡Œè¿œç¨‹debug</li></ul><p>æ›´å¤šFlumeå†…å®¹æŸ¥çœ‹<a href="http://flume.apache.org/FlumeUserGuide.html#flume-channel-selectors">å®˜ç½‘ç”¨æˆ·æ‰‹å†Œ</a></p><hr><p>agent1.sources.avro-source1.command = /usr/local/bin/tail  -n +$(tail -n1 /home/storm/tmp/n) â€“max-unchanged-stats=600 -F  /home/storm/tmp/id.txt | awk â€˜ARNGIND==1{i=$0;next}{i++; if($0~/æ–‡ä»¶å·²æˆªæ–­/)i=0; print i &gt;&gt; â€œ/home/storm/tmp/nâ€;print $1â€â€”â€œi}â€™ /home/storm/tmp/n -</p>]]></content>
      
      
      <categories>
          
          <category> Flume </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> log </tag>
            
            <tag> Flume </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å†è®®HDFSå†™æµç¨‹ä¹‹pipeline</title>
      <link href="/%E5%86%8D%E8%AE%AEHDFS%E5%86%99%E6%B5%81%E7%A8%8B%E4%B9%8Bpipeline.html"/>
      <url>/%E5%86%8D%E8%AE%AEHDFS%E5%86%99%E6%B5%81%E7%A8%8B%E4%B9%8Bpipeline.html</url>
      
        <content type="html"><![CDATA[<p>ä¹‹å‰æœ‰ä¸€ç¯‡æ˜¯ä»‹ç»HDFSå†™æµç¨‹çš„ï¼Œåªæ˜¯å¤§è‡´çš„ä»ä»£ç çš„è§’åº¦è§£æäº†ä¸‹ï¼Œæœ‰äº›ç»†èŠ‚å¹¶æ²¡æœ‰æ·±æŒ–ï¼Œè¿™ç¯‡æ–‡ç« æˆ‘ä»¬ä¸»è¦æ¥æŒ–ä¸‹å†™æµç¨‹ä¸­çš„ä¸€äº›ç»†èŠ‚ï¼Œä½†æ˜¯ç”±äºæˆ‘æ°´å¹³æœ‰é™ï¼Œåªèƒ½å°½å¯èƒ½çš„æŒ–ï¼Œæœ¬ç¯‡ä¹Ÿä¼šä¸å®šæ—¶çš„è¿›è¡Œæ‰“è¡¥ä¸ã€‚</p><p>è¿™é‡Œé‡ç‚¹æ€»ç»“ä¸‹å¼€å§‹å¾€pipelineä¸­å†™æ•°æ®åˆ°ä¸€ä¸ªblockç»“æŸå…³é—­pipelineçš„æµç¨‹ã€‚æƒ³å…ˆäº†è§£ä¸‹HDFS writeæµç¨‹çš„è¯·çœ‹[è¿™ç¯‡](<a href="http://bigdatadecode.top/HDFS">http://bigdatadecode.top/HDFS</a> writeè§£æ.html)</p><p>è¿™é‡Œå…ˆåˆ—ä¸‹æƒ³è¦æ€»ç»“çš„çŸ¥è¯†ç‚¹ï¼š</p><ul><li>leaseæ£€æŸ¥å‘ç”Ÿåœ¨å“ªï¼ŸcreateFileæ—¶åˆ›å»ºleaseï¼Œä¸¤ä¸ªçº¿ç¨‹èƒ½å¦åŒæ—¶åˆ›å»ºåŒä¸€ä¸ªæ–‡ä»¶ï¼Ÿleaseæ£€æŸ¥åªåœ¨addBlockä¸­å‘ç”Ÿï¼Ÿæ˜¯å¦ä¼šåˆ¤æ–­leaseçš„å½“å‰æŒæœ‰è€…æ˜¯å¦ç»§ç»­æŒæœ‰</li><li>clientæˆ–è€…dnä½•æ—¶å‘nnæ±‡æŠ¥Replicaæˆ–è€…Blockçš„çŠ¶æ€</li><li>pipelineæ˜¯æ€ä¹ˆå»ºç«‹çš„ï¼Œtargets dnæ˜¯æ€ä¹ˆä¼ é€’çš„</li><li>pipelineåœ¨setupé˜¶æ®µå‘ç”Ÿæ•…éšœæ€ä¹ˆåŠï¼Œclientå¦‚ä½•æ£€æµ‹ï¼Œå¦‚ä½•ä¿®å¤</li><li>pipelineåœ¨streamé˜¶æ®µå‘ç”Ÿæ•…éšœæ€ä¹ˆåŠï¼Œclientå¦‚ä½•æ£€æµ‹ï¼Œå¦‚ä½•ä¿®å¤</li><li>pipelineåœ¨closeé˜¶æ®µå‘ç”Ÿæ•…éšœæ€ä¹ˆåŠï¼Œclientå¦‚ä½•æ£€æµ‹ï¼Œå¦‚ä½•ä¿®å¤</li><li>pipelineä¸­æŸä¸ªdnå‘ç”Ÿæ•…éšœï¼Œæ˜¯å¦éœ€è¦replace dnï¼ŒreplaceåŸåˆ™</li><li>pipeline recoveryã€block recoveryå’Œlease recoveryçš„å…³ç³»ï¼ŒåŠå„ä¸ªrecoveryå‘ç”Ÿçš„æ—¶é—´ç‚¹ã€ç”±è°ä¸»å¯¼ï¼Ÿ</li><li>Replicaå’ŒBlockçš„çŠ¶æ€æ˜¯æ€ä¹ˆå˜åŒ–çš„ï¼ŒReplicaçš„çŠ¶æ€åˆæ˜¯æ€ä¹ˆå½±å“Blockçš„çŠ¶æ€çš„ã€‚</li><li>pipelineä¸­ä»€ä¹ˆæ•…éšœä¼šå‘ä¸Šæ¸¸å‘é€ackç„¶åå…³é—­å½“å‰dnçš„ç½‘ç»œè¿æ¥ï¼Œæ˜¯è°å…³é—­dnçš„è¿æ¥(<em>dnåœ¨DataXceiver.writeBlockçš„finallyä¸­å…³é—­è¿æ¥</em>)ï¼Ÿdnè‡ªå·±è¿˜æ˜¯clientï¼Ÿ</li></ul><p>ä¹‹æ‰€ä»¥è¦æŠŠçŸ¥è¯†ç‚¹åˆ—å‡ºæ¥ï¼Œæ˜¯å› ä¸ºè¿™äº›çŸ¥è¯†ç‚¹ä¸ä¸€å®šèƒ½ä¸€æ¬¡ææ¸…æ¥šï¼Œé¿å…ä»¥åå¿˜äº†æ›´æ–°ä»€ä¹ˆçŸ¥è¯†ç‚¹ã€‚</p><span id="more"></span><h2 id="leaseæ£€æŸ¥å‘ç”Ÿåœ¨å“ª"><a href="#leaseæ£€æŸ¥å‘ç”Ÿåœ¨å“ª" class="headerlink" title="leaseæ£€æŸ¥å‘ç”Ÿåœ¨å“ª"></a>leaseæ£€æŸ¥å‘ç”Ÿåœ¨å“ª</h2><p>HDFSæ˜¯é€šè¿‡leaseæ¥é˜²æ­¢å¹¶å‘å†™ï¼Œå®ç°å†™é”åŠŸèƒ½çš„ã€‚</p><p>HDFS writeåœ¨open FSDataOutputStreamæ—¶å‘NNç”³è¯·leaseï¼Œå¹¶åœ¨å¾—åˆ°leaseä¹‹åï¼Œç”±clientè°ƒç”¨LeaseReneweræ¥ç»­çº¦ã€‚è¦æƒ³é˜²æ­¢å¹¶å‘å†™ï¼Œåˆ™éœ€è¦åœ¨clientåœ¨å†™æ•°æ®æ—¶åˆ¤æ–­æ˜¯å¦æŒæœ‰è¯¥æ–‡ä»¶çš„leaseï¼Œé‚£ä¹ˆè¿™ä¸ªleaseçš„æ£€æŸ¥éƒ½å‘ç”Ÿåœ¨å“ªé‡Œå‘¢ï¼Ÿ</p><h3 id="addFile"><a href="#addFile" class="headerlink" title="addFile"></a>addFile</h3><p>åœ¨HDFS writeä»£ç è·Ÿè¯»ä¸­å‘ç°ï¼Œåœ¨ç”³è¯·leaseæ—¶å¹¶æ²¡æœ‰è¿›è¡Œleaseçš„æ£€æŸ¥(æ²¡æœ‰æ£€æŸ¥è¯¥æ–‡ä»¶çš„leaseæ˜¯å¦å·²è¢«åˆ«çš„clientæ‰€æŒæœ‰)ï¼Œè¿™æ ·å¦‚æœæœ‰ä¸¤ä¸ªclientå¯¹åŒä¸€ä¸ªæ–‡ä»¶è¿›è¡Œopen FSDataOutputStreamæ—¶ï¼Œèƒ½å¦æˆåŠŸï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿï¼Ÿ</p><p>ç”³è¯·leaseçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BlocksMapUpdateInfo <span class="title">startFileInternal</span><span class="params">(FSPermissionChecker pc, </span></span></span><br><span class="line"><span class="params"><span class="function">    String src, PermissionStatus permissions, String holder, </span></span></span><br><span class="line"><span class="params"><span class="function">    String clientMachine, <span class="keyword">boolean</span> create, <span class="keyword">boolean</span> overwrite, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> isLazyPersist, CipherSuite suite, CryptoProtocolVersion version,</span></span></span><br><span class="line"><span class="params"><span class="function">    EncryptedKeyVersion edek, <span class="keyword">boolean</span> logRetryEntry)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> FileAlreadyExistsException, AccessControlException,</span></span><br><span class="line"><span class="function">    UnresolvedLinkException, FileNotFoundException,</span></span><br><span class="line"><span class="function">    ParentNotDirectoryException, RetryStartFileException, IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    BlocksMapUpdateInfo toRemoveBlocks = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// myFileä¸ºnullï¼Œä¹Ÿå°±æ˜¯srcä¸å­˜åœ¨æ—¶ï¼Œæ­¤æ—¶createä¸ºtrue</span></span><br><span class="line">    <span class="keyword">if</span> (myFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!create) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">&quot;Can&#x27;t overwrite non-existent &quot;</span> +</span><br><span class="line">            src + <span class="string">&quot; for client &quot;</span> + clientMachine);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// myFileä¸ä¸ºnullï¼Œä¹Ÿå°±æ˜¯è¯´srcå·²ç»å­˜åœ¨ï¼Œåˆ™é‡å†™</span></span><br><span class="line">      <span class="comment">// overwriteæ—¶ä¸åº”è¯¥æ£€æŸ¥ä¸‹è¯¥clientæ˜¯å¦æŒæœ‰è¯¥æ–‡ä»¶çš„leaseå—ï¼Ÿ</span></span><br><span class="line">      <span class="keyword">if</span> (overwrite) &#123;</span><br><span class="line">        toRemoveBlocks = <span class="keyword">new</span> BlocksMapUpdateInfo();</span><br><span class="line">        List&lt;INode&gt; toRemoveINodes = <span class="keyword">new</span> ChunkedArrayList&lt;INode&gt;();</span><br><span class="line">        <span class="keyword">long</span> ret = dir.delete(src, toRemoveBlocks, toRemoveINodes, now());</span><br><span class="line">        <span class="keyword">if</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          incrDeletedFileCount(ret);</span><br><span class="line">          removePathAndBlocks(src, <span class="keyword">null</span>, toRemoveINodes, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If lease soft limit time is expired, recover the lease</span></span><br><span class="line">        recoverLeaseInternal(myFile, src, holder, clientMachine, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileAlreadyExistsException(src + <span class="string">&quot; for client &quot;</span> +</span><br><span class="line">            clientMachine + <span class="string">&quot; already exists&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥HDFSä¸­çš„object(inode+block)æ˜¯å¦è¾¾åˆ°ä¸Šé™</span></span><br><span class="line">    checkFsObjectLimit();</span><br><span class="line">    INodeFile newNode = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always do an implicit mkdirs for parent directory tree.</span></span><br><span class="line">    Path parent = <span class="keyword">new</span> Path(src).getParent();</span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span> &amp;&amp; mkdirsRecursively(parent.toString(),</span><br><span class="line">            permissions, <span class="keyword">true</span>, now())) &#123;</span><br><span class="line">      <span class="comment">// addFileåˆ°namespaceï¼Œè¿™æœŸé—´ä¼šåˆ¤æ–­Quota</span></span><br><span class="line">      newNode = dir.addFile(src, permissions, replication, blockSize,</span><br><span class="line">                            holder, clientMachine);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// å°†fileæ·»åŠ åˆ°namespaceä¸­ä¹‹åï¼Œç”³è¯·lease</span></span><br><span class="line">    leaseManager.addLease(newNode.getFileUnderConstructionFeature()</span><br><span class="line">        .getClientName(), src);</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢çš„ä»£ç å¯çŸ¥clientåœ¨openä¸€ä¸ªfileçš„è¾“å‡ºæµæ—¶ï¼Œå¹¶æ²¡æœ‰è¿›è¡Œleaseæ£€æŸ¥(ç›®å‰æœªå‘ç°)ï¼Œåªæ˜¯åˆ¤æ–­å½“å‰fileæ˜¯è¿›è¡Œcreateè¿˜æ˜¯overwriteï¼Œç„¶åè¿›è¡ŒnamespaceçŠ¶æ€çš„æ›´æ–°ï¼Œæœ€åè¿›è¡Œç”³è¯·leaseã€‚</p><p>é‚£ä¹ˆå½“clientAæ‰“å¼€fileAæ–‡ä»¶çš„è¾“å‡ºæµè¿›è¡Œå†™æ•°æ®æ—¶ï¼ŒclientBä¹Ÿå‘å‡ºäº†è¯·æ±‚æ¥æ‰“å¼€fileAæ–‡ä»¶çš„è¾“å‡ºæµï¼Œæ­¤æ—¶fileAå·²ç»å­˜åœ¨ï¼Œåˆ™è¿›è¡Œoverwriteï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­ï¼Œæ²¡æœ‰è¿›è¡Œä»»ä½•leaseçš„æ£€æŸ¥ï¼ŒclientBèƒ½å¤Ÿå°†clientAå·²ç»å†™å…¥fileAä¸­çš„æ•°æ®è¦†ç›–æ‰(ä¹Ÿå°±æ˜¯æŠŠå·²ç»å†™å…¥çš„æ•°æ®è°ƒç”¨dir.deleteåˆ é™¤ï¼Œå¹¶ä¸”deleteæ—¶ä¹Ÿæ²¡æœ‰æ¶‰åŠleaseæ£€æŸ¥)ï¼Œ*éšååˆä¼šé€šè¿‡addLeaseå¾—åˆ°clientBå…³äºfileAçš„lease(æ­¤æ—¶clientAæŒæœ‰clientAå…³äºfileAçš„lease)*ã€‚</p><p>leaseåœ¨LeaseManagerä¸­æ˜¯ä»¥æŒæœ‰è€…æ¥åŒºåˆ†çš„ï¼ŒclientAå’ŒclientBæ˜¯ä¸åŒçš„æŒæœ‰è€…ï¼Œåˆ™åœ¨å„è‡ªçš„leaseä¸­éƒ½ä¿ç•™è¿™fileAçš„pathã€‚</p><p><strong>è¿™ç§æƒ…å†µHDFSå…·ä½“æ˜¯æ€ä¹ˆå¤„ç†çš„ï¼Ÿæœ‰æ—¶é—´æ‰¾ä¸ªåˆé€‚çš„ä¾‹å­å»æµ‹è¯•ä¸‹ã€‚ã€‚ã€‚</strong></p><h3 id="addBlock"><a href="#addBlock" class="headerlink" title="addBlock"></a>addBlock</h3><p>ä¸Šé¢åˆ†æäº†ä¸‹addFileæ—¶leaseç›¸å…³çš„æ“ä½œï¼Œä¸‹é¢è§£æä¸‹addBlockæ—¶è¿›è¡Œçš„leaseæ£€æŸ¥ã€‚</p><p>blockæ˜¯é€šè¿‡pipelineå†™å…¥dnçš„ï¼Œå½“éœ€è¦addBlockæ—¶ï¼ŒDataStreamerä¼šåˆ›å»ºä¸€ä¸ªpipelineï¼Œpipelineçš„åˆ›å»ºæœŸé—´è¿›è¡Œleaseæ£€æŸ¥ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FSNamesystem.java</span></span><br><span class="line"><span class="function">FileState <span class="title">analyzeFileState</span><span class="params">(String src,</span></span></span><br><span class="line"><span class="params"><span class="function">                              <span class="keyword">long</span> fileId,</span></span></span><br><span class="line"><span class="params"><span class="function">                              String clientName,</span></span></span><br><span class="line"><span class="params"><span class="function">                              ExtendedBlock previous,</span></span></span><br><span class="line"><span class="params"><span class="function">                              LocatedBlock[] onRetryBlock)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException  </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// checkLeaseè¿›è¡Œleaseæ£€æŸ¥</span></span><br><span class="line">  <span class="keyword">final</span> INodeFile pendingFile = checkLease(src, clientName, inode, fileId);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> INodeFile <span class="title">checkLease</span><span class="params">(String src, String holder, INode inode,</span></span></span><br><span class="line"><span class="params"><span class="function">                             <span class="keyword">long</span> fileId)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> LeaseExpiredException, FileNotFoundException </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">assert</span> <span class="title">hasReadLock</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="keyword">final</span> String ident = src + <span class="string">&quot; (inode &quot;</span> + fileId + <span class="string">&quot;)&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (inode == <span class="keyword">null</span>) &#123;</span><br><span class="line">    Lease lease = leaseManager.getLease(holder);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LeaseExpiredException(</span><br><span class="line">        <span class="string">&quot;No lease on &quot;</span> + ident + <span class="string">&quot;: File does not exist. &quot;</span></span><br><span class="line">        + (lease != <span class="keyword">null</span> ? lease.toString()</span><br><span class="line">            : <span class="string">&quot;Holder &quot;</span> + holder + <span class="string">&quot; does not have any open files.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!inode.isFile()) &#123;</span><br><span class="line">    Lease lease = leaseManager.getLease(holder);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LeaseExpiredException(</span><br><span class="line">        <span class="string">&quot;No lease on &quot;</span> + ident + <span class="string">&quot;: INode is not a regular file. &quot;</span></span><br><span class="line">            + (lease != <span class="keyword">null</span> ? lease.toString()</span><br><span class="line">            : <span class="string">&quot;Holder &quot;</span> + holder + <span class="string">&quot; does not have any open files.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> INodeFile file = inode.asFile();</span><br><span class="line">  <span class="keyword">if</span> (!file.isUnderConstruction()) &#123;</span><br><span class="line">    Lease lease = leaseManager.getLease(holder);</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LeaseExpiredException(</span><br><span class="line">        <span class="string">&quot;No lease on &quot;</span> + ident + <span class="string">&quot;: File is not open for writing. &quot;</span></span><br><span class="line">        + (lease != <span class="keyword">null</span> ? lease.toString()</span><br><span class="line">            : <span class="string">&quot;Holder &quot;</span> + holder + <span class="string">&quot; does not have any open files.&quot;</span>));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// No further modification is allowed on a deleted file.</span></span><br><span class="line">  <span class="comment">// A file is considered deleted, if it is not in the inodeMap or is marked</span></span><br><span class="line">  <span class="comment">// as deleted in the snapshot feature.</span></span><br><span class="line">  <span class="keyword">if</span> (isFileDeleted(file)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(src);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é€šè¿‡fileå¾—åˆ°è¯¥fileçš„clientNameï¼Œåˆ¤æ–­æ˜¯å¦æŒæœ‰è¯¥lease</span></span><br><span class="line">  <span class="comment">// é‚£ä¹ˆä¸Šé¢çš„æƒ…å†µï¼Œfileä¼šæœ‰ä¸¤ä¸ªclientNameï¼Ÿè¿™è‚¯å®šä¸ä¼šå‡ºç°ï¼Œä½†åœ¨å“ªè¿›è¡Œçš„å¤„ç†å‘¢ï¼Ÿï¼Ÿ</span></span><br><span class="line">  String clientName = file.getFileUnderConstructionFeature().getClientName();</span><br><span class="line">  <span class="keyword">if</span> (holder != <span class="keyword">null</span> &amp;&amp; !clientName.equals(holder)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> LeaseExpiredException(<span class="string">&quot;Lease mismatch on &quot;</span> + ident +</span><br><span class="line">        <span class="string">&quot; owned by &quot;</span> + clientName + <span class="string">&quot; but is accessed by &quot;</span> + holder);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> file;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><ul><li>pipelineæ˜¯æ€ä¹ˆå»ºç«‹çš„ï¼Œtargets dnæ˜¯æ€ä¹ˆä¼ é€’çš„</li><li>pipelineåœ¨setupé˜¶æ®µå‘ç”Ÿæ•…éšœæ€ä¹ˆåŠï¼Œclientå¦‚ä½•æ£€æµ‹ï¼Œå¦‚ä½•ä¿®å¤</li></ul><h2 id="pipeline-setup-amp-error"><a href="#pipeline-setup-amp-error" class="headerlink" title="pipeline setup &amp; error"></a>pipeline setup &amp; error</h2><h3 id="pipeline-setup"><a href="#pipeline-setup" class="headerlink" title="pipeline setup"></a>pipeline setup</h3><p>HDFSå†™æ•°æ®æ—¶æ˜¯å…ˆå°†æ•°æ®å†™å…¥æœ¬åœ°bufä¸­ï¼Œbufå†™æ»¡ä¹‹åå†™å…¥packetä¸­ï¼Œpacketå†™æ»¡ä¹‹åæ”¾å…¥dataQueueï¼Œé€šçŸ¥DataStreamerå»æ¶ˆè´¹ï¼Œæ­¤æ—¶DataStreamerå‘ç°pipelineçš„çŠ¶æ€æ˜¯<em>PIPELINE_SETUP_CREATE</em>ï¼Œåˆ™å¼€å§‹åˆ›å»ºpipelineã€‚åˆ›å»ºpipelineæ—¶ä¼šå‘NNç”³è¯·addBlockï¼ŒNNä¼šè¿”å›blockçš„locationsä¿¡æ¯ï¼Œç„¶åæ ¹æ®locationsä¿¡æ¯åˆ›å»ºpipelineã€‚</p><p>pipelineçš„é•¿åº¦é»˜è®¤æ˜¯3(å‰¯æœ¬å› å­ä¸ªæ•°)ï¼Œåœ¨clientç«¯é€šè¿‡<code>createBlockOutputStream</code>ä¸pipelineä¸­çš„ç¬¬ä¸€ä¸ªdnå»ºç«‹è¿æ¥<em>å¹¶ç­‰å¾…dnå‘é€å›æ¥çš„connect-ack</em>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">createBlockOutputStream</span><span class="params">(DatanodeInfo[] nodes,</span></span></span><br><span class="line"><span class="params"><span class="function">    StorageType[] nodeStorageTypes, <span class="keyword">long</span> newGS, <span class="keyword">boolean</span> recoveryFlag)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    DataOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// ä¸ç¬¬ä¸€ä¸ªdnå»ºç«‹httpè¿æ¥</span></span><br><span class="line">      s = createSocketForPipeline(nodes[<span class="number">0</span>], nodes.length, dfsClient);</span><br><span class="line">      <span class="keyword">long</span> writeTimeout = dfsClient.getDatanodeWriteTimeout(nodes.length);</span><br><span class="line">      <span class="comment">// å‘ä¸‹æ¸¸å‘é€è¯·æ±‚</span></span><br><span class="line">      OutputStream unbufOut = NetUtils.getOutputStream(s, writeTimeout);</span><br><span class="line">      <span class="comment">// æ¥æ”¶ä¸‹æ¸¸è¿”å›çš„ack</span></span><br><span class="line">      InputStream unbufIn = NetUtils.getInputStream(s);</span><br><span class="line">      IOStreamPair saslStreams = dfsClient.saslClient.socketSend(s,</span><br><span class="line">        unbufOut, unbufIn, dfsClient, accessToken, nodes[<span class="number">0</span>]);</span><br><span class="line">      unbufOut = saslStreams.out;</span><br><span class="line">      unbufIn = saslStreams.in;</span><br><span class="line">      out = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(unbufOut,</span><br><span class="line">          HdfsConstants.SMALL_BUFFER_SIZE));</span><br><span class="line">      </span><br><span class="line">      blockReplyStream = <span class="keyword">new</span> DataInputStream(unbufIn);</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// å‘dnå‘é€å†™è¯·æ±‚ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºconnectè¯·æ±‚</span></span><br><span class="line">      <span class="comment">// ç”±dnä¸Šçš„DataXceiverServeræ¥æ”¶ï¼Œnewä¸€ä¸ªDataXceiverå»å“åº”</span></span><br><span class="line">      <span class="keyword">new</span> Sender(out).writeBlock(blockCopy, nodeStorageTypes[<span class="number">0</span>], accessToken,</span><br><span class="line">          dfsClient.clientName, nodes, nodeStorageTypes, <span class="keyword">null</span>, bcs, </span><br><span class="line">          nodes.length, block.getNumBytes(), bytesSent, newGS,</span><br><span class="line">          checksum4WriteBlock, cachingStrategy.get(), isLazyPersistFile);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// receive ack for connect</span></span><br><span class="line">      <span class="comment">// å‘ä¸‹æ¸¸å‘é€å†™è¯·æ±‚ä¹‹åï¼Œç­‰å¾…ä¸‹æ¸¸è¿”å›çš„connect-ack</span></span><br><span class="line">      <span class="comment">// æ¥æ”¶åˆ°connect-ackä¹‹åæ‰ä¼šå‘pipelineä¸­send packet</span></span><br><span class="line">      BlockOpResponseProto resp = BlockOpResponseProto.parseFrom(</span><br><span class="line">          PBHelper.vintPrefixed(blockReplyStream));</span><br><span class="line">      pipelineStatus = resp.getStatus();</span><br><span class="line">      firstBadLink = resp.getFirstBadLink();</span><br><span class="line">      <span class="comment">// OOBæ˜¯out of bandçš„ç¼©å†™ï¼Œå¸¦å¤–æ•°æ®</span></span><br><span class="line">      <span class="comment">// Got an restart OOB ack.</span></span><br><span class="line">      <span class="comment">// If a node is already restarting, this status is not likely from</span></span><br><span class="line">      <span class="comment">// the same node. If it is from a different node, it is not</span></span><br><span class="line">      <span class="comment">// from the local datanode. Thus it is safe to treat this as a</span></span><br><span class="line">      <span class="comment">// regular node error.</span></span><br><span class="line">      <span class="keyword">if</span> (PipelineAck.isRestartOOBStatus(pipelineStatus) &amp;&amp;</span><br><span class="line">        restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        checkRestart = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;A datanode is restarting.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// pipeline setupæ²¡æœ‰æˆåŠŸï¼ŒæŠ›å‡ºå¼‚å¸¸åœ¨catchä¸­å¤„ç†</span></span><br><span class="line">      <span class="keyword">if</span> (pipelineStatus != SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipelineStatus == Status.ERROR_ACCESS_TOKEN) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> InvalidBlockTokenException(</span><br><span class="line">              <span class="string">&quot;Got access token error for connect ack with firstBadLink as &quot;</span></span><br><span class="line">                  + firstBadLink);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Bad connect ack with firstBadLink as &quot;</span></span><br><span class="line">              + firstBadLink);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">assert</span> <span class="keyword">null</span> == blockStream : <span class="string">&quot;Previous blockStream unclosed&quot;</span>;</span><br><span class="line">      blockStream = out;</span><br><span class="line">      result =  <span class="keyword">true</span>; <span class="comment">// success</span></span><br><span class="line">      restartingNodeIndex = -<span class="number">1</span>;</span><br><span class="line">      hasError = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">      <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Exception in createBlockOutputStream&quot;</span>, ie);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ie <span class="keyword">instanceof</span> InvalidEncryptionKeyException &amp;&amp; refetchEncryptionKey &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Will fetch a new encryption key and retry, &quot;</span> </span><br><span class="line">            + <span class="string">&quot;encryption key was invalid when connecting to &quot;</span></span><br><span class="line">            + nodes[<span class="number">0</span>] + <span class="string">&quot; : &quot;</span> + ie);</span><br><span class="line">        <span class="comment">// The encryption key used is invalid.</span></span><br><span class="line">        refetchEncryptionKey--;</span><br><span class="line">        dfsClient.clearDataEncryptionKey();</span><br><span class="line">        <span class="comment">// Don&#x27;t close the socket/exclude this node just yet. Try again with</span></span><br><span class="line">        <span class="comment">// a new encryption key.</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// find the datanode that matches</span></span><br><span class="line">      <span class="keyword">if</span> (firstBadLink.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">          <span class="comment">// NB: Unconditionally using the xfer addr w/o hostname</span></span><br><span class="line">          <span class="keyword">if</span> (firstBadLink.equals(nodes[i].getXferAddr())) &#123;</span><br><span class="line">            errorIndex = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> checkRestart == <span class="keyword">false</span>;</span><br><span class="line">        errorIndex = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Check whether there is a restart worth waiting for.</span></span><br><span class="line">      <span class="keyword">if</span> (checkRestart &amp;&amp; shouldWaitForRestart(errorIndex)) &#123;</span><br><span class="line">        restartDeadline = dfsClient.getConf().datanodeRestartTimeout +</span><br><span class="line">            Time.now();</span><br><span class="line">        restartingNodeIndex = errorIndex;</span><br><span class="line">        errorIndex = -<span class="number">1</span>;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Waiting for the datanode to be restarted: &quot;</span> +</span><br><span class="line">            nodes[restartingNodeIndex]);</span><br><span class="line">      &#125;</span><br><span class="line">      hasError = <span class="keyword">true</span>;</span><br><span class="line">      setLastException(ie);</span><br><span class="line">      result =  <span class="keyword">false</span>;  <span class="comment">// error</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        IOUtils.closeSocket(s);</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeStream(out);</span><br><span class="line">        out = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeStream(blockReplyStream);</span><br><span class="line">        blockReplyStream = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨pipeline setupé˜¶æ®µclientå…ˆå‘pipelineä¸­çš„ç¬¬ä¸€ä¸ªdnå‘é€è¿æ¥è¯·æ±‚ï¼Œç„¶åç­‰å¾…pipelineä¸­dnå‘é€å›çš„conncet-ackï¼Œ<em>ç”±äºclientå‘é€è¿æ¥è¯·æ±‚å’Œæ¥æ”¶dnè¿”å›çš„connect-ackæ˜¯åŒæ­¥çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦åƒæ¥æ”¶packet acké‚£æ ·å•ç‹¬newä¸€ä¸ªResponder</em>ã€‚<strong>clientå‘é€è¿æ¥è¯·æ±‚ä¹‹åä¼šä¸€ç›´ç­‰å¾…æœ€åä¸€ä¸ªdnçš„connect-ackè¿”å›åˆ°clientä¹‹åæ‰ä¼šç»§ç»­æ‰§è¡Œï¼Œå»æ ¡éªŒconnectæ˜¯å¦æˆåŠŸ</strong>ã€‚</p><p>clientä¸pipelineä¸­çš„ç¬¬ä¸€ä¸ªdnå»ºç«‹è¿æ¥ä¹‹åï¼Œä¸‹é¢æ¥çœ‹ä¸‹pipelineä¸­å‰©ä¸‹çš„dnæ˜¯å¦‚ä½•å»ºç«‹è¿æ¥çš„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataXceiver.writeBlock</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBlock</span><span class="params">(<span class="keyword">final</span> ExtendedBlock block,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> StorageType storageType, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Token&lt;BlockTokenIdentifier&gt; blockToken,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> String clientname,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DatanodeInfo[] targets,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> StorageType[] targetStorageTypes, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DatanodeInfo srcDataNode,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> BlockConstructionStage stage,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">int</span> pipelineSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> minBytesRcvd,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> maxBytesRcvd,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> latestGenerationStamp,</span></span></span><br><span class="line"><span class="params"><span class="function">    DataChecksum requestedChecksum,</span></span></span><br><span class="line"><span class="params"><span class="function">    CachingStrategy cachingStrategy,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">boolean</span> allowLazyPersist)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// reply to upstream datanode or client </span></span><br><span class="line">  <span class="keyword">final</span> DataOutputStream replyOut = <span class="keyword">new</span> DataOutputStream(</span><br><span class="line">      <span class="keyword">new</span> BufferedOutputStream(</span><br><span class="line">          getOutputStream(),</span><br><span class="line">          HdfsConstants.SMALL_BUFFER_SIZE));</span><br><span class="line">  checkAccess(replyOut, isClient, block, blockToken,</span><br><span class="line">      Op.WRITE_BLOCK, BlockTokenSecretManager.AccessMode.WRITE);</span><br><span class="line"></span><br><span class="line">  DataOutputStream mirrorOut = <span class="keyword">null</span>;  <span class="comment">// stream to next target</span></span><br><span class="line">  DataInputStream mirrorIn = <span class="keyword">null</span>;    <span class="comment">// reply from next target</span></span><br><span class="line">  Socket mirrorSock = <span class="keyword">null</span>;           <span class="comment">// socket to next target</span></span><br><span class="line">  String mirrorNode = <span class="keyword">null</span>;           <span class="comment">// the name:port of next target</span></span><br><span class="line">  String firstBadLink = <span class="string">&quot;&quot;</span>;           <span class="comment">// first datanode that failed in connection setup</span></span><br><span class="line">  Status mirrorInStatus = SUCCESS;</span><br><span class="line">  <span class="keyword">final</span> String storageUuid;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDatanode || </span><br><span class="line">        stage != BlockConstructionStage.PIPELINE_CLOSE_RECOVERY) &#123;</span><br><span class="line">      <span class="comment">// open a block receiver</span></span><br><span class="line">      blockReceiver = <span class="keyword">new</span> BlockReceiver(block, storageType, in,</span><br><span class="line">          peer.getRemoteAddressString(),</span><br><span class="line">          peer.getLocalAddressString(),</span><br><span class="line">          stage, latestGenerationStamp, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">          clientname, srcDataNode, datanode, requestedChecksum,</span><br><span class="line">          cachingStrategy, allowLazyPersist);</span><br><span class="line"></span><br><span class="line">      storageUuid = blockReceiver.getStorageUuid();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      storageUuid = datanode.data.recoverClose(</span><br><span class="line">          block, latestGenerationStamp, minBytesRcvd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// ä¸ä¸‹æ¸¸dnå»ºç«‹è¿æ¥</span></span><br><span class="line">    <span class="keyword">if</span> (targets.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      InetSocketAddress mirrorTarget = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// Connect to backup machine</span></span><br><span class="line">      mirrorNode = targets[<span class="number">0</span>].getXferAddr(connectToDnViaHostname);</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Connecting to datanode &quot;</span> + mirrorNode);</span><br><span class="line">      &#125;</span><br><span class="line">      mirrorTarget = NetUtils.createSocketAddr(mirrorNode);</span><br><span class="line">      mirrorSock = datanode.newSocket();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> timeoutValue = dnConf.socketTimeout</span><br><span class="line">            + (HdfsServerConstants.READ_TIMEOUT_EXTENSION * targets.length);</span><br><span class="line">        <span class="keyword">int</span> writeTimeout = dnConf.socketWriteTimeout + </span><br><span class="line">                    (HdfsServerConstants.WRITE_TIMEOUT_EXTENSION * targets.length);</span><br><span class="line">        NetUtils.connect(mirrorSock, mirrorTarget, timeoutValue);</span><br><span class="line">        mirrorSock.setSoTimeout(timeoutValue);</span><br><span class="line">        mirrorSock.setSendBufferSize(HdfsConstants.DEFAULT_DATA_SOCKET_SIZE);</span><br><span class="line">        </span><br><span class="line">        OutputStream unbufMirrorOut = NetUtils.getOutputStream(mirrorSock,</span><br><span class="line">            writeTimeout);</span><br><span class="line">        InputStream unbufMirrorIn = NetUtils.getInputStream(mirrorSock);</span><br><span class="line">        DataEncryptionKeyFactory keyFactory =</span><br><span class="line">          datanode.getDataEncryptionKeyFactoryForBlock(block);</span><br><span class="line">        IOStreamPair saslStreams = datanode.saslClient.socketSend(mirrorSock,</span><br><span class="line">          unbufMirrorOut, unbufMirrorIn, keyFactory, blockToken, targets[<span class="number">0</span>]);</span><br><span class="line">        unbufMirrorOut = saslStreams.out;</span><br><span class="line">        unbufMirrorIn = saslStreams.in;</span><br><span class="line">        mirrorOut = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(unbufMirrorOut,</span><br><span class="line">            HdfsConstants.SMALL_BUFFER_SIZE));</span><br><span class="line">        mirrorIn = <span class="keyword">new</span> DataInputStream(unbufMirrorIn);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not propagate allowLazyPersist to downstream DataNodes.</span></span><br><span class="line">        <span class="keyword">new</span> Sender(mirrorOut).writeBlock(originalBlock, targetStorageTypes[<span class="number">0</span>],</span><br><span class="line">            blockToken, clientname, targets, targetStorageTypes, srcDataNode,</span><br><span class="line">            stage, pipelineSize, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">            latestGenerationStamp, requestedChecksum, cachingStrategy, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        mirrorOut.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// read connect ack (only for clients, not for replication req)</span></span><br><span class="line">        <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">          <span class="comment">// ä»mirrorInä¸­è¯»å–ä¸‹æ¸¸è¿”å›çš„connect-ack</span></span><br><span class="line">          BlockOpResponseProto connectAck =</span><br><span class="line">            BlockOpResponseProto.parseFrom(PBHelper.vintPrefixed(mirrorIn));</span><br><span class="line">          mirrorInStatus = connectAck.getStatus();</span><br><span class="line">          firstBadLink = connectAck.getFirstBadLink();</span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled() || mirrorInStatus != SUCCESS) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;Datanode &quot;</span> + targets.length +</span><br><span class="line">                     <span class="string">&quot; got response for connect ack &quot;</span> +</span><br><span class="line">                     <span class="string">&quot; from downstream datanode with firstbadlink as &quot;</span> +</span><br><span class="line">                     firstBadLink);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">          BlockOpResponseProto.newBuilder()</span><br><span class="line">            .setStatus(ERROR)</span><br><span class="line">             <span class="comment">// NB: Unconditionally using the xfer addr w/o hostname</span></span><br><span class="line">            .setFirstBadLink(targets[<span class="number">0</span>].getXferAddr())</span><br><span class="line">            .build()</span><br><span class="line">            .writeDelimitedTo(replyOut);</span><br><span class="line">          replyOut.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        IOUtils.closeStream(mirrorOut);</span><br><span class="line">        mirrorOut = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeStream(mirrorIn);</span><br><span class="line">        mirrorIn = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeSocket(mirrorSock);</span><br><span class="line">        mirrorSock = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">          LOG.error(datanode + <span class="string">&quot;:Exception transfering block &quot;</span> +</span><br><span class="line">                    block + <span class="string">&quot; to mirror &quot;</span> + mirrorNode + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          LOG.info(datanode + <span class="string">&quot;:Exception transfering &quot;</span> +</span><br><span class="line">                   block + <span class="string">&quot; to mirror &quot;</span> + mirrorNode +</span><br><span class="line">                   <span class="string">&quot;- continuing without the mirror&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// send connect-ack to source for clients and not transfer-RBW/Finalized</span></span><br><span class="line">    <span class="keyword">if</span> (isClient &amp;&amp; !isTransfer) &#123;</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled() || mirrorInStatus != SUCCESS) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;Datanode &quot;</span> + targets.length +</span><br><span class="line">                 <span class="string">&quot; forwarding connect ack to upstream firstbadlink is &quot;</span> +</span><br><span class="line">                 firstBadLink);</span><br><span class="line">      &#125;</span><br><span class="line">      BlockOpResponseProto.newBuilder()</span><br><span class="line">        .setStatus(mirrorInStatus)</span><br><span class="line">        .setFirstBadLink(firstBadLink)</span><br><span class="line">        .build()</span><br><span class="line">        .writeDelimitedTo(replyOut);</span><br><span class="line">      replyOut.flush();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// receive the block and mirror to the next target</span></span><br><span class="line">    <span class="keyword">if</span> (blockReceiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String mirrorAddr = (mirrorSock == <span class="keyword">null</span>) ? <span class="keyword">null</span> : mirrorNode;</span><br><span class="line">      blockReceiver.receiveBlock(mirrorOut, mirrorIn, replyOut,</span><br><span class="line">          mirrorAddr, <span class="keyword">null</span>, targets, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// send close-ack for transfer-RBW/Finalized </span></span><br><span class="line">      <span class="keyword">if</span> (isTransfer) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">          LOG.trace(<span class="string">&quot;TRANSFER: send close-ack&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        writeResponse(SUCCESS, <span class="keyword">null</span>, replyOut);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...    </span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;opWriteBlock &quot;</span> + block + <span class="string">&quot; received exception &quot;</span> + ioe);</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// close all opened streams</span></span><br><span class="line">    IOUtils.closeStream(mirrorOut);</span><br><span class="line">    IOUtils.closeStream(mirrorIn);</span><br><span class="line">    IOUtils.closeStream(replyOut);</span><br><span class="line">    IOUtils.closeSocket(mirrorSock);</span><br><span class="line">    IOUtils.closeStream(blockReceiver);</span><br><span class="line">    blockReceiver = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>dnä¸Šå“åº”ä¸Šæ¸¸æˆ–è€…clientè¿æ¥è¯·æ±‚çš„æ˜¯DataXceiverçº¿ç¨‹</em>ã€‚å¦‚æœæœ‰ä¸‹æ¸¸dnï¼Œåˆ™DataXceiverä¸ä¸‹æ¸¸dnå»ºç«‹è¿æ¥ï¼Œå‘é€å†™è¯·æ±‚ï¼Œå¹¶ç­‰å¾…ä¸‹æ¸¸è¿”å›çš„connect-ackï¼Œæ¥æ”¶åˆ°ä¸‹æ¸¸çš„è¿”å›çš„connect-ackä¹‹åå°†connect-ackç»§ç»­è¿”å›ç»™ä¸Šæ¸¸ï¼Œä¹‹åå¼€å§‹è°ƒç”¨<code>blockReceiver.receiveBlock</code>æ¥æ¥æ”¶pipelineä¸­çš„packetã€‚</p><p><em>å½“clientæ¥æ”¶åˆ°pipelineé€å±‚è¿”å›çš„connect-ackä¹‹åï¼Œpipelineå°±åˆ›å»ºæˆåŠŸäº†</em>ã€‚ä¸è¿‡ç»†å¿ƒçš„å°ä¼™ä¼´ä»¬å¯èƒ½ä¼šå‘ç°åœ¨DataXceiverä¸­ä¸ä¸‹æ¸¸dnå»ºç«‹è¿æ¥æ—¶<em>éƒ½æ˜¯ä»targetä¸­å–å‡ºçš„ç¬¬ä¸€ä¸ªå…ƒç´ è¿›è¡Œè¿æ¥</em>(<code>mirrorNode = targets[0].getXferAddr(connectToDnViaHostname);</code>)ï¼Œé‚£ä¹ˆtargetä¸­çš„å…ƒç´ æ˜¯æ€ä¹ˆå‡å°‘çš„å‘¢ï¼Ÿtargetæ˜¯é€šè¿‡Senderå‘é€ç»™ä¸‹æ¸¸dnçš„ï¼ŒæŸ¥çœ‹Sender.writeBlockå‚æ•°ä¸­targetçš„å€¼å¹¶æ²¡æœ‰å˜åŒ–ï¼Œä½†æ˜¯ä¸‹æ¸¸dnæ¥æ”¶åˆ°çš„targetå´å‘ç”Ÿäº†å˜åŒ–ï¼Œåˆ™targetçš„å€¼ä¸€å®šæ˜¯åœ¨writeBlockä¸­æ”¹å˜çš„ï¼ŒæŸ¥çœ‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Sender.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBlock</span><span class="params">(<span class="keyword">final</span> ExtendedBlock blk,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> StorageType storageType, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Token&lt;BlockTokenIdentifier&gt; blockToken,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> String clientName,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DatanodeInfo[] targets,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> StorageType[] targetStorageTypes, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DatanodeInfo source,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> BlockConstructionStage stage,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">int</span> pipelineSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> minBytesRcvd,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> maxBytesRcvd,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> latestGenerationStamp,</span></span></span><br><span class="line"><span class="params"><span class="function">    DataChecksum requestedChecksum,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> CachingStrategy cachingStrategy,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">boolean</span> allowLazyPersist)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  OpWriteBlockProto.Builder proto = OpWriteBlockProto.newBuilder()</span><br><span class="line">    .setHeader(header)</span><br><span class="line">    .setStorageType(PBHelper.convertStorageType(storageType))</span><br><span class="line">    <span class="comment">// PBHelper.convert å°†targetä¸­çš„å…ƒç´ ä»ç´¢å¼•1å¤„å¼€å§‹</span></span><br><span class="line">    .addAllTargets(PBHelper.convert(targets, <span class="number">1</span>))</span><br><span class="line">    .addAllTargetStorageTypes(PBHelper.convertStorageTypes(targetStorageTypes, <span class="number">1</span>))</span><br><span class="line">    .setStage(toProto(stage))</span><br><span class="line">    .setPipelineSize(pipelineSize)</span><br><span class="line">    .setMinBytesRcvd(minBytesRcvd)</span><br><span class="line">    .setMaxBytesRcvd(maxBytesRcvd)</span><br><span class="line">    .setLatestGenerationStamp(latestGenerationStamp)</span><br><span class="line">    .setRequestedChecksum(checksumProto)</span><br><span class="line">    .setCachingStrategy(getCachingStrategy(cachingStrategy))</span><br><span class="line">    .setAllowLazyPersist(allowLazyPersist);</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹åœ¨pipeline setupè¿‡ç¨‹ä¸­å‡ºç°æ•…éšœæ€ä¹ˆåŠï¼Ÿ</p><h3 id="errors-in-pipeline-setup"><a href="#errors-in-pipeline-setup" class="headerlink" title="errors in pipeline setup"></a>errors in pipeline setup</h3><p><strong>clientç«¯</strong>å¯èƒ½åœ¨ä¸dnå»ºç«‹socketè¿æ¥æ—¶(<code>createSocketForPipeline</code>)å’Œæ¥æ”¶dnè¿”å›çš„connect-ackæ—¶(<code>BlockOpResponseProto.parseFrom(PBHelper.vintPrefixed(blockReplyStream))</code>)å‘ç”ŸIOException errorã€‚<br>è°ƒç”¨<code>createSocketForPipeline</code>ä¸dnå»ºç«‹socketè¿æ¥æ—¶ï¼Œå¯èƒ½ä¼šæŠ›å‡ºIOExceptionå¼‚å¸¸ï¼›åœ¨æ¥æ”¶dnè¿”å›çš„connect-ackæ—¶ï¼Œæ ¹æ®è¿”å›çš„çŠ¶æ€<code>pipelineStatus</code>æ˜¯å¦ä¸ºSUCCESSï¼Œä¸æ˜¯SUCCESSåˆ™æ ¹æ®pipelineStatusçš„çŠ¶æ€æŠ›å‡ºä¸åŒçš„å¼‚å¸¸ã€‚è¿™äº›å¼‚å¸¸åœ¨catchä¸­æ•è·ï¼Œå¤„ç†é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// ä¸dnå»ºç«‹è¿æ¥ï¼Œå¤±è´¥æŠ›å‡ºå¼‚å¸¸IOException</span></span><br><span class="line">  s = createSocketForPipeline(nodes[<span class="number">0</span>], nodes.length, dfsClient);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// receive ack for connect</span></span><br><span class="line">  <span class="comment">// æ¥æ”¶dnè¿”å›çš„connect-ack</span></span><br><span class="line">  BlockOpResponseProto resp = BlockOpResponseProto.parseFrom(</span><br><span class="line">      PBHelper.vintPrefixed(blockReplyStream));</span><br><span class="line">  <span class="comment">// è®°å½•ä»connectçš„çŠ¶æ€</span></span><br><span class="line">  pipelineStatus = resp.getStatus();</span><br><span class="line">  <span class="comment">// è®°å½•å‘ç”Ÿæ•…éšœdnçš„ç´¢å¼•</span></span><br><span class="line">  firstBadLink = resp.getFirstBadLink();</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// pipelineStatusçŠ¶æ€ä¸ä¸ºSUCCESSï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">  <span class="keyword">if</span> (pipelineStatus != SUCCESS) &#123;</span><br><span class="line">    <span class="keyword">if</span> (pipelineStatus == Status.ERROR_ACCESS_TOKEN) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> InvalidBlockTokenException(</span><br><span class="line">          <span class="string">&quot;Got access token error for connect ack with firstBadLink as &quot;</span></span><br><span class="line">              + firstBadLink);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Bad connect ack with firstBadLink as &quot;</span></span><br><span class="line">          + firstBadLink);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">  <span class="comment">// createBlockOutputStreamä¸­å‘ç”Ÿæ•…éšœ</span></span><br><span class="line">  <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">    DFSClient.LOG.info(<span class="string">&quot;Exception in createBlockOutputStream&quot;</span>, ie);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// find the datanode that matches</span></span><br><span class="line">  <span class="keyword">if</span> (firstBadLink.length() != <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">      <span class="comment">// NB: Unconditionally using the xfer addr w/o hostname</span></span><br><span class="line">      <span class="keyword">if</span> (firstBadLink.equals(nodes[i].getXferAddr())) &#123;</span><br><span class="line">      <span class="comment">// errorIndexåœ¨DataStreamerä¸­æ ‡è¯†å¤„ç†errorï¼ŒprocessDatanodeErrorè¿›è¡Œå¤„ç†</span></span><br><span class="line">        errorIndex = i;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// firstBadLink.length()ä¸º0ï¼Œåˆ™å¯èƒ½æ˜¯åœ¨createBlockOutputStreamæ—¶å‘ç”Ÿerror</span></span><br><span class="line">    <span class="keyword">assert</span> checkRestart == <span class="keyword">false</span>;</span><br><span class="line">    errorIndex = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Check whether there is a restart worth waiting for.</span></span><br><span class="line">  <span class="keyword">if</span> (checkRestart &amp;&amp; shouldWaitForRestart(errorIndex)) &#123;</span><br><span class="line">    restartDeadline = dfsClient.getConf().datanodeRestartTimeout +</span><br><span class="line">        Time.now();</span><br><span class="line">    restartingNodeIndex = errorIndex;</span><br><span class="line">    errorIndex = -<span class="number">1</span>;</span><br><span class="line">    DFSClient.LOG.info(<span class="string">&quot;Waiting for the datanode to be restarted: &quot;</span> +</span><br><span class="line">        nodes[restartingNodeIndex]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// hasErroråœ¨DataStreamerä¸­æ ‡è¯†å¤„ç†errorï¼ŒprocessDatanodeErrorè¿›è¡Œå¤„ç†</span></span><br><span class="line">  hasError = <span class="keyword">true</span>;</span><br><span class="line">  setLastException(ie);</span><br><span class="line">  result =  <span class="keyword">false</span>;  <span class="comment">// error</span></span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  <span class="comment">// å‘ç”Ÿerroræ—¶ï¼Œresultåœ¨catchä¸­è®¾ä¸ºfalse</span></span><br><span class="line">  <span class="comment">// å‘ç”Ÿerrorï¼Œå…³é—­ä¸dnçš„è¿æ¥</span></span><br><span class="line">  <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">    IOUtils.closeSocket(s);</span><br><span class="line">    s = <span class="keyword">null</span>;</span><br><span class="line">    IOUtils.closeStream(out);</span><br><span class="line">    out = <span class="keyword">null</span>;</span><br><span class="line">    IOUtils.closeStream(blockReplyStream);</span><br><span class="line">    blockReplyStream = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåœ¨<code>createSocketForPipeline</code>ä¸­å‘ç”Ÿerrorï¼Œç›´æ¥è¢«catchæ•è·ï¼Œ<em>firstBadLinkä¸ºåˆå§‹å€¼(å› ä¸ºæ²¡æœ‰æ¥å—dnè¿”å›çš„connect-ack)ï¼ŒerrorIndexèµ‹å€¼ä¸º0ï¼ŒhasErrorèµ‹å€¼ä¸ºtrueï¼›</em><br>å¦‚æœåœ¨æ¥æ”¶connect-ackä¹‹åï¼Œ<em>æ£€æŸ¥pipelineStatusçš„å€¼ä¸ºéSUCCESSï¼ŒæŠ›å‡ºå¼‚å¸¸è¢«catchæ•è·ï¼Œæ‰¾åˆ°firstBadLinkå¯¹åº”çš„dnï¼Œå¯¹errorIndexèµ‹å€¼ï¼ŒhasErrorèµ‹å€¼ä¸ºtrueï¼›</em></p><p><em>å¯¹errorIndexå’ŒhasErrorèµ‹å€¼ä¹‹åï¼Œåœ¨finallyä¸­æ ¹æ®resultçš„å€¼å…³é—­ç½‘ç»œè¿æ¥</em>ã€‚</p><p>errorIndex&gt;=0å’ŒhasError==trueæ—¶ï¼Œåœ¨DataStreamer.runä¸­è°ƒç”¨<em>processDatanodeError</em>å¯¹errorè¿›è¡Œå¤„ç†ã€‚</p><p><strong>dnç«¯</strong>çš„å¤„ç†é€»è¾‘çš„å…¥å£åœ¨<em>DataXceiver.writeBlock</em>ä¸­ï¼ŒwriteBlockä¼šåˆ¤æ–­targets.lengthæ˜¯å¦å¤§äº0ï¼Œå¤§äº0åˆ™è¡¨ç¤ºæœ‰ä¸‹æ¸¸dnï¼Œåˆ™ä¸ä¸‹æ¸¸dnå»ºç«‹è¿æ¥ï¼Œå»ºç«‹è¿æ¥æ—¶å¯èƒ½ä¼šå‘ç”ŸerroræŠ›å‡ºIOExceptionï¼Œè¢«catchæ•è·ï¼Œè®¾ç½®ackçš„çŠ¶æ€ä¸ºERRORè¿”å›ç»™ä¸Šæ¸¸å¹¶å…³é—­ç›¸å…³ç½‘ç»œè¿æ¥ã€‚éœ€è¦æ³¨æ„çš„æ˜¯å½“å‰dnæ¥æ”¶åˆ°ä¸‹æ¸¸dnçš„connect-ackæ—¶å¹¶ä¸ä¼šåˆ¤æ–­ackä¸­çš„çŠ¶æ€ï¼Œè€Œæ˜¯ç›´æ¥è¿”å›ç»™ä¸Šæ¸¸æˆ–è€…clientã€‚</p><p>åœ¨targets.lengthå¤§äº0çš„ä»£ç æ®µçš„catchä¸­æœ‰æ®µä»£ç éœ€è¦æ³¨æ„ä¸‹ï¼š(<em>å…·ä½“é€»è¾‘éšåå†å±¡ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</em>)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">  LOG.error(datanode + <span class="string">&quot;:Exception transfering block &quot;</span> +</span><br><span class="line">            block + <span class="string">&quot; to mirror &quot;</span> + mirrorNode + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">  <span class="comment">// catchä¸­åˆæŠ›å‡ºå¼‚å¸¸ï¼Œè¢«å¤–å±‚çš„catchæ•è·</span></span><br><span class="line">  <span class="keyword">throw</span> e;</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// ä½•æ—¶é€‰æ‹©å¿½ç•¥errorï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  LOG.info(datanode + <span class="string">&quot;:Exception transfering &quot;</span> +</span><br><span class="line">           block + <span class="string">&quot; to mirror &quot;</span> + mirrorNode +</span><br><span class="line">           <span class="string">&quot;- continuing without the mirror&quot;</span>, e);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>pipeline setupä¸­ä¸æŸä¸ªdnè¿æ¥å‘ç”Ÿerrorä¹‹åï¼Œå°±ç«‹å³è¿”å›ERRORçŠ¶æ€å¹¶å…³é—­è¿æ¥ï¼Œé€šè¿‡é€å±‚è¿”å›ç»™clientä¹‹åï¼Œåˆclientå¤„ç†ï¼Œè¿›è¡Œé‡æ–°setupã€‚</em></p><h3 id="pipeline-setupå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤"><a href="#pipeline-setupå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤" class="headerlink" title="pipeline setupå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤"></a>pipeline setupå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤</h3><p>errorIndexå’ŒhasErroråœ¨createBlockOutputStreamä¸­è¢«èµ‹å€¼ï¼ŒerrorIndexç­‰äº0è¡¨ç¤ºæ˜¯clientä¸ç¬¬ä¸€ä¸ªdnå»ºç«‹è¿æ¥æ—¶å‘ç”Ÿæ•…éšœï¼Œåˆ™å†æ¬¡è¿›å…¥whileå¾ªç¯ä¾ç„¶å°è¯•ä¸ç¬¬ä¸€ä¸ªdnå»ºç«‹è¿æ¥ã€‚errorIndexä¸ç­‰0è€Œç­‰äºpipelineä¸­dnçš„ç´¢å¼•æ—¶ï¼Œåˆ™è·³å‡ºwhileï¼Œ<em>è¿”å›åˆ°<code>nextBlockOutputStream</code>ä¸­ï¼Œæ ¹æ®createBlockOutputStreamçš„ç»“æœå’Œé‡è¯•çš„æ¬¡æ•°åˆ¤æ–­æ˜¯å¦è¿›å…¥whileä¸­ï¼Œè¿›è¡Œå†æ¬¡pipeline setupï¼Œæ­¤æ—¶ä¼šåƒNNé‡æ–°ç”³è¯·block</em>ã€‚</p><p>è¿™ä¹Ÿå°±æ˜¯ä¹‹å‰æ–‡ç« ä¸­ä»‹ç»çš„pipeline setup recoveryçš„ç­–ç•¥(è¿™é‡Œåªæ˜¯create new blockæ—¶setup errorçš„æ¢å¤ç­–ç•¥):<br><em>å¦‚æœæ–°å»ºä¸€ä¸ªpipelineæ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªæ–°blockï¼Œåˆ™clientåªæ˜¯æ”¾å¼ƒè¿™ä¸ªblockï¼Œé‡æ–°å‘NNç”³è¯·ä¸€ä¸ªæ–°çš„blockã€‚ç„¶åä¸ºè¿™ä¸ªæ–°çš„blockå»ºç«‹pipeline</em></p><h2 id="pipeline-streaming-amp-error"><a href="#pipeline-streaming-amp-error" class="headerlink" title="pipeline streaming &amp; error"></a>pipeline streaming &amp; error</h2><h3 id="pipeline-data-streaming"><a href="#pipeline-data-streaming" class="headerlink" title="pipeline data streaming"></a>pipeline data streaming</h3><p>pipeline setupæˆåŠŸä¹‹åï¼Œ<strong>clientç«¯</strong>åœ¨DataStreamer.runä¸­ï¼Œé€šè¿‡<code>initDataStreaming</code>ï¼Œè®¾ç½®<em>BlockConstructionStageçš„çŠ¶æ€ä¸ºDATA_STREAMING</em>å¹¶<em>å¯åŠ¨ä¸€ä¸ªResponseProcessorçº¿ç¨‹æ¥æ”¶ä¸‹æ¸¸dnè¿”å›çš„packet ack</em>ã€‚</p><p>ResponseProcessorçº¿ç¨‹å¯åŠ¨ä¹‹åï¼Œå°†packetå¼€å§‹å‘pipelineä¸­å‘é€ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  one.writeTo(blockStream);</span><br><span class="line">  blockStream.flush();   </span><br><span class="line">&#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">  <span class="comment">// HDFS-3398 treat primary DN is down since client is unable to </span></span><br><span class="line">  <span class="comment">// write to primary DN. If a failed or restarting node has already</span></span><br><span class="line">  <span class="comment">// been recorded by the responder, the following call will have no </span></span><br><span class="line">  <span class="comment">// effect. Pipeline recovery can handle only one node error at a</span></span><br><span class="line">  <span class="comment">// time. If the primary node fails again during the recovery, it</span></span><br><span class="line">  <span class="comment">// will be taken out then.</span></span><br><span class="line">  tryMarkPrimaryDatanodeFailed();</span><br><span class="line">  <span class="keyword">throw</span> e;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>clientç«¯çš„DataStreamerå‘é€packetåˆ°pipelineä¸­ï¼Œpipelineä¸­çš„ç¬¬ä¸€ä¸ªdnå¼€å§‹æ¥æ”¶packetï¼Œä»£ç ä¾ç„¶æ˜¯åœ¨DataXceiver.writeBlockä¸­ï¼Œ(<em>æ­¤æ—¶pipelineå·²ç»å»ºç«‹æˆåŠŸï¼Œä¹Ÿå°±æ˜¯dnå·²ç»å°†connect-ackè¿”å›ç»™clientï¼Œåˆ™å¼€å§‹æ¥æ”¶pipelineä¸­çš„packet</em>)ã€‚dné€šè¿‡<code>blockReceiver.receiveBlock</code>æ¥æ”¶packetï¼Œ<em>åœ¨æ¥æ”¶packetæ—¶å¯èƒ½ä¼šå‘ç”Ÿerrorï¼ŒæŠ›å‡ºIOExceptionï¼Œåœ¨finallyä¸­å…³é—­è¿æ¥</em>ã€‚receiveBlockçš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receiveBlock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DataOutputStream mirrOut, // output to next datanode</span></span></span><br><span class="line"><span class="params"><span class="function">    DataInputStream mirrIn,   // input from next datanode</span></span></span><br><span class="line"><span class="params"><span class="function">    DataOutputStream replyOut,  // output to previous datanode</span></span></span><br><span class="line"><span class="params"><span class="function">    String mirrAddr, DataTransferThrottler throttlerArg,</span></span></span><br><span class="line"><span class="params"><span class="function">    DatanodeInfo[] downstreams,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> isReplaceBlock)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isClient &amp;&amp; !isTransfer) &#123;</span><br><span class="line">      <span class="comment">// å¯åŠ¨ä¸€ä¸ªPacketResponderå®ˆæŠ¤çº¿ç¨‹</span></span><br><span class="line">      responder = <span class="keyword">new</span> Daemon(datanode.threadGroup, </span><br><span class="line">          <span class="keyword">new</span> PacketResponder(replyOut, mirrIn, downstreams));</span><br><span class="line">      responder.start(); <span class="comment">// start thread to processes responses</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾ªç¯ä»socketä¸­æ¥æ”¶packet</span></span><br><span class="line">    <span class="keyword">while</span> (receivePacket() &gt;= <span class="number">0</span>) &#123; <span class="comment">/* Receive until the last packet */</span> &#125;</span><br><span class="line">    <span class="comment">// è¯¥blockçš„packetæ¥æ”¶å®Œæ¯•ä¹‹åï¼Œå°†PacketResponderçº¿ç¨‹å…³é—­</span></span><br><span class="line">    <span class="comment">// wait for all outstanding packet responses. And then</span></span><br><span class="line">    <span class="comment">// indicate responder to gracefully shutdown.</span></span><br><span class="line">    <span class="comment">// Mark that responder has been closed for future processing</span></span><br><span class="line">    <span class="keyword">if</span> (responder != <span class="keyword">null</span>) &#123;</span><br><span class="line">      ((PacketResponder)responder.getRunnable()).close();</span><br><span class="line">      responderClosed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    <span class="keyword">if</span> (datanode.isRestarting()) &#123;</span><br><span class="line">      <span class="comment">// Do not throw if shutting down for restart. Otherwise, it will cause</span></span><br><span class="line">      <span class="comment">// premature termination of responder.</span></span><br><span class="line">      LOG.info(<span class="string">&quot;Shutting down for restart (&quot;</span> + block + <span class="string">&quot;).&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      LOG.info(<span class="string">&quot;Exception for &quot;</span> + block, ioe);</span><br><span class="line">      <span class="keyword">throw</span> ioe;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">  ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨DataXceiver.writeBlockä¸­ä¼šå…ˆæ ¹æ®stageåˆ›å»ºä¸åŒçŠ¶æ€Replicaçš„BlockReceiverï¼Œç„¶åè°ƒç”¨blockReceiver.receiveBlockæ¥æ¥æ”¶socketä¸­çš„packetã€‚</p><p>clientç«¯ä¼šå•ç‹¬èµ·ä¸€ä¸ªResponseProcessorçº¿ç¨‹æ¥æ¥æ”¶packet ackï¼Œé‚£ä¹ˆdnä¹Ÿä¼šæ–°èµ·ä¸€ä¸ªPacketResponderçš„å®ˆæŠ¤çº¿ç¨‹æ¥æ¥æ”¶ä¸‹æ¸¸çš„è¿”å›çš„ackå’Œå‘ä¸Šæ¸¸å‘é€ackã€‚(<em>éœ€è¦æ³¨æ„çš„æ˜¯clientç«¯å’Œdnç«¯ä¸­ç”¨æ¥å­˜å‚¨packetçš„æ•°æ®ç»“æ„æœ‰æ‰€ä¸åŒï¼Œclientç«¯æ˜¯å…ˆå°†packetæ”¾å…¥dataQueueï¼Œç„¶åæ”¾å…¥ackQueueï¼Œè€Œdnç«¯åªæœ‰ackQueueï¼Œæ²¡æœ‰dataQueueï¼Œå› ä¸ºpipelineä¸­dnçš„å†…å­˜ä¸­åªæœ‰ä¸€ä¸ªpacketï¼Œå‘ä¸‹æ¸¸å‘é€ä¹‹åå°†å†…å­˜ä¸­çš„packetæ”¾å…¥ackQueueä¸­ã€‚</em>)</p><p>dnç«¯æ˜¯ä»¥packetä¸ºå•ä½æ¥æ”¶æ•°æ®çš„ï¼Œ<code>packetReceiver.receiveNextPacket(in)</code>ä»socketæ¥æ”¶packetåˆ°dnçš„å†…å­˜ä¸­ï¼Œç„¶åæ”¾å…¥ackQueueä¸­ï¼Œå‘ä¸‹æ¸¸å‘é€<code>packetReceiver.mirrorPacketTo(mirrorOut)</code>ï¼Œå‘é€å®Œä¹‹åå°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥diskã€‚</p><p>ä¸Šé¢ä»‹ç»äº†packetä»clientå‘é€åˆ°pipelineä¸­ï¼Œå¹¶åœ¨pipelineä¸­çš„ä¼ é€ï¼Œä¸‹é¢ä»‹ç»ä¸‹åœ¨pipeline Streamingå‘ç”Ÿerrorçš„æƒ…å†µ</p><h3 id="errors-in-pipeline-streaming"><a href="#errors-in-pipeline-streaming" class="headerlink" title="errors in pipeline streaming"></a>errors in pipeline streaming</h3><p>pipeline streamä¸­å¯ä»¥å†ç»†åˆ†ä¸º3ä¸ªé˜¶æ®µï¼Œåˆ†åˆ«ä¸º1.aæ¥æ”¶socketä¸­çš„packetåˆ°å†…å­˜ï¼Œ1.bå°†å†…å­˜ä¸­çš„packetå‘é€åˆ°ä¸‹æ¸¸çš„socketä¸­ï¼Œ2å°†å†…å­˜ä¸­çš„packetå†™å…¥ç£ç›˜ï¼Œ3.aæ¥æ”¶ä¸‹æ¸¸è¿”å›çš„ackï¼Œ3.bå‘ä¸Šæ¸¸å‘é€ackã€‚è¿™å‡ ä¸ªé˜¶æ®µéƒ½æœ‰å¯èƒ½å‘ç”Ÿerrorã€‚</p><p>1.aæ¥æ”¶socketä¸­çš„packetçš„å†…å­˜æ—¶(<code>packetReceiver.receiveNextPacket(in)</code>)ä¼šæŠ›å‡ºå¼‚å¸¸IOExceptionï¼Œåœ¨writeBlockä¸­è¢«æ•è·ï¼Œfinallyæ‰§è¡Œå…³é—­è¿æ¥ã€‚</p><p>1.bå°†å†…å­˜ä¸­çš„packetå†™å…¥ä¸‹æ¸¸socketæ—¶(<code>packetReceiver.mirrorPacketTo(mirrorOut)</code>)ä¼šæŠ›å‡ºå¼‚å¸¸IOExceptionï¼Œè¢«catchæ•è·ï¼Œè°ƒç”¨<code>handleMirrorOutError</code>ï¼ŒhandleMirrorOutErrorä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * While writing to mirrorOut, failure to write to mirror should not</span></span><br><span class="line"><span class="comment"> * affect this datanode unless it is caused by interruption.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">handleMirrorOutError</span><span class="params">(IOException ioe)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  String bpid = block.getBlockPoolId();</span><br><span class="line">  LOG.info(datanode.getDNRegistrationForBP(bpid)</span><br><span class="line">      + <span class="string">&quot;:Exception writing &quot;</span> + block + <span class="string">&quot; to mirror &quot;</span> + mirrorAddr, ioe);</span><br><span class="line">  <span class="keyword">if</span> (Thread.interrupted()) &#123; <span class="comment">// shut down if the thread is interrupted</span></span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123; <span class="comment">// encounter an error while writing to mirror</span></span><br><span class="line">    <span class="comment">// continue to run even if can not write to mirror</span></span><br><span class="line">    <span class="comment">// notify client of the error</span></span><br><span class="line">    <span class="comment">// and wait for the client to shut down the pipeline</span></span><br><span class="line">    mirrorError = <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ— è®º1.bæ˜¯å¦å‘ç”Ÿerrorï¼Œå§‹ç»ˆéƒ½ä¼šå°†å†…å­˜ä¸­çš„packetå†™å…¥ç£ç›˜ï¼Œä¹Ÿå°±æ˜¯è‚¯å®šä¼šæ‰§è¡Œ2ã€‚2ä¸­å†™å…¥ç£ç›˜çš„æ•°æ®ä¸»è¦æ˜¯chunksumæ•°æ®å’Œdataæ•°æ®ï¼Œé‚£ä¹ˆè¿™ä¸¤æ­¥éƒ½å¯èƒ½ä¼šå‘ç”Ÿerrorã€‚</p><p>åœ¨æ ¡éªŒchunksumæ—¶(<code>verifyChunks(dataBuf, checksumBuf)</code>)æŠ›å‡ºå¼‚å¸¸è¢«æ•è·ï¼Œå¯èƒ½ä¼šå°†packetçš„çŠ¶æ€è®¾ç½®ä¸º<em>Status.ERROR_CHECKSUM</em>ç„¶åæ”¾å…¥ackQueueä¸­(<strong>åœ¨å°†packetå‘ä¸‹æ¸¸socketä¸­å‘é€ä¹‹å‰å·²ç»å°†è¯¥packetæ”¾å…¥ackQueueä¸­ï¼Œæ­¤æ—¶åˆæ”¾è¿›å»ï¼Ÿä¼šä¸ä¼šé‡ï¼Ÿä¸ºä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿ</strong>)ï¼Œå¹¶å†æŠ›å‡ºIOExceptionå¼‚å¸¸åœ¨writeBlockä¸­æ•è·ï¼Œfinallyæ‰§è¡Œå…³é—­è¿æ¥ã€‚</p><p>å°†dataå†™å…¥diskæ—¶ä¼šæŠ›å‡ºIOExceptionï¼Œåœ¨writeBlockä¸­æ•è·ï¼Œfinallyæ‰§è¡Œå…³é—­è¿æ¥ã€‚</p><p>3.aå’Œ3.bæ˜¯åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼Œ3.aæ¥æ”¶ä¸‹æ¸¸çš„ackæ—¶å¯èƒ½ä¼šæŠ›å‡ºIOExceptionå¼‚å¸¸ï¼Œè¢«æ•è·å¹¶å¯¹mirrorErrorèµ‹å€¼ä¸ºtrueã€‚3.bå‘ä¸Šæ¸¸æˆ–è€…clientå‘é€ackæ—¶ä¹Ÿå¯èƒ½æŠ›å‡ºIOExceptionå¼‚å¸¸ã€‚ä¸‹é¢çœ‹ä¸‹PacketResponder.runä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> lastPacketInBlock = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> startTime = ClientTraceLog.isInfoEnabled() ? System.nanoTime() : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (isRunning() &amp;&amp; !lastPacketInBlock) &#123;</span><br><span class="line">    <span class="keyword">long</span> totalAckTimeNanos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isInterrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Packet pkt = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">long</span> expected = -<span class="number">2</span>;</span><br><span class="line">      <span class="comment">// new ä¸€ä¸ªnullçš„ack</span></span><br><span class="line">      PipelineAck ack = <span class="keyword">new</span> PipelineAck();</span><br><span class="line">      <span class="keyword">long</span> seqno = PipelineAck.UNKOWN_SEQNO;</span><br><span class="line">      <span class="keyword">long</span> ackRecvNanoTime = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å‘ä¸‹æ¸¸å‘é€packetå‘ç”Ÿerroræˆ–è€…æ¥æ”¶ä¸‹æ¸¸è¿”å›çš„ackæ—¶å‘ç”Ÿerrorï¼Œ</span></span><br><span class="line">      <span class="comment">// éƒ½æœ‰å¯èƒ½å°†mirrorErrorç½®ä¸ºtrueï¼Œå¯¼è‡´ä¸è¿›ifä¹Ÿå°±æ˜¯ä¸æ¥å—ä¸‹æ¸¸çš„ack</span></span><br><span class="line">        <span class="keyword">if</span> (type != PacketResponderType.LAST_IN_PIPELINE &amp;&amp; !mirrorError) &#123;</span><br><span class="line">          <span class="comment">// read an ack from downstream datanode</span></span><br><span class="line">          ack.readFields(downstreamIn);</span><br><span class="line">          ackRecvNanoTime = System.nanoTime();</span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(myString + <span class="string">&quot; got &quot;</span> + ack);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Process an OOB ACK.</span></span><br><span class="line">          ...</span><br><span class="line">          seqno = ack.getSeqno();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (seqno != PipelineAck.UNKOWN_SEQNO</span><br><span class="line">            || type == PacketResponderType.LAST_IN_PIPELINE) &#123;</span><br><span class="line">          <span class="comment">// ä»ackQueueä¸­å–å‡ºä¸€ä¸ªpacket</span></span><br><span class="line">          pkt = waitForAckHead(seqno);</span><br><span class="line">          <span class="keyword">if</span> (!isRunning()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          expected = pkt.seqno;</span><br><span class="line">          <span class="keyword">if</span> (type == PacketResponderType.HAS_DOWNSTREAM_IN_PIPELINE</span><br><span class="line">              &amp;&amp; seqno != expected) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(myString + <span class="string">&quot;seqno: expected=&quot;</span> + expected</span><br><span class="line">                + <span class="string">&quot;, received=&quot;</span> + seqno);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">if</span> (type == PacketResponderType.HAS_DOWNSTREAM_IN_PIPELINE) &#123;</span><br><span class="line">            <span class="comment">// The total ack time includes the ack times of downstream</span></span><br><span class="line">            <span class="comment">// nodes.</span></span><br><span class="line">            <span class="comment">// The value is 0 if this responder doesn&#x27;t have a downstream</span></span><br><span class="line">            <span class="comment">// DN in the pipeline.</span></span><br><span class="line">            totalAckTimeNanos = ackRecvNanoTime - pkt.ackEnqueueNanoTime;</span><br><span class="line">            <span class="comment">// Report the elapsed time from ack send to ack receive minus</span></span><br><span class="line">            <span class="comment">// the downstream ack time.</span></span><br><span class="line">            <span class="keyword">long</span> ackTimeNanos = totalAckTimeNanos</span><br><span class="line">                - ack.getDownstreamAckTimeNanos();</span><br><span class="line">            <span class="keyword">if</span> (ackTimeNanos &lt; <span class="number">0</span>) &#123;</span><br><span class="line">              <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">                LOG.debug(<span class="string">&quot;Calculated invalid ack time: &quot;</span> + ackTimeNanos</span><br><span class="line">                    + <span class="string">&quot;ns.&quot;</span>);</span><br><span class="line">              &#125;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              datanode.metrics.addPacketAckRoundTripTimeNanos(ackTimeNanos);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          lastPacketInBlock = pkt.lastPacketInBlock;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException ine) &#123;</span><br><span class="line">        isInterrupted = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">          isInterrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// continue to run even if can not read from mirror</span></span><br><span class="line">          <span class="comment">// notify client of the error</span></span><br><span class="line">          <span class="comment">// and wait for the client to shut down the pipeline</span></span><br><span class="line">          mirrorError = <span class="keyword">true</span>;</span><br><span class="line">          LOG.info(myString, ioe);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Thread.interrupted() || isInterrupted) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The receiver thread cancelled this thread. We could also check</span></span><br><span class="line"><span class="comment">         * any other status updates from the receiver thread (e.g. if it is</span></span><br><span class="line"><span class="comment">         * ok to write to replyOut). It is prudent to not send any more</span></span><br><span class="line"><span class="comment">         * status back to the client because this datanode has a problem.</span></span><br><span class="line"><span class="comment">         * The upstream datanode will detect that this datanode is bad, and</span></span><br><span class="line"><span class="comment">         * rightly so.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The receiver thread can also interrupt this thread for sending</span></span><br><span class="line"><span class="comment">         * an out-of-band response upstream.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        LOG.info(myString + <span class="string">&quot;: Thread is interrupted.&quot;</span>);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (lastPacketInBlock) &#123;</span><br><span class="line">        <span class="comment">// Finalize the block and close the block file</span></span><br><span class="line">        finalizeBlock(startTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å‘ä¸Šæ¸¸å‘é€ackï¼ŒåŒ…æ‹¬æ¥æ”¶ä¸‹æ¸¸çš„ackå’Œä»è‡ªå·±çš„ack</span></span><br><span class="line">      sendAckUpstream(ack, expected, totalAckTimeNanos,</span><br><span class="line">          (pkt != <span class="keyword">null</span> ? pkt.offsetInBlock : <span class="number">0</span>), </span><br><span class="line">          (pkt != <span class="keyword">null</span> ? pkt.ackStatus : Status.SUCCESS));</span><br><span class="line">      <span class="keyword">if</span> (pkt != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// remove the packet from the ack queue</span></span><br><span class="line">        removeAckHead();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;IOException in BlockReceiver.run(): &quot;</span>, e);</span><br><span class="line">      <span class="keyword">if</span> (running) &#123;</span><br><span class="line">        datanode.checkDiskErrorAsync();</span><br><span class="line">        LOG.info(myString, e);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!Thread.interrupted()) &#123; <span class="comment">// failure not caused by interruption</span></span><br><span class="line">          receiverThread.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (running) &#123;</span><br><span class="line">        LOG.info(myString, e);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">        receiverThread.interrupt();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(myString + <span class="string">&quot; terminating&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè¿˜æ˜¯æœ‰å¾ˆå¤šåœ°æ–¹ä¸æ¸…æ¥šï¼Œè®°å½•ä¸‹ï¼š</p><blockquote><p>è¿™ä¸ªè¿‡ç¨‹æ˜¯pipelineä¸­é‡è¦çš„è¿‡ç¨‹ï¼Œä½†è¿™é‡Œä¹Ÿæœ‰å¾ˆå¤šç–‘æƒ‘ï¼Œè®°å½•ä¸‹ä»¥åæ…¢æ…¢è§£å†³<br>data streamä¸­å‘ç”Ÿçš„errorçš„çŠ¶æ€æ˜¯æ€ä¹ˆè®°å½•åœ¨ackQueueä¸­ï¼Œç›®å‰åœ¨ä»£ç ä¸­åªå‘ç°å½“<code>verifyChunks</code>å¼‚å¸¸æ—¶ï¼Œä¼šå°†packetçš„çŠ¶æ€å˜ä¸ºERROR_CHECKSUMæ”¾å…¥ackQueueä¸­ï¼Œåˆ«çš„æƒ…å†µå‘¢ï¼Ÿï¼Ÿï¼Ÿåˆæ˜¯æ€ä¹ˆåé¦ˆç»™ä¸Šæ¸¸çš„ï¼Ÿï¼Ÿï¼Ÿ<br>å‘ä¸‹æ¸¸å‘é€packetå‘ç”Ÿerroræ—¶ï¼ŒmirrorErrorå¯èƒ½ä¼šè¢«ç½®ä¸ºtrueï¼Œè€Œæ­¤æ—¶PacketResponderå°†ä¸æ¥å—ä¸‹æ¸¸çš„ackï¼Œé‚£ä¹ˆåªæ˜¯å°†ä¸€ä¸ªnullçš„ackå’ŒStatus.SUCCESS(sendAckUpstream(ack, expected, totalAckTimeNanos,(pkt != null ? pkt.offsetInBlock : 0), (pkt != null ? pkt.ackStatus : Status.SUCCESS)))å‘é€ç»™ä¸Šæ¸¸ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ(ä¸æ¥å—ä¸‹æ¸¸çš„ackåˆ™ä¸èƒ½ä»ackQueueä¸­å–packetï¼Œä½†ä¸ºä»€ä¹ˆè¦å‘é€Status.SUCCESS)<br>å½“æŸä¸ªpacketå‘ç”Ÿerrorï¼Œclientå¹¶ä¸æ˜¯é©¬ä¸Šå‘ç°ï¼Œè€Œæ˜¯ç­‰å¾…è¿™ä¸ªpacketçš„ackè¿”å›ç»™clientä¹‹åï¼Œclientæ‰èƒ½æ£€æµ‹åˆ°è¯¥packetå‘ç”Ÿäº†errorï¼Œè¿›è¡Œå¤„ç†ã€‚</p></blockquote><p>ä¸Šé¢æ˜¯dnç«¯åœ¨pipeline streamä¸­å¯èƒ½å‘ç”Ÿçš„errorï¼Œä¸‹é¢ä»‹ç»ä¸‹clientç«¯åœ¨pipeline streamä¸­å‘ç”Ÿçš„error</p><p>clientç«¯ä¸pipeline streamç›¸å…³çš„æ˜¯ResponseProcessorçº¿ç¨‹å’ŒDataStreamerçº¿ç¨‹ã€‚å…ˆçœ‹ä¸‹ResponseProcessorçº¿ç¨‹æ¥æ”¶dnå‘æ¥çš„ackï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  setName(<span class="string">&quot;ResponseProcessor for block &quot;</span> + block);</span><br><span class="line">  PipelineAck ack = <span class="keyword">new</span> PipelineAck();</span><br><span class="line">  <span class="keyword">while</span> (!responderClosed &amp;&amp; dfsClient.clientRunning &amp;&amp; !isLastPacketInBlock) &#123;</span><br><span class="line">    <span class="comment">// process responses from datanodes.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// read an ack from the pipeline</span></span><br><span class="line">      <span class="keyword">long</span> begin = Time.monotonicNow();</span><br><span class="line">      ack.readFields(blockReplyStream);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">long</span> seqno = ack.getSeqno();</span><br><span class="line">      <span class="comment">// processes response status from datanodes.</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = ack.getNumOfReplies()-<span class="number">1</span>; i &gt;=<span class="number">0</span>  &amp;&amp; dfsClient.clientRunning; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> Status reply = ack.getReply(i);</span><br><span class="line">        <span class="comment">// Restart will not be treated differently unless it is</span></span><br><span class="line">        <span class="comment">// the local node or the only one in the pipeline.</span></span><br><span class="line">        <span class="keyword">if</span> (PipelineAck.isRestartOOBStatus(reply) &amp;&amp;</span><br><span class="line">            shouldWaitForRestart(i)) &#123;</span><br><span class="line">          restartDeadline = dfsClient.getConf().datanodeRestartTimeout +</span><br><span class="line">              Time.now();</span><br><span class="line">          setRestartingNodeIndex(i);</span><br><span class="line">          String message = <span class="string">&quot;A datanode is restarting: &quot;</span> + targets[i];</span><br><span class="line">          DFSClient.LOG.info(message);</span><br><span class="line">         <span class="keyword">throw</span> <span class="keyword">new</span> IOException(message);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// node error</span></span><br><span class="line">        <span class="keyword">if</span> (reply != SUCCESS) &#123;</span><br><span class="line">          setErrorIndex(i); <span class="comment">// first bad datanode</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Bad response &quot;</span> + reply +</span><br><span class="line">              <span class="string">&quot; for block &quot;</span> + block +</span><br><span class="line">              <span class="string">&quot; from datanode &quot;</span> + </span><br><span class="line">              targets[i]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">assert</span> seqno != PipelineAck.UNKOWN_SEQNO : </span><br><span class="line">        <span class="string">&quot;Ack for unknown seqno should be a failed ack: &quot;</span> + ack;</span><br><span class="line">      <span class="keyword">if</span> (seqno == Packet.HEART_BEAT_SEQNO) &#123;  <span class="comment">// a heartbeat ack</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// a success ack for a data packet</span></span><br><span class="line">      Packet one;</span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        one = ackQueue.getFirst();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ¥æ”¶åˆ°çš„seqnoå’ŒackQueueä¸­çš„ä¸ä¸€æ ·ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">if</span> (one.seqno != seqno) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;ResponseProcessor: Expecting seqno &quot;</span> +</span><br><span class="line">                              <span class="string">&quot; for block &quot;</span> + block +</span><br><span class="line">                              one.seqno + <span class="string">&quot; but received &quot;</span> + seqno);</span><br><span class="line">      &#125;</span><br><span class="line">      isLastPacketInBlock = one.lastPacketInBlock;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Fail the packet write for testing in order to force a</span></span><br><span class="line">      <span class="comment">// pipeline recovery.</span></span><br><span class="line">      <span class="keyword">if</span> (DFSClientFaultInjector.get().failPacket() &amp;&amp;</span><br><span class="line">          isLastPacketInBlock) &#123;</span><br><span class="line">        failPacket = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">              <span class="string">&quot;Failing the last packet for testing.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// update bytesAcked</span></span><br><span class="line">      block.setNumBytes(one.getLastByteOffsetBlock());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        lastAckedSeqno = seqno;</span><br><span class="line">        ackQueue.removeFirst();</span><br><span class="line">        dataQueue.notifyAll();</span><br><span class="line"></span><br><span class="line">        one.releaseBuffer(byteArrayManager);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!responderClosed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">          setLastException((IOException)e);</span><br><span class="line">        &#125;</span><br><span class="line">        hasError = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// If no explicit error report was received, mark the primary</span></span><br><span class="line">        <span class="comment">// node as failed.</span></span><br><span class="line">        tryMarkPrimaryDatanodeFailed();</span><br><span class="line">        <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">          dataQueue.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">          DFSClient.LOG.warn(<span class="string">&quot;DFSOutputStream ResponseProcessor exception &quot;</span></span><br><span class="line">               + <span class="string">&quot; for block &quot;</span> + block, e);</span><br><span class="line">        &#125;</span><br><span class="line">        responderClosed = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ResponseProcessororä¸­æ¥æ”¶ä¸‹æ¸¸çš„ackæ—¶ï¼Œå¦‚æœackä¸­çš„packetæœ‰éSUCCESSçŠ¶æ€ï¼Œåˆ™<code>setErrorIndex</code>å¹¶æŠ›å‡ºIOExceptionå¼‚å¸¸ï¼›å¦‚æœæ¥æ”¶åˆ°ackçš„seqnoå’Œä»ackQueueå–å‡ºçš„seqnoä¸ä¸€æ ·ï¼Œåˆ™æŠ›å‡ºIOExceptionå¼‚å¸¸ï¼ŒæŠ›å‡ºä¹‹ååœ¨catchä¸­æ•è·ï¼Œå°†hasErrorç½®ä¸ºtrueï¼Œå…³é—­ResponseProcessororçº¿ç¨‹ã€‚</p><p>åœ¨DataStreamer.runä¸­ä¹Ÿå¯èƒ½æŠ›å‡ºå¼‚å¸¸(åœ¨<code>one.writeTo(blockStream)</code>ä¸­æŠ›å‡ºå¼‚å¸¸IOException)</p><h3 id="pipeline-streamå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤"><a href="#pipeline-streamå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤" class="headerlink" title="pipeline streamå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤"></a>pipeline streamå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤</h3><p>pipeline streamä¸­å‘ç”Ÿerroråªæœ‰åœ¨clientç«¯æ‰èƒ½æ£€æµ‹åˆ°æ‰è¿›è¡Œå¤„ç†ã€‚</p><p>å¦‚æœæ˜¯åœ¨ResponseProcessororä¸­å‘ç”Ÿçš„å¼‚å¸¸ï¼Œåˆ†ä¸¤ç§æƒ…å†µï¼Œç¬¬ä¸€ç§æ˜¯åœ¨åœ¨ä¸‹æ¸¸çš„ackä¸­å‘ç°packetçš„çŠ¶æ€éSUCCESSï¼Œ<em>åˆ™è®¾ç½®errorIndexä¸ºpipelineä¸­ç¬¬ä¸€ä¸ªå‘é€errorçš„dnç´¢å¼•</em>å¹¶æŠ›å‡ºIOExceptionåœ¨catchä¸­æ•è·å°†hasErrorç½®ä¸ºtrueã€‚<br>ç¬¬äºŒç§æƒ…å†µæ˜¯æ¥æ”¶åˆ°ackçš„seqnoå’Œä»ackQueueä¸­å–å‡ºçš„seqnoä¸ä¸€æ ·ï¼Œåˆ™æŠ›å‡ºIOExceptionåœ¨catchä¸­æ•è·å°†hasErrorç½®ä¸ºtrueã€‚</p><p>DataStreamer.runä¸­one.writeTo(blockStream)æŠ›å‡ºå¼‚å¸¸è¢«catchæ•è·å†æ¬¡æŠ›å‡ºIOExceptionè¢«å¤–å±‚çš„catchæ•è·å°†hasErrorç½®ä¸ºtrueã€‚</p><p>hasErrorå’ŒerrorIndexçš„å€¼å‘ç”Ÿå˜åŒ–ä¹‹åï¼Œåœ¨DataStreamer.runä¸­è¢«å‘ç°ï¼Œè¿›è¡Œæ•…éšœå¤„ç†ã€‚ç›¸å…³ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// if the Responder encountered an error, shutdown Responder</span></span><br><span class="line"><span class="keyword">if</span> (hasError &amp;&amp; response != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    response.close();</span><br><span class="line">    response.join();</span><br><span class="line">    response = <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">    DFSClient.LOG.warn(<span class="string">&quot;Caught exception &quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (hasError &amp;&amp; (errorIndex &gt;= <span class="number">0</span> || restartingNodeIndex &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">  doSleep = processDatanodeError();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processDatanodeErroråªæœ‰åœ¨errorIndexå¤§äºç­‰äº0æˆ–è€…restartingNodeIndexå¤§äºç­‰äº0æ—¶æ‰æ‰§è¡Œï¼Œ(<strong>ä¹Ÿå°±æ˜¯è¯´å½“ResponseProcessoræ¥æ”¶åˆ°çš„ackä¸­æœ‰packetçš„çŠ¶æ€æ˜¯éSUCCESSæ—¶ï¼Œæ‰ä¼šæ‰§è¡Œï¼Ÿï¼Ÿï¼Ÿ</strong>)ã€‚</p><p>æ¥ç ”ç©¶ä¸‹processDatanodeErrorä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processDatanodeError</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">    DFSClient.LOG.info(<span class="string">&quot;Error Recovery for &quot;</span> + block +</span><br><span class="line">    <span class="string">&quot; waiting for responder to exit. &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å…³é—­è¿æ¥</span></span><br><span class="line">  closeStream();</span><br><span class="line">  <span class="comment">// å°†ackQueueä¸­ç­‰å¾…æ¥æ”¶ackçš„packeté‡æ–°æ”¾å›dataQueueä¸­ï¼Œé‡æ–°å¾€pipelineå‘é€</span></span><br><span class="line">  <span class="comment">// move packets from ack queue to front of the data queue</span></span><br><span class="line">  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">    dataQueue.addAll(<span class="number">0</span>, ackQueue);</span><br><span class="line">    ackQueue.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record the new pipeline failure recovery.</span></span><br><span class="line">  <span class="keyword">if</span> (lastAckedSeqnoBeforeFailure != lastAckedSeqno) &#123;</span><br><span class="line">     lastAckedSeqnoBeforeFailure = lastAckedSeqno;</span><br><span class="line">     pipelineRecoveryCount = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If we had to recover the pipeline five times in a row for the</span></span><br><span class="line">    <span class="comment">// same packet, this client likely has corrupt data or corrupting</span></span><br><span class="line">    <span class="comment">// during transmission.</span></span><br><span class="line">    <span class="keyword">if</span> (++pipelineRecoveryCount &gt; <span class="number">5</span>) &#123;</span><br><span class="line">      DFSClient.LOG.warn(<span class="string">&quot;Error recovering pipeline for writing &quot;</span> +</span><br><span class="line">          block + <span class="string">&quot;. Already retried 5 times for the same packet.&quot;</span>);</span><br><span class="line">      lastException.set(<span class="keyword">new</span> IOException(<span class="string">&quot;Failing write. Tried pipeline &quot;</span> +</span><br><span class="line">          <span class="string">&quot;recovery 5 times without success.&quot;</span>));</span><br><span class="line">      streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  <span class="keyword">boolean</span> doSleep = setupPipelineForAppendOrRecovery();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_CLOSE) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If we had an error while closing the pipeline, we go through a fast-path</span></span><br><span class="line">      <span class="comment">// where the BlockReceiver does not run. Instead, the DataNode just finalizes</span></span><br><span class="line">      <span class="comment">// the block immediately during the &#x27;connect ack&#x27; process. So, we want to pull</span></span><br><span class="line">      <span class="comment">// the end-of-block packet from the dataQueue, since we don&#x27;t actually have</span></span><br><span class="line">      <span class="comment">// a true pipeline to send it over.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// We also need to set lastAckedSeqno to the end-of-block Packet&#x27;s seqno, so that</span></span><br><span class="line">      <span class="comment">// a client waiting on close() will be aware that the flush finished.</span></span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        Packet endOfBlockPacket = dataQueue.remove();  <span class="comment">// remove the end of block packet</span></span><br><span class="line">        <span class="keyword">assert</span> endOfBlockPacket.lastPacketInBlock;</span><br><span class="line">        <span class="keyword">assert</span> lastAckedSeqno == endOfBlockPacket.seqno - <span class="number">1</span>;</span><br><span class="line">        lastAckedSeqno = endOfBlockPacket.seqno;</span><br><span class="line">        dataQueue.notifyAll();</span><br><span class="line">      &#125;</span><br><span class="line">      endBlock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      initDataStreaming();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> doSleep;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setupPipelineForAppendOrRecovery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// check number of datanodes</span></span><br><span class="line">  <span class="keyword">if</span> (nodes == <span class="keyword">null</span> || nodes.length == <span class="number">0</span>) &#123;</span><br><span class="line">    String msg = <span class="string">&quot;Could not get block locations. &quot;</span> + <span class="string">&quot;Source file \&quot;&quot;</span></span><br><span class="line">        + src + <span class="string">&quot;\&quot; - Aborting...&quot;</span>;</span><br><span class="line">    DFSClient.LOG.warn(msg);</span><br><span class="line">    setLastException(<span class="keyword">new</span> IOException(msg));</span><br><span class="line">    streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">long</span> newGS = <span class="number">0L</span>;</span><br><span class="line">  <span class="keyword">while</span> (!success &amp;&amp; !streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">    <span class="comment">// Sleep before reconnect if a dn is restarting.</span></span><br><span class="line">    <span class="comment">// This process will be repeated until the deadline or the datanode</span></span><br><span class="line">    <span class="comment">// starts back up.</span></span><br><span class="line">    <span class="keyword">if</span> (restartingNodeIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 4 seconds or the configured deadline period, whichever is shorter.</span></span><br><span class="line">      <span class="comment">// This is the retry interval and recovery will be retried in this</span></span><br><span class="line">      <span class="comment">// interval until timeout or success.</span></span><br><span class="line">      <span class="keyword">long</span> delay = Math.min(dfsClient.getConf().datanodeRestartTimeout,</span><br><span class="line">          <span class="number">4000L</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(delay);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">        lastException.set(<span class="keyword">new</span> IOException(<span class="string">&quot;Interrupted while waiting for &quot;</span> +</span><br><span class="line">            <span class="string">&quot;datanode to restart. &quot;</span> + nodes[restartingNodeIndex]));</span><br><span class="line">        streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ­¤æ—¶hasErrorçš„å€¼ä¸ºtrue</span></span><br><span class="line">    <span class="keyword">boolean</span> isRecovery = hasError;</span><br><span class="line">    <span class="comment">// remove bad datanode from list of datanodes.</span></span><br><span class="line">    <span class="comment">// If errorIndex was not set (i.e. appends), then do not remove </span></span><br><span class="line">    <span class="comment">// any datanodes</span></span><br><span class="line">    <span class="keyword">if</span> (errorIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      StringBuilder pipelineMsg = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; nodes.length; j++) &#123;</span><br><span class="line">        pipelineMsg.append(nodes[j]);</span><br><span class="line">        <span class="keyword">if</span> (j &lt; nodes.length - <span class="number">1</span>) &#123;</span><br><span class="line">          pipelineMsg.append(<span class="string">&quot;, &quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (nodes.length &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        lastException.set(<span class="keyword">new</span> IOException(<span class="string">&quot;All datanodes &quot;</span> + pipelineMsg</span><br><span class="line">            + <span class="string">&quot; are bad. Aborting...&quot;</span>));</span><br><span class="line">        streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      DFSClient.LOG.warn(<span class="string">&quot;Error Recovery for block &quot;</span> + block +</span><br><span class="line">          <span class="string">&quot; in pipeline &quot;</span> + pipelineMsg + </span><br><span class="line">          <span class="string">&quot;: bad datanode &quot;</span> + nodes[errorIndex]);</span><br><span class="line">      failed.add(nodes[errorIndex]);</span><br><span class="line"></span><br><span class="line">      DatanodeInfo[] newnodes = <span class="keyword">new</span> DatanodeInfo[nodes.length-<span class="number">1</span>];</span><br><span class="line">      arraycopy(nodes, newnodes, errorIndex);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> StorageType[] newStorageTypes = <span class="keyword">new</span> StorageType[newnodes.length];</span><br><span class="line">      arraycopy(storageTypes, newStorageTypes, errorIndex);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> String[] newStorageIDs = <span class="keyword">new</span> String[newnodes.length];</span><br><span class="line">      arraycopy(storageIDs, newStorageIDs, errorIndex);</span><br><span class="line">      <span class="comment">// ç”¨å‰©ä¸‹çš„dnç»„æˆä¸€ä¸ªæ–°çš„pipeline</span></span><br><span class="line">      setPipeline(newnodes, newStorageTypes, newStorageIDs);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Just took care of a node error while waiting for a node restart</span></span><br><span class="line">      <span class="keyword">if</span> (restartingNodeIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If the error came from a node further away than the restarting</span></span><br><span class="line">        <span class="comment">// node, the restart must have been complete.</span></span><br><span class="line">        <span class="keyword">if</span> (errorIndex &gt; restartingNodeIndex) &#123;</span><br><span class="line">          restartingNodeIndex = -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errorIndex &lt; restartingNodeIndex) &#123;</span><br><span class="line">          <span class="comment">// the node index has shifted.</span></span><br><span class="line">          restartingNodeIndex--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// this shouldn&#x27;t happen...</span></span><br><span class="line">          <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        hasError = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      lastException.set(<span class="keyword">null</span>);</span><br><span class="line">      errorIndex = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦éœ€è¦æ›¿æ¢å‘ç”Ÿæ•…éšœçš„dnä»è€Œç»„æˆä¸€ä¸ªæ–°çš„pipeline</span></span><br><span class="line">    <span class="comment">// ç”±dfs.client.block.write.replace-datanode-on-failure.policyå‚æ•°æ§åˆ¶ç­–ç•¥</span></span><br><span class="line">    <span class="comment">// Check if replace-datanode policy is satisfied.</span></span><br><span class="line">    <span class="keyword">if</span> (dfsClient.dtpReplaceDatanodeOnFailure.satisfy(blockReplication,</span><br><span class="line">        nodes, isAppend, isHflushed)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å‘pipelineä¸­æ–°åŠ ä¸€ä¸ªdn</span></span><br><span class="line">        addDatanode2ExistingPipeline();</span><br><span class="line">      &#125; <span class="keyword">catch</span>(IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">if</span> (!dfsClient.dtpReplaceDatanodeOnFailure.isBestEffort()) &#123;</span><br><span class="line">          <span class="keyword">throw</span> ioe;</span><br><span class="line">        &#125;</span><br><span class="line">        DFSClient.LOG.warn(<span class="string">&quot;Failed to replace datanode.&quot;</span></span><br><span class="line">            + <span class="string">&quot; Continue with the remaining datanodes since &quot;</span></span><br><span class="line">            + DFSConfigKeys.DFS_CLIENT_WRITE_REPLACE_DATANODE_ON_FAILURE_BEST_EFFORT_KEY</span><br><span class="line">            + <span class="string">&quot; is set to true.&quot;</span>, ioe);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// get a new generation stamp and an access token</span></span><br><span class="line">    LocatedBlock lb = dfsClient.namenode.updateBlockForPipeline(block, dfsClient.clientName);</span><br><span class="line">    newGS = lb.getBlock().getGenerationStamp();</span><br><span class="line">    accessToken = lb.getBlockToken();</span><br><span class="line">    <span class="comment">// set up the pipeline again with the remaining nodes</span></span><br><span class="line">    <span class="keyword">if</span> (failPacket) &#123; <span class="comment">// for testing</span></span><br><span class="line">      success = createBlockOutputStream(nodes, storageTypes, newGS, isRecovery);</span><br><span class="line">      failPacket = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Give DNs time to send in bad reports. In real situations,</span></span><br><span class="line">        <span class="comment">// good reports should follow bad ones, if client committed</span></span><br><span class="line">        <span class="comment">// with those nodes.</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      success = createBlockOutputStream(nodes, storageTypes, newGS, isRecovery);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (restartingNodeIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">assert</span> hasError == <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">// check errorIndex set above</span></span><br><span class="line">      <span class="keyword">if</span> (errorIndex == restartingNodeIndex) &#123;</span><br><span class="line">        <span class="comment">// ignore, if came from the restarting node</span></span><br><span class="line">        errorIndex = -<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// still within the deadline</span></span><br><span class="line">      <span class="keyword">if</span> (Time.now() &lt; restartDeadline) &#123;</span><br><span class="line">        <span class="keyword">continue</span>; <span class="comment">// with in the deadline</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// expired. declare the restarting node dead</span></span><br><span class="line">      restartDeadline = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">int</span> expiredNodeIndex = restartingNodeIndex;</span><br><span class="line">      restartingNodeIndex = -<span class="number">1</span>;</span><br><span class="line">      DFSClient.LOG.warn(<span class="string">&quot;Datanode did not restart in time: &quot;</span> +</span><br><span class="line">          nodes[expiredNodeIndex]);</span><br><span class="line">      <span class="comment">// Mark the restarting node as failed. If there is any other failed</span></span><br><span class="line">      <span class="comment">// node during the last pipeline construction attempt, it will not be</span></span><br><span class="line">      <span class="comment">// overwritten/dropped. In this case, the restarting node will get</span></span><br><span class="line">      <span class="comment">// excluded in the following attempt, if it still does not come up.</span></span><br><span class="line">      <span class="keyword">if</span> (errorIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        errorIndex = expiredNodeIndex;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// From this point on, normal pipeline recovery applies.</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="comment">// while</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (success) &#123;</span><br><span class="line">    <span class="comment">// update pipeline at the namenode</span></span><br><span class="line">    ExtendedBlock newBlock = <span class="keyword">new</span> ExtendedBlock(</span><br><span class="line">        block.getBlockPoolId(), block.getBlockId(), block.getNumBytes(), newGS);</span><br><span class="line">    dfsClient.namenode.updatePipeline(dfsClient.clientName, block, newBlock,</span><br><span class="line">        nodes, storageIDs);</span><br><span class="line">    <span class="comment">// update client side generation stamp</span></span><br><span class="line">    block = newBlock;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// do not sleep, continue processing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨pipelineä¸­æ˜¯å¦æ›¿æ¢å‘ç”Ÿæ•…éšœçš„dnä¸å‰©ä¸‹çš„dnç»„æˆæ–°çš„pipelineçš„åˆ¤æ–­æ¡ä»¶æ˜¯é€šè¿‡ä¸èƒ½çš„replaceç­–ç•¥å†³å®šçš„ï¼Œé»˜è®¤æ˜¯defaultç­–ç•¥ï¼Œç”±<em>dfs.client.block.write.replace-datanode-on-failure.policy</em>æ§åˆ¶ï¼Œdefaultç­–ç•¥å¦‚ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DEFAULT condition:</span></span><br><span class="line"><span class="comment"> *   Let r be the replication number.</span></span><br><span class="line"><span class="comment"> *   Let n be the number of existing datanodes.</span></span><br><span class="line"><span class="comment"> *   Add a new datanode only if r &gt;= 3 and either</span></span><br><span class="line"><span class="comment"> *   (1) floor(r/2) &gt;= n; or</span></span><br><span class="line"><span class="comment"> *   (2) r &gt; n and the block is hflushed/appended.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">satisfy</span><span class="params">(<span class="keyword">final</span> <span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DatanodeInfo[] existings, <span class="keyword">final</span> <span class="keyword">int</span> n, <span class="keyword">final</span> <span class="keyword">boolean</span> isAppend,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">boolean</span> isHflushed)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (replication &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (n &lt;= (replication/<span class="number">2</span>)) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> isAppend || isHflushed;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>æ˜¯è¯´3ä¸ªdnç»„æˆçš„pipelineæœ‰ä¸€ä¸ªdnå‘ç”Ÿæ•…éšœä¸ä¼šæ›¿æ¢å‘ç”Ÿæ•…éšœçš„dnï¼Ÿé‚£ä½•æ—¶ä¼šæœ‰ä¸¤ä¸ªdnå‘ç”Ÿæ•…éšœï¼Œåœ¨ResponseProcessorä¸­åªæ£€æµ‹ç¬¬ä¸€ä¸ªå‘ç”Ÿæ•…éšœçš„dnå¹¶è®¾ç½®errorIndexä¸ºè¯¥dnçš„ç´¢å¼•ï¼Œåœ¨å“ªé‡Œä¼šæ£€æŸ¥å‘ç”Ÿå¤šä¸ªdnæ•…éšœï¼Ÿï¼Ÿï¼Ÿ</strong></p><p>ä¸Šé¢æ˜¯pipeline streamç›¸å…³çš„å†…å®¹ï¼Œæœ‰äº›è¿˜æ˜¯ä¸æ˜¯å¤ªæ¸…æ¥šï¼Œéšåå†æ ¹æ®ä¸æ–­çš„å•ƒä»£ç ä¸æ–­åŠ æ·±ç†è§£ç„¶åå†æ›´æ–°å§ã€‚</p><h2 id="pipeline-close-amp-error"><a href="#pipeline-close-amp-error" class="headerlink" title="pipeline close &amp; error"></a>pipeline close &amp; error</h2><h3 id="pipeline-close"><a href="#pipeline-close" class="headerlink" title="pipeline close"></a>pipeline close</h3><p>clientç«¯åœ¨DataStreamer.runä¸­é¦–å…ˆåˆ¤æ–­å½“å‰packetæ˜¯å¦ä¸ºlastPacketInBlockï¼Œå¦‚æœæ˜¯åˆ™é˜»å¡ç›´åˆ°ackQueueä¸­çš„packetè¿”å›çš„ackéƒ½è¢«clientæ”¶åˆ°ï¼Œç„¶åè®¾ç½®pipelineçš„çŠ¶æ€ä¸º<em>BlockConstructionStage.PIPELINE_CLOSE</em>ã€‚</p><p>æ¥ç€å°†å½“å‰packetä¹Ÿå°±æ˜¯blockä¸­çš„æœ€åä¸€ä¸ªpacketå‘é€åˆ°pipelineä¸­ï¼Œå°†æ­¤packetå‘é€åˆ°pipelineä¸­åˆ™ç­‰å¾…æ”¶åˆ°è¯¥packetçš„ackä¹‹åè°ƒç”¨<code>endBlock()</code>å°†è¿æ¥å…³é—­å¹¶å°†pipelineç½®ä¸ºåˆå§‹çŠ¶æ€ã€‚</p><p>åœ¨dnç«¯é¦–å…ˆé€šè¿‡DataXceiver.writeBlockè°ƒç”¨BlockReceiver.receiverPacketï¼Œåœ¨å…¶ä¸­åˆ¤æ–­<code>lastPacketInBlock || len == 0</code>å¹¶ä¸”**syncBlock(å…·ä½“ç”¨æ¥å¹²ä»€ä¹ˆï¼Ÿï¼Ÿ)**ä¸ºtrueåˆ™è°ƒç”¨<code>flushOrSync(true)</code>å°†dataå’Œmetaå†™å…¥ç£ç›˜ã€‚<br>å…¶æ¬¡åœ¨PacketResponderçº¿ç¨‹ä¸­åœ¨æ¥æ”¶ä¸‹æ¸¸ackä¹‹ååˆ¤æ–­ä»ackQueueä¸­å–å‡ºçš„packetæ˜¯å¦ä¸ºlastPacketBlockï¼Œå¦‚æœæ˜¯åˆ™è°ƒç”¨<code>finalizeBlock(startTime)</code>ï¼Œç„¶åå‘ä¸Šæ¸¸å‘é€ack</p><h3 id="errors-in-pipeline-close"><a href="#errors-in-pipeline-close" class="headerlink" title="errors in pipeline close"></a>errors in pipeline close</h3><p>clientç«¯åœ¨closeé˜¶æ®µå¯èƒ½å‘ç”Ÿerrorçš„åœ°æ–¹æ˜¯å°†æœ€åä¸€ä¸ªpacketå‘é€åˆ°pipelineæ—¶å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸ç„¶åå°†hasErrorç½®ä¸ºtrue</p><p>dnç«¯åœ¨closeé˜¶æ®µå‘ç”Ÿerrorçš„åœ°æ–¹å¯èƒ½æ˜¯åœ¨BlockReceiver.receiverPacketä¸­åˆ¤æ–­packetä¸ºæœ€åä¸€ä¸ªpacketå¹¶ä¸”syncBlockä¸ºtrueåˆ™è°ƒç”¨flushOrSync(true)ï¼ŒflushOrSync(true)å¯èƒ½ä¼šæŠ›å‡ºå¼‚å¸¸(<em>è¯¥IOExceptionä¸€è·¯ä»DataXceiver.writeBlockä¸­æŠ›å‡º</em>)ã€‚</p><h3 id="pipeline-closeå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤"><a href="#pipeline-closeå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤" class="headerlink" title="pipeline closeå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤"></a>pipeline closeå‘ç”Ÿerrorä¹‹åçš„ä¿®å¤</h3><p>clientç«¯å‘é€errorå°†hasErrorç½®ä¸ºtrueï¼Œä¼šæ‰§è¡Œ<code>processDatanodeError</code>å—ï¼Ÿï¼Ÿï¼Ÿ<br>ä¸ä¼šæ‰§è¡Œï¼Ÿï¼Ÿä½†æ˜¯åœ¨processDatanodeErrorä»£ç ä¸­æœ‰è¿™æ ·ä¸€æ®µï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">  <span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_CLOSE) &#123;</span><br><span class="line">    <span class="comment">// If we had an error while closing the pipeline, we go through a fast-path</span></span><br><span class="line">    <span class="comment">// where the BlockReceiver does not run. Instead, the DataNode just finalizes</span></span><br><span class="line">    <span class="comment">// the block immediately during the &#x27;connect ack&#x27; process. So, we want to pull</span></span><br><span class="line">    <span class="comment">// the end-of-block packet from the dataQueue, since we don&#x27;t actually have</span></span><br><span class="line">    <span class="comment">// a true pipeline to send it over.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// We also need to set lastAckedSeqno to the end-of-block Packet&#x27;s seqno, so that</span></span><br><span class="line">    <span class="comment">// a client waiting on close() will be aware that the flush finished.</span></span><br><span class="line">    <span class="comment">// å¦‚æœåœ¨pipeline closeé˜¶æ®µå‘ç”Ÿerrorï¼Œæœ‰ä¸€ä¸ªå¿«é€Ÿçš„æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸ç”¨åœ¨dnä¸Šnew BlockReceiver</span></span><br><span class="line">    <span class="comment">// è€Œæ˜¯è®©dnåœ¨pipelineé‡å»ºæ—¶å°±ç«‹é©¬ä½¿block Finalizedã€‚å› æ­¤åªæ˜¯å°†æœ€åä¸€ä¸ªpacketä»dataQueueä¸­å–å‡º</span></span><br><span class="line">    <span class="comment">// æ²¡æœ‰å¿…è¦å¾€ä¸€ä¸ªpipelineä¸­å‘é€ã€‚</span></span><br><span class="line">    <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">      Packet endOfBlockPacket = dataQueue.remove();  <span class="comment">// remove the end of block packet</span></span><br><span class="line">      <span class="keyword">assert</span> endOfBlockPacket.lastPacketInBlock;</span><br><span class="line">      <span class="keyword">assert</span> lastAckedSeqno == endOfBlockPacket.seqno - <span class="number">1</span>;</span><br><span class="line">      lastAckedSeqno = endOfBlockPacket.seqno;</span><br><span class="line">      dataQueue.notifyAll();</span><br><span class="line">    &#125;</span><br><span class="line">    endBlock();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    initDataStreaming();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¼šæ‰§è¡Œï¼Ÿï¼Ÿä½†æ˜¯errorIndexå¯èƒ½ä¸º-1å‘€ã€‚ã€‚ã€‚ã€‚</p><p>pipelineåœ¨closeé˜¶æ®µæ˜¯å·²ç»å°†ä¹‹å‰çš„packetçš„ackè¿”å›ç»™clientï¼Œç„¶åclientæ‰ä¼šå‘é€æœ€åä¸€ä¸ªpacket(<em>æ­¤packetä¸ºnull</em>)åˆ°pipelineä¸­ï¼Œé‚£ä¹ˆåœ¨dnç«¯çš„erroråº”è¯¥å’Œpipeline streamé˜¶æ®µåœ¨dnç«¯å‘ç”Ÿçš„erroræƒ…å†µç±»ä¼¼ï¼Œè¿˜æ²¡æœ‰å…·ä½“ææ˜ç™½ï¼Ÿï¼Ÿï¼Ÿï¼Ÿã€‚</p><hr><p>è€ƒè™‘å®¢æˆ·ç«¯å†™æ–‡ä»¶çš„è¿‡ç¨‹ä¸­å®•æœºï¼Œé‚£ä¹ˆåœ¨lease soft limitè¿‡æœŸä¹‹å‰ï¼Œå…¶ä»–çš„å®¢æˆ·ç«¯ä¸èƒ½å†™è¿™ä¸ªæ–‡ä»¶ï¼Œç­‰åˆ°lease soft limitè¿‡æœŸåï¼Œå…¶ä»–å®¢æˆ·ç«¯å¯ä»¥å†™è¿™ä¸ªæ–‡ä»¶ï¼Œåœ¨å†™æ–‡ä»¶ä¹‹å‰ï¼Œä¼šé¦–å…ˆæ£€æŸ¥æ–‡ä»¶æ˜¯ä¸æ˜¯æ²¡æœ‰å…³é—­ï¼Œå¦‚æœæ²¡æœ‰ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥lease recoveryå’Œblock recoveryé˜¶æ®µï¼Œè¿™ä¸ªé˜¶æ®µçš„ç›®çš„æ˜¯ä½¿æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockçš„æ‰€æœ‰å‰¯æœ¬æ•°æ®è¾¾åˆ°ä¸€è‡´ï¼Œå› ä¸ºå®¢æˆ·ç«¯å†™blockçš„å¤šä¸ªå‰¯æœ¬æ˜¯pipelineå†™ï¼Œpipelineä¸­çš„å‰¯æœ¬æ•°æ®ä¸ä¸€è‡´å¾ˆæ­£å¸¸ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> write </tag>
            
            <tag> fail </tag>
            
            <tag> pipeline </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFS writeè§£æ</title>
      <link href="/HDFS%20write%E8%A7%A3%E6%9E%90.html"/>
      <url>/HDFS%20write%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡ä¸»è¦è®°å½•ä¸‹HDFSå†™æ–‡ä»¶çš„æµç¨‹ã€‚å…¶å†™å…¥æµç¨‹ä¸æ™®é€šæ–‡ä»¶å†™å…¥æµç¨‹ç±»ä¼¼ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªè¾“å‡ºæµOutputStreamï¼Œç„¶åé€šè¿‡è¿™ä¸ªè¾“å‡ºæµå†™å…¥æ•°æ®ã€‚åœ¨HDFSä¸­æ•°æ®ä¼ è¾“çš„åŸºæœ¬å•å…ƒä¸ºPacket(é»˜è®¤64k)ï¼Œæ¯ä¸ªpacketåˆç”±å¾ˆå¤šä¸ªchunkç»„æˆï¼Œchunkæ˜¯æ–‡ä»¶æ ¡éªŒçš„åŸºæœ¬å•ä½ï¼Œä¸€ä¸ªchunkä¸€ä¸ªchunksumï¼Œchunkæ˜¯æ ¡éªŒå•ä½ä¹Ÿå°±æ˜¯å†™å…¥å•ä½ï¼Œå°†chunkå†™å…¥packetï¼Œä¸€ä¸ªpacketå†™æ»¡ä¹‹åï¼Œå°†packetå‘é€åˆ°pipelineä¸­ã€‚</p><p>ä¸‹é¢ä»ä»£ç å±‚æ¬¡å»è¯¦ç»†è§£è¯»ä¸‹writeæµç¨‹ã€‚å…¶å†™å…¥æµç¨‹å›¾å¦‚ä¸‹ï¼š<br>![writeæµç¨‹å›¾](/blogimgs/HDFS writeè§£æ/hdfs-write-flow.png â€œwriteæµç¨‹å›¾â€)</p><span id="more"></span><h2 id="åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµ"><a href="#åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµ" class="headerlink" title="åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµ"></a>åˆ›å»ºä¸€ä¸ªè¾“å‡ºæµ</h2><p>HDFSå†™æ–‡ä»¶è·Ÿjavaå†™æ–‡ä»¶ç±»ä¼¼ï¼Œéƒ½éœ€è¦å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµï¼ŒHDFSæ˜¯é€šè¿‡<em>FileSystem</em>å¯¹è±¡æ‰“å¼€æ–‡ä»¶æµçš„ï¼Œä»£ç æµç¨‹ä¸ºé€šè¿‡<code>FileSystem.get(conf)</code>å¾—åˆ°ä¸€ä¸ª<code>FileSystem</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨<code>create(Path)</code>æˆ–è€…<code>append(Path)</code>æ‰“å¼€ä¸€ä¸ªFSDataOutputStreamæµï¼Œçœ‹ä¸‹createä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(Path f)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> create(f, <span class="keyword">true</span>); <span class="comment">// Path overwrite</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FileSystemæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå°†å…·ä½“çš„<code>create</code>çš„å…·ä½“æ“ä½œç•™ç»™å­ç±»å®ç°ï¼Œä¾‹å¦‚DistributedFileSystemã€WebHdfsFileSystemç­‰ï¼Œä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå…·æœ‰ä¸åŒæ‰“å¼€æ–‡ä»¶çš„è¡Œä¸ºï¼Œæˆ‘ä»¬ä»¥DistributedFileSystemä¸ºä¾‹ï¼Œcreateæ–¹æ³•å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">create</span><span class="params">(<span class="keyword">final</span> Path f, <span class="keyword">final</span> FsPermission permission,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> EnumSet&lt;CreateFlag&gt; cflags, <span class="keyword">final</span> <span class="keyword">int</span> bufferSize,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> <span class="keyword">short</span> replication, <span class="keyword">final</span> <span class="keyword">long</span> blockSize, <span class="keyword">final</span> Progressable progress,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> ChecksumOpt checksumOpt)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  statistics.incrementWriteOps(<span class="number">1</span>);</span><br><span class="line">  Path absF = fixRelativePart(f);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FileSystemLinkResolver&lt;FSDataOutputStream&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">doCall</span><span class="params">(<span class="keyword">final</span> Path p)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, UnresolvedLinkException </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> DFSOutputStream dfsos = dfs.create(getPathName(p), permission,</span><br><span class="line">              cflags, replication, blockSize, progress, bufferSize,</span><br><span class="line">              checksumOpt);</span><br><span class="line">      <span class="keyword">return</span> dfs.createWrappedOutputStream(dfsos, statistics);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FSDataOutputStream <span class="title">next</span><span class="params">(<span class="keyword">final</span> FileSystem fs, <span class="keyword">final</span> Path p)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> fs.create(p, permission, cflags, bufferSize,</span><br><span class="line">          replication, blockSize, progress, checksumOpt);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;.resolve(<span class="keyword">this</span>, absF);</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>DistributedFileSystem.create()ä¸­newä¸€ä¸ªFileSystemLinkResolverçš„åŒ¿åç±»ï¼Œåœ¨resolveä¸­è°ƒç”¨åœ¨åŒ¿åç±»ä¸­é‡å†™çš„<code>doCall()</code>æ–¹æ³•ï¼Œå¦‚æœdoCallæŠ›å‡ºUnresolvedLinkExceptionå¼‚å¸¸ï¼Œè¢«resolveæ•è·è°ƒç”¨<code>next()</code>ï¼Œè¿›è¡Œå†æ¬¡æ‰“å¼€ã€‚(<em>è¿™æ®µä»£ç è·Ÿopenä¸€ä¸ªFSDataInputStreamç±»ä¼¼</em>)</p><p>åœ¨<code>doCall()</code>ä¸­è°ƒç”¨<code>dfs.create</code>è¿”å›ä¸€ä¸ª<em>DFSOutputStream</em>å¯¹è±¡ï¼Œç„¶åå†é€šè¿‡<code>dfs.createWrappedOutputStream</code>åŒ…è£…ä¸€ä¸ª<em>HdfsDataOutputStream</em>å¯¹è±¡è¿”å›ç»™<em>FSDataOutputStream</em>ï¼ŒFSDataOutputStreamæ˜¯HdfsDataOutputStreamçš„çˆ¶ç±»ï¼Œè¿™æ ·å°±é€šè¿‡FileSystem.create(path)æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶æµã€‚</p><p>doCallä¸­dfsæ˜¯FSDataOutputStreamçš„æˆå‘˜å˜é‡DFSClientï¼Œå…¶createæ–¹æ³•ä¸­å¾—åˆ°ä¸€ä¸ªDFSOutputStreamå®ä¾‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DFSOutputStream <span class="title">create</span><span class="params">(String src, </span></span></span><br><span class="line"><span class="params"><span class="function">                           FsPermission permission,</span></span></span><br><span class="line"><span class="params"><span class="function">                           EnumSet&lt;CreateFlag&gt; flag, </span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Progressable progress,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">int</span> buffersize,</span></span></span><br><span class="line"><span class="params"><span class="function">                           ChecksumOpt checksumOpt)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> create(src, permission, flag, <span class="keyword">true</span>,</span><br><span class="line">      replication, blockSize, progress, buffersize, checksumOpt, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> DFSOutputStream <span class="title">create</span><span class="params">(String src, </span></span></span><br><span class="line"><span class="params"><span class="function">                           FsPermission permission,</span></span></span><br><span class="line"><span class="params"><span class="function">                           EnumSet&lt;CreateFlag&gt; flag, </span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">boolean</span> createParent,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">long</span> blockSize,</span></span></span><br><span class="line"><span class="params"><span class="function">                           Progressable progress,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="keyword">int</span> buffersize,</span></span></span><br><span class="line"><span class="params"><span class="function">                           ChecksumOpt checksumOpt,</span></span></span><br><span class="line"><span class="params"><span class="function">                           InetSocketAddress[] favoredNodes)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  checkOpen();</span><br><span class="line">  <span class="keyword">if</span> (permission == <span class="keyword">null</span>) &#123;</span><br><span class="line">    permission = FsPermission.getFileDefault();</span><br><span class="line">  &#125;</span><br><span class="line">  FsPermission masked = permission.applyUMask(dfsClientConf.uMask);</span><br><span class="line">  <span class="keyword">if</span>(LOG.isDebugEnabled()) &#123;</span><br><span class="line">    LOG.debug(src + <span class="string">&quot;: masked=&quot;</span> + masked);</span><br><span class="line">  &#125;</span><br><span class="line">  String[] favoredNodeStrs = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (favoredNodes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    favoredNodeStrs = <span class="keyword">new</span> String[favoredNodes.length];</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; favoredNodes.length; i++) &#123;</span><br><span class="line">      favoredNodeStrs[i] = </span><br><span class="line">          favoredNodes[i].getHostName() + <span class="string">&quot;:&quot;</span> </span><br><span class="line">                       + favoredNodes[i].getPort();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åœ¨å¾—åˆ°è¾“å‡ºæµçš„è¿‡ç¨‹ä¸­ï¼Œä¸ä¼šå¯¹leaseè¿›è¡Œæ£€æŸ¥ï¼Œ</span></span><br><span class="line">  <span class="comment">// åªæ˜¯åœ¨åˆ›å»ºfileæ—¶ï¼Œæ·»åŠ leaseï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºfileä¹‹åï¼Œæ ¹æ®åˆ›å»ºçš„file newä¸€ä¸ªFSDataOutputStream</span></span><br><span class="line">  <span class="keyword">final</span> DFSOutputStream result = DFSOutputStream.newStreamForCreate(<span class="keyword">this</span>,</span><br><span class="line">      src, masked, flag, createParent, replication, blockSize, progress,</span><br><span class="line">      buffersize, dfsClientConf.createChecksum(checksumOpt),</span><br><span class="line">      favoredNodeStrs);</span><br><span class="line">  <span class="comment">// å¾—åˆ°è¾“å‡ºæµï¼Œä¹Ÿå°±å¾—åˆ°äº†è¯¥fileçš„leaseï¼Œå¾—åˆ°leaseä¹‹åå°±åº”è¯¥èµ·ä¸ªçº¿ç¨‹å¯¹å…¶è¿›è¡Œç»­çº¦</span></span><br><span class="line">  beginFileLease(result.getFileId(), result);</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>æ–‡ä»¶çš„çˆ¶ç›®å½•å¦‚æœä¸å­˜åœ¨ï¼Œdfs.createæ—¶ä¼šè‡ªåŠ¨åˆ›å»ºå…¶çˆ¶ç›®å½•ï¼Œåœ¨dfs.createä¼ å‚æ—¶ï¼Œå°†createParentè®¾ç½®ä¸ºtrueã€‚</p><p>dfs.createä¸­å¾—åˆ°ä¸€ä¸ªDFSOutputStreamçš„å®ä¾‹ï¼ŒDFSOutputStreamå®ä¾‹é€šè¿‡é™æ€æ–¹æ³•newStreamForCreateå¾—åˆ°ã€‚åœ¨HDFSå†™æ–‡ä»¶ä¸­æ˜¯é€šè¿‡Lease(ç§Ÿçº¦)æ¥ç»´æŠ¤å†™æ–‡ä»¶å‡­è¯çš„ï¼Œæ‰€ä»¥å¾—åˆ°ä¸€ä¸ªæ–‡ä»¶çš„å†™æƒé™ä¹‹åå°†å…¶ç§Ÿçº¦è¿›è¡Œå­˜å‚¨å¹¶å®šæ—¶æ›´æ–°ã€‚</p><h3 id="DFSOutputStreamå®ä¾‹"><a href="#DFSOutputStreamå®ä¾‹" class="headerlink" title="DFSOutputStreamå®ä¾‹"></a>DFSOutputStreamå®ä¾‹</h3><p>DFSOutputStreamçš„æ„é€ æ–¹æ³•æ˜¯ç§æœ‰çš„ï¼Œåˆ™å®ä¾‹é€šè¿‡é™æ€æ–¹æ³•newStreamForCreateå¾—åˆ°ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> DFSOutputStream <span class="title">newStreamForCreate</span><span class="params">(DFSClient dfsClient, String src,</span></span></span><br><span class="line"><span class="params"><span class="function">    FsPermission masked, EnumSet&lt;CreateFlag&gt; flag, <span class="keyword">boolean</span> createParent,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize, Progressable progress, <span class="keyword">int</span> buffersize,</span></span></span><br><span class="line"><span class="params"><span class="function">    DataChecksum checksum, String[] favoredNodes)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  HdfsFileStatus stat = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Retry the create if we get a RetryStartFileException up to a maximum</span></span><br><span class="line">  <span class="comment">// number of times</span></span><br><span class="line">  <span class="keyword">boolean</span> shouldRetry = <span class="keyword">true</span>;</span><br><span class="line">  <span class="comment">// retryCount æ˜¯ 10</span></span><br><span class="line">  <span class="keyword">int</span> retryCount = CREATE_RETRY_COUNT;</span><br><span class="line">  <span class="keyword">while</span> (shouldRetry) &#123;</span><br><span class="line">    shouldRetry = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// rpc è°ƒç”¨</span></span><br><span class="line">      stat = dfsClient.namenode.create(src, masked, dfsClient.clientName,</span><br><span class="line">          <span class="keyword">new</span> EnumSetWritable&lt;CreateFlag&gt;(flag), createParent, replication,</span><br><span class="line">          blockSize, SUPPORTED_CRYPTO_VERSIONS);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RemoteException re) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> RetryStartFileException) &#123;</span><br><span class="line">        <span class="keyword">if</span> (retryCount &gt; <span class="number">0</span>) &#123;</span><br><span class="line">          shouldRetry = <span class="keyword">true</span>;</span><br><span class="line">          retryCount--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Too many retries because of encryption&quot;</span> +</span><br><span class="line">              <span class="string">&quot; zone operations&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Preconditions.checkNotNull(stat, <span class="string">&quot;HdfsFileStatus should not be null!&quot;</span>);</span><br><span class="line">  <span class="keyword">final</span> DFSOutputStream out = <span class="keyword">new</span> DFSOutputStream(dfsClient, src, stat,</span><br><span class="line">      flag, progress, checksum, favoredNodes);</span><br><span class="line">  <span class="comment">// å¯åŠ¨DataStreamerçº¿ç¨‹</span></span><br><span class="line">  out.start();</span><br><span class="line">  <span class="keyword">return</span> out;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>newStreamForCreateå…ˆé€šè¿‡rpcè¯·æ±‚namenodeåˆ›å»ºä¸€ä¸ªæ–‡ä»¶ï¼Œç„¶åé€šè¿‡è¯¥æ–‡ä»¶æ‰“å¼€ä¸€ä¸ªè¾“å‡ºæµã€‚</p><p>rpcè¯·æ±‚åˆ›å»ºæ–‡ä»¶å¯åŠ¨äº†é‡è¯•æœºåˆ¶ï¼Œé»˜è®¤é‡è¯•10æ¬¡ï¼Œé€šè¿‡<code>stat = dfsClient.namenode.create</code>åˆ›å»ºï¼ŒæˆåŠŸä¹‹åbreakå‡ºwhileå¾ªç¯ã€‚createè¿œç¨‹è°ƒç”¨çš„æµç¨‹ä¸ºNameNodeRpcServer.create -&gt; namesystem.startFile -&gt; startFileInt -&gt; startFileInternalã€‚åœ¨startFileInternalä¸­é€šè¿‡<code>newNode = dir.addFile(src, permissions, replication, blockSize, holder, clientMachine);</code>å‘namenodeä¸­æ·»åŠ ä¸€ä¸ªæ–‡ä»¶ï¼Œå¹¶å°†clientnameå¯¹srcçš„ç§Ÿçº¦è¿›è¡Œå­˜å‚¨<code>leaseManager.addLease(newNode.getFileUnderConstructionFeature().getClientName(), src);</code>ï¼Œå…³äºç§Ÿçº¦çš„æ›´å¤šå†…å®¹è¯·çœ‹<a href="http://bigdatadecode.top/HDFS%E7%A7%9F%E7%BA%A6%E8%A7%A3%E6%9E%90.html">HDFSä¸­ç§Ÿçº¦è§£æ</a></p><p>å…ˆçœ‹ä¸‹startFileInternalçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FSNamesystem.java</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> BlocksMapUpdateInfo <span class="title">startFileInternal</span><span class="params">(FSPermissionChecker pc, </span></span></span><br><span class="line"><span class="params"><span class="function">    String src, PermissionStatus permissions, String holder, </span></span></span><br><span class="line"><span class="params"><span class="function">    String clientMachine, <span class="keyword">boolean</span> create, <span class="keyword">boolean</span> overwrite, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> createParent, <span class="keyword">short</span> replication, <span class="keyword">long</span> blockSize, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> isLazyPersist, CipherSuite suite, CryptoProtocolVersion version,</span></span></span><br><span class="line"><span class="params"><span class="function">    EncryptedKeyVersion edek, <span class="keyword">boolean</span> logRetryEntry)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> FileAlreadyExistsException, AccessControlException,</span></span><br><span class="line"><span class="function">    UnresolvedLinkException, FileNotFoundException,</span></span><br><span class="line"><span class="function">    ParentNotDirectoryException, RetryStartFileException, IOException </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">assert</span> <span class="title">hasWriteLock</span><span class="params">()</span></span>;</span><br><span class="line">  <span class="comment">// Verify that the destination does not exist as a directory already.</span></span><br><span class="line">  <span class="keyword">final</span> INodesInPath iip = dir.getINodesInPath4Write(src);</span><br><span class="line">  <span class="keyword">final</span> INode inode = iip.getLastINode();</span><br><span class="line">  <span class="comment">// è¿™é‡Œåˆ¤æ–­è¯¥pathæ˜¯å¦å·²ç»ä»¥è·¯å¾„çš„å½¢å¼å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">if</span> (inode != <span class="keyword">null</span> &amp;&amp; inode.isDirectory()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> FileAlreadyExistsException(src +</span><br><span class="line">        <span class="string">&quot; already exists as a directory&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">final</span> INodeFile myFile = INodeFile.valueOf(inode, src, <span class="keyword">true</span>);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    BlocksMapUpdateInfo toRemoveBlocks = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// è¯¥fileä¸å­˜åœ¨åˆ™create</span></span><br><span class="line">    <span class="keyword">if</span> (myFile == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!create) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileNotFoundException(<span class="string">&quot;Can&#x27;t overwrite non-existent &quot;</span> +</span><br><span class="line">            src + <span class="string">&quot; for client &quot;</span> + clientMachine);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// è¯¥fileå·²ç»å­˜åœ¨ï¼Œåˆ™é‡å†™</span></span><br><span class="line">      <span class="keyword">if</span> (overwrite) &#123;</span><br><span class="line">        toRemoveBlocks = <span class="keyword">new</span> BlocksMapUpdateInfo();</span><br><span class="line">        List&lt;INode&gt; toRemoveINodes = <span class="keyword">new</span> ChunkedArrayList&lt;INode&gt;();</span><br><span class="line">        <span class="keyword">long</span> ret = dir.delete(src, toRemoveBlocks, toRemoveINodes, now());</span><br><span class="line">        <span class="keyword">if</span> (ret &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          incrDeletedFileCount(ret);</span><br><span class="line">          removePathAndBlocks(src, <span class="keyword">null</span>, toRemoveINodes, <span class="keyword">true</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// è¿™æ˜¯æ€ä¹ˆæ‰§è¡Œåˆ°è¿™çš„ï¼Ÿï¼Ÿ</span></span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// If lease soft limit time is expired, recover the lease</span></span><br><span class="line">        recoverLeaseInternal(myFile, src, holder, clientMachine, <span class="keyword">false</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> FileAlreadyExistsException(src + <span class="string">&quot; for client &quot;</span> +</span><br><span class="line">            clientMachine + <span class="string">&quot; already exists&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¼šæ£€æŸ¥æ•´ä¸ªhdfsä¸Šinodeçš„ä¸Šé™ï¼Œä¸€èˆ¬ä¸è®¾ç½®</span></span><br><span class="line">    <span class="comment">// æ›¾ç»è¢«é—®è¿‡hdfsä¸­blockçš„ä¸Šé™æ˜¯å¤šå°‘ï¼Œä¼°è®¡é—®çš„å°±æ˜¯è¿™ä¸ªå§</span></span><br><span class="line">    <span class="comment">// ç”±dfs.namenode.max.objectsæ§åˆ¶</span></span><br><span class="line">    <span class="comment">// è¿˜æœ‰ä¸ªå±æ€§æ§åˆ¶ä¸€ä¸ªfileçš„æœ€å¤šblockä¸ªæ•°ï¼Œé»˜è®¤æ˜¯1024*1024</span></span><br><span class="line">    <span class="comment">// dfs.namenode.fs-limits.max-blocks-per-fileæ§åˆ¶</span></span><br><span class="line">    checkFsObjectLimit();</span><br><span class="line">    INodeFile newNode = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Always do an implicit mkdirs for parent directory tree.</span></span><br><span class="line">    Path parent = <span class="keyword">new</span> Path(src).getParent();</span><br><span class="line">    <span class="comment">// é€’å½’çš„åˆ›å»ºçˆ¶ç›®å½•</span></span><br><span class="line">    <span class="keyword">if</span> (parent != <span class="keyword">null</span> &amp;&amp; mkdirsRecursively(parent.toString(),</span><br><span class="line">            permissions, <span class="keyword">true</span>, now())) &#123;</span><br><span class="line">      <span class="comment">// å°†fileæ·»åŠ åˆ°namespaceä¸­</span></span><br><span class="line">      newNode = dir.addFile(src, permissions, replication, blockSize,</span><br><span class="line">                            holder, clientMachine);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (newNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unable to add &quot;</span> + src +  <span class="string">&quot; to namespace&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†clientNameå¯¹fileçš„leaseæ”¾å…¥LeaseManagerä¸­</span></span><br><span class="line">    leaseManager.addLease(newNode.getFileUnderConstructionFeature()</span><br><span class="line">        .getClientName(), src);</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// record file record in log, record new generation stamp</span></span><br><span class="line">    getEditLog().logOpenFile(src, newNode, overwrite, logRetryEntry);</span><br><span class="line">    <span class="keyword">if</span> (NameNode.stateChangeLog.isDebugEnabled()) &#123;</span><br><span class="line">      NameNode.stateChangeLog.debug(<span class="string">&quot;DIR* NameSystem.startFile: added &quot;</span> +</span><br><span class="line">          src + <span class="string">&quot; inode &quot;</span> + newNode.getId() + <span class="string">&quot; &quot;</span> + holder);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> toRemoveBlocks;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">    NameNode.stateChangeLog.warn(<span class="string">&quot;DIR* NameSystem.startFile: &quot;</span> + src + <span class="string">&quot; &quot;</span> +</span><br><span class="line">        ie.getMessage());</span><br><span class="line">    <span class="keyword">throw</span> ie;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>åœ¨å¾—åˆ°FSDataOutputStreamæ—¶ï¼Œå¹¶æ²¡æœ‰å¯¹leaseè¿›è¡Œæ ¡éªŒï¼Œé‚£ä¹ˆå½“client1å¾—åˆ°fileAçš„FSDataOutputStreamä¹‹åï¼Œå°†å…¶å¯¹åº”çš„ç§Ÿçº¦addåˆ°LeaseManagerä¸­ï¼Œæ­¤æ—¶client2ä¹Ÿå†ç”³è¯·fileAçš„FSDataOutputStreamï¼Œæ­¤æ—¶ä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿclient2ä¹Ÿå¾—åˆ°fileAçš„è¾“å‡ºæµï¼Œå¹¶å°†client2å¯¹åº”çš„leaseä¹Ÿæ”¾å…¥LeaseManagerä¸­ï¼Ÿé‚£ä¹ˆæ­¤æ—¶å°±æœ‰ä¸¤ä¸ªclientæŒæœ‰æ–‡ä»¶fileAçš„ç§Ÿçº¦ã€‚  æ˜¯åœ¨å†™å…¥bytesæ—¶è¿›è¡Œlease æ£€æŸ¥å—ï¼Ÿï¼Ÿï¼Ÿç–‘æƒ‘ä¸­ã€‚ã€‚ã€‚</strong></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> Lease <span class="title">addLease</span><span class="params">(String holder, String src)</span> </span>&#123;</span><br><span class="line">  Lease lease = getLease(holder);</span><br><span class="line">  <span class="keyword">if</span> (lease == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// å¦‚æœå½“å‰clientæ²¡æœ‰ç§Ÿçº¦ï¼Œåˆ™åˆ›å»ºä¸€ä¸ª</span></span><br><span class="line">    lease = <span class="keyword">new</span> Lease(holder);</span><br><span class="line">    leases.put(holder, lease);</span><br><span class="line">    sortedLeases.add(lease);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// å½“å‰clientå·²ç»æŒæœ‰leaseï¼Œåˆ™æ›´æ–°æ—¶é—´</span></span><br><span class="line">    renewLease(lease);</span><br><span class="line">  &#125;</span><br><span class="line">  sortedLeasesByPath.put(src, lease);</span><br><span class="line">  lease.paths.add(src);</span><br><span class="line">  <span class="keyword">return</span> lease;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å›åˆ°newStreamForCreateä¸­ï¼Œé€šè¿‡namenodeåˆ›å»ºçš„æ–‡ä»¶newä¸€ä¸ªè¾“å‡ºæµ<code>DFSOutputStream out = new DFSOutputStream(dfsClient, src, stat, flag, progress, checksum, favoredNodes)</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">DFSOutputStream</span><span class="params">(DFSClient dfsClient, String src, HdfsFileStatus stat,</span></span></span><br><span class="line"><span class="params"><span class="function">    EnumSet&lt;CreateFlag&gt; flag, Progressable progress,</span></span></span><br><span class="line"><span class="params"><span class="function">    DataChecksum checksum, String[] favoredNodes)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(dfsClient, src, progress, stat, checksum);</span><br><span class="line">  <span class="keyword">this</span>.shouldSyncBlock = flag.contains(CreateFlag.SYNC_BLOCK);</span><br><span class="line">  <span class="comment">// packeté»˜è®¤å¤§å°64k</span></span><br><span class="line">  <span class="comment">// è®¡ç®—æ¯ä¸ªpacketçš„chunkä¸ªæ•°ï¼Œå’Œpacketçš„å¤§å°</span></span><br><span class="line">  computePacketChunkSize(dfsClient.getConf().writePacketSize, bytesPerChecksum);</span><br><span class="line">  Span traceSpan = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (Trace.isTracing()) &#123;</span><br><span class="line">    traceSpan = Trace.startSpan(<span class="keyword">this</span>.getClass().getSimpleName()).detach();</span><br><span class="line">  &#125;</span><br><span class="line">  streamer = <span class="keyword">new</span> DataStreamer(stat, traceSpan);</span><br><span class="line">  <span class="keyword">if</span> (favoredNodes != <span class="keyword">null</span> &amp;&amp; favoredNodes.length != <span class="number">0</span>) &#123;</span><br><span class="line">    streamer.setFavoredNodes(favoredNodes);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DFSOutputStreamä¸­æœ‰ä¸ªé‡è¦çš„çº¿ç¨‹DataStreamerï¼Œè¯¥çº¿ç¨‹ä¸»è¦è´Ÿè´£å‘pipelineä¸­çš„dnå‘é€packetã€‚</p><p>å†æ¬¡å›åˆ°newStreamForCreateä¸­ï¼Œè°ƒç”¨<code>out.start()</code>å¯åŠ¨DataStreamerçº¿ç¨‹ã€‚</p><p>DFSOutputStreamåˆ›å»ºå®Œæ¯•ä¹‹åï¼Œå›åˆ°DFSClient.createä¸­ï¼Œæ‰§è¡Œ<code>beginFileLease(result.getFileId(), result)</code>å¼€å¯Leaseå®šæ—¶Renewæœºåˆ¶LeaseRenewer</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Get a lease and start automatic renewal */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">beginFileLease</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> inodeId, <span class="keyword">final</span> DFSOutputStream out)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  getLeaseRenewer().put(inodeId, out, <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// LeaseRenewer æ˜¯å®¢æˆ·ç«¯checkæ˜¯å¦æ›´æ–°ç§Ÿçº¦</span></span><br><span class="line"><span class="comment">// A thread per namenode per user</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">put</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> inodeId, <span class="keyword">final</span> DFSOutputStream out,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DFSClient dfsc)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (dfsc.isClientRunning()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isRunning() || isRenewerExpired()) &#123;</span><br><span class="line">      <span class="comment">//start a new deamon with a new id.</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">int</span> id = ++currentId;</span><br><span class="line">      daemon = <span class="keyword">new</span> Daemon(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;Lease renewer daemon for &quot;</span> + clientsString()</span><br><span class="line">                  + <span class="string">&quot; with renew id &quot;</span> + id + <span class="string">&quot; started&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// è°ƒç”¨LeaseRenewer.run(final int id)</span></span><br><span class="line">            <span class="comment">// åœ¨runä¸­è°ƒç”¨renewå¯¹ç§Ÿçº¦ç»­çº¦</span></span><br><span class="line">            LeaseRenewer.<span class="keyword">this</span>.run(id);</span><br><span class="line">          &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(LeaseRenewer.<span class="keyword">this</span>.getClass().getSimpleName()</span><br><span class="line">                  + <span class="string">&quot; is interrupted.&quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            <span class="keyword">synchronized</span>(LeaseRenewer.<span class="keyword">this</span>) &#123;</span><br><span class="line">              Factory.INSTANCE.remove(LeaseRenewer.<span class="keyword">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">              LOG.debug(<span class="string">&quot;Lease renewer daemon for &quot;</span> + clientsString()</span><br><span class="line">                  + <span class="string">&quot; with renew id &quot;</span> + id + <span class="string">&quot; exited&quot;</span>);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> String <span class="title">toString</span><span class="params">()</span> </span>&#123;</span><br><span class="line">          <span class="keyword">return</span> String.valueOf(LeaseRenewer.<span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;);</span><br><span class="line">      daemon.start();</span><br><span class="line">    &#125;</span><br><span class="line">    dfsc.putFileBeingWritten(inodeId, out);</span><br><span class="line">    emptyTime = Long.MAX_VALUE;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>å›åˆ°daCallæ–¹æ³•ä¸­ï¼Œè°ƒç”¨<code>dfs.createWrappedOutputStream(dfsos, statistics)</code>ï¼Œå°†DFSOutputStreamå°è£…ä¸ºHdfsDataOutputStreamç±»å‹(FSDataOutputStreamå­ç±»)ï¼Œå°†ç»“æœreturnç»™FSDataOutputStreamç±»å‹çš„è¾“å‡ºæµã€‚åˆ°æ­¤FSDataOutputStreamè¾“å‡ºæµåˆ›å»ºå®Œæ¯•ã€‚æ¥ç€è¯¥è°ƒç”¨writeæ–¹æ³•ï¼Œè¿›è¡Œæ•°æ®çš„å†™å…¥ã€‚</p><h2 id="å‘è¾“å‡ºæµä¸­å†™bytesæ•°æ®æµ"><a href="#å‘è¾“å‡ºæµä¸­å†™bytesæ•°æ®æµ" class="headerlink" title="å‘è¾“å‡ºæµä¸­å†™bytesæ•°æ®æµ"></a>å‘è¾“å‡ºæµä¸­å†™bytesæ•°æ®æµ</h2><p>å†™å…¥æ“ä½œçš„APIæ˜¯é€šè¿‡FSDataOutputStreamçš„å¯¹è±¡outè°ƒç”¨write(byte[])ï¼Œè°ƒç”¨æµç¨‹ä¸ºout.write(bytes) -&gt; FilterOutputStream.write -&gt; DataOutputStream.write -&gt; out.write(byte[], off, len) -&gt; FSOutputSummer.write(byte b[], int off, int len)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">write</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;  </span><br><span class="line">  checkClosed();</span><br><span class="line">  <span class="keyword">if</span> (off &lt; <span class="number">0</span> || len &lt; <span class="number">0</span> || off &gt; b.length - len) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> ArrayIndexOutOfBoundsException();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> n=<span class="number">0</span>;n&lt;len;n+=write1(b, off+n, len-n)) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨writeä¸­æ ¹æ®å†™å…¥lenä¸æ–­çš„è°ƒç”¨<code>write1</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">write1</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// å†™å…¥é•¿åº¦å¤§äºæœ¬åœ°bufçš„é•¿åº¦æ—¶ï¼Œç›´æ¥å†™å…¥æœ¬åœ°bufçš„é•¿åº¦</span></span><br><span class="line">  <span class="keyword">if</span>(count==<span class="number">0</span> &amp;&amp; len&gt;=buf.length) &#123;</span><br><span class="line">    <span class="comment">// local buffer is empty and user buffer size &gt;= local buffer size, so</span></span><br><span class="line">    <span class="comment">// simply checksum the user buffer and send it directly to the underlying</span></span><br><span class="line">    <span class="comment">// stream</span></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> length = buf.length;</span><br><span class="line">    writeChecksumChunks(b, off, length);</span><br><span class="line">    <span class="keyword">return</span> length;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å½“lenå°äºæœ¬åœ°bufçš„é•¿åº¦æ—¶ï¼Œå…ˆå†™å…¥bufï¼Œå½“bufå†™æ»¡ä¹‹åï¼ŒflushBuffer</span></span><br><span class="line">  <span class="comment">// copy user data to local buffer</span></span><br><span class="line">  <span class="keyword">int</span> bytesToCopy = buf.length-count;</span><br><span class="line">  bytesToCopy = (len&lt;bytesToCopy) ? len : bytesToCopy;</span><br><span class="line">  System.arraycopy(b, off, buf, count, bytesToCopy);</span><br><span class="line">  count += bytesToCopy;</span><br><span class="line">  <span class="keyword">if</span> (count == buf.length) &#123;</span><br><span class="line">    <span class="comment">// local buffer is full</span></span><br><span class="line">    flushBuffer();</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">return</span> bytesToCopy;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>_å†™å…¥æ•°æ®æ—¶ï¼Œæ˜¯å…ˆå°†æ•°æ®å†™å…¥æœ¬åœ°buf_ï¼Œbufé»˜è®¤é•¿åº¦ä¸º<code>this.buf = new byte[sum.getBytesPerChecksum() * BUFFER\_NUM\_CHUNKS]; BUFFER\_NUM\_CHUNKS = 9</code>ï¼Œå³9ä¸ªchunkçš„é•¿åº¦4608ã€‚bufå†™æ»¡ä¹‹åå¯¹å…¶æ•°æ®ç”Ÿæˆchunksumå†™å…¥packetã€‚</p><p>å½“å†™å…¥æ•°æ®çš„lenå¤§äºbufçš„é•¿åº¦æ—¶ï¼Œåˆ™æ•°æ®ä¸å†™å…¥bufï¼Œç›´æ¥è°ƒç”¨<code>writeChecksumChunks</code>å°†bufé•¿åº¦å¤§å°çš„æ•°æ®ç”Ÿæˆchunksumï¼Œå¹¶å†™å…¥packetä¸­ã€‚<br>å½“å†™å…¥æ•°æ®çš„lenå°äºbufçš„é•¿åº¦æ—¶ï¼Œåˆ™å°†æ•°æ®copyåˆ°bufä¸­ï¼Œç­‰bufæ»¡æ—¶ï¼Œè°ƒç”¨<code>flushBuffer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">flushBuffer</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  flushBuffer(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">flushBuffer</span><span class="params">(<span class="keyword">boolean</span> keep,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> flushPartial)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> bufLen = count;</span><br><span class="line">  <span class="keyword">int</span> partialLen = bufLen % sum.getBytesPerChecksum();</span><br><span class="line">  <span class="keyword">int</span> lenToFlush = flushPartial ? bufLen : bufLen - partialLen;</span><br><span class="line">  <span class="keyword">if</span> (lenToFlush != <span class="number">0</span>) &#123;</span><br><span class="line">    writeChecksumChunks(buf, <span class="number">0</span>, lenToFlush);</span><br><span class="line">    <span class="keyword">if</span> (!flushPartial || keep) &#123;</span><br><span class="line">      count = partialLen;</span><br><span class="line">      System.arraycopy(buf, bufLen - count, buf, <span class="number">0</span>, count);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    count = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// total bytes left minus unflushed bytes left</span></span><br><span class="line">  <span class="keyword">return</span> count - (bufLen - lenToFlush);</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>åœ¨flushBufferä¸­ä¾ç„¶ä¼šè°ƒç”¨<code>writeChecksumChunks</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">writeChecksumChunks</span><span class="params">(<span class="keyword">byte</span> b[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span></span></span><br><span class="line"><span class="function"><span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// è®¡ç®—checksum</span></span><br><span class="line">  sum.calculateChunkedSums(b, off, len, checksum, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i += sum.getBytesPerChecksum()) &#123;</span><br><span class="line">    <span class="keyword">int</span> chunkLen = Math.min(sum.getBytesPerChecksum(), len - i);</span><br><span class="line">    <span class="keyword">int</span> ckOffset = i / sum.getBytesPerChecksum() * getChecksumSize();</span><br><span class="line">    <span class="comment">// ä¸€ä¸ªchunkä¸€ä¸ªchunkçš„å†™å…¥packet</span></span><br><span class="line">    writeChunk(b, off + i, chunkLen, checksum, ckOffset, getChecksumSize());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨writeChecksumChunksä¸­å…ˆè°ƒç”¨<code>calculateChunkedSums</code>è®¡ç®—æ•°æ®çš„checksumï¼Œç„¶åè°ƒç”¨<code>writeChunk</code>å°†æ¯ä¸ªchunkå†™å…¥packetä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DFSOutputStream.class</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">writeChunk</span><span class="params">(<span class="keyword">byte</span>[] b, <span class="keyword">int</span> offset, <span class="keyword">int</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">byte</span>[] checksum, <span class="keyword">int</span> ckoff, <span class="keyword">int</span> cklen)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å¦‚æœå½“å‰currentPacketä¸ºnullï¼Œåˆ™æ–°åˆ›å»ºä¸€ä¸ª</span></span><br><span class="line">  <span class="keyword">if</span> (currentPacket == <span class="keyword">null</span>) &#123;</span><br><span class="line">    currentPacket = createPacket(packetSize, chunksPerPacket, </span><br><span class="line">        bytesCurBlock, currentSeqno++);</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å…ˆå†™å…¥checksumï¼Œç„¶åå†™å…¥data</span></span><br><span class="line">  currentPacket.writeChecksum(checksum, ckoff, cklen);</span><br><span class="line">  currentPacket.writeData(b, offset, len);</span><br><span class="line">  currentPacket.numChunks++;</span><br><span class="line">  bytesCurBlock += len;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If packet is full, enqueue it for transmission</span></span><br><span class="line">  <span class="comment">// currentPacketå·²æ»¡ æˆ–è€…å½“å‰å†™å…¥blockçš„é•¿åº¦ç­‰äºblockçš„å¤§å°</span></span><br><span class="line">  <span class="keyword">if</span> (currentPacket.numChunks == currentPacket.maxChunks ||</span><br><span class="line">      bytesCurBlock == blockSize) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// å°†packetæ”¾å…¥é˜Ÿåˆ—dataQueueä¸­</span></span><br><span class="line">    waitAndQueueCurrentPacket();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If the reopened file did not end at chunk boundary and the above</span></span><br><span class="line">    <span class="comment">// write filled up its partial chunk. Tell the summer to generate full </span></span><br><span class="line">    <span class="comment">// crc chunks from now on.</span></span><br><span class="line">    <span class="keyword">if</span> (appendChunk &amp;&amp; bytesCurBlock%bytesPerChecksum == <span class="number">0</span>) &#123;</span><br><span class="line">      appendChunk = <span class="keyword">false</span>;</span><br><span class="line">      resetChecksumBufSize();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æœ€åä¸€ä¸ªpacketæ—¶ï¼Œå¯èƒ½ä¼šå°äºblockçš„å¤§å°ï¼Œéœ€é‡æ–°è®¡ç®—ä¸‹packetçš„å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (!appendChunk) &#123;</span><br><span class="line">      <span class="keyword">int</span> psize = Math.min((<span class="keyword">int</span>)(blockSize-bytesCurBlock), dfsClient.getConf().writePacketSize);</span><br><span class="line">      computePacketChunkSize(psize, bytesPerChecksum);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// if encountering a block boundary, send an empty packet to </span></span><br><span class="line">    <span class="comment">// indicate the end of block and reset bytesCurBlock.</span></span><br><span class="line">    <span class="comment">// è¾¾åˆ°blockå¤§å°ä¹‹åï¼Œå‘ç”Ÿä¸€ä¸ªç©ºçš„packet</span></span><br><span class="line">    <span class="keyword">if</span> (bytesCurBlock == blockSize) &#123;</span><br><span class="line">      currentPacket = createPacket(<span class="number">0</span>, <span class="number">0</span>, bytesCurBlock, currentSeqno++);</span><br><span class="line">      currentPacket.lastPacketInBlock = <span class="keyword">true</span>;</span><br><span class="line">      currentPacket.syncBlock = shouldSyncBlock;</span><br><span class="line">      waitAndQueueCurrentPacket();</span><br><span class="line">      bytesCurBlock = <span class="number">0</span>;</span><br><span class="line">      lastFlushOffset = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>writeChunk</code>å…ˆå°†chunkå†™å…¥currentPacketä¸­ï¼Œå½“currentPacketå†™æ»¡ä¹‹åè°ƒç”¨<code>waitAndQueueCurrentPacket</code>ï¼Œå°†packetæ”¾å…¥dataQueueé˜Ÿåˆ—ï¼Œç­‰å¾…DataStreamerçº¿ç¨‹å°†packetå†™å…¥pipelineä¸­ï¼Œ_æ•´ä¸ªblockå‘é€å®Œæ¯•ä¹‹åå°†å‘é€ä¸€ä¸ªç©ºçš„packet_ã€‚</p><p>å°†packetæ”¾å…¥dataQueueçš„é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitAndQueueCurrentPacket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// If queue is full, then wait till we have enough space</span></span><br><span class="line">    <span class="comment">// dfs.client.write.max-packets-in-flight é»˜è®¤å€¼80</span></span><br><span class="line">    <span class="comment">// å½“dataQueueå’ŒackQueueçš„å¤§å°ä¹‹å’Œå¤§äº80æ—¶ï¼Œç­‰å¾…</span></span><br><span class="line">    <span class="keyword">while</span> (!closed &amp;&amp; dataQueue.size() + ackQueue.size()  &gt; dfsClient.getConf().writeMaxPackets) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        dataQueue.wait();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        <span class="comment">// If we get interrupted while waiting to queue data, we still need to get rid</span></span><br><span class="line">        <span class="comment">// of the current packet. This is because we have an invariant that if</span></span><br><span class="line">        <span class="comment">// currentPacket gets full, it will get queued before the next writeChunk.</span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// Rather than wait around for space in the queue, we should instead try to</span></span><br><span class="line">        <span class="comment">// return to the caller as soon as possible, even though we slightly overrun</span></span><br><span class="line">        <span class="comment">// the MAX_PACKETS length.</span></span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    checkClosed();</span><br><span class="line">    <span class="comment">// å°†currentPacketæ”¾å…¥dataQueue</span></span><br><span class="line">    queueCurrentPacket();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">queueCurrentPacket</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (currentPacket == <span class="keyword">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    dataQueue.addLast(currentPacket);</span><br><span class="line">    lastQueuedSeqno = currentPacket.seqno;</span><br><span class="line">    <span class="keyword">if</span> (DFSClient.LOG.isDebugEnabled()) &#123;</span><br><span class="line">      DFSClient.LOG.debug(<span class="string">&quot;Queued packet &quot;</span> + currentPacket.seqno);</span><br><span class="line">    &#125;</span><br><span class="line">    currentPacket = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// é€šçŸ¥DataStreamerçº¿ç¨‹æ¶ˆè´¹</span></span><br><span class="line">    dataQueue.notifyAll();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h2 id="DFSOutputStream-DataStreamerå‘é€packet"><a href="#DFSOutputStream-DataStreamerå‘é€packet" class="headerlink" title="DFSOutputStream.DataStreamerå‘é€packet"></a>DFSOutputStream.DataStreamerå‘é€packet</h2><p>DFSOutputStreamä¸­æœ‰ä¸¤ä¸ªé˜Ÿåˆ—ï¼Œä¸€ä¸ªdataQueueä¸€ä¸ªackQueueï¼Œä¸¤ä¸ªé˜Ÿåˆ—å¤§å°çš„å’Œä¸èƒ½è¶…è¿‡_dfs.client.write.max-packets-in-flight_çš„å€¼ã€‚<br>å°†currentPacketæ”¾å…¥dataQueueä¸­ï¼Œå¹¶é€šçŸ¥DataStreamerçº¿ç¨‹æ¥æ¶ˆè´¹ï¼ŒDataStreamerçš„runæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataStreamer.run</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> lastPacket = Time.now();</span><br><span class="line">  TraceScope traceScope = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (traceSpan != <span class="keyword">null</span>) &#123;</span><br><span class="line">    traceScope = Trace.continueSpan(traceSpan);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// if the Responder encountered an error, shutdown Responder</span></span><br><span class="line">    <span class="keyword">if</span> (hasError &amp;&amp; response != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        response.close();</span><br><span class="line">        response.join();</span><br><span class="line">        response = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">        DFSClient.LOG.warn(<span class="string">&quot;Caught exception &quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Packet one;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// process datanode IO errors if any</span></span><br><span class="line">      <span class="keyword">boolean</span> doSleep = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (hasError &amp;&amp; (errorIndex &gt;= <span class="number">0</span> || restartingNodeIndex &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">        doSleep = processDatanodeError();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        <span class="comment">// wait for a packet to be sent.</span></span><br><span class="line">        <span class="keyword">long</span> now = Time.now();</span><br><span class="line">        <span class="comment">// dataQueueä¸ºnullï¼Œå¹¶ä¸”æ—¶é—´æœªè¶…æ—¶ï¼Œåˆ™ç­‰å¾…</span></span><br><span class="line">        <span class="keyword">while</span> ((!streamerClosed &amp;&amp; !hasError &amp;&amp; dfsClient.clientRunning </span><br><span class="line">            &amp;&amp; dataQueue.size() == <span class="number">0</span> &amp;&amp; </span><br><span class="line">            (stage != BlockConstructionStage.DATA_STREAMING || </span><br><span class="line">             stage == BlockConstructionStage.DATA_STREAMING &amp;&amp; </span><br><span class="line">             now - lastPacket &lt; dfsClient.getConf().socketTimeout/<span class="number">2</span>)) || doSleep ) &#123;</span><br><span class="line">          <span class="keyword">long</span> timeout = dfsClient.getConf().socketTimeout/<span class="number">2</span> - (now-lastPacket);</span><br><span class="line">          timeout = timeout &lt;= <span class="number">0</span> ? <span class="number">1000</span> : timeout;</span><br><span class="line">          timeout = (stage == BlockConstructionStage.DATA_STREAMING)?</span><br><span class="line">             timeout : <span class="number">1000</span>;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            dataQueue.wait(timeout);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">            DFSClient.LOG.warn(<span class="string">&quot;Caught exception &quot;</span>, e);</span><br><span class="line">          &#125;</span><br><span class="line">          doSleep = <span class="keyword">false</span>;</span><br><span class="line">          now = Time.now();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (streamerClosed || hasError || !dfsClient.clientRunning) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// get packet to be sent.</span></span><br><span class="line">        <span class="comment">// å‘é€packetï¼ŒdataQueueä¸ºnullï¼Œåˆ™å‘é€ä¸€ä¸ªå¿ƒè·³</span></span><br><span class="line">        <span class="keyword">if</span> (dataQueue.isEmpty()) &#123;</span><br><span class="line">          one = createHeartbeatPacket();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          one = dataQueue.getFirst(); <span class="comment">// regular data packet</span></span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">assert</span> one != <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// get new block from namenode.</span></span><br><span class="line">      <span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_SETUP_CREATE) &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// å»ºç«‹pipeline</span></span><br><span class="line">        setPipeline(nextBlockOutputStream());</span><br><span class="line">        <span class="comment">// å¯åŠ¨ResponseProcessorçº¿ç¨‹ï¼Œæ›´æ–°DataStreamerçš„çŠ¶æ€ä¸ºDATA_STREAMING</span></span><br><span class="line">        initDataStreaming();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_SETUP_APPEND) &#123;</span><br><span class="line">        ...</span><br><span class="line">        setupPipelineForAppendOrRecovery();</span><br><span class="line">        initDataStreaming();</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">long</span> lastByteOffsetInBlock = one.getLastByteOffsetBlock();</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// å½“å‰packetæ˜¯blockçš„æœ€åä¸€ä¸ªpacketï¼Œç­‰å¾…æ¥æ”¶ä¹‹å‰æ‰€æœ‰packetçš„ack</span></span><br><span class="line">      <span class="keyword">if</span> (one.lastPacketInBlock) &#123;</span><br><span class="line">        <span class="comment">// wait for all data packets have been successfully acked</span></span><br><span class="line">        <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">          <span class="keyword">while</span> (!streamerClosed &amp;&amp; !hasError &amp;&amp; </span><br><span class="line">              ackQueue.size() != <span class="number">0</span> &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">// wait for acks to arrive from datanodes</span></span><br><span class="line">              dataQueue.wait(<span class="number">1000</span>);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">              DFSClient.LOG.warn(<span class="string">&quot;Caught exception &quot;</span>, e);</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (streamerClosed || hasError || !dfsClient.clientRunning) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        stage = BlockConstructionStage.PIPELINE_CLOSE;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// send the packet</span></span><br><span class="line">      <span class="comment">// å°†packetä»dataQueueç§»åˆ°ackQueueï¼Œå‡†å¤‡å‘é€packet</span></span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        <span class="comment">// move packet from dataQueue to ackQueue</span></span><br><span class="line">        <span class="keyword">if</span> (!one.isHeartbeatPacket()) &#123;</span><br><span class="line">          dataQueue.removeFirst();</span><br><span class="line">          ackQueue.addLast(one);</span><br><span class="line">          dataQueue.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// write out data to remote datanode</span></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°†packetå†™å…¥pipeline</span></span><br><span class="line">        one.writeTo(blockStream);</span><br><span class="line">        blockStream.flush();   </span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="comment">// HDFS-3398 treat primary DN is down since client is unable to </span></span><br><span class="line">        <span class="comment">// write to primary DN. If a failed or restarting node has already</span></span><br><span class="line">        <span class="comment">// been recorded by the responder, the following call will have no </span></span><br><span class="line">        <span class="comment">// effect. Pipeline recovery can handle only one node error at a</span></span><br><span class="line">        <span class="comment">// time. If the primary node fails again during the recovery, it</span></span><br><span class="line">        <span class="comment">// will be taken out then.</span></span><br><span class="line">        tryMarkPrimaryDatanodeFailed();</span><br><span class="line">        <span class="keyword">throw</span> e;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPacket = Time.now();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// update bytesSent</span></span><br><span class="line">      <span class="keyword">long</span> tmpBytesSent = one.getLastByteOffsetBlock();</span><br><span class="line">      <span class="keyword">if</span> (bytesSent &lt; tmpBytesSent) &#123;</span><br><span class="line">        bytesSent = tmpBytesSent;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (streamerClosed || hasError || !dfsClient.clientRunning) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Is this block full?</span></span><br><span class="line">      <span class="comment">// å°†å½“å‰packetå‘é€ä¹‹åï¼Œå³å°†å½“å‰packetæ”¾å…¥ackQueue</span></span><br><span class="line">      <span class="comment">// å¦‚æœå½“å‰packetæ˜¯æœ€åä¸€ä¸ªï¼Œåˆ™ç»§ç»­ç­‰å¾…æ­¤packetçš„ackï¼Œ</span></span><br><span class="line">      <span class="comment">// ç„¶åendBlock</span></span><br><span class="line">      <span class="keyword">if</span> (one.lastPacketInBlock) &#123;</span><br><span class="line">        <span class="comment">// wait for the close packet has been acked</span></span><br><span class="line">        <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">          <span class="keyword">while</span> (!streamerClosed &amp;&amp; !hasError &amp;&amp; </span><br><span class="line">              ackQueue.size() != <span class="number">0</span> &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">            dataQueue.wait(<span class="number">1000</span>);<span class="comment">// wait for acks to arrive from datanodes</span></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (streamerClosed || hasError || !dfsClient.clientRunning) &#123;</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        endBlock();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (progress != <span class="keyword">null</span>) &#123; progress.progress(); &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// This is used by unit test to trigger race conditions.</span></span><br><span class="line">      <span class="keyword">if</span> (artificialSlowdown != <span class="number">0</span> &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">        Thread.sleep(artificialSlowdown); </span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      <span class="comment">// Log warning if there was a real error.</span></span><br><span class="line">      <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        DFSClient.LOG.warn(<span class="string">&quot;DataStreamer Exception&quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">        setLastException((IOException)e);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        setLastException(<span class="keyword">new</span> IOException(<span class="string">&quot;DataStreamer Exception: &quot;</span>,e));</span><br><span class="line">      &#125;</span><br><span class="line">      hasError = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">if</span> (errorIndex == -<span class="number">1</span> &amp;&amp; restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="comment">// Not a datanode issue</span></span><br><span class="line">        streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (traceScope != <span class="keyword">null</span>) &#123;</span><br><span class="line">    traceScope.close();</span><br><span class="line">  &#125;</span><br><span class="line">  closeInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DataStreamerçº¿ç¨‹ä¸»è¦æ˜¯ä»dataQueueä¸­æ‹¿å‡ºpacketå‘é€åˆ°pipelineï¼Œé€šè¿‡<code>setPipeline(nextBlockOutputStream())</code>åˆ›å»ºpipelineï¼Œ<code>nextBlockOutputStream</code>æ‰“å¼€ä¸€ä¸ªDataOutputStream</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LocatedBlock <span class="title">nextBlockOutputStream</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  LocatedBlock lb = <span class="keyword">null</span>;</span><br><span class="line">  DatanodeInfo[] nodes = <span class="keyword">null</span>;</span><br><span class="line">  StorageType[] storageTypes = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">int</span> count = dfsClient.getConf().nBlockWriteRetry;</span><br><span class="line">  <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">  ExtendedBlock oldBlock = block;</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">    hasError = <span class="keyword">false</span>;</span><br><span class="line">    lastException.set(<span class="keyword">null</span>);</span><br><span class="line">    errorIndex = -<span class="number">1</span>;</span><br><span class="line">    success = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">long</span> startTime = Time.now();</span><br><span class="line">    DatanodeInfo[] excluded =</span><br><span class="line">        excludedNodes.getAllPresent(excludedNodes.asMap().keySet())</span><br><span class="line">        .keySet()</span><br><span class="line">        .toArray(<span class="keyword">new</span> DatanodeInfo[<span class="number">0</span>]);</span><br><span class="line">    block = oldBlock;</span><br><span class="line">    <span class="comment">// å‘namenodeå‘é€add blockè¯·æ±‚</span></span><br><span class="line">    <span class="comment">// add block æ—¶ä¼šcheckLease(åœ¨analyzeFileStateä¸­è°ƒç”¨)</span></span><br><span class="line">    lb = locateFollowingBlock(startTime,</span><br><span class="line">        excluded.length &gt; <span class="number">0</span> ? excluded : <span class="keyword">null</span>);</span><br><span class="line">    block = lb.getBlock();</span><br><span class="line">    block.setNumBytes(<span class="number">0</span>);</span><br><span class="line">    bytesSent = <span class="number">0</span>;</span><br><span class="line">    accessToken = lb.getBlockToken();</span><br><span class="line">    nodes = lb.getLocations();</span><br><span class="line">    storageTypes = lb.getStorageTypes();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Connect to first DataNode in the list.</span></span><br><span class="line">    <span class="comment">// ä¸nodesä¸­çš„ç¬¬ä¸€ä¸ªdatanodeå»ºç«‹è¿æ¥</span></span><br><span class="line">    <span class="comment">// å‘ä¸‹æ¸¸å‘é€å†™è¯·æ±‚ï¼Œç”±Senderå‘é€</span></span><br><span class="line">    success = createBlockOutputStream(nodes, storageTypes, <span class="number">0L</span>, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">      DFSClient.LOG.info(<span class="string">&quot;Abandoning &quot;</span> + block);</span><br><span class="line">      dfsClient.namenode.abandonBlock(block, fileId, src,</span><br><span class="line">          dfsClient.clientName);</span><br><span class="line">      block = <span class="keyword">null</span>;</span><br><span class="line">      DFSClient.LOG.info(<span class="string">&quot;Excluding datanode &quot;</span> + nodes[errorIndex]);</span><br><span class="line">      excludedNodes.put(nodes[errorIndex], nodes[errorIndex]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">while</span> (!success &amp;&amp; --count &gt;= <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!success) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unable to create new block.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> lb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">createBlockOutputStream</span><span class="params">(DatanodeInfo[] nodes,</span></span></span><br><span class="line"><span class="params"><span class="function">    StorageType[] nodeStorageTypes, <span class="keyword">long</span> newGS, <span class="keyword">boolean</span> recoveryFlag)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Status pipelineStatus = SUCCESS;</span><br><span class="line">  String firstBadLink = <span class="string">&quot;&quot;</span>;</span><br><span class="line">  <span class="keyword">boolean</span> checkRestart = <span class="keyword">false</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// persist blocks on namenode on next flush</span></span><br><span class="line">  persistBlocks.set(<span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> refetchEncryptionKey = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">boolean</span> result = <span class="keyword">false</span>;</span><br><span class="line">    DataOutputStream out = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">assert</span> <span class="keyword">null</span> == s : <span class="string">&quot;Previous socket unclosed&quot;</span>;</span><br><span class="line">      <span class="keyword">assert</span> <span class="keyword">null</span> == blockReplyStream : <span class="string">&quot;Previous blockReplyStream unclosed&quot;</span>;</span><br><span class="line">      <span class="comment">// å»ºç«‹socketè¿æ¥</span></span><br><span class="line">      s = createSocketForPipeline(nodes[<span class="number">0</span>], nodes.length, dfsClient);</span><br><span class="line">      <span class="keyword">long</span> writeTimeout = dfsClient.getDatanodeWriteTimeout(nodes.length);</span><br><span class="line">      </span><br><span class="line">      OutputStream unbufOut = NetUtils.getOutputStream(s, writeTimeout);</span><br><span class="line">      InputStream unbufIn = NetUtils.getInputStream(s);</span><br><span class="line">      IOStreamPair saslStreams = dfsClient.saslClient.socketSend(s,</span><br><span class="line">        unbufOut, unbufIn, dfsClient, accessToken, nodes[<span class="number">0</span>]);</span><br><span class="line">      unbufOut = saslStreams.out;</span><br><span class="line">      unbufIn = saslStreams.in;</span><br><span class="line">      out = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(unbufOut,</span><br><span class="line">          HdfsConstants.SMALL_BUFFER_SIZE));</span><br><span class="line">      blockReplyStream = <span class="keyword">new</span> DataInputStream(unbufIn);</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// send the request</span></span><br><span class="line">      <span class="comment">// å‘dnå‘é€å†™è¯·æ±‚ï¼Œç”±DataXceiveræ¥æ”¶</span></span><br><span class="line">      <span class="keyword">new</span> Sender(out).writeBlock(blockCopy, nodeStorageTypes[<span class="number">0</span>], accessToken,</span><br><span class="line">          dfsClient.clientName, nodes, nodeStorageTypes, <span class="keyword">null</span>, bcs, </span><br><span class="line">          nodes.length, block.getNumBytes(), bytesSent, newGS,</span><br><span class="line">          checksum4WriteBlock, cachingStrategy.get(), isLazyPersistFile);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// receive ack for connect</span></span><br><span class="line">      BlockOpResponseProto resp = BlockOpResponseProto.parseFrom(</span><br><span class="line">          PBHelper.vintPrefixed(blockReplyStream));</span><br><span class="line">      pipelineStatus = resp.getStatus();</span><br><span class="line">      firstBadLink = resp.getFirstBadLink();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Got an restart OOB ack.</span></span><br><span class="line">      <span class="comment">// If a node is already restarting, this status is not likely from</span></span><br><span class="line">      <span class="comment">// the same node. If it is from a different node, it is not</span></span><br><span class="line">      <span class="comment">// from the local datanode. Thus it is safe to treat this as a</span></span><br><span class="line">      <span class="comment">// regular node error.</span></span><br><span class="line">      <span class="keyword">if</span> (PipelineAck.isRestartOOBStatus(pipelineStatus) &amp;&amp;</span><br><span class="line">        restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        checkRestart = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;A datanode is restarting.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (pipelineStatus != SUCCESS) &#123;</span><br><span class="line">        <span class="keyword">if</span> (pipelineStatus == Status.ERROR_ACCESS_TOKEN) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> InvalidBlockTokenException(</span><br><span class="line">              <span class="string">&quot;Got access token error for connect ack with firstBadLink as &quot;</span></span><br><span class="line">                  + firstBadLink);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Bad connect ack with firstBadLink as &quot;</span></span><br><span class="line">              + firstBadLink);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">assert</span> <span class="keyword">null</span> == blockStream : <span class="string">&quot;Previous blockStream unclosed&quot;</span>;</span><br><span class="line">      blockStream = out;</span><br><span class="line">      result =  <span class="keyword">true</span>; <span class="comment">// success</span></span><br><span class="line">      restartingNodeIndex = -<span class="number">1</span>;</span><br><span class="line">      hasError = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">      <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Exception in createBlockOutputStream&quot;</span>, ie);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (ie <span class="keyword">instanceof</span> InvalidEncryptionKeyException &amp;&amp; refetchEncryptionKey &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Will fetch a new encryption key and retry, &quot;</span> </span><br><span class="line">            + <span class="string">&quot;encryption key was invalid when connecting to &quot;</span></span><br><span class="line">            + nodes[<span class="number">0</span>] + <span class="string">&quot; : &quot;</span> + ie);</span><br><span class="line">        <span class="comment">// The encryption key used is invalid.</span></span><br><span class="line">        refetchEncryptionKey--;</span><br><span class="line">        dfsClient.clearDataEncryptionKey();</span><br><span class="line">        <span class="comment">// Don&#x27;t close the socket/exclude this node just yet. Try again with</span></span><br><span class="line">        <span class="comment">// a new encryption key.</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// find the datanode that matches</span></span><br><span class="line">      <span class="keyword">if</span> (firstBadLink.length() != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">          <span class="comment">// NB: Unconditionally using the xfer addr w/o hostname</span></span><br><span class="line">          <span class="keyword">if</span> (firstBadLink.equals(nodes[i].getXferAddr())) &#123;</span><br><span class="line">            errorIndex = i;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">assert</span> checkRestart == <span class="keyword">false</span>;</span><br><span class="line">        errorIndex = <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Check whether there is a restart worth waiting for.</span></span><br><span class="line">      <span class="keyword">if</span> (checkRestart &amp;&amp; shouldWaitForRestart(errorIndex)) &#123;</span><br><span class="line">        restartDeadline = dfsClient.getConf().datanodeRestartTimeout +</span><br><span class="line">            Time.now();</span><br><span class="line">        restartingNodeIndex = errorIndex;</span><br><span class="line">        errorIndex = -<span class="number">1</span>;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Waiting for the datanode to be restarted: &quot;</span> +</span><br><span class="line">            nodes[restartingNodeIndex]);</span><br><span class="line">      &#125;</span><br><span class="line">      hasError = <span class="keyword">true</span>;</span><br><span class="line">      setLastException(ie);</span><br><span class="line">      result =  <span class="keyword">false</span>;  <span class="comment">// error</span></span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">        IOUtils.closeSocket(s);</span><br><span class="line">        s = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeStream(out);</span><br><span class="line">        out = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeStream(blockReplyStream);</span><br><span class="line">        blockReplyStream = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>nextBlockOutputStreamä¸­é€šè¿‡<code>locateFollowingBlock</code>å¾—åˆ°blockçš„locateLocationsï¼Œç”±<code>createBlockOutputStream</code>ä¸nodesä¸­çš„ç¬¬ä¸€ä¸ªdnå»ºç«‹socketè¿æ¥(<em>æ­¤è¿‡ç¨‹ä¸­ä¼šå»ºç«‹ä¸€ä¸ªè¾“å‡ºæµå’Œä¸€ä¸ªè¾“å…¥æµï¼Œå…¶ä¸­è¾“å‡ºæµç”¨æ¥å‘ä¸‹æ¸¸å‘é€packetï¼Œè¾“å…¥æµç”¨æ¥æ¥æ”¶ä¸‹æ¸¸å‘æ¥çš„ack</em>)ï¼Œ<em>å¹¶å‘é€writeBlockè¯·æ±‚</em>ã€‚æœ€ånextBlockOutputStreamè¿”å›nodesåˆ—è¡¨ï¼Œç”±<code>setPipeline</code>è®¾ç½®å½“å‰blockçš„pipeLine</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setPipeline</span><span class="params">(DatanodeInfo[] nodes, StorageType[] storageTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">    String[] storageIDs)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.nodes = nodes;</span><br><span class="line">  <span class="keyword">this</span>.storageTypes = storageTypes;</span><br><span class="line">  <span class="keyword">this</span>.storageIDs = storageIDs;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å»ºç«‹pipeLineä¹‹åï¼Œè¿˜è¦å¯ä¸€ä¸ªæ–°çš„çº¿ç¨‹<code>ResponseProcessor</code>æ¥æ”¶packetçš„ackï¼Œè¿™ä¸ªçº¿ç¨‹åœ¨<code>initDataStreaming</code>ä¸­å¯åŠ¨ï¼Œå¹¶æ›´æ–°DataStreamerçº¿ç¨‹çš„çŠ¶æ€ä¸º<em>DATA_STREAMING</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initDataStreaming</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.setName(<span class="string">&quot;DataStreamer for file &quot;</span> + src +</span><br><span class="line">      <span class="string">&quot; block &quot;</span> + block);</span><br><span class="line">  response = <span class="keyword">new</span> ResponseProcessor(nodes);</span><br><span class="line">  response.start();</span><br><span class="line">  stage = BlockConstructionStage.DATA_STREAMING;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‡†å¤‡å·¥ä½œç»“æŸä¹‹åï¼Œå°±æ˜¯å‘é€packetï¼Œè°ƒç”¨<code>one.writeTo(blockStream)</code>ï¼Œ<strong>è¿™é‡Œåªæ˜¯å°†packetå†™å…¥pipelineä¸­çš„ç¬¬ä¸€ä¸ªdn</strong>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">writeTo</span><span class="params">(DataOutputStream stm)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> dataLen = dataPos - dataStart;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> checksumLen = checksumPos - checksumStart;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> pktLen = HdfsConstants.BYTES_IN_INTEGER + dataLen + checksumLen;</span><br><span class="line"></span><br><span class="line">  PacketHeader header = <span class="keyword">new</span> PacketHeader(</span><br><span class="line">    pktLen, offsetInBlock, seqno, lastPacketInBlock, dataLen, syncBlock);</span><br><span class="line">  <span class="comment">// checksumPosä¸ç­‰äºdataStartæ—¶ï¼Œå°†checksumç§»åŠ¨åˆ°dataå‰é¢ï¼Œ</span></span><br><span class="line">  <span class="comment">// ç´§æŒ¨ç€dataï¼Œä¸ºheaderç©ºå‡ºè¶³å¤Ÿçš„ç©ºé—´</span></span><br><span class="line">  <span class="keyword">if</span> (checksumPos != dataStart) &#123;</span><br><span class="line">    <span class="comment">// Move the checksum to cover the gap. This can happen for the last</span></span><br><span class="line">    <span class="comment">// packet or during an hflush/hsync call.</span></span><br><span class="line">    System.arraycopy(buf, checksumStart, buf, </span><br><span class="line">                     dataStart - checksumLen , checksumLen); </span><br><span class="line">    checksumPos = dataStart;</span><br><span class="line">    checksumStart = checksumPos - checksumLen;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> headerStart = checksumStart - header.getSerializedSize();</span><br><span class="line">  <span class="keyword">assert</span> checksumStart + <span class="number">1</span> &gt;= header.getSerializedSize();</span><br><span class="line">  <span class="keyword">assert</span> checksumPos == dataStart;</span><br><span class="line">  <span class="keyword">assert</span> headerStart &gt;= <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">assert</span> headerStart + header.getSerializedSize() == checksumStart;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Copy the header data into the buffer immediately preceding the checksum</span></span><br><span class="line">  <span class="comment">// data.</span></span><br><span class="line">  <span class="comment">// å°†headerå¤åˆ¶åˆ°packetçš„bufä¸­ï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„packet</span></span><br><span class="line">  System.arraycopy(header.getBytes(), <span class="number">0</span>, buf, headerStart,</span><br><span class="line">      header.getSerializedSize());</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// corrupt the data for testing.</span></span><br><span class="line">  <span class="keyword">if</span> (DFSClientFaultInjector.get().corruptPacket()) &#123;</span><br><span class="line">    buf[headerStart+header.getSerializedSize() + checksumLen + dataLen-<span class="number">1</span>] ^= <span class="number">0xff</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Write the now contiguous full packet to the output stream.</span></span><br><span class="line">  <span class="comment">// å°†bufå†™å…¥è¾“å‡ºæµä¸­</span></span><br><span class="line">  stm.write(buf, headerStart, header.getSerializedSize() + checksumLen + dataLen);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// undo corruption.</span></span><br><span class="line">  <span class="keyword">if</span> (DFSClientFaultInjector.get().uncorruptPacket()) &#123;</span><br><span class="line">    buf[headerStart+header.getSerializedSize() + checksumLen + dataLen-<span class="number">1</span>] ^= <span class="number">0xff</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="DataXceiverçº¿ç¨‹å†™å…¥DataNode"><a href="#DataXceiverçº¿ç¨‹å†™å…¥DataNode" class="headerlink" title="DataXceiverçº¿ç¨‹å†™å…¥DataNode"></a>DataXceiverçº¿ç¨‹å†™å…¥DataNode</h2><p>ä»¥ä¸Šçš„æµç¨‹å¯ä»¥çœ‹åšæ˜¯clientç«¯ï¼Œclientç«¯å°†æ•°æ®å‘é€åˆ°dnä¸Šï¼Œç”±dnè´Ÿè´£å°†packetå†™å…¥æœ¬åœ°ç£ç›˜ï¼Œå¹¶å‘ä¸‹ä¸€ä¸ªdnå‘é€ã€‚è¿™å…¶ä¸­æ¶‰åŠåˆ°DataXceiverServerçº¿ç¨‹å’ŒDataXceiverçº¿ç¨‹ï¼ŒDataXceiverServerç›¸å½“äºç›‘å¬å™¨ï¼Œè€ŒDataXceiverç›¸å½“äºhandleï¼Œç”±DataXceiverServerç›‘å¬æ¥è‡ªclientçš„socketè¯·æ±‚ï¼Œæ ¹æ®è¯·æ±‚åˆ›å»ºDataXceiverçº¿ç¨‹ã€‚ç”±DataXceiverçº¿ç¨‹è¿›è¡Œå†™dnã€‚çœ‹ä¸‹DataXceiverServer.runæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Peer peer = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (datanode.shouldRun &amp;&amp; !datanode.shutdownForUpgrade) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// æ¥æ”¶clientçš„socketè¯·æ±‚</span></span><br><span class="line">      peer = peerServer.accept();</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Make sure the xceiver count is not exceeded</span></span><br><span class="line">      <span class="keyword">int</span> curXceiverCount = datanode.getXceiverCount();</span><br><span class="line">      <span class="comment">// æŸ¥çœ‹å½“å‰çº¿ç¨‹æ˜¯å¦è¶…å‡ºä¸Šé™ dfs.datanode.max.transfer.threadsæ§åˆ¶</span></span><br><span class="line">      <span class="keyword">if</span> (curXceiverCount &gt; maxXceiverCount) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Xceiver count &quot;</span> + curXceiverCount</span><br><span class="line">            + <span class="string">&quot; exceeds the limit of concurrent xcievers: &quot;</span></span><br><span class="line">            + maxXceiverCount);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ–°å¯ä¸€ä¸ªDataXceiverçº¿ç¨‹</span></span><br><span class="line">      <span class="keyword">new</span> Daemon(datanode.threadGroup,</span><br><span class="line">          DataXceiver.create(peer, datanode, <span class="keyword">this</span>))</span><br><span class="line">          .start();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (SocketTimeoutException ignored)</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…·ä½“çš„å¤„ç†é€»è¾‘åœ¨DataXceiverçº¿ç¨‹ä¸­ï¼ŒæŸ¥çœ‹runæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> opsProcessed = <span class="number">0</span>;</span><br><span class="line">  Op op = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment">// We process requests in a loop, and stay around for a short timeout.</span></span><br><span class="line">    <span class="comment">// This optimistic behaviour allows the other end to reuse connections.</span></span><br><span class="line">    <span class="comment">// Setting keepalive timeout to 0 disable this behavior.</span></span><br><span class="line">    <span class="keyword">do</span> &#123;</span><br><span class="line">      updateCurrentThreadName(<span class="string">&quot;Waiting for operation #&quot;</span> + (opsProcessed + <span class="number">1</span>));</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// è¯»å–æ“ä½œç </span></span><br><span class="line">        op = readOp();</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedIOException ignored) &#123;</span><br><span class="line">        <span class="comment">// Time out while we wait for client rpc</span></span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException err) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// å¤„ç†æ“ä½œç </span></span><br><span class="line">      processOp(op);</span><br><span class="line">      ++opsProcessed;</span><br><span class="line">    &#125; <span class="keyword">while</span> ((peer != <span class="keyword">null</span>) &amp;&amp;</span><br><span class="line">        (!peer.isClosed() &amp;&amp; dnConf.socketKeepaliveTimeout &gt; <span class="number">0</span>));</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DataXceiver.runæ–¹æ³•ä¸­ä¸»è¦æ˜¯è¯»å–æ“ä½œç (readOp)å¹¶è§£ææ“ä½œç (processOp)ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Receiver.class</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">processOp</span><span class="params">(Op op)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">switch</span>(op) &#123;</span><br><span class="line">  <span class="keyword">case</span> READ_BLOCK:</span><br><span class="line">    opReadBlock();</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> WRITE_BLOCK:</span><br><span class="line">    opWriteBlock(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> REPLACE_BLOCK:</span><br><span class="line">    opReplaceBlock(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> COPY_BLOCK:</span><br><span class="line">    opCopyBlock(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> BLOCK_CHECKSUM:</span><br><span class="line">    opBlockChecksum(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> TRANSFER_BLOCK:</span><br><span class="line">    opTransferBlock(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> REQUEST_SHORT_CIRCUIT_FDS:</span><br><span class="line">    opRequestShortCircuitFds(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> RELEASE_SHORT_CIRCUIT_FDS:</span><br><span class="line">    opReleaseShortCircuitFds(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">case</span> REQUEST_SHORT_CIRCUIT_SHM:</span><br><span class="line">    opRequestShortCircuitShm(in);</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  <span class="keyword">default</span>:</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unknown op &quot;</span> + op + <span class="string">&quot; in data stream&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯å†™å…¥æ“ä½œï¼Œåˆ™è°ƒç”¨<code>opWriteBlock</code>ï¼ŒopWriteBlockä¸­åˆè°ƒç”¨writeBlockï¼ŒDataXceiveré‡æ–°äº†writeBlockï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// DataXceiver.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">writeBlock</span><span class="params">(<span class="keyword">final</span> ExtendedBlock block,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> StorageType storageType, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Token&lt;BlockTokenIdentifier&gt; blockToken,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> String clientname,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DatanodeInfo[] targets,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> StorageType[] targetStorageTypes, </span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> DatanodeInfo srcDataNode,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> BlockConstructionStage stage,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">int</span> pipelineSize,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> minBytesRcvd,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> maxBytesRcvd,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> latestGenerationStamp,</span></span></span><br><span class="line"><span class="params"><span class="function">    DataChecksum requestedChecksum,</span></span></span><br><span class="line"><span class="params"><span class="function">    CachingStrategy cachingStrategy,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">boolean</span> allowLazyPersist)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  previousOpClientName = clientname;</span><br><span class="line">  updateCurrentThreadName(<span class="string">&quot;Receiving block &quot;</span> + block);</span><br><span class="line">  <span class="comment">// clientnameä¸ä¸ºnullï¼Œåˆ™isDatanodeä¸ºfalseï¼ŒisClientä¸ºtrue</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> isDatanode = clientname.length() == <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> isClient = !isDatanode;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> isTransfer = stage == BlockConstructionStage.TRANSFER_RBW</span><br><span class="line">      || stage == BlockConstructionStage.TRANSFER_FINALIZED;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// We later mutate block&#x27;s generation stamp and length, but we need to</span></span><br><span class="line">  <span class="comment">// forward the original version of the block to downstream mirrors, so</span></span><br><span class="line">  <span class="comment">// make a copy here.</span></span><br><span class="line">  <span class="keyword">final</span> ExtendedBlock originalBlock = <span class="keyword">new</span> ExtendedBlock(block);</span><br><span class="line">  <span class="keyword">if</span> (block.getNumBytes() == <span class="number">0</span>) &#123;</span><br><span class="line">    block.setNumBytes(dataXceiverServer.estimateBlockSize);</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// reply to upstream datanode or client</span></span><br><span class="line">  <span class="comment">// å‘upstreamæˆ–è€…clientå»ºç«‹ä¸€ä¸ªè¾“å‡ºæµï¼Œç”¨äºå‘é€ack </span></span><br><span class="line">  <span class="keyword">final</span> DataOutputStream replyOut = <span class="keyword">new</span> DataOutputStream(</span><br><span class="line">      <span class="keyword">new</span> BufferedOutputStream(</span><br><span class="line">          getOutputStream(),</span><br><span class="line">          HdfsConstants.SMALL_BUFFER_SIZE));</span><br><span class="line">  ...</span><br><span class="line">  DataOutputStream mirrorOut = <span class="keyword">null</span>;  <span class="comment">// stream to next target</span></span><br><span class="line">  DataInputStream mirrorIn = <span class="keyword">null</span>;    <span class="comment">// reply from next target</span></span><br><span class="line">  Socket mirrorSock = <span class="keyword">null</span>;           <span class="comment">// socket to next target</span></span><br><span class="line">  String mirrorNode = <span class="keyword">null</span>;           <span class="comment">// the name:port of next target</span></span><br><span class="line">  String firstBadLink = <span class="string">&quot;&quot;</span>;           <span class="comment">// first datanode that failed in connection setup</span></span><br><span class="line">  Status mirrorInStatus = SUCCESS;</span><br><span class="line">  <span class="keyword">final</span> String storageUuid;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isDatanode || </span><br><span class="line">        stage != BlockConstructionStage.PIPELINE_CLOSE_RECOVERY) &#123;</span><br><span class="line">      <span class="comment">// open a block receiver</span></span><br><span class="line">      <span class="comment">// å®ä¾‹åŒ–blockReceiverï¼Œç”¨äºæ¥æ”¶packet</span></span><br><span class="line">      blockReceiver = <span class="keyword">new</span> BlockReceiver(block, storageType, in,</span><br><span class="line">          peer.getRemoteAddressString(),</span><br><span class="line">          peer.getLocalAddressString(),</span><br><span class="line">          stage, latestGenerationStamp, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">          clientname, srcDataNode, datanode, requestedChecksum,</span><br><span class="line">          cachingStrategy, allowLazyPersist);</span><br><span class="line"></span><br><span class="line">      storageUuid = blockReceiver.getStorageUuid();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      storageUuid = datanode.data.recoverClose(</span><br><span class="line">          block, latestGenerationStamp, minBytesRcvd);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Connect to downstream machine, if appropriate</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="keyword">if</span> (targets.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      InetSocketAddress mirrorTarget = <span class="keyword">null</span>;</span><br><span class="line">      <span class="comment">// Connect to backup machine</span></span><br><span class="line">      <span class="comment">// å¾—åˆ°downstreamçš„dn</span></span><br><span class="line">      mirrorNode = targets[<span class="number">0</span>].getXferAddr(connectToDnViaHostname);</span><br><span class="line">      ...</span><br><span class="line">      mirrorTarget = NetUtils.createSocketAddr(mirrorNode);</span><br><span class="line">      mirrorSock = datanode.newSocket();</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">int</span> timeoutValue = dnConf.socketTimeout</span><br><span class="line">            + (HdfsServerConstants.READ_TIMEOUT_EXTENSION * targets.length);</span><br><span class="line">        <span class="keyword">int</span> writeTimeout = dnConf.socketWriteTimeout + </span><br><span class="line">                    (HdfsServerConstants.WRITE_TIMEOUT_EXTENSION * targets.length);</span><br><span class="line">        <span class="comment">// å»ºç«‹è¿æ¥</span></span><br><span class="line">        NetUtils.connect(mirrorSock, mirrorTarget, timeoutValue);</span><br><span class="line">        mirrorSock.setSoTimeout(timeoutValue);</span><br><span class="line">        mirrorSock.setSendBufferSize(HdfsConstants.DEFAULT_DATA_SOCKET_SIZE);</span><br><span class="line">        </span><br><span class="line">        OutputStream unbufMirrorOut = NetUtils.getOutputStream(mirrorSock,</span><br><span class="line">            writeTimeout);</span><br><span class="line">        InputStream unbufMirrorIn = NetUtils.getInputStream(mirrorSock);</span><br><span class="line">        DataEncryptionKeyFactory keyFactory =</span><br><span class="line">          datanode.getDataEncryptionKeyFactoryForBlock(block);</span><br><span class="line">        IOStreamPair saslStreams = datanode.saslClient.socketSend(mirrorSock,</span><br><span class="line">          unbufMirrorOut, unbufMirrorIn, keyFactory, blockToken, targets[<span class="number">0</span>]);</span><br><span class="line">        unbufMirrorOut = saslStreams.out;</span><br><span class="line">        unbufMirrorIn = saslStreams.in;</span><br><span class="line">        mirrorOut = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(unbufMirrorOut,</span><br><span class="line">            HdfsConstants.SMALL_BUFFER_SIZE));</span><br><span class="line">        mirrorIn = <span class="keyword">new</span> DataInputStream(unbufMirrorIn);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Do not propagate allowLazyPersist to downstream DataNodes.</span></span><br><span class="line">        <span class="comment">// å‘downstreamå‘é€å†™è¯·æ±‚</span></span><br><span class="line">        <span class="keyword">new</span> Sender(mirrorOut).writeBlock(originalBlock, targetStorageTypes[<span class="number">0</span>],</span><br><span class="line">            blockToken, clientname, targets, targetStorageTypes, srcDataNode,</span><br><span class="line">            stage, pipelineSize, minBytesRcvd, maxBytesRcvd,</span><br><span class="line">            latestGenerationStamp, requestedChecksum, cachingStrategy, <span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">        mirrorOut.flush();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// read connect ack (only for clients, not for replication req)</span></span><br><span class="line">        <span class="comment">// å¾—åˆ°ä¸‹æ¸¸çš„connect-ack</span></span><br><span class="line">        <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">          BlockOpResponseProto connectAck =</span><br><span class="line">            BlockOpResponseProto.parseFrom(PBHelper.vintPrefixed(mirrorIn));</span><br><span class="line">          mirrorInStatus = connectAck.getStatus();</span><br><span class="line">          firstBadLink = connectAck.getFirstBadLink();</span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled() || mirrorInStatus != SUCCESS) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;Datanode &quot;</span> + targets.length +</span><br><span class="line">                     <span class="string">&quot; got response for connect ack &quot;</span> +</span><br><span class="line">                     <span class="string">&quot; from downstream datanode with firstbadlink as &quot;</span> +</span><br><span class="line">                     firstBadLink);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      <span class="comment">// è¿™ä¸ªcatchæ•è·çš„æ˜¯pipelineå»ºç«‹æ—¶çš„å¼‚å¸¸</span></span><br><span class="line">      <span class="comment">// å½“å‰dnä¸ä¸‹æ¸¸å»ºç«‹è¿æ¥æ—¶å‘ç”Ÿçš„å¼‚å¸¸</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">          BlockOpResponseProto.newBuilder()</span><br><span class="line">            .setStatus(ERROR)</span><br><span class="line">             <span class="comment">// NB: Unconditionally using the xfer addr w/o hostname</span></span><br><span class="line">            .setFirstBadLink(targets[<span class="number">0</span>].getXferAddr())</span><br><span class="line">            .build()</span><br><span class="line">            .writeDelimitedTo(replyOut);</span><br><span class="line">          replyOut.flush();</span><br><span class="line">        &#125;</span><br><span class="line">        IOUtils.closeStream(mirrorOut);</span><br><span class="line">        mirrorOut = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeStream(mirrorIn);</span><br><span class="line">        mirrorIn = <span class="keyword">null</span>;</span><br><span class="line">        IOUtils.closeSocket(mirrorSock);</span><br><span class="line">        mirrorSock = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (isClient) &#123;</span><br><span class="line">          LOG.error(datanode + <span class="string">&quot;:Exception transfering block &quot;</span> +</span><br><span class="line">                    block + <span class="string">&quot; to mirror &quot;</span> + mirrorNode + <span class="string">&quot;: &quot;</span> + e);</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          LOG.info(datanode + <span class="string">&quot;:Exception transfering &quot;</span> +</span><br><span class="line">                   block + <span class="string">&quot; to mirror &quot;</span> + mirrorNode +</span><br><span class="line">                   <span class="string">&quot;- continuing without the mirror&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;<span class="comment">// ifç»“æŸï¼Œåˆ¤æ–­æ˜¯å¦æœ‰ä¸‹æ¸¸dnï¼Œæ˜¯å¦å»ºç«‹è¿æ¥</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// send connect-ack to source for clients and not transfer-RBW/Finalized</span></span><br><span class="line">    <span class="keyword">if</span> (isClient &amp;&amp; !isTransfer) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// å‘upstreamå‘é€connect-ack</span></span><br><span class="line">      BlockOpResponseProto.newBuilder()</span><br><span class="line">        .setStatus(mirrorInStatus)</span><br><span class="line">        .setFirstBadLink(firstBadLink)</span><br><span class="line">        .build()</span><br><span class="line">        .writeDelimitedTo(replyOut);</span><br><span class="line">      replyOut.flush();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å‘ä¸Šæ¸¸å‘é€connect-ackä¹‹åå‡†å¤‡æ¥æ”¶block packet</span></span><br><span class="line">    <span class="comment">// receive the block and mirror to the next target</span></span><br><span class="line">    <span class="keyword">if</span> (blockReceiver != <span class="keyword">null</span>) &#123;</span><br><span class="line">      String mirrorAddr = (mirrorSock == <span class="keyword">null</span>) ? <span class="keyword">null</span> : mirrorNode;</span><br><span class="line">      <span class="comment">// æ¥æ”¶block</span></span><br><span class="line">      blockReceiver.receiveBlock(mirrorOut, mirrorIn, replyOut,</span><br><span class="line">          mirrorAddr, <span class="keyword">null</span>, targets, <span class="keyword">false</span>);</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// update its generation stamp</span></span><br><span class="line">    <span class="keyword">if</span> (isClient &amp;&amp; </span><br><span class="line">        stage == BlockConstructionStage.PIPELINE_CLOSE_RECOVERY) &#123;</span><br><span class="line">      block.setGenerationStamp(latestGenerationStamp);</span><br><span class="line">      block.setNumBytes(minBytesRcvd);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// if this write is for a replication request or recovering</span></span><br><span class="line">    <span class="comment">// a failed close for client, then confirm block. For other client-writes,</span></span><br><span class="line">    <span class="comment">// the block is finalized in the PacketResponder.</span></span><br><span class="line">    <span class="keyword">if</span> (isDatanode ||</span><br><span class="line">        stage == BlockConstructionStage.PIPELINE_CLOSE_RECOVERY) &#123;</span><br><span class="line">      datanode.closeBlock(block, DataNode.EMPTY_DEL_HINT, storageUuid);</span><br><span class="line">      LOG.info(<span class="string">&quot;Received &quot;</span> + block + <span class="string">&quot; src: &quot;</span> + remoteAddress + <span class="string">&quot; dest: &quot;</span></span><br><span class="line">          + localAddress + <span class="string">&quot; of size &quot;</span> + block.getNumBytes());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;opWriteBlock &quot;</span> + block + <span class="string">&quot; received exception &quot;</span> + ioe);</span><br><span class="line">    <span class="keyword">throw</span> ioe;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// close all opened streams</span></span><br><span class="line">    ...</span><br><span class="line">    blockReceiver = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>writeBlockä¸­å®ä¾‹åŒ–blockReceiverï¼Œç”±blockReceiver.receiveBlockæ¥æ”¶packetå¹¶å†™å…¥downstreamå’Œæœ¬åœ°ç£ç›˜ï¼Œåœ¨æ¥æ”¶packetä¹‹å‰å…ˆåˆ›å»ºäºdownstreamçš„è¿æ¥ï¼Œå¹¶å‘downstreamå‘é€å†™è¯·æ±‚</em>ã€‚ä¸‹é¢æ¥çœ‹ä¸‹receiveBlockçš„ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">receiveBlock</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DataOutputStream mirrOut, // output to next datanode</span></span></span><br><span class="line"><span class="params"><span class="function">    DataInputStream mirrIn,   // input from next datanode</span></span></span><br><span class="line"><span class="params"><span class="function">    DataOutputStream replyOut,  // output to previous datanode</span></span></span><br><span class="line"><span class="params"><span class="function">    String mirrAddr, DataTransferThrottler throttlerArg,</span></span></span><br><span class="line"><span class="params"><span class="function">    DatanodeInfo[] downstreams,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> isReplaceBlock)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">    syncOnClose = datanode.getDnConf().syncOnClose;</span><br><span class="line">    <span class="keyword">boolean</span> responderClosed = <span class="keyword">false</span>;</span><br><span class="line">    mirrorOut = mirrOut;</span><br><span class="line">    mirrorAddr = mirrAddr;</span><br><span class="line">    throttler = throttlerArg;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">this</span>.replyOut = replyOut;</span><br><span class="line">    <span class="keyword">this</span>.isReplaceBlock = isReplaceBlock;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (isClient &amp;&amp; !isTransfer) &#123;</span><br><span class="line">      responder = <span class="keyword">new</span> Daemon(datanode.threadGroup, </span><br><span class="line">          <span class="keyword">new</span> PacketResponder(replyOut, mirrIn, downstreams));</span><br><span class="line">      responder.start(); <span class="comment">// start thread to processes responses</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯ä¸ªç©ºå¾ªç¯</span></span><br><span class="line">    <span class="comment">// ä¸åœçš„è°ƒç”¨receivePacketæ¥æ”¶packetï¼Œç›´åˆ°æ•´ä¸ªblockçš„packetæ¥æ”¶å®Œ</span></span><br><span class="line">    <span class="keyword">while</span> (receivePacket() &gt;= <span class="number">0</span>) &#123; <span class="comment">/* Receive until the last packet */</span> &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// wait for all outstanding packet responses. And then</span></span><br><span class="line">    <span class="comment">// indicate responder to gracefully shutdown.</span></span><br><span class="line">    <span class="comment">// Mark that responder has been closed for future processing</span></span><br><span class="line">    <span class="keyword">if</span> (responder != <span class="keyword">null</span>) &#123;</span><br><span class="line">      ((PacketResponder)responder.getRunnable()).close();</span><br><span class="line">      responderClosed = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// If this write is for a replication or transfer-RBW/Finalized,</span></span><br><span class="line">    <span class="comment">// then finalize block or convert temporary to RBW.</span></span><br><span class="line">    <span class="comment">// For client-writes, the block is finalized in the PacketResponder.</span></span><br><span class="line">    <span class="keyword">if</span> (isDatanode || isTransfer) &#123;</span><br><span class="line">      <span class="comment">// close the block/crc files</span></span><br><span class="line">      close();</span><br><span class="line">      block.setNumBytes(replicaInfo.getNumBytes());</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (stage == BlockConstructionStage.TRANSFER_RBW) &#123;</span><br><span class="line">        <span class="comment">// for TRANSFER_RBW, convert temporary to RBW</span></span><br><span class="line">        datanode.data.convertTemporaryToRbw(block);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">// for isDatnode or TRANSFER_FINALIZED</span></span><br><span class="line">        <span class="comment">// Finalize the block.</span></span><br><span class="line">        datanode.data.finalizeBlock(block);</span><br><span class="line">      &#125;</span><br><span class="line">      datanode.metrics.incrBlocksWritten();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>receiveBlockä¼šå¯åŠ¨PacketResponderçº¿ç¨‹æ¥æ¥æ”¶æ¥è‡ªdownstreamçš„packet ackå’Œå‘upstreamå‘é€packet ackã€‚<em>PacketResponderä¸­ä¹Ÿæœ‰ä¸ªackQueueé˜Ÿåˆ—</em>(æ³¨æ„å’ŒDFSOutputStreamä¸­çš„dataQueueå’ŒackQueueåŒºåˆ†)ï¼ŒreceivePacketå°†æ¥æ”¶çš„packetæ”¾å…¥ackQueueä¸­ï¼Œç”±PacketResponderæ¥æ”¶ackå¹¶ä»ackQueueä¸­å–å‡ºpacketã€‚receivePacketä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">receivePacket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// read the next packet</span></span><br><span class="line">  <span class="comment">// ä»æµä¸­è¯»å–packet</span></span><br><span class="line">  packetReceiver.receiveNextPacket(in);</span><br><span class="line"></span><br><span class="line">  PacketHeader header = packetReceiver.getHeader();</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Sanity check the header</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">long</span> offsetInBlock = header.getOffsetInBlock();</span><br><span class="line">  <span class="keyword">long</span> seqno = header.getSeqno();</span><br><span class="line">  <span class="keyword">boolean</span> lastPacketInBlock = header.isLastPacketInBlock();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> len = header.getDataLen();</span><br><span class="line">  <span class="keyword">boolean</span> syncBlock = header.getSyncBlock();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// avoid double sync&#x27;ing on close</span></span><br><span class="line">  <span class="keyword">if</span> (syncBlock &amp;&amp; lastPacketInBlock) &#123;</span><br><span class="line">    <span class="keyword">this</span>.syncOnClose = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update received bytes</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> firstByteInBlock = offsetInBlock;</span><br><span class="line">  offsetInBlock += len;</span><br><span class="line">  <span class="keyword">if</span> (replicaInfo.getNumBytes() &lt; offsetInBlock) &#123;</span><br><span class="line">    replicaInfo.setNumBytes(offsetInBlock);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// put in queue for pending acks, unless sync was requested</span></span><br><span class="line">  <span class="comment">// åœ¨å‘downstreamå‘é€packetä¹‹å‰ï¼Œå°†packetæ”¾å…¥ackQueueä¸­</span></span><br><span class="line">  <span class="keyword">if</span> (responder != <span class="keyword">null</span> &amp;&amp; !syncBlock &amp;&amp; !shouldVerifyChecksum()) &#123;</span><br><span class="line">    ((PacketResponder) responder.getRunnable()).enqueue(seqno,</span><br><span class="line">        lastPacketInBlock, offsetInBlock, Status.SUCCESS);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//First write the packet to the mirror:</span></span><br><span class="line">  <span class="keyword">if</span> (mirrorOut != <span class="keyword">null</span> &amp;&amp; !mirrorError) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">long</span> begin = Time.monotonicNow();</span><br><span class="line">      <span class="comment">// å‘downstreamå‘é€packet</span></span><br><span class="line">      packetReceiver.mirrorPacketTo(mirrorOut);</span><br><span class="line">      mirrorOut.flush();</span><br><span class="line">      <span class="keyword">long</span> duration = Time.monotonicNow() - begin;</span><br><span class="line">      <span class="keyword">if</span> (duration &gt; datanodeSlowLogThresholdMs) &#123;</span><br><span class="line">        LOG.warn(<span class="string">&quot;Slow BlockReceiver write packet to mirror took &quot;</span> + duration</span><br><span class="line">            + <span class="string">&quot;ms (threshold=&quot;</span> + datanodeSlowLogThresholdMs + <span class="string">&quot;ms)&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      handleMirrorOutError(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†packetçš„dataéƒ¨åˆ†å†™å…¥æœ¬åœ°æ—¶çš„buf</span></span><br><span class="line">  ByteBuffer dataBuf = packetReceiver.getDataSlice();</span><br><span class="line">  ByteBuffer checksumBuf = packetReceiver.getChecksumSlice();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (lastPacketInBlock || len == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span>(LOG.isDebugEnabled()) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot;Receiving an empty packet or the end of the block &quot;</span> + block);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// sync block if requested</span></span><br><span class="line">    <span class="keyword">if</span> (syncBlock) &#123;</span><br><span class="line">      flushOrSync(<span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> checksumLen = diskChecksum.getChecksumSize(len);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> checksumReceivedLen = checksumBuf.capacity();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checksumReceivedLen &gt; <span class="number">0</span> &amp;&amp; checksumReceivedLen != checksumLen) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Invalid checksum length: received length is &quot;</span></span><br><span class="line">          + checksumReceivedLen + <span class="string">&quot; but expected length is &quot;</span> + checksumLen);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checksumReceivedLen &gt; <span class="number">0</span> &amp;&amp; shouldVerifyChecksum()) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// æ ¡éªŒchecksum</span></span><br><span class="line">        verifyChunks(dataBuf, checksumBuf);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="comment">// checksum error detected locally. there is no reason to continue.</span></span><br><span class="line">        <span class="keyword">if</span> (responder != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            ((PacketResponder) responder.getRunnable()).enqueue(seqno,</span><br><span class="line">                lastPacketInBlock, offsetInBlock,</span><br><span class="line">                Status.ERROR_CHECKSUM);</span><br><span class="line">            <span class="comment">// Wait until the responder sends back the response</span></span><br><span class="line">            <span class="comment">// and interrupt this thread.</span></span><br><span class="line">            Thread.sleep(<span class="number">3000</span>);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (InterruptedException e) &#123; &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Terminating due to a checksum error.&quot;</span> + ioe);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (needsChecksumTranslation) &#123;</span><br><span class="line">        <span class="comment">// overwrite the checksums in the packet buffer with the</span></span><br><span class="line">        <span class="comment">// appropriate polynomial for the disk storage.</span></span><br><span class="line">        translateChunks(dataBuf, checksumBuf);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// checksumåœ¨ä¼ è¾“è¿‡ç¨‹ä¸­ä¸¢å¤±ï¼Œåˆ™é‡æ–°è®¡ç®—</span></span><br><span class="line">    <span class="keyword">if</span> (checksumReceivedLen == <span class="number">0</span> &amp;&amp; !streams.isTransientStorage()) &#123;</span><br><span class="line">      <span class="comment">// checksum is missing, need to calculate it</span></span><br><span class="line">      checksumBuf = ByteBuffer.allocate(checksumLen);</span><br><span class="line">      diskChecksum.calculateChunkedSums(dataBuf, checksumBuf);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// by this point, the data in the buffer uses the disk checksum</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> shouldNotWriteChecksum = checksumReceivedLen == <span class="number">0</span></span><br><span class="line">        &amp;&amp; streams.isTransientStorage();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å¾—åˆ°ç£ç›˜ä¸­å½“å‰blockçš„é•¿åº¦</span></span><br><span class="line">      <span class="keyword">long</span> onDiskLen = replicaInfo.getBytesOnDisk();</span><br><span class="line">      <span class="keyword">if</span> (onDiskLen&lt;offsetInBlock) &#123;</span><br><span class="line">        <span class="comment">//finally write to the disk :</span></span><br><span class="line">        <span class="comment">// å½“ç£ç›˜ä¸­å·²å†™å…¥blockçš„é•¿åº¦ä¸æ˜¯chunkçš„æ•´æ•°å€ï¼Œåˆ™å°†æœ€åä¸€ä¸ªchecksumè¿›è¡Œé‡å†™</span></span><br><span class="line">        <span class="keyword">if</span> (onDiskLen % bytesPerChecksum != <span class="number">0</span>) &#123; </span><br><span class="line">          <span class="comment">// prepare to overwrite last checksum</span></span><br><span class="line">          adjustCrcFilePosition();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// If this is a partial chunk, then read in pre-existing checksum</span></span><br><span class="line">        Checksum partialCrc = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (!shouldNotWriteChecksum &amp;&amp; firstByteInBlock % bytesPerChecksum != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;receivePacket for &quot;</span> + block </span><br><span class="line">                + <span class="string">&quot;: bytesPerChecksum=&quot;</span> + bytesPerChecksum                  </span><br><span class="line">                + <span class="string">&quot; does not divide firstByteInBlock=&quot;</span> + firstByteInBlock);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">long</span> offsetInChecksum = BlockMetadataHeader.getHeaderSize() +</span><br><span class="line">              onDiskLen / bytesPerChecksum * checksumSize;</span><br><span class="line">          partialCrc = computePartialChunkCrc(onDiskLen, offsetInChecksum);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> startByteToDisk = (<span class="keyword">int</span>)(onDiskLen-firstByteInBlock) </span><br><span class="line">            + dataBuf.arrayOffset() + dataBuf.position();</span><br><span class="line">        <span class="comment">// dataçš„len</span></span><br><span class="line">        <span class="keyword">int</span> numBytesToDisk = (<span class="keyword">int</span>)(offsetInBlock-onDiskLen);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Write data to disk.</span></span><br><span class="line">        <span class="keyword">long</span> begin = Time.monotonicNow();</span><br><span class="line">        <span class="comment">// å°†dataå†™å…¥ç£ç›˜</span></span><br><span class="line">        out.write(dataBuf.array(), startByteToDisk, numBytesToDisk);</span><br><span class="line">        <span class="keyword">long</span> duration = Time.monotonicNow() - begin;</span><br><span class="line">        ...</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">byte</span>[] lastCrc;</span><br><span class="line">        <span class="keyword">if</span> (shouldNotWriteChecksum) &#123;</span><br><span class="line">          lastCrc = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (partialCrc != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// If this is a partial chunk, then verify that this is the only</span></span><br><span class="line">          <span class="comment">// chunk in the packet. Calculate new crc for this chunk.</span></span><br><span class="line">          <span class="keyword">if</span> (len &gt; bytesPerChecksum) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unexpected packet data length for &quot;</span></span><br><span class="line">                +  block + <span class="string">&quot; from &quot;</span> + inAddr + <span class="string">&quot;: a partial chunk must be &quot;</span></span><br><span class="line">                + <span class="string">&quot; sent in an individual packet (data length = &quot;</span> + len</span><br><span class="line">                +  <span class="string">&quot; &gt; bytesPerChecksum = &quot;</span> + bytesPerChecksum + <span class="string">&quot;)&quot;</span>);</span><br><span class="line">          &#125;</span><br><span class="line">          partialCrc.update(dataBuf.array(), startByteToDisk, numBytesToDisk);</span><br><span class="line">          <span class="keyword">byte</span>[] buf = FSOutputSummer.convertToByteStream(partialCrc, checksumSize);</span><br><span class="line">          lastCrc = copyLastChunkChecksum(buf, checksumSize, buf.length);</span><br><span class="line">          checksumOut.write(buf);</span><br><span class="line">          <span class="keyword">if</span>(LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(<span class="string">&quot;Writing out partial crc for data len &quot;</span> + len);</span><br><span class="line">          &#125;</span><br><span class="line">          partialCrc = <span class="keyword">null</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// write checksum</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> offset = checksumBuf.arrayOffset() +</span><br><span class="line">              checksumBuf.position();</span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">int</span> end = offset + checksumLen;</span><br><span class="line">          lastCrc = copyLastChunkChecksum(checksumBuf.array(), checksumSize,</span><br><span class="line">              end);</span><br><span class="line">          <span class="comment">// å°†checksumå†™å…¥ç£ç›˜</span></span><br><span class="line">          checksumOut.write(checksumBuf.array(), offset, checksumLen);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/// flush entire packet, sync if requested</span></span><br><span class="line">        <span class="comment">// å°†block dataå’Œmetadata flushåˆ°ç£ç›˜</span></span><br><span class="line">        flushOrSync(syncBlock);       </span><br><span class="line">        replicaInfo.setLastChecksumAndDataLen(offsetInBlock, lastCrc);</span><br><span class="line">        datanode.metrics.incrBytesWritten(len);</span><br><span class="line">        manageWriterOsCache(offsetInBlock);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException iex) &#123;</span><br><span class="line">      datanode.checkDiskErrorAsync();</span><br><span class="line">      <span class="keyword">throw</span> iex;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> lastPacketInBlock?-<span class="number">1</span>:len;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="å‘é€æ¥æ”¶ACK"><a href="#å‘é€æ¥æ”¶ACK" class="headerlink" title="å‘é€æ¥æ”¶ACK"></a>å‘é€æ¥æ”¶ACK</h2><p><em>receivePacketä»æµä¸­è¯»å‡ºpacketï¼Œåœ¨å…¶å‘downstreamå‘é€æ—¶ï¼Œå…ˆå°†packetå½“å¦‚ackQueueé˜Ÿåˆ—ä¸­ï¼Œç”±PacketResponderçº¿ç¨‹ç­‰å¾…æ¥æ”¶æ­¤packetçš„ackï¼Œç„¶åå‘downstreamå‘é€packetï¼Œæœ€åå°†packetå†™å…¥æœ¬åœ°ç£ç›˜ã€‚</em></p><p>ä¸‹é¢çœ‹ä¸‹PacketResponderçº¿ç¨‹çš„runæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> lastPacketInBlock = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> startTime = ClientTraceLog.isInfoEnabled() ? System.nanoTime() : <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (isRunning() &amp;&amp; !lastPacketInBlock) &#123;</span><br><span class="line">    <span class="keyword">long</span> totalAckTimeNanos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">boolean</span> isInterrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      Packet pkt = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">long</span> expected = -<span class="number">2</span>;</span><br><span class="line">      PipelineAck ack = <span class="keyword">new</span> PipelineAck();</span><br><span class="line">      <span class="keyword">long</span> seqno = PipelineAck.UNKOWN_SEQNO;</span><br><span class="line">      <span class="keyword">long</span> ackRecvNanoTime = <span class="number">0</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (type != PacketResponderType.LAST_IN_PIPELINE &amp;&amp; !mirrorError) &#123;</span><br><span class="line">          <span class="comment">// read an ack from downstream datanode</span></span><br><span class="line">          <span class="comment">// è¯»å–ack</span></span><br><span class="line">          ack.readFields(downstreamIn);</span><br><span class="line">          ackRecvNanoTime = System.nanoTime();</span><br><span class="line">          <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">            LOG.debug(myString + <span class="string">&quot; got &quot;</span> + ack);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Process an OOB ACK.</span></span><br><span class="line">          Status oobStatus = ack.getOOBStatus();</span><br><span class="line">          <span class="keyword">if</span> (oobStatus != <span class="keyword">null</span>) &#123;</span><br><span class="line">            LOG.info(<span class="string">&quot;Relaying an out of band ack of type &quot;</span> + oobStatus);</span><br><span class="line">            sendAckUpstream(ack, PipelineAck.UNKOWN_SEQNO, <span class="number">0L</span>, <span class="number">0L</span>,</span><br><span class="line">                Status.SUCCESS);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// æ–°æ”¶åˆ°çš„ackçš„seqno</span></span><br><span class="line">          seqno = ack.getSeqno();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è·å¾—ä¸€ä¸ªack</span></span><br><span class="line">        <span class="keyword">if</span> (seqno != PipelineAck.UNKOWN_SEQNO</span><br><span class="line">            || type == PacketResponderType.LAST_IN_PIPELINE) &#123;</span><br><span class="line">          <span class="comment">// æŒ‰ç…§å‘é€packetçš„é¡ºåºæ¥æ”¶packet ack</span></span><br><span class="line">          pkt = waitForAckHead(seqno);</span><br><span class="line">          <span class="keyword">if</span> (!isRunning()) &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          expected = pkt.seqno;</span><br><span class="line">          ...</span><br><span class="line">          lastPacketInBlock = pkt.lastPacketInBlock;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException ine) &#123;</span><br><span class="line">        isInterrupted = <span class="keyword">true</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Thread.interrupted()) &#123;</span><br><span class="line">          isInterrupted = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// continue to run even if can not read from mirror</span></span><br><span class="line">          <span class="comment">// notify client of the error</span></span><br><span class="line">          <span class="comment">// and wait for the client to shut down the pipeline</span></span><br><span class="line">          mirrorError = <span class="keyword">true</span>;</span><br><span class="line">          LOG.info(myString, ioe);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Thread.interrupted() || isInterrupted) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The receiver thread cancelled this thread. We could also check</span></span><br><span class="line"><span class="comment">         * any other status updates from the receiver thread (e.g. if it is</span></span><br><span class="line"><span class="comment">         * ok to write to replyOut). It is prudent to not send any more</span></span><br><span class="line"><span class="comment">         * status back to the client because this datanode has a problem.</span></span><br><span class="line"><span class="comment">         * The upstream datanode will detect that this datanode is bad, and</span></span><br><span class="line"><span class="comment">         * rightly so.</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * The receiver thread can also interrupt this thread for sending</span></span><br><span class="line"><span class="comment">         * an out-of-band response upstream.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        LOG.info(myString + <span class="string">&quot;: Thread is interrupted.&quot;</span>);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (lastPacketInBlock) &#123;</span><br><span class="line">        <span class="comment">// Finalize the block and close the block file</span></span><br><span class="line">        finalizeBlock(startTime);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å‘upstreamå‘é€ack</span></span><br><span class="line">      sendAckUpstream(ack, expected, totalAckTimeNanos,</span><br><span class="line">          (pkt != <span class="keyword">null</span> ? pkt.offsetInBlock : <span class="number">0</span>), </span><br><span class="line">          (pkt != <span class="keyword">null</span> ? pkt.ackStatus : Status.SUCCESS));</span><br><span class="line">      <span class="keyword">if</span> (pkt != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// remove the packet from the ack queue</span></span><br><span class="line">        removeAckHead();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;IOException in BlockReceiver.run(): &quot;</span>, e);</span><br><span class="line">      <span class="keyword">if</span> (running) &#123;</span><br><span class="line">        datanode.checkDiskErrorAsync();</span><br><span class="line">        LOG.info(myString, e);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">if</span> (!Thread.interrupted()) &#123; <span class="comment">// failure not caused by interruption</span></span><br><span class="line">          receiverThread.interrupt();</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (running) &#123;</span><br><span class="line">        LOG.info(myString, e);</span><br><span class="line">        running = <span class="keyword">false</span>;</span><br><span class="line">        receiverThread.interrupt();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(myString + <span class="string">&quot; terminating&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>PacketResponderçº¿ç¨‹ä¸»è¦ç”¨æ¥æ¥æ”¶å’Œå‘é€packet ackï¼Œå¹¶ä¸”æ˜¯æŒ‰ç…§packetçš„å†™å…¥é¡ºåºå‘é€ackã€‚</p><p>å¦‚æœpacketçš„typeä¸º<em>LAST_IN_PIPELINE</em>æ—¶ï¼Œä¸è¿›å…¥<code>if (type != PacketResponderType.LAST_IN_PIPELINE &amp;&amp; !mirrorError)</code>è¯­å¥ï¼Œç›´æ¥è¿›å…¥<code>if (seqno != PipelineAck.UNKOWN_SEQNO || type == PacketResponderType.LAST_IN_PIPELINE)</code>ï¼Œä»ackQueueé˜Ÿåˆ—ä¸­æ‹¿å‡ºç¬¬ä¸€ä¸ªpacketï¼Œ<code>sendAckUpstream</code>å‘upstreamå‘é€ackï¼Œå‘é€ç»“æŸä¹‹åä»ackQueueä¸­ç§»é™¤packetã€‚å› ä¸ºackQueueçš„é‡Œpacketçš„é¡ºåºæ˜¯packetçš„å†™å…¥é¡ºåºï¼Œåˆ™è¿™æ ·å°±ä¿è¯äº†ackä¹Ÿæ˜¯æœ‰åºçš„ã€‚</p><p>å¦‚æœpacketçš„typeä¸º<em>HAS_DOWNSTREAM_IN_PIPELINE</em>æ—¶ï¼Œè¿›å…¥<code>if (type != PacketResponderType.LAST_IN_PIPELINE &amp;&amp; !mirrorError)</code>ï¼Œä»è¾“å…¥æµä¸­è¯»å–ackï¼Œå†è¿›å…¥<code>if (seqno != PipelineAck.UNKOWN_SEQNO || type == PacketResponderType.LAST_IN_PIPELINE)</code>ä»ackQueueä¸­è¯»å–expectçš„packetï¼Œè¿›è¡Œä¸€äº›åˆ—æ ¡éªŒä¹‹åï¼Œæƒ³upstreamå‘é€ack<code>sendAckUpstream</code>(<em>æ­¤æ—¶å‘é€çš„ackåŒ…æ‹¬è‡ªå·±å’Œdownstreamçš„ack</em>)ï¼Œå‘é€ç»“æŸä¹‹åä»ackQueueä¸­ç§»é™¤packetã€‚</p><p><em>PacketResponderçº¿ç¨‹è´Ÿè´£dnä¸Špacket ackçš„å‘é€å’Œæ¥æ”¶ï¼ŒResponseProcessorçº¿ç¨‹è´Ÿè´£clientç«¯packet ackçš„æ¥æ”¶</em>ï¼Œçœ‹ä¸‹ResponseProcessorçº¿ç¨‹çš„runæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  PipelineAck ack = <span class="keyword">new</span> PipelineAck();</span><br><span class="line">  <span class="keyword">while</span> (!responderClosed &amp;&amp; dfsClient.clientRunning &amp;&amp; !isLastPacketInBlock) &#123;</span><br><span class="line">    <span class="comment">// process responses from datanodes.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// read an ack from the pipeline</span></span><br><span class="line">      <span class="keyword">long</span> begin = Time.monotonicNow();</span><br><span class="line">      <span class="comment">// è¯»å–ack</span></span><br><span class="line">      ack.readFields(blockReplyStream);</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">long</span> seqno = ack.getSeqno();</span><br><span class="line">      <span class="comment">// processes response status from datanodes.</span></span><br><span class="line">      <span class="comment">// ä»pipelineçš„æœ€åä¸€ä¸ªdnå¼€å§‹æ¥æ”¶ack</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = ack.getNumOfReplies()-<span class="number">1</span>; i &gt;=<span class="number">0</span>  &amp;&amp; dfsClient.clientRunning; i--) &#123;</span><br><span class="line">        <span class="keyword">final</span> Status reply = ack.getReply(i);</span><br><span class="line">        ...</span><br><span class="line">        <span class="comment">// node error</span></span><br><span class="line">        <span class="keyword">if</span> (reply != SUCCESS) &#123;</span><br><span class="line">          setErrorIndex(i); <span class="comment">// first bad datanode</span></span><br><span class="line">          <span class="comment">// throw åˆ™è·³å‡ºforå¾ªç¯ï¼Œè¢«catchæ•è·å¼‚å¸¸</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Bad response &quot;</span> + reply +</span><br><span class="line">              <span class="string">&quot; for block &quot;</span> + block +</span><br><span class="line">              <span class="string">&quot; from datanode &quot;</span> + </span><br><span class="line">              targets[i]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">assert</span> seqno != PipelineAck.UNKOWN_SEQNO : </span><br><span class="line">        <span class="string">&quot;Ack for unknown seqno should be a failed ack: &quot;</span> + ack;</span><br><span class="line">      <span class="keyword">if</span> (seqno == Packet.HEART_BEAT_SEQNO) &#123;  <span class="comment">// a heartbeat ack</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// a success ack for a data packet</span></span><br><span class="line">      Packet one;</span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        one = ackQueue.getFirst();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ä»è¾“å…¥æµä¸­è¯»å–çš„ackçš„seqnoä¸ackQueueä¸­å–å¾—çš„seqnoä¸ä¸€æ ·åˆ™æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      <span class="keyword">if</span> (one.seqno != seqno) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;ResponseProcessor: Expecting seqno &quot;</span> +</span><br><span class="line">                              <span class="string">&quot; for block &quot;</span> + block +</span><br><span class="line">                              one.seqno + <span class="string">&quot; but received &quot;</span> + seqno);</span><br><span class="line">      &#125;</span><br><span class="line">      isLastPacketInBlock = one.lastPacketInBlock;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Fail the packet write for testing in order to force a</span></span><br><span class="line">      <span class="comment">// pipeline recovery.</span></span><br><span class="line">      <span class="keyword">if</span> (DFSClientFaultInjector.get().failPacket() &amp;&amp;</span><br><span class="line">          isLastPacketInBlock) &#123;</span><br><span class="line">        failPacket = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">              <span class="string">&quot;Failing the last packet for testing.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">        </span><br><span class="line">      <span class="comment">// update bytesAcked</span></span><br><span class="line">      block.setNumBytes(one.getLastByteOffsetBlock());</span><br><span class="line">      <span class="comment">// æ¥æ”¶åˆ°ackåï¼Œä»ackQueueä¸­ç§»é™¤packet</span></span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        lastAckedSeqno = seqno;</span><br><span class="line">        ackQueue.removeFirst();</span><br><span class="line">        dataQueue.notifyAll();</span><br><span class="line"></span><br><span class="line">        one.releaseBuffer(byteArrayManager);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!responderClosed) &#123;</span><br><span class="line">        <span class="keyword">if</span> (e <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">          setLastException((IOException)e);</span><br><span class="line">        &#125;</span><br><span class="line">        hasError = <span class="keyword">true</span>;</span><br><span class="line">        <span class="comment">// If no explicit error report was received, mark the primary</span></span><br><span class="line">        <span class="comment">// node as failed.</span></span><br><span class="line">        tryMarkPrimaryDatanodeFailed();</span><br><span class="line">        <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">          dataQueue.notifyAll();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">          DFSClient.LOG.warn(<span class="string">&quot;DFSOutputStream ResponseProcessor exception &quot;</span></span><br><span class="line">               + <span class="string">&quot; for block &quot;</span> + block, e);</span><br><span class="line">        &#125;</span><br><span class="line">        responderClosed = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ResponseProcessorçº¿ç¨‹è¯»å–ackï¼Œå¹¶ä»pipelineä¸­çš„æœ€åä¸€ä¸ªdnæ£€æŸ¥packetçš„çŠ¶æ€ï¼Œå¦‚æœå‘ç°erroråˆ™è®¾ç½®errorIndexä¸ºå½“å‰dnçš„ç´¢å¼•ï¼Œåœ¨catchä¸­è®¾ç½®<code>hasError = true</code>ï¼›å¦‚æœæ²¡æœ‰erroråˆ™ä»ackQueueä¸­ç§»é™¤packetã€‚</p><h2 id="pipelineä¸­å†™å‘é€é”™è¯¯"><a href="#pipelineä¸­å†™å‘é€é”™è¯¯" class="headerlink" title="pipelineä¸­å†™å‘é€é”™è¯¯"></a>pipelineä¸­å†™å‘é€é”™è¯¯</h2><p>åœ¨å†™æ•°æ®çš„è¿‡ç¨‹ä¸­ï¼Œå¦‚æœPipelineæ•°æ®æµç®¡é“ä¸­çš„ä¸€ä¸ªDataNodeèŠ‚ç‚¹å†™å¤±è´¥äº†ä¼šå‘ç”Ÿä»€é—®é¢˜ã€éœ€è¦åšå“ªäº›å†…éƒ¨å¤„ç†å‘¢ï¼Ÿä¸‹é¢ä»ä»£ç ä¸­å¯»æ‰¾ç­”æ¡ˆã€‚</p><p>ResponseProcessorçº¿ç¨‹ä¸­ä»æ¥æ”¶åˆ°çš„ackä¸­å‘ç°errorï¼Œåˆ™è®¾ç½®errorIndexä¸ºé”™è¯¯èŠ‚ç‚¹çš„indexï¼ŒhasErroræ ‡è¯†ä¸ºtrueï¼Œåœ¨DataStreamerçº¿ç¨‹ä¸­å‘ç°å±æ€§çš„å˜åŒ–ï¼Œè¿›è¡Œé”™è¯¯å¤„ç†ï¼Œçœ‹ä¸‹éƒ¨åˆ†DataStreamerçš„runä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">while</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">    <span class="comment">// if the Responder encountered an error, shutdown Responder</span></span><br><span class="line">    <span class="keyword">if</span> (hasError &amp;&amp; response != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        response.close();</span><br><span class="line">        response.join();</span><br><span class="line">        response = <span class="keyword">null</span>;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException  e) &#123;</span><br><span class="line">        DFSClient.LOG.warn(<span class="string">&quot;Caught exception &quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Packet one;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// process datanode IO errors if any</span></span><br><span class="line">      <span class="keyword">boolean</span> doSleep = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (hasError &amp;&amp; (errorIndex &gt;= <span class="number">0</span> || restartingNodeIndex &gt;= <span class="number">0</span>)) &#123;</span><br><span class="line">        <span class="comment">// å¤„ç†é”™è¯¯</span></span><br><span class="line">        doSleep = processDatanodeError();</span><br><span class="line">      &#125;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DataStreamerçº¿ç¨‹å‘ç°errorä¹‹åè°ƒç”¨<code>processDatanodeError</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processDatanodeError</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (response != <span class="keyword">null</span>) &#123;</span><br><span class="line">    DFSClient.LOG.info(<span class="string">&quot;Error Recovery for &quot;</span> + block +</span><br><span class="line">    <span class="string">&quot; waiting for responder to exit. &quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å…³é—­pipelineæµ</span></span><br><span class="line">  closeStream();</span><br><span class="line">  <span class="comment">// å°†ackQueueä¸­çš„packetç§»åˆ°dataQueue</span></span><br><span class="line">  <span class="comment">// move packets from ack queue to front of the data queue</span></span><br><span class="line">  <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">    dataQueue.addAll(<span class="number">0</span>, ackQueue);</span><br><span class="line">    ackQueue.clear();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Record the new pipeline failure recovery.</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºæ–°çš„pipelineå¯ä»¥è¿›è¡Œé‡è¯•</span></span><br><span class="line">  <span class="keyword">if</span> (lastAckedSeqnoBeforeFailure != lastAckedSeqno) &#123;</span><br><span class="line">     lastAckedSeqnoBeforeFailure = lastAckedSeqno;</span><br><span class="line">     pipelineRecoveryCount = <span class="number">1</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// If we had to recover the pipeline five times in a row for the</span></span><br><span class="line">    <span class="comment">// same packet, this client likely has corrupt data or corrupting</span></span><br><span class="line">    <span class="comment">// during transmission.</span></span><br><span class="line">    <span class="keyword">if</span> (++pipelineRecoveryCount &gt; <span class="number">5</span>) &#123;</span><br><span class="line">      DFSClient.LOG.warn(<span class="string">&quot;Error recovering pipeline for writing &quot;</span> +</span><br><span class="line">          block + <span class="string">&quot;. Already retried 5 times for the same packet.&quot;</span>);</span><br><span class="line">      lastException.set(<span class="keyword">new</span> IOException(<span class="string">&quot;Failing write. Tried pipeline &quot;</span> +</span><br><span class="line">          <span class="string">&quot;recovery 5 times without success.&quot;</span>));</span><br><span class="line">      streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é‡å»ºpipeline</span></span><br><span class="line">  <span class="keyword">boolean</span> doSleep = setupPipelineForAppendOrRecovery();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (!streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">    <span class="keyword">if</span> (stage == BlockConstructionStage.PIPELINE_CLOSE) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// If we had an error while closing the pipeline, we go through a fast-path</span></span><br><span class="line">      <span class="comment">// where the BlockReceiver does not run. Instead, the DataNode just finalizes</span></span><br><span class="line">      <span class="comment">// the block immediately during the &#x27;connect ack&#x27; process. So, we want to pull</span></span><br><span class="line">      <span class="comment">// the end-of-block packet from the dataQueue, since we don&#x27;t actually have</span></span><br><span class="line">      <span class="comment">// a true pipeline to send it over.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// We also need to set lastAckedSeqno to the end-of-block Packet&#x27;s seqno, so that</span></span><br><span class="line">      <span class="comment">// a client waiting on close() will be aware that the flush finished.</span></span><br><span class="line">      <span class="keyword">synchronized</span> (dataQueue) &#123;</span><br><span class="line">        Packet endOfBlockPacket = dataQueue.remove();  <span class="comment">// remove the end of block packet</span></span><br><span class="line">        <span class="keyword">assert</span> endOfBlockPacket.lastPacketInBlock;</span><br><span class="line">        <span class="keyword">assert</span> lastAckedSeqno == endOfBlockPacket.seqno - <span class="number">1</span>;</span><br><span class="line">        lastAckedSeqno = endOfBlockPacket.seqno;</span><br><span class="line">        dataQueue.notifyAll();</span><br><span class="line">      &#125;</span><br><span class="line">      endBlock();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// å¯åŠ¨ResponseProcessçº¿ç¨‹</span></span><br><span class="line">      initDataStreaming();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> doSleep;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processDatanodeErroræ–¹æ³•ä¸­ä¸»è¦é€»è¾‘æ˜¯<code>setupPipelineForAppendOrRecovery</code>ï¼Œåˆ›å»ºæ–°çš„pipeline</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">setupPipelineForAppendOrRecovery</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// check number of datanodes</span></span><br><span class="line">  ...  </span><br><span class="line">  <span class="keyword">boolean</span> success = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">long</span> newGS = <span class="number">0L</span>;</span><br><span class="line">  <span class="keyword">while</span> (!success &amp;&amp; !streamerClosed &amp;&amp; dfsClient.clientRunning) &#123;</span><br><span class="line">    <span class="comment">// Sleep before reconnect if a dn is restarting.</span></span><br><span class="line">    <span class="comment">// This process will be repeated until the deadline or the datanode</span></span><br><span class="line">    <span class="comment">// starts back up.</span></span><br><span class="line">    <span class="keyword">if</span> (restartingNodeIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// 4 seconds or the configured deadline period, whichever is shorter.</span></span><br><span class="line">      <span class="comment">// This is the retry interval and recovery will be retried in this</span></span><br><span class="line">      <span class="comment">// interval until timeout or success.</span></span><br><span class="line">      <span class="keyword">long</span> delay = Math.min(dfsClient.getConf().datanodeRestartTimeout,</span><br><span class="line">          <span class="number">4000L</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        Thread.sleep(delay);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">        lastException.set(<span class="keyword">new</span> IOException(<span class="string">&quot;Interrupted while waiting for &quot;</span> +</span><br><span class="line">            <span class="string">&quot;datanode to restart. &quot;</span> + nodes[restartingNodeIndex]));</span><br><span class="line">        streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> isRecovery = hasError;</span><br><span class="line">    <span class="comment">// remove bad datanode from list of datanodes.</span></span><br><span class="line">    <span class="comment">// If errorIndex was not set (i.e. appends), then do not remove </span></span><br><span class="line">    <span class="comment">// any datanodes</span></span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">if</span> (errorIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">if</span> (nodes.length &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">        lastException.set(<span class="keyword">new</span> IOException(<span class="string">&quot;All datanodes &quot;</span> + pipelineMsg</span><br><span class="line">            + <span class="string">&quot; are bad. Aborting...&quot;</span>));</span><br><span class="line">        streamerClosed = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å°†é”™è¯¯çš„dnåŠ å…¥failedåˆ—è¡¨ä¸­</span></span><br><span class="line">      failed.add(nodes[errorIndex]);</span><br><span class="line">      DatanodeInfo[] newnodes = <span class="keyword">new</span> DatanodeInfo[nodes.length-<span class="number">1</span>];</span><br><span class="line">      <span class="comment">// å°†æ­£å¸¸çš„dnå¤åˆ¶åˆ°æ–°çš„æ•°ç»„newnodesé‡Œ</span></span><br><span class="line">      arraycopy(nodes, newnodes, errorIndex);</span><br><span class="line">      <span class="keyword">final</span> StorageType[] newStorageTypes = <span class="keyword">new</span> StorageType[newnodes.length];</span><br><span class="line">      arraycopy(storageTypes, newStorageTypes, errorIndex);</span><br><span class="line">      <span class="keyword">final</span> String[] newStorageIDs = <span class="keyword">new</span> String[newnodes.length];</span><br><span class="line">      arraycopy(storageIDs, newStorageIDs, errorIndex);</span><br><span class="line">      <span class="comment">// ä½¿ç”¨newnodesè®¾ç½®pipeline</span></span><br><span class="line">      setPipeline(newnodes, newStorageTypes, newStorageIDs);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Just took care of a node error while waiting for a node restart</span></span><br><span class="line">      <span class="keyword">if</span> (restartingNodeIndex &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If the error came from a node further away than the restarting</span></span><br><span class="line">        <span class="comment">// node, the restart must have been complete.</span></span><br><span class="line">        <span class="keyword">if</span> (errorIndex &gt; restartingNodeIndex) &#123;</span><br><span class="line">          restartingNodeIndex = -<span class="number">1</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (errorIndex &lt; restartingNodeIndex) &#123;</span><br><span class="line">          <span class="comment">// the node index has shifted.</span></span><br><span class="line">          restartingNodeIndex--;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// this shouldn&#x27;t happen...</span></span><br><span class="line">          <span class="keyword">assert</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (restartingNodeIndex == -<span class="number">1</span>) &#123;</span><br><span class="line">        hasError = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      lastException.set(<span class="keyword">null</span>);</span><br><span class="line">      errorIndex = -<span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Check if replace-datanode policy is satisfied.</span></span><br><span class="line">    <span class="keyword">if</span> (dfsClient.dtpReplaceDatanodeOnFailure.satisfy(blockReplication,</span><br><span class="line">        nodes, isAppend, isHflushed)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// è¡¥å…¨pipelineçš„èŠ‚ç‚¹æ•°é‡</span></span><br><span class="line">        addDatanode2ExistingPipeline();</span><br><span class="line">      &#125; <span class="keyword">catch</span>(IOException ioe) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// get a new generation stamp and an access token</span></span><br><span class="line">    <span class="comment">// ç”Ÿæˆä¸€ä¸ªæ–°çš„stamp</span></span><br><span class="line">    LocatedBlock lb = dfsClient.namenode.updateBlockForPipeline(block, dfsClient.clientName);</span><br><span class="line">    newGS = lb.getBlock().getGenerationStamp();</span><br><span class="line">    accessToken = lb.getBlockToken();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// set up the pipeline again with the remaining nodes</span></span><br><span class="line">    <span class="keyword">if</span> (failPacket) &#123; <span class="comment">// for testing</span></span><br><span class="line">      success = createBlockOutputStream(nodes, storageTypes, newGS, isRecovery);</span><br><span class="line">      failPacket = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Give DNs time to send in bad reports. In real situations,</span></span><br><span class="line">        <span class="comment">// good reports should follow bad ones, if client committed</span></span><br><span class="line">        <span class="comment">// with those nodes.</span></span><br><span class="line">        Thread.sleep(<span class="number">2000</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä¸pipelineä¸­çš„ç¬¬ä¸€ä¸ªdnå»ºç«‹è¿æ¥</span></span><br><span class="line">      success = createBlockOutputStream(nodes, storageTypes, newGS, isRecovery);</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">  &#125; <span class="comment">// while</span></span><br><span class="line">  <span class="comment">// æ›´æ–°blockçš„stamp</span></span><br><span class="line">  <span class="keyword">if</span> (success) &#123;</span><br><span class="line">    <span class="comment">// update pipeline at the namenode</span></span><br><span class="line">    ExtendedBlock newBlock = <span class="keyword">new</span> ExtendedBlock(</span><br><span class="line">        block.getBlockPoolId(), block.getBlockId(), block.getNumBytes(), newGS);</span><br><span class="line">    dfsClient.namenode.updatePipeline(dfsClient.clientName, block, newBlock,</span><br><span class="line">        nodes, storageIDs);</span><br><span class="line">    <span class="comment">// update client side generation stamp</span></span><br><span class="line">    block = newBlock;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// do not sleep, continue processing</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>setupPipelineForAppendOrRecoveryä»åŸpipelineä¸­å–å‡ºæ­£å¸¸çš„dnï¼Œå°†é”™è¯¯dnæ’é™¤ï¼Œç„¶åè°ƒç”¨<code>addDatanode2ExistingPipeline</code>ï¼ŒåŠ å…¥ä¸€ä¸ªæ–°çš„dnä¸åŸæ¥æ­£å¸¸çš„ä¸¤ä¸ªdnç»„æˆä¸€ä¸ªæ–°çš„pipeline(<em>åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ä¼štransferä¹‹å‰ä¼ è¾“æˆåŠŸçš„æ•°æ®</em>)ï¼Œå¹¶ç”Ÿæˆæ–°çš„stampå’Œtokenï¼Œè°ƒç”¨<code>createBlockOutputStream</code>ä¸pipelineå»ºç«‹socketè¿æ¥ã€‚ä½¿ç”¨stampæ›´æ–°blockæ ‡è¯†ï¼Œè¿™æ ·namenodeå¯ä»¥åˆ é™¤ä»¥å‰å‘ç”Ÿé”™è¯¯çš„blockã€‚</p><p>ä¸‹é¢ä¸»è¦çœ‹å†™<code>addDatanode2ExistingPipeline</code>ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addDatanode2ExistingPipeline</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * Is data transfer necessary?  We have the following cases.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * Case 1: Failure in Pipeline Setup</span></span><br><span class="line"><span class="comment">   * - Append</span></span><br><span class="line"><span class="comment">   *    + Transfer the stored replica, which may be a RBW or a finalized.</span></span><br><span class="line"><span class="comment">   * - Create</span></span><br><span class="line"><span class="comment">   *    + If no data, then no transfer is required.</span></span><br><span class="line"><span class="comment">   *    + If there are data written, transfer RBW. This case may happens </span></span><br><span class="line"><span class="comment">   *      when there are streaming failure earlier in this pipeline.</span></span><br><span class="line"><span class="comment">   *</span></span><br><span class="line"><span class="comment">   * Case 2: Failure in Streaming</span></span><br><span class="line"><span class="comment">   * - Append/Create:</span></span><br><span class="line"><span class="comment">   *    + transfer RBW</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * Case 3: Failure in Close</span></span><br><span class="line"><span class="comment">   * - Append/Create:</span></span><br><span class="line"><span class="comment">   *    + no transfer, let NameNode replicates the block.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//get a new datanode</span></span><br><span class="line">  <span class="keyword">final</span> DatanodeInfo[] original = nodes;</span><br><span class="line">  <span class="comment">// ä»namenodeå¾—åˆ°ä¸€ä¸ªæ–°çš„dn</span></span><br><span class="line">  <span class="keyword">final</span> LocatedBlock lb = dfsClient.namenode.getAdditionalDatanode(</span><br><span class="line">      src, fileId, block, nodes, storageIDs,</span><br><span class="line">      failed.toArray(<span class="keyword">new</span> DatanodeInfo[failed.size()]),</span><br><span class="line">      <span class="number">1</span>, dfsClient.clientName);</span><br><span class="line">  <span class="comment">// æ›´æ–°pipeline    </span></span><br><span class="line">  setPipeline(lb);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//find the new datanode</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> d = findNewDatanode(original);</span><br><span class="line">  <span class="comment">//transfer replica</span></span><br><span class="line">  <span class="keyword">final</span> DatanodeInfo src = d == <span class="number">0</span>? nodes[<span class="number">1</span>]: nodes[d - <span class="number">1</span>];</span><br><span class="line">  <span class="comment">// transferçš„ç›®æ ‡èŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯æ–°æ·»åŠ çš„èŠ‚ç‚¹</span></span><br><span class="line">  <span class="keyword">final</span> DatanodeInfo[] targets = &#123;nodes[d]&#125;;</span><br><span class="line">  <span class="keyword">final</span> StorageType[] targetStorageTypes = &#123;storageTypes[d]&#125;;</span><br><span class="line">  <span class="comment">// tarnsfer</span></span><br><span class="line">  transfer(src, targets, targetStorageTypes, lb.getBlockToken());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>hdfs writeçš„æµç¨‹ä¸ºï¼š</p><ul><li>é€šè¿‡FileSystem.createåˆ›å»ºä¸€ä¸ªFSDataOutputStreamè¾“å‡ºæµï¼Œåœ¨æ­¤è¿‡ç¨‹ä¸­clienté€šè¿‡rpcå‘namenodeæ·»åŠ ä¸€ä¸ªæ–‡ä»¶è®°å½•ï¼Œå¾—åˆ°è¯¥æ–‡ä»¶çš„ç§Ÿçº¦ï¼Œå¯åŠ¨ä¸€ä¸ªDataStreamerçº¿ç¨‹(DataStreamerçº¿ç¨‹ä¸­ç»´æŠ¤dataQueueå’ŒackQueueé˜Ÿåˆ—)ï¼Œå¹¶æŒç»­æ›´æ–°ç§Ÿçº¦</li><li>FSDataOutputStreamè¾“å‡ºæµå»ºå¥½ä¹‹åï¼Œå°±å¯ä»¥è°ƒç”¨FSDataOutputStream.writeæ–¹æ³•è¿›è¡Œæ•°æ®çš„å†™å…¥ã€‚åœ¨å†™å…¥è¿‡ç¨‹ä¸­å…ˆå°†æ•°æ®å†™å…¥clientæœ¬åœ°çš„bufä¸­ï¼Œæ­¤bufé»˜è®¤æ˜¯9ä¸ªchunkçš„å¤§å°ï¼Œå½“æœ¬åœ°bufå†™æ»¡ä¹‹å(<em>å¦‚æœè¦å†™å…¥çš„æ•°æ®é•¿åº¦å¤§äºæœ¬åœ°bufçš„é•¿åº¦ï¼Œåˆ™ç›´æ¥å°†bufé•¿åº¦çš„æ•°æ®å†™å…¥currentPacketä¸­</em>)ï¼Œè®¡ç®—è¿™äº›æ•°æ®çš„checksumï¼Œå¹¶å†™å…¥currentPacketä¸­ï¼ŒcurrentPacketå†™æ»¡ä¹‹åæ”¾å…¥dataQueueä¸­æ’é˜Ÿå¹¶é€šçŸ¥DataStreamerçº¿ç¨‹å»dataQueueä¸­æ¶ˆè´¹æ•°æ®ã€‚(<strong>æ•°æ®å…ˆå†™å…¥æœ¬åœ°bufï¼Œç„¶åå†™å…¥packetï¼Œç­‰packetæ»¡ä¹‹åæ‰å‘namenodeç”³è¯·blockId</strong>)</li><li>DataStreamerçº¿ç¨‹ä»dataQueueä¸­å–å‡ºpacketï¼Œå¦‚æœDataStreamerçš„stageä¸º<em>PIPELINE_SETUP_CREATE</em>æ—¶ï¼Œè¡¨ç¤ºå½“å‰blockçš„pipelineè¿˜æ²¡æœ‰å»ºç«‹ï¼Œå‘namenodeç”³è¯·blockIdå’Œblockçš„locationsï¼Œå°†ç”³è¯·åˆ°çš„locationsç»„æˆä¸€ä¸ªpipelineï¼Œä¸ç¬¬ä¸€ä¸ªdnå»ºç«‹socketè¿æ¥ï¼Œç”±Senderå‘é€å†™è¯·æ±‚ã€‚æ–°å¯åŠ¨ResponseProcessorçº¿ç¨‹æ¥æ”¶dnè¿”å›çš„packet ackï¼Œå¹¶æ›´æ–°DataStreamerçš„stageï¼Œç”±<em>PIPELINE_SETUP_CREATE</em>å˜ä¸º<em>DATA_STREAMING</em></li><li>å°†è¦å‘é€çš„packetä»dataQueueä¸­ç§»åˆ°ackQueueä¸­ï¼Œç„¶åå‘pipelineä¸­å‘é€packet</li></ul><p>ä»¥ä¸Šçš„æµç¨‹éƒ½å‘ç”Ÿåœ¨clientç«¯ï¼Œä¸‹é¢çš„æµç¨‹å‘ç”Ÿåœ¨dnç«¯</p><ul><li>dnåœ¨clientåˆ›å»ºpipelineæ—¶ï¼Œé€šè¿‡DataXceiverServeræ¥æ”¶åˆ°clientçš„socketè¯·æ±‚ï¼Œåˆ›å»ºä¸€ä¸ªDataXceiverçº¿ç¨‹ï¼Œç”±DataXceiverçº¿ç¨‹å¤„ç†æ¥è‡ªclientçš„å†™è¯·æ±‚ã€‚</li><li>DataXceiverçº¿ç¨‹ä¼šå®ä¾‹åŒ–ä¸€ä¸ªBlockReceiverå¯¹è±¡ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æœ‰downstreamï¼Œå¦‚æœæœ‰åˆ™åˆ›å»ºä¸€ä¸ªdownstreamçš„socketï¼Œå‘é€å†™è¯·æ±‚ã€‚</li><li>ä¸downstreamå»ºç«‹è¿æ¥ä¹‹åï¼Œåœ¨blockReceiver.receiveBlockå¾ªç¯è°ƒç”¨receivePacketæ¥æ”¶packetï¼Œå‘downstreamå‘é€packetä¹‹å‰å°†packetæ”¾å…¥ackQueue(å½“å‰ackQueueæ˜¯PacketResponderçº¿ç¨‹ç»´æŠ¤çš„)ä¸­ï¼Œç„¶åå°†dataå’Œchecksumå†™å…¥ç£ç›˜</li><li>åœ¨blockReceiver.receiveBlockä¸­è¿˜ä¼šå¯åŠ¨ä¸€ä¸ªPacketResponderçº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹è´Ÿè´£æ¥æ”¶downstreamå‘é€çš„packet ackï¼Œæ ¡éªŒæˆåŠŸä¹‹åä»ackQueueä¸­ç§»é™¤ï¼Œå‘upstreamå‘é€è‡ªå·±çš„ackå’Œdownstreamçš„ackã€‚</li><li>æœ€ç»ˆæ‰€æœ‰çš„ackéƒ½æ±‡é›†åˆ°ResponseProcessorçº¿ç¨‹ä¸­ï¼Œå¦‚æœackæ²¡æœ‰erroråˆ™ä»ackQueueä¸­ç§»é™¤ï¼›å¦‚æœæœ‰errorï¼Œå…ˆå°†ackQueueä¸­çš„packetç§»åˆ°dataQueueä¸­ï¼Œç„¶åå°†å‘ç”Ÿerrorçš„dnä»pipelineä¸­åˆ é™¤ï¼Œä»namenodeä¸­é‡æ–°ç”³è¯·dnä¸åŸæœ‰çš„æ²¡æœ‰å‘ç”Ÿerrorçš„dnç»„æˆæ–°çš„pipelineï¼Œåœ¨<code>addDatanode2ExistingPipeline</code>ä¸­åˆ¤æ–­æ˜¯å¦è¦transferå·²ç»å‘é€çš„packetï¼Œ<em>å°†å·²ç»å‘é€æˆåŠŸçš„packetä»ä¹‹å‰æ­£å¸¸çš„dnä¸Štransferåˆ°æ–°å¢åŠ çš„dnä¸Šï¼Œå¹¶æ›´æ–°blockæ˜¯stamp</em>ï¼Œè¿™æ ·å‘ç”Ÿæ•…éšœçš„DataNodeèŠ‚ç‚¹ä¸Šçš„blockæ•°æ®ä¼šåœ¨èŠ‚ç‚¹æ¢å¤æ­£å¸¸åè¢«åˆ é™¤ã€‚</li></ul><h2 id="ç–‘é—®"><a href="#ç–‘é—®" class="headerlink" title="ç–‘é—®"></a>ç–‘é—®</h2><p>åœ¨DataNodeèŠ‚ç‚¹çš„æµæ°´å¤åˆ¶è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä¸€ä¸ªDataNodeèŠ‚ç‚¹å‘ç”Ÿé”™è¯¯ï¼Œå¦‚æ¥æ”¶åˆ°çš„packetå‡ºé”™äº†ï¼Œé‚£ä¹ˆè¯¥DataNodeçš„BlockReceiverè‡ªåŠ¨ç»“æŸè¯¥çº¿ç¨‹ï¼Œä¹Ÿä¸ä¼šå‘å‘é€ç«¯å‘é€ç¡®è®¤å¸§ï¼Œå‘é€ç«¯å°±ä¼šè¿Ÿè¿Ÿæ”¶ä¸åˆ°æ¥æ”¶ç«¯çš„ç¡®è®¤å¸§ï¼Œè¿™æ ·çš„è¯ï¼Œæ¥å—ç«¯å°±ä»»åŠ¡å®ƒä»¥åçš„æ‰€æœ‰DataNodeèŠ‚ç‚¹åœ¨æ¥å—è¯¥Blockçš„packetæ˜¯å‘ç”Ÿäº†é”™è¯¯ï¼Œå¹¶æŠŠè¿™ä¸ªæƒ…å†µå‘é€ç»™å‘é€ç«¯çš„å‘é€ç«¯ã€‚</p><p>å¦‚æœPipelineä¸­çš„å¤šä¸ªèŠ‚ç‚¹åœ¨å†™æ•°æ®æ˜¯å‘ç”Ÿå¤±è´¥ï¼Œé‚£ä¹ˆåªè¦å†™æˆåŠŸçš„blockçš„æ•°é‡è¾¾åˆ°dfs.replication.min(é»˜è®¤ä¸º1)ï¼Œé‚£ä¹ˆå°±ä»»åŠ¡æ˜¯å†™æˆåŠŸçš„ï¼Œç„¶åNameNodeåé€šè¿‡ä¸€æ­¥çš„æ–¹å¼å°†blockå¤åˆ¶åˆ°å…¶ä»–èŠ‚ç‚¹ï¼Œæœ€åäº‹æ•°æ®å‰¯æœ¬è¾¾åˆ°dfs.replicationå‚æ•°é…ç½®çš„ä¸ªæ•°ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> write </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Append/Hflush/Readè®¾è®¡æ–‡æ¡£</title>
      <link href="/%5B%E8%AF%91%5DAppend%20Hflush%20Read%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3.html"/>
      <url>/%5B%E8%AF%91%5DAppend%20Hflush%20Read%E8%AE%BE%E8%AE%A1%E6%96%87%E6%A1%A3.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡æ˜¯ä¸€ç¯‡è¯‘æ–‡ï¼Œä¸»è¦æ˜¯ç¿»è¯‘ä¸‹Append/Hflush/Read Designã€‚hdfsçš„writeä¸€ç›´çœ‹ä¸å¤ªæ‡‚ï¼Œæƒ³ç¿»è¯‘ä¸‹æ­¤è®¾è®¡æ–‡æ¡£ï¼Œå¸Œæœ›èƒ½æœ‰æ›´æ·±å…¥çš„ç†è§£ã€‚</p><span id="more"></span><h2 id="Replica-Block-çŠ¶æ€"><a href="#Replica-Block-çŠ¶æ€" class="headerlink" title="Replica/Block çŠ¶æ€"></a>Replica/Block çŠ¶æ€</h2><p>Blockåœ¨NameNodeå’ŒDataNodeä¸­æœ‰ä¸åŒçš„ç§°å‘¼ï¼Œ<em>åœ¨NameNodeä¸­ä¸ºblockï¼Œåœ¨DataNodeä¸­ä¸ºReplica</em>ã€‚é€šå¸¸è¯´çš„blockçš„å‰¯æœ¬æ•°æ˜¯3ï¼ŒæŒ‡çš„å°±æ˜¯dnä¸­Replicaä¸º3ã€‚</p><h3 id="ReplicaçŠ¶æ€"><a href="#ReplicaçŠ¶æ€" class="headerlink" title="ReplicaçŠ¶æ€"></a>ReplicaçŠ¶æ€</h3><p><strong>Finalized</strong>:<br>   <em>finalized Replicaå·²ç»å®Œæˆäº†å†™å…¥æ“ä½œ</em>ã€‚ä¸ä¼šå†æœ‰æ–°çš„æ•°æ®å†™å…¥ï¼Œé™¤éæ­¤Replicaè¢«å†æ¬¡æ‰“å¼€æˆ–è€…è¢«è¿½åŠ ã€‚<br>   finalized Replicaçš„æ•°æ®å’Œmetaæ•°æ®æ˜¯åŒ¹é…çš„ã€‚<br>   <em>å½“å‰block idçš„æ‰€æœ‰Replicaæœ‰ç›¸åŒçš„æ•°æ®å¤§å°</em>ã€‚<br>   ä½†æ˜¯finalized Replicaçš„GS(generation stamp)ä¸æ˜¯ä¸€ç›´ä¸å˜çš„ï¼ŒGSå¯èƒ½å› ä¸ºä¸€æ¬¡é”™è¯¯çš„recoveryè€Œå¯¼è‡´å…¶å‘ç”Ÿå˜åŒ–ã€‚<br><strong>RBW(Replica Being Written)</strong>:<br>   <em>åˆ›å»ºReplicaæˆ–è€…è¿½åŠ Replicaæ—¶ï¼ŒReplicaçš„çŠ¶æ€ä¸ºRBW</em>ã€‚<br>   æ•°æ®å†™å…¥RBWçŠ¶æ€çš„Replicaã€‚å…¶<em>RBW Replicaæ€»æ˜¯ä¸€ä¸ªæœªå…³é—­æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockçš„Replica</em>ã€‚<br>   åŒä¸€ä¸ªblock idçš„RBWçŠ¶æ€çš„Replicaçš„é•¿åº¦ä¸å›ºå®šã€‚<br>   RBWçŠ¶æ€çš„Replicaåœ¨ç£ç›˜ä¸­çš„æ•°æ®ä¸metaæ•°æ®ä¸åŒ¹é…ï¼Œ<em>ä¹Ÿå°±æ˜¯è¯´è¿˜æœ‰ä¸€éƒ¨åˆ†æ•°æ®åœ¨å†…å­˜ä¸­æ²¡æœ‰flushåˆ°ç£ç›˜</em>ã€‚<br>   RBWçŠ¶æ€çš„Replicaä¸­çš„æ‰€æœ‰æ•°æ®å¯¹readerså¹¶<strong>ä¸éƒ½æ˜¯ä¸å¯è§çš„</strong>ï¼Œ<em>åªæœ‰æ¥å—åˆ°queue ackçš„packetæ‰æ˜¯å¯è§çš„</em>ã€‚<br>   <em>å¦‚æœå‘ç”Ÿæ•…éšœï¼ŒRBWçŠ¶æ€çš„Replicaä¸­çš„æ•°æ®æ˜¯éœ€è¦ä¿æŠ¤çš„</em>ã€‚<br><strong>RWR(Replica Waiting to be Recovered)</strong>:<br>   <em>DataNodeæŒ‚æ‰æˆ–è€…é‡å¯æ—¶ï¼Œæ‰€æœ‰RBWçŠ¶æ€çš„Replicaå˜ä¸ºRWRçŠ¶æ€</em>ã€‚<br>   RWRçŠ¶æ€çš„Replicaä¸ä¼šåœ¨pipelineä¸­å­˜åœ¨ï¼Œå› æ­¤RWR Replicaä¹Ÿä¸èƒ½å†™å…¥æ•°æ®ã€‚<br>   RWRçŠ¶æ€ä¸‹çš„replicaå°†ä¼šå˜æˆè¿‡æœŸï¼Œæˆ–è€…*å½“clientæ­»äº†ä¹‹åï¼ŒRWRå°†å‡ºç°åœ¨ç§Ÿçº¦æ¢å¤çš„è¿‡ç¨‹ä¸­(å°†RBWçŠ¶æ€çš„Replicaè½¬ä¸ºRWR)*ã€‚<br><strong>RUR(Replica Under Recovery)</strong>:<br>   ç§Ÿçº¦æ¢å¤ä¼šè§¦å‘Replicaæ¢å¤(or Block Recovery)ï¼Œæ­¤æ—¶ï¼Œä»»ä½•ä¸€ä¸ªéTEMPORARYçŠ¶æ€çš„replicaéƒ½æœ‰å¯èƒ½è½¬æ¢ä¸ºRURçŠ¶æ€ã€‚<br>   <strong>ç§Ÿçº¦æ¢å¤ä¼šè§¦å‘Blockæ¢å¤ï¼Œæ­¤æ—¶Replicaçš„çŠ¶æ€è½¬ä¸ºRURï¼Œé‚£ä¹ˆRWRæ˜¯åœ¨å“ªç§Ÿçº¦æ¢å¤ä¸­å“ªé‡Œå‡ºç°ï¼Ÿï¼Ÿ</strong><br><strong>TEMPORARY</strong>:<br>   åœ¨blockå¤åˆ¶(ç”±replication monitoræˆ–è€…balancerå¼•èµ·çš„blockå¤åˆ¶æ“ä½œ)ä¸­ä¼šå‡ºç°temporaryçŠ¶æ€çš„replicaã€‚<br>   æ­¤çŠ¶æ€ä¸‹çš„replicaä¸RBWçŠ¶æ€ç±»ä¼¼ï¼Œåªæ˜¯è¯¥çŠ¶æ€ä¸‹çš„æ•°æ®æ˜¯ä¸å¯è§çš„ã€‚<br>   å¦‚æœblockå¤åˆ¶å¤±è´¥ï¼ŒTEMPORARYçŠ¶æ€ä¸‹çš„replicaä¼šè¢«åˆ é™¤ã€‚</p><p>åœ¨DataNodeç£ç›˜ä¸­(ä¹Ÿå°±æ˜¯å­˜æ”¾blockçš„dnç£ç›˜ä¸­)ï¼Œæ¯ä¸ªdataç›®å½•éƒ½æœ‰ä¸‰ä¸ªå­ç›®å½•ï¼Œåˆ†åˆ«ä¸ºcurrentã€tmpå’Œrbwã€‚å…¶ä¸­currentä¸­å­˜æ”¾finalized replicasï¼Œtmpç›®å½•å­˜æ”¾temporary replicasï¼Œrbwç›®å½•å­˜æ”¾rbwã€rwrå’Œrur replicasã€‚</p><p>å½“replicaæ˜¯ç”±äºreplicaå¤åˆ¶æˆ–è€…balanceè€Œåˆ›å»ºçš„ï¼Œåˆ™å°†æ­¤replicaæ”¾å…¥tempç›®å½•ã€‚ä¸€æ—¦ä¸€ä¸ªreplicaå®Œæˆï¼Œä¹Ÿå°±æ˜¯finalizedï¼Œåˆ™å°†å…¶ç§»åŠ¨åˆ°currentç›®å½•ä¸­ã€‚å½“DataNodeé‡å¯æ—¶ï¼Œtmpç›®å½•ä¸‹çš„replicasè¢«åˆ é™¤ï¼Œrbwç›®å½•ä¸‹çš„replicasè¢«åšä¸ºrwrçŠ¶æ€è¿›è¡ŒåŠ è½½(<strong>rbwç›®å½•ä¸‹å­˜æ”¾ç€rbwã€rwrã€rurï¼Œrurä¹Ÿè½¬æ¢ä¸ºrwrï¼Ÿï¼Ÿï¼Ÿè½¬æ¢ä¸ºrwrä¹‹åæ€ä¹ˆåŠå‘¢ï¼Ÿï¼Ÿ</strong>)ï¼Œåœ¨currentç›®å½•ä¸‹çš„replicasè¢«åšä¸ºfinalizedçŠ¶æ€è¿›è¡ŒåŠ è½½ã€‚</p><p>åœ¨DataNodeå‡çº§è¿‡ç¨‹ä¸­ï¼Œåœ¨currentå’Œrbwç›®å½•ä¸‹çš„æ‰€æœ‰replicaså°†è¢«ä¿å­˜åœ¨ä¸€ä¸ªå¿«ç…§ä¸­ã€‚</p><h3 id="BlockçŠ¶æ€"><a href="#BlockçŠ¶æ€" class="headerlink" title="BlockçŠ¶æ€"></a>BlockçŠ¶æ€</h3><p>Blockåœ¨NameNodeä¸­çš„çŠ¶æ€ä¸ºï¼š<br><strong>UnderConstruction</strong>:<br>   æ–°å»ºä¸€ä¸ªblockæˆ–è€…æ‰“å¼€å·²å­˜åœ¨çš„blockæ¥è¿½åŠ ï¼Œæ­¤æ—¶blockä¸ºUnderConstructionçŠ¶æ€ã€‚<br>   UnderConstructionçŠ¶æ€çš„blockå¯ä»¥å†™å…¥æ•°æ®ã€‚é€šå¸¸æ˜¯ä¸€ä¸ªæœªå…³é—­æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockã€‚<br>   ç”±äºæ­¤çŠ¶æ€ä¸‹çš„blockå¯ä»¥å†™å…¥æ•°æ®ï¼Œåˆ™UnderConstruction blockçš„é•¿åº¦å’ŒGSæ˜¯ä¸å›ºå®šçš„ã€‚<br>   UnderConstruction blockä¸­çš„æ•°æ®å¹¶ä¸æ˜¯å®Œå…¨å¯è§çš„ã€‚<br>   UnderConstruction blockä¼šè®°å½•write pipelineçš„ä½ç½®ï¼Œå¦‚æœclientæŒ‚äº†ï¼Œä¹Ÿä¼šè®°å½•rwr replicasçš„ä½ç½®ã€‚(A block underconstruction keep strack of its write pipeline(i.e.,locations of valid rbw replicas) and the locations of its rwr replicas if the client dies)<br>   <em>å¯¹åº”Replicaçš„çŠ¶æ€ä¸ºRBW</em><br><strong>UnderRecovery</strong>:<br>   å½“ä¸€ä¸ªæ–‡ä»¶çš„ç§Ÿçº¦è¶…æœŸä¹‹åï¼Œå¦‚æœæ­¤æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockæ˜¯UnderConstructionçŠ¶æ€ï¼Œå½“blockæ¢å¤å¼€å§‹æ—¶ï¼ŒUnderConstructionå˜ä¸ºUnderRecoveryçŠ¶æ€ã€‚<br>   <em>å¯¹åº”Replicaçš„çŠ¶æ€ä¸ºRUR</em><br><strong>Commited</strong>:<br>   <em>Committed blockçš„é•¿åº¦å’ŒGSæ˜¯ä¸å˜çš„</em>ï¼Œé™¤éè¯¥blockè¢«å†æ¬¡æ‰“å¼€æ¥è¿½åŠ ã€‚ä½†æ˜¯<strong>DataNodeè¿˜æ²¡æœ‰ä¸ŠæŠ¥è¿™æ ·çš„Replicaï¼Œå¯¼è‡´NameNodeä¸­æ‰¾ä¸åˆ°ä¸ä¹‹åŒ¹é…çš„finalized replica</strong>ï¼Œæ­¤æ—¶blockè¢«ç§°ä¸ºCommittedçŠ¶æ€ã€‚<br>   ä¸ºäº†å“åº”è¯»è¯·æ±‚ï¼ŒCommitted blockä¾ç„¶è¦ä¿ç•™rbw replicasçš„åœ°å€ã€‚ä¹Ÿè¦è®°å½•finalized replicasçš„GSå’Œé•¿åº¦ã€‚<br>   å½“clientè¦æ±‚nnç»™æœªå…³é—­çš„æ–‡ä»¶å¢åŠ ä¸€ä¸ªblockæˆ–è€…å…³é—­æ­¤æ–‡ä»¶æ—¶ï¼Œä¸€ä¸ªUnderConstruction blockå˜ä¸ºCommittedã€‚<br>   å¦‚æœä¸€ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªblockæˆ–è€…å€’æ•°ç¬¬äºŒä¸ªblockæ˜¯COMMITTEDçŠ¶æ€ï¼Œåˆ™è¯¥æ–‡ä»¶ä¸èƒ½è¢«å…³é—­ï¼Œclientå¿…é¡»è¿›è¡Œé‡è¯•ã€‚<br>   Add Block and close will be extended to include the last blockâ€™s GS and length.<br><strong>Complete</strong>:<br>   Complete blockçš„é•¿åº¦å’ŒGSæ˜¯ä¸å˜çš„ï¼Œå¹¶ä¸”NameNodeå·²ç»å‘ç°å½“å‰blockçš„finalized replicaèƒ½å¤Ÿå’ŒGS/lenåŒ¹é…ã€‚<br>   Complete blockåªä¿å­˜finalized replicasçš„ä½ç½®ã€‚<br>   åªæœ‰å½“ä¸€ä¸ªæ–‡ä»¶çš„æ‰€æœ‰blockéƒ½æ˜¯Completeæ—¶ï¼Œæ‰èƒ½å…³é—­ã€‚<br>   <em>å¯¹åº”Replicaçš„çŠ¶æ€ä¸ºFinalized</em></p><p>å’ŒReplicaçš„çŠ¶æ€ä¸åŒï¼Œblockçš„çŠ¶æ€ä¸ä¼šåœ¨å›ºåŒ–åˆ°ç£ç›˜ã€‚å½“NameNodeé‡å¯æ—¶ï¼Œæœªå…³é—­æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockçš„çŠ¶æ€ä¸ºUnderConstructionè¿›è¡ŒåŠ è½½ï¼Œå‰©ä¸‹çš„blockéƒ½ä¸ºCompleteçŠ¶æ€ã€‚</p><p>æ›´å¤šçš„ç»†èŠ‚åŒ…æ‹¬Replicaå’ŒBlockçŠ¶æ€çš„è½¬æ¢å›¾éƒ½å°†åœ¨åé¢çš„ç« èŠ‚ä¸­ä»‹ç»ã€‚</p><p><strong>ç–‘æƒ‘Replicaä¸Blockçš„çŠ¶æ€æ˜¯æ€ä¹ˆäº¤äº’çš„ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</strong></p><h2 id="Write-Hflush"><a href="#Write-Hflush" class="headerlink" title="Write/Hflush"></a>Write/Hflush</h2><h3 id="write-pipeline"><a href="#write-pipeline" class="headerlink" title="write pipeline"></a>write pipeline</h3><p>HDFSæ–‡ä»¶æ˜¯ç”±å¤šä¸ªblockç»„æˆã€‚blockæ˜¯é€šè¿‡write pipelineå°†æ•°æ®å†™å…¥çš„ã€‚Bytesæ•°æ®ä»¥packetä¸ºå•ä½è¢«æ¨é€åˆ°pipelineä¸­ã€‚å¦‚æœä¸å‘ç”Ÿerrorï¼Œblockçš„æ„æˆä¼šç»è¿‡3ä¸ªé˜¶æ®µã€‚å¦‚å›¾æ‰€ç¤ºã€‚<br><img src="/blogimgs/appendDesign/writePipeline.png" alt="write pipeline" title="write pipeline"><br>æ­¤pipelineåŒ…å«3ä¸ªDataNode(DN0ã€DN1å’ŒDN2)å’Œä¸€ä¸ªç”±5ä¸ªpacketç»„æˆçš„blockã€‚<br>å›¾ä¸­çš„ç²—çº¿è¡¨ç¤ºpacketï¼Œè™šçº¿è¡¨ç¤ºack messagesï¼Œç»†çº¿è¡¨ç¤ºæ§åˆ¶ä¿¡æ¯(setup/close)ã€‚<br>t0-t1æ˜¯pipelineçš„setupé˜¶æ®µã€‚t1-t2æ˜¯data streamingé˜¶æ®µ(t1å‘é€ç¬¬ä¸€ä¸ªpacketï¼Œt2æ˜¯æ¥æ”¶æœ€åä¸€ä¸ªpacketçš„ack)ï¼Œ<em>åœ¨æ•°æ®ä¼ è¾“ä¸­éœ€è¦æ³¨æ„çš„æ˜¯packet3ä¹‹æ‰€ä»¥è¦ç­‰åˆ°æ¥æ”¶åˆ°packet2çš„ackä¹‹åæ‰å‘é€æ˜¯å› ä¸ºpacket2è°ƒç”¨äº†hflush</em>ã€‚t2-t3æ˜¯pipelineçš„closeé˜¶æ®µã€‚</p><p>ä¸‹é¢è¯¦ç»†ä»‹ç»ä¸‹ç€3ä¸ªé˜¶æ®µï¼š</p><blockquote><p>setupï¼š</p></blockquote><p>clientæ²¿ç€pipelineçš„ä¸‹æ¸¸dnå‘é€äº†ä¸€ä¸ªWrite_Blockè¯·æ±‚ã€‚å½“æœ€åä¸€ä¸ªdnæ¥æ”¶åˆ°è¿™ä¸ªè¯·æ±‚ï¼Œä¼šæ²¿ç€pipelineçš„ä¸Šæ¸¸dnå‘é€ä¸€ä¸ªackç»™clientã€‚æ­¤æ—¶ï¼Œ<em>pipelineä¸­dnçš„ç½‘ç»œè¿æ¥å°±è¢«å»ºç«‹ï¼Œå¹¶ä¸”æ¯ä¸ªdnéƒ½åˆ›å»ºæˆ–è€…æ‰“å¼€ä¸€ä¸ªReplica</em>ï¼Œç­‰å¾…å†™å…¥æ•°æ®ã€‚</p><blockquote><p>data streaming</p></blockquote><p>æ•°æ®é¦–å…ˆè¢«ç¼“å­˜åœ¨clientç«¯çš„bufä¸­ï¼Œå½“bufå†™æ»¡ä¹‹åå†™å…¥packetä¸­ã€‚ä¸€ä¸ªpacketå†™æ»¡ä¹‹åï¼Œè¢«å‘é€åˆ°pipelineä¸­ã€‚ä¸‹ä¸€ä¸ªpacketåœ¨æ¥æ”¶åˆ°ä¹‹å‰packetçš„ackä¹‹å‰å°±å¯ä»¥å‘é€åˆ°pipelineä¸­ã€‚æœªå®Œæˆpacket(æœªå‘é€å’Œæœªæ¥æ”¶åˆ°ackçš„packetç»Ÿç§°æœªå®Œæˆçš„packetï¼ŒåŸæ–‡æ˜¯outstanding packets)çš„ä¸ªæ•°æ˜¯ç”±clientæ§åˆ¶çš„ï¼Œä»£ç ä¸­æ˜¯80(æ˜¯dataQueueå’ŒackQueueä¸­packetçš„å’Œ)ï¼Œè¶…è¿‡äº†é™åˆ¶åˆ™é˜»å¡ã€‚<br>å¦‚æœä»£ç ä¸­æ˜ç¡®è°ƒç”¨<code>hflush</code>ï¼Œä¼šå°†å½“å‰packetå‘é€åˆ°pipelineä¸­(<strong>æ˜¯æŠŠpacketå‘é€åˆ°dataQueueç­‰å¾…DataStreameræ¥å–è¿˜æ˜¯ç›´æ¥å‘é€åˆ°pipelineä¸­ï¼Ÿï¼Ÿ</strong>)ï¼Œæ— è®ºæ­¤packetæ˜¯å¦å·²ç»å†™æ»¡ã€‚<em>Hflushæ˜¯ä¸€ä¸ªåŒæ­¥æ“ä½œï¼Œåœ¨æ¥æ”¶åˆ°æ­¤packetçš„ackä¹‹å‰ï¼Œä¸èƒ½å†™å…¥ä»»ä½•æ•°æ®</em>ã€‚</p><blockquote><p>close(finalize a block and shutdown pipeline)</p></blockquote><p>å½“clientæ”¶åˆ°æ‰€æœ‰packetçš„ackä¹‹åï¼Œå‘é€ä¸€ä¸ªå…³é—­è¯·æ±‚ã€‚<br>è¿™æ ·ä¿è¯äº†å¦‚æœåœ¨data streamingå¤±è´¥äº†ï¼Œæ¢å¤æ“ä½œæ²¡æœ‰å¿…è¦å»å¤„ç†ä¸€äº›æƒ…å†µï¼Œå¦‚ä¸€äº›Replicaså·²ç»Finalizedå’Œä¸€äº›Replicaå¹¶æ²¡æœ‰å®Œæ•´çš„æ•°æ®ã€‚(This ensures that if data streaming fails, the recovery does not need to handle the case that some replicas have been finalized and some do not have all the data)</p><h3 id="packetåœ¨æŸä¸ªDNä¸­æ˜¯æµç¨‹"><a href="#packetåœ¨æŸä¸ªDNä¸­æ˜¯æµç¨‹" class="headerlink" title="packetåœ¨æŸä¸ªDNä¸­æ˜¯æµç¨‹"></a>packetåœ¨æŸä¸ªDNä¸­æ˜¯æµç¨‹</h3><p><img src="/blogimgs/appendDesign/packetPipeline.png" alt="packet in pipeline" title="packet in pipeline"><br>å¯¹äºæ¯ä¸ªpacketï¼Œpipelineä¸­çš„dnä¼šåš3ä»¶äº‹ï¼š</p><ol><li>Stream data<br>a. ä»ä¸Šæ¸¸çš„dnæˆ–è€…clientæ¥æ”¶æ•°æ®<br>b. å¦‚æœä¸‹æ¸¸æœ‰dnåˆ™å‘ä¸‹æ¸¸å‘é€æ•°æ®</li><li>å°†dataæˆ–è€…crcå†™å…¥blockæ–‡ä»¶æˆ–è€…mateæ–‡ä»¶</li><li>Stream ack<br>a. å¦‚æœä¸‹æ¸¸æœ‰dnåˆ™æ¥æ”¶ä¸‹æ¸¸dnå‘é€çš„ack<br>b. å‘ä¸Šæ¸¸dnæˆ–è€…clientå‘é€ack</li></ol><blockquote><p>éœ€è¦æ³¨æ„çš„æ˜¯ä¸Šé¢çš„æ•°å­—å¹¶ä¸ä»£è¡¨è¿™ä¸‰ä»¶äº‹çš„æ‰§è¡Œé¡ºåºã€‚</p></blockquote><p>Stream ack(3)ä¼šåœ¨Steam data(1)ä¹‹åæ‰§è¡Œï¼Œä½†æ˜¯ç†è®ºä¸Šwrite data to disk(2)å¯ä»¥å‘ç”Ÿåœ¨1.aä¹‹åçš„ä»»ä½•æ—¶é—´é‡Œã€‚<em>ä»£ç ä¸­åœ¨æ‰§è¡Œ1.bä¹‹åå¹¶ä¸”æ¥æ”¶åˆ°ä¸‹ä¸ªpacketä¹‹å‰å»æ‰§è¡Œwrite data to disk(2)</em></p><p><em>pipelineä¸­çš„DataNodeæœ‰ä¸¤ä¸ªçº¿ç¨‹</em>ã€‚dataçº¿ç¨‹è´Ÿè´£data streamå’Œdisk writingã€‚å¯¹äºæ¯ä¸ªpacketï¼Œdataçº¿ç¨‹æŒ‰ç…§é¡ºåºæ‰§è¡Œ1.aã€1.bå’Œ2ã€‚<em>packetè¢«flushåˆ°ç£ç›˜ä¹‹åï¼Œå¯ä»¥ä»å†…å­˜ä¸­ç§»é™¤</em>ã€‚ackçº¿ç¨‹è´Ÿè´£ack streamingã€‚å¯¹äºæ¯ä¸ªpacketï¼Œackçº¿ç¨‹æŒ‰ç…§æ‰§è¡Œ3.aå’Œ3.bã€‚<em>ç”±äºdataçº¿ç¨‹å’Œackçº¿ç¨‹æ˜¯åŒæ—¶æ‰§è¡Œçš„ï¼Œå› æ­¤æ— æ³•ä¿è¯(2)å’Œ(3)çš„æ‰§è¡Œé¡ºåº</em>ã€‚packetçš„ackå¯èƒ½ä¼šåœ¨å†™å…¥ç£ç›˜ä¹‹å‰å‘é€ã€‚</p><p>ç®—æ³•åœ¨å†™æ€§èƒ½ã€æ•°æ®æŒä¹…æ€§å’Œç®—æ³•çš„ç®€å•æ€§åšäº†ä¸ªæƒè¡¡ã€‚<br>1ã€å°½å¿«çš„å°†æ•°æ®å†™å…¥ç£ç›˜è€Œä¸æ˜¯ç­‰å¾…æ¥æ”¶åˆ°ackä¹‹åï¼Œèƒ½å¤Ÿæå‡æ•°æ®çš„æŒä¹…æ€§ï¼Œé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚<br>2ã€å¹¶å‘çš„æ‰§è¡Œdataçº¿ç¨‹å’Œackçº¿ç¨‹<br>3ã€<strong>åœ¨pipelineçš„å†…å­˜ä¸­æœ€å¤šåªå­˜åœ¨ä¸€ä¸ªpacket</strong>ï¼Œä½¿bufferç®¡ç†å¾ˆç®€å•ã€‚<br>(<strong>pipelineæ˜¯æ€ä¹ˆä¿è¯å†…å­˜æœ€å¤šåªæœ‰ä¸€ä¸ªpacketçš„ï¼Ÿï¼Ÿï¼Ÿå†™å…¥ç£ç›˜çš„packetå°±ä»å†…å­˜åˆ é™¤ï¼Ÿï¼Ÿï¼Ÿ</strong>)</p><h3 id="ä¸€è‡´æ€§"><a href="#ä¸€è‡´æ€§" class="headerlink" title="ä¸€è‡´æ€§"></a>ä¸€è‡´æ€§</h3><ul><li>clientä»RBW Replicaä¸­è¯»æ•°æ®æ—¶ï¼ŒDataNodeä¸ä¼šå°†æ¥æ”¶åˆ°çš„æ‰€æœ‰æ•°æ®éƒ½å¯¹clientå¯è§ã€‚</li><li>RBW Replicaç»´æŠ¤ç€ä¸¤ä¸ªè®¡æ•°å™¨ï¼š<br> 1ã€BA: æ¥æ”¶åˆ°ä¸‹æ¸¸ackçš„bytesæ•°ã€‚è¿™äº›æ•°æ®å¯¹clientæ˜¯å¯è§çš„ã€‚ä¹Ÿè¢«ç§°ä¸ºReplicaçš„å¯è§é•¿åº¦ã€‚<br> 2ã€BR: blockå·²ç»æ¥æ”¶åˆ°çš„bytesæ•°ï¼ŒåŒ…æ‹¬å†™å…¥ç£ç›˜çš„å’Œåœ¨dnå†…å­˜ä¸­çš„æ•°æ®ã€‚</li><li>å‡è®¾å¼€å§‹åœ¨pipelineä¸­çš„æ‰€æœ‰DataNodeä¸­RBW Replicaçš„ä¸¤ä¸ªè®¡æ•°å™¨(BA, BR)=(a, a)ã€‚åˆ™å½“clientå°†ä¸€ä¸ªå¤§å°ä¸ºb bytesçš„packetå‘é€åˆ°pipelineä¸­ï¼Œåœ¨clientæ¥æ”¶åˆ°packetçš„ackä¹‹å‰æ²¡æœ‰åˆ«çš„packetå‘é€åˆ°pipelineä¸­ã€‚<br> 1ã€æŸä¸ªDNæ‰§è¡Œå®Œ<em>1.a</em>ä¹‹åï¼Œ(BA, BR)å˜ä¸º(a, a+b)<br> 2ã€æŸä¸ªDNæ‰§è¡Œå®Œ<em>3.a</em>ä¹‹åï¼Œ(BA, BR)å˜ä¸º(a+b, a+b)<br> 3ã€å½“clientæˆåŠŸæ¥æ”¶packetçš„ackä¹‹åï¼Œpipelineä¸­æ‰€æœ‰dnsçš„RBW Replicaçš„è®¡æ•°å™¨å˜ä¸º(BA, BR)å˜ä¸º(a+b, a+b)</li><li>pipelineä¸­æœ‰Nä¸ªDataNode(DN0ã€DN1ã€â€¦DNn)ï¼ŒDN0æ˜¯pipelineä¸­çš„ç¬¬ä¸€ä¸ªï¼Œç¦»clientæœ€è¿‘ï¼Œåˆ™æœ‰ä¸‹é¢çš„ç‰¹æ€§ï¼š<br> åœ¨ä»»ä½•ç»™å®šçš„æ—¶é—´tï¼Œ<br> <img src="/blogimgs/appendDesign/BABR.png"><br> è¿™ä¸ªç‰¹æ€§ä¿è¯äº†ä¸€æ—¦æ•°æ®å˜ä¸ºå¯è§çš„ï¼Œåˆ™pipelineä¸­æ‰€æœ‰çš„dnéƒ½æœ‰æ­¤æ•°æ®ã€‚(<em>åªè¦æ¥æ”¶åˆ°ackçš„packetå°±æ˜¯å¯è§çš„ï¼Ÿä¸€æ—¦æ•°æ®æ˜¯å¯è§çš„ï¼Œä¿è¯æ‰€æœ‰çš„dnéƒ½æœ‰æ­¤æ•°æ®ï¼Œä½†ä¸ä¿è¯è¯¥æ•°æ®åœ¨æ‰€æœ‰çš„dnä¸Šéƒ½æ˜¯å¯è§çš„ï¼Ÿï¼Ÿæ˜¯è¿™æ ·ç†è§£å—ï¼Ÿï¼Ÿè¿˜æ˜¯è¯´åªæœ‰clientæ¥æ”¶åˆ°ackä¹‹åæ•°æ®æ‰æ˜¯å¯è§çš„ï¼Ÿï¼Ÿæˆ‘æ„Ÿè§‰æ˜¯å‰è€…ã€‚éšåéªŒè¯</em>)</li><li>å‡è®¾BScè¡¨ç¤ºclientåœ¨æ—¶é—´ç‚¹tå‘é€åˆ°pipelineä¸­çš„æ•°æ®é•¿åº¦ï¼ŒBAcæ˜¯clientæ¥æ”¶åˆ°ackçš„æ•°æ®é•¿åº¦ã€‚åˆ™ä¸Šé¢çš„å…¬å¼å˜ä¸ºå¦‚ä¸‹ï¼š<br> <img src="/blogimgs/appendDesign/BCBABR.png"></li></ul><h2 id="Read"><a href="#Read" class="headerlink" title="Read"></a>Read</h2><p>è¯»ä¸€ä¸ªæœªå…³é—­çš„æ–‡ä»¶æ—¶ï¼Œå­˜åœ¨çš„æŒ‘æˆ˜æ˜¯å¦‚æœæœ€åä¸€ä¸ªblockæ˜¯UnderConstructionï¼Œé‚£ä¹ˆå¦‚æœä¿è¯ä¸€è‡´æ€§ã€‚è§£å†³æ€è·¯æ˜¯ä¿è¯åœ¨DNiä¸Šè¯»åˆ°çš„æ•°æ®ä¹Ÿèƒ½åœ¨DNjä¸Šè¯»å–ï¼Œå°½ç®¡BAi&gt;BAjã€‚</p><blockquote><p>ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆï¼š</p></blockquote><ul><li>å½“clientè¯»ä¸€ä¸ªUnderConstruction blockæ—¶ï¼Œå…ˆå‘DNå‘é€ä¸€ä¸ªè¯·æ±‚å¾—åˆ°è¿™ä¸ªReplicaçš„BA</li><li>å¦‚æœè¦è¯»çš„é•¿åº¦è¶…è¿‡äº†UnderConstruction blockçš„BAï¼Œé‚£ä¹ˆæŠ›å‡ºä¸€ä¸ªEOFExceptionå¼‚å¸¸</li><li>åªæœ‰å½“readè¯·æ±‚çš„<em>èµ·å§‹åç§»åœ°å€å°äºæœ€åä¸€ä¸ªblockçš„å¯è§é•¿åº¦æ—¶</em>(æ˜¯èµ·å§‹ä½ç½®å°äºå¯è§é•¿åº¦ï¼Œå³offå°äºBAã€‚<strong>é‚£ä¹ˆåªè¦offå¤§äºBAï¼Œå³ä½¿lenå°äºBRï¼Œä¹Ÿä¸ä¼šå‘é€ç»™DNï¼Ÿï¼Ÿ</strong>)ï¼Œæ‰ä¼šå‘é€ç»™DNã€‚å½“DNæ”¶åˆ°ä¸€ä¸ªreadè¯·æ±‚ï¼Œè¯»å–çš„é•¿åº¦å°äºBRï¼Œåˆ™è¿”å›æ­¤åŒºé—´çš„æ•°æ®ã€‚</li><li>å‡è®¾readè¯·æ±‚æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„(blck, off, len)ï¼Œå…¶ä¸­blckåŒ…å«blockIdå’ŒGSï¼Œoffæ˜¯è¯»å–çš„èµ·å§‹ä½ç½®ï¼Œlenè¦è¯»å–æ•°æ®çš„é•¿åº¦</li><li>å¦‚æœDNæœ‰ä¸ªReplicaçš„GSç­‰äºblckçš„GSæˆ–è€…æ¯”blckçš„GSæ–°ï¼Œåˆ™å¯ä»¥å“åº”å½“å‰readè¯·æ±‚ã€‚</li><li><em>å‡è®¾clientä»DNjä¸Šå¾—åˆ°äº†blockçš„lengthï¼Œåˆ™offå’Œlençš„å’Œå¿…é¡»å°äºç­‰äºBAj</em>ã€‚</li><li>å‡è®¾readè¯·æ±‚å‘é€ç»™äº†DNi(<em>èƒ½å‘é€ä¸ªDNiï¼Œåˆ™offä¸€å®šå°äºBAi</em>)ï¼ŒDNiä¸Šçš„ä¸€ä¸ªReplicaçš„çŠ¶æ€æ˜¯(BAi, BRi)ï¼Œåˆ™<br> 1ã€å¦‚æœoff+len&lt;=BAiï¼ŒDNièƒ½ä»offå¤„å‘é€lené•¿åº¦çš„bytesç»™client<br> 2ã€å¦‚æœoff+len&gt;BAiï¼Œå¹¶ä¸”off+len&lt;=BAj(*ç”±ä¸Šä¸€æ¡å‡è®¾å¾—çŸ¥*)ï¼ŒBAj&gt;=BAiï¼Œåˆ™DNiåœ¨pipelineä¸­ä¸€å®šæ˜¯DNjçš„ä¸Šæ¸¸ï¼Œä¹Ÿå°±æ˜¯ç¦»clientçš„è·ç¦»æ¯”DNjè¦è¿‘ã€‚åˆ™BRi&gt;=BRj&gt;=BAjã€‚BRi&gt;BAj,æ‰€ä»¥BRi&gt;off+lenã€‚ä¹Ÿå°±æ˜¯è¯´DNiæœ‰clientæƒ³è¦è¯»å–çš„æ•°æ®ï¼Œåˆ™DNiå‘é€æ•°æ®ç»™client<br> 3ã€off+lenä¸€å®šä¸èƒ½æ¯”BRiå¤§ï¼Œå¦‚æœå‘é€äº†è¿™ç§æƒ…å†µï¼ŒDNè®°å½•ä¸‹errorå¹¶æ‹’ç»è¿™æ¬¡è¯·æ±‚ã€‚</li><li>å¦‚æœæ­£åœ¨å“åº”readè¯·æ±‚çš„DNiæŒ‚æ‰äº†ï¼Œclientèƒ½åœ¨è¯¥blockçš„å…¶å®ƒReplicaæ‰€åœ¨çš„DNä¸­ä»»æ„åˆ‡æ¢ã€‚</li><li>è¿™ä¸ªè§£å†³æ–¹æ¡ˆæ¯”è¾ƒç®€å•ï¼Œ<em>ä½†æ˜¯éœ€è¦é‡æ–°æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å»å–æ•°æ®ï¼Œå› ä¸ºæœ€åä¸€ä¸ªblockçš„å¯è§é•¿åº¦æ˜¯åœ¨client readä¹‹å‰ä»DNä¸Šå¾—åˆ°çš„</em>(ä¹Ÿå°±æ˜¯è¯´clientè¦å…ˆè·Ÿä»ä¸€ä¸ªDNä¸Šå¾—åˆ°å¯è§æ•°æ®çš„é•¿åº¦ï¼Œç„¶åå†å»æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å»è¯»æ•°)ï¼Œè€Œä¸”clientè¯»å–çš„æ•°æ®çš„é•¿åº¦ä¸èƒ½è¶…è¿‡æœ€åä¸€ä¸ªblockçš„é•¿åº¦ã€‚</li></ul><blockquote><p>æ¦‚æ‹¬ä¸‹è¿™ç§æ–¹æ¡ˆçš„è¯»å–æµç¨‹ï¼š<br>è¯»æ“ä½œåˆ†ä¸ºä¸¤æ¬¡è¯·æ±‚ï¼š<br>ç¬¬ä¸€æ¬¡å‘blockçš„Replicaæ‰€åœ¨çš„æŸä¸€ä¸ªDN(è¯¥DNè®°ä¸ºDNi)å‘é€ä¸€ä¸ªè¯·æ±‚ï¼Œ<em>å¾—åˆ°blockçš„å¯è§é•¿åº¦BAiï¼Œå¦‚æœoff+lenå¤§äºBAiï¼Œåˆ™æŠ›å‡ºEOFException</em>ï¼›<br>ç¬¬äºŒæ¬¡è¯·æ±‚æ˜¯å‘Replicaæ‰€åœ¨çš„æŸä¸ªDNå‘é€è¯»è¯·æ±‚ï¼Œ<em>å‘é€æ—¶è¦åˆ¤æ–­offæ˜¯å¦å°äºè¯¥DNçš„BAï¼Œåªæœ‰å°äºBAæ‰å‘è¯¥DNå‘é€è¯»è¯·æ±‚</em>ã€‚(å‘é€ç»™DNï¼ŒDNæ˜¯å¦å“åº”ï¼Œå…¶åˆ¤æ–­æ ‡å‡†ä¸ºDNæœ‰ä¸ª<em>Replicaçš„GSç­‰äºblckçš„GSæˆ–è€…æ¯”blckçš„GSæ–°ï¼Œåˆ™å¯ä»¥å“åº”å½“å‰readè¯·æ±‚</em>)</p></blockquote><blockquote><p>ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆ</p></blockquote><ul><li>æ­¤ç§æ–¹æ¡ˆæ˜¯è®©clientæ§åˆ¶ä¸€è‡´æ€§ï¼ŒDNåªè´Ÿè´£å‘é€æ•°æ®ã€‚</li><li>å‡è®¾readè¯·æ±‚æ˜¯ä¸€ä¸ªä¸‰å…ƒç»„(blck, off, len)ï¼Œå…¶ä¸­blckåŒ…å«blockIdå’ŒGSï¼Œoffæ˜¯è¯»å–çš„èµ·å§‹ä½ç½®ï¼Œlenè¦è¯»å–æ•°æ®çš„é•¿åº¦</li><li>å¦‚æœDNæœ‰ä¸ªReplicaçš„GSç­‰äºblckçš„GSæˆ–è€…æ¯”blckçš„GSæ–°ï¼Œåˆ™å¯ä»¥å“åº”å½“å‰readè¯·æ±‚ã€‚</li><li>å‡è®¾DNiä¸­æŸä¸ªReplicaçš„çŠ¶æ€æ˜¯(BAi, BRi)ï¼Œåˆ™DNièƒ½å‘é€çš„æ•°æ®ä¸º[off, min(off+len, BRi)]ï¼Œå¹¶å°†BAiä¸€èµ·å‘é€ç»™client</li><li>clientæ¥æ”¶è¿™äº›æ•°æ®ï¼Œå¹¶å»æŸ¥æ‰¾å½“å‰Replicaæœ€å¤§çš„BA</li><li>å¦‚æœDNiè¯»å¤±è´¥ï¼Œclientèƒ½å»ä»»ä½•ä¸€å°åŒ…å«æ­¤Replicaçš„DNä¸Šè¯»å–</li><li>å¦‚ä½•ä¿è¯ä¸€è‡´æ€§çš„å‘¢ï¼Ÿ<br> å‡è®¾æœ‰ä¸€ä¸ªç”±Nä¸ªDNç»„æˆçš„pipelineï¼ŒDN0æ˜¯pipelineä¸­çš„ç¬¬ä¸€ä¸ªã€‚<br> å‡è®¾clientåœ¨æ—¶é—´tèƒ½å¤Ÿæä¾›ç»™applicationçš„é•¿åº¦æ˜¯BRcï¼Œåˆ™<br> <img src="/blogimgs/appendDesign/2BRC.png"><br> å› æ­¤æ— è®ºä»é‚£ä¸ªDNä¸Šè¯»å–æ•°æ®ï¼ŒDNéƒ½èƒ½å¤Ÿæ»¡è¶³ã€‚</li><li>æ­¤æ–¹æ³•éœ€è¦æ”¹å˜ä¸‹è¯»åè®®ï¼Œç”±äºclientç«¯è¦æ§åˆ¶è¯»çš„ä¸€è‡´æ€§åˆ™ä¼šå˜çš„è¾ƒå¤æ‚ã€‚ä½†æ˜¯æ­¤æ–¹æ³•ä¸ç”¨è¯·æ±‚å†æ¬¡æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶å»è¯»æ•°æ®ã€‚</li></ul><p><em>ä»£ç ä¸­åº”è¯¥ç”¨çš„æ˜¯ç¬¬ä¸€ç§ï¼Œæœ‰æ—¶é—´éªŒè¯ä¸‹</em></p><h2 id="Append"><a href="#Append" class="headerlink" title="Append"></a>Append</h2><h3 id="Append-API"><a href="#Append-API" class="headerlink" title="Append API"></a>Append API</h3><ol><li>clientå‘NNå‘é€ä¸€ä¸ªappendè¯·æ±‚</li><li>NNé¦–å…ˆç¡®è®¤æ­¤æ–‡ä»¶å·²è¢«å…³é—­ï¼Œç„¶åæ£€æŸ¥è¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªblockï¼Œ<br>å¦‚æœ<em>æ­¤blockæ²¡æœ‰å†™æ»¡å¹¶ä¸”æ²¡æœ‰Replicaï¼Œåˆ™appendæ“ä½œå¤±è´¥</em>ã€‚å¦åˆ™å°†blockæ”¹ä¸ºUnderConstructionçŠ¶æ€ã€‚<br>å¦‚æœæœ€åä¸€ä¸ªblockå†™æ»¡äº†ï¼Œåˆ™NNåˆ†é…ä¸€ä¸ªæ–°çš„blockä½œä¸ºæœ€åä¸€ä¸ªblockã€‚<br>å¦‚æœæœ€åä¸€ä¸ªblockæ²¡æœ‰å†™æ»¡ï¼ŒNNæ”¹å˜è¿™ä¸ªblockçš„çŠ¶æ€ä¸ºUnderConstructionï¼Œå¹¶ç”¨è¯¥blockçš„Finalized Replicasæ¥åˆå§‹åŒ–pipeline(If the last block is not full, NN changes this block to be an underconstruction block, <em>with its finalized replicas as its initial pipeline</em>)<br>è¿”å›blockIdã€GSã€lengthå’Œlocationsã€‚å¦‚æœæœ€åä¸€ä¸ªblockæœªæ»¡ï¼Œä¹Ÿéœ€è¦è¿”å›ä¸€ä¸ªæ–°çš„GSã€‚</li><li>å¦‚æœæœ€åä¸€ä¸ªblockä¸æ»¡ï¼Œåˆ™ä¸ºappendå»ºç«‹ä¸€ä¸ªpipelineã€‚å¦åˆ™ä¸ºcreateå»ºç«‹ä¸€ä¸ªpipelineã€‚</li><li>å¦‚æœæœ€åä¸€ä¸ªblockæœ€åä¸€ä¸ªchunkæ²¡æœ‰è¾¾åˆ°chunkè¾¹ç•Œï¼Œåˆ™è¯»å–æœ€åä¸€éƒ¨åˆ†çš„crc chunkï¼Œè¯»å–å®ƒæ˜¯ä¸ºäº†é‡å†™è®¡ç®—chunksum</li><li>å‰©ä¸‹çš„å’Œæ­£å¸¸å†™çš„æµç¨‹ä¸€æ ·</li></ol><h3 id="æŒä¹…åŒ–-Durability"><a href="#æŒä¹…åŒ–-Durability" class="headerlink" title="æŒä¹…åŒ–(Durability)"></a>æŒä¹…åŒ–(Durability)</h3><ul><li>NNä¿è¯åŒ…å«appendä¹‹å‰æ•°æ®çš„Complete blockçš„å‰¯æœ¬æ•°æ»¡è¶³è¯¥æ–‡ä»¶çš„å‰¯æœ¬æ•°ã€‚</li><li>åŒ…å«appendä¹‹å‰æ•°æ®çš„UnderConstruction blockçš„æŒä¹…åŒ–åœ¨æ­¤ç‰ˆæœ¬ä¸­æ²¡è®¾è®¡</li></ul><h2 id="æ•…éšœå¤„ç†"><a href="#æ•…éšœå¤„ç†" class="headerlink" title="æ•…éšœå¤„ç†"></a>æ•…éšœå¤„ç†</h2><h3 id="pipeline-Recovery"><a href="#pipeline-Recovery" class="headerlink" title="pipeline Recovery"></a>pipeline Recovery</h3><p>å½“ä¸€ä¸ªblockæ˜¯UnderConstructionçŠ¶æ€æ—¶ï¼Œå¯èƒ½åœ¨stage1ã€stage2å’Œstage3å‘ç”Ÿé”™è¯¯ã€‚stage1æ˜¯æŒ‡pipeline setupï¼Œstage2æ˜¯æŒ‡data streamingï¼Œstage3æ˜¯æŒ‡pipeline closeã€‚<em>pipeline recoveryå¤„ç†pipelineä¸­çš„DNså‘ç”Ÿçš„error</em>ã€‚</p><h4 id="stage1å‘ç”Ÿæ•…éšœ"><a href="#stage1å‘ç”Ÿæ•…éšœ" class="headerlink" title="stage1å‘ç”Ÿæ•…éšœ"></a>stage1å‘ç”Ÿæ•…éšœ</h4><p>åœ¨pipeline setupæ—¶ï¼ŒæŸä¸ªDNå‘ç”Ÿäº†æ•…éšœï¼Œè¿™ä¸ªDNå‘é€ä¸€ä¸ªæ•…éšœçš„ackåˆ°ä¸Šæ¸¸DNä¹‹åï¼Œå…³é—­blockæ–‡ä»¶å’Œæ‰€æœ‰çš„tcp/ipè¿æ¥ã€‚ä¸€æ—¦clientæ£€æµ‹åˆ°è¿™ä¸ªæ•…éšœï¼Œclientä¼šæ ¹æ®å»ºç«‹pipelineçš„ç›®çš„è€Œè¿›è¡Œä¸åŒçš„æ“ä½œï¼š</p><ul><li>å¦‚æœæ–°å»ºä¸€ä¸ªpipelineæ˜¯ä¸ºäº†åˆ›å»ºä¸€ä¸ªæ–°blockï¼Œåˆ™clientåªæ˜¯æ”¾å¼ƒè¿™ä¸ªblockï¼Œé‡æ–°å‘NNç”³è¯·ä¸€ä¸ªæ–°çš„blockã€‚ç„¶åä¸ºè¿™ä¸ªæ–°çš„blockå»ºç«‹pipeline</li><li>å¦‚æœæ–°å»ºä¸€ä¸ªpipelineæ˜¯ä¸ºäº†appendä¸€ä¸ªblockï¼Œåˆ™clientä¼šç”¨*å‰©ä¸‹çš„DNs(ä¸æ·»åŠ æ–°çš„DNåˆ°pipelineä¸­ï¼Ÿï¼Ÿ)*é‡å»ºä¸€ä¸ªpipelineå¹¶æ›´æ–°blockçš„GSã€‚</li></ul><p>è®¿é—®tokené”™è¯¯åœ¨pipeline setupä¸­æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ•…éšœã€‚å¦‚æœç”±äºaccess tokenè¿‡æœŸè€Œå¯¼è‡´pipeline setupå¤±è´¥æ—¶ï¼Œclientä¼šç»§ç»­ç”¨ä¹‹å‰çš„DNsé‡å»ºpipelineã€‚</p><h4 id="stage2å‘ç”Ÿæ•…éšœ"><a href="#stage2å‘ç”Ÿæ•…éšœ" class="headerlink" title="stage2å‘ç”Ÿæ•…éšœ"></a>stage2å‘ç”Ÿæ•…éšœ</h4><ul><li>DNçš„æ•…éšœå¯èƒ½å‘ç”Ÿåœ¨1.aã€1.bã€2ã€3.aå’Œ3.bä¸­çš„ä»»ä½•ä¸€ä¸ªé˜¶æ®µã€‚æ— è®ºä½•é˜¶æ®µï¼Œå½“æ•…éšœå‘ç”Ÿæ—¶ï¼Œå‘ç”Ÿæ•…éšœçš„DNä¼šé€€å‡ºpipeline(å…³é—­æ‰€æœ‰çš„tcp/ipè¿æ¥ï¼Œå¦‚æœæ•…éšœä¸æ˜¯å‘ç”Ÿåœ¨3.aå’Œ3.båˆ™å°†å†…å­˜ä¸­çš„æ•°æ®å†™å…¥ç£ç›˜ï¼Œå…³é—­ç£ç›˜ä¸Šçš„æ–‡ä»¶)ã€‚</li><li>å½“clientæ£€æµ‹åˆ°æ•…éšœæ—¶ï¼Œåœæ­¢å‘é€æ•°æ®åˆ°pipeline</li><li>clientåˆ©ç”¨å‰©ä¸‹çš„DNsé‡æ„ä¸€ä¸ªpipelineï¼Œè¯¥blockçš„æ‰€æœ‰Replicaéƒ½ä¼šäº§ç”Ÿä¸€ä¸ªæ–°çš„GS</li><li>clientä»BAcå¤„é‡æ–°å‘é€æ•°æ®ï¼Œæ­¤æ—¶GSå·²ç»æ›´æ–°ã€‚è¿™é‡Œæœ‰ä¸ªå¯ä»¥ä¼˜åŒ–çš„åœ°æ–¹å°±æ˜¯clientä»min(BRi, iæ˜¯pipelineä¸­DNçš„ç´¢å¼•)å¤„é‡æ–°å‘é€æ•°æ®ã€‚</li><li>å½“DNæ¥æ”¶åˆ°ä¸€ä¸ªpacketæ—¶ï¼Œå¦‚æœå½“å‰DNä¸Šå·²ç»å­˜åœ¨ï¼Œåˆ™data streamç›´æ¥å°†å…¶packetå‘é€åˆ°ä¸‹æ¸¸è€Œä¸å†æ¬¡å†™å…¥ç£ç›˜ã€‚</li></ul><p>æ­¤recoveryç­–ç•¥æœ‰ä¸ªå¾ˆå¥½çš„ç‰¹æ€§ï¼šåªè¦åœ¨old pipelineä¸­æ•°æ®æ˜¯å¯è§çš„ï¼Œåˆ™åœ¨é‡æ–°å»ºç«‹çš„pipelineä¸­ä¾ç„¶æ˜¯å¯è§çš„ï¼Œå³ä½¿åœ¨old pipelineä¸­å­˜æ”¾æœ€å¤§é•¿åº¦BAçš„DNæŒ‚æ‰äº†ã€‚è¿™æ˜¯å› ä¸ºåœ¨pipeline recoveryä¸­ä¸ä¼šå‡å°‘ä»»ä½•DNçš„BAå’ŒBRã€‚</p><h4 id="stage3å‘ç”Ÿæ•…éšœ"><a href="#stage3å‘ç”Ÿæ•…éšœ" class="headerlink" title="stage3å‘ç”Ÿæ•…éšœ"></a>stage3å‘ç”Ÿæ•…éšœ</h4><p>clientæ£€æµ‹åˆ°æ•…éšœï¼Œä¼šåˆ©ç”¨å‰©ä¸‹çš„DNsé‡å»ºä¸€ä¸ªpipelineã€‚æ¯ä¸ªDNä¼šæ›´æ–°blockçš„GSå’Œå°†æœªfinalizedçš„replicaå˜ä¸ºfinalizedã€‚å‘é€ä¸€ä¸ªackä¹‹åå…³é—­æ‰€æœ‰çš„ç½‘ç»œè¿æ¥ã€‚</p><h3 id="DataNode-Restart"><a href="#DataNode-Restart" class="headerlink" title="DataNode Restart"></a>DataNode Restart</h3><ul><li>DataNodeé‡å¯æ—¶ï¼Œä¼šå°†dataç›®å½•ä¸‹rbwå­ç›®å½•ä¸‹çš„æ‰€æœ‰replicaçš„çŠ¶æ€å˜ä¸ºRWRçŠ¶æ€åŠ è½½åˆ°å†…å­˜ï¼Œè¿™äº›Replicaçš„é•¿åº¦æ˜¯æœ‰crcè®°å½•çš„æœ€å¤§å€¼ã€‚</li><li>RWR Replicaæ˜¯ä¸å¯è§çš„ï¼Œä¹Ÿä¸ä¼šå‡ºç°åœ¨pipeline recoveryä¸­ï¼Œä¹Ÿæ˜¯ä¸å¯å†™çš„(åªæœ‰åœ¨pipelineä¸­çš„replicaæ‰æ˜¯å¯å†™çš„)ã€‚</li><li>RWR Replicaçš„clientå¦‚æœå­˜åœ¨ï¼Œåˆ™è¯¥Replicaå¯èƒ½ä¼šè¿‡æ—¶è€Œè¢«NNåˆ æ‰ï¼Œå¦‚æœclientä¸å­˜åœ¨ï¼Œåˆ™é€šè¿‡lease recoveryå°†çŠ¶æ€å˜ä¸ºfinalizedã€‚</li></ul><h3 id="NameNode-Restart"><a href="#NameNode-Restart" class="headerlink" title="NameNode Restart"></a>NameNode Restart</h3><ul><li>NameNodeä¸Šä¸ä¼šå°†blockçš„çŠ¶æ€å›ºåŒ–åˆ°ç£ç›˜ã€‚å› æ­¤å½“NNé‡å¯æ—¶ï¼Œéœ€è¦é‡æ–°å­˜å‚¨blockçš„çŠ¶æ€ã€‚å¯¹äºæœªå…³é—­æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockä¸ç®¡è¯¥blockä¹‹å‰æ˜¯ä»€ä¹ˆçŠ¶æ€éƒ½å˜ä¸ºUnderConstructionçŠ¶æ€ï¼Œå…¶å®ƒçš„blockéƒ½æ˜¯CompleteçŠ¶æ€ã€‚</li><li>è¦æ±‚æ¯ä¸ªDNæ³¨å†Œå¹¶å‘é€block reportã€‚block reportä¸­åŒ…æ‹¬é™¤äº†TEMPORARYçŠ¶æ€çš„æ‰€æœ‰çŠ¶æ€çš„Replica(finalizedã€rbwã€rwrã€rurã€)ã€‚</li><li>å½“NameNodeæ¥æ”¶åˆ°<em>æœ€å°‘ä¸€ä¸ªå‰¯æœ¬çš„CompleteçŠ¶æ€çš„blockå’ŒUnderConstructionçŠ¶æ€çš„blockçš„ä¸ªæ•°</em>è¾¾åˆ°ä¹‹å‰è®¾ç½®çš„é˜ˆå€¼æ—¶ï¼Œæ‰é€€å‡ºsafemodeæ¨¡å¼ã€‚(NameNode does exit safemode unless the number of complete and under construction blocks that have received at least one replica reaches the pre-defined threshold)</li></ul><h3 id="Lease-Recovery"><a href="#Lease-Recovery" class="headerlink" title="Lease Recovery"></a>Lease Recovery</h3><p>å½“é—®åŠçš„ç§Ÿçº¦è¶…æœŸä¹‹åï¼ŒNNè¦ä¸ºå®¢æˆ·ç«¯å…³é—­è¿™ä¸ªæ–‡ä»¶ã€‚è¿™é‡Œæœ‰ä¸¤ä¸ªé—®é¢˜ï¼š(1)å¹¶è¡Œæ§åˆ¶ï¼Œè¦æ˜¯åœ¨pipeline setupã€data steamã€pipeline closeæˆ–è€…pipeline recoveryé˜¶æ®µä¸­ï¼Œå¹¶ä¸”clientä¾ç„¶å­˜æ´»çš„æ—¶å€™è¿›è¡Œlease recoveryä¼šæ€æ ·ï¼Ÿå¦‚æœå­˜åœ¨å¤šä¸ªå¹¶è¡Œçš„lease recoveryæ€ä¹ˆåŠï¼Ÿ(2)ä¸€è‡´æ€§ä¿è¯ï¼Œå½“æœ€åä¸€ä¸ªblockæ˜¯UnderConstructionçŠ¶æ€æ—¶ï¼Œå…¶blockçš„æ‰€æœ‰Replicaéœ€è¦ä¿æŒä¸€è‡´çš„çŠ¶æ€ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰€æœ‰çš„Replicaåœ¨ç£ç›˜ä¸Šåº”è¯¥è®°å½•ç›¸åŒçš„é•¿åº¦å’Œä¸€æ ·çš„GSã€‚</p><ol><li>NNç»­çº¦æ—¶(<em>NN renews lease, æ˜¯ä¸æ˜¯ç¿»è¯‘æˆNNæ¢å¤ç§Ÿçº¦æ—¶ï¼Œæ›´åŠ åˆé€‚</em>)ï¼Œ<em>æ”¹å˜è¿™ä¸ªæ–‡ä»¶çš„ç§Ÿçº¦æ‰€æœ‰è€…ä¸ºdfs</em>å¹¶å°†æ“ä½œè®°å½•åœ¨editlogã€‚å› æ­¤å¦‚æœclientä¾ç„¶æ´»ç€ï¼Œä»»ä½•ä¸€ä¸ªä¸å†™ç›¸å…³çš„è¯·æ±‚å¦‚ç”Ÿæˆä¸€ä¸ªæ–°çš„GSã€å¢åŠ ä¸€ä¸ªæ–°çš„blockæˆ–è€…å…³é—­è¿™ä¸ªæ–‡ä»¶ï¼Œå°†è¢«æ‹’ç»ã€‚ä¹‹æ‰€ä»¥è¢«æ‹’ç»æ˜¯å› ä¸ºclientæ­¤æ—¶å·²ç»ä¸å†æ‹¥æœ‰æ­¤æ–‡ä»¶çš„leaseã€‚è¿™å°±é˜»æ­¢äº†clientå¹¶å‘çš„æ”¹å˜ä¸€ä¸ªæœªå…³é—­çš„æ–‡ä»¶ã€‚</li><li>NNæ£€æŸ¥è¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªblockçŠ¶æ€ã€‚å…¶å®ƒçš„blockåº”è¯¥æ˜¯CompleteçŠ¶æ€ã€‚ä¸‹è¡¨å±•ç¤ºäº†æ‰€æœ‰å¯èƒ½çš„ç»„åˆå’Œç›¸åº”ç»„åˆæ‰€é‡‡å–äº†åŠ¨ä½œï¼š</li></ol><p><img src="/blogimgs/appendDesign/1.png"></p><h3 id="Block-Recovery"><a href="#Block-Recovery" class="headerlink" title="Block Recovery"></a>Block Recovery</h3><ol><li><p>NNé€‰æ‹©ä»Replicaæ‰€åœ¨çš„DNsä¸­é€‰æ‹©ä¸€ä¸ªprimary DataNode(PD)ä½œä¸ºNNçš„ä»£ç†æ¥æ‰§è¡Œblock recoveryã€‚å¦‚æœblockæ²¡æœ‰Replicasåˆ™æ”¾å¼ƒblock recoveryã€‚</p></li><li><p>NNå¾—åˆ°ä¸€ä¸ªæ–°GSã€‚GSç”¨æ¥æ ‡è¯†è¿™ä¸ªblockåœ¨recoveryæˆåŠŸä¹‹åçš„ç‰ˆæœ¬ã€‚Block recoveryæ”¹å˜æœ€åä¸€ä¸ªblockçš„çŠ¶æ€ï¼Œå¦‚æœå®ƒæ˜¯UnderConstructionï¼Œåˆ™æ”¹ä¸ºUnderRecoveryçŠ¶æ€(<em>not RUR</em>)ã€‚UnderRecovery blockç”±å”¯ä¸€çš„recovery idæ ‡è¯†å’Œæ–°çš„GSã€‚<em>PDå’ŒNNçš„ä»»ä½•ä¸€æ¬¡é€šä¿¡ï¼Œéƒ½éœ€è¦åŒ¹é…recovery idã€‚è¿™å°±æ˜¯æ€æ ·å¹¶å‘å¤„ç†block recoveryçš„</em>ã€‚<strong>æœ€åŸºç¡€çš„è§„åˆ™å°±æ˜¯æœ€è¿‘è¦æäº¤çš„recoveryçš„ä¼˜å…ˆçº§é«˜äºä¹‹å‰æäº¤çš„</strong>ã€‚</p></li><li><p>éšåNNè¦æ±‚PD recovery blockã€‚NNå‘é€ç»™PDæ–°çš„GSã€block idå’Œæ‰€æœ‰Replicaçš„locations(åŒ…æ‹¬finalized replicaã€RBW replicaå’ŒRWB replica)ã€‚</p></li><li><p>PDæ‰§è¡Œblock recoveryï¼š<br>a. PDè¦æ±‚Replicaå­˜åœ¨çš„æ¯ä¸€ä¸ªDNå»æ‰§è¡Œreplica recoveryã€‚<br>   i. PDå°†recovery idã€block idå’ŒGSå‘é€ç»™æ¯ä¸ªDN<br>   ii. DNæ£€æŸ¥å„è‡ªReplicaçš„çŠ¶æ€ï¼š</p><pre><code>  1ã€ æ£€æŸ¥æ˜¯å¦å­˜åœ¨ï¼šå¦‚æœDNæ²¡æœ‰è¿™ä¸ªreplicaï¼Œæˆ–è€…è¿™ä¸ªreplicaçš„GSæ¯”è¯·æ±‚ä¸­çš„GSè¦è€ï¼Œæ›´æˆ–è€…æ˜¯æ¯”recovery idè¦æ–°ï¼Œåˆ™æŠ›å‡ºReplicaNotExistsException  2ã€æ£€æŸ¥æ˜¯å¦åœæ­¢å†™å…¥ï¼šå¦‚æœä¸€ä¸ªreplicaæ­£åœ¨å†™å…¥å’Œä¸€ä¸ªæ­£åœ¨å†™å…¥çš„çº¿ç¨‹ï¼Œåˆ™ä¸­æ–­å†™çº¿ç¨‹ï¼Œç­‰å¾…å†™çº¿ç¨‹é€€å‡ºã€‚å¦‚æœå†™çº¿ç¨‹æ­£åœ¨æ¥å—packetæ—¶è¢«ä¸­æ–­ï¼Œåˆ™åœæ­¢å†™çº¿ç¨‹å¹¶æ”¾å¼ƒè¿™ä¸ªå†™å…¥ä¸€åŠçš„packetã€‚åœ¨çº¿ç¨‹é€€å‡ºä¹‹å‰ï¼Œç¡®è®¤ç£ç›˜ä¸Šè®°å½•çš„é•¿åº¦ä¸BRç›¸åŒï¼Œç„¶åå…³é—­blockæ–‡ä»¶å’Œcrcæ–‡ä»¶ã€‚*è¿™æ ·æ§åˆ¶äº†client writeå’Œblock recoveryåœ¨DNsä¸Šçš„å¹¶å‘*ã€‚Block recoveryæŠ¢å client writeï¼Œå¯¼è‡´pipelineå¤±è´¥ã€‚éšåçš„pipeline recoveryä¼šå¤±è´¥ï¼Œå› ä¸ºdfs clientä»NNå¾—åˆ°ä¸€ä¸ªUnderRecoveryçŠ¶æ€blockçš„GSã€‚  3ã€åœæ­¢ä¹‹å‰çš„block recoveryï¼šå½“æŸä¸ªReplicaå·²ç»æ˜¯RURçŠ¶æ€æ—¶ï¼Œå¦‚æœæ­¤Replicaçš„recovery idå¤§äºç­‰äºåˆšæ”¶åˆ°æ­¤Replicaçš„recovery idï¼Œåˆ™æŠ›å‡ºâ€©RecoveryInProgressExceptionã€‚å¦‚æœåˆšæ”¶åˆ°çš„GSå¤§ï¼Œåˆ™è¡¨ç¤ºRUR replicaçš„recovery idè®¾ç½®ä¸ºåˆšæ”¶åˆ°çš„recovery idã€‚  4ã€çŠ¶æ€æ”¹å˜ï¼šå°†Replicaçš„çŠ¶æ€å˜ä¸ºRURã€‚è®¾ç½®recovery idä¸ºä¸€ä¸ªæ–°çš„recovery idå’ŒåŸæ¥çŠ¶æ€çš„ä¸€ä¸ªå¼•ç”¨(Set its recovery id to be the new recovery id and a reference to its old state.)ã€‚ä»»ä½•ä¸€æ¬¡PDå’Œå®ƒçš„é€šä¿¡éƒ½éœ€è¦åŒ¹é…recovery idã€‚*Note3å’Œ4åœ¨DNsçš„block recoveryå¹¶å‘çš„é—®é¢˜*ã€‚æœ€åä¸€ä¸ªrecoveryæ€»æ˜¯ä¼˜å…ˆäºä¹‹å‰çš„recoveryï¼Œå¹¶ä¸”æ²¡æœ‰ä¸¤ä¸ªrecoveryä¼šæœ‰æ‰€äº¤å‰ã€‚  5ã€æ£€æŸ¥crcï¼šå¯¹blockæ–‡ä»¶è¿›è¡Œä¸€æ¬¡crcæ£€æŸ¥ã€‚å¦‚æœReplicaçš„çŠ¶æ€æ˜¯finalizedæˆ–è€…RBWæ—¶ï¼Œcrcä¸åŒ¹é…åˆ™æŠ›å‡ºCorruptedReplicaExceptionâ€©ã€‚ç„¶è€Œå¦‚æœReplicaçš„çŠ¶æ€æ˜¯RWRæ—¶ï¼Œå¯¹blockæ–‡ä»¶è¿›è¡Œè£å‰ªï¼Œå°†ä¸åŒ¹é…çš„éƒ¨åˆ†å‡æ‰ï¼Œä¿ç•™ä¸Šæ¬¡åŒ¹é…çš„é•¿åº¦ã€‚</code></pre><p>   iii. å¦‚æœæ²¡æœ‰ä»»ä½•å¼‚å¸¸æŠ›å‡ºï¼Œæ¯ä¸ªDNå°†Replicaçš„çŠ¶æ€(Replica idã€GSã€on-disk lenã€pre-recovery state)è¿”å›ç»™PDã€‚<br>b. ä»DNæ”¶åˆ°å“åº”ä¹‹åï¼ŒPDæ¥å†³å®šblockçš„é•¿åº¦ã€‚<br>   i. å¦‚æœæœ‰ä¸€ä¸ªDNæŠ›å‡ºRecoveryInProgressExceptionï¼Œåˆ™PDæ”¾å¼ƒblock recoveryã€‚<br>   ii. å¦‚æœæ‰€æœ‰çš„DNæŠ›å‡ºä¸€ä¸ªexception(<em>æ‰€æœ‰çš„DNæŠ›å‡ºçš„exceptionå¿…é¡»ç›¸åŒè¿˜æ˜¯ï¼Ÿï¼Ÿï¼Ÿ</em>)ï¼Œåˆ™æ”¾å¼ƒblock recoveryã€‚<br>   iii. å¦‚æœNNæ¥æ”¶åˆ°çš„æ‰€æœ‰æœ€å¤§Replicaçš„é•¿åº¦ä¸º0ï¼Œåˆ™NNåˆ é™¤è¿™ä¸ªblock<br>   iv. å¦åˆ™ï¼Œæ£€æŸ¥é•¿åº¦é0çš„Replicaè¿”å›çš„çŠ¶æ€ã€‚ä¸‹è¡¨æ˜¯ä¸¤ä¸ªReplicaçš„å¯èƒ½ç»„åˆæƒ…å†µ:</p></li></ol><p><img src="/blogimgs/appendDesign/2.png"></p><p>   c. Recovery Replicaçš„é•¿åº¦è®¾ç½®å‚è€ƒb.iv<br>      i. PDè¦æ±‚æ¯ä¸ªDNå»æ¢å¤Replicaï¼Œç”±PDå‘é€block idã€GSå’Œé•¿åº¦<br>      ii. å¦‚æœDNä¸­ä¸å­˜åœ¨RURçŠ¶æ€çš„Replicaæˆ–è€…Recovery idå’Œæ–°çš„GSä¸åŒ¹é…ï¼Œåˆ™å¤±è´¥<br>      iii. å¦åˆ™DNæ”¹å˜è¿™ä¸ªReplicaçš„GSä¸ºæ–°çš„GSã€‚éšååœ¨å†…å­˜ä¸­æ›´æ–°æ­¤Replicaçš„é•¿åº¦ä¸ºæ–°çš„é•¿åº¦ï¼Œè£å‰ªè¿™ä¸ªblock file(ç£ç›˜ä¸­çš„æ–‡ä»¶)çš„é•¿åº¦å¹¶æ”¹å˜crc file(may casuse truncation and/or modification of last 4 crcbytes)ã€‚å¦‚æœè¯¥Replicaä¸æ˜¯FinalizedçŠ¶æ€åˆ™å˜ä¸ºFinalizedçŠ¶æ€ã€‚æ­¤æ—¶Replica RecoveryæˆåŠŸ<br>   d. PDæ£€æŸ¥cçš„ç»“æœã€‚<br>   å¦‚æœæ²¡æœ‰DNæˆåŠŸï¼Œåˆ™block recoveryå¤±è´¥ã€‚<br>   å¦‚æœä¸€äº›æˆåŠŸä¸€äº›å¤±è´¥ï¼ŒPDä»NNå¤„å¾—åˆ°ä¸€ä¸ªæ–°çš„GSï¼Œè®©æˆåŠŸçš„DNé‡å¤block recoveryã€‚<br>   å¦‚æœæ‰€æœ‰çš„DNéƒ½æˆåŠŸäº†ï¼ŒPDå°†æ–°çš„GSå’Œé•¿åº¦å‘ŠçŸ¥NNã€‚<br>   NN finalizes the blockï¼Œå¹¶ä¸”å¦‚æœè¿™ä¸ªæ–‡ä»¶çš„æ‰€æœ‰blockéƒ½æ˜¯CompleteçŠ¶æ€ï¼Œåˆ™å…³é—­æ–‡ä»¶ã€‚åœ¨è¶…è¿‡äº†å°è¯•å…³é—­æ–‡ä»¶çš„æ¬¡æ•°ä¹‹åï¼ŒNNå¼ºåˆ¶å…³é—­æ–‡ä»¶</p><p>pipelineæµä¸­è‡³å°‘æœ‰ä¸€ä¸ªDNæ˜¯æ­£å¸¸çš„å¹¶ä¸”å†™å…¥æµæ²¡æœ‰è¢«ä¸­æ–­ï¼Œåˆ™lease recoveryå°±èƒ½å¤Ÿä¿è¯åœ¨æ¢å¤ä¹‹åå¯¹clientå¯è§çš„æ•°æ®ä¸ä¼šä¸¢å¤±ã€‚è¿™æ˜¯å› ä¸ºï¼š</p><ol><li>åœ¨case1ã€2å’Œ3ä¸­æœ‰ä¸€ä¸ªReplicaæ˜¯FinalizedçŠ¶æ€ã€‚åˆ™clientåœ¨blockæ„å»ºè¿‡ç¨‹ä¸­çš„stage1å’Œæˆ–è€…stage3è‚¯å®šå·²ç»æŒ‚äº†ã€‚è¿™ä¸ªç®—æ³•ä¸ä¼šç§»é™¤ä»»ä½•æ•°æ®ã€‚</li><li>åœ¨case4å’Œ5ä¸­ï¼Œæ‰€æœ‰recoveryçš„Replicaéƒ½æœ‰RBWçŠ¶æ€(<em>all replicas to be recovered are in rbw state</em>)ã€‚clientè‚¯å®šåœ¨blockæ„å»ºè¿‡ç¨‹ä¸­çš„stage2æ—¶å·²ç»æ­»å»ã€‚å‡è®¾recoveryä¹‹å‰çš„pipelineæœ‰nä¸ªDN(DN0ã€DN1..DNn)ï¼ŒDNiåœ¨4.a.iiè¿”å›çš„é•¿åº¦ä¸€å®šç­‰äºBRiã€‚å‡è®¾åœ¨pipelineä¸­DNçš„ä¸€ä¸ªå­é›†DNs(<em>Assume that a subset of the DataNodes S in the pipeline participates the length agreement</em>)ï¼Œåˆ™é•¿åº¦ä¸º<em>min(BRi, iä¸ºDNsä¸­çš„ç´¢å¼•)&gt;=BRn-1&gt;=BAn-1&gt;=â€¦&gt;=BA0</em>ã€‚è¿™å°±ä¿è¯äº†lease recoveryä¸ä¼šç§»é™¤å·²ç»å¯¹clientå¯è§çš„æ•°æ®ã€‚</li><li>åœ¨case6ä¸­ï¼Œè¿™ä¸ªç®—æ³•æ²¡æœ‰ä»»ä½•ä¿è¯ï¼Œå› ä¸ºåœ¨recoveryä¹‹å‰çš„pipelineä¸­çš„æ‰€æœ‰DNéƒ½å·²ç»é‡å¯äº†ã€‚</li></ol><h2 id="Pipeline-Set-Up"><a href="#Pipeline-Set-Up" class="headerlink" title="Pipeline Set Up"></a>Pipeline Set Up</h2><h3 id="pipeline-setupçš„åŸå› "><a href="#pipeline-setupçš„åŸå› " class="headerlink" title="pipeline setupçš„åŸå› "></a>pipeline setupçš„åŸå› </h3><ol><li>Create: å½“ä¸€ä¸ªæ–°çš„blockè¢«åˆ›å»ºæ—¶ï¼Œpipelineéœ€è¦åœ¨æ•°æ®ä¼ è¾“åˆ°DNä¹‹å‰è¢«åˆ›å»º</li><li>Append: å½“ä¸€ä¸ªæ–‡ä»¶éœ€è¦è¿½åŠ æ—¶ï¼Œå¹¶ä¸”æœ€åä¸€ä¸ªblockæ²¡æœ‰å†™æ»¡ã€‚ç”±æœ€åä¸€ä¸ªblockçš„æ‰€æœ‰Replicaæ‰€åœ¨çš„DNç»„æˆçš„pipelineéœ€è¦åœ¨ä¼ è¾“æ•°æ®åˆ°DNä¹‹å‰è¢«å»ºç«‹ã€‚</li><li>Append Recovery: å½“ç¬¬2ç§æƒ…å†µå¤±è´¥æ—¶ï¼ŒåŒ…å«å‰©ä¸‹DNçš„pipelineéœ€è¦è¢«åˆ›å»ºã€‚</li><li>Data Streaming Recovery: å¦‚æœData Streamingå¤±è´¥ï¼Œå‰©ä¸‹DNç»„æˆçš„pipelineéœ€è¦åœ¨Data Streaming resumesä¹‹å‰è¢«å»ºç«‹ã€‚</li><li>Close Recovery: å¦‚æœpipelineå…³é—­å¤±è´¥ï¼Œå‰©ä¸‹çš„DNç»„æˆçš„pipelineä¸ºäº†finalize blockè€Œéœ€è¦è¢«å»ºç«‹ã€‚</li></ol><h3 id="pipeline-setup-æ­¥éª¤"><a href="#pipeline-setup-æ­¥éª¤" class="headerlink" title="pipeline setup æ­¥éª¤"></a>pipeline setup æ­¥éª¤</h3><p>1ã€case2ã€3ã€4å’Œ5éƒ½æ˜¯åœ¨å·²ç»å­˜åœ¨çš„blockä¸Šåˆ›å»ºpipelineï¼Œå› æ­¤blockçš„GSéœ€è¦éšç€pipelineçš„åˆ›å»ºè€Œæ›´æ–°ã€‚dfs clientå‘NNè¯·æ±‚ä¸€ä¸ªæ–°çš„GSã€‚</p><p>2ã€dfs clientå‘pipelineä¸­çš„DNå‘é€ä¸€ä¸ªå†™blockçš„è¯·æ±‚ï¼Œè¯·æ±‚æ‰€å¸¦çš„å‚æ•°æœ‰è€ç‰ˆæœ¬GSçš„block idã€blocké•¿åº¦(Replicaçš„é•¿åº¦ä¸€å®šå¤§äºç­‰äºæ­¤é•¿åº¦)ã€æœ€å¤§çš„Replicaé•¿åº¦ã€flagsã€æ–°çš„GSç­‰ã€‚å¦‚ä¸‹è¡¨æ‰€ç¤ºï¼š</p><p><img src="/blogimgs/appendDesign/3.png"></p><p>3ã€ä¸‹è¡¨è®°å½•äº†DNåœ¨æ¥æ”¶åˆ°pipeline setupè¯·æ±‚ä¹‹åçš„è¡Œä¸ºã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ<em>RWR Replicaä¸å‚ä¸pipeline recovery</em>ã€‚é€šè¿‡å¯¹RWR Replicaè¿›è¡Œä¸€äº›ç‰¹æ®Šçš„å¤„ç†ä»è€Œæ”¾å®½è¿™ä¸ªé™åˆ¶ã€‚ä½†æ˜¯ç”±äºè¿™ç§æƒ…å†µå¾ˆå°‘è§ï¼Œæˆ‘ä»¬æš‚æ—¶é€‰æ‹©ä»€ä¹ˆä¹Ÿä¸åšã€‚</p><p><img src="/blogimgs/appendDesign/4.png"></p><p>4ã€åœ¨case2ã€3å’Œ4ä¸­ï¼Œå½“pipeline setupæˆåŠŸä¹‹åï¼Œdfs clientå°†new GSã€min lengthå’Œæ–°pipelineä¸­çš„DNé€šçŸ¥ç»™NNã€‚NNéšåæ›´æ–°UnderConstruction blockçš„GSã€lenå’Œlocationsã€‚</p><p>5ã€å½“pipelineåˆ›å»ºå¤±è´¥æ—¶ï¼Œå¦‚æœpipelineä¸­è¿˜æœ‰DNå­˜æ´»ï¼Œåˆ™è¿”å›åˆ°ç¬¬ä¸€æ­¥å¹¶ä¸”è®¾ç½®flagsä¸ºrecoveryã€‚å¦‚æœpipelineä¸­æ²¡æœ‰DNå­˜æ´»ï¼Œè¡¨ç¤ºæ­¤æ¬¡pipelineå¤±è´¥ã€‚<br>å¦‚æœuser applicationåœ¨hflushæˆ–è€…writeä¸­blockedï¼Œåˆ™unblockedå¹¶æŠ›å‡ºEmptyPipelineExceptionã€‚å¦åˆ™åœ¨ä¸‹æ¬¡write/hflush/closeä¼šå¾—åˆ°EmptyPipelineExceptionã€‚</p><h2 id="å‘NNæŠ¥å‘ŠReplica-BlockçŠ¶æ€ã€å…ƒæ•°æ®ä¿¡æ¯"><a href="#å‘NNæŠ¥å‘ŠReplica-BlockçŠ¶æ€ã€å…ƒæ•°æ®ä¿¡æ¯" class="headerlink" title="å‘NNæŠ¥å‘ŠReplica/BlockçŠ¶æ€ã€å…ƒæ•°æ®ä¿¡æ¯"></a>å‘NNæŠ¥å‘ŠReplica/BlockçŠ¶æ€ã€å…ƒæ•°æ®ä¿¡æ¯</h2><h3 id="client-reports"><a href="#client-reports" class="headerlink" title="client reports"></a>client reports</h3><p>clienté€šçŸ¥NNæ›´æ”¹UnderConstruction blockçš„å…ƒæ•°æ®ä¿¡æ¯æˆ–è€…çŠ¶æ€ã€‚</p><p>åœ¨pipeline set upç« èŠ‚ä»‹ç»çš„<em>case2(append)ã€case3(append recovery)å’Œcase4(data streaming recovery)ä¸­ï¼Œä¸€ä¸ªæ–°çš„pipelineå»ºç«‹ä¹‹åï¼Œclientå‘NNæ±‡æŠ¥blockçš„GSå’Œpipelineä¸­çš„DN</em>ã€‚NNéšåæ›´æ–°UnderConstruction blockçš„GSã€lengthå’Œlocationsã€‚</p><p><em>éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå‡å¦‚pipelineæ˜¯å› ä¸ºcreate blockè€Œå»ºç«‹çš„ï¼Œåˆ™clientä¸å‘NNæ±‡æŠ¥è¿™ä¸ªæ–°çš„blockå’Œlocationsã€‚ç›¸åå½“clienté€šè¿‡addBlock/appendç”³è¯·ä¸€ä¸ªæ–°çš„blockæ—¶ï¼ŒNNå…ˆå°†è¿™ä¸ªæ–°blockå’Œlocationsæ”¾å…¥blocksMapï¼Œç„¶åå°†blockå’Œlocationsè¿”å›ç»™client</em>ã€‚è¿™ç§è®¾è®¡æœ‰ç‘•ç–µã€‚å¦‚æœä¸€ä¸ªè¯»è¯·æ±‚å»è¯»æœ€åä¸€ä¸ªblockï¼Œ<em>è€Œè¿™ä¸ªæ—¶é—´ç‚¹æ­£å¥½å‘ç”Ÿåœ¨è¿™ä¸ªblockåœ¨NNç«¯æ”¾å…¥blocksMapåï¼Œè¿™ä¸ªblockçš„ä¸€ä¸ªReplicaåœ¨DNä¸Šåˆ›å»ºä¹‹å‰</em>ï¼Œåˆ™è¿™ä¸ªè¯»è¯·æ±‚å¯èƒ½ä¼šå¾—åˆ°â€block dose not exitâ€çš„é”™ã€‚ç”±äºè¿™ç§æƒ…å†µå¾ˆå°‘ï¼Œæˆ‘ä»¬æœ‰æ„çš„è¿™æ ·è®¾è®¡å·²æ¢å–æ€§èƒ½ã€‚å½“æ–°å»ºblockæ—¶ï¼Œpipeline setup ä¹‹åï¼Œclientæ²¡æœ‰å¿…è¦å‘NNå‘é€ä¸€ä¸ªé€šçŸ¥ã€‚</p><p><em>å½“clientè¯·æ±‚addBlockæˆ–è€…closeæ–‡ä»¶æ—¶ï¼ŒNNä¼šfinalizeæœ€åä¸€ä¸ªblockçš„GSå’Œlengthã€‚å¦‚æœæœ€åä¸€ä¸ªblockå·²ç»å­˜åœ¨ä¸€ä¸ªä¸å…¶GS/lenç›¸åŒçš„Replicaï¼Œåˆ™å°†æœ€åä¸€ä¸ªblockçš„çŠ¶æ€å¯èƒ½ä¼šå˜ä¸ºCompleteã€‚å¦åˆ™å°†æœ€åä¸€ä¸ªblockçš„çŠ¶æ€å˜ä¸ºCommitted</em>ã€‚å¦å¤–ï¼Œå¦‚æœæœ€åä¸€ä¸ªblockçš„Replicaä¸ªæ•°å°äºå‰¯æœ¬å› å­ï¼Œåˆ™NNå¤åˆ¶è¿™ä¸ªblockä½¿å…¶è¾¾æ»¡è¶³å‰¯æœ¬å› å­ã€‚</p><h3 id="DataNode-Reports"><a href="#DataNode-Reports" class="headerlink" title="DataNode Reports"></a>DataNode Reports</h3><p>DNå‘¨æœŸæ€§çš„å‘NNæ±‡æŠ¥Replicaçš„å…ƒæ•°æ®ä¿¡æ¯æˆ–è€…çŠ¶æ€çš„æ”¹å˜ã€‚å½“RBW Replicaå˜ä¸ºFinalizedæ—¶å‘NNå‘é€ä¸€ä¸ªblockReceivedä¿¡æ¯ã€‚</p><h3 id="Block-Reports"><a href="#Block-Reports" class="headerlink" title="Block Reports"></a>Block Reports</h3><ul><li><em>blockæ±‡æŠ¥çš„å†…å®¹åŒ…æ‹¬ä¸¤ç§ï¼Œä¸€ç§æ˜¯é’ˆå¯¹Finalized Replicaï¼Œå¦ä¸€ç§æ˜¯é’ˆå¯¹RBW Replica</em>ã€‚Finalized Replicaæ—¶æ±‡æŠ¥çš„å†…å®¹åŒ…æ‹¬Finalizedçš„Replicaå’Œä¹‹å‰çŠ¶æ€æ˜¯Finalizedè€Œç°åœ¨æ˜¯RURçŠ¶æ€çš„Replicaã€‚RBW Replicaæ—¶æ±‡æŠ¥çš„å†…å®¹åŒ…æ‹¬RBW Replicaã€RWR Replicaså’Œä¹‹å‰çŠ¶æ€ä¸æ˜¯Finalizedè€Œç°åœ¨çš„çŠ¶æ€æ˜¯RURçš„Replicaã€‚*RBW Replicaçš„é•¿åº¦æ˜¯å·²ç»æ¥æ”¶åˆ°çš„é•¿åº¦(BR)*ã€‚RWRçš„é•¿åº¦æ˜¯ä¸€ä¸ªè´Ÿæ•°ã€‚</li><li>Replicaæ±‡æŠ¥çš„çŠ¶æ€æ˜¯ä¸€ä¸ªå››å…ƒç»„(DataNode, blck_id, blck_GS, blck_len, isRbw)</li><li>NNæ”¶åˆ°block reportä¹‹åï¼Œå’Œå†…å­˜ä¸­çš„çŠ¶æ€è¿›è¡Œå¯¹æ¯”ï¼Œå¯¹æ¯”çš„ç»“æœå¦‚ä¸‹ï¼š(åœ¨å†…å­˜ä¸­ä¿å­˜ç€4ä¸ªlist)<br> 1ã€å¦‚æœblck_idæ— æ•ˆåˆ™æ”¾å…¥deleteListä¸­ï¼Œä¾‹å¦‚blocksMapä¸­ä¸å­˜åœ¨blck_idçš„Entryæˆ–è€…ä¸å±äºä»»ä½•ä¸€ä¸ªæ–‡ä»¶<br> 2ã€å¦‚æœNNæ²¡æœ‰è¿™ä¸ªReplica(DataNode, blck_id)ä½†æ˜¯block reportä¸­æœ‰ï¼Œåˆ™åŠ å…¥addStoredBlockList<br> 3ã€å¦‚æœNNæœ‰è¿™ä¸ªReplica(DataNode, blck_id)ä½†æ˜¯block reportä¸­æ²¡æœ‰ï¼Œåˆ™åŠ å…¥rmStoredBlockList<br> 4ã€å¦‚æœReplicaåœ¨NNä¸­çš„çŠ¶æ€æ˜¯RBWï¼Œè€Œblock reportä¸­æ˜¯Finalizedï¼Œåˆ™åŠ å…¥updateStateListã€‚(<strong>RBWåº”è¯¥æ˜¯DNçš„çŠ¶æ€ï¼Œæ€ä¹ˆä¼šåœ¨NNä¸­è®°å½•å‘¢ï¼Ÿï¼Ÿ</strong>)<br>é¿å…client reportå’ŒDataNode reportç«äº‰æ¡ä»¶ï¼Œåˆ™RBW ReplicaåªåŠ å…¥deleteListæˆ–è€…addStoredBlockListã€‚</li><li>æ·»åŠ ä¸€ä¸ªæ–°çš„Replica<br> 1ã€Blockåœ¨NNä¸­çš„çŠ¶æ€æ˜¯Complete<br> å½“æ±‡æŠ¥çš„Replicaçš„çŠ¶æ€æ˜¯Finalizedæ—¶ï¼Œå¦‚æœå®ƒçš„GSå’Œlengthå’ŒNNè®°å½•çš„å€¼ä¸ä¸€æ ·ï¼Œåˆ™å°†å®ƒåŠ å…¥blocksMapä½†è¦æ ‡è®°ä¸ºcorruptã€‚å¦åˆ™add the replica(<strong>??????</strong>)ã€‚<br> å½“æ±‡æŠ¥çš„Replicaçš„çŠ¶æ€æ˜¯RBWæ—¶ï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶å·²ç»å…³é—­ï¼Œå¦‚æœReplicaçš„GS/lengthå’ŒNNä¸­è®°å½•çš„å€¼ä¸ä¸€æ ·æˆ–è€…è¿™ä¸ªblockå·²ç»è¾¾åˆ°äº†å‰¯æœ¬å› å­çš„ä¸ªæ•°ï¼Œåˆ™å‘½ä»¤å®ƒçš„DataNodeå°†å…¶Replicaåˆ é™¤ã€‚å¦åˆ™do nothingã€‚<br> 2ã€Blockåœ¨NNä¸­çš„çŠ¶æ€æ˜¯Committed<br> è¿™ä¸ªå¤„ç†çš„æµç¨‹å’Œä¸Šé¢çš„æƒ…å†µç±»ä¼¼ï¼Œé™¤éæ±‡æŠ¥çš„Replicaçš„çŠ¶æ€æ˜¯Finalizedå¹¶ä¸”å’ŒNNä¸­è®°å½•çš„GSå’Œlengthç›¸åŒï¼Œåˆ™NNå°†è¿™ä¸ªblockçš„çŠ¶æ€æ”¹ä¸ºCompleteã€‚<br> 3ã€Blockåœ¨NNä¸­çš„çŠ¶æ€æ˜¯UnderConstructionæˆ–è€…UnderRecovery<br> å¦‚æœæ±‡æŠ¥çš„Replicaçš„çŠ¶æ€æ˜¯Finalizedå¹¶ä¸”æ­¤Replicaçš„GSä¸NNä¸­è®°å½•çš„GSç›¸åŒæˆ–è€…æ¯”NNä¸­è®°å½•çš„å€¼æ–°ï¼Œåˆ™add the replicaã€‚åŒæ—¶æ ‡è®°è¿™ä¸ªreplicaä¸ºFinalizedå’Œä¿æŒå¯¹å®ƒçš„é•¿åº¦å’ŒGSçš„è·Ÿè¸ªã€‚<br> å¦‚æœæ±‡æŠ¥çš„Replicaçš„çŠ¶æ€æ˜¯RBWå¹¶ä¸”æ­¤Replicaæ˜¯æœ‰æ•ˆçš„(GSä¸è€ï¼Œlengthä¸çŸ­)ï¼Œadd the replicaã€‚å¦‚æœReplicaæ˜¯RBWï¼Œåˆ™æ ‡è®°ä¸ºRBWï¼Œå¦åˆ™æ ‡è®°ä¸ºRWRã€‚<br> å¦åˆ™å¿½ç•¥å®ƒ(Otherwise ignore it)ã€‚</li><li>æ›´æ–°Replicaçš„çŠ¶æ€<br>å½“block reportçš„å†…å®¹æ˜¯Replicaä»RBWå˜ä¸ºFinalizedçŠ¶æ€æ—¶ï¼Œ<br>å¦‚æœè¿™ä¸ªblockæ˜¯UnderConstructionçŠ¶æ€ï¼ŒNNæ ‡è®°NNå­˜å‚¨è¿™ä¸ªReplicaä¸ºFinalizedå¹¶ä¸”è®°å½•è¿™ä¸ªFinalized Replicaçš„GSå’Œlength(NN marks the NN stored replica as finalized and keeps track of the finalized replicaâ€™s GS and length)ã€‚<br>å¦‚æœè¿™ä¸ªblockæ˜¯CommittedçŠ¶æ€ï¼Œå¦‚æœè¿™ä¸ªFinalized Replicaçš„GSå’Œlengthå’Œblockçš„GSå’Œlengthç›¸åŒ¹é…ï¼Œåˆ™NNæ”¹å˜è¿™ä¸ªblockçš„çŠ¶æ€ä¸ºCompleteã€‚<br>å¦åˆ™ä»NNä¸Šç§»é™¤è¯¥Replicaã€‚</li></ul><h3 id="blockReceived"><a href="#blockReceived" class="headerlink" title="blockReceived"></a>blockReceived</h3><p>DataNodeå‘NNå‘é€blockReceivedé€šçŸ¥NNä¸€ä¸ªReplicaå·²ç»å®Œæˆã€‚<br>å½“NNæ¥æ”¶åˆ°blockReceivedé€šçŸ¥åï¼Œ<br>å¦‚æœ(DataNode, blck_id)åœ¨NNä¸­ä¸å­˜åœ¨ï¼Œåˆ™add a new replicaã€‚<br>å¦‚æœreplicaè®°å½•çš„çŠ¶æ€æ˜¯RBWï¼Œåˆ™æ›´æ–°replicaçš„çŠ¶æ€ã€‚<br>å¦‚æœblockæ˜¯æ— æ•ˆçš„ï¼Œåˆ™è¦æ±‚DataNodeåˆ é™¤è¿™ä¸ªreplicaã€‚</p><h2 id="Replica-Block-State-Transition"><a href="#Replica-Block-State-Transition" class="headerlink" title="Replica/Block State Transition"></a>Replica/Block State Transition</h2><h3 id="Replica-State-Transition"><a href="#Replica-State-Transition" class="headerlink" title="Replica State Transition"></a>Replica State Transition</h3><p>ä¸‹å›¾æ€»ç»“äº†Replicaåœ¨DataNodeä¸Šæ‰€æœ‰å¯èƒ½çš„çŠ¶æ€è½¬ç§»ã€‚<br><img src="/blogimgs/appendDesign/ReplicaTransition.png" alt="Replica State Transition" title="Replica State Transition"></p><ul><li>æ–°çš„Replicaè¢«åˆ›å»º<br> å¦‚æœæ–°çš„Replicaæ˜¯è¢«clientåˆ›å»ºï¼Œåˆ™Replicaçš„çŠ¶æ€æ˜¯RBWã€‚<br> å¦‚æœæ˜¯ç”±äºNNå‘é€çš„ä¸€ä¸ªå¤åˆ¶(å¤åˆ¶å‰¯æœ¬æˆ–è€…balance)çš„æŒ‡ä»¤ï¼Œåˆ™Replicaçš„çŠ¶æ€æ˜¯Temporaryã€‚</li><li>å½“DNé‡å¯æ—¶ï¼ŒRBW Replicaæ”¹å˜çŠ¶æ€ä¸ºRWRã€‚</li><li>å½“leaseåˆ°æœŸè€Œå¼•èµ·çš„Replica recoveryæ—¶ï¼ŒReplicaçš„çŠ¶æ€å˜ä¸ºRUR</li><li>å½“clientå…³é—­æ–‡ä»¶ã€Replica recoveryæˆåŠŸæˆ–è€…å¤åˆ¶æˆåŠŸæ—¶ï¼ŒReplicaçš„çŠ¶æ€æ˜¯Finalizedã€‚</li><li>recoveryå‘ç”Ÿé”™è¯¯ï¼Œæ€»æ˜¯ä¼šæ›´æ–°Replicaçš„GS</li></ul><h3 id="Block-State-Transition"><a href="#Block-State-Transition" class="headerlink" title="Block State Transition"></a>Block State Transition</h3><p>ä¸‹å›¾æ€»ç»“äº†Blockåœ¨NNä¸Šæ‰€æœ‰å¯èƒ½çš„çŠ¶æ€è½¬ç§»ã€‚<br><img src="/blogimgs/appendDesign/BlockTransition.png" alt="Block State Transition" title="Block State Transition"></p><ul><li>Blockè¢«åˆ›å»º<br> å¦‚æœclientè°ƒç”¨addBlockç»™ä¸€ä¸ªæ–‡ä»¶æ·»åŠ ä¸€ä¸ªæ–°çš„blockæ—¶ï¼Œåˆ›å»ºBlock<br> å¦‚æœclientè°ƒç”¨appendå¹¶ä¸”æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockå·²ç»å†™æ»¡ï¼Œåˆ™åˆ›å»ºBlock<br>æ–°åˆ›å»ºçš„Blockçš„çŠ¶æ€æ˜¯UnderConstruction   </li><li>å¦‚æœæœ€åä¸€ä¸ªblockæ²¡æœ‰å†™æ»¡ï¼Œåˆ™appendä¼šå°†æœ€åä¸€ä¸ªblockç”±CompleteçŠ¶æ€å˜ä¸ºUnderConstructionã€‚</li><li>å½“addBlockæˆ–è€…closeæ—¶ï¼Œ<br> æœ€åä¸€ä¸ªBlockçš„çŠ¶æ€å¯èƒ½æ˜¯Complete(Blockçš„GSå’Œlenå·²ç»æœ‰Replicaä¸ä¹‹ç›¸åŒ¹é…)ä¹Ÿå¯èƒ½æ˜¯Committed(ä¸åŒ¹é…åˆ™ä¸ºCommitted)ã€‚<br> addBlockä¼šä¸€ç›´ç­‰åˆ°ç›´åˆ°å€’æ•°ç¬¬äºŒä¸ªBlockå˜ä¸ºCompleteã€‚<br> ç›´åˆ°æœ€åä¸¤ä¸ªblockå˜ä¸ºCompleteæ—¶ï¼Œæ–‡ä»¶æ‰ä¼šå…³é—­</li><li>å½“leaseåˆ°æœŸæ—¶ï¼Œlease recoveryå°†UnderConstructionçŠ¶æ€çš„blockå˜ä¸ºUnderRecovery<br> block recoveryä¼šå°†UnderRecoveryå˜ä¸ºï¼š<br> 1ã€å¦‚æœReplicaçš„é•¿åº¦ä¸º0åˆ™ç§»é™¤ã€‚<br> 2ã€å¦‚æœrecoveryæˆåŠŸå¹¶ä¸”æ²¡æœ‰ä¸GSå’Œlenç›¸åŒ¹é…çš„Finalized Replicaå­˜åœ¨ï¼Œåˆ™å˜ä¸ºCommittedã€‚<br> 3ã€å¦‚æœrecoveryæˆåŠŸå¹¶ä¸”æœ‰ä¸GSå’Œlenç›¸åŒ¹é…çš„Finalized Replicaå­˜åœ¨ï¼Œåˆ™å˜ä¸ºCompleteã€‚<br> <strong>lease recoveryä¼šå¼ºåˆ¶å°†Committed blockå˜ä¸ºComplete</strong>ã€‚</li><li>Blockçš„çŠ¶æ€ä¸ä¼šå­˜å‚¨åœ¨ç£ç›˜ã€‚å½“NNé‡å¯æ—¶ï¼Œæœªå…³é—­æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockå˜ä¸ºUnderConstructionï¼Œ*å…¶ä½™çš„blockä¸ºComplete(å€’æ•°ç¬¬äºŒä¸ªblockæ˜¯Committedä¹Ÿä¼šå¼ºåˆ¶å˜ä¸ºComplete)*ã€‚<br> å¦‚æœè¿™ä¸ªblockæ˜¯æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockï¼Œå½“NNé‡å¯æ—¶ï¼Œæœ€åä¸€ä¸ªblockå¯èƒ½ä¼šä»Completeæˆ–è€…CommittedçŠ¶æ€å˜ä¸ºUnderConstructionã€‚å¦‚æœclientä¾ç„¶å­˜åœ¨ï¼Œclientä¼šå†æ¬¡å°†æ­¤block finalizeã€‚å¦åˆ™å½“leaseè¶…æœŸæ—¶ï¼Œblock recoveryä¼šå†æ¬¡finalizeã€‚</li><li>ä¸€æ—¦ä¸€ä¸ªblockå˜æˆCompleteæˆ–è€…Committedï¼Œè¯¥blockçš„æ‰€æœ‰Replicasåº”è¯¥æœ‰ç›¸åŒçš„GSå’Œé•¿åº¦ã€‚<em>å½“ä¸€ä¸ªblockæ˜¯UnderConstructionï¼Œå®ƒå¯èƒ½æœ‰å¤šä¸ªç‰ˆæœ¬çš„blockæ··åˆå­˜åœ¨é›†ç¾¤ä¸­</em>ã€‚</li></ul>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Append </tag>
            
            <tag> Hflush </tag>
            
            <tag> Read </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Java NIO</title>
      <link href="/Java%20NIO.html"/>
      <url>/Java%20NIO.html</url>
      
        <content type="html"><![CDATA[<h2 id="Java-NIO"><a href="#Java-NIO" class="headerlink" title="Java NIO"></a>Java NIO</h2><p>åœ¨æ•´ç†NIOæ–‡æ¡£å‰å…ˆä»‹ç»ä¸‹5ä¸ªI/Oæ¨¡å‹ã€‚åœ¨å°†I/Oæ¨¡å‹ä¹‹å‰è¿˜å¾—ä»‹ç»å‡ ä¸ªæ¦‚å¿µï¼š</p><p><img src="/blogimgs/javanio-1.jpg" alt="I/Oæ“ä½œæµç¨‹" title="I/Oæ“ä½œæµç¨‹"></p><ul><li>å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´</li></ul><blockquote><p>æ•°æ®ä»ç£ç›˜ç§»åŠ¨åˆ°ç”¨æˆ·è¿›ç¨‹çš„å†…å­˜åŒºåŸŸæ—¶ï¼Œè¦æ¶‰åŠåˆ°å†…æ ¸ç©ºé—´å’Œç”¨æˆ·ç©ºé—´ã€‚<br>ç”¨æˆ·ç©ºé—´å°±æ˜¯å¸¸è§„è¿›ç¨‹ï¼ˆå¦‚JVMï¼‰æ‰€åœ¨åŒºåŸŸï¼Œ_ç”¨æˆ·ç©ºé—´_æ˜¯<code>éç‰¹æƒåŒºåŸŸ</code>ï¼Œå¦‚<code>ä¸èƒ½ç›´æ¥è®¿é—®ç¡¬ä»¶è®¾å¤‡</code>ã€‚<em>å†…æ ¸ç©ºé—´</em>æ˜¯<code>æ“ä½œç³»ç»Ÿæ‰€åœ¨åŒºåŸŸ</code>ï¼Œé‚£è‚¯å®šæ˜¯æœ‰ç‰¹æƒå•¦ï¼Œå¦‚èƒ½ä¸è®¾å¤‡æ§åˆ¶å™¨é€šè®¯ï¼Œæ§åˆ¶ç”¨æˆ·åŒºåŸŸçš„è¿›ç¨‹è¿è¡ŒçŠ¶æ€ã€‚è¿›ç¨‹æ‰§è¡ŒI/Oæ“ä½œæ—¶ï¼Œå®ƒæ‰§è¡Œä¸€ä¸ªç³»ç»Ÿè°ƒç”¨æŠŠæ§åˆ¶æƒäº¤ç”±å†…æ ¸ã€‚</p></blockquote><ul><li>ç¼“å†²åŒºæ“ä½œ</li></ul><blockquote><p>ç¼“å†²åŒºæ“ä½œæ˜¯æ‰€æœ‰I/Oçš„åŸºç¡€ï¼Œè¿›ç¨‹æ‰§è¡ŒI/Oæ“ä½œï¼Œå½’ç»“èµ·æ¥å°±æ˜¯å‘æ“ä½œç³»ç»Ÿå‘å‡ºè¯·æ±‚ï¼Œè®©å®ƒè¦ä¹ˆæŠŠç¼“å†²åŒºé‡Œçš„æ•°æ®æ’å¹²ï¼ˆå†™ï¼‰ï¼Œè¦ä¹ˆæŠŠç¼“å†²åŒºå¡«æ»¡ï¼ˆè¯»ï¼‰</p></blockquote><span id="more"></span><h3 id="5ç§I-Oæ¨¡å‹"><a href="#5ç§I-Oæ¨¡å‹" class="headerlink" title="5ç§I/Oæ¨¡å‹"></a>5ç§I/Oæ¨¡å‹</h3><p><em>IOè¯·æ±‚åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µ</em>ï¼š1ã€ç­‰å¾…æ•°æ®å°±ç»ªã€‚2ã€ä»å†…æ ¸ç¼“å†²åŒºæ‹·è´æ•°æ®åˆ°è¿›ç¨‹ç¼“å†²åŒº<br>æŒ‰ç…§è¯·æ±‚æ˜¯å¦é˜»å¡åˆ†ä¸ºï¼šåŒæ­¥IOå’Œå¼‚æ­¥IOã€‚<br>Unixå­˜åœ¨5ç§IOæ¨¡å‹ï¼š<br>ï¼ˆ1ï¼‰é˜»å¡IO:æœ€å¸¸ç”¨çš„æ¨¡å‹ï¼Œç¼ºçœæƒ…å†µæ–‡ä»¶æ“ä½œéƒ½æ˜¯é˜»å¡çš„ã€‚<br><img src="/blogimgs/javanio-blocking-2.png" alt="é˜»å¡I/O" title="é˜»å¡I/O"><br>ï¼ˆ2ï¼‰éé˜»å¡IO:ç”¨æˆ·éœ€è¦ä¸æ–­ä¸»åŠ¨è¯¢é—®kernelæ•°æ®æ˜¯å¦å‡†å¤‡å¥½äº†ï¼Œå‡†å¤‡å¥½ä¹‹å<em>é€šçŸ¥</em>ç”¨æˆ·å°†æ•°æ®ä»å†…æ ¸ç©ºé—´copyåˆ°ç”¨æˆ·ç©ºé—´(<em>ç”¨æˆ·å¾—åˆ°é€šçŸ¥ä¹‹åï¼Œ<strong>äº²è‡ªå»</strong>å†…æ ¸ç©ºé—´ä¸­å°†æ•°æ®å¤åˆ¶åˆ°ç”¨æˆ·ç©ºé—´</em>)ã€‚<br>è¿™é‡Œçš„éé˜»å¡æ˜¯æŒ‡<em>ç­‰å¾…æ•°æ®å‡†å¤‡å¥½çš„è¿™æ®µæ—¶é—´ä¸ä¼šé˜»å¡</em>ï¼Œéœ€è¦è¯´æ˜çš„æ˜¯ç­‰å¾…å°±ç»ªçš„é˜»å¡æ˜¯ä¸ä½¿ç”¨CPUçš„ï¼Œæ˜¯åœ¨<em>ç©ºç­‰</em>ï¼›<em>è€ŒçœŸæ­£çš„è¯»å†™æ“ä½œçš„é˜»å¡æ˜¯ä½¿ç”¨CPUçš„ï¼ŒçœŸæ­£åœ¨â€å¹²æ´»â€ï¼Œè€Œä¸”è¿™ä¸ªè¿‡ç¨‹éå¸¸å¿«ï¼Œå±äºmemory copy</em>ï¼Œå¸¦å®½é€šå¸¸åœ¨1GB/sçº§åˆ«ä»¥ä¸Šï¼Œå¯ä»¥ç†è§£ä¸ºåŸºæœ¬ä¸è€—æ—¶ã€‚ã€‚<br><img src="/blogimgs/javanio-nonblocking-3.png" alt="éé˜»å¡I/O" title="éé˜»å¡I/O"><br>ï¼ˆ3ï¼‰IOå¤ç”¨:ä¹Ÿå«ä½œevent driven IO<br><img src="/blogimgs/javanio-multiplexing-4.png" alt="I/Oå¤ç”¨" title="I/Oå¤ç”¨"><br>ï¼ˆ4ï¼‰ä¿¡å·é©±åŠ¨IO:å†…æ ¸é€šçŸ¥æˆ‘ä»¬ä½•æ—¶å¯ä»¥å¼€å§‹ä¸€ä¸ªI/Oæ“ä½œ<br>ï¼ˆ5ï¼‰å¼‚æ­¥IO:å†…æ ¸é€šçŸ¥æˆ‘ä»¬I/Oæ“ä½œä½•æ—¶<strong>å·²ç»å®Œæˆ</strong><br><img src="/blogimgs/javanio-asynchronous-5.png" alt="å¼‚æ­¥I/O" title="å¼‚æ­¥I/O"></p><h3 id="ç–‘é—®â€“Java-NIOå¯¹åº”å“ªç§I-Oæ¨¡å‹ï¼Ÿ"><a href="#ç–‘é—®â€“Java-NIOå¯¹åº”å“ªç§I-Oæ¨¡å‹ï¼Ÿ" class="headerlink" title="ç–‘é—®â€“Java NIOå¯¹åº”å“ªç§I/Oæ¨¡å‹ï¼Ÿ"></a>ç–‘é—®â€“Java NIOå¯¹åº”å“ªç§I/Oæ¨¡å‹ï¼Ÿ</h3><blockquote><p>wikiä¸Šè¯´â€Non-blocking I/O (usually called NIO, and sometimes called â€œNew I/Oâ€)â€ï¼Œè€Œåˆæœ‰å¾ˆå¤šblogè¯´NIOå°±æ˜¯IOå¤ç”¨ï¼Œç»å¸¸è¯´NIOçš„<code>select</code>æ˜¯IOå¤ç”¨ï¼Œåœ¨I/Oæ¨¡å‹ä¸­éé˜»å¡IOå’ŒIOå¤ç”¨æ˜¯ä¸¤ç§ä¸åŒçš„æ¨¡å‹ï¼Œ<strong>è¿™ä¸ªæ˜¯æ€ä¹ˆå›äº‹ï¼Ÿï¼Ÿï¼Ÿ</strong>Java NIOä¸Non-blocking I/Oã€I/Oå¤ç”¨çš„å…³ç³»æ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿ<em>æ˜¯ä¸€ç§åŒæ­¥éé˜»å¡çš„I/Oæ¨¡å‹ï¼Œä¹Ÿæ˜¯I/Oå¤šè·¯å¤ç”¨çš„åŸºç¡€</em>ã€‚</p></blockquote><h3 id="NIOçš„ä¼˜åŠ¿"><a href="#NIOçš„ä¼˜åŠ¿" class="headerlink" title="NIOçš„ä¼˜åŠ¿"></a>NIOçš„ä¼˜åŠ¿</h3><p>NIOè¾ƒäºä¼ ç»ŸIOçš„ä¼˜åŠ¿åœ¨äºNIOæ˜¯åŸºäº<em>å—</em>çš„ï¼Œè€Œä¸”æœ‰<em>é€šé“</em>ï¼ˆChannelï¼‰å’Œ<em>ç¼“å†²åŒº</em>ï¼ˆbufferï¼‰çš„æ¦‚å¿µï¼Œæ›´åŠ æ¥è¿‘æ“ä½œç³»ç»Ÿæ‰§è¡ŒIOçš„æ–¹å¼ã€‚</p><p>ä¼˜åŠ¿å¦‚ä¸‹ï¼š</p><ul><li>äº‹ä»¶é©±åŠ¨æ¨¡å‹(Reactorè®¾è®¡æ¨¡å¼â€“Reactoræ˜¯å¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸€ç§åŸºäºäº‹ä»¶é©±åŠ¨çš„è®¾è®¡æ¨¡å¼ã€‚)</li><li>é¿å…å¤šçº¿ç¨‹(Reactoræ¨¡å¼ä¸­_å•çº¿ç¨‹è½®è¯¢_æ¥è¿›è¡Œäº‹ä»¶åˆ†å‘)</li><li>éé˜»å¡I/Oï¼ŒI/Oè¯»å†™ä¸å†é˜»å¡ï¼Œè€Œæ˜¯è¿”å›0</li><li>åŸºäºblockçš„ä¼ è¾“ï¼Œé€šå¸¸æ¯”åŸºäºæµçš„ä¼ è¾“æ›´é«˜æ•ˆ</li><li>æ›´é«˜çº§çš„IOå‡½æ•°ï¼Œzero-copy</li><li>IOå¤šè·¯å¤ç”¨å¤§å¤§æé«˜äº†Javaç½‘ç»œåº”ç”¨çš„å¯ä¼¸ç¼©æ€§å’Œå®ç”¨æ€§</li></ul><h3 id="æ¦‚å¿µ"><a href="#æ¦‚å¿µ" class="headerlink" title="æ¦‚å¿µ"></a>æ¦‚å¿µ</h3><ul><li>ç¼“å†²åŒº</li></ul><p>åœ¨ç¼“å†²åŒºä¸­ï¼Œæœ€é‡è¦çš„å±æ€§æœ‰ä¸‹é¢ä¸‰ä¸ªï¼Œå®ƒä»¬ä¸€èµ·åˆä½œå®Œæˆå¯¹ç¼“å†²åŒºå†…éƒ¨çŠ¶æ€çš„å˜åŒ–è·Ÿè¸ªï¼š<br>positionï¼šæŒ‡å®šäº†ä¸‹ä¸€ä¸ªå°†è¦è¢«å†™å…¥æˆ–è€…è¯»å–çš„å…ƒç´ ç´¢å¼•ï¼Œå®ƒçš„å€¼ç”±get()/put()æ–¹æ³•è‡ªåŠ¨æ›´æ–°ï¼Œåœ¨æ–°åˆ›å»ºä¸€ä¸ªBufferå¯¹è±¡æ—¶ï¼Œpositionè¢«åˆå§‹åŒ–ä¸º0ã€‚<br>limitï¼š<strong>æŒ‡å®šå½“å‰bufferä¸­è¯»å–æ•°æ®æ—¶çš„æœ«å°¾index</strong> ä¾‹å¦‚å½“å‰bufferçš„capacityæ˜¯10ï¼Œä½†åªå†™å…¥å†…å®¹åªå åˆ°4ï¼Œåˆ™æ­¤æ—¶è¯»å–bufferæ—¶ï¼Œlimitä¸º4ï¼Œè¯»å–çš„å†…å®¹åˆ°limitä¸ºæ­¢ï¼Œä¹Ÿå¯ä»¥è¯´limitè®°å½•äº†å½“å‰bufferå·²ç”¨çš„å®¹é‡ã€‚ä¹Ÿå°±æ˜¯è¯´æŒ‡å®šå½“å‰bufferæœ‰å¤šå°‘æ•°æ®éœ€è¦å–å‡º(åœ¨ä»ç¼“å†²åŒºå†™å…¥é€šé“æ—¶)ï¼Œæˆ–è€…æœ‰å¤šå°‘ç©ºé—´å¯ä»¥æ”¾å…¥æ•°æ®(åœ¨ä»é€šé“è¯»å…¥ç¼“å†²åŒºæ—¶)ã€‚<br>capacityï¼šæŒ‡å®šäº†å¯ä»¥å­˜å‚¨åœ¨ç¼“å†²åŒºä¸­çš„æœ€å¤§æ•°æ®å®¹é‡ï¼Œå®é™…ä¸Šï¼Œå®ƒæŒ‡å®šäº†åº•å±‚æ•°ç»„çš„å¤§å°ï¼Œæˆ–è€…è‡³å°‘æ˜¯æŒ‡å®šäº†å‡†è®¸æˆ‘ä»¬ä½¿ç”¨çš„åº•å±‚æ•°ç»„çš„å®¹é‡ã€‚</p><blockquote><p>è¯»å–bufferä¸­çš„æ•°æ®æ—¶ï¼Œè°ƒç”¨<code>flip()</code>,æ­¤æ–¹æ³•å°†ä¼šå®Œæˆä¸¤ä»¶äº‹æƒ…ï¼š<br>1ã€æŠŠlimitè®¾ç½®ä¸ºå½“å‰çš„positionå€¼<br>2ã€æŠŠpositionè®¾ç½®ä¸º0</p></blockquote><p>ä»¥ä¸Šä¸‰ä¸ªå±æ€§å€¼ä¹‹é—´ç›¸å¯¹å¤§å°çš„å…³ç³»ï¼š0 &lt;= position &lt;= limit &lt;= capacityã€‚å¦‚æœæˆ‘ä»¬åˆ›å»ºä¸€ä¸ªæ–°çš„å®¹é‡å¤§å°ä¸º10çš„ByteBufferå¯¹è±¡ï¼Œåœ¨åˆå§‹åŒ–çš„æ—¶å€™ï¼ˆè°ƒç”¨<code>clear()</code>æ–¹æ³•å°†bufferé‡ç½®ä¸ºåˆå§‹åŒ–ï¼‰ï¼Œpositionè®¾ç½®ä¸º0ï¼Œlimitå’Œ capacityè¢«è®¾ç½®ä¸º10ï¼Œåœ¨ä»¥åä½¿ç”¨ByteBufferå¯¹è±¡è¿‡ç¨‹ä¸­ï¼Œcapacityçš„å€¼ä¸ä¼šå†å‘ç”Ÿå˜åŒ–ï¼Œè€Œå…¶å®ƒä¸¤ä¸ªä¸ªå°†ä¼šéšç€ä½¿ç”¨è€Œå˜åŒ–ã€‚</p><ul><li>é€šé“</li></ul><p>é€šé“ä¸»è¦ç”¨æ¥ä¼ è¾“æ•°æ®ï¼Œä¸ç¼“å†²åŒºè¿›è¡Œäº¤äº’ï¼Œä¸Selectorå…³è”èµ·æ¥ä½¿ç”¨çš„ï¼Œå®é™…ä¸Šæ˜¯é€šè¿‡SelectableChannelä¸­çš„<code>register()</code>æ–¹æ³•è¿›è¡Œæ³¨å†Œçš„<strong>ï¼ˆå¦‚æœåœ¨é˜»å¡æ¨¡å¼ä¸‹æ³¨å†Œä¸€ä¸ªé€šé“ï¼Œç³»ç»Ÿä¼šæŠ›å‡ºIllegalBlockingModeExceptionå¼‚å¸¸ã€‚ ï¼‰</strong>ã€‚<code>register()</code>æ–¹æ³•è¿”å›ä¸€ä¸ª<code>SelectionKey</code>ï¼Œ<code>SelectionKey</code>æ˜¯Channelå’ŒSelectorä¹‹é—´çš„å…³è”å¯¹è±¡ï¼Œè¯¥å¯¹è±¡å¯ä»¥é€šè¿‡<code>channel()</code>å’Œ<code>selector()</code>æ–¹æ³•å¾—åˆ°è¯¥SelectionKeyå…³è”çš„channelå’Œselectorã€‚SelectionKeyç»´æŠ¤ç€ä¸¤ä¸ªSeté›†åˆï¼Œä¸€ä¸ªæ˜¯æ„Ÿå…´è¶£çš„äº‹ä»¶é›†åˆ<code>interestOps()</code>ï¼Œå¦ä¸€ä¸ªæ˜¯å‡†å¤‡å¥½äº†çš„ï¼Œå¯ä»¥è¿›è¡ŒIOæ“ä½œçš„é›†åˆ<code>readyOps()</code>ã€‚SelectionKeyç±»ä¸­å®šä¹‰äº†4ç§å¯é€‰æ‹©æ“ä½œï¼šreadã€writeã€ connectå’Œacceptï¼Œæ¯ä¸ªå…·ä½“é€šé“æœ‰ä¸åŒçš„æœ‰æ•ˆçš„å¯é€‰æ‹©æ“ä½œé›† åˆï¼Œæ¯”å¦‚ServerSocketChannelçš„æœ‰æ•ˆæ“ä½œé›†åˆæ˜¯acceptï¼Œè€ŒSocketChannelçš„æœ‰æ•ˆæ“ä½œé›†åˆæ˜¯readã€writeå’Œ connectã€‚ </p><ul><li>é€‰æ‹©å™¨</li></ul><p>é€‰æ‹©å™¨å¯è°“NIOä¸­çš„é‡å¤´æˆï¼ŒI/Oå¤ç”¨çš„æ ¸å¿ƒï¼Œå…¶ä¸­ç»´æŠ¤ç€ä¸¤ä¸ªé”®çš„é›†åˆï¼š<em>å·²æ³¨å†Œçš„é”®çš„é›†åˆ</em><code>keys()</code>å’Œ<em>å·²é€‰æ‹©çš„é”®çš„é›†åˆ</em><code>selectedKeys()</code>ï¼Œå·²é€‰æ‹©çš„é”®çš„é›†åˆæ˜¯å·²æ³¨å†Œçš„é”®çš„é›†åˆçš„å­é›†ã€‚é™¤æ­¤ä¹‹å¤–ï¼Œå…¶å®é€‰æ‹©å™¨å†…éƒ¨è¿˜ç»´æŠ¤ç€ä¸€ä¸ªå·²å–æ¶ˆçš„é”®çš„é›†åˆï¼Œè¿™ä¸ªé›†åˆåŒ…å«äº†cancel()æ–¹æ³•è¢«è°ƒç”¨è¿‡çš„é”®ã€‚ </p><p>å½“Selectorå’Œç‰¹å®šçš„SelectableChannelå…³è”å¥½åå°±å¼€å§‹å·¥ä½œäº†ï¼Œå·¥ä½œæ—¶åªéœ€è¦è°ƒç”¨<code>select()</code>æ–¹æ³•ã€‚<code>select()</code> æ˜¯<em>é˜»å¡</em>è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°æœ‰æŸä¸ªChannelçš„æŸä¸ªæ„Ÿå…´è¶£çš„Opå‡†å¤‡å¥½äº†ã€‚<code>select()</code>åªè¿”å›æœ¬æ¬¡æ‰§è¡Œ<code>select()</code>æ—¶ä»_æœªå‡†å¤‡å¥½åˆ°å‡†å¤‡å¥½çŠ¶æ€çš„channelæ•°ï¼ˆåœ¨æ‰§è¡Œ<code>select()</code>ä¹‹å‰å·²ç»å‡†å¤‡å¥½çš„channelä¸è¿›è¡Œè®¡æ•°ï¼‰_ï¼Œå¦‚æœä¸ä¸º0ï¼Œå°†è°ƒç”¨<code>selectedKeys()</code>æ–¹æ³•å¾—åˆ°ä¸€ä¸ªå·²é€‰æ‹©çš„é”®çš„é›†åˆsetã€‚</p><h3 id="ä»£ç "><a href="#ä»£ç " class="headerlink" title="ä»£ç "></a>ä»£ç </h3><p>ä¸‹é¢æ˜¯ä¸€ä¸ªæœåŠ¡å™¨ç«¯ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> port = <span class="number">30</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ServerSocketChannelæ²¡æœ‰bind()æ–¹æ³•ï¼Œ</span></span><br><span class="line"><span class="comment">//å› æ­¤éœ€è¦å–å‡ºå¯¹ç­‰çš„Socketå¯¹è±¡å¹¶ä½¿ç”¨å®ƒæ¥ç»‘å®šåˆ°æŸä¸€ç«¯å£ä»¥å¼€å§‹ç›‘å¬è¿æ¥ã€‚</span></span><br><span class="line">ServerSocketChannel serverChannel = ServerSocketChannel.open( );</span><br><span class="line">ServerSocket serverSocket = serverChannel.socket( );</span><br><span class="line">serverSocket.bind (<span class="keyword">new</span> InetSocketAddress (port));</span><br><span class="line"></span><br><span class="line"><span class="comment">//é€šå¸¸Selectoræ˜¯ç”±é™æ€å·¥å‚æ–¹æ³•open()å®ä¾‹åŒ–çš„</span></span><br><span class="line">Selector selector = Selector.open( );</span><br><span class="line"></span><br><span class="line"><span class="comment">//å¦‚æœåœ¨é˜»å¡æ¨¡å¼ä¸‹æ³¨å†Œä¸€ä¸ªé€šé“ï¼Œç³»ç»Ÿä¼šæŠ›å‡ºIllegalBlockingModeExceptionå¼‚å¸¸ã€‚ </span></span><br><span class="line">serverChannel.configureBlocking (<span class="keyword">false</span>);</span><br><span class="line">serverChannel.register (selector, SelectionKey.OP_ACCEPT);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Dispatch Loop</span></span><br><span class="line"><span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">//select() é˜»å¡è°ƒç”¨çº¿ç¨‹ï¼Œç›´åˆ°æœ‰æŸä¸ªChannelçš„æŸä¸ªæ„Ÿå…´è¶£çš„Opå‡†å¤‡å¥½äº†</span></span><br><span class="line"><span class="comment">//è¿”å›æœ¬æ¬¡æ‰§è¡Œselectæ—¶ä»æœªå‡†å¤‡å¥½åˆ°å‡†å¤‡å¥½çŠ¶æ€çš„channelæ•°ï¼Œ</span></span><br><span class="line"><span class="comment">//ä¸ä¸º0ï¼Œåˆ™è°ƒç”¨selector.selectedKeys()</span></span><br><span class="line">    <span class="keyword">int</span> n = selector.select( );</span><br><span class="line">    <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">continue</span>; <span class="comment">// nothing to do</span></span><br><span class="line">    &#125;</span><br><span class="line">    Iterator it = selector.selectedKeys().iterator( );</span><br><span class="line">    <span class="keyword">while</span> (it.hasNext( )) &#123;</span><br><span class="line">    <span class="comment">//å¾—åˆ°SelectionKey</span></span><br><span class="line">        SelectionKey key = (SelectionKey) it.next( );</span><br><span class="line">        <span class="keyword">if</span> (key.isAcceptable( )) &#123;</span><br><span class="line">        <span class="comment">//é€šè¿‡SelectionKeyçš„channel()å¾—åˆ°è¯¥æ„Ÿå…´è¶£äº‹ä»¶çš„channel</span></span><br><span class="line">            ServerSocketChannel server = </span><br><span class="line">            (ServerSocketChannel) key.channel( );</span><br><span class="line">            <span class="comment">//åœ¨éé˜»å¡æ¨¡å¼ä¸‹ï¼Œå½“æ²¡æœ‰ä¼ å…¥è¿æ¥åœ¨ç­‰å¾…æ—¶ï¼Œ</span></span><br><span class="line">            <span class="comment">//å…¶accept()æ–¹æ³•ä¼šç«‹å³è¿”å›nullã€‚</span></span><br><span class="line">            SocketChannel channel = server.accept( );</span><br><span class="line">            <span class="keyword">if</span> (channel == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="comment">//handle code, could happen</span></span><br><span class="line">            &#125;</span><br><span class="line">            channel.configureBlocking (<span class="keyword">false</span>);</span><br><span class="line">            channel.register (selector, SelectionKey.OP_READ);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (key.isReadable( )) &#123;</span><br><span class="line">            readDataFromSocket (key);  </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//è¿™è¡Œä»£ç æ˜¯å¿…è¦çš„,å°†è¯¥keyæ”¾å…¥cancelé›†åˆä¸­ï¼Œåœ¨ä¸‹æ¬¡select()æ—¶åˆ é™¤</span></span><br><span class="line">        it.remove( );</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h3><p><a href="https://yq.aliyun.com/articles/2371">https://yq.aliyun.com/articles/2371</a><br><a href="http://www.molotang.com/articles/906.html">http://www.molotang.com/articles/906.html</a><br><a href="http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf">http://gee.cs.oswego.edu/dl/cpjslides/nio.pdf</a></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> NIO </tag>
            
            <tag> IO </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSæ¢å¤è¿‡ç¨‹1</title>
      <link href="/%5B%E8%AF%91%5DHDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B1.html"/>
      <url>/%5B%E8%AF%91%5DHDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B1.html</url>
      
        <content type="html"><![CDATA[<p>è¿è¡Œæˆ–è€…ç§»åŠ¨ç”Ÿäº§ç¯å¢ƒä¸­çš„Hadoopæ—¶ï¼Œå¯¹å¾ˆå¥½çš„æŒæ¡HDFSçš„æ¢å¤è¿‡ç¨‹æ˜¯éå¸¸é‡è¦çš„ã€‚<br>HDFSä¸­ä¸€ä¸ªé‡è¦çš„è®¾è®¡éœ€æ±‚å°±æ˜¯è¦ä¿è¯åœ¨ç”Ÿäº§éƒ¨ç½²ä¸­æŒç»­æ­£ç¡®çš„æ“ä½œã€‚<em>å°¤å…¶å¤æ‚çš„æ˜¯åœ¨ç½‘ç»œå’ŒèŠ‚ç‚¹æ•…éšœçš„æƒ…å†µä¸‹ä¿è¯å†™å…¥HDFSçš„æ­£ç¡®æ€§ï¼Œç§Ÿçº¦æ¢å¤ã€blockæ¢å¤å’Œpipelineæ¢å¤ä¿è¯äº†å†™çš„æ­£ç¡®æ€§ã€‚</em>ç†è§£è¿™äº›æ¢å¤æ“ä½œä½•æ—¶ä½•åœ°è¢«è°ƒç”¨ï¼Œä»¥åŠåšäº†ä»€ä¹ˆï¼Œèƒ½å¸®åŠ©ç”¨æˆ·æˆ–è€…å¼€å‘è€…ç†è§£HDFSé›†ç¾¤çš„åŸç†ã€‚</p><p>åœ¨è¿™ç¯‡åšå®¢ä¸­ï¼Œä½ ä¼šå¯¹é‚£äº›æ¢å¤æµç¨‹æœ‰ä¸ªæ›´æ·±å…¥çš„ç†è§£ã€‚é¦–å…ˆç®€å•ä»‹ç»ä¸‹HDFS write pipelineå’Œæ¢å¤æµç¨‹ï¼Œå¯¹block/replicaçš„çŠ¶æ€å’Œgeneration stampsçš„æ¦‚å¿µè¿›è¡Œè§£é‡Šï¼Œç„¶åé€æ­¥ä»‹ç»ç§Ÿçº¦æ¢å¤å’Œblockæ¢å¤ã€‚</p><p>è¿™ç³»åˆ—æ–‡ç« è¢«åˆ†ä¸ºä¸¤ç¯‡ï¼šç¬¬ä¸€ç¯‡ä»‹ç»ç§Ÿçº¦æ¢å¤å’Œblockæ¢å¤çš„ç»†èŠ‚ï¼Œç¬¬äºŒç¯‡ä¸»è¦ä»‹ç»pipelineæ¢å¤ã€‚æƒ³äº†è§£æ›´å¤šçš„å†…å®¹ï¼Œè¯·å‚è€ƒè®¾è®¡æ–‡æ¡£ï¼š<a href="https://issues.apache.org/jira/secure/attachment/12445209/appendDesign3.pdf">Append, Hflush, and Read for implementation details</a></p><span id="more"></span><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>HDFSä¸­ï¼Œæ–‡ä»¶è¢«åˆ†ä¸ºå—å­˜å‚¨ã€‚HDFSä¸­çš„æ–‡ä»¶å¯ä»¥è¢«å¤šclientåŒæ—¶è¯»ï¼Œä½†åªèƒ½è¢«ä¸€ä¸ªclientå†™å…¥ã€‚blockçš„å¤šå‰¯æœ¬å­˜å‚¨åœ¨ä¸åŒçš„dnä¸Šä¿è¯äº†HDFSçš„å®¹é”™éœ€æ±‚ã€‚å…¶ä¸­å‰¯æœ¬çš„ä¸ªæ•°è¢«ç§°ä¸ºå‰¯æœ¬å› å­ã€‚å½“ä¸€ä¸ªæ–°æ–‡ä»¶çš„blockè¢«åˆ›å»ºï¼Œæˆ–è€…æ‰“å¼€ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶(å› ä¸ºå†™æˆ–è€…è¿½åŠ )ï¼ŒHDFSå†™æ“ä½œä¼šåˆ›å»ºä¸€ä¸ªç”±dnsç»„æˆçš„pipelineæ¥æ¥æ”¶å¹¶å­˜å‚¨å‰¯æœ¬(å‰¯æœ¬å› å­å†³å®šäº†åœ¨pipelineä¸­dnsçš„ä¸ªæ•°)ã€‚ä¸‹å›¾æ˜¯blockå†™å…¥pipelineçš„æµç¨‹ï¼š<br><img src="/blogimgs/HDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B/block2pipeline.png" alt="blockå†™å…¥pipeline" title="blockå†™å…¥pipeline"><br>clientè¯»æ–‡ä»¶æ—¶ä»å­˜æ”¾æ–‡ä»¶blockçš„dnsä¸­é€‰æ‹©ä¸€ä¸ªdnï¼Œå¹¶è¯·æ±‚ä»dnä¸Šè¿›è¡Œæ•°æ®ä¼ è¾“ã€‚</p><p>ä¸‹é¢ä¸¤ä¸ªåº”ç”¨åœºæ™¯çªæ˜¾äº†å®¹é”™çš„é‡è¦æ€§ï¼š</p><ul><li>HBaseçš„Region Server(RS)å†™æ—¶ä¼šå…ˆå†™å…¥WALï¼ŒWALæ˜¯ä¸€ä¸ªHDFSæ–‡ä»¶ï¼Œèƒ½å¤Ÿé˜²æ­¢æ•°æ®ä¸¢å¤±ã€‚å¦‚æœä¸€ä¸ªRSå®•æœºï¼Œä¸€ä¸ªæ–°çš„RSä¼šå¯åŠ¨å¹¶é€šè¿‡è¯»å–WALæ–‡ä»¶å»é‡æ„å…ˆå‰RSçš„çŠ¶æ€ã€‚å¦‚æœåœ¨RSå®•æœºçš„æ—¶å€™ï¼Œå†™å…¥pipelineæ²¡æœ‰å®Œæˆï¼Œåœ¨pipelineä¸­çš„dnsä¸Šçš„æ•°æ®å¯èƒ½å¹¶æ²¡æœ‰åŒæ­¥ã€‚ä¸ºäº†é‡æ„RSæ­£ç¡®çš„çŠ¶æ€ï¼ŒHDFSå¿…é¡»ä¿è¯ä»WALä¸­è¯»å–æ•°æ®çš„æ­£ç¡®æ€§ã€‚</li><li>Flumeå®¢æˆ·ç«¯éœ€è¦å®æ—¶çš„å°†æ•°æ®å†™å…¥HDFSä¸­ï¼Œç”šè‡³åœ¨pipelineä¸­å­˜åœ¨ä¸€äº›dnå¤±è´¥æˆ–è€…åœæ­¢å“åº”çš„æƒ…å†µä¸‹ï¼Œä¹Ÿå¿…é¡»ä¿è¯èƒ½å¤ŸæŒç»­çš„å†™ã€‚</li></ul><h2 id="ç§Ÿçº¦æ¢å¤ã€blockæ¢å¤å’Œpipelineæ¢å¤å‘ç”Ÿåœ¨ä»¥ä¸‹çš„æƒ…å†µä¸‹ï¼š"><a href="#ç§Ÿçº¦æ¢å¤ã€blockæ¢å¤å’Œpipelineæ¢å¤å‘ç”Ÿåœ¨ä»¥ä¸‹çš„æƒ…å†µä¸‹ï¼š" class="headerlink" title="ç§Ÿçº¦æ¢å¤ã€blockæ¢å¤å’Œpipelineæ¢å¤å‘ç”Ÿåœ¨ä»¥ä¸‹çš„æƒ…å†µä¸‹ï¼š"></a>ç§Ÿçº¦æ¢å¤ã€blockæ¢å¤å’Œpipelineæ¢å¤å‘ç”Ÿåœ¨ä»¥ä¸‹çš„æƒ…å†µä¸‹ï¼š</h2><ul><li>åœ¨clientå¯ä»¥å¾€HDFSä¸Šå†™æ–‡ä»¶ä¹‹å‰ï¼Œå¿…é¡»ä»nnä¸Šå¾—åˆ°ä¸€ä¸ªç§Ÿçº¦(Lease)ï¼Œè¿™ä¸ªç§Ÿçº¦ä¹Ÿå°±ç›¸å½“äºä¸€ä¸ªå†™é”ã€‚ç§Ÿçº¦ä¿è¯äº†åªæœ‰ä¸€ä¸ªclientå†™çš„è¯­ä¹‰ã€‚å¦‚æœå½“å‰clientæƒ³è¦ç»´æŒå†™æ“ä½œï¼Œç§Ÿçº¦å¿…é¡»åœ¨é¢„å®šä¹‰çš„æ—¶é—´å‘¨æœŸå†…æ›´æ–°ç§Ÿçº¦ã€‚å¦‚æœä¸€ä¸ªç§Ÿçº¦æ²¡æœ‰è¢«æ›´æ–°æˆ–è€…æŒæœ‰è¯¥ç§Ÿçº¦çš„clientæ­»äº†ï¼Œåˆ™ç§Ÿçº¦ä¼šè¿‡æœŸã€‚å½“ç§Ÿçº¦è¿‡æœŸä¹‹åï¼ŒHDFSä¼šå…³é—­ç§Ÿçº¦å¯¹åº”çš„æ–‡ä»¶å¹¶ä¸”ä¼šé‡Šæ”¾ä»£è¡¨è¿™ä¸ªclientçš„ç§Ÿçº¦ï¼Œç„¶åå…¶å®ƒclientså°±èƒ½å¤Ÿå†™è¿™ä¸ªæ–‡ä»¶äº†ã€‚_è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºç§Ÿçº¦å›æ”¶_ã€‚</li><li>å½“ç§Ÿçº¦æ¢å¤å‘ç”Ÿçš„æ—¶å€™ï¼Œå¦‚æœä¸€ä¸ªæ–‡ä»¶æ­£åœ¨å†™å…¥çš„æœ€åä¸€ä¸ªblockæ²¡æœ‰ä¼ æ’­åˆ°åœ¨pipelineä¸­çš„æ‰€æœ‰dnï¼Œå†™å…¥åˆ°ä¸åŒdnä¸Šçš„æ•°æ®å¯èƒ½ä¸åŒã€‚åœ¨ç§Ÿçº¦æ¢å¤å¯¼è‡´è¿™ä¸ªæ–‡ä»¶è¢«å…³é—­ä¹‹å‰ï¼Œæœ‰å¿…è¦ä¿è¯æœ€åä¸€ä¸ªblockçš„æ‰€æœ‰replicasç›¸åŒï¼Œ_è¿™ä¸ªè¿‡ç¨‹è¢«ç§°ä¸ºblockæ¢å¤_ã€‚_blockæ¢å¤åªæœ‰åœ¨ç§Ÿçº¦æ¢å¤æ—¶è¢«è§¦å‘_ï¼Œå¹¶ä¸”ç§Ÿçº¦æ¢å¤åªä¼šè§¦å‘ä¸€ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªblock(<em>å¦‚æœè¯¥blockä¸æ˜¯COMPLETEçŠ¶æ€</em>)è¿›è¡Œblockæ¢å¤ã€‚</li><li>åœ¨å†™pipelineæ“ä½œä¸­ï¼Œæœ‰äº›dnå¯èƒ½ä¼šå¤±è´¥ã€‚å¦‚æœå‘ç”Ÿå¤±è´¥ï¼Œåº•å±‚çš„å†™æ“ä½œä¸èƒ½è¢«ç®€å•ç²—æš´çš„å¤±è´¥ã€‚HDFSä¼šå°è¯•æ¢å¤è¿™äº›errorï¼Œå…è®¸clientèƒ½å¤Ÿç»§ç»­å†™å…¥pipelineä¸­ã€‚ä»pipelineä¸­æ¢å¤errorçš„æµç¨‹è¢«ç§°ä¸ºpipelineæ¢å¤ã€‚</li></ul><p>ä¸‹é¢çš„ç« èŠ‚å°†å¯¹è¿™äº›è¿‡ç¨‹è¿›è¡Œæ›´åŠ æ·±å…¥çš„ä»‹ç»ã€‚</p><h2 id="Blocksã€Replicaså’Œä»–ä»¬çš„çŠ¶æ€"><a href="#Blocksã€Replicaså’Œä»–ä»¬çš„çŠ¶æ€" class="headerlink" title="Blocksã€Replicaså’Œä»–ä»¬çš„çŠ¶æ€"></a>Blocksã€Replicaså’Œä»–ä»¬çš„çŠ¶æ€</h2><p>ä¸ºäº†åŒºåˆ†Namenodeä¸­çš„blockså’ŒDataNodeä¸­çš„blocksï¼Œå°†NameNodeä¸­çš„blocksç§°ä¸ºblocksï¼Œå°†DataNodeä¸­çš„blocksç§°ä¸ºreplicasã€‚</p><p>DataNodeä¸­çš„replicaæœ‰å¦‚ä¸‹çŠ¶æ€(å®šä¹‰åœ¨org.apache.hadoop.hdfs.server.common.HdfsServerConstants.javaä¸­)ï¼š</p><ul><li>FINALIZED: å½“replicaæ˜¯è¿™ä¸ªçŠ¶æ€æ—¶ï¼Œè¯¥replicaçš„å†™å…¥æ“ä½œå·²ç»å®Œæˆï¼Œæ•°æ®çš„å¤§å°ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œé™¤éå¯¹è¯¥replicaè¿›è¡Œappendæ“ä½œã€‚æœ‰ä¸€æ ·generation stamp(GS)çš„blockçš„æ‰€æœ‰replicaæ˜¯ç›¸åŒçš„ã€‚finalized replicaçš„GSå¯èƒ½ä¼šåœ¨blockæ¢å¤ä¸­é€’å¢ã€‚</li><li>RBW(Replica Being Written): ä¸ç®¡æ˜¯æ–°å»ºä¸€ä¸ªæ–‡ä»¶è¿˜æ˜¯é‡æ–°æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶è¿›è¡Œè¿½åŠ ï¼Œæ­¤æ—¶ä»»ä½•ä¸€ä¸ªæ­£åœ¨è¢«å†™å…¥çš„replicaéƒ½RBWçŠ¶æ€ã€‚RBWçŠ¶æ€çš„replicaæ€»æ˜¯æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockã€‚æ•°æ®ä¾ç„¶æ­£åœ¨å†™å…¥è¯¥replicaï¼Œreplicaå¹¶æ²¡æœ‰finalizedã€‚_RBW replicaä¸­çš„æ•°æ®(ä¸ä¸€å®šæ˜¯æ‰€æœ‰çš„æ•°æ®)æ˜¯å¯è¯»çš„_ã€‚å¦‚æœæœ‰ä»»ä½•æ•…éšœå‘ç”Ÿï¼ŒRBWçŠ¶æ€çš„replicaä¼šå°è¯•ä¿å­˜æ•°æ®ã€‚</li><li>RWR(Replica Waiting to be Recovered): å¦‚æœdnå®•æœºæˆ–è€…é‡å¯äº†ï¼Œå…¶ä¸Šçš„æ‰€æœ‰RBWçŠ¶æ€çš„replicaså°†ä¼šå°†çŠ¶æ€è½¬æ¢ä¸ºRWRã€‚RWRçŠ¶æ€ä¸‹çš„replicaå°†ä¼šå˜æˆè¿‡æœŸçš„ï¼Œç„¶åè¢«ä¸¢å¼ƒï¼›æˆ–è€…å‚ä¸ç§Ÿçº¦æ¢å¤ä¸­ã€‚</li><li>RUR(Replica Under Recovery): åœ¨ç§Ÿçº¦æ¢å¤çš„è¿‡ç¨‹ä¸­ï¼Œä»»ä½•ä¸€ä¸ªéTEMPORARYçŠ¶æ€çš„replicaéƒ½æœ‰å¯èƒ½è½¬æ¢ä¸ºRURçŠ¶æ€ã€‚</li><li>TEMPORARY: åœ¨blockå¤åˆ¶(ç”±replication monitoræˆ–è€…balancerå¼•èµ·çš„blockå¤åˆ¶æ“ä½œ)ä¸­ä¼šå‡ºç°temporaryçŠ¶æ€çš„replicaã€‚æ­¤çŠ¶æ€ä¸‹çš„replicaä¸RBWçŠ¶æ€ç±»ä¼¼ï¼Œåªæ˜¯è¯¥çŠ¶æ€ä¸‹çš„æ•°æ®æ˜¯ä¸å¯è§çš„ã€‚å¦‚æœblockå¤åˆ¶å¤±è´¥ï¼ŒTEMPORARYçŠ¶æ€ä¸‹çš„replicaä¼šè¢«åˆ é™¤ã€‚</li></ul><p>blockåœ¨NameNodeä¸­çš„çŠ¶æ€(å®šä¹‰åœ¨org.apache.hadoop.hdfs.server.common.HdfsServerConstants.java)å¦‚ä¸‹ï¼š</p><ul><li>UNDER_CONSTRUCTION: blockæ­£åœ¨å†™å…¥æ—¶å¤„äºæ­¤çŠ¶æ€ã€‚åœ¨UNDER_CONSTRUCTIONä¸‹çš„blockæ˜¯è¢«æ‰“å¼€æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockï¼Œè¯¥blockçš„é•¿åº¦å’Œgeneration stampéƒ½æ˜¯å¯å˜çš„ï¼Œå¹¶ä¸”_å®ƒçš„æ•°æ®(ä¸ä¸€å®šæ˜¯æ‰€æœ‰çš„æ•°æ®)æ˜¯å¯è§çš„_ã€‚nnä¿æŒå†™pipelineçš„è·Ÿè¸ª(æœ‰æ•ˆRBW replicasçš„ä½ç½®)ï¼Œå’Œå¯¹RWR replicasçš„å®šä½</li><li>UNDER_RECOVERY: å¦‚æœä¸€ä¸ªæ–‡ä»¶çš„ç§Ÿçº¦è¶…æœŸæ—¶ï¼Œè¯¥æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockæ˜¯UNDER_CONSTRUCTIONï¼Œåœ¨blockæ¢å¤å¼€å§‹æ—¶ï¼Œè¯¥blockä¼šå˜ä¸ºUNDER_RECOVERYã€‚</li><li>COMMITTED: COMMITTEDæ„å‘³ç€ä¸€ä¸ªblockçš„æ•°æ®å’Œgeneration stampä¸ä¼šå‘ç”Ÿå˜åŒ–(é™¤éå†æ¬¡æ‰“å¼€è¿›è¡Œè¿½åŠ )ï¼Œå¹¶ä¸”æ¯”ä¸ŠæŠ¥FINALIZEDçŠ¶æ€ã€æœ‰ç€ç›¸åŒGS/lengthçš„replicasçš„æœ€å°å‰¯æœ¬æ•°å°‘(<em>å…·ä½“ä¸å¤ªæ˜ç™½ï¼Œå¯èƒ½ç¿»è¯‘çš„æœ‰é—®é¢˜ï¼Œé™„ä¸ŠåŸæ–‡â€“and there are fewer than the minimal-replication number of DataNodes that have reported FINALIZED replicas of same GS/length</em>)ã€‚ä¸ºäº†æä¾›è¯»æœåŠ¡ï¼ŒCOMMITTEDçŠ¶æ€çš„blockå¿…é¡»ä¿æŒå¯¹RBW replicasä½ç½®çš„è·Ÿè¸ªå’ŒFINALIZED replicasçš„GSã€lengthçš„è·Ÿè¸ªã€‚å½“clientè¯·æ±‚nnå¢åŠ ä¸€ä¸ªblockæˆ–è€…å…³é—­æ–‡ä»¶æ—¶ï¼Œå¤„äºUNDER_CONSTRUCTIONçŠ¶æ€çš„blockå°†å˜ä¸ºCOMMITTEDçŠ¶æ€ã€‚å¦‚æœä¸€ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªblockæˆ–è€…å€’æ•°ç¬¬äºŒä¸ªblockæ˜¯COMMITTEDçŠ¶æ€ï¼Œåˆ™è¯¥æ–‡ä»¶ä¸èƒ½è¢«å…³é—­ï¼Œclientå¿…é¡»è¿›è¡Œé‡è¯•ã€‚</li><li>COMPLETE: å½“å‘ç°äº†æœ‰ç€ç›¸åŒGS/lengthçš„FINALIZEDçŠ¶æ€ä¸‹çš„replicasæ»¡è¶³æœ€å°å‰¯æœ¬æ•°ï¼Œåˆ™è¯¥blockç”±COMMITTEDè½¬ä¸ºCOMPLETEçŠ¶æ€ã€‚åªæœ‰å½“æ‰€æœ‰çš„blockéƒ½å˜æˆCOMPLETEæ—¶ï¼Œè¯¥æ–‡ä»¶æ‰èƒ½è¢«å…³é—­ã€‚å³ä½¿ä¸€ä¸ªblockä¸æ»¡è¶³æœ€å°å‰¯æœ¬æ•°ï¼Œä¹Ÿå¯èƒ½è¢«å¼ºåˆ¶å˜ä¸ºCOMPLETEï¼Œä¾‹å¦‚å½“å…ˆå‰çš„blockè¿˜æ²¡æœ‰åˆ°COMPLETEçŠ¶æ€ï¼Œclientè¯·æ±‚ä¸€ä¸ªæ–°blockï¼Œæ­¤æ—¶ä¼šå°†å…ˆå‰çš„blockå¼ºåˆ¶å˜ä¸ºCOMPLETEçŠ¶æ€ã€‚</li></ul><p>DataNodeså°†replicaçš„çŠ¶æ€æŒä¹…åŒ–åˆ°ç£ç›˜ï¼Œä½†æ˜¯NameNodeå¹¶ä¸ä¼šè®²blockçš„çŠ¶æ€æŒä¹…åŒ–åˆ°ç£ç›˜ã€‚å½“NameNodeé‡å¯æ—¶ï¼Œnnä¼šå°†å…ˆå‰æ‰“å¼€æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockçš„çŠ¶æ€å˜ä¸ºUNDER_CONSTRUCTIONï¼Œå°†å…¶ä½™blockçš„çŠ¶æ€å˜ä¸ºCOMPLETEã€‚</p><p>replicaå’Œblockçš„çŠ¶æ€è½¬æ¢å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/HDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B/replica-state.png" alt="replica-state" title="replica-state"><br><img src="/blogimgs/HDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B/block-state.png" alt="block-state" title="block-state"></p><h2 id="Generation-Stamp"><a href="#Generation-Stamp" class="headerlink" title="Generation Stamp"></a>Generation Stamp</h2><p>å¯¹äºæ¯ä¸€ä¸ªblockæ¥è¯´ï¼ŒGSæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„8-byteæ•°å­—ï¼Œç”±NameNodeè¿›è¡Œç»´æŠ¤ã€‚blockå’Œreplicaçš„GSå¤„äºä¸‹é¢çš„ç›®çš„è¢«å¼•å…¥ï¼š</p><ul><li>æ£€æµ‹ä¸€ä¸ªblockçš„é™ˆæ—§çš„replica: ä¹Ÿå°±æ˜¯è¯´ï¼Œè¿™ä¸ªreplicaçš„GSå°äºè¿™ä¸ªblockçš„GSã€‚è¿™æ˜¯å¯èƒ½å‘ç”Ÿçš„ï¼Œä¾‹å¦‚ä¸€ä¸ªè¿½åŠ æ“ä½œï¼Œä¸çŸ¥ä»€ä¹ˆåŸå› è·³è¿‡äº†æ­¤replicaï¼Œæ²¡æœ‰æ›´æ–°æ­¤replicaï¼Œä½¿è¯¥replicaçš„GSä¾ç„¶æ˜¯ä¸ºè¿½åŠ ä¹‹å‰çš„GSï¼Œè€Œå…¶ä½™replicaçš„GSç°åœ¨å·²ç»æ˜¯è¿½åŠ ä¹‹åçš„GSã€‚</li><li>å½“ä¸€ä¸ªDataNodeæ­»äº†ä¸€æ®µæ—¶é—´ï¼Œç„¶ååˆé‡æ–°åŠ å…¥äº†é›†ç¾¤ï¼Œæ­¤æ—¶åœ¨æ­¤DataNodeä¸Šæ£€æµ‹è¿‡æ—¶çš„replicaã€‚</li></ul><p>å½“ä¸‹é¢çš„æƒ…å†µå‘ç”Ÿæ—¶ï¼Œä¸€ä¸ªæ–°çš„GSä¼šäº§ç”Ÿï¼š</p><ul><li>åˆ›å»ºä¸€ä¸ªæ–°æ–‡ä»¶</li><li>clientå¯¹ä¸€ä¸ªå·²ç»å­˜åœ¨çš„æ–‡ä»¶è¿›è¡Œappendæˆ–è€…truncate</li><li>clientåœ¨å‘dnsä¸Šå†™æ•°æ®æ—¶å‘ç”Ÿé”™è¯¯ï¼Œä¼šè¯·æ±‚ä¸€ä¸ªæ–°çš„GS</li><li>NameNodeå¯¹ä¸€ä¸ªæ–‡ä»¶å‘èµ·ç§Ÿçº¦æ¢å¤æ“ä½œ</li></ul><h2 id="Lease-Recovery-and-Block-Recovery"><a href="#Lease-Recovery-and-Block-Recovery" class="headerlink" title="Lease Recovery and Block Recovery"></a>Lease Recovery and Block Recovery</h2><h3 id="Lease-Manager"><a href="#Lease-Manager" class="headerlink" title="Lease Manager"></a>Lease Manager</h3><p>ç§Ÿçº¦åœ¨NameNodeä¸Šè¢«lease Managerè¿›è¡Œç®¡ç†ã€‚NameNodeè·Ÿè¸ªæ¯ä¸ªclientæ‰“å¼€çš„å†™æ–‡ä»¶ã€‚clientæ²¡æœ‰å¿…è¦ä¸ºå®ƒæ‰“å¼€çš„æ¯ä¸ªå†™æ–‡ä»¶è¿›è¡Œå•ç‹¬æ›´æ–°ç§Ÿçº¦ï¼Œè€Œæ˜¯å®šæœŸçš„å‘NameNodeå‘é€ä¸€ä¸ªè¯·æ±‚å¯¹æ‰€æœ‰çš„æ–‡ä»¶è¿›è¡Œç§Ÿçº¦æ›´æ–°ã€‚</p><p>æ¯ä¸ªNameNodeç®¡ç†ä¸€ä¸ªå•ç‹¬çš„HDFS namespaceï¼Œæ¯ä¸ªHDFS namespaceä¼šæœ‰ä¸€ä¸ªå•ç‹¬çš„lease manageræ¥ç®¡ç†ä¸è¯¥namespaceç›¸å…³çš„æ‰€æœ‰clientç§Ÿçº¦ã€‚Federated HDFSé›†ç¾¤å¯èƒ½æœ‰å¤šä¸ªnamespaceï¼Œæ¯ä¸ªnamespaceséƒ½æœ‰å…¶è‡ªå·±çš„lease mangerã€‚</p><p>lease managerç»´æŠ¤è¿™ä¸¤ä¸ªè¶…æ—¶æ—¶é—´(ç›®å‰è¿™ä¸¤ä¸ªè¶…æ—¶æ—¶é—´æ˜¯ä¸å¯é…ç½®çš„)ï¼Œä¸€ä¸ªæ˜¯softLimit(1m)ï¼Œå¦ä¸€ä¸ªæ˜¯hardLimit(1h)ã€‚lease managerç®¡ç†çš„æ‰€æœ‰ç§Ÿçº¦éƒ½éµå®ˆç›¸åŒçš„softLimitå’ŒhardLimitã€‚åœ¨softLimitè¿‡æœŸä¹‹å‰ï¼ŒæŒæœ‰æŸæ–‡ä»¶ç§Ÿçº¦çš„clientç‹¬å è¯¥æ–‡ä»¶çš„å†™æƒé™ã€‚å¦‚æœsoftLimitè¶…æœŸå¹¶ä¸”clientå¹¶æ²¡æœ‰æ›´æ–°ç§Ÿçº¦æˆ–è€…å…³é—­äº†æ–‡ä»¶ï¼Œå¦ä¸€ä¸ªclientèƒ½å¼ºåˆ¶æ¥ç®¡è¿™ä¸ªç§Ÿçº¦ã€‚å¦‚æœhardLimitè¶…æœŸå¹¶ä¸”clientæ²¡æœ‰æ›´æ–°ç§Ÿçº¦ï¼ŒHDFSå‡è®¾æ­¤clientå·²ç»é€€å‡ºï¼Œå°†è‡ªåŠ¨å…³é—­ä»£è¡¨clientçš„æ–‡ä»¶ï¼Œä»è€Œæ¢å¤ç§Ÿçº¦ã€‚</p><p>äº‹å®ä¸ŠclientæŒæœ‰çš„æŸä¸ªæ–‡ä»¶ç§Ÿçº¦å¹¶ä¸ä¼šé˜»æ­¢å…¶å®ƒclientå¯¹æ­¤æ–‡ä»¶è¿›è¡Œè¯»ï¼Œä¸€ä¸ªæ–‡ä»¶èƒ½åŒæ—¶æœ‰å¤šä¸ªclientè¿›è¡Œè¯»ï¼Œä½†åªèƒ½æœ‰ä¸€ä¸ªclientè¿›è¡Œå†™ã€‚</p><p>lease managerå†…éƒ¨æ”¯æŒçš„æ“ä½œï¼š</p><ul><li>ä¸ºä¸€ä¸ªclientå¢åŠ ä¸€ä¸ªç§Ÿçº¦å’Œè·¯å¾„(å¦‚æœè¿™ä¸ªclientå·²ç»æœ‰äº†ä¸€ä¸ªç§Ÿçº¦ï¼Œåˆ™å¢åŠ è¿™ä¸ªè·¯å¾„åˆ°è¿™ä¸ªç§Ÿçº¦ã€‚å¦åˆ™ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„ç§Ÿçº¦ï¼Œå¹¶æ·»åŠ è·¯å¾„åˆ°ç§Ÿçº¦é‡Œé¢)</li><li>ç§»é™¤clientçš„ç§Ÿçº¦å’Œè·¯å¾„(å¦‚æœè¿™æ˜¯ç§Ÿçº¦çš„æœ€åä¸€ä¸ªè·¯å¾„ï¼Œåˆ™ç§»é™¤è¿™ä¸ªç§Ÿçº¦)</li><li>æ£€æŸ¥soft/hard limitæ˜¯å¦è¿‡æœŸï¼Œ</li><li>å’Œå¯¹ç»™å®šçš„clientè¿›è¡Œrenewç§Ÿçº¦ã€‚</li></ul><p>lease manageræœ‰ä¸€ä¸ªmonitorçº¿ç¨‹ï¼Œæ­¤çº¿ç¨‹å‘¨æœŸæ€§(æ¯2s)çš„æ£€æŸ¥æ‰€æœ‰ç§Ÿçº¦æ˜¯å¦hardLimitè¶…æœŸï¼Œå¦‚æœè¶…æœŸï¼Œåˆ™å¯¹ç§Ÿçº¦ä¸­çš„æ‰€æœ‰æ–‡ä»¶è§¦å‘ç§Ÿçº¦æ¢å¤ã€‚</p><p>HDFS clienté€šè¿‡org.apache.hadoop.hdfs.LeaseRenewer.LeaseRenewerç±»renewså®ƒè‡ªå·±çš„ç§Ÿçº¦ã€‚LeaseRenewerå¯¹æ¯ä¸ªNameNodeä¸Šçš„æ¯ä¸ªuserè¿è¡Œä¸€ä¸ªçº¿ç¨‹å»å‘¨æœŸæ€§çš„æ£€æŸ¥ï¼Œå½“é—´éš”è¶…è¿‡ç§Ÿçº¦æ£€æŸ¥çš„ä¸€åŠï¼Œåˆ™æ›´æ–°LeaseRenewerå¯¹åº”çš„æ‰€æœ‰clientçš„ç§Ÿçº¦ã€‚</p><p>(æ³¨æ„: ä¸€ä¸ªHDFS clientåªä¼šå…³è”ä¸€ä¸ªNameNode; è¯·çœ‹å®ƒçš„æ„é€ å™¨ org.apache.hadoop.hdfs.DFSClient)ã€‚ å¦‚æœåŒä¸€ä¸ªåº”ç”¨æƒ³è¦è®¿é—®è”é‚¦é›†ç¾¤çš„ä¸åŒNSçš„ä¸åŒçš„æ–‡ä»¶ï¼Œéœ€è¦ä¸ºæ¯ä¸€ä¸ªNameNodeåˆ›å»ºclientã€‚</p><h3 id="Lease-Recovery-Process"><a href="#Lease-Recovery-Process" class="headerlink" title="Lease Recovery Process"></a>Lease Recovery Process</h3><p>ç§Ÿçº¦çš„æ¢å¤è¿‡ç¨‹è¢«NameNodeè§¦å‘ç”¨æ¥å¯¹ç»™å®šçš„clientè¿›è¡Œæ¢å¤ç§Ÿçº¦ã€‚åœ¨é€šè¿‡ç›‘æ§çº¿ç¨‹æ£€æŸ¥åˆ°è¾¾hardLimitçš„æœ‰æ•ˆæœŸï¼Œæˆ–è€…softLimitè¿‡æœŸæ—¶ï¼Œå…¶ä»–å®¢æˆ·ç«¯å°è¯•æ¥ç®¡ç§Ÿçº¦çš„æƒ…å†µä¸‹NameNodeä¼šè§¦å‘Lease Recoveryã€‚Lease Recoveryä¼šæ£€æŸ¥ç›¸åŒclientæ‰“å¼€çš„æ¯ä¸ªå†™æ–‡ä»¶ï¼Œå¦‚æœè¿™ä¸ªæ–‡ä»¶çš„æœ€åä¸€ä¸ªblockä¸æ˜¯COMPLETEçŠ¶æ€åˆ™æ‰§è¡Œblock recoveryï¼Œå¹¶ä¸”å…³é—­è¿™ä¸ªæ–‡ä»¶ã€‚<em>Block Recoveryåªæœ‰åœ¨Lease Recoveryæ—¶ä¼šè¢«è§¦å‘</em>ã€‚</p><p>ä¸‹é¢æ˜¯ç»™å®šæ–‡ä»¶fçš„Lease Recoveryç®—æ³•ã€‚å½“clientæ­»äº†ï¼Œè¯¥ç®—æ³•é€‚ç”¨äºè¯¥clientæ‰“å¼€çš„æ¯ä¸ªå†™æ–‡ä»¶ã€‚</p><p>1ã€å¾—åˆ°åŒ…å«fæœ€åä¸€ä¸ªblockçš„dns<br>2ã€ä»dnsä¸­åˆ†é…ä¸€ä¸ªdnä½œä¸ºprimary dn p<br>3ã€pä»NameNodeä¸­å¾—åˆ°ä¸€ä¸ªæ–°çš„GS<br>4ã€pä»æ¯ä¸ªdnä¸Šå¾—åˆ°blockçš„ä¿¡æ¯<br>5ã€på°±æ˜¯è¿™ä¸ªblockçš„æœ€å°é•¿åº¦<br>6ã€pæ›´æ–°dnsï¼Œæ‹¥æœ‰åˆæ³•çš„GSï¼Œå³æ–°çš„GSå’Œæœ€å°çš„blocké•¿åº¦ã€‚<br>7ã€pç¡®è®¤NameNodeæ›´æ–°çš„ç»“æœ.<br>8ã€NameNodeæ›´æ–°BlockInfo<br>9ã€NameNodeç§»é™¤fçš„ç§Ÿçº¦(å…¶ä»–å†™çš„æ“ä½œç°åœ¨å¯ä»¥ç»´æŠ¤è¿™ä¸ªæ–‡ä»¶fçš„ç§Ÿçº¦ï¼Œè¿›è¡Œå†™å…¥æ“ä½œ)<br>10ã€NameNodeæäº¤è¿™äº›æ”¹å˜åˆ°edit log.<br>ç¬¬ä¸‰æ­¥åˆ°ç¬¬ä¸ƒæ­¥æ˜¯ç®—æ³•çš„block recoveryéƒ¨åˆ†ã€‚å¦‚æœä¸€ä¸ªæ–‡ä»¶éœ€è¦block recoveryï¼ŒNameNodeä»æ‹¥æœ‰è¯¥æ–‡ä»¶æœ€åä¸€ä¸ªblockçš„replicaçš„DataNodesä¸­æŒ‘é€‰ä¸€ä¸ªprimary DataNodeï¼Œä½¿å…¶DataNodeåè°ƒå…¶ä½™DataNodesè¿›è¡Œblock recoveryã€‚ç»“æŸä¹‹åï¼Œè¿™ä¸ªDataNodeæƒ³NameNodeæŠ¥å‘Šï¼ŒNameNodeæ›´æ–°è¿™ä¸ªblockçš„å†…éƒ¨çŠ¶æ€ï¼Œç§»é™¤è¿™ä¸ªç§Ÿçº¦ï¼Œæœ€åæƒ³edit logæäº¤æ”¹å˜ã€‚</p><p>æœ‰æ—¶ç®¡ç†å‘˜åœ¨hardLimitæœªè¶…æ—¶ä¹‹å‰ï¼Œéœ€è¦å¼ºåˆ¶å¯¹æŸä¸ªæ–‡ä»¶è¿›è¡ŒLease Recoveryï¼Œæ­¤æ—¶å¯ä»¥ä½¿ç”¨ä¸€ä¸ªCLI<br><code>hdfs debug recoverLease [-path &lt;path&gt;] [-retries &lt;num-retries&gt;]</code></p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p><em>ç§Ÿçº¦æ¢å¤ï¼Œå—æ¢å¤ï¼Œå’Œpipelineæ¢å¤å¯¹HDFSå®¹é”™è‡³å…³é‡è¦</em>ã€‚ä»–ä»¬ä¸€èµ·ä¿è¯äº†HDFSå†™çš„æŒä¹…æ€§å’Œä¸€è‡´æ€§ï¼Œå³ä½¿æ˜¯åœ¨ç½‘ç»œæˆ–è€…èŠ‚ç‚¹å¼‚å¸¸çš„æƒ…å†µä¸‹ã€‚</p><p>åœ¨ä¸‹ä¸€ç¯‡ä¸­å°†ä»‹ç»pipeline recoveryã€‚</p><p><a href="http://blog.cloudera.com/blog/2015/02/understanding-hdfs-recovery-processes-part-1/">åŸæ–‡åœ°å€</a></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Lease Recovery </tag>
            
            <tag> Block Recovery </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFS readè§£æ(ä¸€)ä¹‹Openæ–‡ä»¶æµ</title>
      <link href="/HDFS%20read%E8%A7%A3%E6%9E%90.html"/>
      <url>/HDFS%20read%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡ä¸»è¦è®°å½•ä¸‹HDFSè¯»å–æ–‡ä»¶çš„æµç¨‹ï¼Œæµç¨‹å›¾å¦‚ä¸‹ï¼š<br>![readæµç¨‹å›¾](/blogimgs/HDFS readè§£æ/readæµç¨‹å›¾.png â€œreadæµç¨‹å›¾â€)</p><p>å¦‚ä¸Šå›¾æ‰€ç¤ºï¼Œ</p><ol><li>HDFS Clienté€šè¿‡FileSystem.get()æ–¹æ³•å®ä¾‹åŒ–ä¸€ä¸ªFileSystemå¯¹è±¡</li><li>è°ƒç”¨FileSystem.openæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶çš„æ•°æ®æµFSDataInputStreamï¼Œ<em>open_ä¸­ä¼šç”¨rpcæ–¹æ³•<code>getBlockLocations</code>å¾—åˆ°blockçš„locationsä¿¡æ¯ï¼Œé»˜è®¤ä¼šå…ˆå¾—åˆ°_prefetchSize</em>(<code>conf.getLong(DFS_CLIENT_READ_PREFETCH_SIZE_KEY, 10 * defaultBlockSize)</code>)å¤§å°æ–‡ä»¶çš„ä¿¡æ¯ã€‚</li><li>HDFS Clienté€šè¿‡FSDataInputStreamæµè¯»å–ç¦»å®¢æˆ·ç«¯æœ€è¿‘çš„dnä¸Šçš„blockï¼Œåœ¨ç¬¬2æ­¥ä¸­å¾—åˆ°çš„block locationä¿¡æ¯å·²ç»å°†blockçš„å‰¯æœ¬æŒ‰ç…§ç¦»å®¢æˆ·ç«¯çš„ç½‘ç»œæ‹“æ‰‘è·ç¦»è¿›è¡Œäº†æ’åºï¼Œæ­¤è¿‡ç¨‹æ˜¯åœ¨nnç«¯å®Œæˆçš„ã€‚</li><li>è¯»å–å®Œå½“å‰blockçš„æ•°æ®åï¼Œå…³é—­ä¸å½“å‰çš„DataNodeè¿æ¥ï¼Œå¹¶ä¸ºè¯»å–ä¸‹ä¸€ä¸ªblockå¯»æ‰¾æœ€ä½³çš„DataNodeï¼›</li><li>å½“è¯»å®Œåˆ—è¡¨çš„blockåï¼Œä¸”æ–‡ä»¶è¯»å–è¿˜æ²¡æœ‰ç»“æŸï¼Œå®¢æˆ·ç«¯ä¼šç»§ç»­å‘Namenodeè·å–ä¸‹ä¸€æ‰¹çš„blockåˆ—è¡¨ã€‚</li><li><em>è¯»å–å®Œä¸€ä¸ªblockéƒ½ä¼šè¿›è¡ŒchecksuméªŒè¯ï¼Œå¦‚æœè¯»å–datanodeæ—¶å‡ºç°é”™è¯¯ï¼Œå®¢æˆ·ç«¯ä¼šé€šçŸ¥Namenodeï¼Œç„¶åå†ä»ä¸‹ä¸€ä¸ªæ‹¥æœ‰è¯¥blockæ‹·è´çš„datanodeç»§ç»­è¯»</em>ï¼› </li></ol><span id="more"></span><h2 id="ç›¸å…³æ¦‚å¿µ"><a href="#ç›¸å…³æ¦‚å¿µ" class="headerlink" title="ç›¸å…³æ¦‚å¿µ"></a>ç›¸å…³æ¦‚å¿µ</h2><ul><li>inode<br>æ–‡ä»¶æ•°æ®éƒ½å‚¨å­˜åœ¨â€å—â€ä¸­ï¼Œé‚£ä¹ˆå¾ˆæ˜¾ç„¶ï¼Œæˆ‘ä»¬è¿˜å¿…é¡»æ‰¾åˆ°ä¸€ä¸ªåœ°æ–¹å‚¨å­˜æ–‡ä»¶çš„å…ƒä¿¡æ¯ï¼Œæ¯”å¦‚æ–‡ä»¶çš„åˆ›å»ºè€…ã€æ–‡ä»¶çš„åˆ›å»ºæ—¥æœŸã€æ–‡ä»¶çš„å¤§å°ç­‰ç­‰ã€‚è¿™ç§å‚¨å­˜æ–‡ä»¶å…ƒä¿¡æ¯çš„åŒºåŸŸå°±å«åšinodeï¼Œä¸­æ–‡è¯‘åä¸ºâ€ç´¢å¼•èŠ‚ç‚¹â€ã€‚æ¯ä¸€ä¸ªæ–‡ä»¶éƒ½æœ‰å¯¹åº”çš„inodeï¼Œé‡Œé¢åŒ…å«äº†ä¸è¯¥æ–‡ä»¶æœ‰å…³çš„ä¸€äº›ä¿¡æ¯ã€‚<br>åœ¨HDFSä¸­inodeä¹Ÿå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶åœ¨å†…å­˜ä¸­çš„ä¸€ä¸ªæŠ½è±¡ï¼Œä¿å­˜äº†è¯¥æ–‡ä»¶çš„ä¸€äº›å…ƒæ•°æ®ä¿¡æ¯ã€‚<br>INODEåœ¨ä»£ç ä¸­æ˜¯ä¸€ä¸ªæœ€åº•å±‚çš„æŠ½è±¡ç±»</li><li>INodeFile<br>æ–‡ä»¶èŠ‚ç‚¹ç±»ï¼Œç»§æ‰¿è‡ªINodeï¼Œè¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ï¼Œå…¶ä¸­æœ‰ä¸ªé‡è¦çš„å±æ€§<code>private BlockInfo[] blocks</code>ï¼Œblocksä¸­å­˜å‚¨çš„æ˜¯è¯¥æ–‡ä»¶çš„blockä¿¡æ¯BlockInfoï¼Œå…¶ä¸­æ¯ä¸ªblock(BlockInfo)æ˜¯ä¸€ä¸ªå…·æœ‰3ä¸ªå…ƒç´ çš„æ•°ç»„(triplets)ï¼Œä¹Ÿå°±æ˜¯ä¸‰ä¸ªæŒ‡é’ˆåŸŸï¼Œå¤§å°ä¸º3<em>replicasï¼Œå…¶ä¸­replicasæ˜¯Blockå‰¯æœ¬æ•°é‡ã€‚tripletsåŒ…å«çš„ä¿¡æ¯ï¼š<br>triplets[3</em>i]ï¼šBlockæ‰€åœ¨çš„DataNode Aï¼›(<em>DatanodeStorageInfoå¯¹è±¡</em>)<br>triplets[3<em>i+1]ï¼šè¯¥DataNode Aä¸Šå‰ä¸€ä¸ªBlockï¼›(<em>æŒ‡å‘å‰ä¸€ä¸ªblockçš„BlockInfoå¯¹è±¡å¼•ç”¨</em>)<br>triplets[3</em>i+2]ï¼šè¯¥DataNode Aä¸Šåä¸€ä¸ªBlockï¼›(<em>æŒ‡å‘åä¸€ä¸ªblockçš„BlockInfoå¯¹è±¡å¼•ç”¨</em>)<br>å…¶ä¸­iè¡¨ç¤ºçš„æ˜¯Blockçš„ç¬¬iä¸ªå‰¯æœ¬ï¼Œiå–å€¼[0,replicas)ã€‚</li><li>INodeDirectory<br>æ–‡ä»¶ç›®å½•ç±»ï¼Œä¹Ÿæ˜¯ç»§æ‰¿è‡ªINode.ä»–çš„å­©å­ä¸­æ˜¯æ–‡ä»¶é›†ä¹Ÿå¯èƒ½æ˜¯ç›®å½•</li><li>INodeDirectoryWithQuota<br>æœ‰é…é¢é™åˆ¶çš„ç›®å½•ï¼Œè¿™æ˜¯ä¸ºäº†é€‚åº”HDFSä¸­çš„é…é¢ç­–ç•¥ã€‚</li><li>INodeFileUnderConstruction<br>å¤„äºæ„å»ºçŠ¶æ€çš„æ–‡ä»¶ç±»ï¼Œå¯ä»¥ä»INodeFileä¸­è½¬åŒ–è€Œæ¥ã€‚</li><li><em>FSNamesystemä¸­ç›¸å…³çš„å±æ€§</em></li></ul><h2 id="HDFS-Readä¹‹æ‰“å¼€æ–‡ä»¶æµ"><a href="#HDFS-Readä¹‹æ‰“å¼€æ–‡ä»¶æµ" class="headerlink" title="HDFS Readä¹‹æ‰“å¼€æ–‡ä»¶æµ"></a>HDFS Readä¹‹æ‰“å¼€æ–‡ä»¶æµ</h2><p>HDFSè¯»å–æ–‡ä»¶å†…å®¹è·Ÿjavaè¯»å–æ–‡ä»¶å†…å®¹ç±»ä¼¼ï¼Œéƒ½éœ€è¦å…ˆæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµï¼ŒHDFSæ˜¯é€šè¿‡<em>FileSystem</em>å¯¹è±¡æ‰“å¼€æ–‡ä»¶æµçš„ï¼Œä»£ç æµç¨‹ä¸ºé€šè¿‡<code>FileSystem.get(conf)</code>å¾—åˆ°ä¸€ä¸ª<code>FileSystem</code>å¯¹è±¡ï¼Œç„¶åè°ƒç”¨<code>open(Path)</code>æ‰“å¼€ä¸€ä¸ªFSDataInputStreamæµï¼Œçœ‹ä¸‹openä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> FSDataInputStream <span class="title">open</span><span class="params">(Path f)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"><span class="comment">// io.file.buffer.size  The size of buffer for use in sequence files.</span></span><br><span class="line">  <span class="keyword">return</span> open(f, getConf().getInt(<span class="string">&quot;io.file.buffer.size&quot;</span>, <span class="number">4096</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>FileSystemæ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå°†å…·ä½“çš„<code>open</code>æ“ä½œç•™ç»™å­ç±»å®ç°ï¼Œä¾‹å¦‚DistributedFileSystemã€WebHdfsFileSystemç­‰ï¼Œä¸åŒçš„æ–‡ä»¶ç³»ç»Ÿå…·æœ‰ä¸åŒæ‰“å¼€æ–‡ä»¶çš„è¡Œä¸ºï¼Œæˆ‘ä»¬ä»¥DistributedFileSystemä¸ºä¾‹ï¼Œopenæ–¹æ³•å®ç°ï¼Œä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// buffersize å†³å®šbuffersizeå¤§å°çš„æ•°æ®åœ¨read/writeæ—¶è¢«ç¼“å­˜</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> FSDataInputStream <span class="title">open</span><span class="params">(Path f, <span class="keyword">final</span> <span class="keyword">int</span> bufferSize)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  statistics.incrementReadOps(<span class="number">1</span>);</span><br><span class="line">  Path absF = fixRelativePart(f);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> FileSystemLinkResolver&lt;FSDataInputStream&gt;() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FSDataInputStream <span class="title">doCall</span><span class="params">(<span class="keyword">final</span> Path p)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException, UnresolvedLinkException </span>&#123;</span><br><span class="line">      <span class="keyword">final</span> DFSInputStream dfsis =</span><br><span class="line">        dfs.open(getPathName(p), bufferSize, verifyChecksum);</span><br><span class="line">      <span class="keyword">return</span> dfs.createWrappedInputStream(dfsis);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> FSDataInputStream <span class="title">next</span><span class="params">(<span class="keyword">final</span> FileSystem fs, <span class="keyword">final</span> Path p)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">      <span class="keyword">return</span> fs.open(p, bufferSize);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;.resolve(<span class="keyword">this</span>, absF);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FileSystemLinkResolver.resolve</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> T <span class="title">resolve</span><span class="params">(<span class="keyword">final</span> FileSystem filesys, <span class="keyword">final</span> Path path)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">  T in = <span class="keyword">null</span>;</span><br><span class="line">  Path p = path;</span><br><span class="line">  <span class="comment">// Assumes path belongs to this FileSystem.</span></span><br><span class="line">  <span class="comment">// Callers validate this by passing paths through FileSystem#checkPath</span></span><br><span class="line">  FileSystem fs = filesys;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">boolean</span> isLink = <span class="keyword">true</span>; isLink;) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      in = doCall(p);</span><br><span class="line">      isLink = <span class="keyword">false</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (UnresolvedLinkException e) &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="comment">// Have to call next if it&#x27;s a new FS</span></span><br><span class="line">      <span class="keyword">if</span> (!fs.equals(filesys)) &#123;</span><br><span class="line">        <span class="keyword">return</span> next(fs, p);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Else, we keep resolving with this filesystem</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Successful call, path was fully resolved</span></span><br><span class="line">  <span class="keyword">return</span> in;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DistributedFileSystem.open()ä¸­newä¸€ä¸ªFileSystemLinkResolverçš„åŒ¿åç±»ï¼Œåœ¨resolveä¸­è°ƒç”¨åœ¨åŒ¿åç±»ä¸­é‡å†™çš„<code>doCall()</code>æ–¹æ³•ï¼Œå¦‚æœdoCallæŠ›å‡ºUnresolvedLinkExceptionå¼‚å¸¸ï¼Œè¢«resolveæ•è·è°ƒç”¨<code>next()</code>ï¼Œè¿›è¡Œå†æ¬¡æ‰“å¼€ã€‚</p><p>åœ¨<code>doCall()</code>ä¸­è°ƒç”¨<code>dfs.open(getPathName(p), bufferSize, verifyChecksum)</code>è¿”å›ä¸€ä¸ª<em>DFSInputStream</em>å¯¹è±¡ï¼Œç„¶åå†é€šè¿‡<code>dfs.createWrappedInputStream(dfsis)</code>åŒ…è£…ä¸€ä¸ª<em>HdfsDataInputStream</em>å¯¹è±¡è¿”å›ç»™<em>FSDataInputStream</em>ï¼ŒFSDataInputStreamæ˜¯HdfsDataInputStreamçš„çˆ¶ç±»ï¼Œè¿™æ ·å°±é€šè¿‡FileSystem.open(path)æ‰“å¼€äº†ä¸€ä¸ªæ–‡ä»¶æµã€‚</p><p>doCallä¸­dfsæ˜¯FSDataInputStreamçš„æˆå‘˜å˜é‡DFSClientï¼Œå…¶openæ–¹æ³•ä¸­newå‡ºä¸€ä¸ªDFSInputStreamå®ä¾‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> DFSInputStream <span class="title">open</span><span class="params">(String src, <span class="keyword">int</span> buffersize, <span class="keyword">boolean</span> verifyChecksum)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, UnresolvedLinkException </span>&#123;</span><br><span class="line">  checkOpen();</span><br><span class="line">  <span class="comment">//    Get block info from namenode</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DFSInputStream(<span class="keyword">this</span>, src, buffersize, verifyChecksum);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// DFSInputStream æ„é€ æ–¹æ³•</span></span><br><span class="line">DFSInputStream(DFSClient dfsClient, String src, <span class="keyword">int</span> buffersize, <span class="keyword">boolean</span> verifyChecksum</span><br><span class="line">               ) <span class="keyword">throws</span> IOException, UnresolvedLinkException &#123;</span><br><span class="line">  <span class="keyword">this</span>.dfsClient = dfsClient;</span><br><span class="line">  <span class="keyword">this</span>.verifyChecksum = verifyChecksum;</span><br><span class="line">  <span class="keyword">this</span>.buffersize = buffersize;</span><br><span class="line">  <span class="keyword">this</span>.src = src;</span><br><span class="line">  <span class="comment">// Clientçš„ç¼“å­˜ç­–ç•¥ï¼ŒCachingStrategy(readDropBehind, readahead);</span></span><br><span class="line">  <span class="comment">// Boolean readDropBehind = (conf.get(DFS_CLIENT_CACHE_DROP_BEHIND_READS) == null) ?</span></span><br><span class="line">  <span class="comment">//     null : conf.getBoolean(DFS_CLIENT_CACHE_DROP_BEHIND_READS, false);</span></span><br><span class="line">  <span class="comment">// Long readahead = (conf.get(DFS_CLIENT_CACHE_READAHEAD) == null) ?</span></span><br><span class="line">  <span class="comment">//     null : conf.getLong(DFS_CLIENT_CACHE_READAHEAD, 0);  </span></span><br><span class="line">  <span class="keyword">this</span>.cachingStrategy =</span><br><span class="line">      dfsClient.getDefaultReadCachingStrategy();</span><br><span class="line">  openInfo();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">openInfo</span><span class="params">()</span> <span class="keyword">throws</span> IOException, UnresolvedLinkException </span>&#123;</span><br><span class="line">  <span class="comment">// fetchLocatedBlocksAndGetLastBlockLengthæœ‰ä¸¤ä¸ªåŠŸèƒ½ï¼Œ</span></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªæ˜¯å¯¹locatedBlocksèµ‹å€¼</span></span><br><span class="line">  <span class="comment">// å¦ä¸€ä¸ªæ˜¯è¿”å›æœ€åä¸€ä¸ªæœªæ„é€ å®Œæˆçš„blockçš„é•¿åº¦</span></span><br><span class="line">  lastBlockBeingWrittenLength = fetchLocatedBlocksAndGetLastBlockLength();</span><br><span class="line">  <span class="keyword">int</span> retriesForLastBlockLength = dfsClient.getConf().retryTimesForGetLastBlockLength;</span><br><span class="line">  <span class="comment">// å¦‚æœè·å–å¤±è´¥ï¼Œåˆ™è¿›è¡Œé‡è¯•ï¼Œé»˜è®¤æ˜¯3æ¬¡</span></span><br><span class="line">  <span class="comment">// dfs.client.retry.times.get-last-block-length è®¾ç½®é‡è¯•æ¬¡æ•°</span></span><br><span class="line">  <span class="comment">// å½“é›†ç¾¤é‡å¯æ—¶ï¼Œdnå¯èƒ½æ²¡æ¥åŠæ±‡æŠ¥blockï¼Œæ­¤æ—¶å¯èƒ½å­˜åœ¨éƒ¨åˆ†blockçš„locationæ— æ³•ä»nnä¸Šè¯»å‡º</span></span><br><span class="line">  <span class="keyword">while</span> (retriesForLastBlockLength &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// Getting last block length as -1 is a special case. When cluster</span></span><br><span class="line">    <span class="comment">// restarts, DNs may not report immediately. At this time partial block</span></span><br><span class="line">    <span class="comment">// locations will not be available with NN for getting the length. Lets</span></span><br><span class="line">    <span class="comment">// retry for 3 times to get the length.</span></span><br><span class="line">    <span class="keyword">if</span> (lastBlockBeingWrittenLength == -<span class="number">1</span>) &#123;</span><br><span class="line">      DFSClient.LOG.warn(<span class="string">&quot;Last block locations not available. &quot;</span></span><br><span class="line">          + <span class="string">&quot;Datanodes might not have reported blocks completely.&quot;</span></span><br><span class="line">          + <span class="string">&quot; Will retry for &quot;</span> + retriesForLastBlockLength + <span class="string">&quot; times&quot;</span>);</span><br><span class="line">      <span class="comment">// ç­‰å¾…dfs.client.retry.interval-ms.get-last-block-length msä¹‹åé‡è¯• </span></span><br><span class="line">      <span class="comment">// é»˜è®¤æ˜¯4000ms</span></span><br><span class="line">      waitFor(dfsClient.getConf().retryIntervalForGetLastBlockLength);</span><br><span class="line">      lastBlockBeingWrittenLength = fetchLocatedBlocksAndGetLastBlockLength();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    retriesForLastBlockLength--;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (retriesForLastBlockLength == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Could not obtain the last block locations.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>openInfoé‡Œåªè°ƒç”¨äº†ä¸€ä¸ªæ–¹æ³•fetchLocatedBlocksAndGetLastBlockLengthï¼ŒopenInfoä¸»è¦æ˜¯ä¿è¯èƒ½å¤Ÿæ­£ç¡®è·å–_å†™å…¥çš„èµ·å§‹åœ°å€lastBlockBeingWrittenLength_ï¼Œå› ä¸º<em>å½“é›†ç¾¤é‡å¯æ—¶ï¼Œdnå¯èƒ½æ²¡æ¥åŠæ±‡æŠ¥blockï¼Œæ­¤æ—¶å¯èƒ½å­˜åœ¨éƒ¨åˆ†blockçš„locationæ— æ³•ä»nnä¸Šè¯»å‡º</em>ï¼Œæ‰€ä»¥å½“lastBlockBeingWrittenLengthèµ‹å€¼å¤±è´¥æ—¶ï¼Œç­‰å¾…4000msç„¶åè¿›è¡Œé‡è¯•ï¼Œé»˜è®¤é‡è¯•æ¬¡æ•°ä¸º3æ¬¡ï¼Œç”±_dfs.client.retry.times.get-last-block-length_æ§åˆ¶ã€‚ä¸»è¦é€»è¾‘åœ¨æ–¹æ³•fetchLocatedBlocksAndGetLastBlockLengthä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">long</span> <span class="title">fetchLocatedBlocksAndGetLastBlockLength</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   <span class="comment">// DFSClient é€šè¿‡rpcè°ƒç”¨FSNamespace.getLocatedBlockså¾—åˆ°éƒ¨åˆ†blockçš„locations</span></span><br><span class="line">  <span class="keyword">final</span> LocatedBlocks newInfo = dfsClient.getLocatedBlocks(src, <span class="number">0</span>);</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (locatedBlocks != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Iterator&lt;LocatedBlock&gt; oldIter = locatedBlocks.getLocatedBlocks().iterator();</span><br><span class="line">    Iterator&lt;LocatedBlock&gt; newIter = newInfo.getLocatedBlocks().iterator();</span><br><span class="line">    <span class="keyword">while</span> (oldIter.hasNext() &amp;&amp; newIter.hasNext()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (! oldIter.next().getBlock().equals(newIter.next().getBlock())) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Blocklist for &quot;</span> + src + <span class="string">&quot; has changed!&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  locatedBlocks = newInfo;</span><br><span class="line">  <span class="keyword">long</span> lastBlockBeingWrittenLength = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­æ­¤srcæ˜¯å¦æœ‰æ­£åœ¨æ„å»ºçš„blockï¼Œæœ‰åˆ™è¿”å›å½“å‰çš„é•¿åº¦ï¼Œæ²¡æœ‰åˆ™è¿”å›0ï¼Œ-1è¡¨ç¤ºå¤±è´¥</span></span><br><span class="line">  <span class="keyword">if</span> (!locatedBlocks.isLastBlockComplete()) &#123;</span><br><span class="line">    <span class="keyword">final</span> LocatedBlock last = locatedBlocks.getLastLocatedBlock();</span><br><span class="line">    <span class="keyword">if</span> (last != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (last.getLocations().length == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (last.getBlockSize() == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// if the length is zero, then no data has been written to</span></span><br><span class="line">          <span class="comment">// datanode. So no need to wait for the locations.</span></span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> len = readBlockLength(last);</span><br><span class="line">      last.getBlock().setNumBytes(len);</span><br><span class="line">      lastBlockBeingWrittenLength = len; </span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  fileEncryptionInfo = locatedBlocks.getFileEncryptionInfo();</span><br><span class="line"></span><br><span class="line">  currentNode = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">return</span> lastBlockBeingWrittenLength;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fetchLocatedBlocksAndGetLastBlockLengthä¸»è¦æ˜¯é€šè¿‡DFSClient.getLocatedBlockså¾—åˆ°srcçš„LocatedBlocksã€‚</p><p>LocatedBlocksåŒ…å«blocks locationsä¿¡æ¯å’Œsrcæ–‡ä»¶é•¿åº¦ã€‚LocatedBlocksä¸­é‡è¦çš„å±æ€§æœ‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// å­˜å‚¨æ–‡ä»¶çš„é•¿åº¦</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> fileLength;</span><br><span class="line"><span class="comment">// å­˜å‚¨æ–‡ä»¶ä¸­blockä¸dnçš„ä¿¡æ¯å’Œæº¢å†™blockçš„å…ƒæ•°æ®</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;LocatedBlock&gt; blocks; <span class="comment">// array of blocks with prioritized locations</span></span><br><span class="line"><span class="comment">// è¡¨ç¤ºsrcæ˜¯å¦æœ‰æ­£åœ¨åˆ›å»ºçš„block</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> underConstruction;</span><br><span class="line"><span class="comment">// srcçš„æœ€åä¸€ä¸ªblock</span></span><br><span class="line"><span class="keyword">private</span> LocatedBlock lastLocatedBlock = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// æ ‡è¯†æœ€åä¸€ä¸ªblockæ˜¯å¦å®Œæˆ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> isLastBlockComplete = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="keyword">private</span> FileEncryptionInfo fileEncryptionInfo = <span class="keyword">null</span>;</span><br></pre></td></tr></table></figure><p>LocatedBlocksä¸­æœ‰ä¸ª_LocatedBlock_çš„listï¼ŒLocatedBlockä¸­å­˜å‚¨çš„æ˜¯blockä¸å…¶å‰¯æœ¬æ‰€åœ¨dnçš„ä¿¡æ¯å’Œblockçš„å…ƒæ•°æ®ä¿¡æ¯ï¼Œæ¯”è¾ƒé‡è¦çš„å±æ€§æœ‰ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// file çš„æŸä¸ªblock</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> ExtendedBlock b;</span><br><span class="line"><span class="comment">// blockä¸­ç¬¬ä¸€ä¸ªå­—èŠ‚åœ¨fileä¸­çš„åç§»é‡</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">long</span> offset;  </span><br><span class="line"><span class="comment">// blockçš„å‰¯æœ¬æ‰€åœ¨dnæ•°ç»„</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> DatanodeInfo[] locs;</span><br><span class="line"><span class="comment">// æ¯ä¸ªå‰¯æœ¬æ‰€åœ¨çš„ç£ç›˜id</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> String[] storageIDs;</span><br><span class="line"><span class="comment">// æ¯ä¸ªå‰¯æœ¬æ‰€åœ¨ç£ç›˜çš„ç±»å‹</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StorageType[] storageTypes;</span><br><span class="line"><span class="comment">// corrupt flag is true if all of the replicas of a block are corrupt.</span></span><br><span class="line"><span class="comment">// else false. If block has few corrupt replicas, they are filtered and </span></span><br><span class="line"><span class="comment">// their locations are not part of this object</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> corrupt;</span><br><span class="line"><span class="keyword">private</span> Token&lt;BlockTokenIdentifier&gt; blockToken = <span class="keyword">new</span> Token&lt;BlockTokenIdentifier&gt;();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * List of cached datanode locations</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">private</span> DatanodeInfo[] cachedLocs;</span><br></pre></td></tr></table></figure><p>DFSClient.getLocatedBlocksæ˜¯é€šè¿‡RPCå¾—åˆ°ç»“æœçš„ï¼Œè°ƒç”¨é¡ºåºä¸º<br><em>dfsClient.getLocatedBlocks(src, 0) -&gt; getLocatedBlocks(src, start, dfsClientConf.prefetchSize) -&gt; callGetBlockLocations(namenode, src, start, length) -&gt; namenode.getBlockLocations(src, start, length) -&gt; NameNodeRpcServer.getBlockLocations(src, start, length) -&gt; namesystem.getBlockLocations(getClientMachine(), src, offset, length)</em></p><p>åœ¨æ­¤è¿‡ç¨‹ä¸­æ¶‰åŠåˆ°ä¸€ä¸ªå˜é‡_prefetchSize_ï¼Œç”±å±æ€§_dfs.client.read.prefetch.size_æ§åˆ¶ï¼Œé»˜è®¤å€¼æ˜¯<code>10 * defaultBlockSize</code>ï¼Œ__è¡¨ç¤ºåœ¨æ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµæ—¶é»˜è®¤æƒ…å†µä¸‹å°†10ä¸ªblockçš„ä¿¡æ¯æ”¾å…¥å†…å­˜ä¸­ï¼Œå¯¹è¯»çš„ä¸€ç§ä¼˜åŒ–__ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹FSNamesystem.getBlockLocationsçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">LocatedBlocks <span class="title">getBlockLocations</span><span class="params">(String clientMachine, String src,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">long</span> offset, <span class="keyword">long</span> length)</span> <span class="keyword">throws</span> AccessControlException,</span></span><br><span class="line"><span class="function">    FileNotFoundException, UnresolvedLinkException, IOException </span>&#123;</span><br><span class="line">  <span class="comment">// å¾—åˆ°æŸæ®µé•¿åº¦åŒºé—´çš„blockä¿¡æ¯</span></span><br><span class="line">  LocatedBlocks blocks = getBlockLocations(src, offset, length, <span class="keyword">true</span>, <span class="keyword">true</span>, <span class="keyword">true</span>);</span><br><span class="line">  <span class="comment">// å¯¹blockçš„å‰¯æœ¬æ‰€åœ¨çš„dnæŒ‰ç…§åˆ°clientçš„ç½‘ç»œæ‹“æ‰‘è·ç¦»è¿›è¡Œæ’åº</span></span><br><span class="line">  <span class="keyword">if</span> (blocks != <span class="keyword">null</span>) &#123;</span><br><span class="line">    blockManager.getDatanodeManager().sortLocatedBlocks(clientMachine,</span><br><span class="line">        blocks.getLocatedBlocks());</span><br><span class="line"></span><br><span class="line">    <span class="comment">// lastBlock is not part of getLocatedBlocks(), might need to sort it too</span></span><br><span class="line">    LocatedBlock lastBlock = blocks.getLastLocatedBlock();</span><br><span class="line">    <span class="keyword">if</span> (lastBlock != <span class="keyword">null</span>) &#123;</span><br><span class="line">      ArrayList&lt;LocatedBlock&gt; lastBlockList =</span><br><span class="line">          Lists.newArrayListWithCapacity(<span class="number">1</span>);</span><br><span class="line">      lastBlockList.add(lastBlock);</span><br><span class="line">      blockManager.getDatanodeManager().sortLocatedBlocks(clientMachine,</span><br><span class="line">          lastBlockList);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†æŒ‰ç…§ç½‘ç»œæ‹“æ‰‘æ’å¥½åºçš„blockè¿”å›ç»™clientç«¯</span></span><br><span class="line">  <span class="keyword">return</span> blocks;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getBlockLocationsåˆè°ƒç”¨getBlockLocationsInt()</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LocatedBlocks <span class="title">getBlockLocationsInt</span><span class="params">(String src, <span class="keyword">long</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">long</span> length, <span class="keyword">boolean</span> doAccessTime, <span class="keyword">boolean</span> needBlockToken,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> checkSafeMode)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException, UnresolvedLinkException, IOException </span>&#123;</span><br><span class="line">  <span class="comment">// æ£€éªŒoffset lengthæ˜¯å¦åˆæ³•ï¼Œä¸åˆæ³•æŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> LocatedBlocks ret = getBlockLocationsUpdateTimes(src,</span><br><span class="line">      offset, length, doAccessTime, needBlockToken);  </span><br><span class="line">  logAuditEvent(<span class="keyword">true</span>, <span class="string">&quot;open&quot;</span>, src);</span><br><span class="line">  <span class="keyword">if</span> (checkSafeMode &amp;&amp; isInSafeMode()) &#123;</span><br><span class="line">    <span class="keyword">for</span> (LocatedBlock b : ret.getLocatedBlocks()) &#123;</span><br><span class="line">      <span class="comment">// if safemode &amp; no block locations yet then throw safemodeException</span></span><br><span class="line">      <span class="keyword">if</span> ((b.getLocations() == <span class="keyword">null</span>) || (b.getLocations().length == <span class="number">0</span>)) &#123;</span><br><span class="line">        SafeModeException se = <span class="keyword">new</span> SafeModeException(</span><br><span class="line">            <span class="string">&quot;Zero blocklocations for &quot;</span> + src, safeMode);</span><br><span class="line">        <span class="keyword">if</span> (haEnabled &amp;&amp; haContext != <span class="keyword">null</span> &amp;&amp; </span><br><span class="line">            haContext.getState().getServiceState() == HAServiceState.ACTIVE) &#123;</span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RetriableException(se);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">throw</span> se;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getBlockLocationsIntä¸»è¦æ˜¯ç”¨æ¥æ£€æŸ¥SafeModeæ¨¡å¼ä¸‹ï¼Œå½“blockçš„locationsä¿¡æ¯ä¸ºnullæ—¶ï¼ŒæŠ›å‡ºsafemodeExceptionã€‚getBlockLocationsIntä¸­è°ƒç”¨getBlockLocationsUpdateTimeså¾—åˆ°LocatedBlocksï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LocatedBlocks <span class="title">getBlockLocationsUpdateTimes</span><span class="params">(<span class="keyword">final</span> String srcArg,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">long</span> offset, <span class="keyword">long</span> length, <span class="keyword">boolean</span> doAccessTime, <span class="keyword">boolean</span> needBlockToken)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> FileNotFoundException,</span></span><br><span class="line"><span class="function">    UnresolvedLinkException, IOException </span>&#123;</span><br><span class="line">  String src = srcArg;</span><br><span class="line">  FSPermissionChecker pc = getPermissionChecker();</span><br><span class="line">  <span class="comment">// æ­¤å¤„çš„pathComponentsåœ¨æ™®é€šsrc(/user/hadoop/xx)ä¸­ä¸ºnull</span></span><br><span class="line">  <span class="keyword">byte</span>[][] pathComponents = FSDirectory.getPathComponentsForReservedPath(src);</span><br><span class="line">  <span class="comment">// æ˜¯å¦éœ€è¦æ›´æ–°è®¿é—®æ—¶é—´ï¼Œå¦‚æœè¶…è¿‡äº†è®¿é—®ç²¾åº¦åˆ™è¿›è¡Œè®¿é—®æ—¶é—´çš„æ›´æ–°ï¼Œ</span></span><br><span class="line">  <span class="comment">// æ›´æ–°æ—¶éœ€è¦æ‹¿åˆ°writeLock</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> attempt = <span class="number">0</span>; attempt &lt; <span class="number">2</span>; attempt++) &#123;</span><br><span class="line">    <span class="keyword">boolean</span> isReadOp = (attempt == <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (isReadOp) &#123; <span class="comment">// first attempt is with readlock</span></span><br><span class="line">      checkOperation(OperationCategory.READ);</span><br><span class="line">      <span class="comment">// å¯é‡å…¥é”</span></span><br><span class="line">      readLock();</span><br><span class="line">    &#125;  <span class="keyword">else</span> &#123; <span class="comment">// second attempt is with  write lock</span></span><br><span class="line">      checkOperation(OperationCategory.WRITE);</span><br><span class="line">      writeLock(); <span class="comment">// writelock is needed to set accesstime</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      src = resolvePath(src, pathComponents);</span><br><span class="line">      <span class="keyword">if</span> (isReadOp) &#123;</span><br><span class="line">        checkOperation(OperationCategory.READ);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        checkOperation(OperationCategory.WRITE);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (isPermissionEnabled) &#123;</span><br><span class="line">        checkPathAccess(pc, src, FsAction.READ);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// if the namenode is in safemode, then do not update access time</span></span><br><span class="line">      <span class="keyword">if</span> (isInSafeMode()) &#123;</span><br><span class="line">        doAccessTime = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å°†src pathè§£æä¸ºINodes infomation</span></span><br><span class="line">      <span class="keyword">final</span> INodesInPath iip = dir.getINodesInPath(src, <span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">final</span> INode[] inodes = iip.getINodes();</span><br><span class="line">      <span class="comment">// å°†pathä¸­çš„æ–‡ä»¶åINodeè½¬åŒ–ä¸ºINodeFile</span></span><br><span class="line">      <span class="keyword">final</span> INodeFile inode = INodeFile.valueOf(</span><br><span class="line">          inodes[inodes.length - <span class="number">1</span>], src);</span><br><span class="line">      <span class="keyword">if</span> (isPermissionEnabled) &#123;</span><br><span class="line">        checkUnreadableBySuperuser(pc, inode, iip.getPathSnapshotId());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!iip.isSnapshot() <span class="comment">//snapshots are readonly, so don&#x27;t update atime.</span></span><br><span class="line">          &amp;&amp; doAccessTime &amp;&amp; isAccessTimeSupported()) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">long</span> now = now();</span><br><span class="line">        <span class="comment">// å½“å‰çš„è®¿é—®æ—¶é—´ä¸ä¸Šæ¬¡è®¿é—®æ—¶é—´è¶…è¿‡äº†è®¿é—®æ—¶é—´ç²¾åº¦</span></span><br><span class="line">        <span class="comment">// è¿›è¡Œè®¿é—®æ—¶é—´çš„æ›´æ–°</span></span><br><span class="line">        <span class="keyword">if</span> (now &gt; inode.getAccessTime() + getAccessTimePrecision()) &#123;</span><br><span class="line">          <span class="comment">// if we have to set access time but we only have the readlock, then</span></span><br><span class="line">          <span class="comment">// restart this entire operation with the writeLock.</span></span><br><span class="line">          <span class="keyword">if</span> (isReadOp) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">boolean</span> changed = dir.setTimes(inode, -<span class="number">1</span>, now, <span class="keyword">false</span>,</span><br><span class="line">                  iip.getLatestSnapshotId());</span><br><span class="line">          <span class="keyword">if</span> (changed) &#123;</span><br><span class="line">            getEditLog().logTimes(src, -<span class="number">1</span>, now);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å½“å‰src pathä¸æ˜¯å¿«ç…§åˆ™è®¡ç®—æ–‡ä»¶çš„é•¿åº¦æ—¶ä¸åŒ…æ‹¬æœ€åä¸€ä¸ªæ­£åœ¨æ„å»ºçš„block</span></span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> fileSize = iip.isSnapshot() ?</span><br><span class="line">          inode.computeFileSize(iip.getPathSnapshotId())</span><br><span class="line">          : inode.computeFileSizeNotIncludingLastUcBlock();</span><br><span class="line">      <span class="keyword">boolean</span> isUc = inode.isUnderConstruction();</span><br><span class="line">      <span class="keyword">if</span> (iip.isSnapshot()) &#123;</span><br><span class="line">        <span class="comment">// if src indicates a snapshot file, we need to make sure the returned</span></span><br><span class="line">        <span class="comment">// blocks do not exceed the size of the snapshot file.</span></span><br><span class="line">        length = Math.min(length, fileSize - offset);</span><br><span class="line">        isUc = <span class="keyword">false</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> FileEncryptionInfo feInfo =</span><br><span class="line">        FSDirectory.isReservedRawName(srcArg) ?</span><br><span class="line">        <span class="keyword">null</span> : dir.getFileEncryptionInfo(inode, iip.getPathSnapshotId(),</span><br><span class="line">            iip);</span><br><span class="line">      <span class="comment">// INodeFileçš„blocksé€šè¿‡blockManageråˆ›å»ºLocatedBlocks</span></span><br><span class="line">      <span class="keyword">final</span> LocatedBlocks blocks =</span><br><span class="line">        blockManager.createLocatedBlocks(inode.getBlocks(), fileSize,</span><br><span class="line">          isUc, offset, length, needBlockToken, iip.isSnapshot(), feInfo);</span><br><span class="line">      <span class="comment">// Set caching information for the located blocks.</span></span><br><span class="line">      <span class="keyword">for</span> (LocatedBlock lb: blocks.getLocatedBlocks()) &#123;</span><br><span class="line">        cacheManager.setCachedLocations(lb);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> blocks;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (isReadOp) &#123;</span><br><span class="line">        readUnlock();</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        writeUnlock();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>; <span class="comment">// can never reach here</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getBlockLocationsUpdateTimesä¸­æœ‰ä¸ªforå¾ªç¯ï¼Œåˆæ¬¡è¿›å…¥å¾ªç¯attemptä¸º0ï¼Œå¾—åˆ°readLockï¼Œå¦‚æœæ”¯æŒè®¿é—®æ—¶é—´çš„è®¾ç½®ï¼Œåˆ™å½“å‰çš„è®¿é—®æ—¶é—´ä¸ä¸Šæ¬¡çš„è®¿é—®æ—¶é—´å·®è¶…è¿‡äº†HDFSè®¾ç½®çš„è®¿é—®æ—¶é—´ç²¾åº¦(<em>dfs.namenode.accesstime.precision</em>)ï¼Œåˆ™è¿›è¡Œè®¿é—®æ—¶é—´çš„æ›´æ–°ï¼Œæ—¶é—´çš„æ›´æ–°éœ€è¦å¾—åˆ°writeLockï¼Œå¦‚æœå½“å‰æ˜¯readLockåˆ™continueï¼Œè¿›è¡Œç¬¬äºŒæ¬¡å¾ªç¯æ‹¿åˆ°writeLockè¿›è¡Œæ›´æ–°ã€‚ï¼ˆ<strong>å¯ä»¥æ ¹æ®fileçš„è®¿é—®æ—¶é—´åˆ¤æ–­æ•°æ®çš„å†·çƒ­</strong>ï¼‰</p><p>é€šè¿‡(FSDirectory)dir.getINodesInPathå¾—åˆ°srcçš„INodeä¿¡æ¯ï¼Œç„¶åå°†INodeè½¬åŒ–ä¸ºINodeFile(INodeFileå¯¹åº”ä¸€ä¸ªæ–‡ä»¶)ã€‚ç„¶åé€šè¿‡blockManager.createLocatedBlockså°†INodeFileä¸­çš„Blockè½¬åŒ–ä¸ºLocatedBlocks</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> LocatedBlocks <span class="title">createLocatedBlocks</span><span class="params">(<span class="keyword">final</span> BlockInfo[] blocks,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> fileSizeExcludeBlocksUnderConstruction,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">boolean</span> isFileUnderConstruction, <span class="keyword">final</span> <span class="keyword">long</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> length, <span class="keyword">final</span> <span class="keyword">boolean</span> needBlockToken,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">boolean</span> inSnapshot, FileEncryptionInfo feInfo)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> namesystem.hasReadLock();</span><br><span class="line">  <span class="keyword">if</span> (blocks == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (blocks.length == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocatedBlocks(<span class="number">0</span>, isFileUnderConstruction,</span><br><span class="line">        Collections.&lt;LocatedBlock&gt;emptyList(), <span class="keyword">null</span>, <span class="keyword">false</span>, feInfo);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot;blocks = &quot;</span> + java.util.Arrays.asList(blocks));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> AccessMode mode = needBlockToken? AccessMode.READ: <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// ä»blocksä¸­å°†offsetåˆ°lengthä¹‹é—´çš„blockåˆ›å»ºä¸ºLocateBlock</span></span><br><span class="line">    <span class="comment">// è¿™é‡Œæ˜¯LocateBlockä¸æ˜¯LocateBlocksï¼Œæ³¨æ„åŒºåˆ†ï¼ŒLocateBlocksé‡Œæœ‰ä¸ªLocateBlockçš„list</span></span><br><span class="line">    <span class="keyword">final</span> List&lt;LocatedBlock&gt; locatedblocks = createLocatedBlockList(</span><br><span class="line">        blocks, offset, length, Integer.MAX_VALUE, mode);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> LocatedBlock lastlb;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">boolean</span> isComplete;</span><br><span class="line">    <span class="keyword">if</span> (!inSnapshot) &#123;</span><br><span class="line">      <span class="keyword">final</span> BlockInfo last = blocks[blocks.length - <span class="number">1</span>];</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">long</span> lastPos = last.isComplete()?</span><br><span class="line">          fileSizeExcludeBlocksUnderConstruction - last.getNumBytes()</span><br><span class="line">          : fileSizeExcludeBlocksUnderConstruction;</span><br><span class="line">      <span class="comment">// å°†æ–‡ä»¶çš„æœ€åä¸€ä¸ªblockåˆ›å»ºä¸ºLocateBlock</span></span><br><span class="line">      <span class="comment">// è¿™é‡Œæ˜¯LocateBlockä¸æ˜¯LocateBlocksï¼Œæ³¨æ„åŒºåˆ†ï¼ŒLocateBlocksé‡Œæœ‰ä¸ªLocateBlockçš„list</span></span><br><span class="line">      lastlb = createLocatedBlock(last, lastPos, mode);</span><br><span class="line">      isComplete = last.isComplete();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      lastlb = createLocatedBlock(blocks,</span><br><span class="line">          fileSizeExcludeBlocksUnderConstruction, mode);</span><br><span class="line">      isComplete = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å®ä¾‹åŒ–LocateBlockså¯¹è±¡</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocatedBlocks(</span><br><span class="line">        fileSizeExcludeBlocksUnderConstruction, isFileUnderConstruction,</span><br><span class="line">        locatedblocks, lastlb, isComplete, feInfo);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createLocatedBlocksä¸­æœ‰<code>createLocatedBlockList</code>å’Œ<code>createLocatedBlock</code>ä¸¤ä¸ªæ–¹æ³•ï¼Œçœ‹åå­—å°±å¯ä»¥çŒœåˆ°è¿™ä¸¤ä¸ªæ–¹æ³•ä¸€ä¸ªè¿”å›å·²LocatedBlock Listï¼Œä¸€ä¸ªåªè¿”å›ä¸€ä¸ªLocatedBlockã€‚å…¶æºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;LocatedBlock&gt; <span class="title">createLocatedBlockList</span><span class="params">(<span class="keyword">final</span> BlockInfo[] blocks,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">long</span> offset, <span class="keyword">final</span> <span class="keyword">long</span> length, <span class="keyword">final</span> <span class="keyword">int</span> nrBlocksToReturn,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> AccessMode mode)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> curBlk = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> curPos = <span class="number">0</span>, blkSize = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> nrBlocks = (blocks[<span class="number">0</span>].getNumBytes() == <span class="number">0</span>) ? <span class="number">0</span> : blocks.length;</span><br><span class="line">  <span class="comment">// æ‰¾åˆ°offsetæ‰€åœ¨çš„block</span></span><br><span class="line">  <span class="keyword">for</span> (curBlk = <span class="number">0</span>; curBlk &lt; nrBlocks; curBlk++) &#123;</span><br><span class="line">    blkSize = blocks[curBlk].getNumBytes();</span><br><span class="line">    <span class="keyword">assert</span> blkSize &gt; <span class="number">0</span> : <span class="string">&quot;Block of size 0&quot;</span>;</span><br><span class="line">    <span class="keyword">if</span> (curPos + blkSize &gt; offset) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    curPos += blkSize;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (nrBlocks &gt; <span class="number">0</span> &amp;&amp; curBlk == nrBlocks)   <span class="comment">// offset &gt;= end of file</span></span><br><span class="line">    <span class="keyword">return</span> Collections.&lt;LocatedBlock&gt;emptyList();</span><br><span class="line">  <span class="comment">// æ­¤å¤„çš„lengthé»˜è®¤æ˜¯128*10ï¼Œç”±å±æ€§dfs.client.read.prefetch.sizeæ§åˆ¶</span></span><br><span class="line">  <span class="keyword">long</span> endOff = offset + length;</span><br><span class="line">  List&lt;LocatedBlock&gt; results = <span class="keyword">new</span> ArrayList&lt;LocatedBlock&gt;(blocks.length);</span><br><span class="line">  <span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="comment">// è°ƒç”¨createLocatedBlock create LocatedBlock</span></span><br><span class="line">    results.add(createLocatedBlock(blocks[curBlk], curPos, mode));</span><br><span class="line">    curPos += blocks[curBlk].getNumBytes();</span><br><span class="line">    curBlk++;</span><br><span class="line">  &#125; <span class="keyword">while</span> (curPos &lt; endOff </span><br><span class="line">        &amp;&amp; curBlk &lt; blocks.length</span><br><span class="line">        &amp;&amp; results.size() &lt; nrBlocksToReturn);</span><br><span class="line">  <span class="keyword">return</span> results;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>createLocatedBlockListå†…éƒ¨ä¹Ÿæ˜¯è°ƒç”¨createLocatedBlockå¾—åˆ°LocatedBlockç„¶åæ”¾å…¥listä¸­ï¼ŒcreateLocatedBlockæºç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> LocatedBlock <span class="title">createLocatedBlock</span><span class="params">(<span class="keyword">final</span> BlockInfo blk, <span class="keyword">final</span> <span class="keyword">long</span> pos,</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="keyword">final</span> BlockTokenSecretManager.AccessMode mode)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> LocatedBlock lb = createLocatedBlock(blk, pos);</span><br><span class="line">  <span class="keyword">if</span> (mode != <span class="keyword">null</span>) &#123;</span><br><span class="line">    setBlockToken(lb, mode);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> lb;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> LocatedBlock <span class="title">createLocatedBlock</span><span class="params">(<span class="keyword">final</span> BlockInfo blk, <span class="keyword">final</span> <span class="keyword">long</span> pos</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">   <span class="comment">// blk æ­£åœ¨æ„å»º</span></span><br><span class="line">  <span class="keyword">if</span> (blk <span class="keyword">instanceof</span> BlockInfoUnderConstruction) &#123;</span><br><span class="line">    <span class="keyword">if</span> (blk.isComplete()) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">          <span class="string">&quot;blk instanceof BlockInfoUnderConstruction &amp;&amp; blk.isComplete()&quot;</span></span><br><span class="line">          + <span class="string">&quot;, blk=&quot;</span> + blk);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> BlockInfoUnderConstruction uc = (BlockInfoUnderConstruction)blk;</span><br><span class="line">    <span class="keyword">final</span> DatanodeStorageInfo[] storages = uc.getExpectedStorageLocations();</span><br><span class="line">    <span class="keyword">final</span> ExtendedBlock eb = <span class="keyword">new</span> ExtendedBlock(namesystem.getBlockPoolId(), blk);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> LocatedBlock(eb, storages, pos, <span class="keyword">false</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// get block locations</span></span><br><span class="line">  <span class="comment">// è®¡ç®—srcä¸­Blockçš„å‰¯æœ¬ä¸­æ— æ³•è¯»å–è¯¥Blockçš„DatanodeèŠ‚ç‚¹æ•°</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numCorruptNodes = countNodes(blk).corruptReplicas();</span><br><span class="line">  <span class="comment">// è®¡ç®—FSNamesystemåœ¨å†…å­˜ä¸­ç»´æŠ¤çš„Block=&gt;Datanodeæ˜ å°„çš„åˆ—è¡¨ä¸­ï¼Œæ— æ³•è¯»å–è¯¥Blockçš„DatanodeèŠ‚ç‚¹æ•°</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numCorruptReplicas = corruptReplicas.numCorruptReplicas(blk);</span><br><span class="line">  <span class="keyword">if</span> (numCorruptNodes != numCorruptReplicas) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Inconsistent number of corrupt replicas for &quot;</span></span><br><span class="line">        + blk + <span class="string">&quot; blockMap has &quot;</span> + numCorruptNodes</span><br><span class="line">        + <span class="string">&quot; but corrupt replicas map has &quot;</span> + numCorruptReplicas);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è®¡ç®—srcä¸­Blockå­˜å‚¨çš„DatanodeèŠ‚ç‚¹æ•° </span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numNodes = blocksMap.numNodes(blk);</span><br><span class="line">  <span class="comment">// å¦‚æœæŸåçš„æ•°å’Œå‰¯æœ¬æ•°ä¸€æ ·ï¼Œåˆ™æ ‡è¯†æ­¤blockä¸ºcorrupt</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">boolean</span> isCorrupt = numCorruptNodes == numNodes;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numMachines = isCorrupt ? numNodes: numNodes - numCorruptNodes;</span><br><span class="line">  <span class="keyword">final</span> DatanodeStorageInfo[] machines = <span class="keyword">new</span> DatanodeStorageInfo[numMachines];</span><br><span class="line">  <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (numMachines &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">for</span>(DatanodeStorageInfo storage : blocksMap.getStorages(blk)) &#123;</span><br><span class="line">      <span class="keyword">final</span> DatanodeDescriptor d = storage.getDatanodeDescriptor();</span><br><span class="line">      <span class="keyword">final</span> <span class="keyword">boolean</span> replicaCorrupt = corruptReplicas.isReplicaCorrupt(blk, d);</span><br><span class="line">      <span class="comment">// å¦‚æœæŸä¸ªblockçš„å‰¯æœ¬corruptï¼Œåˆ™ä¸å°†æ­¤å‰¯æœ¬æ”¾å…¥machinesä¸­</span></span><br><span class="line">      <span class="comment">// åªæœ‰åœ¨blockæ˜¯corruptæ—¶ï¼Œæ‰å°†æŸåçš„å‰¯æœ¬æ”¾å…¥machines</span></span><br><span class="line">      <span class="keyword">if</span> (isCorrupt || (!replicaCorrupt))</span><br><span class="line">        machines[j++] = storage;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">assert</span> j == machines.length :</span><br><span class="line">    <span class="string">&quot;isCorrupt: &quot;</span> + isCorrupt + </span><br><span class="line">    <span class="string">&quot; numMachines: &quot;</span> + numMachines +</span><br><span class="line">    <span class="string">&quot; numNodes: &quot;</span> + numNodes +</span><br><span class="line">    <span class="string">&quot; numCorrupt: &quot;</span> + numCorruptNodes +</span><br><span class="line">    <span class="string">&quot; numCorruptRepls: &quot;</span> + numCorruptReplicas;</span><br><span class="line">  <span class="keyword">final</span> ExtendedBlock eb = <span class="keyword">new</span> ExtendedBlock(namesystem.getBlockPoolId(), blk);</span><br><span class="line">  <span class="comment">// å®ä¾‹åŒ–ä¸€ä¸ªLocatedBlockï¼ŒisCorruptæ ‡è¯†blockæ˜¯å¦corrupt</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> LocatedBlock(eb, machines, pos, isCorrupt);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸Šè¿°æ–¹æ³•æ˜¯åœ¨BlockManagerç±»ä¸­ï¼Œç±»ä¸­æœ‰ä¸¤ä¸ªå±æ€§blocksMapå’ŒcorruptReplicasï¼Œç®€å•ä»‹ç»ä¸‹è¿™ä¸¤ä¸ªå±æ€§çš„ä½œç”¨ï¼š<br><code>blocksMap</code>æ˜¯<code>BlocksMap</code>çš„å®ä¾‹ï¼Œå…¶ä»£è¡¨äº†Blockâ†’{INodeã€datanodes}çš„æ˜ å°„ã€‚å…·ä½“ä»£è¡¨äº†æ¯ä¸€ä¸ªBlockåœ¨å“ªä¸€ä¸ªDataNodeä¸Šå­˜å‚¨ï¼Œå…¶å†…éƒ¨æœ‰ä¸ªBlockInfoå¯¹è±¡ã€‚<br><code>CorruptReplicasMap corruptReplicas = new CorruptReplicasMap()</code>ï¼ŒcorruptReplicasæ˜¯CorruptReplicasMapçš„ä¸€ä¸ªå®ä¾‹ã€‚<strong>corruptReplicasä¿å­˜äº†æ–‡ä»¶ç³»ç»Ÿä¸­æ‰€æœ‰çš„æŸåblock</strong>ã€‚æ³¨æ„ï¼Œåªæœ‰ä¸€ä¸ªblockçš„æ‰€æœ‰å¤‡ä»½å­˜å‚¨éƒ½æŸåæ‰è®¤ä¸ºè¯¥blockæ˜¯æŸåçš„ã€‚å…¶ä¿å­˜çš„å½¢å¼å¦‚ä¸‹ï¼Œä¸€ä¸ªblockå’Œæ‰€æœ‰ä¿å­˜è¯¥blockçš„datanodeï¼ŒBlockâ†’TreeSet<DatanodeDescriptor></p><p>å¾—åˆ°LocatedBlocksä¹‹åï¼Œå›åˆ°FSNamesystem.getBlockLocationsä¸­å¯¹blockçš„locationsæ ¹æ®clientçš„ç½‘ç»œæ‹“æ‰‘è·ç¦»è¿›è¡Œæ’åºï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sortLocatedBlocks</span><span class="params">(<span class="keyword">final</span> String targethost,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> List&lt;LocatedBlock&gt; locatedblocks)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//sort the blocks</span></span><br><span class="line">  <span class="comment">// As it is possible for the separation of node manager and datanode, </span></span><br><span class="line">  <span class="comment">// here we should get node but not datanode only .</span></span><br><span class="line">  Node client = getDatanodeByHost(targethost);</span><br><span class="line">  <span class="keyword">if</span> (client == <span class="keyword">null</span>) &#123;</span><br><span class="line">    List&lt;String&gt; hosts = <span class="keyword">new</span> ArrayList&lt;String&gt; (<span class="number">1</span>);</span><br><span class="line">    hosts.add(targethost);</span><br><span class="line">    String rName = dnsToSwitchMapping.resolve(hosts).get(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (rName != <span class="keyword">null</span>)</span><br><span class="line">      client = <span class="keyword">new</span> NodeBase(rName + NodeBase.PATH_SEPARATOR_STR + targethost);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  Comparator&lt;DatanodeInfo&gt; comparator = avoidStaleDataNodesForRead ?</span><br><span class="line">      <span class="keyword">new</span> DFSUtil.DecomStaleComparator(staleInterval) : </span><br><span class="line">      DFSUtil.DECOM_COMPARATOR;</span><br><span class="line">      </span><br><span class="line">  <span class="keyword">for</span> (LocatedBlock b : locatedblocks) &#123;</span><br><span class="line">    DatanodeInfo[] di = b.getLocations();</span><br><span class="line">    <span class="comment">// å°†ä¸‹çº¿çš„æˆ–è€…è¿‡æ—¶çš„dnæ”¾åˆ°æœ€å</span></span><br><span class="line">    Arrays.sort(di, comparator);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">int</span> lastActiveIndex = di.length - <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (lastActiveIndex &gt; <span class="number">0</span> &amp;&amp; isInactive(di[lastActiveIndex])) &#123;</span><br><span class="line">        --lastActiveIndex;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> activeLen = lastActiveIndex + <span class="number">1</span>;      </span><br><span class="line">    networktopology.sortByDistance(client, b.getLocations(), activeLen);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹blockçš„locationsè¿›è¡Œæ’åºåˆ†ä¸ºä¸¤æ­¥ï¼Œé¦–å…ˆå¯¹locationsä¸­çš„çŠ¶æ€è¿›è¡Œæ’åºï¼Œå°†ä¸‹çº¿çš„æˆ–è€…è¿‡æ—¶çš„dnæ’åœ¨æœ€åã€‚<br>Blockæ‰€åœ¨çš„Datanodeåˆ—è¡¨ä¸­ï¼Œå¦‚æœå…¶ä¸­æŸä¸ªDatanodeåœ¨æŒ‡å®šçš„æ—¶é—´å†…æ²¡æœ‰å‘Namenodeå‘é€heartbeatï¼ˆé»˜è®¤ç”±å¸¸é‡DFSConfigKeys.DFS_NAMENODE_STALE_DATANODE_INTERVAL_DEFAULTå®šä¹‰ï¼Œé»˜è®¤å€¼ä¸º30sï¼‰ï¼Œåˆ™è¯¥Datanodeçš„çŠ¶æ€å³ä¸ºSTALEï¼Œå…·æœ‰è¯¥çŠ¶æ€çš„Datanodeå¯¹åº”çš„Blockæ’åœ¨åé¢</p><p>ç„¶åæŒ‰ç…§ç½‘ç»œæ‹“æ‰‘è¿›è¡Œæ’åºï¼Œæ–¹æ³•ä¸ºsortByDistanceï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sortByDistance</span><span class="params">(Node reader, Node[] nodes, <span class="keyword">int</span> activeLen)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** Sort weights for the nodes array */</span></span><br><span class="line">  <span class="keyword">int</span>[] weights = <span class="keyword">new</span> <span class="keyword">int</span>[activeLen];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;activeLen; i++) &#123;</span><br><span class="line">  <span class="comment">// 0 is local, 1 is same rack, 2 is off rack</span></span><br><span class="line">    weights[i] = getWeight(reader, nodes[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Add weight/node pairs to a TreeMap to sort</span></span><br><span class="line">  <span class="comment">// TreeMap æŒ‰ç…§keyè¿›è¡Œæ’åº</span></span><br><span class="line">  TreeMap&lt;Integer, List&lt;Node&gt;&gt; tree = <span class="keyword">new</span> TreeMap&lt;Integer, List&lt;Node&gt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;activeLen; i++) &#123;</span><br><span class="line">    <span class="keyword">int</span> weight = weights[i];</span><br><span class="line">    Node node = nodes[i];</span><br><span class="line">    List&lt;Node&gt; list = tree.get(weight);</span><br><span class="line">    <span class="keyword">if</span> (list == <span class="keyword">null</span>) &#123;</span><br><span class="line">      list = Lists.newArrayListWithExpectedSize(<span class="number">1</span>);</span><br><span class="line">      tree.put(weight, list);</span><br><span class="line">    &#125;</span><br><span class="line">    list.add(node);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> idx = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (List&lt;Node&gt; list: tree.values()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (list != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// å¯¹TreeMapä¸­valueè¿›è¡Œshuffleï¼Œä»¥å…äº§ç”Ÿçƒ­ç‚¹</span></span><br><span class="line">      <span class="comment">// é»˜è®¤æƒ…å†µä¸‹listé‡Œåªæœ‰ä¸€ä¸ªnodeï¼Œå½“å‰¯æœ¬æ•°å¢å¤šï¼Œ</span></span><br><span class="line">      <span class="comment">// å¯èƒ½åœ¨åŒä¸€rackä¸Šæœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œåˆ™æ­¤æ—¶listä¸­å°±æœ‰ä¸¤ä¸ªnode</span></span><br><span class="line">      Collections.shuffle(list, r);</span><br><span class="line">      <span class="keyword">for</span> (Node n: list) &#123;</span><br><span class="line">        nodes[idx] = n;</span><br><span class="line">        idx++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Preconditions.checkState(idx == activeLen,</span><br><span class="line">      <span class="string">&quot;Sorted the wrong number of nodes!&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åå°†æ’å¥½åºçš„LocatedBlocksè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œåˆ™open fileçš„è¿‡ç¨‹ç»“æŸã€‚ä¸‹é¢å°±æ˜¯[read fileé˜¶æ®µ](<a href="http://bigdatadecode.top/HDFS">http://bigdatadecode.top/HDFS</a> readè§£æ2ä¹‹ä»æ–‡ä»¶æµä¸­read.html)ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> read </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFS HAç›¸å…³çš„å‡ ä¸ªé—®é¢˜å’Œç¤ºä¾‹åœºæ™¯</title>
      <link href="/HDFS%20HA%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98%E5%92%8C%E7%A4%BA%E4%BE%8B%E5%9C%BA%E6%99%AF.html"/>
      <url>/HDFS%20HA%E7%9B%B8%E5%85%B3%E7%9A%84%E5%87%A0%E4%B8%AA%E9%97%AE%E9%A2%98%E5%92%8C%E7%A4%BA%E4%BE%8B%E5%9C%BA%E6%99%AF.html</url>
      
        <content type="html"><![CDATA[<h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><ol><li><p>ä½•æ—¶ä¼šè§¦å‘ä¸»å¤‡é€‰ä¸¾<br>å½“active nnçš„HealthMonitoræ£€æµ‹åˆ°activeçŠ¶æ€ä¸º_SERVICE_UNHEALTHY_å’Œ_SERVICE_NOT_RESPONDING_æ—¶ï¼Œactiveçš„ActiveStandbyElectorä¼šquitElectionï¼Œ__quitElectionå°±æ˜¯å…³é—­zkè¿æ¥ï¼ˆzkå…³é—­è¿æ¥ä¹‹åï¼Œç›¸åº”çš„watcherä¹Ÿå¤±å»ä½œç”¨ï¼‰__ï¼ŒZKFailoverControllerä¼šä¸»åŠ¨åˆ é™¤å½“å‰åœ¨Zookeeperä¸Šå»ºç«‹çš„ä¸´æ—¶èŠ‚ç‚¹/hadoop-ha/${dfs.nameservices}/ActiveStandbyElectorLockï¼Œæ­¤æ—¶activeçš„zkå·²ç»å…³é—­è¿æ¥ï¼Œwatcherå·²æ— æ³•ç›‘å¬åˆ°_DeleteNode_äº‹ä»¶ï¼Œstandbyä¸Šçš„watcheråˆ™å¯ä»¥ç›‘å¬åˆ°_DeleteNode_äº‹ä»¶ï¼Œä¼šé©¬ä¸Šå†æ¬¡è¿›å…¥åˆ°åˆ›å»º/hadoop-ha/${dfs.nameservices}/ActiveStandbyElectorLockèŠ‚ç‚¹çš„æµç¨‹ï¼Œå¦‚æœåˆ›å»ºæˆåŠŸï¼Œè¿™ä¸ªæœ¬æ¥å¤„äºStandbyçŠ¶æ€çš„NameNode å°±é€‰ä¸¾ä¸ºä¸»NameNodeå¹¶éšåå¼€å§‹åˆ‡æ¢ä¸ºActiveçŠ¶æ€ã€‚</p></li><li><p>activeæ‰€åœ¨çš„ä¸»æœºå®•æœº(<em>ActiveNNæ–­ç”µï¼Œç½‘ç»œå¼‚å¸¸ï¼Œè´Ÿè½½è¿‡é«˜æˆ–è€…æœºå™¨å‡ºç°å¼‚å¸¸æ— æ³•è¿æ¥</em>)ï¼Œstandbyèƒ½å¦åˆ‡æ¢æˆåŠŸï¼Œæ€ä¹ˆé…ç½®<br>activeå®•æœºï¼Œactiveä¸Šçš„zkfcä¹Ÿé€€å‡ºï¼Œå¯¼è‡´ä¸zkçš„è¿æ¥å…³é—­ï¼Œä¸´æ—¶èŠ‚ç‚¹ActiveStandbyElectorLockè¢«åˆ é™¤ï¼Œä½†ActiveBreadCrumbæ²¡æœ‰åˆ é™¤ï¼Œstandbyä¸Šçš„ActiveStandbyElectoræ£€æµ‹åˆ°èŠ‚ç‚¹ActiveStandbyElectorLockè¢«åˆ é™¤ï¼Œè¿›è¡ŒæŠ¢é”ï¼Œå»åˆ›å»ºèŠ‚ç‚¹ActiveStandbyElectorLockï¼Œåˆ›å»ºæˆåŠŸä¹‹åï¼Œè¿›è¡ŒçŠ¶æ€åˆ‡æ¢ï¼Œè°ƒç”¨becomeActiveï¼Œ_å› ä¸ºActiveBreadCrumbæ²¡æœ‰è¢«åˆ é™¤_ï¼Œä¸ºäº†é˜²æ­¢è„‘è£‚ä¼šè°ƒç”¨fenceOldActiveå»fenceï¼Œå¦‚æœfenceæˆåŠŸåˆ™è¿›è¡ŒçŠ¶æ€çš„å†™å…¥ï¼ŒçŠ¶æ€åˆ‡æ¢æˆåŠŸã€‚_ç”±æ­¤å¯è§fenceçš„æˆå†³å®šäº†åˆ‡æ¢æ˜¯å¦æˆåŠŸ_ï¼Œfenceæ–¹æ³•æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯sshfenceï¼Œå¦ä¸€ä¸ªæ˜¯shellã€‚å½“activeå®•æœºï¼Œåˆ™sshä¸é€šï¼Œsshfenceä¼šfenceå¤±è´¥ï¼Œ__ä¹Ÿå°±æ˜¯è¯´å¦‚æœåªé…ç½®äº†sshfenceæ–¹æ³•ï¼Œåˆ™æ— æ³•åˆ‡æ¢æˆåŠŸ__ã€‚__å½“activeå®•æœºï¼Œæƒ³åˆ‡æ¢æˆåŠŸéœ€è¦é…ç½®shellæ–¹æ³•ï¼Œshellæ–¹æ³•å¯ä»¥è¯´æ˜¯æ¥å¼¥è¡¥activeå®•æœºçš„__ã€‚_æ‰€ä»¥åœ¨é…ç½®fence methodçš„æ—¶å€™æœ€å¥½é…ç½®ä¸¤ä¸ªæ–¹æ³•_ã€‚</p></li><li><p>activeå‘ç”Ÿå¼‚å¸¸ï¼Œactiveä¸Šçš„zkfcä¼šä¸ä¼šè¿›è¡Œfence<br>zkfcè¿›è¡Œfenceçš„æ—¶å€™æ˜¯åœ¨æ‹¿åˆ°createLockä¹‹åï¼Œnnè¿›è¡ŒçŠ¶æ€è½¬æ¢æ—¶æ‰è¿›è¡Œfenceã€‚activeå‘ç”Ÿå¼‚å¸¸ï¼Œå…¶ä¸Šçš„zkfcä¸ä¼šè¿›è¡Œfenceï¼Œå› ä¸ºhealthmonitoræ£€æµ‹åˆ°å¼‚å¸¸ä¹‹åï¼Œä¼šè®©å…¶é€€å‡ºé€‰ä¸¾ï¼Œä¹Ÿå°±æ˜¯å…³é—­zkè¿æ¥ï¼Œzkè¿æ¥å…³é—­ä¹‹åï¼Œæ³¨å†Œçš„watcherä¹Ÿæ¶ˆå¤±ï¼Œä¹Ÿå°±æ— æ³•ç›‘å¬åˆ°èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œä¹Ÿå°±ä¸ä¼šå»æŠ¢é”ï¼Œæ›´ä¸ä¼šå»fenceã€‚</p></li><li><p>SSHFenceæ˜¯ä»standby sshåˆ°activeè¿›è¡Œfenceï¼Œé‚£ShellFenceæ˜¯æ€ä¹ˆæçš„ï¼Ÿ<br><strong>åœ¨å“ªæ‰§è¡Œï¼Œè°è°ƒç”¨çš„ï¼Œæ€ä¹ˆè¿›è¡Œkillæ‰active</strong><br>shell fenceæ˜¯æ€ä¹ˆåˆ°åŸactiveæœºå™¨ä¸Šæ‰§è¡Œçš„ï¼Ÿ<br>shell fence ä¸ä¼šåˆ°åŸactiveä¸Šæ‰§è¡Œactivekillæ‰ï¼Œshellå¯ä»¥æ˜¯ä¸€ä¸ªç©ºå‘½ä»¤ä½¿å…¶å•çº¯çš„æ­£å¸¸é€€å‡ºï¼Œç„¶åstandbyä¼šè¿›è¡ŒçŠ¶æ€è½¬æ¢ã€‚ä½†æ˜¯æˆ‘ç–‘æƒ‘çš„æ˜¯shellåªæ˜¯å°†standbyè¿›è¡Œçš„çŠ¶æ€è½¬æ¢ï¼Œä½†åŸactiveå‘¢ï¼ŸåŸactiveæ£€æµ‹åˆ°å¼‚å¸¸ï¼Œé€€å‡ºé€‰ä¸¾å…³é—­äº†zkè¿æ¥ï¼Œåªæœ‰HMåœ¨ä¸æ–­çš„æ£€æµ‹nnçš„çŠ¶æ€ï¼Œå½“æ£€æµ‹åˆ°healthyä¹‹åï¼Œé‡æ–°å»ºç«‹zkè¿æ¥ï¼Œç„¶åwatcheræ•è·åˆ°è¿æ¥äº‹ä»¶ï¼Œ<em>è°ƒç”¨monitorActiveStatusè¿›è¡ŒçŠ¶æ€çš„æ£€æŸ¥è¿›è¡Œå˜æ¢ï¼Œæ­¤æ—¶åŸactiveå˜ä¸ºstandby</em>ï¼›<em>ä½†æ˜¯å‡å¦‚åŸactiveä¸€ç›´æ˜¯ä¸å¥åº·çš„å‘¢ï¼Ÿé‚£ä¹ˆåŸactiveæ˜¯æ€ä¹ˆè¿›è¡ŒçŠ¶æ€è½¬æ¢çš„</em>ï¼Ÿ</p></li><li><p>fence methodéœ€è¦æ€ä¹ˆé…ç½®ï¼Œå¦‚æœéœ€è¦é…ç½®ä¸¤ä¸ªæ–¹æ³•ï¼Œé‚£ä¸ºä»€ä¹ˆä¸åªé…ç½®shell menthod</p></li><li><p>ä¸€èˆ¬å¯¼è‡´NameNodeåˆ‡æ¢çš„åŸå› <br>nnä¸å¥åº·ï¼ˆæ²¡æœ‰ç£ç›˜ç©ºé—´ï¼‰ï¼Œrpcæ²¡æœ‰å“åº”ï¼ˆcallqueueå æ»¡ï¼‰ï¼Œ<br>éšç€é›†ç¾¤è§„æ¨¡çš„å˜å¤§å’Œä»»åŠ¡é‡å˜å¤šï¼ŒNameNodeçš„å‹åŠ›ä¼šè¶Šæ¥è¶Šå¤§ï¼Œä¸€äº›é»˜è®¤å‚æ•°å·²ç»ä¸èƒ½æ»¡è¶³é›†ç¾¤çš„æ—¥å¸¸éœ€æ±‚ï¼Œé™¤æ­¤ä¹‹å¤–ï¼Œ_å¼‚å¸¸çš„Jobåœ¨çŸ­æ—¶é—´å†…åˆ›å»ºå’Œåˆ é™¤å¤§é‡æ–‡ä»¶_ï¼Œ<strong>å¼•èµ·NNèŠ‚ç‚¹é¢‘ç¹æ›´æ–°å†…å­˜çš„æ•°æ®ç»“æ„ä»è€Œå¯¼è‡´RPCçš„å¤„ç†æ—¶é—´å˜é•¿ï¼ŒCallQueueé‡Œé¢çš„RpcCallå †ç§¯ï¼Œç”šè‡³ä¸¥é‡çš„æƒ…å†µä¸‹æ‰“æ»¡CallQueueï¼Œå¯¼è‡´NameNodeå“åº”å˜æ…¢ï¼Œç”šè‡³æ— å“åº”</strong>ï¼ŒZKFCçš„HealthMonitorç›‘æ§è‡ªå·±çš„NNå¼‚å¸¸æ—¶ï¼Œåˆ™ä¼šæ–­å¼€ä¸ZooKeeperçš„é“¾æ¥ï¼Œä»è€Œé‡Šæ”¾é”ï¼Œå¦å¤–ä¸€ä¸ªNNä¸Šçš„ZKFCè¿›è¡ŒæŠ¢é”è¿›è¡ŒStandbyåˆ°ActiveçŠ¶æ€çš„åˆ‡æ¢ã€‚è¿™æ˜¯ä¸€èˆ¬å¼•èµ·çš„åˆ‡æ¢çš„æµç¨‹ã€‚</p></li><li><p>activeå‘ç”Ÿå¼‚å¸¸ï¼Œå¹¶ä¸”activeå’Œstandbyæ— æ³•æ­£å¸¸sshï¼Œfence methodsè®¾ç½®çš„ä¸ºssh å’Œ shellï¼Œæ­¤æ—¶èƒ½å¦åˆ‡æ¢æˆåŠŸ<br>HealthMonitoræ£€æŸ¥åˆ°activeä¸æ­£å¸¸ï¼Œæ”¾å¼ƒé€‰ä¸¾ï¼Œæ–­å¼€zkè¿æ¥ï¼Œä¸´æ—¶èŠ‚ç‚¹è¢«åˆ é™¤ï¼Œstandbyè¿›è¡Œé€‰ä¸¾ï¼Œåˆ›å»ºä¸´æ—¶èŠ‚ç‚¹æˆåŠŸï¼Œå‡†å¤‡becomeActiveï¼Œæ­¤æ—¶å‘ç°ActiveBreadCrumbä¸Šå­˜å‚¨çš„ä¿¡æ¯å’Œå½“å‰èŠ‚ç‚¹ä¸ä¸€è‡´ï¼Œè¿›è¡Œfenceï¼ŒFailoverControlleræ²¡æœ‰gracefully fenceæˆåŠŸï¼Œè¿›è¡ŒNodeFence.fenceï¼Œé¦–å…ˆé€‰ç”¨sshï¼Œå‘ç°sshä¸é€šï¼Œå†é€‰æ‹©shellï¼Œshellè¿”å›æ­£å¸¸å€¼(<em>shellä¸­æ²¡æœ‰ä»»ä½•é€»è¾‘ç›´æ¥è¿”å›æ­£å¸¸å€¼</em>)ï¼Œstandbyè½¬æ¢çŠ¶æ€ä¸ºactiveæˆåŠŸï¼Œ<strong>æ­¤æ—¶åŸactiveèŠ‚ç‚¹çš„çŠ¶æ€æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯ä¸æ˜¯ä¸¤ä¸ªèŠ‚ç‚¹éƒ½æ˜¯activeï¼Œå‡ºç°è„‘è£‚ï¼Ÿ</strong>ï¼Œä¸ä¼šå‡ºç°è„‘è£‚ï¼Œzfkcä¼šåœ¨è¿›è¡ŒçŠ¶æ€æ£€æŸ¥æ—¶å°†åŸactiveå˜æˆstandby</p></li></ol><span id="more"></span><h2 id="ç¤ºä¾‹åœºæ™¯"><a href="#ç¤ºä¾‹åœºæ™¯" class="headerlink" title="ç¤ºä¾‹åœºæ™¯"></a>ç¤ºä¾‹åœºæ™¯</h2><ul><li><p>ActiveNNäº§ç”ŸJVM crash<br>ä¸€æ—¦è¿™ç§æƒ…å†µå‘ç”Ÿï¼ŒHealthMonitoråœ¨è°ƒç”¨monitorHealth()å°†å¤±æ•ˆã€‚ç„¶åHMå°†å‘ZKFCè°ƒç”¨enterState(SERVICE_NOT_RESPONDING)ï¼Œæœ¬åœ°ZKFCå°†é€€å‡ºElectionï¼Œå¦å¤–ä¸€ä¸ªZKFCè·å–active lockï¼Œæ‰§è¡Œfencingï¼Œå˜æˆactiveã€‚</p></li><li><p>ActiveNN JVM freeze<br>å¦‚æœJVM freezeäº†ä½†æ˜¯æ²¡æœ‰crashæ‰ï¼Œè¿™ä¸ä¸Šé¢æƒ…å†µä¸€æ ·ï¼ŒmonitorHealthä¼šç”±äºtimeoutè€Œå¼•å‘ä¸Šè¿°è¿‡ç¨‹ã€‚FUTURE-WORKï¼šä½¿ç”¨JVMTIæ¥åˆ¤æ–­NNæ˜¯å¦åœ¨è¿›è¡Œgcï¼Œå¦‚æ­¤å¯ä»¥ä½¿ç”¨å¦ä¸€ä¸ªtimeoutæ¥ä¸ºgcè¿›è¡Œfailoverã€‚</p></li><li><p>ActiveNN machine crash</p></li><li><p><em>å½“æ•´ä¸ªæœºå™¨crashäº†ï¼ŒASE(ActiveStandbyElector)åœ¨zkçš„sessionå°†ä¼šè¿‡æœŸï¼Œå¦ä¸€ä¸ªZKFCå°†ä¼šè·å–è¿™ä¸ªäº‹ä»¶ï¼Œå¼•å‘failoverã€‚</em>*</p></li><li><p>Active ZKFC crash<br>å°½ç®¡ZKFCè®¾è®¡ç®€å•ï¼Œä½†æ˜¯ä»ç„¶æœ‰å¯èƒ½ä¼šcrashæ‰ï¼Œåœ¨è¿™ä¸ªæƒ…å†µä¸‹ï¼Œfailoverå°†ä¼šè¢«é”™è¯¯çš„è§¦å‘ã€‚å¦ä¸€ä¸ªNNçš„ZKFCé€šè¿‡RPCå°†å¯¹ActiveNNè°ƒç”¨transitionToStandbyè®©å®ƒæ”¾å¼ƒactive lockï¼Œç„¶åè¿›è¡Œaggressive fencingã€‚__å°½ç®¡ä¼šæˆåŠŸï¼Œä½†æ˜¯ä¼šå¯¼è‡´è¿›è¡Œäº†ä¸€æ¬¡æ²¡æœ‰å¿…è¦çš„failover__ã€‚</p></li><li><p>Zookeeper crash<br>å½“zké›†ç¾¤crashäº†ï¼Œé‚£ä¹ˆæ‰€æœ‰çš„ZKFCå°†æ”¶åˆ°DISCONNECTEDäº‹ä»¶ã€‚ç„¶åZKFCåœ¨æœ¬åœ°NNè°ƒç”¨enterNeutralModeï¼Œé™¤æ­¤ä¹‹å¤–ä¸åšä»»ä½•æ”¹å˜ã€‚ç³»ç»Ÿé™¤äº†ä¸èƒ½æ‰§è¡Œfailoverä¹‹å¤–ï¼Œä¸å…¶ä»–æƒ…å†µæ— å¼‚ã€‚<br>å½“zkæ¢å¤äº†ï¼Œclientsç«‹é©¬èƒ½å¤Ÿé‡è¿ã€‚è€Œzkèƒ½å¤Ÿå°†ä¹‹å‰çš„sessionä¿¡æ¯é‡æ–°è¢«å„ä¸ªclientè¿›è¡Œè·å–ï¼ˆåœ¨å¯åŠ¨çš„ä¸€ä¸ªtimeouæ—¶é—´å†…ï¼‰ã€‚æ‰€ä»¥æ‰€æœ‰çš„nodeså°†ä¼šé‡æ–°è·å–sessionï¼Œä¸éœ€è¦è¿›è¡Œæ— å¿…è¦çš„failoverã€‚<br>FutureWorkï¼šbreadcrumb znodeåœ¨è¿™ä¸ªæƒ…å†µä¸‹å¯ä»¥ä¼˜å…ˆçš„ç»™äºˆåˆ°ActiveNNï¼Œåœ¨ZKæŒ‚æ‰ä¹‹å‰ã€‚</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> HA </tag>
            
            <tag> ZKFC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSæ¢å¤è¿‡ç¨‹2</title>
      <link href="/%5B%E8%AF%91%5DHDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B2.html"/>
      <url>/%5B%E8%AF%91%5DHDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B2.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬ç¯‡ä¸»è¦æ¥ç€<a href="http://bigdatadecode.top/[%E8%AF%91]HDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B1.html">ä¸Šç¯‡</a>ä»‹ç»Pipeline Recoveryã€‚</p><h2 id="å†™Pipeline"><a href="#å†™Pipeline" class="headerlink" title="å†™Pipeline"></a>å†™Pipeline</h2><p>å½“HDFS clientæ‰§è¡Œä¸€ä¸ªå†™æ“ä½œæ—¶ï¼Œæ•°æ®æ˜¯ä»¥åºåˆ—åŒ–çš„blockå½¢å¼å†™è¿›å»çš„ã€‚å…¶ä¸­blockåˆè¢«åˆ†ä¸ºå¾ˆå¤špacketsï¼Œå°†packetså‘é€åˆ°ç”±ä¸€äº›dnç»„æˆçš„pipelineä¸­ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š<br><img src="/blogimgs/HDFS%E6%81%A2%E5%A4%8D%E8%BF%87%E7%A8%8B/packet-in-pipeline.png" alt="pipelineæµç¨‹" title="pipelineæµç¨‹"></p><span id="more"></span><p>pipelineåˆ†ä¸ºä¸‰ä¸ªé˜¶æ®µï¼š</p><ol><li>Pipeline setup<br>clientå‘pipelineå‘é€ä¸€ä¸ªWrite_Blockè¯·æ±‚ï¼Œpipelineä¸­çš„æœ€åä¸€ä¸ªDataNodeå¾€å›å‘é€ä¸€ä¸ªackã€‚clientæ”¶åˆ°ackä¹‹åï¼Œpipelineå°±å¤„äºsetupçŠ¶æ€ï¼Œå‡†å¤‡å†™å…¥æ•°æ®ã€‚</li><li>Data streaming<br>æ•°æ®é€šè¿‡packetså‘é€åˆ°pipelineä¸­ã€‚clientç«¯ç¼“å­˜æ•°æ®åˆ°bufferä¸­ï¼Œbufferæ»¡ä¹‹åå†™å…¥packetï¼Œç­‰packetæ»¡ä¹‹åï¼Œå‘é€packetåˆ°pipelineä¸­ã€‚å¦‚æœclientè°ƒç”¨<code>hflush()</code>ï¼Œ<em>å³ä½¿å½“å‰packetæ²¡æœ‰è¢«å†™æ»¡ï¼Œä¹Ÿä¼šå‘é€åˆ°pipelineä¸­ï¼Œå¹¶ä¸”ä¸‹ä¸€ä¸ªpacketåœ¨æ”¶åˆ°å½“å‰packetçš„ackä¹‹å‰ä¸ä¼šå‘é€åˆ°pipelineä¸­</em>(<strong>ä¸Šå›¾ä¸­çš„packet2å°±æ˜¯è°ƒç”¨hflush</strong>)ã€‚</li><li>Close(æ”¹å˜replicaçš„çŠ¶æ€ä¸ºfinalizeå¹¶ä¸”å…³é—­pipeline)<br>clientç­‰å¾…æ”¶åˆ°æ‰€æœ‰packetçš„ackä¹‹åï¼Œæ‰ä¼šå‘é€ä¸€ä¸ªå…³é—­è¯·æ±‚ã€‚pipelineä¸­çš„dnæ”¹å˜ç›¸åº”replicaçš„çŠ¶æ€ä¸ºFINALIZEDï¼Œå¹¶å‘nnæŠ¥å‘Šã€‚å½“nnæ”¶åˆ°replicaçš„FINALIZEDçŠ¶æ€çš„ä¸ªæ•°æ»¡è¶³æœ€å°å‰¯æœ¬æ•°æ—¶ï¼Œnnæ”¹å˜blockçš„çŠ¶æ€ä¸ºCOMPLETEã€‚</li></ol><h2 id="Pipeline-Recovery"><a href="#Pipeline-Recovery" class="headerlink" title="Pipeline Recovery"></a>Pipeline Recovery</h2><p>æ— è®ºåœ¨pipelineä¸‰ä¸ªé˜¶æ®µä¸­çš„å“ªä¸ªé˜¶æ®µï¼Œåªè¦å½“pipelineä¸­çš„dnå‘ç”Ÿerroræ—¶ï¼ŒPipeline Recoveryå°±ä¼šè¢«å¯åŠ¨ã€‚</p><h2 id="Recovery-from-Pipeline-Setup-Failure"><a href="#Recovery-from-Pipeline-Setup-Failure" class="headerlink" title="Recovery from Pipeline Setup Failure"></a>Recovery from Pipeline Setup Failure</h2><p>1ã€å½“pipelineç”¨æ¥æ–°å¢åŠ ä¸€ä¸ªblockæ—¶ï¼Œclientæ”¾å¼ƒè¿™ä¸ªblockï¼Œå¹¶å‘nnè¯·æ±‚ä¸€ä¸ªæ–°çš„blockå’Œä¸€ç»„æ–°çš„dnç»„é‡æ–°ç»„æˆä¸€ä¸ªpipelineã€‚<br>2ã€å½“pipelineç”¨æ¥è¿½åŠ ä¸€ä¸ªblockæ—¶ï¼Œclientä½¿ç”¨å‰©ä½™çš„dné‡å»ºpipelineå¹¶ä¸”å¢åŠ blockçš„generation stampã€‚</p><h2 id="Recovery-from-Data-Streaming-Failure"><a href="#Recovery-from-Data-Streaming-Failure" class="headerlink" title="Recovery from Data Streaming Failure"></a>Recovery from Data Streaming Failure</h2><p>1ã€å½“pipelineä¸­çš„dnå‘ç°error(checksumå¼‚å¸¸æˆ–è€…å†™åˆ°ç£ç›˜å‘ç”Ÿå¼‚å¸¸)ï¼Œå‘ç”Ÿerrorçš„dnå…³é—­TCP/IPè¿æ¥ï¼Œç§»å‡ºpipelineã€‚å¦‚æœæ•°æ®æ²¡æœ‰æŸåï¼Œå°†ç¼“å­˜ä¸­çš„æ•°æ®å†™å…¥ç›¸åº”çš„blockå’Œchecksumæ–‡ä»¶ä¸­(If the data is deemed not corrupted, it also writes buffered data to the relevant block and checksum (METADATA) files.)ã€‚<br>2ã€å½“clientå‘ç°å¼‚å¸¸ï¼Œclientåœæ­¢å‘pipelineä¸­å‘é€æ•°æ®ï¼Œä½¿ç”¨å‰©ä½™æ­£å¸¸çš„dné‡å»ºä¸€ä¸ªæ–°çš„pipelineã€‚æ­¤æ—¶ï¼Œblockçš„æ‰€æœ‰replicaéƒ½æœ‰ä¸€ä¸ªæ–°çš„GSã€‚<br>3ã€clientå¸¦ç€æ–°çš„GSå‘é€æ•°æ®packetã€‚æœ‰äº›dnå¦‚æœå·²ç»æ¥å—åˆ°è¿™äº›æ•°æ®ï¼Œåˆ™å¿½ç•¥è¿™äº›packetå¹¶å‘pipelçš„ä¸‹æ¸¸å‘é€è¿™äº›packetã€‚</p><h2 id="Recovery-from-Close-Failure"><a href="#Recovery-from-Close-Failure" class="headerlink" title="Recovery from Close Failure"></a>Recovery from Close Failure</h2><p>å½“pipelineå¤„äºcloseçŠ¶æ€æ—¶ï¼Œclientå‘ç°æ•…éšœï¼Œåˆ™åˆ©ç”¨å‰©ä½™æ­£å¸¸çš„dné‡å»ºpipelineã€‚æ¯ä¸ªdné€’å¢blockçš„GSï¼Œå¦‚æœreplicaä¸æ˜¯finalizedçŠ¶æ€å°±å°†å…¶æ”¹ä¸ºfinalizedã€‚</p><p>å½“pipelineä¸­çš„ä¸€ä¸ªdnå‘ç”Ÿæ•…éšœï¼Œåˆ™å°†å…¶æ•…éšœèŠ‚ç‚¹ä»pipelineä¸­ç§»é™¤ã€‚åœ¨pipeline recoveryé˜¶æ®µï¼Œclientå¯èƒ½éœ€è¦åˆ©ç”¨å‰©ä½™æ­£å¸¸çš„èŠ‚ç‚¹é‡å»ºpipelineã€‚(åœ¨é‡å»ºpipelineä¸­ï¼Œæ˜¯å¦éœ€è¦æ–°çš„dnæ›¿ä»£å‘ç”Ÿæ•…éšœçš„dnï¼Œè¿™ä¸ªå†³ç­–ä¾èµ–DataNodeæ›¿æ¢ç­–ç•¥ï¼Œåœ¨ä¸‹é¢çš„ç« èŠ‚ä¸­ä»‹ç»)å¤åˆ¶ç›‘æ§çº¿ç¨‹å°†ä¼šæ£€æŸ¥blockçš„å¤æœ¬ï¼Œä½¿å…¶æ»¡è¶³é…ç½®çš„å‰¯æœ¬å› å­ã€‚</p><h2 id="DataNode-Replacement-Policy-upon-Failure"><a href="#DataNode-Replacement-Policy-upon-Failure" class="headerlink" title="DataNode Replacement Policy upon Failure"></a>DataNode Replacement Policy upon Failure</h2><p>åœ¨pipeline recoveryä¸­ï¼Œå†³å®šæ˜¯å¦å¢åŠ dnæ›¿æ¢å‘ç”Ÿæ•…éšœçš„dnçš„ç­–ç•¥æœ‰4ç§ã€‚å¦‚ä¸‹ï¼š</p><ul><li>DISABLE: ç¦æ­¢è¿›è¡Œdnæ›¿æ¢ï¼Œå¹¶åœ¨æœåŠ¡å™¨ç«¯æŠ›å‡ºä¸€ä¸ªå¼‚å¸¸ã€‚ç±»ä¼¼äºclientç«¯çš„NEVERã€‚</li><li>NEVER: å½“pipelineå¤±è´¥æ—¶ä¸æ›¿æ¢dnã€‚(ä¸€èˆ¬ä¸è¿™æ ·æ)</li><li>DEFAULT: åŸºäºä»¥ä¸‹è§„åˆ™æ›¿æ¢dn:<br> å°†é…ç½®çš„å‰¯æœ¬å› å­æ•°è®¾ä¸ºr<br> å°†pipelineä¸­å­˜æ´»çš„dnæ•°è®¾ä¸ºn<br> å¦‚æœr&gt;=3å¹¶ä¸”æ»¡è¶³ä¸‹é¢ä»»æ„ä¸€ä¸ªæ¡ä»¶æ‰æ›¿æ¢å‘ç”Ÿæ•…éšœçš„dn<br> floor(r/2) &gt;= n; or (å½“hflush/appendè¢«è°ƒç”¨å¹¶ä¸”r &gt; n)</li><li>ALWAYS: Alwaysæ˜¯åªè¦å­˜åœ¨dnå‘ç”Ÿæ•…éšœå°±ä¼šæœ‰æ–°çš„dnè¿›è¡Œæ›¿æ¢ã€‚å¦‚æœä¸èƒ½æ›¿æ¢åˆ™å¤±è´¥ã€‚</li></ul><p>å¦‚æœæƒ³ç¦æ­¢è¿™äº›ç­–ç•¥ï¼Œå¯ä»¥è®¾ç½®ä¸‹é¢è¿™ä¸ªé…ç½®(é»˜è®¤å€¼æ˜¯true):<br><code>dfs.client.block.write.replace-datanode-on-failure.enable</code><br>å‡å¦‚ä¸Šé¢çš„é…ç½®æ˜¯trueï¼Œåˆ™é»˜è®¤çš„æ›¿æ¢ç­–ç•¥æ˜¯DEFAULTã€‚ç”±ä¸‹é¢çš„å±æ€§æ§åˆ¶:<br><code>dfs.client.block.write.replace-datanode-on-failure.policy</code><br>å½“ä½¿ç”¨DEFAULTæˆ–è€…ALWAYSæ—¶ï¼Œå¦‚æœpipelineä¸­åªæœ‰ä¸€ä¸ªdn<strong>æ›¿æ¢</strong>æˆåŠŸäº†ï¼Œpipeline recoveryå°†ä¸ä¼šæˆåŠŸï¼Œå¹¶ä¸”clientå°†ä¸èƒ½åœ¨æ‰§è¡Œå†™æ“ä½œã€‚è¿™ä¸ªé—®é¢˜é€šè¿‡è®¾ç½®ä¸‹é¢çš„å±æ€§è¿›è¡Œè§£å†³:<br><code>dfs.client.block.write.replace-datanode-on-failure.best-effort</code><br>æ­¤å±æ€§é»˜è®¤æ˜¯falseã€‚å¦‚æœæ˜¯é»˜è®¤å€¼ï¼Œclientä¼šä¸€ç›´å°è¯•æ›¿æ¢å‘ç”Ÿæ•…éšœçš„dnç›´åˆ°æ»¡è¶³ç‰¹å®šçš„ç­–ç•¥ã€‚å¦‚æœè®¾ç½®ä¸ºtrueï¼Œå³ä½¿ç‰¹å®šçš„ç­–ç•¥ä¸æ»¡è¶³(åœ¨pipelineä¸­åªæœ‰ä¸€ä¸ªdnæˆåŠŸï¼Œæ¯”è¦æ±‚çš„æ•°é‡è¦å°‘)ï¼Œclientä¾ç„¶å¯ä»¥ç»§ç»­å†™ã€‚</p><p><a href="http://blog.cloudera.com/blog/2015/03/understanding-hdfs-recovery-processes-part-2/">åŸæ–‡åœ°å€</a></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Pipeline Recovery </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFS readè§£æ2ä¹‹ä»æ–‡ä»¶æµä¸­read</title>
      <link href="/HDFS%20read%E8%A7%A3%E6%9E%902%E4%B9%8B%E4%BB%8E%E6%96%87%E4%BB%B6%E6%B5%81%E4%B8%ADread.html"/>
      <url>/HDFS%20read%E8%A7%A3%E6%9E%902%E4%B9%8B%E4%BB%8E%E6%96%87%E4%BB%B6%E6%B5%81%E4%B8%ADread.html</url>
      
        <content type="html"><![CDATA[<p>[ä¸Šç¯‡](<a href="http://bigdatadecode.top/HDFS">http://bigdatadecode.top/HDFS</a> readè§£æ.html)ä¸»è¦è®°å½•äº†HDFS readæ‰“å¼€ä¸€ä¸ªæ–‡ä»¶æµçš„æµç¨‹ï¼Œè¯¥ç¯‡è®°å½•ä¸‹ä»æ‰“å¼€çš„æ–‡ä»¶æµé‡Œreadæ•°æ®çš„æµç¨‹ã€‚</p><span id="more"></span><h2 id="HDFS-Readä¹‹ä»æ–‡ä»¶æµä¸­read"><a href="#HDFS-Readä¹‹ä»æ–‡ä»¶æµä¸­read" class="headerlink" title="HDFS Readä¹‹ä»æ–‡ä»¶æµä¸­read"></a>HDFS Readä¹‹ä»æ–‡ä»¶æµä¸­read</h2><p>è¯»å–æ–‡ä»¶æµä¸­çš„æ•°æ®é€šè¿‡æ–‡ä»¶æµFSDataInputStreamå¯¹è±¡çš„readæ–¹æ³•è¿›è¡Œè¯»å–ï¼Œæœ€ç»ˆè°ƒç”¨äº†DFSInputStreamçš„readæ–¹æ³•(å¯ä»¥å†™ä¸ªhdfs read file demo è¿›è¡Œdebugä¸‹å°±ä¼šå‘ç°)</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">final</span> <span class="keyword">byte</span> buf[], <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// ReaderStrategy å°†ä¸åŒçš„BlockReaderè¿›è¡Œäº†å°è£…</span></span><br><span class="line">  <span class="comment">// çœŸæ­£è¯»æ•°æ®çš„æ˜¯BlockReaderå¯¹è±¡</span></span><br><span class="line">  ReaderStrategy byteArrayReader = <span class="keyword">new</span> ByteArrayStrategy(buf);</span><br><span class="line">  <span class="keyword">return</span> readWithStrategy(byteArrayReader, off, len);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">readWithStrategy</span><span class="params">(ReaderStrategy strategy, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Map&lt;ExtendedBlock,Set&lt;DatanodeInfo&gt;&gt; corruptedBlockMap </span><br><span class="line">    = <span class="keyword">new</span> HashMap&lt;ExtendedBlock, Set&lt;DatanodeInfo&gt;&gt;();</span><br><span class="line">  failures = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">if</span> (pos &lt; getFileLength()) &#123;</span><br><span class="line">    <span class="keyword">int</span> retries = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">while</span> (retries &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// currentNode can be left as null if previous read had a checksum</span></span><br><span class="line">        <span class="comment">// error on the same block. See HDFS-3067</span></span><br><span class="line">        <span class="comment">// pos å’Œ blockEnd ä¼šåœ¨blockSeekTo -&gt; getBlockAt ä¸­èµ‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (pos &gt; blockEnd || currentNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å½“å‰positionæ‰€åœ¨çš„block</span></span><br><span class="line">          currentNode = blockSeekTo(pos);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> realLen = (<span class="keyword">int</span>) Math.min(len, (blockEnd - pos + <span class="number">1L</span>));</span><br><span class="line">        <span class="keyword">if</span> (locatedBlocks.isLastBlockComplete()) &#123;</span><br><span class="line">          realLen = (<span class="keyword">int</span>) Math.min(realLen, locatedBlocks.getFileLength());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è¯»å–buffer</span></span><br><span class="line">        <span class="keyword">int</span> result = readBuffer(strategy, off, realLen, corruptedBlockMap);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (result &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">          pos += result;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// got a EOS from reader though we expect more data on it.</span></span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Unexpected EOS from the reader&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (dfsClient.stats != <span class="keyword">null</span>) &#123;</span><br><span class="line">          dfsClient.stats.incrementBytesRead(result);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">        <span class="comment">// å¦‚æœæ£€æµ‹åˆ°ChecksumException åˆ™åªæŠ›å‡ºå¼‚å¸¸ï¼Œå†æ¬¡è¿›è¡Œå¾ªç¯</span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (ChecksumException ce) &#123;</span><br><span class="line">        <span class="keyword">throw</span> ce;    </span><br><span class="line">        <span class="comment">// å¦‚æœæ•è·åˆ°IOå¼‚å¸¸ï¼Œåˆ™retriesæ¬¡æ•°å‡1ï¼Œè¿›å…¥ä¸‹ä¸€æ¬¡å¾ªç¯        </span></span><br><span class="line">      &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        <span class="keyword">if</span> (retries == <span class="number">1</span>) &#123;</span><br><span class="line">          DFSClient.LOG.warn(<span class="string">&quot;DFS Read&quot;</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        blockEnd = -<span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (currentNode != <span class="keyword">null</span>) &#123; addToDeadNodes(currentNode); &#125;</span><br><span class="line">        <span class="keyword">if</span> (--retries == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">throw</span> e;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="comment">// Check if need to report block replicas corruption either read</span></span><br><span class="line">        <span class="comment">// was successful or ChecksumException occured.</span></span><br><span class="line">        reportCheckSumFailure(corruptedBlockMap, </span><br><span class="line">            currentLocatedBlock.getLocations().length);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>readWithStrategyä¼šé‡è¯•2æ¬¡è¿›è¡Œè¯»å–ï¼Œ_å¦‚æœæ•è·åˆ°<code>ChecksumException</code>åˆ™ç›´æ¥è¿›è¡Œé‡è¯•(æœ¬æ¬¡å°è¯•ä¸è®¡æ•°)_ï¼Œå½“æ•è·åˆ°<code>IOException</code>å¼‚å¸¸æ—¶ä¼šè¿›è¡Œé‡è¯•(å°è¯•æ¬¡æ•°å‡1)ï¼Œé‡æ–°é€‰æ‹©dnè¿›è¡Œè¯»å–ï¼Œå¹¶æŠŠæœ‰ioå¼‚å¸¸çš„dnæ”¾å…¥deadNodes mapä¸­ã€‚<strong>ä¸€ä¸ªblockä¸€ä¸ªdeadNodesï¼Ÿï¼Ÿï¼Ÿ</strong></p><p><strong>deadNodesæ˜¯DFSInputStreamçš„å±æ€§ï¼Œåˆ™åº”è¯¥æ˜¯ä¸€ä¸ªDFSInputStreamä¸€ä¸ªdeadNodesï¼Œä½†æ˜¯åœ¨è¯»å–ä¸€ä¸ªblockç»“æŸä¹‹åï¼ŒdeadNodesä¼šä¸ä¼šè¢«clearæ‰ï¼Ÿï¼Ÿè¯»å–å¤±è´¥ä¹‹åä¼šclear deadNodes</strong></p><p>readWithStrategyä¸­ä¸»è¦æœ‰ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯<code>blockSeekTo</code>å’Œ<code>readBuffer</code>ï¼ŒblockSeekToæ˜¯æ‰¾åˆ°å½“å‰posçš„blockï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> DatanodeInfo <span class="title">blockSeekTo</span><span class="params">(<span class="keyword">long</span> target)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Connect to best DataNode for desired Block, with potential offset</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  DatanodeInfo chosenNode = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">int</span> refetchToken = <span class="number">1</span>; <span class="comment">// only need to get a new access token once</span></span><br><span class="line">  <span class="keyword">int</span> refetchEncryptionKey = <span class="number">1</span>; <span class="comment">// only need to get a new encryption key once</span></span><br><span class="line">  <span class="keyword">boolean</span> connectFailedOnce = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// Compute desired block</span></span><br><span class="line">    <span class="comment">//å¾—åˆ°targetæ‰€åœ¨çš„dn locationsä¿¡æ¯</span></span><br><span class="line">    LocatedBlock targetBlock = getBlockAt(target, <span class="keyword">true</span>);</span><br><span class="line">    <span class="keyword">assert</span> (target==pos) : <span class="string">&quot;Wrong postion &quot;</span> + pos + <span class="string">&quot; expect &quot;</span> + target;</span><br><span class="line">    <span class="keyword">long</span> offsetIntoBlock = target - targetBlock.getStartOffset();</span><br><span class="line">    <span class="comment">// ä»dn setä¸­é€‰å‡ºä¸€ä¸ªdn</span></span><br><span class="line">    DNAddrPair retval = chooseDataNode(targetBlock, <span class="keyword">null</span>);</span><br><span class="line">    chosenNode = retval.info;</span><br><span class="line">    InetSocketAddress targetAddr = retval.addr;</span><br><span class="line">    StorageType storageType = retval.storageType;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      ExtendedBlock blk = targetBlock.getBlock();</span><br><span class="line">      Token&lt;BlockTokenIdentifier&gt; accessToken = targetBlock.getBlockToken();</span><br><span class="line">      <span class="comment">// ä½¿ç”¨ Builderæ¨¡å¼ åˆ›å»ºä¸€ä¸ª blockReader</span></span><br><span class="line">      blockReader = <span class="keyword">new</span> BlockReaderFactory(dfsClient.getConf()).</span><br><span class="line">          setInetSocketAddress(targetAddr).</span><br><span class="line">          setRemotePeerFactory(dfsClient).</span><br><span class="line">          setDatanodeInfo(chosenNode).</span><br><span class="line">          setStorageType(storageType).</span><br><span class="line">          setFileName(src).</span><br><span class="line">          setBlock(blk).</span><br><span class="line">          setBlockToken(accessToken).</span><br><span class="line">          setStartOffset(offsetIntoBlock).</span><br><span class="line">          setVerifyChecksum(verifyChecksum).</span><br><span class="line">          setClientName(dfsClient.clientName).</span><br><span class="line">          setLength(blk.getNumBytes() - offsetIntoBlock).</span><br><span class="line">          setCachingStrategy(cachingStrategy).</span><br><span class="line">          setAllowShortCircuitLocalReads(!shortCircuitForbidden()).</span><br><span class="line">          setClientCacheContext(dfsClient.getClientContext()).</span><br><span class="line">          setUserGroupInformation(dfsClient.ugi).</span><br><span class="line">          setConfiguration(dfsClient.getConfiguration()).</span><br><span class="line">          build();</span><br><span class="line">      <span class="keyword">if</span>(connectFailedOnce) &#123;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Successfully connected to &quot;</span> + targetAddr +</span><br><span class="line">                           <span class="string">&quot; for &quot;</span> + blk);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> chosenNode;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      <span class="keyword">if</span> (ex <span class="keyword">instanceof</span> InvalidEncryptionKeyException &amp;&amp; refetchEncryptionKey &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;Will fetch a new encryption key and retry, &quot;</span> </span><br><span class="line">            + <span class="string">&quot;encryption key was invalid when connecting to &quot;</span> + targetAddr</span><br><span class="line">            + <span class="string">&quot; : &quot;</span> + ex);</span><br><span class="line">        <span class="comment">// The encryption key used is invalid.</span></span><br><span class="line">        refetchEncryptionKey--;</span><br><span class="line">        dfsClient.clearDataEncryptionKey();</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (refetchToken &gt; <span class="number">0</span> &amp;&amp; tokenRefetchNeeded(ex, targetAddr)) &#123;</span><br><span class="line">        refetchToken--;</span><br><span class="line">        <span class="comment">// Fetch a block from namenode and cache it ????</span></span><br><span class="line">        fetchBlockAt(target);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        connectFailedOnce = <span class="keyword">true</span>;</span><br><span class="line">        DFSClient.LOG.warn(<span class="string">&quot;Failed to connect to &quot;</span> + targetAddr + <span class="string">&quot; for block&quot;</span></span><br><span class="line">          + <span class="string">&quot;, add to deadNodes and continue. &quot;</span> + ex, ex);</span><br><span class="line">        <span class="comment">// Put chosen node into dead list, continue</span></span><br><span class="line">        addToDeadNodes(chosenNode);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>blockSeekToä¸»è¦åŒ…å«ä¸¤ä¸ªæ–¹æ³•å’Œä¸€ä¸ªBlockReaderçš„å®ä¾‹åŒ–å¯¹è±¡ï¼Œä¸€ä¸ªæ–¹æ³•æ˜¯<code>getBlockAt</code>ï¼Œå…¶ä½œç”¨æ˜¯å¾—åˆ°å½“å‰offsetæ‰€åœ¨çš„blockçš„dn locationsä¿¡æ¯ï¼Œå¦ä¸€ä¸ªæ–¹æ³•æ˜¯<code>chooseDataNode</code>ï¼Œå…¶ä½œç”¨æ˜¯ä»<code>getBlockAt</code>å¾—åˆ°çš„dn locations listä¸­å¾—åˆ°ä¸€ä¸ªdnã€‚getBlockAtçš„å®ç°é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> LocatedBlock <span class="title">getBlockAt</span><span class="params">(<span class="keyword">long</span> offset,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> updatePosition)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> (locatedBlocks != <span class="keyword">null</span>) : <span class="string">&quot;locatedBlocks is null&quot;</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> LocatedBlock blk;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//check offset</span></span><br><span class="line">  <span class="keyword">if</span> (offset &lt; <span class="number">0</span> || offset &gt;= getFileLength()) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;offset &lt; 0 || offset &gt;= getFileLength(), offset=&quot;</span></span><br><span class="line">        + offset</span><br><span class="line">        + <span class="string">&quot;, updatePosition=&quot;</span> + updatePosition</span><br><span class="line">        + <span class="string">&quot;, locatedBlocks=&quot;</span> + locatedBlocks);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> <span class="keyword">if</span> (offset &gt;= locatedBlocks.getFileLength()) &#123;</span><br><span class="line">    <span class="comment">// offset to the portion of the last block,</span></span><br><span class="line">    <span class="comment">// which is not known to the name-node yet;</span></span><br><span class="line">    <span class="comment">// getting the last block </span></span><br><span class="line">    blk = locatedBlocks.getLastLocatedBlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// search cached blocks first</span></span><br><span class="line">    <span class="comment">// ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ä»ç¼“å­˜çš„blockä¸­æŸ¥æ‰¾å½“å‰offsetæ‰€åœ¨çš„block</span></span><br><span class="line">    <span class="keyword">int</span> targetBlockIdx = locatedBlocks.findBlock(offset);</span><br><span class="line">    <span class="comment">// åœ¨ç¼“å­˜ä¸­æ²¡æœ‰æ‰¾åˆ°</span></span><br><span class="line">    <span class="keyword">if</span> (targetBlockIdx &lt; <span class="number">0</span>) &#123; <span class="comment">// block is not cached</span></span><br><span class="line">      targetBlockIdx = LocatedBlocks.getInsertIndex(targetBlockIdx);</span><br><span class="line">      <span class="comment">// fetch more blocks</span></span><br><span class="line">      <span class="comment">// å†æ¬¡æŠ“å–blocksï¼Œä»å½“å‰offsetå¤„å¼€å§‹æŠ“å–</span></span><br><span class="line">      <span class="keyword">final</span> LocatedBlocks newBlocks = dfsClient.getLocatedBlocks(src, offset);</span><br><span class="line">      <span class="keyword">assert</span> (newBlocks != <span class="keyword">null</span>) : <span class="string">&quot;Could not find target position &quot;</span> + offset;</span><br><span class="line">      <span class="comment">// å°†new blockæ’å…¥åˆ°ç¼“å­˜çš„targetBlockIdxä½ç½®ä¸­</span></span><br><span class="line">      locatedBlocks.insertRange(targetBlockIdx, newBlocks.getLocatedBlocks());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¾—åˆ°offsetæ‰€åœ¨çš„block  targetBlockIdxæ˜¯blockåœ¨ç¼“å­˜ä¸­çš„ç´¢å¼•</span></span><br><span class="line">    blk = locatedBlocks.get(targetBlockIdx);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// update current position</span></span><br><span class="line">  <span class="comment">// æ›´æ–°readçš„èµ·å§‹åœ°å€poså’Œç»“æŸåœ°å€blockEnd</span></span><br><span class="line">  <span class="keyword">if</span> (updatePosition) &#123;</span><br><span class="line">    pos = offset;</span><br><span class="line">    blockEnd = blk.getStartOffset() + blk.getBlockSize() - <span class="number">1</span>;</span><br><span class="line">    currentLocatedBlock = blk;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> blk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getBlockAtä¸»è¦æ˜¯å¾—åˆ°offsetæ‰€åœ¨çš„blockï¼Œå…¶æ£€ç´¢æ–¹æ³•æ˜¯å…ˆåœ¨ç¼“å­˜(è¿™ä¸ªç¼“å­˜å¤§å°æ˜¯ç”±_dfs.client.read.prefetch.size_å†³å®šçš„)ä¸­è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°å°±è¿”å›å…¶ç´¢å¼•ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™å†æ¬¡è°ƒç”¨rpcè¿›è¡Œé‡æ–°æŠ“å–blockï¼Œ__æ­¤æ¬¡æŠ“å–çš„blockçš„æ˜¯ä»offsetæ‰€åœ¨blockå¼€å§‹æŠ“å–çš„__ã€‚ä¸‹é¢çœ‹ä¸‹<code>findBlock</code>çš„ä»£ç ï¼š</p><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">public int findBlock(long offset) &#123;</span><br><span class="line">  <span class="comment">// create fake block of size 0 as a key</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºä¸€ä¸ªLocatedBlockå¯¹è±¡ï¼Œä¾¿äºå’ŒLocatedBlocksä¸­çš„blockè¿›è¡Œæ¯”è¾ƒ</span></span><br><span class="line">  <span class="type">LocatedBlock</span> key = <span class="keyword">new</span> <span class="type">LocatedBlock</span>(</span><br><span class="line">      <span class="keyword">new</span> <span class="type">ExtendedBlock</span>(), <span class="keyword">new</span> <span class="type">DatanodeInfo</span>[<span class="number">0</span>], <span class="number">0</span>L, <span class="literal">false</span>);</span><br><span class="line">  key.setStartOffset(offset);</span><br><span class="line">  key.getBlock().setNumBytes(<span class="number">1</span>);</span><br><span class="line">  <span class="comment">// é‡å†™comparator</span></span><br><span class="line">  <span class="type">Comparator</span>&lt;<span class="type">LocatedBlock</span>&gt; comp = </span><br><span class="line">    <span class="keyword">new</span> <span class="type">Comparator</span>&lt;<span class="type">LocatedBlock</span>&gt;() &#123;</span><br><span class="line">      <span class="comment">// Returns 0 iff a is inside b or b is inside a</span></span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      public int compare(<span class="type">LocatedBlock</span> a, <span class="type">LocatedBlock</span> b) &#123;</span><br><span class="line">        long aBeg = a.getStartOffset();</span><br><span class="line">        long bBeg = b.getStartOffset();</span><br><span class="line">        long aEnd = aBeg + a.getBlockSize();</span><br><span class="line">        long bEnd = bBeg + b.getBlockSize();</span><br><span class="line">        <span class="keyword">if</span>(aBeg &lt;= bBeg &amp;&amp; bEnd &lt;= aEnd </span><br><span class="line">            || bBeg &lt;= aBeg &amp;&amp; aEnd &lt;= bEnd)</span><br><span class="line">          <span class="keyword">return</span> <span class="number">0</span>; <span class="comment">// one of the blocks is inside the other</span></span><br><span class="line">        <span class="keyword">if</span>(aBeg &lt; bBeg)</span><br><span class="line">          <span class="keyword">return</span> <span class="number">-1</span>; <span class="comment">// a&#x27;s left bound is to the left of the b&#x27;s</span></span><br><span class="line">        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;;</span><br><span class="line">    <span class="comment">// è°ƒç”¨Collectionsçš„äºŒåˆ†æŸ¥æ‰¾</span></span><br><span class="line">  <span class="keyword">return</span> <span class="type">Collections</span>.binarySearch(blocks, key, comp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>findBlockä¸»è¦æ˜¯åˆ©ç”¨Collectionsçš„äºŒåˆ†æŸ¥æ‰¾è¿›è¡ŒæŸ¥æ‰¾offsetæ‰€åœ¨çš„blockï¼Œè¿›è¡Œæ¯”è¾ƒæ—¶å…ˆåˆ›å»ºä¸€ä¸ªLocatedBlockå¯¹è±¡ï¼Œç„¶åé‡å†™Comparatorè¿›è¡Œå¯¹è±¡çš„æ¯”è¾ƒã€‚å¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™è°ƒç”¨<code>dfsClient.getLocatedBlocks</code>ï¼Œä»å½“å‰offsetæ‰€åœ¨çš„blockä¸ºèµ·ç‚¹è¿›è¡Œå†æ¬¡æŠ“å–å›ºå®šé•¿åº¦çš„blockï¼Œå¹¶å°†newBlocksæ’å…¥ç¼“å­˜ä¸­çš„blocksä¸­ã€‚</p><p>æŠ“å–blockæ˜¯é€šè¿‡rpcè°ƒç”¨dfsClient.getLocatedBlocksä»FSNamesystemä¸­è·å¾—blocksåˆ—è¡¨ï¼Œç„¶åé€šè¿‡<code>locatedBlocks.insertRange</code>æ’å…¥åˆ°ç¼“å­˜ä¸­ï¼ŒlocatedBlocks.insertRangeä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">insertRange</span><span class="params">(<span class="keyword">int</span> blockIdx, List&lt;LocatedBlock&gt; newBlocks)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è¿”å›åœ¨ç¼“å­˜ä¸­æŸ¥æ‰¾å¤±è´¥è¿”å›çš„lowå¤„çš„ç´¢å¼•</span></span><br><span class="line">  <span class="keyword">int</span> oldIdx = blockIdx;</span><br><span class="line">  <span class="keyword">int</span> insStart = <span class="number">0</span>, insEnd = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// å¦‚æœç¼“å­˜blocksçš„æœ€åä¸€ä¸ªå…ƒç´ ä¾ç„¶å°äºç›®æ ‡blockçš„offsetæ—¶(ä¹Ÿå°±æ˜¯low=len+1)</span></span><br><span class="line">  <span class="comment">// åˆ™ä¸è¿›å…¥forå¾ªç¯</span></span><br><span class="line">  <span class="comment">// æ‰¾åˆ°ç›®æ ‡blockåœ¨newBlocksä¸­çš„ç´¢å¼•</span></span><br><span class="line">  <span class="keyword">for</span>(<span class="keyword">int</span> newIdx = <span class="number">0</span>; newIdx &lt; newBlocks.size() &amp;&amp; oldIdx &lt; blocks.size(); </span><br><span class="line">                                                      newIdx++) &#123;</span><br><span class="line">    <span class="keyword">long</span> newOff = newBlocks.get(newIdx).getStartOffset();</span><br><span class="line">    <span class="keyword">long</span> oldOff = blocks.get(oldIdx).getStartOffset();</span><br><span class="line">    <span class="comment">// å½“newBlocks</span></span><br><span class="line">    <span class="keyword">if</span>(newOff &lt; oldOff) &#123;</span><br><span class="line">      insEnd++;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span>(newOff == oldOff) &#123;</span><br><span class="line">      <span class="comment">// replace old cached block by the new one</span></span><br><span class="line">      blocks.set(oldIdx, newBlocks.get(newIdx));</span><br><span class="line">      <span class="keyword">if</span>(insStart &lt; insEnd) &#123; <span class="comment">// insert new blocks</span></span><br><span class="line">        blocks.addAll(oldIdx, newBlocks.subList(insStart, insEnd));</span><br><span class="line">        oldIdx += insEnd - insStart;</span><br><span class="line">      &#125;</span><br><span class="line">      insStart = insEnd = newIdx+<span class="number">1</span>;</span><br><span class="line">      oldIdx++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;  <span class="comment">// newOff &gt; oldOff</span></span><br><span class="line">      <span class="keyword">assert</span> <span class="keyword">false</span> : <span class="string">&quot;List of LocatedBlock must be sorted by startOffset&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  insEnd = newBlocks.size();</span><br><span class="line">  <span class="comment">// å°†å¤§äºç›®æ ‡blockçš„blocksæ’å…¥ç¼“å­˜ä¸­</span></span><br><span class="line">  <span class="keyword">if</span>(insStart &lt; insEnd) &#123; <span class="comment">// insert new blocks</span></span><br><span class="line">    blocks.addAll(oldIdx, newBlocks.subList(insStart, insEnd));</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>insertRangeå°†<em>newBlocks</em>ä¸­çš„blockæ ¹æ®å…¶åœ¨<em>blocks</em>ä¸­çš„é¡ºåº<em>åˆ†åŒºé—´æ’å…¥blocksä¸­</em>ã€‚åŒºé—´ç”±insStartå’ŒinsEndæ§åˆ¶ï¼Œforå¾ªç¯ä¸­è°ƒæ•´insEndå’ŒinsStartçš„å€¼ï¼Œåˆ†æ‰¹æ¬¡æ’å…¥åˆ°blocksä¸­ã€‚</p><p>æ­¤æ—¶å°±å¯ä»¥å¾—åˆ°ç›®æ ‡blockçš„locationsä¿¡æ¯ï¼Œé€šè¿‡<code>chooseDataNode</code>é€‰æ‹©ä¸€ä¸ªdnï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> DNAddrPair <span class="title">chooseDataNode</span><span class="params">(LocatedBlock block,</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;DatanodeInfo&gt; ignoredNodes)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> getBestNodeDNAddrPair(block, ignoredNodes);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">      <span class="comment">// æ•è·åˆ°getBestNodeDNAddrPairä¸­chosenNodeä¸ºnullçš„å¼‚å¸¸ä¹‹å</span></span><br><span class="line">      <span class="comment">// æ¸…ç©ºdeadNodesï¼Œé‡æ–°è·å–è¯¥blockçš„ä¿¡æ¯</span></span><br><span class="line">      <span class="comment">// å°è¯•3æ¬¡ï¼ŒæŠ›å‡ºå¼‚å¸¸</span></span><br><span class="line">      String errMsg = getBestNodeDNAddrPairErrorString(block.getLocations(),</span><br><span class="line">        deadNodes, ignoredNodes);</span><br><span class="line">      String blockInfo = block.getBlock() + <span class="string">&quot; file=&quot;</span> + src;</span><br><span class="line">      <span class="comment">// dfs.client.max.block.acquire.failures é»˜è®¤æ˜¯3</span></span><br><span class="line">      <span class="comment">// è·å–è¯¥blockä¿¡æ¯3æ¬¡ï¼Œæ³¨æ„ä¸è·å–3æ¬¡dnçš„åŒºåˆ«</span></span><br><span class="line">      <span class="keyword">if</span> (failures &gt;= dfsClient.getMaxBlockAcquireFailures()) &#123;</span><br><span class="line">        String description = <span class="string">&quot;Could not obtain block: &quot;</span> + blockInfo;</span><br><span class="line">        DFSClient.LOG.warn(description + errMsg</span><br><span class="line">            + <span class="string">&quot;. Throwing a BlockMissingException&quot;</span>);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> BlockMissingException(src, description,</span><br><span class="line">            block.getStartOffset());</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      DatanodeInfo[] nodes = block.getLocations();</span><br><span class="line">      <span class="keyword">if</span> (nodes == <span class="keyword">null</span> || nodes.length == <span class="number">0</span>) &#123;</span><br><span class="line">        DFSClient.LOG.info(<span class="string">&quot;No node available for &quot;</span> + blockInfo);</span><br><span class="line">      &#125;</span><br><span class="line">      DFSClient.LOG.info(<span class="string">&quot;Could not obtain &quot;</span> + block.getBlock()</span><br><span class="line">          + <span class="string">&quot; from any node: &quot;</span> + ie + errMsg</span><br><span class="line">          + <span class="string">&quot;. Will get new block locations from namenode and retry...&quot;</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Introducing a random factor to the wait time before another retry.</span></span><br><span class="line">        <span class="comment">// The wait time is dependent on # of failures and a random factor.</span></span><br><span class="line">        <span class="comment">// At the first time of getting a BlockMissingException, the wait time</span></span><br><span class="line">        <span class="comment">// is a random number between 0..3000 ms. If the first retry</span></span><br><span class="line">        <span class="comment">// still fails, we will wait 3000 ms grace period before the 2nd retry.</span></span><br><span class="line">        <span class="comment">// Also at the second retry, the waiting window is expanded to 6000 ms</span></span><br><span class="line">        <span class="comment">// alleviating the request rate from the server. Similarly the 3rd retry</span></span><br><span class="line">        <span class="comment">// will wait 6000ms grace period before retry and the waiting window is</span></span><br><span class="line">        <span class="comment">// expanded to 9000ms. </span></span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> timeWindow = dfsClient.getConf().timeWindow;</span><br><span class="line">        <span class="keyword">double</span> waitTime = timeWindow * failures +       <span class="comment">// grace period for the last round of attempt</span></span><br><span class="line">          timeWindow * (failures + <span class="number">1</span>) * DFSUtil.getRandom().nextDouble(); <span class="comment">// expanding time window for each failure</span></span><br><span class="line">        DFSClient.LOG.warn(<span class="string">&quot;DFS chooseDataNode: got # &quot;</span> + (failures + <span class="number">1</span>) + <span class="string">&quot; IOException, will wait for &quot;</span> + waitTime + <span class="string">&quot; msec.&quot;</span>);</span><br><span class="line">        Thread.sleep((<span class="keyword">long</span>)waitTime);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (InterruptedException iex) &#123;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// ä»blockçš„æ‰€æœ‰dnä¸­æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„dnï¼Œåˆ™å°†deadNodesæ¸…ç©ºï¼Œé‡æ–°è·å–è¯¥blockçš„ä¿¡æ¯</span></span><br><span class="line">      <span class="comment">// ä¸€ä¸ªblockä¸€ä¸ªdeadNodes</span></span><br><span class="line">      deadNodes.clear(); <span class="comment">//2nd option is to remove only nodes[blockId]</span></span><br><span class="line">      openInfo();</span><br><span class="line">      block = getBlockAt(block.getStartOffset(), <span class="keyword">false</span>);</span><br><span class="line">      failures++;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> DNAddrPair <span class="title">getBestNodeDNAddrPair</span><span class="params">(LocatedBlock block,</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;DatanodeInfo&gt; ignoredNodes)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  DatanodeInfo[] nodes = block.getLocations();</span><br><span class="line">  StorageType[] storageTypes = block.getStorageTypes();</span><br><span class="line">  DatanodeInfo chosenNode = <span class="keyword">null</span>;</span><br><span class="line">  StorageType storageType = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">if</span> (nodes != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// éå†é€‰å‡ºédeadNodeèŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; nodes.length; i++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!deadNodes.containsKey(nodes[i])</span><br><span class="line">          &amp;&amp; (ignoredNodes == <span class="keyword">null</span> || !ignoredNodes.contains(nodes[i]))) &#123;</span><br><span class="line">        chosenNode = nodes[i];</span><br><span class="line">        <span class="comment">// Storage types are ordered to correspond with nodes, so use the same</span></span><br><span class="line">        <span class="comment">// index to get storage type.</span></span><br><span class="line">        <span class="keyword">if</span> (storageTypes != <span class="keyword">null</span> &amp;&amp; i &lt; storageTypes.length) &#123;</span><br><span class="line">          storageType = storageTypes[i];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¾ªç¯äº†ä¸€åœˆä¾ç„¶æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„dn</span></span><br><span class="line">  <span class="keyword">if</span> (chosenNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;No live nodes contain block &quot;</span> + block.getBlock() +</span><br><span class="line">        <span class="string">&quot; after checking nodes = &quot;</span> + Arrays.toString(nodes) +</span><br><span class="line">        <span class="string">&quot;, ignoredNodes = &quot;</span> + ignoredNodes);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> String dnAddr =</span><br><span class="line">      chosenNode.getXferAddr(dfsClient.getConf().connectToDnViaHostname);</span><br><span class="line">  <span class="keyword">if</span> (DFSClient.LOG.isDebugEnabled()) &#123;</span><br><span class="line">    DFSClient.LOG.debug(<span class="string">&quot;Connecting to datanode &quot;</span> + dnAddr);</span><br><span class="line">  &#125;</span><br><span class="line">  InetSocketAddress targetAddr = NetUtils.createSocketAddr(dnAddr);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DNAddrPair(chosenNode, targetAddr, storageType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chooseDataNodeè°ƒç”¨<code>getBestNodeDNAddrPair</code>åœ¨<em>blockçš„locationsä¸­é€‰æ‹©ä¸€ä¸ªdn</em>ï¼Œå¦‚æœæ²¡æœ‰æ‰¾åˆ°åˆ™æŠ›å‡ºä¸€ä¸ª<em>IOExceptionå¼‚å¸¸</em>ï¼Œåœ¨chooseDataNodeä¸­æ•è·ï¼Œåœ¨catchä¸­æ ¡éªŒé‡è¯•æ¬¡æ•°æ˜¯å¦è¶…è¿‡<code>dfs.client.max.block.acquire.failures</code>ï¼Œæ²¡æœ‰åˆ™æ¸…ç©ºdeadNodeså†æ¬¡å»è·å–è¯¥blockçš„locationsã€‚ä¾ç„¶å¤±è´¥åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚</p><p>chooseDataNodeç»“æŸè¿”å›åˆ°blockSeekToä¸­ï¼Œç”±BlockReaderFactoryåˆ›å»ºBlockReaderå¯¹è±¡ï¼Œè¿™é‡Œåˆ›å»ºçš„BlockReaderå¯¹è±¡ä¼šæ ¹æ®<em>short circuit local read</em>è¿˜æ˜¯<em>è¿œç¨‹è¯»</em>åˆ›å»ºä¸åŒçš„BlockReaderã€‚BlockReaderFactoryä½¿ç”¨äº†Builderè®¾è®¡æ¨¡å¼ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> BlockReader <span class="title">build</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  BlockReader reader = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  Preconditions.checkNotNull(configuration);</span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦å¼€å¯äº†short circuit local read</span></span><br><span class="line">  <span class="comment">// short circuit local read ä½¿ç”¨çš„å°±æ˜¯ Unix Domain SocketæŠ€æœ¯ï¼Œ</span></span><br><span class="line">  <span class="comment">// é‚£ä¸ºä»€ä¹ˆè¿˜è¦å°†conf.domainSocketDataTrafficä½œä¸ºä¸€ä¸ªå¤‡é€‰æ–¹æ¡ˆ</span></span><br><span class="line">  <span class="keyword">if</span> (conf.shortCircuitLocalReads &amp;&amp; allowShortCircuitLocalReads) &#123;</span><br><span class="line">    <span class="keyword">if</span> (clientContext.getUseLegacyBlockReaderLocal()) &#123;</span><br><span class="line">      reader = getLegacyBlockReaderLocal();</span><br><span class="line">      <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">          LOG.trace(<span class="keyword">this</span> + <span class="string">&quot;: returning new legacy block reader local.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      reader = getBlockReaderLocal();</span><br><span class="line">      <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">          LOG.trace(<span class="keyword">this</span> + <span class="string">&quot;: returning new block reader local.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> reader;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é€šè¿‡UNIX domain socket å¾—åˆ°ä¸€ä¸ªremote block reader</span></span><br><span class="line">  <span class="comment">// ä¸short circuit local read çš„åŒºåˆ«ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  <span class="keyword">if</span> (conf.domainSocketDataTraffic) &#123;</span><br><span class="line">    reader = getRemoteBlockReaderFromDomain();</span><br><span class="line">    <span class="keyword">if</span> (reader != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">        LOG.trace(<span class="keyword">this</span> + <span class="string">&quot;: returning new remote block reader using &quot;</span> +</span><br><span class="line">            <span class="string">&quot;UNIX domain socket on &quot;</span> + pathInfo.getPath());</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> reader;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  Preconditions.checkState(!DFSInputStream.tcpReadsDisabledForTesting,</span><br><span class="line">      <span class="string">&quot;TCP reads were disabled for testing, but we failed to &quot;</span> +</span><br><span class="line">      <span class="string">&quot;do a non-TCP read.&quot;</span>);</span><br><span class="line">  <span class="comment">// è¿”å›è¿œç¨‹BlockReader</span></span><br><span class="line">  <span class="keyword">return</span> getRemoteBlockReaderFromTcp();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¾—åˆ°BlockReaderä¹‹åä»£ç å›åˆ°<code>readWithStrategy</code>ä¸­ï¼Œç„¶åè¿›è¡Œ<code>readBuffer</code>æ“ä½œï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// corruptedBlockMapåœ¨readWithStrategyä¸­è¢«å®ä¾‹åŒ–</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">readBuffer</span><span class="params">(ReaderStrategy reader, <span class="keyword">int</span> off, <span class="keyword">int</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">    Map&lt;ExtendedBlock, Set&lt;DatanodeInfo&gt;&gt; corruptedBlockMap)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  IOException ioe;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/* we retry current node only once. So this is set to true only here.</span></span><br><span class="line"><span class="comment">   * Intention is to handle one common case of an error that is not a</span></span><br><span class="line"><span class="comment">   * failure on datanode or client : when DataNode closes the connection</span></span><br><span class="line"><span class="comment">   * since client is idle. If there are other cases of &quot;non-errors&quot; then</span></span><br><span class="line"><span class="comment">   * then a datanode might be retried by setting this to true again.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">boolean</span> retryCurrentNode = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">// retry as many times as seekToNewSource allows.</span></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">return</span> reader.doRead(blockReader, off, len, readStatistics);</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( ChecksumException ce ) &#123;</span><br><span class="line">      DFSClient.LOG.warn(<span class="string">&quot;Found Checksum error for &quot;</span></span><br><span class="line">          + getCurrentBlock() + <span class="string">&quot; from &quot;</span> + currentNode</span><br><span class="line">          + <span class="string">&quot; at &quot;</span> + ce.getPos());        </span><br><span class="line">      ioe = ce;</span><br><span class="line">      retryCurrentNode = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// we want to remember which block replicas we have tried</span></span><br><span class="line">      addIntoCorruptedBlockMap(getCurrentBlock(), currentNode,</span><br><span class="line">          corruptedBlockMap);</span><br><span class="line">    &#125; <span class="keyword">catch</span> ( IOException e ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!retryCurrentNode) &#123;</span><br><span class="line">        DFSClient.LOG.warn(<span class="string">&quot;Exception while reading from &quot;</span></span><br><span class="line">            + getCurrentBlock() + <span class="string">&quot; of &quot;</span> + src + <span class="string">&quot; from &quot;</span></span><br><span class="line">            + currentNode, e);</span><br><span class="line">      &#125;</span><br><span class="line">      ioe = e;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">boolean</span> sourceFound = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (retryCurrentNode) &#123;</span><br><span class="line">      <span class="comment">/* possibly retry the same node so that transient errors don&#x27;t</span></span><br><span class="line"><span class="comment">       * result in application level failures (e.g. Datanode could have</span></span><br><span class="line"><span class="comment">       * closed the connection because the client is idle for too long).</span></span><br><span class="line"><span class="comment">       */</span> </span><br><span class="line">      sourceFound = seekToBlockSource(pos);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      addToDeadNodes(currentNode);</span><br><span class="line">      sourceFound = seekToNewSource(pos);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (!sourceFound) &#123;</span><br><span class="line">      <span class="keyword">throw</span> ioe;</span><br><span class="line">    &#125;</span><br><span class="line">    retryCurrentNode = <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>readBufferæ˜¯é€šè¿‡è°ƒç”¨ByteArrayStrategyé‡å†™çš„doReadæ–¹æ³•æ¥readçš„ï¼Œè€Œ<code>ByteArrayStrategy.doRead</code>åˆæ˜¯è°ƒç”¨<code>BlockReader.read</code>æ¥è¿›è¡ŒçœŸæ­£çš„è¯»æ“ä½œã€‚</p><p>doReadæ—¶readBufferä¼šæ•è·åˆ°ChecksumExceptionå’ŒIOExceptionå¼‚å¸¸ï¼Œ</p><ul><li>å¦‚æœæ£€æµ‹åˆ°_ChecksumException_å¼‚å¸¸ï¼ŒretryCurrentNode å˜ä¸ºfasleï¼Œå°†å½“å‰èŠ‚ç‚¹åŠ å…¥deadNodesï¼Œç„¶åè¿›è¡ŒseekToNewSource</li><li>å¦‚æœæ£€æµ‹åˆ°_IOException_å¼‚å¸¸ï¼Œå¹¶ä¸”retryCurrentNodeä¸ºtrueï¼Œåˆ™è¿›è¡ŒseekToBlockSource<pre><code>            å¦‚æœretryCurrentNodeä¸ºfalseï¼Œå°†å½“å‰èŠ‚ç‚¹åŠ å…¥deadNodesï¼Œç„¶åè¿›è¡ŒseekToNewSource</code></pre></li></ul><p>retryCurrentNodeæ ‡è¯†å½“å‰èŠ‚ç‚¹readå¤±è´¥ä¹‹åæ˜¯å¦è¿›è¡Œé‡è¯•ï¼Œå¦‚æœæ˜¯ChecksumExceptionå¤±è´¥ï¼Œåˆ™ä¸è¿›è¡Œé‡è¯•ï¼Œå¦‚æœæ˜¯IOExceptionå¤±è´¥ï¼Œåˆ™è¿›è¡Œé‡è¯•ï¼Œå¹¶ä¸”åªé‡è¯•ä¸€æ¬¡ã€‚_å› ä¸ºå¯èƒ½å­˜åœ¨ç”±äºclienté•¿æ—¶é—´æ²¡æœ‰ä»»ä½•åŠ¨ä½œï¼Œåˆ™dnå…³é—­äº†è¿æ¥å¯¼è‡´IOExceptionï¼Œæ­¤æ—¶è¿›è¡Œé‡è¯•_ã€‚__æ­¤å¤„è¿›è¡Œé‡è¯•å¹¶ä¸æ˜¯é©¬ä¸Šå¯¹è¯¥èŠ‚ç‚¹è¿›è¡Œé‡è¯•ï¼Œåªæ˜¯ä¸è¯¥èŠ‚ç‚¹æ ‡ä¸ºdeadï¼Œå¯ä»¥åœ¨éšåçš„choseNodeæ—¶å¯ä»¥è¢«å†æ¬¡é€‰æ‹©__ã€‚</p><p>ç”±seekToNewSourceæ¥é€‰æ‹©å†æ¬¡readçš„èŠ‚ç‚¹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">seekToNewSource</span><span class="params">(<span class="keyword">long</span> targetPos)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> markedDead = deadNodes.containsKey(currentNode);</span><br><span class="line">  addToDeadNodes(currentNode);</span><br><span class="line">  DatanodeInfo oldNode = currentNode;</span><br><span class="line">  DatanodeInfo newNode = blockSeekTo(targetPos);</span><br><span class="line">  <span class="keyword">if</span> (!markedDead) &#123;</span><br><span class="line">    <span class="comment">/* remove it from deadNodes. blockSeekTo could have cleared </span></span><br><span class="line"><span class="comment">     * deadNodes and added currentNode again. Thats ok. */</span></span><br><span class="line">    deadNodes.remove(oldNode);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!oldNode.getDatanodeUuid().equals(newNode.getDatanodeUuid())) &#123;</span><br><span class="line">    currentNode = newNode;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çœŸæ­£çš„readæ“ä½œæ˜¯<code>BlockReader.read</code>ï¼ŒBlockReaderæ˜¯åœ¨blockSeekToä¸­å®ä¾‹åŒ–çš„ï¼Œæ­¤å¤„æ˜¯_è¿œç¨‹read_ï¼Œå…¶å®ç°æ˜¯<code>RemoteBlockReader2.read</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RemoteBlockReader2.read</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">byte</span>[] buf, <span class="keyword">int</span> off, <span class="keyword">int</span> len)</span> </span></span><br><span class="line"><span class="function">                             <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line"></span><br><span class="line">  UUID randomId = <span class="keyword">null</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (curDataSlice == <span class="keyword">null</span> || curDataSlice.remaining() == <span class="number">0</span> &amp;&amp; bytesNeededToFinish &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    readNextPacket();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (curDataSlice.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// we&#x27;re at EOF now</span></span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¦‚æœbufçš„lenå°äºcurDataSliceçš„é•¿åº¦ï¼Œå‰©ä¸‹çš„å†…å®¹æ€ä¹ˆè¯»</span></span><br><span class="line">  <span class="keyword">int</span> nRead = Math.min(curDataSlice.remaining(), len);</span><br><span class="line">  <span class="comment">// ä»curDataSliceä¸­è¯»å–æ•°æ®åˆ°bufä¸­</span></span><br><span class="line">  curDataSlice.get(buf, off, nRead);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> nRead;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">readNextPacket</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">//Read packet headers.</span></span><br><span class="line">  packetReceiver.receiveNextPacket(in);</span><br><span class="line"></span><br><span class="line">  PacketHeader curHeader = packetReceiver.getHeader();</span><br><span class="line">  curDataSlice = packetReceiver.getDataSlice();</span><br><span class="line">  <span class="keyword">assert</span> curDataSlice.capacity() == curHeader.getDataLen();</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">if</span> (curHeader.getDataLen() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// bytesPerChecksum å¤šå°‘å­—èŠ‚ä¸€ä¸ªcheckcum</span></span><br><span class="line">    <span class="comment">// curHeader.getDataLenå¾—åˆ°æ•°æ®dataçš„é•¿åº¦ï¼Œç„¶åå¾—å‡ºéœ€è¦å¤šå°‘ä¸ªchunks</span></span><br><span class="line">    <span class="keyword">int</span> chunks = <span class="number">1</span> + (curHeader.getDataLen() - <span class="number">1</span>) / bytesPerChecksum;</span><br><span class="line">    <span class="comment">// å¾—å‡ºchecksumçš„é•¿åº¦</span></span><br><span class="line">    <span class="keyword">int</span> checksumsLen = chunks * checksumSize;</span><br><span class="line">    ...</span><br><span class="line">    lastSeqNo = curHeader.getSeqno();</span><br><span class="line">    <span class="keyword">if</span> (verifyChecksum &amp;&amp; curDataSlice.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// N.B.: the checksum error offset reported here is actually</span></span><br><span class="line">      <span class="comment">// relative to the start of the block, not the start of the file.</span></span><br><span class="line">      <span class="comment">// This is slightly misleading, but preserves the behavior from</span></span><br><span class="line">      <span class="comment">// the older BlockReader.</span></span><br><span class="line">      <span class="comment">// åˆ©ç”¨checksumæ£€æŸ¥æ•°æ®æ˜¯å¦æ­£ç¡®</span></span><br><span class="line">      checksum.verifyChunkedSums(curDataSlice,</span><br><span class="line">          packetReceiver.getChecksumSlice(),</span><br><span class="line">          filename, curHeader.getOffsetInBlock());</span><br><span class="line">    &#125;</span><br><span class="line">    bytesNeededToFinish -= curHeader.getDataLen();</span><br><span class="line">  &#125;    </span><br><span class="line">  </span><br><span class="line">  <span class="comment">// First packet will include some data prior to the first byte</span></span><br><span class="line">  <span class="comment">// the user requested. Skip it.</span></span><br><span class="line">  <span class="keyword">if</span> (curHeader.getOffsetInBlock() &lt; startOffset) &#123;</span><br><span class="line">    <span class="keyword">int</span> newPos = (<span class="keyword">int</span>) (startOffset - curHeader.getOffsetInBlock());</span><br><span class="line">    curDataSlice.position(newPos);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we&#x27;ve now satisfied the whole client read, read one last packet</span></span><br><span class="line">  <span class="comment">// header, which should be empty</span></span><br><span class="line">  <span class="comment">// bytesNeededToFinishæ˜¯è¡¨ç¤ºè¿˜éœ€è¦è¯»å¤šå°‘å­—èŠ‚ï¼Œ</span></span><br><span class="line">  <span class="comment">// è¿™ä¸ªæ˜¯åœ¨å“ªèµ‹å€¼çš„ï¼Ÿæ€ä¹ˆçŸ¥é“è¿˜æœ‰å¤šå°‘å­—èŠ‚è¦è¯»</span></span><br><span class="line">  <span class="keyword">if</span> (bytesNeededToFinish &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// è¯»å–ç»“æŸ</span></span><br><span class="line">    readTrailingEmptyPacket();</span><br><span class="line">    <span class="keyword">if</span> (verifyChecksum) &#123;</span><br><span class="line">      sendReadResult(Status.CHECKSUM_OK);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      sendReadResult(Status.SUCCESS);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>readæ—¶packetæ˜¯åŸºæœ¬çš„ä¼ è¾“å•ä½ï¼Œæ¯ä¸ªpacket(é»˜è®¤æ¯ä¸ªpacketä¸º64K)ç”±è‹¥å¹²ä¸ªchunkç»„æˆï¼Œæ¯ä¸ªchunkå¯¹åº”ä¸€ä¸ªchunksumã€‚</p><p>curDataSliceä¸­å­˜å‚¨è¿™éœ€è¦è¯»å–dataçš„ä¿¡æ¯ï¼Œåˆæ¬¡è¯»å–packetæ—¶ï¼ŒcurDataSliceä¸ºnullï¼Œè¿›è¡Œpacketè¯»å–<code>readNextPacket</code>ï¼Œå¯¹curDataSliceè¿›è¡Œèµ‹å€¼ï¼ˆ_ä¹Ÿå°±æ˜¯å…ˆæŠŠå†…å®¹è¯»å–åˆ°packetä¸­ï¼Œæ­¤æ—¶curDataSliceå°±ç›¸å½“äºä¸€ä¸ªpacket_ï¼‰ï¼Œå¹¶å¯¹packetä¸­çš„æ•°æ®è°ƒç”¨<code>checksum.verifyChunkedSums</code>è¿›è¡Œchecksumæ£€éªŒã€‚</p><p>æœ€åç”±<code>curDataSlice.get(buf, off, nRead)</code>ä»curDataSliceè¯»å–ä¸€å®šé•¿åº¦çš„byteæ”¾å…¥bufä¸­ã€‚</p><p>åˆ™ä¸€æ¬¡è°ƒç”¨readæµç¨‹ç»“æŸï¼Œä¸€æ¬¡readåªæ˜¯ä»packetä¸­è¯»å–ä¸€äº›byteï¼Œå†æ¬¡è°ƒç”¨readä¼šç»§ç»­ä»curDataSliceä¸­getä¸€å®šé•¿åº¦çš„byteï¼Œç›´åˆ°<code>curDataSlice.remaining() == 0 &amp;&amp; bytesNeededToFinish &gt; 0</code>æ—¶ï¼Œä¹Ÿå°±æ˜¯å½“å‰packetå†…å®¹è¯»å–å®Œæ¯•ï¼Œç„¶åå†æ¬¡è°ƒç”¨readNextPacketè¿›è¡Œè¯»å–blockã€‚</p><p>ç®€å•è¯´ä¸‹packetçš„æ•°æ®ç»“æ„</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Each packet looks like:</span></span><br><span class="line"><span class="comment">//   PLEN    HLEN      HEADER     CHECKSUMS  DATA</span></span><br><span class="line"><span class="comment">//   32-bit  16-bit   &lt;protobuf&gt;  &lt;variable length&gt;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// PLEN:      Payload length</span></span><br><span class="line"><span class="comment">//            = length(PLEN) + length(CHECKSUMS) + length(DATA)</span></span><br><span class="line"><span class="comment">//            This length includes its own encoded length in</span></span><br><span class="line"><span class="comment">//            the sum for historical reasons.</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// HLEN:      Header length</span></span><br><span class="line"><span class="comment">//            = length(HEADER)</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">// HEADER:    the actual packet header fields, encoded in protobuf</span></span><br><span class="line"><span class="comment">// CHECKSUMS: the crcs for the data chunk. May be missing if</span></span><br><span class="line"><span class="comment">//            checksums were not requested</span></span><br><span class="line"><span class="comment">// DATA       the actual block data</span></span><br></pre></td></tr></table></figure><p>HDFSä¸€ä¸ªæ–‡ä»¶ç”±å¤šä¸ªblockæ„æˆã€‚HDFSåœ¨è¿›è¡Œblockè¯»å†™çš„æ—¶å€™æ˜¯ä»¥packet(é»˜è®¤æ¯ä¸ªpacketä¸º64K)ä¸ºå•ä½è¿›è¡Œçš„ã€‚æ¯ä¸€ä¸ªpacketç”±è‹¥å¹²ä¸ªchunkï¼ˆé»˜è®¤512Byteï¼‰ç»„æˆã€‚Chunkæ˜¯è¿›è¡Œæ•°æ®æ ¡éªŒçš„åŸºæœ¬å•ä½ï¼Œå¯¹æ¯ä¸€ä¸ªchunkç”Ÿæˆä¸€ä¸ªæ ¡éªŒå’Œ(é»˜è®¤4Byte)å¹¶å°†æ ¡éªŒå’Œè¿›è¡Œå­˜å‚¨ã€‚åœ¨è¯»å–ä¸€ä¸ªblockçš„æ—¶å€™ï¼Œæ•°æ®ä¼ è¾“çš„åŸºæœ¬å•ä½æ˜¯packetï¼Œæ¯ä¸ªpacketç”±è‹¥å¹²ä¸ªchunkç»„æˆã€‚</p><h2 id="è¡¥å……"><a href="#è¡¥å……" class="headerlink" title="è¡¥å……"></a>è¡¥å……</h2><h3 id="getRemoteBlockReaderFromTcpä»£ç è·Ÿè¯»"><a href="#getRemoteBlockReaderFromTcpä»£ç è·Ÿè¯»" class="headerlink" title="getRemoteBlockReaderFromTcpä»£ç è·Ÿè¯»"></a>getRemoteBlockReaderFromTcpä»£ç è·Ÿè¯»</h3><p>getRemoteBlockReaderFromTcpå¾—åˆ°ä¸€ä¸ªè¿œç¨‹BlockReader</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> BlockReader <span class="title">getRemoteBlockReaderFromTcp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  BlockReader blockReader = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    BlockReaderPeer curPeer = <span class="keyword">null</span>;</span><br><span class="line">    Peer peer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">//Get the next TCP-based peer-- either from the cache or by creating it.</span></span><br><span class="line">      curPeer = nextTcpPeer();</span><br><span class="line">      <span class="keyword">if</span> (curPeer == <span class="keyword">null</span>) <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">if</span> (curPeer.fromCache) remainingCacheTries--;</span><br><span class="line">      peer = curPeer.peer;</span><br><span class="line">      <span class="comment">// é€šè¿‡peerå¾—åˆ°æŸä¸ªblockçš„blockReader</span></span><br><span class="line">      blockReader = getRemoteBlockReader(peer);</span><br><span class="line">      <span class="keyword">return</span> blockReader;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (blockReader == <span class="keyword">null</span>) &#123;</span><br><span class="line">        IOUtils.cleanup(LOG, peer);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> BlockReader <span class="title">getRemoteBlockReader</span><span class="params">(Peer peer)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (conf.useLegacyBlockReader) &#123;</span><br><span class="line">    <span class="keyword">return</span> RemoteBlockReader.newBlockReader(fileName,</span><br><span class="line">        block, token, startOffset, length, conf.ioBufferSize,</span><br><span class="line">        verifyChecksum, clientName, peer, datanode,</span><br><span class="line">        clientContext.getPeerCache(), cachingStrategy);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> RemoteBlockReader2.newBlockReader(</span><br><span class="line">        fileName, block, token, startOffset, length,</span><br><span class="line">        verifyChecksum, clientName, peer, datanode,</span><br><span class="line">        clientContext.getPeerCache(), cachingStrategy);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// RemoteBlockReader2</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> BlockReader <span class="title">newBlockReader</span><span class="params">(String file,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   ExtendedBlock block,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   Token&lt;BlockTokenIdentifier&gt; blockToken,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="keyword">long</span> startOffset, <span class="keyword">long</span> len,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="keyword">boolean</span> verifyChecksum,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   String clientName,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   Peer peer, DatanodeID datanodeID,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   PeerCache peerCache,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   CachingStrategy cachingStrategy)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// in and out will be closed when sock is closed (by the caller)</span></span><br><span class="line">  <span class="comment">// ä½¿ç”¨Socketå»ºç«‹å†™å…¥æµï¼Œ</span></span><br><span class="line">  <span class="keyword">final</span> DataOutputStream out = <span class="keyword">new</span> DataOutputStream(<span class="keyword">new</span> BufferedOutputStream(</span><br><span class="line">        peer.getOutputStream()));</span><br><span class="line">  <span class="comment">// å‘DataNodeå‘é€è¯»æŒ‡ä»¤</span></span><br><span class="line">  <span class="comment">// æ­¤å¤„çš„readBlockä¸DataXceiverä¸­çš„readBlockçš„åŒºåˆ«æ˜¯å•¥ï¼Ÿè¿™æ˜¯ä¸€ä¸ªrpcè°ƒç”¨ï¼Ÿï¼Ÿ</span></span><br><span class="line">  <span class="comment">// Senderæ˜¯clientç«¯ï¼ŒDataXceiveræ˜¯Serverç«¯ï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  <span class="keyword">new</span> Sender(out).readBlock(block, blockToken, clientName, startOffset, len,</span><br><span class="line">      verifyChecksum, cachingStrategy);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Get bytes in block</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  DataInputStream in = <span class="keyword">new</span> DataInputStream(peer.getInputStream());</span><br><span class="line"></span><br><span class="line">  BlockOpResponseProto status = BlockOpResponseProto.parseFrom(</span><br><span class="line">      PBHelper.vintPrefixed(in));</span><br><span class="line">  checkSuccess(status, peer, block, file);</span><br><span class="line">  ReadOpChecksumInfoProto checksumInfo =</span><br><span class="line">    status.getReadOpChecksumInfo();</span><br><span class="line">  DataChecksum checksum = DataTransferProtoUtil.fromProto(</span><br><span class="line">      checksumInfo.getChecksum());</span><br><span class="line">  <span class="comment">//Warning when we get CHECKSUM_NULL?</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Read the first chunk offset.</span></span><br><span class="line">  <span class="keyword">long</span> firstChunkOffset = checksumInfo.getChunkOffset();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( firstChunkOffset &lt; <span class="number">0</span> || firstChunkOffset &gt; startOffset ||</span><br><span class="line">      firstChunkOffset &lt;= (startOffset - checksum.getBytesPerChecksum())) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;BlockReader: error in first chunk offset (&quot;</span> +</span><br><span class="line">                          firstChunkOffset + <span class="string">&quot;) startOffset is &quot;</span> +</span><br><span class="line">                          startOffset + <span class="string">&quot; for file &quot;</span> + file);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> RemoteBlockReader2(file, block.getBlockPoolId(), block.getBlockId(),</span><br><span class="line">      checksum, verifyChecksum, startOffset, firstChunkOffset, len, peer,</span><br><span class="line">      datanodeID, peerCache);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="éšæœºè¯»"><a href="#éšæœºè¯»" class="headerlink" title="éšæœºè¯»"></a>éšæœºè¯»</h3><p>HDFSè¯»æ–‡ä»¶åŒ…å«ä¸¤ç§ï¼Œä¸€ç§æ˜¯æœ€ç»å¸¸ä½¿ç”¨çš„é¡ºåºè¯»ï¼Œå¦ä¸€ç§æ˜¯éšæœºè¯»ã€‚åƒMRä»»åŠ¡ï¼Œä¸€èˆ¬éƒ½ä¼šæ¶‰åŠåˆ°éšæœºè¯»ã€‚MRåœ¨æäº¤ä½œä¸šæ—¶ï¼Œå·²ç»ç¡®å®šäº†æ¯ä¸ªmapå’Œreduceè¦è¯»å–çš„æ–‡ä»¶ï¼Œæ–‡ä»¶çš„åç§»é‡ï¼Œè¯»å–çš„é•¿åº¦ï¼Œåˆ™åªè¯»å–ç›¸åº”çš„splitå°±è¡Œã€‚</p><p>éšæœºè¯»çš„ä»£ç å…¥å£å‡½æ•°ä¾ç„¶åœ¨<code>FSDataInputStream</code>ä¸­ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FSDataInputStream.read</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">long</span> position, <span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ((PositionedReadable)in).read(position, buffer, offset, length);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//DFSInputStream.read</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">read</span><span class="params">(<span class="keyword">long</span> position, <span class="keyword">byte</span>[] buffer, <span class="keyword">int</span> offset, <span class="keyword">int</span> length)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// sanity checks</span></span><br><span class="line">  dfsClient.checkOpen();</span><br><span class="line">  <span class="keyword">if</span> (closed) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;Stream closed&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  failures = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">long</span> filelen = getFileLength();</span><br><span class="line">  <span class="keyword">if</span> ((position &lt; <span class="number">0</span>) || (position &gt;= filelen)) &#123;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">int</span> realLen = length;</span><br><span class="line">  <span class="keyword">if</span> ((position + length) &gt; filelen) &#123;</span><br><span class="line">    realLen = (<span class="keyword">int</span>)(filelen - position);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// determine the block and byte range within the block</span></span><br><span class="line">  <span class="comment">// corresponding to position and realLen</span></span><br><span class="line">  List&lt;LocatedBlock&gt; blockRange = getBlockRange(position, realLen);</span><br><span class="line">  <span class="keyword">int</span> remaining = realLen;</span><br><span class="line">  Map&lt;ExtendedBlock,Set&lt;DatanodeInfo&gt;&gt; corruptedBlockMap </span><br><span class="line">    = <span class="keyword">new</span> HashMap&lt;ExtendedBlock, Set&lt;DatanodeInfo&gt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> (LocatedBlock blk : blockRange) &#123;</span><br><span class="line">    <span class="keyword">long</span> targetStart = position - blk.getStartOffset();</span><br><span class="line">    <span class="keyword">long</span> bytesToRead = Math.min(remaining, blk.getBlockSize() - targetStart);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (dfsClient.isHedgedReadsEnabled()) &#123;</span><br><span class="line">        hedgedFetchBlockByteRange(blk, targetStart, targetStart + bytesToRead</span><br><span class="line">            - <span class="number">1</span>, buffer, offset, corruptedBlockMap);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        fetchBlockByteRange(blk, targetStart, targetStart + bytesToRead - <span class="number">1</span>,</span><br><span class="line">            buffer, offset, corruptedBlockMap);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="comment">// Check and report if any block replicas are corrupted.</span></span><br><span class="line">      <span class="comment">// BlockMissingException may be caught if all block replicas are</span></span><br><span class="line">      <span class="comment">// corrupted.</span></span><br><span class="line">      reportCheckSumFailure(corruptedBlockMap, blk.getLocations().length);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    remaining -= bytesToRead;</span><br><span class="line">    position += bytesToRead;</span><br><span class="line">    offset += bytesToRead;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">assert</span> remaining == <span class="number">0</span> : <span class="string">&quot;Wrong number of bytes read.&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (dfsClient.stats != <span class="keyword">null</span>) &#123;</span><br><span class="line">    dfsClient.stats.incrementBytesRead(realLen);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> realLen;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>è¿™ä¸¤ç¯‡æ–‡ç« ä¸»è¦ä»‹ç»äº†hdfsè¯»æ–‡ä»¶çš„æµç¨‹ï¼Œæ•´ä¸ªæµç¨‹ä¸ºï¼š</p><ol><li>å¾—åˆ°ä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„å®ä¾‹ï¼Œé€šè¿‡getFileSystemå¾—åˆ°</li><li>openä¸€ä¸ªæ–‡ä»¶è¾“å…¥æµï¼Œopenæ—¶æ ¹æ®æŒ‡å®šçš„pathè°ƒç”¨rpcæ‰“å¼€ä¸€ä¸ªFSDataInputStreamï¼Œåœ¨åˆå§‹åŒ–è¾“å…¥æµæ—¶ï¼Œä¼šå°†ä¸€éƒ¨åˆ†blockçš„locationsä¿¡æ¯è¯»å…¥å†…å­˜è¿›è¡Œç¼“å­˜ï¼Œé»˜è®¤æ˜¯10ä¸ªblockã€‚å°†è¾“å…¥æµçš„å®ä¾‹è¿”å›ç»™clientã€‚<em>å†…å­˜ä¸­ç¼“å­˜çš„blockå·²ç»æ˜¯æŒ‰ç…§å„ä¸ªdnåˆ°clientçš„è·ç¦»è¿›è¡Œæ’åºä¹‹åçš„ç»“æœ</em></li><li>è¾“å…¥æµå®ä¾‹åŒ–ä¹‹åï¼Œè°ƒç”¨readæ–¹æ³•è¯»å–æ•°æ®ã€‚(è¯»åˆ†ä¸ºé¡ºåºè¯»å’Œéšæœºè¯»)<ol><li>readæ—¶å¯ä»¥é€‰æ‹©å‡ ç§ReaderStrategyï¼Œæœ¬ç¯‡é€‰æ‹©çš„æ˜¯ByteArrayStrategyã€‚</li><li>æ ¹æ®offå’Œlenè¿›è¡Œè¯»ã€‚é€šè¿‡offæ‰¾åˆ°å¯¹åº”çš„block A(äºŒåˆ†æŸ¥æ‰¾)ï¼Œå¦‚æœblock Aåœ¨ä¹‹å‰çš„ç¼“å­˜ä¸­ï¼Œåˆ™ç›´æ¥è¿”å›block Aã€‚å¦‚æœblock Aä¸åœ¨ä¹‹å‰çš„ç¼“å­˜ä¸­ï¼Œåˆ™å†æ¬¡è¯·æ±‚ä»nnè¯·æ±‚ä¸€éƒ¨åˆ†blockï¼Œå°†æ–°è¯·æ±‚çš„blocksæ ¹æ®å…¶ä¸­blockåœ¨åŸç¼“å­˜ä¸­çš„ä½ç½®æ’å…¥åˆ°ç¼“å­˜ä¸­ï¼Œä¹‹åå¾—åˆ°è¯¥offå¯¹åº”çš„block Aã€‚</li><li>é€šè¿‡block Aé€‰æ‹©ç¦»clientæœ€è¿‘çš„dnï¼Œ*å¦‚æœå¾—åˆ°dnæ—¶å‘ç”ŸIOExceptioné”™è¯¯(å½“ä»locationsä¸­æ²¡æœ‰é€‰æ‹©åˆ°åˆé€‚çš„dnæ—¶ï¼ŒæŠ›å‡ºIOException)*ï¼Œåˆ™ç­‰å¾…ä¸€æ®µæ—¶é—´ä¹‹åï¼Œè¿›è¡Œé‡è¯•ï¼Œé»˜è®¤æ˜¯é‡è¯•3æ¬¡ã€‚</li><li>å¾—åˆ°dnä¹‹åï¼Œé€šè¿‡BlockReadè¿›è¡Œè¯»å–æ•°æ®ï¼ŒBlockReadæ ¹æ®æ˜¯å¦short circuit local å’Œ remoteå®ä¾‹åŒ–ä¸åŒçš„BlockReadã€‚</li><li><em>readæ•°æ®æ—¶å‘ç”Ÿçš„é”™è¯¯ä¸ºchecksumExceptionå’ŒIOException</em>ï¼Œå¦‚æœæ˜¯ChecksumExceptionåˆ™å°†dnæ”¾å…¥deadNodesä¸­ï¼Œæ¢ä¸ªdnè¿›è¡Œé‡è¯»ï¼Œå¦‚æœæ˜¯IOExceptionåˆ™ç›´æ¥é‡è¯»(<em>å¯èƒ½æ˜¯è¿æ¥æ–­å¼€äº†</em>)ï¼Œä¸å°†dnæ”¾å…¥deadNodesä¸­ã€‚</li><li>æœ¬ç¯‡ä»‹ç»çš„æ˜¯RemoteBlockReaderï¼Œè¯»æ–‡ä»¶æ—¶æ˜¯ä»¥packetä¸ºå•ä½çš„ï¼Œè¯»å–ä¸€ä¸ªpacketæ”¾å…¥å†…å­˜ï¼Œå¯¹å…¶ä¸­çš„chunkè¿›è¡Œchecksumæ ¡éªŒã€‚ä»å†…å­˜ä¸­è¯»å–lençš„é•¿åº¦ï¼Œå¦‚æœè¯»å®Œåˆ™ç»§ç»­è¯»å–ä¸‹ä¸€ä¸ªpacketã€‚<em>è¯»å–å®Œæ¯•ä¹‹åå‘é€ä¸€ä¸ªç©ºpacketã€‚</em><strong>æ˜¯blockçš„æœ€åä¸€ä¸ªpacketè¿˜æ˜¯ï¼Ÿï¼Ÿ</strong></li><li>è¯»æ–‡ä»¶æ—¶è¿˜éœ€è¦dnç«¯çš„ä¸€äº›æ“ä½œï¼Œä¸»è¦ç±»æ˜¯DataXceiverï¼Œè¿™ä¸ªç±»éšåå†åˆ†æã€‚</li></ol></li></ol><h2 id="é—®é¢˜"><a href="#é—®é¢˜" class="headerlink" title="é—®é¢˜"></a>é—®é¢˜</h2><ul><li>ä½•ç§æƒ…å†µä¸‹blockä¼šä¸¢å¤±</li><li>è¯»å–é€Ÿåº¦æ…¢ï¼ŒæŸä¸ªnodeè¯»å–å¤±è´¥</li><li>æ€ä¹ˆåˆ¤æ–­éœ€è¦åˆ›å»ºè¿œç¨‹BlockReaderè¿˜æ˜¯æœ¬åœ°BlockReader(æ˜¯å¦è¿˜æœ‰æœ¬åœ°è¯»çš„æ¦‚å¿µï¼Œéƒ½æ˜¯é€šè¿‡remoteå—ï¼Ÿ)<br>ä»…ç”±æ­¤æ¥åˆ¤æ–­æ˜¯å¦å¼€å¯æœ¬åœ°è¯»è¿˜æ˜¯è¿œç¨‹è¯»ï¼Ÿ  setRemotePeerFactory<br>allowShortCircuitLocalReads å½“ å½“å‰æ–‡ä»¶æ­£åœ¨æ„å»ºä¸­åˆ™ä¸ºfalse</li><li>readæŸä¸ªblockçš„dnæ—¶ï¼Œå‡ºé”™ï¼Œæ€ä¹ˆåŠ<br>çœ‹åœ¨å“ªå‡ºé”™ï¼Ÿæ˜¯åœ¨get block dnæ—¶è¿˜æ˜¯åœ¨å¾—åˆ°dnè¿›è¡Œreadæ—¶å‡ºé”™ï¼Œ<br><em>å¦‚æœåœ¨get blockçš„dnæ—¶å‡ºé”™</em>ï¼Œé‡å¤3æ¬¡ä¾ç„¶å‡ºé”™ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸ã€‚<br><em>å¦‚æœåœ¨å¾—åˆ°dnä¹‹åï¼Œreadæ—¶å‡ºé”™</em>ï¼Œæ­¤æ—¶åˆåˆ†ä¸¤ç§æƒ…å†µï¼Œå¦‚æœæ˜¯checksumé”™ï¼Œæ¢ä¸ªdné‡è¯»ï¼Œå¦‚æœæ˜¯IOExceptionï¼Œåˆ™ç›´æ¥é‡è¯•ã€‚</li><li>å‘é€ï¼Œæ•°æ®æ˜¯æ€ä¹ˆå‘é€çš„ï¼Ÿï¼Ÿï¼Ÿ   è¯»çš„è¿‡ç¨‹ä¸­æœ‰sendå˜›ï¼Ÿ</li><li>è¯»å–æŸä¸ªdnçš„blockæ—¶å¤±è´¥ï¼Œå°†æ­¤dnåŠ å…¥å“ªï¼Ÿæˆ–è€…dnæ­»æ‰ï¼Œã€‚ã€‚<br>  åŠ å…¥deadNodes</li><li>è¿™ä¸ªdeadNodesæ˜¯è°ç»´æŠ¤çš„ï¼Ÿåªæ˜¯æœ¬æ¬¡è¯»ï¼Ÿ<br>è¯»ä¸€ä¸ªblockï¼Œä¸€ä¸ªdeadNodes</li><li>In HDFS, why corrupted block(s) happens?<br> dfs.datanode.scan.period.hours</li><li>Sender(out).readBlockä¸DataXceiverä¸­çš„readBlockçš„åŒºåˆ«æ˜¯å•¥ï¼Ÿè¿™æ˜¯ä¸€ä¸ªrpcè°ƒç”¨ï¼Ÿï¼Ÿ<br>// Senderæ˜¯clientç«¯ï¼ŒDataXceiveræ˜¯Serverç«¯ï¼Ÿï¼Ÿï¼Ÿ</li></ul><h2 id="ç›¸å…³é…ç½®å±æ€§"><a href="#ç›¸å…³é…ç½®å±æ€§" class="headerlink" title="ç›¸å…³é…ç½®å±æ€§"></a>ç›¸å…³é…ç½®å±æ€§</h2><ul><li><p>io.file.buffer.size(4096)<br> The size of buffer for use in sequence files. The size of this buffer should probably be a multiple of hardware page size (4096 on Intel x86), and it determines how much data is buffered during read and write operations.</p></li><li><p>dfs.client.read.prefetch.size</p></li></ul><p>prefetchSize = conf.getLong(DFS_CLIENT_READ_PREFETCH_SIZE_KEY,<br>          10 * defaultBlockSize);</p><ul><li><p>dfs.client.<em>cache.drop</em>.behind.reads (vs dfs.datanode.<em>drop.cache</em>.behind.reads)</p><p> Just like dfs.datanode.drop.cache.behind.reads, this setting causes the page cache to be dropped behind HDFS reads, potentially freeing up more memory for other uses. Unlike dfs.datanode.drop.cache.behind.reads, this is a client-side setting rather than a setting for the entire datanode. If present, this setting will override the DataNode default. If the native libraries are not available to the DataNode, this configuration has no effect.</p><p> In some workloads, the data read from HDFS is known to be significantly large enough that it is unlikely to be useful to cache it in the operating system buffer cache. In this case, the DataNode may be configured to automatically purge all data from the buffer cache after it is delivered to the client. This behavior is automatically disabled for workloads which read only short sections of a block (e.g HBase random-IO workloads). This may improve performance for some workloads by freeing buffer cache space usage for more cacheable data. If the Hadoop native libraries are not available, this configuration has no effect.</p></li></ul><ul><li><p>dfs.client.cache.drop.behind.writes</p></li><li><p>dfs.client.cache.readahead (vs dfs.datanode.readahead.bytes)</p><p> When using remote reads, this setting causes the datanode to read ahead in the block file using posix_fadvise, potentially decreasing I/O wait times. Unlike dfs.datanode.readahead.bytes, this is a client-side setting rather than a setting for the entire datanode. If present, this setting will override the DataNode default. When using local reads, this setting determines how much readahead we do in BlockReaderLocal. If the native libraries are not available to the DataNode, this configuration has no effect.</p></li></ul>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> read </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NameNodeå†…å­˜è§£æåŠå¤§å°è¯„ä¼°</title>
      <link href="/NameNode%E5%86%85%E5%AD%98%E8%A7%A3%E6%9E%90%E5%8F%8A%E5%A4%A7%E5%B0%8F%E8%AF%84%E4%BC%B0.html"/>
      <url>/NameNode%E5%86%85%E5%AD%98%E8%A7%A3%E6%9E%90%E5%8F%8A%E5%A4%A7%E5%B0%8F%E8%AF%84%E4%BC%B0.html</url>
      
        <content type="html"><![CDATA[<p>HDFSç”±NameNodeå’ŒDataNodeç»„æˆï¼Œå…¶ä¸­NameNodeä½œä¸ºMasterèŠ‚ç‚¹ï¼Œè´Ÿè´£ç»´æŠ¤æ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€ï¼Œä¸ºäº†æé«˜å“åº”é€Ÿåº¦å…¶å¤§éƒ¨åˆ†æ•°æ®éƒ½å¸¸é©»å†…å­˜ï¼Œåˆ™NameNodeå†…å­˜çš„ä½¿ç”¨å°¤ä¸ºé‡è¦ï¼Œä¸€æ—¦NameNodeå‡ºç°æ•…éšœï¼Œæ•´ä¸ªHadoopé›†ç¾¤å°±å°†å¤„äºä¸å¯æœåŠ¡çš„çŠ¶æ€ã€‚</p><p>åœ¨è§£æNameNodeå†…å­˜ä¹‹å‰å…ˆæ¥å›é¡¾ä¸‹HDFSæ•´ä½“æ¶æ„ã€‚</p><span id="more"></span><h2 id="HDFSæ¶æ„"><a href="#HDFSæ¶æ„" class="headerlink" title="HDFSæ¶æ„"></a>HDFSæ¶æ„</h2><p><img src="/blogimgs/NameNode%E5%86%85%E5%AD%98%E8%AF%84%E4%BC%B0/HDFS-A.gif" alt="HDFSæ¶æ„" title="HDFSæ¶æ„"><br>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºHDFSå¯ä»¥åˆ†ä¸ºä¸¤å±‚ï¼Œåˆ†åˆ«ä¸ºNameSpaceå’ŒBlock Storage Serviceï¼Œå…¶ä¸­Block Storage ServiceåŒ…å«Block Managementå’ŒStorageä¸¤éƒ¨åˆ†ã€‚</p><p>NameSpaceå’ŒBlock Managementåœ¨NameNodeä¸­ï¼ŒStorageåœ¨DataNodeä¸­ã€‚</p><p>NameSpaceä¸»è¦å­˜å‚¨é›†ç¾¤çš„ç›®å½•ç»“æ„å’Œæ–‡ä»¶æ‰€å¯¹åº”çš„blockæ˜ å°„(file-&gt;blocksçš„æ˜ å°„)ï¼Œæ˜¯HDFSæ–‡ä»¶ç³»ç»Ÿå®é™…æ‰§è¡Œçš„æ ¸å¿ƒï¼Œæä¾›å„ç§å¢åˆ æ”¹æŸ¥æ–‡ä»¶æ“ä½œæ¥å£ã€‚</p><p>Block Management</p><ul><li>é€šè¿‡æ³¨å†Œå’Œå‘¨æœŸæ€§çš„å¿ƒè·³æä¾›dné›†ç¾¤æˆå‘˜</li><li>å¤„ç†dnçš„block reportï¼Œå­˜å‚¨åœ¨BlocksMapä¸­</li><li>æä¾›blockç›¸å…³çš„æ“ä½œï¼Œå¦‚createã€deleteã€modifå’Œget block location</li><li>ç®¡ç†replicaçš„æ”¾ç½®ç­–ç•¥ï¼Œä¸è¶³å‰¯æœ¬å› å­çš„replicaè¿›è¡Œå¤åˆ¶ï¼Œè¶…è¿‡å‰¯æœ¬å› å­çš„replicaè¿›è¡Œåˆ é™¤</li></ul><p>Storage<br>ç”±DataNodeæä¾›ï¼Œç”¨äºå°†replicaå­˜æ”¾åœ¨æœ¬åœ°æ–‡ä»¶ç³»ç»Ÿä¸­å¹¶æä¾›è¯»å†™æƒé™ã€‚</p><p>ç”±ä¸Šå¾—çŸ¥NameNodeä¸­ä¸»è¦ç”±NameSpaceå’ŒBlock Managementç»„æˆï¼Œå…¶ä¸­NameSpaceå’ŒBlocksMapæ˜¯å å†…å­˜çš„å¤§æˆ·ã€‚</p><h2 id="NameNodeå†…å­˜æ¦‚è¿°"><a href="#NameNodeå†…å­˜æ¦‚è¿°" class="headerlink" title="NameNodeå†…å­˜æ¦‚è¿°"></a>NameNodeå†…å­˜æ¦‚è¿°</h2><p>NameNodeçš„å†…å­˜ä¸­é™¤äº†ä¸Šé¢æåˆ°çš„NameSpaceå’ŒBlocksMapä¹‹å¤–ï¼Œè¿˜æœ‰ç»´æŠ¤æ•´ä¸ªé›†ç¾¤æ‹“æ‰‘ç»“æ„çš„NetworkTopologyã€ç®¡ç†æ•´ä¸ªé›†ç¾¤å†™ç§Ÿçº¦çš„LeaseManagerã€ç®¡ç†é›†ä¸­å¼ç¼“å­˜çš„CacheManagerå’ŒSnapshotManagerã€‚NameNodeçš„å†…å­˜ç»“æ„å¦‚ä¸‹å›¾ï¼š<br><img src="/blogimgs/NameNode%E5%86%85%E5%AD%98%E8%AF%84%E4%BC%B0/namenodemem.png" alt="NameNodeå†…å­˜ç»“æ„" title="NameNodeå†…å­˜ç»“æ„"><br>Namespaceï¼šç»´æŠ¤æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•æ ‘ç»“æ„ï¼ŒåŠç›®å½•æ ‘ä¸Šçš„çŠ¶æ€å˜åŒ–ï¼›<br>BlocksManagerï¼šç»´æŠ¤æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿä¸­ä¸æ•°æ®å—ç›¸å…³çš„ä¿¡æ¯ï¼ŒåŠæ•°æ®å—çš„çŠ¶æ€å˜åŒ–ï¼›<br>NetworkTopologyï¼šç»´æŠ¤æœºæ¶æ‹“æ‰‘åŠDataNodeä¿¡æ¯ï¼Œæœºæ¶æ„ŸçŸ¥çš„åŸºç¡€ï¼›<br>LeaseManagerï¼šè¯»å†™çš„äº’æ–¥åŒæ­¥å°±æ˜¯é Leaseå®ç°ï¼Œæ”¯æŒHDFSçš„Write-Once-Read-Manyçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼›<br>CacheManagerï¼š<em>Hadoop 2.3.0å¼•å…¥çš„é›†ä¸­å¼ç¼“å­˜æ–°ç‰¹æ€§</em>ï¼Œæ”¯æŒé›†ä¸­å¼ç¼“å­˜çš„ç®¡ç†ï¼Œå®ç°memory-localityæå‡è¯»æ€§èƒ½ï¼›<br>SnapshotManagerï¼š<em>Hadoop 2.1.0å¼•å…¥çš„Snapshotæ–°ç‰¹æ€§</em>ï¼Œç”¨äºæ•°æ®å¤‡ä»½ã€å›æ»šï¼Œä»¥é˜²æ­¢å› ç”¨æˆ·è¯¯æ“ä½œå¯¼è‡´é›†ç¾¤å‡ºç°æ•°æ®é—®é¢˜ï¼›<br>DelegationTokenSecretManagerï¼šç®¡ç†HDFSçš„å®‰å…¨è®¿é—®ï¼›<br>å…¶ä»–ï¼šä¸´æ—¶æ•°æ®ä¿¡æ¯ã€ç»Ÿè®¡ä¿¡æ¯metricsç­‰ç­‰ã€‚</p><p>NameNodeå¸¸é©»å†…å­˜ä¸»è¦è¢«Namespaceå’ŒBlockManagerä½¿ç”¨ï¼ŒäºŒè€…ä½¿ç”¨å æ¯”åˆ†åˆ«æ¥è¿‘50%ã€‚å…¶ä»–éƒ¨åˆ†å†…å­˜å¼€é”€è¾ƒå°ä¸”ç›¸å¯¹å›ºå®šï¼Œä¸Namespaceå’ŒBlockManagerç›¸æ¯”åŸºæœ¬å¯ä»¥å¿½ç•¥ã€‚</p><h2 id="NameNodeå†…å­˜è§£æ"><a href="#NameNodeå†…å­˜è§£æ" class="headerlink" title="NameNodeå†…å­˜è§£æ"></a>NameNodeå†…å­˜è§£æ</h2><h3 id="NameSpace"><a href="#NameSpace" class="headerlink" title="NameSpace"></a>NameSpace</h3><p>ä¸å•æœºæ–‡ä»¶ç³»ç»Ÿç›¸ä¼¼ï¼ŒHDFSå¯¹æ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„ä¹Ÿæ˜¯æŒ‰ç…§æ ‘çŠ¶ç»“æ„ç»´æŠ¤ï¼ŒNamespaceä¿å­˜äº†ç›®å½•æ ‘åŠæ¯ä¸ªç›®å½•/æ–‡ä»¶èŠ‚ç‚¹çš„å±æ€§ã€‚<em>é™¤åœ¨å†…å­˜å¸¸é©»å¤–ï¼Œè¿™éƒ¨åˆ†æ•°æ®ä¼šå®šæœŸflushåˆ°æŒä¹…åŒ–è®¾å¤‡ä¸Šï¼Œç”Ÿæˆä¸€ä¸ªæ–°çš„FsImageæ–‡ä»¶ï¼Œæ–¹ä¾¿NameNodeå‘ç”Ÿé‡å¯æ—¶ï¼Œä»FsImageåŠæ—¶æ¢å¤æ•´ä¸ªNamespace</em>ã€‚</p><p>åœ¨æ•´ä¸ªNamespaceç›®å½•æ ‘ä¸­å­˜åœ¨ä¸¤ç§ä¸åŒç±»å‹çš„<em>INode</em>æ•°æ®ç»“æ„ï¼šINodeDirectoryå’ŒINodeFileã€‚å…¶ä¸­<em>INodeDirectoryæ ‡è¯†çš„æ˜¯ç›®å½•æ ‘ä¸­çš„ç›®å½•</em>ï¼Œ<em>INodeFileæ ‡è¯†çš„æ˜¯ç›®å½•æ ‘ä¸­çš„æ–‡ä»¶</em>ã€‚ç”±äºäºŒè€…å‡ç»§æ‰¿è‡ªINodeï¼Œæ‰€ä»¥å…·å¤‡å¤§éƒ¨åˆ†ç›¸åŒçš„å…¬å…±ä¿¡æ¯INodeWithAdditionalFieldsï¼Œé™¤å¸¸ç”¨åŸºç¡€å±æ€§å¤–ï¼Œå…¶ä¸­è¿˜æä¾›äº†æ‰©å±•å±æ€§featuresï¼Œå¦‚Quotaï¼ŒSnapshotç­‰å‡é€šè¿‡Featureå¢åŠ ï¼Œå¦‚æœä»¥åå‡ºç°æ–°å±æ€§ä¹Ÿå¯é€šè¿‡Featureæ–¹ä¾¿æ‰©å±•ã€‚ä¸åŒçš„æ˜¯ï¼ŒINodeFileç‰¹æœ‰çš„æ ‡è¯†<em>å‰¯æœ¬æ•°å’Œæ•°æ®å—å¤§å°ç»„åˆçš„header</em>ï¼ˆ2.6.1ä¹‹ååˆæ–°å¢äº†æ ‡è¯†å­˜å‚¨ç­–ç•¥IDçš„ä¿¡æ¯ï¼‰åŠè¯¥æ–‡ä»¶åŒ…å«çš„æœ‰åºBlocksæ•°ç»„ï¼›INodeDirectoryåˆ™ç‰¹æœ‰å­èŠ‚ç‚¹çš„åˆ—è¡¨childrenã€‚è¿™é‡Œéœ€è¦ç‰¹åˆ«è¯´æ˜childrenæ˜¯é»˜è®¤å¤§å°ä¸º5çš„ArrayListï¼ŒæŒ‰ç…§å­èŠ‚ç‚¹nameæœ‰åºå­˜å‚¨ï¼Œè™½ç„¶åœ¨æ’å…¥æ—¶ä¼šæŸå¤±ä¸€éƒ¨åˆ†å†™æ€§èƒ½ï¼Œä½†æ˜¯å¯ä»¥æ–¹ä¾¿åç»­å¿«é€ŸäºŒåˆ†æŸ¥æ‰¾æé«˜è¯»æ€§èƒ½ï¼Œå¯¹ä¸€èˆ¬å­˜å‚¨ç³»ç»Ÿï¼Œè¯»æ“ä½œæ¯”å†™æ“ä½œå æ¯”è¦é«˜ã€‚</p><h3 id="BlockManager"><a href="#BlockManager" class="headerlink" title="BlockManager"></a>BlockManager</h3><p>BlocksMapåœ¨NameNodeçš„å†…å­˜ç©ºé—´ä¸­å æ®å¾ˆå¤§çš„æ¯”ä¾‹ï¼Œç”±BlockManagerç»Ÿä¸€ç®¡ç†ã€‚ç›¸æ¯”NameSpaceï¼ŒBlockManagerç®¡ç†çš„è¿™éƒ¨åˆ†æ•°æ®è¦å¤æ‚çš„å¤šã€‚<em>Namespaceä¸BlockManagerä¹‹é—´é€šè¿‡å‰é¢æåˆ°çš„INodeFileæœ‰åºBlocksæ•°ç»„å…³è”åˆ°ä¸€èµ·</em>ã€‚ä¸‹å›¾æ˜¯BlockManagerç®¡ç†çš„å†…å­˜ç»“æ„ã€‚<br><img src="/blogimgs/NameNode%E5%86%85%E5%AD%98%E8%AF%84%E4%BC%B0/blockmanager.png" alt="BlockManager" title="BlockManager"></p><p>INodeFileæ˜¯ä¸€ä¸ªå®ä½“fileåœ¨NameNodeå†…å­˜ä¸­çš„ä¸€ä¸ªå¯¹è±¡ï¼ŒåŒ…å«ä¸€ä¸ªå­˜æ”¾blockä¿¡æ¯çš„BlockInfoæ•°ç»„ï¼Œæ•°ç»„çš„å¤§å°ä¸ºæ–‡ä»¶blockçš„ä¸ªæ•°ã€‚å¦‚ä¸Šå›¾BlockInfo[A~K]æ‰€ç¤ºã€‚</p><p>BlockInfoç»§æ‰¿è‡ªBlockï¼Œç»´æŠ¤çš„æ˜¯Blockçš„å…ƒæ•°æ®ï¼Œé™¤åŸºæœ¬ä¿¡æ¯å¤–è¿˜åŒ…æ‹¬ä¸€ä¸ª*inodeå¼•ç”¨(<code>private BlockCollection bc</code>)<em>ï¼Œè¡¨ç¤ºè¯¥blockæ‰€å±çš„æ–‡ä»¶ï¼›ä»¥åŠä¸€ä¸ªè®°å½•replicaåˆ°åº•å­˜æ”¾åœ¨é‚£äº›dnä¸Šçš„ä¸‰å…ƒç»„æ•°ç»„<code>Object[] triplets</code>ï¼Œå¤§å°ä¸º3</em>replicasï¼Œå…¶ä¸­replicasæ˜¯Blockå‰¯æœ¬æ•°é‡ã€‚tripletsåŒ…å«çš„ä¿¡æ¯ï¼š</p><p>triplets[3<em>i]ï¼šBlockæ‰€åœ¨çš„DataNode Aï¼›(<em>DatanodeStorageInfoå¯¹è±¡</em>)<br>triplets[3</em>i+1]ï¼šè¯¥DataNode Aä¸Šå‰ä¸€ä¸ªBlockï¼›(<em>æŒ‡å‘å‰ä¸€ä¸ªblockçš„BlockInfoå¯¹è±¡å¼•ç”¨</em>)<br>triplets[3*i+2]ï¼šè¯¥DataNode Aä¸Šåä¸€ä¸ªBlockï¼›(<em>æŒ‡å‘åä¸€ä¸ªblockçš„BlockInfoå¯¹è±¡å¼•ç”¨</em>)</p><p>å…¶ä¸­iè¡¨ç¤ºçš„æ˜¯Blockçš„ç¬¬iä¸ªå‰¯æœ¬ï¼Œiå–å€¼[0,replicas)ã€‚</p><p>ä»å‰é¢æè¿°ä¸­é€šè¿‡BlockInfoå¯ä»¥å¾—åˆ°ä»¥ä¸‹å‡ å—é‡è¦ä¿¡æ¯ï¼š</p><ul><li>æ–‡ä»¶åŒ…å«äº†å“ªäº›Block(ç”±BlockInfoå¯¹è¯¥æ–‡ä»¶çš„å¼•ç”¨å¯ä»¥å¾—åˆ°è¯¥æ–‡ä»¶æ‰€æœ‰çš„blockä¿¡æ¯)</li><li>è¿™äº›Blockåˆ†åˆ«è¢«å®é™…å­˜å‚¨åœ¨å“ªäº›DataNodeä¸Š(é€šè¿‡BlockInfoçš„tripletsæ•°ç»„å¯ä»¥å¾—åˆ°è¯¥blockçš„replicaå­˜å‚¨ä½ç½®)</li><li>DataNodeä¸Šæ‰€æœ‰Blockå‰åé“¾è¡¨å…³ç³»(é€šè¿‡BlockInfoçš„tripletsæ•°ç»„ä¸­pre)</li></ul><p>å¦‚æœä»ä¿¡æ¯å®Œæ•´åº¦æ¥çœ‹ï¼Œä»¥ä¸Šæ•°æ®è¶³å¤Ÿæ”¯æŒæ‰€æœ‰å…³äºHDFSæ–‡ä»¶ç³»ç»Ÿçš„æ­£å¸¸æ“ä½œï¼Œä½†è¿˜å­˜åœ¨ä¸€ä¸ªä½¿ç”¨åœºæ™¯è¾ƒå¤šçš„é—®é¢˜ï¼š<em>ä¸èƒ½é€šè¿‡blockidå¿«é€Ÿå®šä½Block</em>ï¼Œæ‰€ä»¥å¼•å…¥äº†BlocksMapã€‚</p><p>BlocksMapåº•å±‚é€šè¿‡LightWeightGSetå®ç°(å…³äºLightWeightGSetçš„è¯¦ç»†ä»‹ç»å¯å‚è€ƒ<a href="http://bigdatadecode.top/HDFS%E4%B8%ADLightWeightGSet%E4%B8%8EHashMap%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90.html">è¿™ç¯‡blog</a>)ï¼Œæœ¬è´¨æ˜¯ä¸€ä¸ªé“¾å¼è§£å†³å†²çªçš„å“ˆå¸Œè¡¨ã€‚ä¸ºäº†é¿å…rehashè¿‡ç¨‹å¸¦æ¥çš„æ€§èƒ½å¼€é”€ï¼Œåˆå§‹åŒ–æ—¶ï¼Œç´¢å¼•ç©ºé—´ç›´æ¥ç»™åˆ°äº†æ•´ä¸ªJVMå¯ç”¨å†…å­˜çš„2%ï¼Œå¹¶ä¸”ä¸å†å˜åŒ–ã€‚é›†ç¾¤å¯åŠ¨è¿‡ç¨‹ï¼Œ<em>DataNodeä¼šè¿›è¡ŒBR(BlockReport)ï¼Œæ ¹æ®BRçš„æ¯ä¸€ä¸ªBlockè®¡ç®—å…¶HashCodeï¼Œä¹‹åå°†å¯¹åº”çš„BlockInfoæ’å…¥åˆ°ç›¸åº”ä½ç½®é€æ¸æ„å»ºèµ·æ¥å·¨å¤§çš„BlocksMap</em>ã€‚å‰é¢åœ¨INodeFileé‡Œä¹Ÿæåˆ°çš„BlockInfoé›†åˆï¼Œå¦‚æœæˆ‘ä»¬å°†BlocksMapé‡Œçš„BlockInfoä¸æ‰€æœ‰INodeFileé‡Œçš„BlockInfoåˆ†åˆ«æ”¶é›†èµ·æ¥ï¼Œå¯ä»¥å‘ç°ä¸¤ä¸ªé›†åˆå®Œå…¨ç›¸åŒï¼Œäº‹å®ä¸ŠBlocksMapé‡Œæ‰€æœ‰çš„BlockInfoå°±æ˜¯INodeFileä¸­å¯¹åº”BlockInfoçš„å¼•ç”¨ï¼›é€šè¿‡BlockæŸ¥æ‰¾å¯¹åº”BlockInfoæ—¶ï¼Œä¹Ÿæ˜¯å…ˆå¯¹Blockè®¡ç®—HashCodeï¼Œæ ¹æ®ç»“æœå¿«é€Ÿå®šä½åˆ°å¯¹åº”çš„BlockInfoä¿¡æ¯ã€‚</p><p>å‰é¢æåˆ°éƒ¨åˆ†éƒ½å±äºé™æ€æ•°æ®éƒ¨åˆ†ï¼ŒNameNodeå†…å­˜ä¸­æ‰€æœ‰æ•°æ®éƒ½è¦éšè¯»å†™æƒ…å†µå‘ç”Ÿå˜åŒ–ï¼ŒBlockManagerå½“ç„¶ä¹Ÿéœ€è¦ç®¡ç†è¿™éƒ¨åˆ†åŠ¨æ€æ•°æ®ã€‚ä¸»è¦æ˜¯å½“Blockå‘ç”Ÿå˜åŒ–ä¸ç¬¦åˆé¢„æœŸæ—¶éœ€è¦åŠæ—¶è°ƒæ•´Blocksçš„åˆ†å¸ƒã€‚è¿™é‡Œæ¶‰åŠå‡ ä¸ªæ ¸å¿ƒçš„æ•°æ®ç»“æ„ï¼š</p><ul><li>excessReplicateMapï¼šè‹¥æŸä¸ªBlockå®é™…å­˜å‚¨çš„å‰¯æœ¬æ•°å¤šäºé¢„è®¾å‰¯æœ¬æ•°ï¼Œè¿™æ—¶å€™éœ€è¦åˆ é™¤å¤šä½™å‰¯æœ¬ï¼Œè¿™é‡Œå¤šä½™å‰¯æœ¬ä¼šè¢«ç½®äºexcessReplicateMapä¸­ã€‚<em>excessReplicateMapæ˜¯ä»DataNodeçš„StorageIDåˆ°Blocké›†åˆçš„æ˜ å°„é›†</em>ã€‚ </li><li>neededReplicationsï¼šè‹¥æŸä¸ªBlockå®é™…å­˜å‚¨çš„å‰¯æœ¬æ•°å°‘äºé¢„è®¾å‰¯æœ¬æ•°ï¼Œè¿™æ—¶å€™éœ€è¦è¡¥å……ç¼ºå°‘å‰¯æœ¬ï¼Œè¿™é‡Œå“ªäº›Blockç¼ºå°‘å¤šå°‘ä¸ªå‰¯æœ¬éƒ½ç»Ÿä¸€å­˜åœ¨neededReplicationsé‡Œï¼Œ<em>æœ¬è´¨ä¸ŠneededReplicationsæ˜¯ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—</em>ï¼Œç¼ºå°‘å‰¯æœ¬æ•°è¶Šå¤šçš„Blockä¹‹åè¶Šä¼šè¢«ä¼˜å…ˆå¤„ç†ã€‚</li><li>invalidateBlocksï¼šè‹¥æŸä¸ªBlockå³å°†è¢«åˆ é™¤ï¼Œä¼šè¢«ç½®äºinvalidateBlocksä¸­ã€‚invalidateBlocksæ˜¯ä»DataNodeçš„StorageIDåˆ°Blocké›†åˆçš„æ˜ å°„é›†ã€‚å¦‚æŸä¸ªæ–‡ä»¶è¢«å®¢æˆ·ç«¯æ‰§è¡Œäº†åˆ é™¤æ“ä½œï¼Œè¯¥æ–‡ä»¶æ‰€å±çš„æ‰€æœ‰Blockä¼šå…ˆè¢«ç½®äºinvalidateBlocksä¸­ã€‚ </li><li>corruptReplicasï¼šæœ‰äº›åœºæ™¯Blockç”±äºæ—¶é—´æˆ³/é•¿åº¦ä¸åŒ¹é…ç­‰ç­‰é€ æˆBlockä¸å¯ç”¨ï¼Œä¼šè¢«æš‚å­˜åœ¨corruptReplicasä¸­ï¼Œä¹‹åå†åšå¤„ç†ã€‚</li></ul><blockquote><p>å…³äºè¿™å‡ ä¸ªæ•°æ®ç»“æ„åœ¨ç»´æŒå‰¯æœ¬å¹³è¡¡ä¸­çš„æ›´å¤šå†…å®¹ï¼Œå¯ä»¥ç§»æ­¥åˆ°<a href="http://bigdatadecode.top/HDFS%E7%BB%B4%E6%8C%81%E5%89%AF%E6%9C%AC%E5%B9%B3%E8%A1%A1%E7%9A%84%E6%B5%81%E7%A8%8B.html">è¿™ç¯‡blog</a></p></blockquote><p>å‰é¢å‡ ä¸ªæ¶‰åŠåˆ°Blockåˆ†å¸ƒæƒ…å†µåŠ¨æ€å˜åŒ–çš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œ<em>è¿™é‡Œçš„æ•°æ®å®é™…ä¸Šæ˜¯è¿‡æ¸¡æ€§è´¨çš„</em>ï¼ŒBlocksManagerå†…éƒ¨çš„ReplicationMonitorçº¿ç¨‹(å…³äºReplicationMonitorçš„å†…å®¹å¯ä»¥æŸ¥çœ‹[blog](<a href="http://bigdatadecode.top/HDFS">http://bigdatadecode.top/HDFS</a> ReplicationMonitorå‰¯æœ¬ç›‘æ§çº¿ç¨‹è§£æ.html)ä¼šæŒç»­ä»å…¶ä¸­å–å‡ºæ•°æ®å¹¶é€šè¿‡é€»è¾‘å¤„ç†ååˆ†å‘ç»™å…·ä½“çš„<em>DatanodeDescriptorå¯¹åº”æ•°æ®ç»“æ„</em>ï¼Œå½“å¯¹åº”DataNodeçš„å¿ƒè·³è¿‡æ¥ä¹‹åï¼ŒNameNodeä¼šéå†DatanodeDescriptoré‡Œæš‚å­˜çš„æ•°æ®ï¼Œå°†å…¶è½¬æ¢æˆå¯¹åº”æŒ‡ä»¤è¿”å›ç»™DataNodeï¼ŒDataNodeæ”¶åˆ°ä»»åŠ¡å¹¶æ‰§è¡Œå®Œæˆåå†åé¦ˆå›NameNodeï¼Œä¹‹åDatanodeDescriptoré‡Œå¯¹åº”ä¿¡æ¯è¢«æ¸…é™¤ã€‚å¦‚BlockBé¢„è®¾å‰¯æœ¬æ•°ä¸º3ï¼Œç”±äºæŸç§åŸå› å®é™…å‰¯æœ¬å˜æˆ4(å¦‚ä¹‹å‰ä¸‹çº¿çš„DataNode Dé‡æ–°ä¸Šçº¿ï¼Œå…¶ä¸­Bæ­£å¥½æœ‰BlockBçš„ä¸€ä¸ªå‰¯æœ¬æ•°æ®)ï¼ŒBlockManagerèƒ½åŠæ—¶å‘ç°å‰¯æœ¬å˜åŒ–ï¼Œå¹¶å°†å¤šä½™çš„DataNode Dä¸ŠBlockBå‰¯æœ¬æ”¾ç½®åˆ°excessReplicateMapä¸­ï¼ŒReplicationMonitorçº¿ç¨‹å®šæœŸæ£€æŸ¥æ—¶å‘ç°excessReplicateMapä¸­æ•°æ®åå°†å…¶ç§»åˆ°DataNode Då¯¹åº”DatanodeDescriptorä¸­invalidateBlocksé‡Œï¼Œå½“DataNode Dä¸‹æ¬¡å¿ƒè·³è¿‡æ¥åï¼Œéšå¿ƒè·³è¿”å›åˆ é™¤Block Bçš„æŒ‡ä»¤ï¼ŒDataNode Dæ”¶åˆ°æŒ‡ä»¤å®é™…åˆ é™¤å…¶ä¸Šçš„Block Bæ•°æ®å¹¶åé¦ˆå›NameNodeï¼Œæ­¤åBlockManagerå°†DataNode Dä¸Šçš„Block Bä»å†…å­˜ä¸­æ¸…é™¤ï¼Œè‡³æ­¤Block Bçš„å‰¯æœ¬ç¬¦åˆé¢„æœŸï¼Œæ•´ä¸ªæµç¨‹å¦‚ä¸‹æ‰€ç¤ºã€‚<br><img src="/blogimgs/NameNode%E5%86%85%E5%AD%98%E8%AF%84%E4%BC%B0/blockreplica.png" alt="åˆ é™¤å¤šä½™å‰¯æœ¬æµç¨‹å›¾" title="åˆ é™¤å¤šä½™å‰¯æœ¬æµç¨‹å›¾"></p><h3 id="NetworkTopology"><a href="#NetworkTopology" class="headerlink" title="NetworkTopology"></a>NetworkTopology</h3><p>å‰é¢å¤šæ¬¡æåˆ°Blockä¸DataNodeä¹‹é—´çš„å…³è”å…³ç³»ï¼Œäº‹å®ä¸ŠNameNodeç¡®å®è¿˜éœ€è¦ç®¡ç†æ‰€æœ‰DataNodeï¼Œä¸ä»…å¦‚æ­¤ï¼Œç”±äºæ•°æ®å†™å…¥å‰éœ€è¦ç¡®å®šæ•°æ®å—å†™å…¥ä½ç½®ï¼ŒNameNodeè¿˜ç»´æŠ¤ç€æ•´ä¸ªæœºæ¶æ‹“æ‰‘NetworkTopologyã€‚ä¸‹å›¾æ‰€ç¤ºå†…å­˜ä¸­æœºæ¶æ‹“æ‰‘å›¾ã€‚<br><img src="/blogimgs/NameNode%E5%86%85%E5%AD%98%E8%AF%84%E4%BC%B0/networktopology.png" alt="NetworkTopologyå†…å­˜ç»“æ„" title="NetworkTopologyå†…å­˜ç»“æ„"></p><p>ä»å›¾ä¸­å¯ä»¥çœ‹å‡ºè¿™é‡ŒåŒ…å«ä¸¤ä¸ªéƒ¨åˆ†ï¼š<em>æœºæ¶æ‹“æ‰‘ç»“æ„NetworkTopologyå’ŒDataNodeèŠ‚ç‚¹ä¿¡æ¯</em>ã€‚å…¶ä¸­æ ‘çŠ¶çš„æœºæ¶æ‹“æ‰‘æ˜¯æ ¹æ®æœºæ¶æ„ŸçŸ¥(ä¸€èˆ¬éƒ½æ˜¯å¤–éƒ¨è„šæœ¬è®¡ç®—å¾—åˆ°)åœ¨é›†ç¾¤å¯åŠ¨å®Œæˆåå»ºç«‹èµ·æ¥ï¼Œæ•´ä¸ªæœºæ¶çš„æ‹“æ‰‘ç»“æ„åœ¨NameNodeçš„ç”Ÿå‘½å‘¨æœŸå†…ä¸€èˆ¬ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼›å¦ä¸€éƒ¨åˆ†æ˜¯æ¯”è¾ƒå…³é”®çš„DataNodeä¿¡æ¯ï¼ŒBlockManagerå·²ç»æåˆ°æ¯ä¸€ä¸ªDataNodeä¸Šçš„Blocksé›†åˆéƒ½ä¼šå½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œæ›´å‡†ç¡®çš„åº”è¯¥æ˜¯DataNodeçš„æ¯ä¸€ä¸ªå­˜å‚¨å•å…ƒDatanodeStorageInfoä¸Šçš„æ‰€æœ‰Blocksé›†åˆä¼šå½¢æˆä¸€ä¸ªåŒå‘é“¾è¡¨ï¼Œè¿™ä¸ªé“¾è¡¨çš„å…¥å£å°±æ˜¯æœºæ¶æ‹“æ‰‘ç»“æ„å¶å­èŠ‚ç‚¹å³DataNodeç®¡ç†çš„DatanodeStorageInfoã€‚æ­¤å¤–ç”±äºä¸Šå±‚åº”ç”¨å¯¹æ•°æ®çš„å¢åˆ æŸ¥éšæ—¶å‘ç”Ÿå˜åŒ–ï¼Œéšä¹‹DatanodeStorageInfoä¸Šçš„Blocksä¹Ÿä¼šåŠ¨æ€å˜åŒ–ï¼Œæ‰€ä»¥NetworkTopologyä¸Šçš„DataNodeå¯¹è±¡è¿˜ä¼šç®¡ç†è¿™äº›åŠ¨æ€å˜åŒ–çš„æ•°æ®ç»“æ„ï¼Œå¦‚replicateBlocks/recoverBlocks/invalidateBlocksï¼Œè¿™äº›æ•°æ®ç»“æ„æ­£å¥½å’ŒBlockManagerç®¡ç†çš„åŠ¨æ€æ•°æ®ç»“æ„å¯¹åº”ï¼Œå®ç°äº†æ•°æ®çš„åŠ¨æ€å˜åŒ–ç”±BlockManagerä¼ è¾¾åˆ°DataNodeå†…å­˜å¯¹è±¡æœ€åé€šè¿‡æŒ‡ä»¤ä¸‹è¾¾åˆ°ç‰©ç†DataNodeå®é™…æ‰§è¡Œçš„æµåŠ¨è¿‡ç¨‹ã€‚</p><p>è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œä¸ºä»€ä¹ˆDatanodeStorageInfoä¸‹æ‰€æœ‰Blockä¹‹é—´ä¼šä»¥åŒå‘é“¾è¡¨ç»„ç»‡ï¼Œè€Œä¸æ˜¯å…¶ä»–æ•°æ®ç»“æ„ï¼Ÿå¦‚æœç»“åˆå®é™…åœºæ™¯å°±ä¸éš¾å‘ç°ï¼Œå¯¹æ¯ä¸€ä¸ªDatanodeStorageInfoä¸‹Blockçš„æ“ä½œé›†ä¸­åœ¨å¿«é€Ÿå¢åŠ /åˆ é™¤(BlockåŠ¨æ€å¢å‡å˜åŒ–)åŠé¡ºåºéå†(BlockReportæœŸé—´)ï¼Œæ‰€ä»¥åŒå‘é“¾è¡¨æ˜¯éå¸¸åˆé€‚çš„æ•°æ®ç»“æ„ã€‚</p><h3 id="LeaseManager"><a href="#LeaseManager" class="headerlink" title="LeaseManager"></a>LeaseManager</h3><p>è¿™é‡Œåªç®€å•ä»‹ç»ä¸‹Leaseæœºåˆ¶ï¼Œæ›´å¤šå†…å®¹è¯·æŸ¥çœ‹blog<a href="http://bigdatadecode.top/HDFS%E7%A7%9F%E7%BA%A6%E8%A7%A3%E6%9E%90.html">HDFSç§Ÿçº¦è§£æ</a></p><p>Leaseæœºåˆ¶æ˜¯é‡è¦çš„åˆ†å¸ƒå¼åè®®ï¼Œå¹¿æ³›åº”ç”¨äºå„ç§å®é™…çš„åˆ†å¸ƒå¼ç³»ç»Ÿä¸­ã€‚HDFSæ”¯æŒWrite-Once-Read-Manyï¼Œå¯¹æ–‡ä»¶å†™æ“ä½œçš„äº’æ–¥åŒæ­¥é Leaseå®ç°ã€‚Leaseå®é™…ä¸Šæ˜¯æ—¶é—´çº¦æŸé”ï¼Œå…¶ä¸»è¦ç‰¹ç‚¹æ˜¯æ’ä»–æ€§ã€‚å®¢æˆ·ç«¯å†™æ–‡ä»¶æ—¶éœ€è¦å…ˆç”³è¯·ä¸€ä¸ªLeaseï¼Œä¸€æ—¦æœ‰å®¢æˆ·ç«¯æŒæœ‰äº†æŸä¸ªæ–‡ä»¶çš„Leaseï¼Œå…¶ä»–å®¢æˆ·ç«¯å°±ä¸å¯èƒ½å†ç”³è¯·åˆ°è¯¥æ–‡ä»¶çš„Leaseï¼Œè¿™å°±ä¿è¯äº†åŒä¸€æ—¶åˆ»å¯¹ä¸€ä¸ªæ–‡ä»¶çš„å†™æ“ä½œåªèƒ½å‘ç”Ÿåœ¨ä¸€ä¸ªå®¢æˆ·ç«¯ã€‚NameNodeçš„LeaseManageræ˜¯Leaseæœºåˆ¶çš„æ ¸å¿ƒï¼Œç»´æŠ¤äº†æ–‡ä»¶ä¸Leaseã€å®¢æˆ·ç«¯ä¸Leaseçš„å¯¹åº”å…³ç³»ï¼Œè¿™ç±»ä¿¡æ¯ä¼šéšå†™æ•°æ®çš„å˜åŒ–å®æ—¶å‘ç”Ÿå¯¹åº”æ”¹å˜ã€‚<br><img src="/blogimgs/NameNode%E5%86%85%E5%AD%98%E8%AF%84%E4%BC%B0/leasemanager.png" alt="LeaseManagerå†…å­˜ç»“æ„" title="LeaseManagerå†…å­˜ç»“æ„"></p><p>ä»ä¸Šå›¾ä¸­å¯ä»¥çœ‹å‡ºLeaseManagerå†…å­˜ç»“æ„ä¸­ä¸»è¦åŒ…æ‹¬ä»¥ä¸‹ä¸‰ä¸ªæ ¸å¿ƒæ•°æ®ç»“æ„ï¼š</p><ul><li>sortedLeasesï¼šLeaseé›†åˆï¼ŒæŒ‰ç…§æ—¶é—´å…ˆåè¿›è¡Œæ’åºï¼Œä¾¿äºæ£€æŸ¥Leaseæ˜¯å¦è¶…æ—¶(hardLimit)ï¼›</li><li>leasesï¼šå®¢æˆ·ç«¯åˆ°Leaseçš„æ˜ å°„å…³ç³»ï¼›(ä¸€å¯¹ä¸€ï¼Œä¸€ä¸ªclentå¯¹åº”ä¸€ä¸ªlease)</li><li>sortedLeasesByPathï¼šæ–‡ä»¶è·¯å¾„åˆ°Leaseçš„æ˜ å°„å…³ç³»ï¼›(å¤šå¯¹ä¸€ï¼Œå¤šä¸ªpathå¯¹åº”ä¸€ä¸ªlease)</li></ul><p>å…¶ä¸­æ¯ä¸€ä¸ªå†™æ•°æ®çš„å®¢æˆ·ç«¯ä¼šå¯¹åº”ä¸€ä¸ªLeaseï¼Œæ¯ä¸ªLeaseé‡ŒåŒ…å«è‡³å°‘ä¸€ä¸ªæ ‡è¯†æ–‡ä»¶è·¯å¾„çš„Pathã€‚Leaseæœ¬èº«å·²ç»ç»´æŠ¤äº†å…¶æŒæœ‰è€…(å®¢æˆ·ç«¯)åŠè¯¥Leaseæ­£åœ¨æ“ä½œçš„æ–‡ä»¶è·¯å¾„é›†åˆï¼Œä¹‹æ‰€ä»¥å¢åŠ äº†leaseså’ŒsortedLeasesByPathä¸ºæé«˜é€šè¿‡LeaseæŒæœ‰è€…æˆ–æ–‡ä»¶è·¯å¾„å¿«é€Ÿç´¢å¼•åˆ°Leaseçš„æ€§èƒ½ã€‚</p><p>ç”±äºLeaseæœ¬èº«çš„æ—¶é—´çº¦æŸç‰¹æ€§ï¼Œå½“Leaseå‘ç”Ÿè¶…æ—¶åéœ€è¦å¼ºåˆ¶å›æ”¶ï¼Œå†…å­˜ä¸­ä¸è¯¥Leaseç›¸å…³çš„å†…å®¹è¦è¢«åŠæ—¶æ¸…é™¤ã€‚è¶…æ—¶æ£€æŸ¥åŠè¶…æ—¶åçš„å¤„ç†é€»è¾‘ç”±LeaseManager.Monitorç»Ÿä¸€æ‰§è¡Œã€‚LeaseManagerä¸­ç»´æŠ¤äº†ä¸¤ä¸ªä¸Leaseç›¸å…³çš„è¶…æ—¶æ—¶é—´ï¼šè½¯è¶…æ—¶(softLimit)å’Œç¡¬è¶…æ—¶(hardLimit)ï¼Œä½¿ç”¨åœºæ™¯ç¨æœ‰ä¸åŒã€‚</p><p>æ­£å¸¸æƒ…å†µä¸‹ï¼Œ<em>å®¢æˆ·ç«¯å‘é›†ç¾¤å†™æ–‡ä»¶å‰éœ€è¦å‘NameNodeçš„LeaseManagerç”³è¯·Leaseï¼›å†™æ–‡ä»¶è¿‡ç¨‹ä¸­å®šæœŸæ›´æ–°Leaseæ—¶é—´ï¼Œä»¥é˜²Leaseè¿‡æœŸï¼Œå‘¨æœŸä¸softLimitç›¸å…³</em>ï¼›å†™å®Œæ•°æ®åç”³è¯·é‡Šæ”¾Leaseã€‚æ•´ä¸ªè¿‡ç¨‹å¯èƒ½å‘ç”Ÿä¸¤ç±»é—®é¢˜ï¼š<br>1ã€å†™æ–‡ä»¶è¿‡ç¨‹ä¸­å®¢æˆ·ç«¯æ²¡æœ‰åŠæ—¶æ›´æ–°Leaseæ—¶é—´ï¼›<br>2ã€å†™å®Œæ–‡ä»¶åæ²¡æœ‰æˆåŠŸé‡Šæ”¾Leaseã€‚<br>ä¸¤ä¸ªé—®é¢˜åˆ†åˆ«å¯¹åº”ä¸ºsoftLimitå’ŒhardLimitã€‚ä¸¤ç§åœºæ™¯éƒ½ä¼šè§¦å‘LeaseManagerå¯¹Leaseè¶…æ—¶å¼ºåˆ¶å›æ”¶ã€‚å¦‚æœå®¢æˆ·ç«¯å†™æ–‡ä»¶è¿‡ç¨‹ä¸­æ²¡æœ‰åŠæ—¶æ›´æ–°Leaseè¶…è¿‡softLimitæ—¶é—´åï¼Œå¦ä¸€å®¢æˆ·ç«¯å°è¯•å¯¹åŒä¸€æ–‡ä»¶è¿›è¡Œå†™æ“ä½œæ—¶è§¦å‘Leaseè½¯è¶…æ—¶å¼ºåˆ¶å›æ”¶ï¼›å¦‚æœå®¢æˆ·ç«¯å†™æ–‡ä»¶å®Œæˆä½†æ˜¯æ²¡æœ‰æˆåŠŸé‡Šæ”¾Leaseï¼Œåˆ™ä¼šç”±LeaseManagerçš„åå°çº¿ç¨‹LeaseManager.Monitoræ£€æŸ¥æ˜¯å¦ç¡¬è¶…æ—¶åç»Ÿä¸€è§¦å‘è¶…æ—¶å›æ”¶ã€‚ä¸ç®¡æ˜¯softLimitè¿˜æ˜¯hardLimitè¶…æ—¶è§¦å‘çš„å¼ºåˆ¶Leaseå›æ”¶ï¼Œå¤„ç†é€»è¾‘éƒ½ä¸€æ ·ï¼šFSNamesystem.internalReleaseLeaseï¼Œé€»è¾‘æœ¬èº«æ¯”è¾ƒå¤æ‚ï¼Œè¿™é‡Œä¸å†å±•å¼€(è¯¦ç»†å†…å®¹å¯ä»¥æŸ¥çœ‹<a href="http://bigdatadecode.top/HDFS%E7%A7%9F%E7%BA%A6%E8%A7%A3%E6%9E%90.html">blog</a>)ï¼Œç®€å•çš„è¯´å…ˆå¯¹Leaseè¿‡æœŸå‰æœ€åä¸€æ¬¡å†™å…¥çš„Blockè¿›è¡Œæ£€æŸ¥å’Œä¿®å¤ï¼Œä¹‹åé‡Šæ”¾è¶…æ—¶æŒæœ‰çš„Leaseï¼Œä¿è¯åé¢å…¶ä»–å®¢æˆ·ç«¯çš„å†™å…¥èƒ½å¤Ÿæ­£å¸¸ç”³è¯·åˆ°è¯¥æ–‡ä»¶çš„Leaseã€‚</p><p>NameNodeå†…å­˜æ•°æ®ç»“æ„éå¸¸ä¸°å¯Œï¼Œè¿™é‡Œå¯¹å‡ ä¸ªé‡è¦çš„æ•°æ®ç»“æ„è¿›è¡Œäº†ç®€å•çš„æè¿°ï¼Œé™¤äº†å‰é¢ç½—åˆ—ä¹‹å¤–ï¼Œå…¶å®è¿˜æœ‰å¦‚SnapShotManager/CacheManagerç­‰ï¼Œç”±äºå…¶å†…å­˜å ç”¨æœ‰é™ä¸”æœ‰ä¸€äº›ç‰¹æ€§è¿˜å°šæœªç¨³å®šï¼Œè¿™é‡Œä¸å†å±•å¼€</p><h2 id="NameNodeå†…å­˜å¤§å°è¯„ä¼°"><a href="#NameNodeå†…å­˜å¤§å°è¯„ä¼°" class="headerlink" title="NameNodeå†…å­˜å¤§å°è¯„ä¼°"></a>NameNodeå†…å­˜å¤§å°è¯„ä¼°</h2><p>NameNodeçš„å†…å­˜ä¸»è¦ç”±NameSpaceå’ŒBlocksMapå ç”¨ï¼Œå…¶ä¸­NameSpaceå­˜å‚¨çš„ä¸»è¦æ˜¯INodeFileå’ŒINodeDirectoryå¯¹è±¡ï¼ŒBlocksMapå­˜å‚¨çš„ä¸»è¦æ˜¯BlockInfoå¯¹è±¡ã€‚åˆ™ä¼°ç®—NameNodeå ç”¨çš„å†…å­˜å¤§å°ä¹Ÿå°±æ˜¯ä¼°ç®—é›†ç¾¤ä¸­INodeFileã€INodeDirectoryå’ŒBlockInfoè¿™äº›å¯¹è±¡å ç”¨çš„heapç©ºé—´ã€‚</p><blockquote><p>Javaä¸­å¸¸è§æ•°æ®ç»“æ„å ç”¨çš„å†…å­˜å¤§å°<br>ä¸‹é¢å…ˆåˆ—ä¸¾ä¸‹javaä¸­å¸¸è§æ•°æ®ç»“æ„å ç”¨çš„å†…å­˜å¤§å°(64bitçš„jvm)<br>int = 4 bytes<br>long = 8 bytes<br>Reference size(å¼•ç”¨) = 8 bytes<br>Object header size(å¯¹è±¡å¤´) = 16 bytes<br>Array header size(æ•°ç»„å¤´) = 24 bytes<br>ArrayList header size(listå¤´) = 24(æ•°ç»„å¤´) + 4(å±æ€§sizeçš„å¤§å°) = 28 bytes<br>TreeMap.Entry = 64 bytes. (Entryçš„å±æ€§ä¸­æœ‰5ä¸ªå¼•ç”¨)<br>HashMap.Entry = 48 bytes. (Entryçš„å±æ€§æœ‰3ä¸ªå¼•ç”¨)<br>String header = 64 bytes.</p></blockquote><p>åˆ™å¯¹INodeFileã€INodeDirectoryå’ŒBlockInfoå¯¹è±¡è¿›è¡Œå¤§å°è¯„ä¼°è¿˜æœ‰ä¸€ç‚¹ç–‘æƒ‘ï¼Œçœ‹äº†å‡ ç¯‡èµ„æ–™è¿˜æ˜¯æœ‰ç‚¹ä¸æ¸…æ™°ï¼Œè¿™é‡Œå°±ä¸å±•å¼€äº†ï¼Œæœ‰å…´è¶£çš„å¯ä»¥çœ‹æ–‡ç« æœ«å°¾çš„èµ„æ–™ï¼Œéšåææ¸…æ¥šäº†ä¼šè¿›è¡Œæ›´æ–°ã€‚</p><p>ä½†å‚è€ƒäº†å¾ˆå¤šèµ„æ–™å¦‚<em>Hadoopæƒå¨æŒ‡å—</em>ã€<em>HADOOP-1687</em>ç­‰ï¼ŒINodeFileã€INodeDirectoryå’ŒBlockInfoå¯¹è±¡å¤§å°åœ¨150~200bytesä¹‹é—´ï¼Œå¯ä»¥ä½¿ç”¨150byteså¯¹å…¶å†…å­˜è¿›è¡Œè¯„ä¼°ï¼Œ</p><p>ä¾‹å­ï¼š<br>NameNodeæ–‡ä»¶å’Œblockä¿¡æ¯å¦‚ä¸‹ï¼š<br>94115032 files and directories, 91722740 blocks = 185837772 total filesystem object(s).</p><p>memSum = 185837772 * 150 bytes = 27875665800bytes = 25.9612368g &lt; 26g</p><p>ä½¿ç”¨jmapå‘½ä»¤æŸ¥çœ‹æ­¤æ—¶NameNodeçš„å†…å­˜<br>å‘½ä»¤<code>jmap -histo:live pid &gt; mem</code>ï¼Œè¾“å‡ºå†…å­˜å¤§å°ä¸º24619484976(22.9286821gï¼Œå¤§çº¦23g)</p><blockquote><p>å°æ’æ›²<br>ä½¿ç”¨å‘½ä»¤<code>jmap -heap pid</code>æŸ¥çœ‹nnæ‰€å çš„å†…å­˜æ—¶ï¼Œå‘ç°nnå çš„å†…å­˜æ¯”ä¼°ç®—çš„26gè¦å¤§å¾ˆå¤šï¼Œéšåä½¿ç”¨<code>histo</code>å‘½ä»¤ä¹‹åæ‰å‘ç°å’Œä¼°ç®—çš„å·®ä¸å¤šï¼ŒåŸå› å¯èƒ½æ˜¯ä½¿ç”¨<code>heap</code>æŸ¥çœ‹çš„nnå ç”¨çš„å†…å­˜ï¼Œå…¶ä¸­å¯èƒ½åŒ…æ‹¬ä¸€äº›æ— ç”¨çš„å¯¹è±¡(åœ¨ç­‰å¾…gc)ï¼Œè€Œä½¿ç”¨<code>histo</code>æŸ¥çœ‹çš„æ˜¯nnä¸­å­˜æ´»çš„å¯¹è±¡ï¼Œèƒ½å¤Ÿæ›´å¥½çš„å±•ç¤ºè¯„ä¼°çš„ç»“æœã€‚</p></blockquote><p><em>å¦‚æœæ˜¯2äº¿çš„FileSystem objectåˆ™å†…å­˜ç©ºé—´å¤§çº¦ä¸º30g(200M * 150 = 30000Mï¼Œçº¦ç­‰30G)</em></p><p>æœ¬ç¯‡æ–‡ç« å¤§éƒ¨åˆ†å†…å®¹æ˜¯ä»ç½‘ä¸Šæ•´ç†æ‰€å¾—ï¼Œåªæœ‰å°‘éƒ¨åˆ†æ˜¯åŸåˆ›ï¼Œæ‰€æ¶‰åŠçš„èµ„æ–™åœ¨å‚è€ƒä¸€èŠ‚ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://issues.apache.org/jira/browse/HADOOP-1687">https://issues.apache.org/jira/browse/HADOOP-1687</a><br><a href="http://hexiaoqiao.github.io/blog/2016/07/06/namenode-memory-overview">http://hexiaoqiao.github.io/blog/2016/07/06/namenode-memory-overview</a><br><a href="http://hexiaoqiao.github.io/blog/2016/07/21/namenode-memory-detail/">http://hexiaoqiao.github.io/blog/2016/07/21/namenode-memory-detail/</a></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> Memory </tag>
            
            <tag> Size </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹Fair Scheduler part2</title>
      <link href="/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BFair%20Scheduler%20part2.html"/>
      <url>/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BFair%20Scheduler%20part2.html</url>
      
        <content type="html"><![CDATA[<p>[ä¸Šç¯‡](<a href="http://bigdatadecode.top/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BFair">http://bigdatadecode.top/YARNæºç åˆ†æä¹‹Fair</a> Scheduler part1.html)ä»‹ç»äº†Fair Schedulerä¸­FairShareå’ŒSteadyFairShareçš„è®¡ç®—æ–¹æ³•ï¼Œæœ¬ç¯‡ä¸»è¦ä»‹ç»å…¶æŠ¢å ç›¸å…³çš„çŸ¥è¯†ã€‚</p><p>æŠ¢å åœ¨YARNä¸­ç»å¸¸å‘ç”Ÿï¼Œä½†å…¶åœ¨ä»€ä¹ˆæ—¶å€™å‘ç”Ÿï¼ŒæŠ¢å è°çš„èµ„æºï¼Œåˆå°†æŠ¢å åçš„èµ„æºåˆ†é…ç»™è°ï¼Œè¿™ç¯‡æ–‡ç« å°±å°è¯•ç€å»è§£é‡Šè¿™äº›é—®é¢˜ã€‚</p><p>æœ¬ç¯‡ä¸»è¦å°†åœ¨Fair Schedulerè°ƒåº¦ä¸­å‘ç”Ÿçš„æŠ¢å ã€‚å…ˆä»‹ç»å‡ ä¸ªç›¸å…³é…ç½®ã€‚</p><span id="more"></span><h2 id="ä¸æŠ¢å ç›¸å…³çš„é…ç½®"><a href="#ä¸æŠ¢å ç›¸å…³çš„é…ç½®" class="headerlink" title="ä¸æŠ¢å ç›¸å…³çš„é…ç½®"></a>ä¸æŠ¢å ç›¸å…³çš„é…ç½®</h2><h3 id="yarn-site-xml"><a href="#yarn-site-xml" class="headerlink" title="yarn-site.xml"></a>yarn-site.xml</h3><blockquote><p>yarn.scheduler.fair.preemption</p></blockquote><p>Fairè°ƒåº¦æ—¶æ˜¯å¦å¼€å¯æŠ¢å åŠŸèƒ½ã€‚é»˜è®¤ä¸ºfalse</p><blockquote><p>yarn.scheduler.fair.preemption.cluster-utilization-threshold    </p></blockquote><p>é›†ç¾¤ä¸­ä½¿ç”¨çš„èµ„æºè¶…è¿‡æ­¤é˜ˆå€¼æ—¶ï¼Œæ‰å‘ç”ŸæŠ¢å ã€‚é»˜è®¤æ˜¯0.8f</p><p>è¿˜æœ‰å‡ ä¸ªé…ç½®è²Œä¼¼æ²¡æœ‰å¼€æ”¾è®¾ç½®ï¼Œ</p><ul><li><p><code>yarn.scheduler.fair.waitTimeBeforeKill</code>ï¼Œé»˜è®¤æ˜¯15000msã€‚ç­‰å¾…æ—¶é—´è¶…è¿‡æ­¤å€¼æ—¶ï¼Œå°†æŠ¢å é˜Ÿåˆ—ä¸­çš„containerkillæ‰ã€‚</p></li><li><p><code>yarn.scheduler.fair.preemptionInterval</code>ï¼Œé»˜è®¤æ˜¯5000msï¼Œä¸¤æ¬¡æŠ¢å æ£€æŸ¥çš„æ—¶é—´é—´éš”</p></li></ul><h3 id="fair-scheduler-xml"><a href="#fair-scheduler-xml" class="headerlink" title="fair-scheduler.xml"></a>fair-scheduler.xml</h3><p>åœ¨fair-scheduler.xmlä¸­å¯ä»¥å•ç‹¬å¯¹æŸä¸ªé˜Ÿåˆ—è®¾ç½®æŠ¢å æ—¶é—´å’Œé˜ˆå€¼ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸€ä¸ªå…¨å±€çš„æŠ¢å æ—¶é—´å’Œé˜ˆå€¼ã€‚<br>å¯¹é˜Ÿåˆ—å•ç‹¬è®¾ç½®æ˜¯åœ¨queueä¸­è®¾ç½®ï¼Œå‚æ•°å¦‚ä¸‹ï¼š</p><blockquote><p>fairSharePreemptionTimeout</p></blockquote><p>é˜Ÿåˆ—æ‰€åˆ†é…çš„èµ„æºå°äº<code>fairShare*fairSharePreemptionThreshold</code>çš„æ—¶é—´è¶…è¿‡äº†è¿™ä¸ªé˜ˆå€¼ï¼Œæ­¤é˜Ÿåˆ—å°†ä»åˆ«çš„é˜Ÿåˆ—ä¸­æŠ¢å èµ„æºã€‚å¦‚æœä¸è®¾ç½®ï¼Œæ­¤é˜Ÿåˆ—è¯¥å±æ€§çš„å€¼å°†ç»§æ‰¿çˆ¶é˜Ÿåˆ—çš„è®¾ç½®ã€‚</p><blockquote><p>fairSharePreemptionThreshold</p></blockquote><p>the fair share preemption threshold for the queue.<br>å¦‚æœé˜Ÿåˆ—ç­‰å¾…äº†fairSharePreemptionTimeoutæ—¶é—´ï¼Œé˜Ÿåˆ—ä¸­çš„èµ„æºä¾ç„¶å°‘äº<code>fairSharePreemptionThreshold*fairShare</code>ï¼Œåˆ™ä»åˆ«çš„é˜Ÿåˆ—ä¸­æŠ¢å ã€‚å¦‚æœä¸è®¾ç½®ï¼Œæ­¤é˜Ÿåˆ—è¯¥å±æ€§çš„å€¼å°†ç»§æ‰¿çˆ¶é˜Ÿåˆ—çš„è®¾ç½®ã€‚</p><p>å…¨å±€æŠ¢å å±æ€§è®¾ç½®çš„å‚æ•°å¦‚ä¸‹ï¼š</p><blockquote><p>defaultFairSharePreemptionTimeout</p></blockquote><p>è®¾ç½®rooté˜Ÿåˆ—å‘ç”ŸfairShareæŠ¢å çš„æ—¶é—´é˜ˆå€¼ï¼Œè¢«fairSharePreemptionTimeouté‡å†™</p><blockquote><p>defaultMinSharePreemptionTimeout </p></blockquote><p>è®¾ç½®rooté˜Ÿåˆ—å‘ç”ŸminShareæŠ¢å çš„æ—¶é—´é˜ˆå€¼ï¼Œè¢«minSharePreemptionTimeouté‡å†™</p><blockquote><p>defaultFairSharePreemptionThreshold</p></blockquote><p>è®¾ç½®rooté˜Ÿåˆ—å‘ç”ŸfairShareæŠ¢å èµ„æºçš„é˜ˆå€¼ï¼Œè¢«fairSharePreemptionThresholdé‡å†™ã€‚ä¹Ÿå°±æ˜¯è¯´æŸä¸ªé˜Ÿåˆ—çš„èµ„æºä½äºfairSharePreemptionThresholdé˜ˆå€¼çš„æ—¶é—´è¶…è¿‡FairSharePreemptionTimeoutæ—¶ï¼Œåˆ™å‘ç”ŸæŠ¢å ã€‚</p><h2 id="æµ‹è¯•ä»£ç "><a href="#æµ‹è¯•ä»£ç " class="headerlink" title="æµ‹è¯•ä»£ç "></a>æµ‹è¯•ä»£ç </h2><p>å…ˆçœ‹ä»£ç å§ï¼Œä»£ç æœ‰ç‚¹é•¿ï¼ŒæŒ‰ç…§ç¨‹åºæµç¨‹ä¸€ä¸ªæ–¹æ³•ä¸€ä¸ªæ–¹æ³•è§£æå§ï¼Œæœ€åå†æŠŠæ•´ä¸ªä»£ç è´´ä¸Šå¤‡ç”¨ã€‚</p><p>yarnåœ¨å¯åŠ¨æ—¶éœ€è¦åŠ è½½é…ç½®æ–‡ä»¶ï¼Œä¹Ÿå°±æ˜¯configurationï¼Œé‚£ä¹ˆæˆ‘ä»¬çš„ç¬¬ä¸€æ­¥ä¹Ÿå°±æ˜¯åˆå§‹åŒ–å‘fair Schedulerå‘ç”ŸæŠ¢å çš„ç¯å¢ƒã€‚ç›¸å…³çš„ç¯å¢ƒé…ç½®æ˜¯åœ¨<code>createConfiguration</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Configuration <span class="title">createConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Configuration conf = <span class="keyword">super</span>.createConfiguration();</span><br><span class="line">  conf.setClass(YarnConfiguration.RM_SCHEDULER, FairScheduler.class,</span><br><span class="line">      ResourceScheduler.class);</span><br><span class="line">  <span class="comment">// å¼€å¯æŠ¢å å¼€å…³  yarn.scheduler.fair.preemption</span></span><br><span class="line">  conf.setBoolean(FairSchedulerConfiguration.PREEMPTION, <span class="keyword">true</span>);</span><br><span class="line">  <span class="comment">// fairé…ç½®æ‰€åœ¨è·¯å¾„</span></span><br><span class="line">  conf.set(FairSchedulerConfiguration.ALLOCATION_FILE, ALLOC_FILE);</span><br><span class="line">  <span class="keyword">return</span> conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fairè°ƒåº¦ä¸­é»˜è®¤æŠ¢å åŠŸèƒ½æ˜¯å…³é—­çš„ï¼Œè¦æƒ³è®©fairè°ƒåº¦ä½¿ç”¨æŠ¢å åŠŸèƒ½éœ€è¦æ›´æ”¹é…ç½®<code>yarn.scheduler.fair.preemption</code>ï¼Œé™¤æ­¤ä¹‹å¤–è¿˜æœ‰ä¸€ä¸ªå‚æ•°æ¥æ§åˆ¶<code>yarn.scheduler.fair.preemption.cluster-utilization-threshold</code>ï¼Œ<em>è¯¥å‚æ•°æ§åˆ¶ç€é›†ç¾¤çš„èµ„æºä½¿ç”¨ç‡è¾¾åˆ°å¤šå°‘ä¹‹åå¯ä»¥å‘ç”ŸæŠ¢å è¡Œä¸º</em>ã€‚è¯¥å‚æ•°åœ¨<code>createConfiguration</code>ä¸­æ²¡æœ‰è®¾ç½®ï¼Œè€Œæ˜¯åœ¨éšåçš„<code>startResourceManager</code>æ–¹æ³•ä¸­è®¾ç½®çš„ã€‚ä¸‹é¢å°±æ¥çœ‹ä¸‹<code>startResourceManager</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startResourceManager</span><span class="params">(<span class="keyword">float</span> utilizationThreshold)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// yarn.scheduler.fair.preemption.cluster-utilization-threshold</span></span><br><span class="line">  <span class="comment">// è®¾ç½®é›†ç¾¤èµ„æºå‘ç”ŸæŠ¢å çš„é˜ˆå€¼</span></span><br><span class="line">  conf.setFloat(FairSchedulerConfiguration.PREEMPTION_THRESHOLD,</span><br><span class="line">      utilizationThreshold);</span><br><span class="line">  <span class="comment">// è™šæ‹ŸRMï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æµ‹è¯•</span></span><br><span class="line">  resourceManager = <span class="keyword">new</span> MockRM(conf);</span><br><span class="line">  resourceManager.start();</span><br><span class="line"></span><br><span class="line">  scheduler = (FairScheduler)resourceManager.getResourceScheduler();</span><br><span class="line"></span><br><span class="line">  scheduler.setClock(clock);</span><br><span class="line">  scheduler.updateInterval = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>startResourceManagerä¼ è¿›å»ä¸ªå‚æ•°ï¼Œè¯¥å‚æ•°èµ‹å€¼ç»™<code>yarn.scheduler.fair.preemption.cluster-utilization-threshold</code>ç”¨æ¥æ§åˆ¶é›†ç¾¤å‘ç”ŸæŠ¢å çš„æ—¶æœºã€‚</p><p>fairè°ƒåº¦åˆ™éœ€è¦å¯åŠ¨ä¸€ä¸ªRMç”¨æ¥è¿›è¡Œèµ„æºç®¡ç†ï¼Œè¿™é‡Œnewä¸€ä¸ª<code>MockRM</code>ï¼ŒMockRMæ˜¯ä¸€ä¸ªè™šæ‹Ÿçš„RMï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æµ‹è¯•ï¼ŒHadoopä¸­æœ‰å¾ˆå¤šç±»ä¼¼çš„ç±»ï¼Œæå¤§çš„æ–¹ä¾¿äº†ä»£ç çš„æµ‹è¯•ã€‚</p><p>å¯åŠ¨RMä¹‹åå°±æ˜¯æƒ³RMæ³¨å†ŒNMï¼Œå³ä¸ºé›†ç¾¤æ·»åŠ èµ„æºï¼Œç„¶åappç”³è¯·èµ„æºï¼Œè¯·çœ‹ä»£ç <code>registerNodeAndSubmitApp</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> ApplicationAttemptId <span class="title">registerNodeAndSubmitApp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> memory, <span class="keyword">int</span> vcores, <span class="keyword">int</span> appContainers, <span class="keyword">int</span> appMemory)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// newå‡ºä¸€ä¸ªåä¸ºnode1çš„nmï¼Œèµ„æºä¸ºmemory vcores</span></span><br><span class="line">  RMNode node1 = MockNodes.newNodeInfo(</span><br><span class="line">      <span class="number">1</span>, Resources.createResource(memory, vcores), <span class="number">1</span>, <span class="string">&quot;node1&quot;</span>);</span><br><span class="line">  NodeAddedSchedulerEvent nodeEvent1 = <span class="keyword">new</span> NodeAddedSchedulerEvent(node1);</span><br><span class="line">  scheduler.handle(nodeEvent1);</span><br><span class="line">  System.out.println(<span class="string">&quot;resources in the cluster : &quot;</span> + scheduler.rootMetrics.getAvailableMB());</span><br><span class="line">  <span class="comment">// æäº¤ä¸€ä¸ªappï¼Œæ‰€éœ€èµ„æºä¸º appContainers * appMemory</span></span><br><span class="line">  ApplicationAttemptId app1 = createSchedulingRequest(appMemory, <span class="string">&quot;queueA&quot;</span>, <span class="string">&quot;user1&quot;</span>, appContainers);</span><br><span class="line">  scheduler.update();</span><br><span class="line">  <span class="comment">// Sufficient node check-ins to fully schedule containers</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; appContainers; i++) &#123;</span><br><span class="line">    NodeUpdateSchedulerEvent nodeUpdate1 = <span class="keyword">new</span> NodeUpdateSchedulerEvent(node1);</span><br><span class="line">    scheduler.handle(nodeUpdate1);</span><br><span class="line">  &#125;</span><br><span class="line">  FSLeafQueue queue = scheduler.getQueueManager().getLeafQueue(</span><br><span class="line">          <span class="string">&quot;queueA&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="comment">// æ‰“å°queueAé˜Ÿåˆ—ç›¸å…³çš„å‚æ•°ï¼Œè®¡ç®—æ–¹å¼å¯ä»¥å‚è€ƒä¸Šä¸€ç¯‡blog</span></span><br><span class="line">  System.out.println( <span class="string">&quot;queueA : &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">          <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">          <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">          <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">          <span class="string">&quot;, running : &quot;</span> + queue.getResourceUsage() +</span><br><span class="line">          <span class="string">&quot;, preempt : &quot;</span> + queue.preemptContainer());</span><br><span class="line">  System.out.println(<span class="string">&quot;rest resources of cluster : &quot;</span> +</span><br><span class="line">          (memory - appContainers * appMemory) + <span class="string">&quot; , &quot;</span> +</span><br><span class="line">      scheduler.rootMetrics.getAvailableMB());</span><br><span class="line">  <span class="keyword">return</span> app1;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹ä¸»ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPreemptionWithFreeResources</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> FileWriter(ALLOC_FILE));</span><br><span class="line">  <span class="comment">// å°†fair-scheduler.xmlé…ç½®å†™å…¥æ–‡ä»¶</span></span><br><span class="line">  out.println(<span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;allocations&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;queue name=\&quot;default\&quot;&gt;&quot;</span>);</span><br><span class="line">  <span class="comment">// maxResources ä¸º0ï¼Œåˆ™defaultå¾—åˆ°fixedé˜Ÿåˆ—ï¼Œ</span></span><br><span class="line">  <span class="comment">// ä¸åˆ—å…¥è®¡ç®—SteadyFairShareå’ŒFairShareçš„é›†åˆä¸­</span></span><br><span class="line">  out.println(<span class="string">&quot;&lt;maxResources&gt;0mb,0vcores&lt;/maxResources&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;queue name=\&quot;queueA\&quot;&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;weight&gt;1&lt;/weight&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;minResources&gt;1024mb,0vcores&lt;/minResources&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;queue name=\&quot;queueB\&quot;&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;weight&gt;1&lt;/weight&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;minResources&gt;1024mb,0vcores&lt;/minResources&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;defaultMinSharePreemptionTimeout&gt;5&lt;/defaultMinSharePreemptionTimeout&gt;&quot;</span>);</span><br><span class="line">  <span class="comment">// if fairSharePreemptionTimeout and defaultFairSharePreemptionTimeout both exist,</span></span><br><span class="line">  <span class="comment">// we take the default one</span></span><br><span class="line">  out.println(<span class="string">&quot;&lt;fairSharePreemptionTimeout&gt;10&lt;/fairSharePreemptionTimeout&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;/allocations&gt;&quot;</span>);</span><br><span class="line">  out.close();</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å‚æ•°0fè¡¨ç¤ºé›†ç¾¤èµ„æºçš„ä½¿ç”¨é‡è¶…è¿‡æ­¤å€¼æ—¶å‘ç”ŸæŠ¢å </span></span><br><span class="line">  startResourceManager(<span class="number">0f</span>);</span><br><span class="line">  <span class="comment">// Create node with 4GB memory and 4 vcores</span></span><br><span class="line">  <span class="comment">// app1ç”³è¯·4ä¸ªcontainerï¼Œæ¯ä¸ªcontainerå 1024MBï¼Œåˆ™å æ»¡é›†ç¾¤èµ„æº</span></span><br><span class="line">  ApplicationAttemptId app1 = registerNodeAndSubmitApp(<span class="number">4</span> * <span class="number">1024</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// app2 æäº¤åˆ°queueBï¼ŒæŠ¢å å¼€å‘å·²æ‰“å¼€å¹¶ä¸”é›†ç¾¤èµ„æºå ç”¨æ¯”ä¾‹è¶…è¿‡0åˆ™å¯ä»¥å‘ç”ŸæŠ¢å </span></span><br><span class="line">  ApplicationAttemptId app2 = createSchedulingRequest(<span class="number">1024</span>, <span class="string">&quot;queueB&quot;</span>, <span class="string">&quot;user1&quot;</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">  scheduler.update();</span><br><span class="line">  <span class="comment">// åœé¡¿6ç§’ï¼Œä½¿å…¶è¶…è¿‡defaultMinSharePreemptionTimeoutï¼ŒqueueBæ²¡æœ‰æ»¡è¶³minShareåˆ™æŠ¢å </span></span><br><span class="line">  clock.tick(<span class="number">6</span>);</span><br><span class="line">  <span class="comment">// æŠ¢å å‰queueAçš„çŠ¶æ€</span></span><br><span class="line">  FSLeafQueue queue = scheduler.getQueueManager().getLeafQueue(</span><br><span class="line">          <span class="string">&quot;queueA&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">  System.out.println( <span class="string">&quot;queueA : &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">          <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">          <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">          <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">          <span class="string">&quot;, running : &quot;</span> + queue.getResourceUsage() +</span><br><span class="line">          <span class="string">&quot;, preempt : &quot;</span> + queue.preemptContainer());</span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦æŠ¢å </span></span><br><span class="line">  <span class="comment">// æ­¤æ¬¡åªæ˜¯å°†è¦æŠ¢å çš„containeræ”¾å…¥warnedContainers listä¸­</span></span><br><span class="line">  scheduler.preemptTasksIfNecessary();</span><br><span class="line">  <span class="comment">// æ‰“å°è¦æŠ¢å å¤šå°‘èµ„æº</span></span><br><span class="line">  System.out.println(<span class="string">&quot;preemptResources() should have been called &quot;</span> + <span class="number">1024</span> + <span class="string">&quot; , &quot;</span> +</span><br><span class="line">          scheduler.getSchedulerApp(app1).getPreemptionContainers().iterator().next().getContainer().getResource());</span><br><span class="line">  System.out.println(<span class="string">&quot;====================================================================&quot;</span>);</span><br><span class="line">  <span class="comment">// åœé¡¿è¶…è¿‡15sï¼Œå°†containeræ€æ‰ï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">  clock.tick(<span class="number">18</span>);</span><br><span class="line">  <span class="comment">// å°†containeræ€æ‰ï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">  scheduler.preemptTasksIfNecessary();</span><br><span class="line">  System.out.println(<span class="string">&quot;preemptResources() should have been called &quot;</span> + <span class="number">1024</span> + <span class="string">&quot; , &quot;</span> +</span><br><span class="line">          scheduler.getSchedulerApp(app1).getPreemptionContainers());</span><br><span class="line">  System.out.println( <span class="string">&quot;queueA : &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">          <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">          <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">          <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">          <span class="string">&quot;, running : &quot;</span> + queue.getResourceUsage() +</span><br><span class="line">          <span class="string">&quot;, preempt : &quot;</span> + queue.preemptContainer());</span><br><span class="line"></span><br><span class="line">  resourceManager.stop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªæµ‹è¯•æŠ¢å çš„æµç¨‹å°±ç»“æŸäº†ã€‚å¤§è‡´æ€è·¯æ˜¯ï¼Œ<em>startResourceManageræ—¶è®¾ç½®é›†ç¾¤å¯ä»¥å‘ç”ŸæŠ¢å çš„æ—¶æœº(ä¾‹å­è®¾ç½®çš„é˜ˆå€¼æ˜¯0)ï¼Œç„¶åå‘é›†ç¾¤æ³¨å†Œäº†ä¸€ä¸ª4gçš„node1ï¼Œåˆæƒ³é›†ç¾¤queueAæäº¤äº†app1(4ä¸ªcontainerï¼Œä¸€ä¸ªcontainerå 1024MB)ï¼Œapp1å æ»¡æ•´ä¸ªé›†ç¾¤èµ„æºï¼Œæ­¤æ—¶app2(1ä¸ªcontainerï¼Œ1024MB)æäº¤ç»™queueBï¼Œæ¨¡æ‹Ÿç­‰å¾…6s(defaultMinSharePreemptionTimeoutæ˜¯5sï¼ŒqueueBæ­¤æ—¶ä¸æ»¡è¶³minShareï¼Œéœ€è¦æŠ¢å )ï¼Œè°ƒç”¨preemptTasksIfNecessaryæŸ¥çœ‹æ˜¯å¦è¦æŠ¢å (æŸ¥çœ‹æ˜¯å¦è¦æŠ¢å åœ¨çœŸå®ç¯å¢ƒä¸­å…¶å®æ˜¯ä¸€ä¸ªçº¿ç¨‹ä¸æ–­çš„åœ¨check)ï¼Œæœ€åå†ç­‰å¾…18s(yarn.scheduler.fair.waitTimeBeforeKillè®¾ç½®çš„æ˜¯15sï¼Œè¶…è¿‡æ­¤å€¼æ‰ä¼šå°†containerkillæ‰é‡Šæ”¾èµ„æº)ï¼Œç„¶åæŸ¥çœ‹queueAé˜Ÿåˆ—è¢«æŠ¢å å‰åçŠ¶æ€çš„å˜åŒ–ã€‚</em></p><p>ä¸Šé¢ä»£ç è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">resources <span class="keyword">in</span> the cluster : 4096</span><br><span class="line">queueA : 4096, weight : 1.0, steadyShare : &lt;memory:2048, vCores:0&gt;, demand : &lt;memory:4096, vCores:4&gt;, running : &lt;memory:4096, vCores:4&gt;, preempt : null</span><br><span class="line">rest resources of cluster : 0</span><br><span class="line">queueA : 2048, weight : 1.0, steadyShare : &lt;memory:2048, vCores:0&gt;, demand : &lt;memory:4096, vCores:4&gt;, running : &lt;memory:4096, vCores:4&gt;, preempt : container_0_0001_01_000004</span><br><span class="line">preemptResources() should have been called 1024 , &lt;memory:1024, vCores:1&gt;</span><br><span class="line">====================================================================</span><br><span class="line">preemptResources() should have been called 1024 , []</span><br><span class="line">queueA : 2048, weight : 1.0, steadyShare : &lt;memory:2048, vCores:0&gt;, demand : &lt;memory:4096, vCores:4&gt;, running : &lt;memory:3072, vCores:3&gt;, preempt : container_0_0001_01_000003</span><br></pre></td></tr></table></figure><p>ä»è¿è¡Œç»“æœä¸­å¯ä»¥çœ‹å‡ºåˆæœŸé›†ç¾¤è¢«queueAä¸­çš„app1å…¨å ï¼Œç„¶åqueueBä¸­çš„app2æäº¤ï¼Œè€ŒqueueBçš„èµ„æºåœ¨5sä¹‹åä»ç„¶ä½äºminShare(1024)ï¼Œåˆ™å‘ç”ŸæŠ¢å ï¼Œä»queueAä¸­æŠ¢å 1024æ»¡è¶³minShareï¼Œç­‰å¾…æ—¶é—´è¶…è¿‡15sä¹‹åï¼Œä¾ç„¶æ²¡æœ‰èµ„æºè¢«é‡Šæ”¾åˆ™killæ‰container_0_0001_01_000004ï¼ŒqueueAä¸­runningçš„èµ„æºå˜ä¸º3072ï¼Œè¯´æ˜æŠ¢å æˆåŠŸã€‚</p><h2 id="æŠ¢å è¿›é˜¶"><a href="#æŠ¢å è¿›é˜¶" class="headerlink" title="æŠ¢å è¿›é˜¶"></a>æŠ¢å è¿›é˜¶</h2><p>ä¸Šä¸€èŠ‚è¯´åˆ°äº†queueBä»queueAæŠ¢å 1024MBï¼Œé‚£ä¹ˆå‡å¦‚é›†ç¾¤ä¸­æœ‰å¤šä¸ªé˜Ÿåˆ—ï¼Œé‚£ä¹ˆåº”è¯¥æ€æ ·é€‰æ‹©ä»å“ªä¸ªé˜Ÿåˆ—æŠ¢å ï¼Œåˆåº”è¯¥æŠ¢å å¤šå°‘å‘¢ï¼Ÿå¸¦ç€è¿™ä¸ªé—®é¢˜å†å»çœ‹ä¸‹ä»£ç ã€‚</p><p>ä¸æŠ¢å ç›¸å…³çš„ä»£ç æ˜¯<code>scheduler.preemptTasksIfNecessary()</code>ï¼Œé‚£ä¹ˆå°±å…ˆçœ‹ä¸‹è¿™ä¸ªæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">preemptTasksIfNecessary</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ ¡éªŒå½“å‰é›†ç¾¤æ˜¯å¦èƒ½å‘ç”ŸæŠ¢å </span></span><br><span class="line">  <span class="keyword">if</span> (!shouldAttemptPreemption()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> curTime = getClock().getTime();</span><br><span class="line">  <span class="comment">// æ—¶é—´é—´éš”æ˜¯å¦è¶…è¿‡ yarn.scheduler.fair.preemptionInterval</span></span><br><span class="line">  <span class="keyword">if</span> (curTime - lastPreemptCheckTime &lt; preemptionInterval) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  lastPreemptCheckTime = curTime;</span><br><span class="line"></span><br><span class="line">  Resource resToPreempt = Resources.clone(Resources.none());</span><br><span class="line">  <span class="keyword">for</span> (FSLeafQueue sched : queueMgr.getLeafQueues()) &#123;</span><br><span class="line">  <span class="comment">// éå†æ‰€æœ‰é˜Ÿåˆ—ï¼Œè®¡ç®—å“ªäº›é˜Ÿåˆ—éœ€è¦æŠ¢å èµ„æºï¼ŒæŠ¢å å¤šå°‘</span></span><br><span class="line">    Resources.addTo(resToPreempt, resToPreempt(sched, curTime));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (Resources.greaterThan(RESOURCE_CALCULATOR, clusterResource, resToPreempt,</span><br><span class="line">      Resources.none())) &#123;</span><br><span class="line">    <span class="comment">// é€‰æ‹©ä»å“ªä¸ªé˜Ÿåˆ—ä¸­æŠ¢</span></span><br><span class="line">    preemptResources(resToPreempt);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>preemptTasksIfNecessaryç”¨æ¥æ£€æŸ¥å“ªäº›é˜Ÿåˆ—éœ€è¦è¿›è¡Œtasksçš„æŠ¢å ï¼Œè®¡ç®—å…±æœ‰å¤šå°‘ä¸ªtaskéœ€è¦è¢«æŠ¢å ï¼Œå¹¶ä»ä¸­é€‰æ‹©ã€‚</p><p>åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦è¦è¿›è¡ŒæŠ¢å çš„æ¡ä»¶æ˜¯<em>å½“é˜Ÿåˆ—çš„èµ„æºä½äºminShareçš„æ—¶é—´è¶…è¿‡minSharePreemptionTimeoutæˆ–è€…ä½äºfairShareçš„æ—¶é—´è¶…è¿‡fairSharePreemptionTimeoutæ—¶å°±è®¤ä¸ºè¯¥é˜Ÿåˆ—éœ€è¦å»æŠ¢å åˆ«çš„é˜Ÿåˆ—çš„èµ„æº</em>ã€‚</p><p>åœ¨æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦éœ€è¦æŠ¢å æ—¶ï¼Œå¾—å…ˆæ ¡éªŒä¸‹å¤§ç¯å¢ƒæ˜¯å¦å…è®¸æŠ¢å å‘ç”Ÿï¼Œè¿™ä¸ªæ˜¯åœ¨<code>shouldAttemptPreemption</code>ä¸­æ ¡éªŒçš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">shouldAttemptPreemption</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// yarn.scheduler.fair.preemption ä¸ºtrueæ—¶ï¼Œ</span></span><br><span class="line">  <span class="comment">// å†åˆ¤æ–­æ˜¯å¦è¶…è¿‡ yarn.scheduler.fair.preemption.cluster-utilization-threshold</span></span><br><span class="line">  <span class="comment">// è¶…è¿‡æ‰å¯ä»¥å‘ç”ŸæŠ¢å </span></span><br><span class="line">  <span class="keyword">if</span> (preemptionEnabled) &#123;</span><br><span class="line">    <span class="keyword">return</span> (preemptionUtilizationThreshold &lt; Math.max(</span><br><span class="line">        (<span class="keyword">float</span>) rootMetrics.getAllocatedMB() / clusterResource.getMemory(),</span><br><span class="line">        (<span class="keyword">float</span>) rootMetrics.getAllocatedVirtualCores() /</span><br><span class="line">            clusterResource.getVirtualCores()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åªæœ‰åœ¨é›†ç¾¤å…è®¸å‘ç”ŸæŠ¢å çš„å‰æä¸‹æ‰æœ‰å¯èƒ½å‘ç”ŸæŠ¢å ï¼Œè€Œåˆ¤æ–­<em>é›†ç¾¤æ˜¯å¦å…è®¸å‘ç”ŸæŠ¢å çš„æ¡ä»¶æ˜¯yarn.scheduler.fair.preemptionä¸ºtrueï¼Œå¹¶ä¸”é›†ç¾¤èµ„æºçš„ä½¿ç”¨ç‡è¶…è¿‡äº†yarn.scheduler.fair.preemption.cluster-utilization-threshold</em></p><p>å½“é›†ç¾¤å…è®¸å‘ç”ŸæŠ¢å æ—¶ï¼Œéå†æ‰€æœ‰çš„é˜Ÿåˆ—ï¼Œæ‰¾å‡ºéœ€è¦æŠ¢å çš„é˜Ÿåˆ—å¹¶è®¡ç®—å‡ºéœ€è¦æŠ¢å å¤šå°‘èµ„æºã€‚è¿™éƒ¨åˆ†ä»£ç é€»è¾‘åœ¨<code>resToPreempt</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Resource <span class="title">resToPreempt</span><span class="params">(FSLeafQueue sched, <span class="keyword">long</span> curTime)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> minShareTimeout = sched.getMinSharePreemptionTimeout();</span><br><span class="line">  <span class="keyword">long</span> fairShareTimeout = sched.getFairSharePreemptionTimeout();</span><br><span class="line">  Resource resDueToMinShare = Resources.none();</span><br><span class="line">  Resource resDueToFairShare = Resources.none();</span><br><span class="line">  <span class="comment">// æ˜¯å¦è¶…è¿‡äº†minSharePreemptionTimeout</span></span><br><span class="line">  <span class="keyword">if</span> (curTime - sched.getLastTimeAtMinShare() &gt; minShareTimeout) &#123;</span><br><span class="line">    Resource target = Resources.min(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">        sched.getMinShare(), sched.getDemand());</span><br><span class="line">    resDueToMinShare = Resources.max(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">        Resources.none(), Resources.subtract(target, sched.getResourceUsage()));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// æ˜¯å¦è¶…è¿‡äº†fairSharePreemptionTimeout</span></span><br><span class="line">  <span class="keyword">if</span> (curTime - sched.getLastTimeAtFairShareThreshold() &gt; fairShareTimeout) &#123;</span><br><span class="line">    Resource target = Resources.min(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">        sched.getFairShare(), sched.getDemand());</span><br><span class="line">    resDueToFairShare = Resources.max(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">        Resources.none(), Resources.subtract(target, sched.getResourceUsage()));</span><br><span class="line">  &#125;</span><br><span class="line">  Resource resToPreempt = Resources.max(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">      resDueToMinShare, resDueToFairShare);</span><br><span class="line">  <span class="keyword">if</span> (Resources.greaterThan(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">      resToPreempt, Resources.none())) &#123;</span><br><span class="line">    String message = <span class="string">&quot;Should preempt &quot;</span> + resToPreempt + <span class="string">&quot; res for queue &quot;</span></span><br><span class="line">        + sched.getName() + <span class="string">&quot;: resDueToMinShare = &quot;</span> + resDueToMinShare</span><br><span class="line">        + <span class="string">&quot;, resDueToFairShare = &quot;</span> + resDueToFairShare;</span><br><span class="line">    LOG.info(message);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> resToPreempt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>resToPreemptè®¡ç®—å½“å‰é˜Ÿåˆ—éœ€è¦æŠ¢å å¤šå°‘èµ„æºï¼Œè®¡ç®—è§„åˆ™ä¸ºï¼š<br>å‡è®¾é˜Ÿåˆ—æ‰€éœ€çš„èµ„æºå¤§äºminShareå’ŒfairShare</p><ul><li>å¦‚æœæ­¤é˜Ÿåˆ—çš„èµ„æºä½äºminShareçš„æ—¶é—´è¶…è¿‡minSharePreemptionTimeoutï¼Œåˆ™åº”è¯¥æŠ¢å minShareå’Œæ­£åœ¨ä½¿ç”¨èµ„æºçš„å·®å€¼ã€‚</li><li>å¦‚æœæ­¤é˜Ÿåˆ—çš„èµ„æºä½äºfairShareçš„æ—¶é—´è¶…è¿‡fairSharePreemptionTimeoutï¼Œåˆ™åº”è¯¥æŠ¢å fairShareå’Œæ­£åœ¨ä½¿ç”¨èµ„æºçš„å·®å€¼ã€‚</li><li>å¦‚æœä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œåˆ™æŠ¢å ä¸¤è€…è¾ƒå¤§çš„æ•°ã€‚</li></ul><p>resToPreemptå†³å®šäº†è¯¥é˜Ÿåˆ—æ˜¯å¦åº”è¯¥å»æŠ¢å ï¼Œåº”è¯¥æŠ¢å¤šå°‘ï¼Œé‚£ä¹ˆä»å“ªæŠ¢å æ˜¯åœ¨å“ªå†³å®šçš„ï¼Ÿç­”æ¡ˆæ˜¯<code>preemptResources</code>ï¼Œçœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">preemptResources</span><span class="params">(Resource toPreempt)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> start = getClock().getTime();</span><br><span class="line">  <span class="keyword">if</span> (Resources.equals(toPreempt, Resources.none())) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Scan down the list of containers we&#x27;ve already warned and kill them</span></span><br><span class="line">  <span class="comment">// if we need to.  Remove any containers from the list that we don&#x27;t need</span></span><br><span class="line">  <span class="comment">// or that are no longer running.</span></span><br><span class="line">  Iterator&lt;RMContainer&gt; warnedIter = warnedContainers.iterator();</span><br><span class="line">  <span class="keyword">while</span> (warnedIter.hasNext()) &#123;</span><br><span class="line">    RMContainer container = warnedIter.next();</span><br><span class="line">    <span class="keyword">if</span> ((container.getState() == RMContainerState.RUNNING ||</span><br><span class="line">            container.getState() == RMContainerState.ALLOCATED) &amp;&amp;</span><br><span class="line">        Resources.greaterThan(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">            toPreempt, Resources.none())) &#123;</span><br><span class="line">      warnOrKillContainer(container);</span><br><span class="line">      Resources.subtractFrom(toPreempt, container.getContainer().getResource());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      warnedIter.remove();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Reset preemptedResource for each app</span></span><br><span class="line">    <span class="keyword">for</span> (FSLeafQueue queue : getQueueManager().getLeafQueues()) &#123;</span><br><span class="line">      <span class="keyword">for</span> (FSAppAttempt app : queue.getRunnableAppSchedulables()) &#123;</span><br><span class="line">        app.resetPreemptedResources();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span> (Resources.greaterThan(RESOURCE_CALCULATOR, clusterResource,</span><br><span class="line">        toPreempt, Resources.none())) &#123;</span><br><span class="line">      <span class="comment">// preemptContainer å†³å®šä»å“ªä¸ªé˜Ÿåˆ—ä¸­æŠ¢èµ„æº</span></span><br><span class="line">      RMContainer container =</span><br><span class="line">          getQueueManager().getRootQueue().preemptContainer();</span><br><span class="line">      <span class="keyword">if</span> (container == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        warnOrKillContainer(container);</span><br><span class="line">        warnedContainers.add(container);</span><br><span class="line">        Resources.subtractFrom(</span><br><span class="line">            toPreempt, container.getContainer().getResource());</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="comment">// Clear preemptedResources for each app</span></span><br><span class="line">    <span class="keyword">for</span> (FSLeafQueue queue : getQueueManager().getLeafQueues()) &#123;</span><br><span class="line">      <span class="keyword">for</span> (FSAppAttempt app : queue.getRunnableAppSchedulables()) &#123;</span><br><span class="line">        app.clearPreemptedResources();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">long</span> duration = getClock().getTime() - start;</span><br><span class="line">  fsOpDurations.addPreemptCallDuration(duration);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>èµ„æºçš„æŠ¢å æ˜¯é€šè¿‡æŒ‘é€‰é˜Ÿåˆ—ï¼Œç„¶ååœ¨é˜Ÿåˆ—ä¸­é€‰appï¼Œæœ€ååœ¨æ­¤appä¸Šé€‰ä¸€ä¸ªcontainerä¸Šï¼Œé˜Ÿåˆ—çš„é€‰å–æ˜¯ä»rooté˜Ÿåˆ—å¼€å§‹ï¼Œç„¶åä¸€å±‚ä¸€å±‚çš„é€‰å–ï¼Œç›´åˆ°ä¸€ä¸ªå€™é€‰Applicationã€‚</p><p>æŠ¢å ç­–ç•¥æ ¹æ®ä¸åŒçš„è°ƒåº¦ç­–ç•¥è€Œä¸åŒï¼š<br>(1) fair/drf  é€‰æ‹©è¶…è¿‡fairShareæœ€å¤šçš„é˜Ÿåˆ—<br>(2) fifo é€‰æ‹©æœ€è¿‘æäº¤çš„appçš„é˜Ÿåˆ—<br>åœ¨appä¸­é€‰æ‹©containeræ˜¯æ ¹æ®containerçš„ä¼˜å…ˆçº§ï¼ŒæŠ¢å ä¼˜å…ˆçº§æœ€ä½çš„containerï¼Œcontainerçš„ä¼˜å…ˆçº§æ˜¯ç”±æ•°å­—æ ‡è¯†çš„ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šä½ã€‚</p><p>è¿™ä¸ªæŒ‘é€‰æµç¨‹çš„å…¥å£å‡½æ•°æ˜¯<code>getQueueManager().getRootQueue().preemptContainer()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FSParentQueue.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RMContainer <span class="title">preemptContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  RMContainer toBePreempted = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Find the childQueue which is most over fair share</span></span><br><span class="line">  FSQueue candidateQueue = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// æ ¹æ®è°ƒåº¦ç­–ç•¥é€‰æ‹©æ¯”è¾ƒå™¨</span></span><br><span class="line">  Comparator&lt;Schedulable&gt; comparator = policy.getComparator();</span><br><span class="line">  <span class="comment">// æ‰¾åˆ°è¶…è¿‡fairShaeræœ€å¤šçš„é˜Ÿåˆ—</span></span><br><span class="line">  <span class="keyword">for</span> (FSQueue queue : childQueues) &#123;</span><br><span class="line">    <span class="keyword">if</span> (candidateQueue == <span class="keyword">null</span> ||</span><br><span class="line">        comparator.compare(queue, candidateQueue) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      candidateQueue = queue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Let the selected queue choose which of its container to preempt</span></span><br><span class="line">  <span class="keyword">if</span> (candidateQueue != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// å¦‚æœå€™é€‰é˜Ÿåˆ—ä¾ç„¶æ˜¯çˆ¶é˜Ÿåˆ—ï¼Œåˆ™ç»§ç»­è°ƒç”¨FSParentQueue.preemptContainerï¼Œå½¢æˆé€’å½’</span></span><br><span class="line">  <span class="comment">// å¦‚æœå€™é€‰é˜Ÿåˆ—æ˜¯å¶å­é˜Ÿåˆ—ï¼Œåˆ™ä»é˜Ÿåˆ—ä¸­æ‰¾åˆ°åˆé€‚çš„appè¿›è¡ŒæŠ¢å </span></span><br><span class="line">    toBePreempted = candidateQueue.preemptContainer();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> toBePreempted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>FSParentQueue.preemptContainerä»rooté˜Ÿåˆ—é€‰æ‹©è¶…è¿‡fairShareæœ€å¤šçš„ä¸€ä¸ªé˜Ÿåˆ—ä½œä¸ºå€™é€‰é˜Ÿåˆ—ï¼Œå¦‚æœæ­¤å€™é€‰é˜Ÿåˆ—ä¾ç„¶æ˜¯çˆ¶é˜Ÿåˆ—åˆ™ç»§ç»­è°ƒç”¨FSParentQueue.preemptContainerå½¢æˆé€’å½’ï¼Œå¦‚æœæ˜¯å¶å­é˜Ÿåˆ—åˆ™è°ƒç”¨FSLeafQueue.preemptContainerï¼Œä»é˜Ÿåˆ—ä¸­é€‰æ‹©ä¸€ä¸ªappã€‚</strong></p><p>é€‰æ‹©é˜Ÿåˆ—å’Œappæ—¶æ¶‰åŠåˆ°ä¸€ä¸ªæ¯”è¾ƒå™¨ï¼Œè¿™ä¸ªæ¯”è¾ƒå™¨æ ¹æ®ä¸åŒçš„ç­–ç•¥å®ç°ä¸ä¸€æ ·ï¼Œè¿™é‡Œä¸»è¦ä»‹ç»ä¸‹<code>FairShareComparator</code>ï¼ŒFairShareComparatoræ˜¯FairSharePolicy.javaçš„å†…éƒ¨ç±»ï¼Œå®ç°äº†Comparatoræ¥å£ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">FairShareComparator</span> <span class="keyword">implements</span> <span class="title">Comparator</span>&lt;<span class="title">Schedulable</span>&gt;,</span></span><br><span class="line"><span class="class">    <span class="title">Serializable</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> serialVersionUID = <span class="number">5564969375856699313L</span>;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> Resource ONE = Resources.createResource(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">compare</span><span class="params">(Schedulable s1, Schedulable s2)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">double</span> minShareRatio1, minShareRatio2;</span><br><span class="line">    <span class="keyword">double</span> useToWeightRatio1, useToWeightRatio2;</span><br><span class="line">    Resource minShare1 = Resources.min(RESOURCE_CALCULATOR, <span class="keyword">null</span>,</span><br><span class="line">        s1.getMinShare(), s1.getDemand());</span><br><span class="line">    Resource minShare2 = Resources.min(RESOURCE_CALCULATOR, <span class="keyword">null</span>,</span><br><span class="line">        s2.getMinShare(), s2.getDemand());</span><br><span class="line">    <span class="keyword">boolean</span> s1Needy = Resources.lessThan(RESOURCE_CALCULATOR, <span class="keyword">null</span>,</span><br><span class="line">        s1.getResourceUsage(), minShare1);</span><br><span class="line">    <span class="keyword">boolean</span> s2Needy = Resources.lessThan(RESOURCE_CALCULATOR, <span class="keyword">null</span>,</span><br><span class="line">        s2.getResourceUsage(), minShare2);</span><br><span class="line">    minShareRatio1 = (<span class="keyword">double</span>) s1.getResourceUsage().getMemory()</span><br><span class="line">        / Resources.max(RESOURCE_CALCULATOR, <span class="keyword">null</span>, minShare1, ONE).getMemory();</span><br><span class="line">    minShareRatio2 = (<span class="keyword">double</span>) s2.getResourceUsage().getMemory()</span><br><span class="line">        / Resources.max(RESOURCE_CALCULATOR, <span class="keyword">null</span>, minShare2, ONE).getMemory();</span><br><span class="line">    useToWeightRatio1 = s1.getResourceUsage().getMemory() /</span><br><span class="line">        s1.getWeights().getWeight(ResourceType.MEMORY);</span><br><span class="line">    useToWeightRatio2 = s2.getResourceUsage().getMemory() /</span><br><span class="line">        s2.getWeights().getWeight(ResourceType.MEMORY);</span><br><span class="line">    <span class="keyword">int</span> res = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (s1Needy &amp;&amp; !s2Needy)</span><br><span class="line">      res = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s2Needy &amp;&amp; !s1Needy)</span><br><span class="line">      res = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (s1Needy &amp;&amp; s2Needy)</span><br><span class="line">      res = (<span class="keyword">int</span>) Math.signum(minShareRatio1 - minShareRatio2);</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">      <span class="comment">// Neither schedulable is needy</span></span><br><span class="line">      res = (<span class="keyword">int</span>) Math.signum(useToWeightRatio1 - useToWeightRatio2);</span><br><span class="line">    <span class="keyword">if</span> (res == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// Apps are tied in fairness ratio. Break the tie by submit time and job</span></span><br><span class="line">      <span class="comment">// name to get a deterministic ordering, which is useful for unit tests.</span></span><br><span class="line">      res = (<span class="keyword">int</span>) Math.signum(s1.getStartTime() - s2.getStartTime());</span><br><span class="line">      <span class="keyword">if</span> (res == <span class="number">0</span>)</span><br><span class="line">        res = s1.getName().compareTo(s2.getName());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> res;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥æ¯”è¾ƒå™¨ä¼ å…¥ä¸¤ä¸ªé˜Ÿåˆ—Aã€Bï¼Œå¦‚æœAå¤§äºBï¼Œåˆ™è¿”å›1ï¼Œå°äºè¿”å›-1ï¼Œç­‰äºåˆ™è¿”å›0ã€‚</p><p><strong>é˜Ÿåˆ—æ¯”è¾ƒæ—¶åˆ†ä¸¤ç§æƒ…å†µï¼Œ</strong>ä¸€ç§æ˜¯æ‰€ç”¨èµ„æºä½äºminShareï¼Œå¦ä¸€ç§æƒ…å†µæ˜¯é«˜äºminShareã€‚<br>(1) ä½äºminShareæ—¶ï¼Œ</p><ul><li>ä¸¤ä¸ªé˜Ÿåˆ—éƒ½ä½äºminShareæ—¶ï¼Œåˆ™æ¯”è¾ƒ_ä¸¤ä¸ªé˜Ÿåˆ—æŒ‚èµ·çš„ä»»åŠ¡æ•°ä¸æ€»ä»»åŠ¡æ•°çš„æ¯”ä¾‹_ï¼Œæ¯”ä¾‹å€¼è¶Šä½åˆ™è¶Šåº”è¯¥å…ˆå¾—åˆ°èµ„æºã€‚åˆ™æ¯”è¾ƒå™¨è®¤ä¸ºæ¯”ä¾‹å¤§çš„é˜Ÿåˆ—è¾ƒå¤§ã€‚</li><li>åªæœ‰ä¸€ä¸ªé˜Ÿåˆ—ä½äºminShareæ—¶ï¼Œåˆ™è¶…è¿‡minShareçš„é‚£ä¸ªé˜Ÿåˆ—è¾ƒå¤§ï¼Œå› ä¸ºä½äºminShareçš„é˜Ÿåˆ—å¾—åˆ°èµ„æºçš„ä¼˜å…ˆçº§é«˜äºå·²ç»è¶…è¿‡minShareé˜Ÿåˆ—çš„ä¼˜å…ˆçº§ã€‚</li></ul><p>(2) é«˜äºminShareæ—¶ï¼Œ</p><ul><li>é«˜äºminShareåˆ™è®¡ç®—é˜Ÿåˆ—æ‰€ä½¿ç”¨çš„èµ„æºä¸weightçš„æ¯”ä¾‹ï¼Œæ¯”ä¾‹å¤§çš„é˜Ÿåˆ—å¤§ã€‚</li></ul><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>FSLeafQueue.preemptContainer</code>ï¼Œçœ‹ä¸‹appæ˜¯æ€ä¹ˆä»é˜Ÿåˆ—ä¸­é€‰ä¸­çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// FSLeafQueue.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> RMContainer <span class="title">preemptContainer</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  RMContainer toBePreempted = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If this queue is not over its fair share, reject</span></span><br><span class="line">  <span class="keyword">if</span> (!preemptContainerPreCheck()) &#123;</span><br><span class="line">    <span class="keyword">return</span> toBePreempted;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">    LOG.debug(<span class="string">&quot;Queue &quot;</span> + getName() + <span class="string">&quot; is going to preempt a container &quot;</span> +</span><br><span class="line">        <span class="string">&quot;from its applications.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Choose the app that is most over fair share</span></span><br><span class="line">  <span class="comment">// æ­¤å¤„çš„æ¯”è¾ƒå™¨ä¾ç„¶æ˜¯ä¸Šé¢ä»‹ç»çš„æ¯”è¾ƒå™¨</span></span><br><span class="line">  Comparator&lt;Schedulable&gt; comparator = policy.getComparator();</span><br><span class="line">  FSAppAttempt candidateSched = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (FSAppAttempt sched : runnableApps) &#123;</span><br><span class="line">    <span class="keyword">if</span> (candidateSched == <span class="keyword">null</span> ||</span><br><span class="line">        comparator.compare(sched, candidateSched) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      candidateSched = sched;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Preempt from the selected app</span></span><br><span class="line">  <span class="keyword">if</span> (candidateSched != <span class="keyword">null</span>) &#123;</span><br><span class="line">  <span class="comment">// ä»appä¸­é€‰æ‹©ä¸€ä¸ªcontainerï¼Œcontainerçš„é€‰å–æ˜¯æŒ‰ç…§ä¼˜å…ˆçº§</span></span><br><span class="line">  <span class="comment">// ä¼˜å…ˆçº§ä¸€æ ·åˆ™æ¯”è¾ƒcontainerId</span></span><br><span class="line">    toBePreempted = candidateSched.preemptContainer();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> toBePreempted;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡ä¸Šé¢çš„æ­¥éª¤å°†containerä»appä¸­é€‰å‡ºä¹‹åï¼Œè°ƒç”¨<code>warnOrKillContainer</code>ï¼Œåˆ¤æ–­æ˜¯å°†containeræ”¾å…¥<code>preemptionMap</code>(è¿™é‡Œè®°å½•äº†å¯ä»¥è¢«æŠ¢å çš„containerå’Œæ”¾å…¥çš„æ—¶é—´)è¿˜æ˜¯ç›´æ¥killæ‰(å½“è¶…è¿‡yarn.scheduler.fair.waitTimeBeforeKillæ—¶ï¼Œåˆ™killæ‰containeré‡Šæ”¾èµ„æº)ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">warnOrKillContainer</span><span class="params">(RMContainer container)</span> </span>&#123;</span><br><span class="line">  ApplicationAttemptId appAttemptId = container.getApplicationAttemptId();</span><br><span class="line">  FSAppAttempt app = getSchedulerApp(appAttemptId);</span><br><span class="line">  FSLeafQueue queue = app.getQueue();</span><br><span class="line">  LOG.info(<span class="string">&quot;Preempting container (prio=&quot;</span> + container.getContainer().getPriority() +</span><br><span class="line">      <span class="string">&quot;res=&quot;</span> + container.getContainer().getResource() +</span><br><span class="line">      <span class="string">&quot;) from queue &quot;</span> + queue.getName());</span><br><span class="line">  </span><br><span class="line">  Long time = app.getContainerPreemptionTime(container);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (time != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// if we asked for preemption more than maxWaitTimeBeforeKill ms ago,</span></span><br><span class="line">    <span class="comment">// proceed with kill</span></span><br><span class="line">    <span class="keyword">if</span> (time + waitTimeBeforeKill &lt; getClock().getTime()) &#123;</span><br><span class="line">      ContainerStatus status =</span><br><span class="line">        SchedulerUtils.createPreemptedContainerStatus(</span><br><span class="line">          container.getContainerId(), SchedulerUtils.PREEMPTED_CONTAINER);</span><br><span class="line"></span><br><span class="line">      recoverResourceRequestForContainer(container);</span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> Not sure if this ever actually adds this to the list of cleanup</span></span><br><span class="line">      <span class="comment">// containers on the RMNode (see SchedulerNode.releaseContainer()).</span></span><br><span class="line">      completedContainer(container, status, RMContainerEventType.KILL);</span><br><span class="line">      LOG.info(<span class="string">&quot;Killing container&quot;</span> + container +</span><br><span class="line">          <span class="string">&quot; (after waiting for premption for &quot;</span> +</span><br><span class="line">          (getClock().getTime() - time) + <span class="string">&quot;ms)&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">// track the request in the FSAppAttempt itself</span></span><br><span class="line">    <span class="comment">// æ¯ä¸ªappéƒ½è®°å½•è‡ªå·±å¯ä»¥è¢«æŠ¢å çš„container</span></span><br><span class="line">    app.addPreemption(container, getClock().getTime());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“warnOrKillContainerå°†containeræ€æ‰ä¹‹åï¼Œé˜Ÿåˆ—å°±å¯ä»¥æŠ¢åˆ°èµ„æºäº†ï¼Œæ•´ä¸ªæŠ¢å è¿‡ç¨‹ä¹Ÿå°±ç»“æŸäº†ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>åœ¨fairç¯å¢ƒä¸‹æŠ¢å æ—¶ï¼Œå…ˆçœ‹å¤§ç¯å¢ƒæ˜¯å¦å¯ä»¥å‘ç”ŸæŠ¢å ï¼Œ</p><blockquote><p>åˆ¤æ–­æ˜¯å¦å‘ç”ŸæŠ¢å çš„æ¡ä»¶æ˜¯<br>yarn.scheduler.fair.preemptionä¸ºtrueï¼Œå¹¶ä¸”é›†ç¾¤èµ„æºçš„ä½¿ç”¨ç‡è¶…è¿‡äº†yarn.scheduler.fair.preemption.cluster-utilization-threshold</p></blockquote><blockquote><p>å¯ä»¥å‘ç”ŸæŠ¢å æ—¶ï¼Œåˆ™è¦åˆ¤æ–­éœ€è¦æŠ¢å å¤šå°‘èµ„æºã€‚æŠ¢å å¤šå°‘èµ„æºåˆ™æ˜¯å°†æ‰€æœ‰çš„é˜Ÿåˆ—éƒ½éå†ä¸€éï¼Œå¯¹æ¯ä¸ªé˜Ÿåˆ—éœ€è¦æŠ¢å çš„èµ„æºè¿›è¡Œæ±‡æ€»ã€‚åœ¨<em>FairScheduler.resToPreempt</em>æ–¹æ³•ä¸­ã€‚<br>æ¯ä¸ªé˜Ÿåˆ—è¦æŠ¢å å¤šå°‘èµ„æºçš„è®¡ç®—è§„åˆ™ä¸ºï¼š<br>å‡è®¾é˜Ÿåˆ—æ‰€éœ€çš„èµ„æºå¤§äºminShareå’ŒfairShare</p></blockquote><ul><li>å¦‚æœæ­¤é˜Ÿåˆ—çš„èµ„æºä½äºminShareçš„æ—¶é—´è¶…è¿‡minSharePreemptionTimeoutï¼Œåˆ™åº”è¯¥æŠ¢å minShareå’Œæ­£åœ¨ä½¿ç”¨èµ„æºçš„å·®å€¼ã€‚</li><li>å¦‚æœæ­¤é˜Ÿåˆ—çš„èµ„æºä½äºfairShareçš„æ—¶é—´è¶…è¿‡fairSharePreemptionTimeoutï¼Œåˆ™åº”è¯¥æŠ¢å fairShareå’Œæ­£åœ¨ä½¿ç”¨èµ„æºçš„å·®å€¼ã€‚</li><li>å¦‚æœä¸Šè¿°ä¸¤ä¸ªæ¡ä»¶éƒ½æ»¡è¶³ï¼Œåˆ™æŠ¢å ä¸¤è€…è¾ƒå¤§çš„æ•°ã€‚</li></ul><blockquote><p>è®¡ç®—å‡ºéœ€è¦æŠ¢å çš„èµ„æºæ€»æ•°ä¹‹åå°±æ˜¯æ‰¾å‡ºæŠ¢å“ªäº›containerã€‚æ‰¾å“ªäº›containerçš„æµç¨‹æ˜¯ä»rooté˜Ÿåˆ—ä¸€å±‚ä¸€å±‚çš„æŸ¥æ‰¾å¯ä»¥æŠ¢å çš„é˜Ÿåˆ—ï¼Œç„¶åä»é˜Ÿåˆ—ä¸­æ‰¾åˆ°Applicationï¼Œæœ€åæ‰¾åˆ°å¯ä»¥æŠ¢å çš„containerã€‚è¿™ä¸ªæµç¨‹çš„å…¥å£å‡½æ•°æ˜¯<code>FairScheduler.preemptResources</code>ã€‚<br>preemptResourceså…ˆéå†<em>warnedContainers</em>(æ˜¯ä¸ªlist)ä¸­çš„containerï¼Œå¦‚æœtoPreemptä¾ç„¶æœ‰å‰©ä½™ï¼Œåˆ™å¾ªç¯çš„ä»rooté˜Ÿåˆ—å‘ä¸‹ä¸€å±‚ä¸€å±‚çš„æŸ¥æ‰¾å¯ä»¥æŠ¢å çš„containerï¼Œå¹¶å°†æ­¤containeræ”¾å…¥list warnedContainersä¸­ã€‚<br>æŠ¢å ç­–ç•¥æ ¹æ®ä¸åŒçš„è°ƒåº¦ç­–ç•¥è€Œä¸åŒï¼š<br>(1) fair/drf  é€‰æ‹©è¶…è¿‡fairShareæœ€å¤šçš„é˜Ÿåˆ—<br>(2) fifo é€‰æ‹©æœ€è¿‘æäº¤çš„appçš„é˜Ÿåˆ—<br>åœ¨appä¸­é€‰æ‹©containeræ˜¯æ ¹æ®containerçš„ä¼˜å…ˆçº§ï¼ŒæŠ¢å ä¼˜å…ˆçº§æœ€ä½çš„containerï¼Œcontainerçš„ä¼˜å…ˆçº§æ˜¯ç”±æ•°å­—æ ‡è¯†çš„ï¼Œæ•°å­—è¶Šå¤§ä¼˜å…ˆçº§è¶Šä½ã€‚</p></blockquote><h2 id="Tips"><a href="#Tips" class="headerlink" title="Tips"></a>Tips</h2><ul><li>FairSharePreemptionTimeoutçš„å€¼åº”è¯¥å¤§äº0.0å°äº1.0ï¼Œå› ä¸ºè®¾ç½®ä¸º0.0åˆ™è¡¨ç¤ºå…³é—­äº†fairShareæŠ¢å åŠŸèƒ½ã€‚</li><li>æŠ¢å æ˜¯å°†queueAçš„containeræ€æ‰è¿›è¡Œé‡æ–°åˆ†é…ç»™queueXé˜Ÿåˆ—ï¼Œä¸èƒ½å°†queueAä¸­app1çš„containeræ€æ‰ç„¶åå†åˆ†é…ç»™queueAä¸­çš„app2</li><li>SchedulingPolicy<br>[ä¸Šç¯‡](<a href="http://bigdatadecode.top/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BFair">http://bigdatadecode.top/YARNæºç åˆ†æä¹‹Fair</a> Scheduler part1.html)ä¸­ä»‹ç»äº†SchedulingPolicyä¸­è®¡ç®—fairShareçš„é€»è¾‘ï¼Œæœ¬ç¯‡ä¸­ä»‹ç»äº†é˜Ÿåˆ—æ’åºæ¯”è¾ƒçš„é€»è¾‘ï¼Œè¿™ä¹Ÿå°±æŠŠSchedulingPolicyçš„åŠŸèƒ½ä»‹ç»å®Œäº†ã€‚<br>åŒ…æ‹¬ä¸¤ä¸ªåŠŸèƒ½ï¼š<br>(1)è®¡ç®—fairshareçš„é€»è¾‘<br>(2)é˜Ÿåˆ—æ’åºæ¯”è¾ƒçš„é€»è¾‘ï¼ˆåœ¨åˆ†é…èµ„æºï¼Œä»¥åŠåœ¨æŠ¢å èµ„æºæ—¶å€™ä¼šè¿›è¡Œæ’åºï¼‰ï¼Œåˆ†é…ç»™æœ€éœ€è¦èµ„æºçš„ï¼Œä»¥åŠæŠ¢å æ‰æœ€ä¸éœ€è¦èµ„æºçš„</li></ul><h2 id="é™„ä»¶-å®Œæ•´ä»£ç "><a href="#é™„ä»¶-å®Œæ•´ä»£ç " class="headerlink" title="é™„ä»¶-å®Œæ•´ä»£ç "></a>é™„ä»¶-å®Œæ•´ä»£ç </h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestFairSchedulerPreemptionSzw</span> <span class="keyword">extends</span> <span class="title">FairSchedulerTestBase</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String ALLOC_FILE = <span class="keyword">new</span> File(<span class="string">&quot;F:\\test-queues&quot;</span>).getAbsolutePath();</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> MockClock clock;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">protected</span> Configuration <span class="title">createConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Configuration conf = <span class="keyword">super</span>.createConfiguration();</span><br><span class="line">    conf.setClass(YarnConfiguration.RM_SCHEDULER, FairScheduler.class,</span><br><span class="line">        ResourceScheduler.class);</span><br><span class="line">    <span class="comment">// å¼€å¯æŠ¢å å¼€å…³  yarn.scheduler.fair.preemption</span></span><br><span class="line">    conf.setBoolean(FairSchedulerConfiguration.PREEMPTION, <span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// fairé…ç½®æ‰€åœ¨è·¯å¾„</span></span><br><span class="line">    conf.set(FairSchedulerConfiguration.ALLOCATION_FILE, ALLOC_FILE);</span><br><span class="line">    <span class="keyword">return</span> conf;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Before</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setup</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    conf = createConfiguration();</span><br><span class="line">    clock = <span class="keyword">new</span> MockClock();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@After</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">teardown</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (resourceManager != <span class="keyword">null</span>) &#123;</span><br><span class="line">      resourceManager.stop();</span><br><span class="line">      resourceManager = <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    conf = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">startResourceManager</span><span class="params">(<span class="keyword">float</span> utilizationThreshold)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// yarn.scheduler.fair.preemption.cluster-utilization-threshold</span></span><br><span class="line">    <span class="comment">// è®¾ç½®é›†ç¾¤èµ„æºå‘ç”ŸæŠ¢å çš„é˜ˆå€¼</span></span><br><span class="line">    conf.setFloat(FairSchedulerConfiguration.PREEMPTION_THRESHOLD,</span><br><span class="line">        utilizationThreshold);</span><br><span class="line">    <span class="comment">// è™šæ‹ŸRMï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿æµ‹è¯•</span></span><br><span class="line">    resourceManager = <span class="keyword">new</span> MockRM(conf);</span><br><span class="line">    resourceManager.start();</span><br><span class="line"></span><br><span class="line">    scheduler = (FairScheduler)resourceManager.getResourceScheduler();</span><br><span class="line"></span><br><span class="line">    scheduler.setClock(clock);</span><br><span class="line">    scheduler.updateInterval = <span class="number">60</span> * <span class="number">1000</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> ApplicationAttemptId <span class="title">registerNodeAndSubmitApp</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">int</span> memory, <span class="keyword">int</span> vcores, <span class="keyword">int</span> appContainers, <span class="keyword">int</span> appMemory)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// newå‡ºä¸€ä¸ªåä¸ºnode1çš„nmï¼Œèµ„æºä¸ºmemory vcores</span></span><br><span class="line">    RMNode node1 = MockNodes.newNodeInfo(</span><br><span class="line">        <span class="number">1</span>, Resources.createResource(memory, vcores), <span class="number">1</span>, <span class="string">&quot;node1&quot;</span>);</span><br><span class="line">    NodeAddedSchedulerEvent nodeEvent1 = <span class="keyword">new</span> NodeAddedSchedulerEvent(node1);</span><br><span class="line">    scheduler.handle(nodeEvent1);</span><br><span class="line"></span><br><span class="line">    System.out.println(<span class="string">&quot;resources in the cluster : &quot;</span> + scheduler.rootMetrics.getAvailableMB());</span><br><span class="line">    <span class="comment">// æäº¤ä¸€ä¸ªappï¼Œæ‰€éœ€èµ„æºä¸º appContainers * appMemory</span></span><br><span class="line">    ApplicationAttemptId app1 = createSchedulingRequest(appMemory, <span class="string">&quot;queueA&quot;</span>, <span class="string">&quot;user1&quot;</span>, appContainers);</span><br><span class="line">    scheduler.update();</span><br><span class="line">    <span class="comment">// Sufficient node check-ins to fully schedule containers</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; appContainers; i++) &#123;</span><br><span class="line">      NodeUpdateSchedulerEvent nodeUpdate1 = <span class="keyword">new</span> NodeUpdateSchedulerEvent(node1);</span><br><span class="line">      scheduler.handle(nodeUpdate1);</span><br><span class="line">    &#125;</span><br><span class="line">    FSLeafQueue queue = scheduler.getQueueManager().getLeafQueue(</span><br><span class="line">            <span class="string">&quot;queueA&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    System.out.println( <span class="string">&quot;queueA : &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">            <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">            <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">            <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">            <span class="string">&quot;, running : &quot;</span> + queue.getResourceUsage() +</span><br><span class="line">            <span class="string">&quot;, preempt : &quot;</span> + queue.preemptContainer());</span><br><span class="line">    System.out.println(<span class="string">&quot;rest resources of cluster : &quot;</span> +</span><br><span class="line">            (memory - appContainers * appMemory) + <span class="string">&quot; , &quot;</span> +</span><br><span class="line">        scheduler.rootMetrics.getAvailableMB());</span><br><span class="line">    <span class="keyword">return</span> app1;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPreemptionWithFreeResources</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">    PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> FileWriter(ALLOC_FILE));</span><br><span class="line">    out.println(<span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;allocations&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;queue name=\&quot;default\&quot;&gt;&quot;</span>);</span><br><span class="line">    <span class="comment">// maxResources ä¸º0ï¼Œåˆ™defaultå¾—åˆ°fixedé˜Ÿåˆ—ï¼Œ</span></span><br><span class="line">    <span class="comment">// ä¸åˆ—å…¥è®¡ç®—SteadyFairShareå’ŒFairShareçš„é›†åˆä¸­</span></span><br><span class="line">    out.println(<span class="string">&quot;&lt;maxResources&gt;0mb,0vcores&lt;/maxResources&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;queue name=\&quot;queueA\&quot;&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;weight&gt;1&lt;/weight&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;minResources&gt;1024mb,0vcores&lt;/minResources&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;queue name=\&quot;queueB\&quot;&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;weight&gt;1&lt;/weight&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;minResources&gt;1024mb,0vcores&lt;/minResources&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;defaultMinSharePreemptionTimeout&gt;5&lt;/defaultMinSharePreemptionTimeout&gt;&quot;</span>);</span><br><span class="line">    <span class="comment">// if fairSharePreemptionTimeout and defaultFairSharePreemptionTimeout both exist,</span></span><br><span class="line">    <span class="comment">// we take the default one</span></span><br><span class="line">    out.println(<span class="string">&quot;&lt;fairSharePreemptionTimeout&gt;10&lt;/fairSharePreemptionTimeout&gt;&quot;</span>);</span><br><span class="line">    out.println(<span class="string">&quot;&lt;/allocations&gt;&quot;</span>);</span><br><span class="line">    out.close();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// å‚æ•°0fè¡¨ç¤ºé›†ç¾¤èµ„æºçš„ä½¿ç”¨é‡è¶…è¿‡æ­¤å€¼æ—¶å‘ç”ŸæŠ¢å </span></span><br><span class="line">    startResourceManager(<span class="number">0f</span>);</span><br><span class="line">    <span class="comment">// Create node with 4GB memory and 4 vcores</span></span><br><span class="line">    <span class="comment">// 2 ä¸ªcontainer 1024mb</span></span><br><span class="line">    ApplicationAttemptId app1 = registerNodeAndSubmitApp(<span class="number">4</span> * <span class="number">1024</span>, <span class="number">4</span>, <span class="number">4</span>, <span class="number">1024</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Verify submitting another request triggers preemption</span></span><br><span class="line">    ApplicationAttemptId app2 = createSchedulingRequest(<span class="number">1024</span>, <span class="string">&quot;queueB&quot;</span>, <span class="string">&quot;user1&quot;</span>, <span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line">    scheduler.update();</span><br><span class="line">    <span class="comment">// åœé¡¿6ç§’ï¼Œä½¿å…¶è¶…è¿‡defaultMinSharePreemptionTimeoutï¼ŒqueueBæ²¡æœ‰æ»¡è¶³minShareåˆ™æŠ¢å </span></span><br><span class="line">    clock.tick(<span class="number">6</span>);</span><br><span class="line"></span><br><span class="line">    FSLeafQueue queue = scheduler.getQueueManager().getLeafQueue(</span><br><span class="line">            <span class="string">&quot;queueA&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">    System.out.println( <span class="string">&quot;queueA : &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">            <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">            <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">            <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">            <span class="string">&quot;, running : &quot;</span> + queue.getResourceUsage() +</span><br><span class="line">            <span class="string">&quot;, preempt : &quot;</span> + queue.preemptContainer());</span><br><span class="line">    <span class="comment">// æ£€æŸ¥æ˜¯å¦æŠ¢å </span></span><br><span class="line">    scheduler.preemptTasksIfNecessary();</span><br><span class="line">    System.out.println(<span class="string">&quot;preemptResources() should have been called &quot;</span> + <span class="number">1024</span> + <span class="string">&quot; , &quot;</span> +</span><br><span class="line">            scheduler.getSchedulerApp(app1).getPreemptionContainers().iterator().next().getContainer().getResource());</span><br><span class="line">    System.out.println(<span class="string">&quot;====================================================================&quot;</span>);</span><br><span class="line">    <span class="comment">// åœé¡¿è¶…è¿‡15sï¼Œå°†containeræ€æ‰ï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">    clock.tick(<span class="number">18</span>);</span><br><span class="line">    <span class="comment">// å°†containeræ€æ‰ï¼Œé‡Šæ”¾èµ„æº</span></span><br><span class="line">    scheduler.preemptTasksIfNecessary();</span><br><span class="line">    System.out.println(<span class="string">&quot;preemptResources() should have been called &quot;</span> + <span class="number">1024</span> + <span class="string">&quot; , &quot;</span> +</span><br><span class="line">            scheduler.getSchedulerApp(app1).getPreemptionContainers());</span><br><span class="line">    System.out.println( <span class="string">&quot;queueA : &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">            <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">            <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">            <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">            <span class="string">&quot;, running : &quot;</span> + queue.getResourceUsage() +</span><br><span class="line">            <span class="string">&quot;, preempt : &quot;</span> + queue.preemptContainer());</span><br><span class="line"></span><br><span class="line">    resourceManager.stop();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> container </tag>
            
            <tag> preempt </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹Fair Scheduler part1</title>
      <link href="/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BFair%20Scheduler%20part1.html"/>
      <url>/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BFair%20Scheduler%20part1.html</url>
      
        <content type="html"><![CDATA[<p>æƒ³çœ‹fair Schedulerçš„æºç å·²ç»å¾ˆä¹…äº†ï¼Œåªæ˜¯ä¸€ç›´æ²¡æœ‰åˆé€‚çš„æ—¶é—´ï¼Œæ›´æ²¡æœ‰æ‰¾åˆ°åˆé€‚çš„æ–¹æ³•å»è¯»srcï¼Œå¯¼è‡´æ¯æ¬¡è¯»ä¸€ç‚¹å°±ä¸æƒ³ç»§ç»­è¯»äº†ï¼Œæœ€è¿‘å®åœ¨æ˜¯å¤ªæ— èŠäº†ï¼Œä¹Ÿä¸çŸ¥é“è¯¥è¯»ç‚¹ä»€ä¹ˆï¼Œäºæ˜¯å°±åˆæƒ³èµ·äº†è¿™ä¸ªæç½®å¾ˆä¹…çš„ä»»åŠ¡ã€‚</p><p>è¿™æ¬¡è¯»ä»£ç æ—¶æˆ‘ç›´æ¥ä»fair Schedulerçš„testç±»ä¸­è¿›è¡Œè·Ÿè¯»ï¼Œè¿™æ ·æˆ‘æ„Ÿè§‰ä¼šæ¯”è¾ƒæ¸…æ™°ä¹Ÿå®¹æ˜“debugã€‚</p><span id="more"></span><h2 id="ç¯å¢ƒåˆå§‹åŒ–"><a href="#ç¯å¢ƒåˆå§‹åŒ–" class="headerlink" title="ç¯å¢ƒåˆå§‹åŒ–"></a>ç¯å¢ƒåˆå§‹åŒ–</h2><p>è¦æƒ³æµ‹è¯•Fair Schedulerï¼Œé¦–å…ˆè¦è™šæ‹Ÿå‡ºä¸€ä¸ªyarnç¯å¢ƒï¼Œå¹¶åŠ è½½fairç›¸å…³çš„é…ç½®ã€‚<br>ä¸‹é¢å°±æ¥çœ‹ä¸‹<em>TestFairScheduler</em>è¿™ä¸ªç±»æ˜¯æ€ä¹ˆå¯¹ç¯å¢ƒè¿›è¡Œåˆå§‹åŒ–çš„ã€‚</p><p>TestFairSchedulerç»§æ‰¿è‡ª<em>FairSchedulerTestBase</em>ï¼Œä¸€äº›å…¬å…±å¸¸ç”¨æ–¹æ³•è¢«æåˆ°FairSchedulerTestBaseä¸­ï¼Œyarnå’Œç›¸å…³é…ç½®ç¯å¢ƒçš„åˆå§‹åŒ–åœ¨setUpä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setUp</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// new å‡ºä¸€ä¸ªfair Schedulerå®ä¾‹</span></span><br><span class="line">  scheduler = <span class="keyword">new</span> FairScheduler();</span><br><span class="line">  <span class="comment">// åœ¨FairSchedulerTestBaseä¸­å®ç°</span></span><br><span class="line">  conf = createConfiguration();</span><br><span class="line">  <span class="comment">// new å‡ºä¸€ä¸ªrm</span></span><br><span class="line">  resourceManager = <span class="keyword">new</span> ResourceManager();</span><br><span class="line">  resourceManager.init(conf);</span><br><span class="line">  <span class="comment">// <span class="doctag">TODO:</span> This test should really be using MockRM. For now starting stuff</span></span><br><span class="line">  <span class="comment">// å¯åŠ¨rmçš„å¼‚æ­¥è°ƒåº¦å™¨</span></span><br><span class="line">  ((AsyncDispatcher)resourceManager.getRMContext().getDispatcher()).start();</span><br><span class="line">  resourceManager.getRMContext().getStateStore().start();</span><br><span class="line">  <span class="comment">// to initialize the master key</span></span><br><span class="line">  resourceManager.getRMContext().getContainerTokenSecretManager().rollMasterKey();</span><br><span class="line">  scheduler.setRMContext(resourceManager.getRMContext());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// FairSchedulerTestBase</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> Configuration <span class="title">createConfiguration</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Configuration conf = <span class="keyword">new</span> YarnConfiguration();</span><br><span class="line">  conf.setClass(YarnConfiguration.RM_SCHEDULER, FairScheduler.class,</span><br><span class="line">      ResourceScheduler.class);</span><br><span class="line">  conf.setInt(YarnConfiguration.RM_SCHEDULER_MINIMUM_ALLOCATION_MB, <span class="number">0</span>);</span><br><span class="line">  conf.setInt(FairSchedulerConfiguration.RM_SCHEDULER_INCREMENT_ALLOCATION_MB,</span><br><span class="line">      <span class="number">1024</span>);</span><br><span class="line">  conf.setInt(YarnConfiguration.RM_SCHEDULER_MAXIMUM_ALLOCATION_MB, <span class="number">10240</span>);</span><br><span class="line">  conf.setBoolean(FairSchedulerConfiguration.ASSIGN_MULTIPLE, <span class="keyword">false</span>);</span><br><span class="line">  conf.setFloat(FairSchedulerConfiguration.PREEMPTION_THRESHOLD, <span class="number">0f</span>);</span><br><span class="line">  <span class="keyword">return</span> conf;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç¯å¢ƒåˆå§‹åŒ–ä¹‹åï¼Œæˆ‘ä»¬å…ˆæ¥çœ‹ä¸ªç®€å•çš„ä¾‹å­ï¼Œæˆ‘ä»¬èƒ½ä»è¿™ä¸ªä¾‹å­ä¸­çŸ¥é“æ¯ä¸ªé˜Ÿåˆ—çš„FairShareæ˜¯å¦‚ä½•ç®—å‡ºæ¥çš„ã€‚</p><h2 id="FairShareè®¡ç®—é€»è¾‘"><a href="#FairShareè®¡ç®—é€»è¾‘" class="headerlink" title="FairShareè®¡ç®—é€»è¾‘"></a>FairShareè®¡ç®—é€»è¾‘</h2><p>æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testFairShareWithMaxResources</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="comment">// è®¾ç½®fair-scheduler.xmlçš„åŠ è½½åœ°å€ï¼Œç”±AllocationFileLoaderServiceè¿›è¡ŒåŠ è½½æ–‡ä»¶å†…å®¹</span></span><br><span class="line">  conf.set(FairSchedulerConfiguration.ALLOCATION_FILE, ALLOC_FILE);</span><br><span class="line">  <span class="comment">// set queueA and queueB maxResources,</span></span><br><span class="line">  <span class="comment">// the sum of queueA and queueB maxResources is more than</span></span><br><span class="line">  <span class="comment">// Integer.MAX_VALUE.</span></span><br><span class="line">  <span class="comment">// å°†fairçš„é…ç½®ä¿¡æ¯å†™å…¥fair-sheduler.xmlä¸­</span></span><br><span class="line">  PrintWriter out = <span class="keyword">new</span> PrintWriter(<span class="keyword">new</span> FileWriter(ALLOC_FILE));</span><br><span class="line">  out.println(<span class="string">&quot;&lt;?xml version=\&quot;1.0\&quot;?&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;allocations&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;queue name=\&quot;queueA\&quot;&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;maxResources&gt;1073741824 mb 1000 vcores&lt;/maxResources&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;weight&gt;.25&lt;/weight&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;queue name=\&quot;queueB\&quot;&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;maxResources&gt;1073741824 mb 1000 vcores&lt;/maxResources&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;weight&gt;.75&lt;/weight&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;/queue&gt;&quot;</span>);</span><br><span class="line">  out.println(<span class="string">&quot;&lt;/allocations&gt;&quot;</span>);</span><br><span class="line">  out.close();</span><br><span class="line"></span><br><span class="line">  scheduler.init(conf);</span><br><span class="line">  scheduler.start();</span><br><span class="line">  scheduler.reinitialize(conf, resourceManager.getRMContext());</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add one big node (only care about aggregate capacity)</span></span><br><span class="line">  RMNode node1 =</span><br><span class="line">      MockNodes.newNodeInfo(<span class="number">1</span>, Resources.createResource(<span class="number">8</span> * <span class="number">1024</span>, <span class="number">8</span>), <span class="number">1</span>,</span><br><span class="line">          <span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">  NodeAddedSchedulerEvent nodeEvent1 = <span class="keyword">new</span> NodeAddedSchedulerEvent(node1);</span><br><span class="line">  scheduler.handle(nodeEvent1);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Queue A wants 1 * 1024.</span></span><br><span class="line">  createSchedulingRequest(<span class="number">1</span> * <span class="number">1024</span>, <span class="string">&quot;queueA&quot;</span>, <span class="string">&quot;user1&quot;</span>);</span><br><span class="line">  <span class="comment">// Queue B wants 6 * 1024</span></span><br><span class="line">  createSchedulingRequest(<span class="number">6</span> * <span class="number">1024</span>, <span class="string">&quot;queueB&quot;</span>, <span class="string">&quot;user1&quot;</span>);</span><br><span class="line">  <span class="comment">// createSchedulingRequest(1 * 1024, &quot;root.default&quot;, &quot;user1&quot;);</span></span><br><span class="line"></span><br><span class="line">  scheduler.update();</span><br><span class="line"></span><br><span class="line">  FSLeafQueue queue = scheduler.getQueueManager().getLeafQueue(</span><br><span class="line">      <span class="string">&quot;queueA&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">  <span class="comment">// queueA&#x27;s weight is 0.25, so its fair share should be 2 * 1024.</span></span><br><span class="line">  System.out.println( <span class="string">&quot;queueA FairShare: &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">          <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">          <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">          <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">          <span class="string">&quot;, max/min : &quot;</span> + queue.getMaxShare() + <span class="string">&quot;/&quot;</span> + queue.getMinShare());</span><br><span class="line">  <span class="comment">// queueB&#x27;s weight is 0.75, so its fair share should be 6 * 1024.</span></span><br><span class="line">  queue = scheduler.getQueueManager().getLeafQueue(</span><br><span class="line">      <span class="string">&quot;queueB&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">  System.out.println( <span class="string">&quot;queueB FairShare: &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">          <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">          <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">          <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">          <span class="string">&quot;, max/min : &quot;</span> + queue.getMaxShare() + <span class="string">&quot;/&quot;</span> + queue.getMinShare());</span><br><span class="line">  queue = scheduler.getQueueManager().getLeafQueue(</span><br><span class="line">          <span class="string">&quot;default&quot;</span>, <span class="keyword">false</span>);</span><br><span class="line">  System.out.println( <span class="string">&quot;default FairShare: &quot;</span> + queue.getFairShare().getMemory() +</span><br><span class="line">          <span class="string">&quot;, weight : &quot;</span> + queue.getWeights().getWeight(ResourceType.MEMORY) +</span><br><span class="line">          <span class="string">&quot;, steadyShare : &quot;</span> + queue.getSteadyFairShare() +</span><br><span class="line">          <span class="string">&quot;, demand : &quot;</span> + queue.getDemand() +</span><br><span class="line">          <span class="string">&quot;, max/min : &quot;</span> + queue.getMaxShare() + <span class="string">&quot;/&quot;</span> + queue.getMinShare());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç çš„è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">queueA FairShare: 2048, weight : 0.25, steadyShare : &lt;memory:1024, vCores:0&gt;, demand : &lt;memory:1024, vCores:1&gt;, max/min : &lt;memory:1073741824, vCores:1000&gt;/&lt;memory:0, vCores:0&gt;</span><br><span class="line">queueB FairShare: 6144, weight : 0.75, steadyShare : &lt;memory:3072, vCores:0&gt;, demand : &lt;memory:6144, vCores:1&gt;, max/min : &lt;memory:1073741824, vCores:1000&gt;/&lt;memory:0, vCores:0&gt;</span><br><span class="line">default FairShare: 0, weight : 1.0, steadyShare : &lt;memory:4096, vCores:0&gt;, demand : &lt;memory:0, vCores:0&gt;, max/min : &lt;memory:2147483647, vCores:2147483647&gt;/&lt;memory:0, vCores:0&gt;</span><br></pre></td></tr></table></figure><p>ç”±ä¸Šé¢çš„è¿è¡Œç»“æœæˆ‘ä»¬å¯ä»¥çŒœå‡º<strong>Weightçš„é»˜è®¤å€¼æ˜¯1.0</strong>ï¼Œ<strong>maxShareå’ŒminShare(å³maxResourceså’ŒminResources)çš„é»˜è®¤å€¼åˆ†åˆ«ä¸ºInteger.MAX_VALUE(2147483647)å’Œ0</strong>ï¼Œä½†æ˜¯FairShareå’ŒsteadyFairShareæ˜¯ä»€ä¹ˆé¬¼ï¼Ÿ</p><p>æˆ‘ä»¬å…ˆå°†FairShareå’ŒsteadyFairShareæ”¾ä¸‹ï¼Œå…ˆä»‹ç»ä¸‹ä¸ä»–ä»¬ç›¸å…³çš„<em>Weight</em>å’Œ<em>maxResources/minResources</em></p><h3 id="Weight"><a href="#Weight" class="headerlink" title="Weight"></a>Weight</h3><p>Weight å€¼çš„ç±»å‹ä¸ºå¤§äºç­‰äº0.0çš„æ•°ï¼Œé»˜è®¤ä¸º1.0ã€‚Weightæ˜¯é˜Ÿåˆ—çš„ä¸€ä¸ªå±æ€§ï¼Œä½œä¸ºä¸€ä¸ªæƒå€¼ï¼Œä½¿å„ä¸ªé˜Ÿåˆ—å¾—åˆ°çš„èµ„æºæˆæ¯”ä¾‹ã€‚</p><blockquote><p>æ³¨æ„äº‹é¡¹ï¼š</p></blockquote><ul><li><p>weigthçš„å€¼å†³å®šäº†ä¸€ä¸ªé˜Ÿåˆ—ç›¸å¯¹äºå…¶å®ƒ<em>å…„å¼Ÿé˜Ÿåˆ—</em>è€Œè¨€åº”è¯¥å¾—åˆ°çš„èµ„æºï¼Œå‡è®¾ï¼š<br>é›†ç¾¤èµ„æºä¸º1000GBã€200ä¸ªvcoreï¼ŒqueueXçš„weightæ˜¯0.25ï¼Œå…¶å®ƒé˜Ÿåˆ—çš„weightæ€»å’Œä¸º0.75ï¼Œ</p></li><li><p>åˆ™queueXçš„FairShareæ˜¯250GBã€50ä¸ªvcore*ã€‚  <strong>è¿™é‡Œçš„FairShareæ˜¯æŒ‡steadyFairShareï¼ŒåŸå› åœ¨ä¸‹é¢ä»‹ç»</strong></p></li><li><p><em>Weightä¸åªç”¨æ¥è®¡ç®—steadyFairShareä¹Ÿç”¨æ¥è®¡ç®—FairShare</em>ã€‚å‡å¦‚è¿™ä¸ªé˜Ÿåˆ—æˆ–è€…å…¶å­é˜Ÿåˆ—ä¸­è‡³å°‘æœ‰ä¸€ä¸ªactive Applicationï¼Œåˆ™<em>FairShare</em>å°±ä¼šè¢«å¼ºåˆ¶è®¡ç®—(<em>è¿™é‡Œçš„FairShareæ˜¯æŒ‡Instantaneous FairShare</em>)ã€‚</p></li><li><p>weigthçš„å€¼æ˜¯å’Œé›†ç¾¤ç›¸å…³çš„ï¼Œæ‰€ä»¥å½“é›†ç¾¤çš„èµ„æºæ”¹å˜ä¹‹åFairShareä¹Ÿä¼šå‘ç”Ÿå˜åŒ–ï¼Œ</p></li></ul><p><strong>æ€è€ƒ</strong> Weightçš„å€¼åº”è¯¥æ€ä¹ˆè®¾ç½®ï¼Ÿæ€ä¹ˆè®¾ç½®æœ€åˆç†ï¼Ÿï¼Ÿï¼Ÿ</p><h3 id="minResourceså’ŒmaxResources"><a href="#minResourceså’ŒmaxResources" class="headerlink" title="minResourceså’ŒmaxResources"></a>minResourceså’ŒmaxResources</h3><p>minResourceså’ŒmaxResourcesæ˜¯é˜Ÿåˆ—çš„èµ„æºé™åˆ¶ã€‚é»˜è®¤æ˜¯0å’ŒInteger.MAX_VALUE</p><blockquote><p>æ³¨æ„äº‹é¡¹:</p></blockquote><ul><li>minResourcesæ˜¯ä¸€ä¸ªè½¯æ€§çš„é™åˆ¶ã€‚æ»¡è¶³ä¸‹é¢è¿™ä¸¤ç§æƒ…å†µæ—¶ï¼ŒminResourcesä¼šå¼ºåˆ¶è¿™ä¸ªé˜Ÿåˆ—çš„æ€»èµ„æºå¤§äºæˆ–è€…ç­‰äºminResourcesé…ç½®çš„å¤§å°ã€‚</li></ul><ol><li>èµ„æºæ˜¯å¯ç”¨çš„æˆ–è€…å¯ä»¥ä»å…¶å®ƒé˜Ÿåˆ—ä¸­æŠ¢å </li><li>æ‰€æœ‰é˜Ÿåˆ—çš„minResourcesçš„æ€»å’Œä¸è¶…è¿‡é›†ç¾¤çš„æ€»èµ„æº</li></ol><ul><li>maxResourcesæ˜¯ä¸€ä¸ªç¡¬æ€§çš„é™åˆ¶ã€‚ä¹Ÿå°±æ˜¯è¯´è¯¥é˜Ÿåˆ—çš„å­é˜Ÿåˆ—æˆ–è€…åä»£é˜Ÿåˆ—æ­£åœ¨ä½¿ç”¨èµ„æºçš„æ€»å’Œä¸ä¼šè¶…è¿‡æ­¤å€¼ã€‚</li><li>minResourceså’ŒmaxResourceså¹¶ä¸è¢«æ¨èã€‚è¿™ä¸¤ä¸ªé…ç½®æœ‰ä¸€äº›ç¼ºç‚¹ï¼š</li></ul><ol><li>minResourceså’ŒmaxResourcesçš„å€¼éƒ½æ˜¯é™æ€çš„ã€‚å› æ­¤é›†ç¾¤èµ„æºå‘ç”Ÿå˜åŒ–çš„è¯æ­¤å€¼éœ€è¦æ›´æ–°ã€‚(<strong>é‚£ä¸ºä»€ä¹ˆä¸è®¾ç½®ä¸ºç™¾åˆ†æ¯”ï¼Ÿæ˜¯å¦å¯ä»¥è‡ªå·±ä¼˜åŒ–ä¸‹ï¼Ÿï¼Ÿï¼Ÿ</strong>)</li><li>maxResourcesé™åˆ¶äº†é›†ç¾¤èµ„æºçš„ä½¿ç”¨ï¼Œé˜Ÿåˆ—è¶…è¿‡maxResourcesä¹‹åä¸èƒ½å†ä½¿ç”¨ä»»ä½•ç©ºé—²çš„èµ„æºã€‚(è¿™ä¸ªåœ¨ä¸åŒçš„åœºæ™¯ä¼˜ç¼ºç‚¹çš„æ€§è´¨ä¹Ÿä¸ä¸€æ ·)</li><li>å¦‚æœä¸€ä¸ªé˜Ÿåˆ—çš„minResourcesè¶…è¿‡äº†FairShareï¼Œå®ƒå¯èƒ½ä¼šå¯¹å…¶ä»–é˜Ÿåˆ—çš„FairShareé€ æˆå½±å“ã€‚</li><li>In the past, one specified minResources when using preemption to get a chunk of resources sooner. This is no longer necessary as FairShare-based preemption has been improved significantly. We will discuss this subject in more detail later.</li></ol><h3 id="FairShareå’ŒSteadyFairShare"><a href="#FairShareå’ŒSteadyFairShare" class="headerlink" title="FairShareå’ŒSteadyFairShare"></a>FairShareå’ŒSteadyFairShare</h3><p>Fair scheduleråŒ…å«ä¸¤ç§FairShareï¼Œåˆ†åˆ«æ˜¯<em>Instantaneous FairShare</em>å’Œ<em>Steady FairShare</em>ï¼Œå…¶ä¸­<em>Instantaneous FairShare</em>ä¸€èˆ¬è¢«ç®€ç§°ä¸º<strong>FairShare</strong>(æœ¬æ–‡ä¸­çš„FairShareæ˜¯æŒ‡Instantaneous FairShareçš„ç®€ç§°)ã€‚</p><p><em>Steady FairShareæ˜¯ä¸€ä¸ªé˜Ÿåˆ—çš„ç†æƒ³å€¼</em>ï¼Œè¿™ä¸ªå€¼æ˜¯ç”±é›†ç¾¤èµ„æºå’Œweigthsè®¡ç®—å‡ºæ¥çš„ï¼Œå¹¶ä¸ä¼šè¢«ç»å¸¸è®¡ç®—ï¼Œåªæ˜¯åœ¨é›†ç¾¤å¯åŠ¨æˆ–è€…é›†ç¾¤çš„æ€»èµ„æºå‘ç”Ÿå¢å‡çš„æ—¶å€™æ‰ä¼šè¢«é‡æ–°è®¡ç®—ã€‚<em>æ¯ä¸ªé˜Ÿåˆ—çš„Steady FairShareçš„è®¡ç®—å…¬å¼æ˜¯<code>totalResources(é›†ç¾¤æ€»èµ„æº)/weights(æ‰€æœ‰é˜Ÿåˆ—çš„weightæ€»å’Œ)*weight(æŸä¸ªé˜Ÿåˆ—çš„weight)</code></em></p><p>Instantaneous FairShareè®¡ç®—é›†ç¾¤ä¸­<em>æ¯ä¸ªactiveé˜Ÿåˆ—</em>çš„FairShareã€‚Steady FairShareæ˜¯è®¡ç®—é›†ç¾¤ä¸­æ‰€æœ‰çš„é˜Ÿåˆ—ã€‚è¿™ä¸¤è€…çš„åŒºåˆ«ä¸ºï¼š</p><ul><li>ç©ºé˜Ÿåˆ—ä¹Ÿå°±æ˜¯æ²¡æœ‰åˆ†é…ä»»ä½•èµ„æºçš„é˜Ÿåˆ—ä¸ä¼šè®¡ç®—Instantaneous FairShareï¼Œå…¶å€¼ä¸º0ã€‚</li><li><em>å¦‚æœé›†ç¾¤ä¸­æ‰€æœ‰çš„é˜Ÿåˆ—éƒ½æ˜¯activeï¼Œåˆ™Steady FairShareå’ŒInstantaneous FairShareç›¸ç­‰</em>ã€‚</li></ul><p><em>æ¯ä¸ªé˜Ÿåˆ—çš„Instantaneous FairShareçš„è®¡ç®—å…¬å¼æ˜¯<code>totalResources(é›†ç¾¤æ€»èµ„æº)/activeWeights(activeé˜Ÿåˆ—çš„weightæ€»å’Œ)*activeWeight(activeé˜Ÿåˆ—çš„weight)</code></em></p><p>ä¸Šé¢çš„ä¸¤ä¸ªè®¡ç®—å…¬å¼éƒ½ä¸å¤ªä¸¥è°¨ï¼Œä»…ä¾›å‚è€ƒï¼Œä»£ç ä¸­çœŸæ­£çš„è®¡ç®—é€»è¾‘æ¯”è¾ƒå¤æ‚ï¼Œå…ˆçœ‹ä¸‹è®¡ç®—Steady FairShareä»£ç çš„æµç¨‹ã€‚</p><blockquote><p>FairShare<br>æ¯ä¸€ä¸ª<em>é˜Ÿåˆ—/ä½œä¸š</em>ä¼šæœ‰ä¸€ä¸ªFairShareå€¼ï¼Œè¡¨ç¤ºè¯¥é˜Ÿåˆ—/ä½œä¸šå½“å‰åº”å¾—çš„èµ„æºã€‚è°ƒåº¦å™¨åå°ä¼šæœ‰ä¸€ä¸ªçº¿ç¨‹ä¸åœçš„æ ¹æ®å½“å‰é›†ç¾¤æ•´ä½“æƒ…å†µï¼ŒåŠ¨æ€çš„æ›´æ–°æ¯ä¸ªä½œä¸šçš„FairShareå€¼ã€‚é€šå¸¸å½“æŸä¸ªä½œä¸šå®é™…è·å–åˆ°èµ„æºä¸æ»¡è¶³å…¶FairShareæ—¶ï¼Œè¯¥ä½œä¸šä¼šæ›´æœ‰å¯èƒ½è·å–åˆ°æ–°çš„èµ„æºï¼ŒåŒæ ·å½“ä½œä¸šå®é™…è·å–åˆ°èµ„æºè¶…å‡ºå…¶FairShareï¼Œåˆ™å¾ˆéš¾å†è·å–åˆ°æ–°çš„èµ„æºï¼Œç”šè‡³ç°æœ‰çš„èµ„æºä¹Ÿä¼šè¢«æŠ¢å ã€‚<br>FairShareçš„è®¡ç®—ä¹Ÿæ˜¯ä¸€ä¸ªè‡ªé¡¶å‘ä¸‹èµ„æºåˆ†é…çš„è¿‡ç¨‹ï¼Œé€šå¸¸æƒ…å†µä¸‹åŒä¸€ä¸ªé˜Ÿåˆ—å†…çš„å„ä¸ªä½œä¸šä¼šå°½é‡å‡åˆ†é˜Ÿåˆ—èµ„æºã€‚åŒæ—¶å…·ä½“æŸä¸ªä½œä¸šçš„FairShareä¼šå—åˆ°å…¶ä»–ä¸€äº›å‚æ•°çš„ä¿®æ­£ã€‚</p></blockquote><p>ä¸Šé¢æåˆ°Steady FairShareåªæ˜¯åœ¨é›†ç¾¤æ€»èµ„æºå‘ç”Ÿå˜åŒ–æ—¶æ‰ä¼šè¢«è®¡ç®—ï¼Œåˆ™å…¶å…¥å£å‡½æ•°æ˜¯<code>scheduler.handle(nodeEvent1);</code>,scheduleræ•è·åˆ°<code>NODE_ADDED</code>äº‹ä»¶ï¼Œè°ƒç”¨<code>addNode</code>ï¼Œç„¶åç»§ç»­è°ƒç”¨<code>queueMgr.getRootQueue().setSteadyFairShare(clusterResource);queueMgr.getRootQueue().recomputeSteadyShares()</code>å…ˆè®¾ç½®æ•´ä¸ªé›†ç¾¤çš„steadyFairShareï¼Œç„¶åè®¡ç®—æ¯ä¸ªé˜Ÿåˆ—çš„steadyFairShareï¼Œè¿™é‡Œä»recomputeSteadyShareså¼€å§‹å±¡ä¸‹ä»£ç çš„æ€è·¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recomputeSteadyShares</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ ¹æ®ä¸åŒçš„è°ƒåº¦ç­–ç•¥è®¡ç®—steadyFairShare</span></span><br><span class="line">  <span class="comment">// fair schedulerä¸­å¯ä»¥ä¸ºæ¯ä¸ªé˜Ÿåˆ—è®¾ç½®è°ƒåº¦ç­–ç•¥ï¼Œè¿™é‡Œä»¥fairä¸ºä¾‹</span></span><br><span class="line">  policy.computeSteadyShares(childQueues, getSteadyFairShare());</span><br><span class="line">  <span class="comment">// å°†ä¸Šé¢è®¡ç®—çš„steadyFairShareèµ‹å€¼ç»™æ¯ä¸ªé˜Ÿåˆ—</span></span><br><span class="line">  <span class="comment">// å¦‚æœé˜Ÿåˆ—æ˜¯çˆ¶é˜Ÿåˆ—ï¼Œåˆ™ç»§ç»­steadyFairShare</span></span><br><span class="line">  <span class="keyword">for</span> (FSQueue childQueue : childQueues) &#123;</span><br><span class="line">    childQueue.getMetrics().setSteadyFairShare(childQueue.getSteadyFairShare());</span><br><span class="line">    <span class="keyword">if</span> (childQueue <span class="keyword">instanceof</span> FSParentQueue) &#123;</span><br><span class="line">      ((FSParentQueue) childQueue).recomputeSteadyShares();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FairSharePolicy.java</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">computeSteadyShares</span><span class="params">(Collection&lt;? extends FSQueue&gt; queues,</span></span></span><br><span class="line"><span class="params"><span class="function">    Resource totalResources)</span> </span>&#123;</span><br><span class="line">  ComputeFairShares.computeSteadyShares(queues, totalResources,</span><br><span class="line">      ResourceType.MEMORY);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè®¡ç®—steadyFairShareç”¨çš„æ˜¯fairç­–ç•¥ï¼Œåˆ™è°ƒç”¨FairSharePolicy.computeSteadySharesï¼Œè°ƒç”¨<code>ComputeFairShares.computeSteadyShares</code>æ¥è®¡ç®—steadyFairShareï¼Œ<code>ComputeFairShares</code>æ˜¯è®¡ç®—FairShareçš„ä¸»è¦é€»è¾‘å®ç°ã€‚å…ˆæ¥çœ‹ä¸‹computeSteadySharesæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">computeSteadyShares</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;? extends FSQueue&gt; queues, Resource totalResources,</span></span></span><br><span class="line"><span class="params"><span class="function">    ResourceType type)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è®¡ç®—steadyFairShareå’ŒFairShareï¼Œæœ€åä¸€ä¸ªå‚æ•°æ˜¯æ ‡è¯†ä½ï¼Œtrueä¸ºè®¡ç®—steadyFairShare</span></span><br><span class="line">  computeSharesInternal(queues, totalResources, type, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±äºFairShareå’ŒsteadyFairShareéƒ½æ˜¯åœ¨ComputeFairSharesç±»ä¸­ï¼Œè€Œä¸”å…¶è®¡ç®—é€»è¾‘ç±»ä¼¼ï¼Œæ‰€ä»¥æ”¾åœ¨åŒä¸€ä¸ªæ–¹æ³•ä¸­è®¡ç®—ï¼Œæå‡ºä¸€ä¸ªæ ‡è¯†ä½æ¥æ ‡è¯†è®¡ç®—çš„æ˜¯FairShareè¿˜æ˜¯steadyFairShareï¼Œè¿™ä¸ªæ–¹æ³•å°±æ˜¯<code>computeSharesInternal</code>ã€‚</p><p>computeSteadySharesè®¡ç®—çš„æ˜¯steadyFairShareï¼Œåˆ™è°ƒç”¨<code>computeSharesInternal</code>æ—¶ï¼Œå°†æ ‡è¯†ä½è®¾ä¸ºtrueï¼ŒcomputeSharesInternalçš„è®¡ç®—é€»è¾‘å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">computeSharesInternal</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;? extends Schedulable&gt; allSchedulables,</span></span></span><br><span class="line"><span class="params"><span class="function">    Resource totalResources, ResourceType type, <span class="keyword">boolean</span> isSteadyShare)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  Collection&lt;Schedulable&gt; schedulables = <span class="keyword">new</span> ArrayList&lt;Schedulable&gt;();</span><br><span class="line">  <span class="comment">// å¾—åˆ°ä¸ç”¨è®¡ç®—FairShareæˆ–è€…SteadyFairShareçš„é˜Ÿåˆ—å’Œè¿™äº›é˜Ÿåˆ—çš„è¿”å›çš„èµ„æº</span></span><br><span class="line">  <span class="keyword">int</span> takenResources = handleFixedFairShares(</span><br><span class="line">      allSchedulables, schedulables, isSteadyShare, type);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (schedulables.isEmpty()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Find an upper bound on R that we can use in our binary search. We start</span></span><br><span class="line">  <span class="comment">// at R = 1 and double it until we have either used all the resources or we</span></span><br><span class="line">  <span class="comment">// have met all Schedulables&#x27; max shares.</span></span><br><span class="line">  <span class="comment">// å¯¹éœ€è¦è®¡ç®—FairShareçš„é˜Ÿåˆ—çš„maxShareè¿›è¡Œsum</span></span><br><span class="line">  <span class="keyword">int</span> totalMaxShare = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (Schedulable sched : schedulables) &#123;</span><br><span class="line">    <span class="keyword">int</span> maxShare = getResourceValue(sched.getMaxShare(), type);</span><br><span class="line">    totalMaxShare = (<span class="keyword">int</span>) Math.min((<span class="keyword">long</span>)maxShare + (<span class="keyword">long</span>)totalMaxShare,</span><br><span class="line">        Integer.MAX_VALUE);</span><br><span class="line">    <span class="keyword">if</span> (totalMaxShare == Integer.MAX_VALUE) &#123;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> totalResource = Math.max((getResourceValue(totalResources, type) -</span><br><span class="line">      takenResources), <span class="number">0</span>);</span><br><span class="line">  <span class="comment">// å¯ç”¨èµ„æºçš„æ€»å’Œ</span></span><br><span class="line">  totalResource = Math.min(totalMaxShare, totalResource);</span><br><span class="line">  <span class="comment">// æ‰¾åˆ°Rçš„ä¸Šé™</span></span><br><span class="line">  <span class="keyword">double</span> rMax = <span class="number">1.0</span>;</span><br><span class="line">  <span class="keyword">while</span> (resourceUsedWithWeightToResourceRatio(rMax, schedulables, type)</span><br><span class="line">      &lt; totalResource) &#123;</span><br><span class="line">    rMax *= <span class="number">2.0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Perform the binary search for up to COMPUTE_FAIR_SHARES_ITERATIONS steps</span></span><br><span class="line">  <span class="keyword">double</span> left = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">double</span> right = rMax;</span><br><span class="line">  <span class="comment">// äºŒåˆ†æŸ¥æ‰¾ï¼Œæœ‰è¿­ä»£ä¸Šé™ï¼ŒCOMPUTE_FAIR_SHARES_ITERATIONSæ˜¯25</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; COMPUTE_FAIR_SHARES_ITERATIONS; i++) &#123;</span><br><span class="line">    <span class="keyword">double</span> mid = (left + right) / <span class="number">2.0</span>;</span><br><span class="line">    <span class="keyword">int</span> plannedResourceUsed = resourceUsedWithWeightToResourceRatio(</span><br><span class="line">        mid, schedulables, type);</span><br><span class="line">    <span class="keyword">if</span> (plannedResourceUsed == totalResource) &#123;</span><br><span class="line">      right = mid;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (plannedResourceUsed &lt; totalResource) &#123;</span><br><span class="line">      left = mid;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      right = mid;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Set the fair shares based on the value of R we&#x27;ve converged to</span></span><br><span class="line">  <span class="comment">// å¯¹æ¯ä¸ªé˜Ÿåˆ—è®¾ç½®FairShareæˆ–è€…SteadyFairShareï¼Œ</span></span><br><span class="line">  <span class="comment">// rightå€¼å°±æ˜¯æ‰€è¦æ±‚çš„FairShareæˆ–è€…SteadyFairShareå€¼</span></span><br><span class="line">  <span class="keyword">for</span> (Schedulable sched : schedulables) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isSteadyShare) &#123;</span><br><span class="line">      setResourceValue(computeShare(sched, right, type),</span><br><span class="line">          ((FSQueue) sched).getSteadyFairShare(), type);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setResourceValue(</span><br><span class="line">          computeShare(sched, right, type), sched.getFairShare(), type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>computeSharesInternalå¯ä»¥ç”¨æ¥è®¡ç®—FairShareå’ŒSteadyFairShareï¼Œä½†æ˜¯è¿™ä¸¤ä¸ªè®¡ç®—çš„é˜Ÿåˆ—é›†åˆæ˜¯ä¸ä¸€æ ·çš„ï¼Œé‚£è¿™ä¸ªé˜Ÿåˆ—é›†åˆæ˜¯åœ¨å“ªè¿›è¡Œç­›é€‰çš„å‘¢ï¼Ÿä»ä¸Šé¢çš„ä»£ç ä¸­å¯ä»¥çœ‹åˆ°æœ‰ä¸ª<code>handleFixedFairShares</code>æ–¹æ³•ï¼Œçœ‹ä¸‹å…¶å…·ä½“çš„å®ç°:</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">handleFixedFairShares</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;? extends Schedulable&gt; schedulables,</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;Schedulable&gt; nonFixedSchedulables,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> isSteadyShare, ResourceType type)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å¦‚æœé˜Ÿåˆ—æ˜¯fixedï¼Œåˆ™è¿”å›å…¶é˜Ÿåˆ— fixedShare çš„æ€»å’Œ</span></span><br><span class="line">  <span class="keyword">int</span> totalResource = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">for</span> (Schedulable sched : schedulables) &#123;</span><br><span class="line">  <span class="comment">// åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦æ˜¯fixed</span></span><br><span class="line">    <span class="keyword">int</span> fixedShare = getFairShareIfFixed(sched, isSteadyShare, type);</span><br><span class="line">    <span class="keyword">if</span> (fixedShare &lt; <span class="number">0</span>) &#123;</span><br><span class="line">      nonFixedSchedulables.add(sched);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      setResourceValue(fixedShare,</span><br><span class="line">          isSteadyShare</span><br><span class="line">              ? ((FSQueue)sched).getSteadyFairShare()</span><br><span class="line">              : sched.getFairShare(),</span><br><span class="line">          type);</span><br><span class="line">      totalResource = (<span class="keyword">int</span>) Math.min((<span class="keyword">long</span>)totalResource + (<span class="keyword">long</span>)fixedShare,</span><br><span class="line">          Integer.MAX_VALUE);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> totalResource;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handleFixedFairSharesç”¨æ¥å¯¹é˜Ÿåˆ—è¿›è¡Œå¤„ç†ï¼Œå°†fixedé˜Ÿåˆ—çš„fixed fairshareè¿›è¡Œæ±‚å’Œè¿”å›ï¼Œå¹¶å°†éfixedçš„é˜Ÿåˆ—æ”¾å…¥nonFixedSchedulablesä¸­ã€‚åˆ¤æ–­æŸä¸ªé˜Ÿåˆ—æ˜¯å¦fixedæ˜¯ç”±æ–¹æ³•<code>getFairShareIfFixed</code>åˆ¤æ–­çš„ï¼Œåˆ¤æ–­æ ‡å‡†å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getFairShareIfFixed</span><span class="params">(Schedulable sched,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">boolean</span> isSteadyShare, ResourceType type)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å½“maxResourceså°äºç­‰äº0æ—¶ï¼Œè¯¥é˜Ÿåˆ—æ˜¯fixed</span></span><br><span class="line">  <span class="keyword">if</span> (getResourceValue(sched.getMaxShare(), type) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// isSteadyShareæ˜¯falseï¼Œç”¨æ¥æ±‚FairShareï¼Œåˆ™åˆ¤æ–­é˜Ÿåˆ—æ˜¯å¦ä¸ºactive</span></span><br><span class="line">  <span class="comment">// è¯¥é˜Ÿåˆ—ä¸æ˜¯activeæ—¶ï¼Œè¿”å›0ï¼Œä»£è¡¨è¯¥é˜Ÿåˆ—æ˜¯fixed</span></span><br><span class="line">  <span class="comment">// For instantaneous fairshares, check if queue is active</span></span><br><span class="line">  <span class="keyword">if</span> (!isSteadyShare &amp;&amp;</span><br><span class="line">      (sched <span class="keyword">instanceof</span> FSQueue) &amp;&amp; !((FSQueue)sched).isActive()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å½“é˜Ÿåˆ—çš„weightå°äºç­‰äº0æ—¶ï¼Œè¯¥é˜Ÿåˆ—æ˜¯fixedï¼Œè¿”å›0æˆ–è€…minShare</span></span><br><span class="line">  <span class="comment">// Check if weight is 0</span></span><br><span class="line">  <span class="keyword">if</span> (sched.getWeights().getWeight(type) &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">int</span> minShare = getResourceValue(sched.getMinShare(), type);</span><br><span class="line">    <span class="keyword">return</span> (minShare &lt;= <span class="number">0</span>) ? <span class="number">0</span> : minShare;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å½“é˜Ÿåˆ—æ˜¯éfixedæ—¶ï¼Œè¿”å›-1</span></span><br><span class="line">  <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ¤æ–­ä¸€ä¸ªé˜Ÿåˆ—æ˜¯fixedçš„æ¡ä»¶æ˜¯ï¼š</p><ul><li>maxResourceså°äºç­‰äº0</li><li>weightå°äºç­‰äº0</li><li>å½“æ±‚FairShareæ—¶ï¼Œå¦‚æœé˜Ÿåˆ—æ˜¯éactiveæ—¶</li></ul><p>computeSharesInternalé€šè¿‡handleFixedFairShareså°†<code>nonFixedSchedulables</code>æ”¾å…¥<code>schedulables</code>ä¸­ï¼Œschedulablesé›†åˆä¸­å­˜æ”¾çš„å°±æ˜¯éœ€è¦è®¡ç®—FairShareæˆ–è€…SteadyFairShareçš„é˜Ÿåˆ—ã€‚</p><p>æ±‚å‡ºæ‰€éœ€è®¡ç®—çš„é˜Ÿåˆ—é›†åˆä¹‹åï¼Œåˆ™å¯¹è¿™äº›é˜Ÿåˆ—åº”å¾—çš„èµ„æºè¿›è¡Œè®¡ç®—ï¼Œè¦è®¡ç®—åº”å¾—èµ„æºåˆ™éœ€æ±‚å‡ºè¿™äº›é˜Ÿåˆ—çš„æ€»èµ„æº(<em>è¿™é‡Œçš„æ€»èµ„æºå¹¶ä¸æ˜¯é›†ç¾¤çš„æ€»èµ„æºï¼Œè€Œæ˜¯æ‰€éœ€è®¡ç®—é˜Ÿåˆ—çš„æ€»èµ„æº</em>)ã€‚<em>æ‰€æ±‚é˜Ÿåˆ—çš„æ€»èµ„æºå°±æ˜¯è¿™äº›é˜Ÿåˆ—æ‰€é…ç½®çš„maxResourcesä¹‹å’Œ</em>ï¼Œå…¶è®¡ç®—æ–¹å¼ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™éƒ¨åˆ†ä»£ç åœ¨computeSharesInternalä¸­</span></span><br><span class="line"><span class="keyword">int</span> totalMaxShare = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">for</span> (Schedulable sched : schedulables) &#123;</span><br><span class="line">  <span class="keyword">int</span> maxShare = getResourceValue(sched.getMaxShare(), type);</span><br><span class="line">  totalMaxShare = (<span class="keyword">int</span>) Math.min((<span class="keyword">long</span>)maxShare + (<span class="keyword">long</span>)totalMaxShare,</span><br><span class="line">      Integer.MAX_VALUE);</span><br><span class="line">  <span class="keyword">if</span> (totalMaxShare == Integer.MAX_VALUE) &#123;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™äº›é˜Ÿåˆ—çš„æ€»å’Œæœ‰å¯èƒ½è¶…è¿‡Integer.MAX_VALUEï¼Œåˆ™éœ€è¦å¯¹å…¶æ€»èµ„æºè¿›è¡Œæ ¡éªŒï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™éƒ¨åˆ†ä»£ç åœ¨computeSharesInternalä¸­</span></span><br><span class="line"><span class="comment">// totalResources é›†ç¾¤æ€»èµ„æºï¼ŒtakenResourcesä¸ºä¸éœ€è¦è®¡ç®—é˜Ÿåˆ—(å³fixed é˜Ÿåˆ—)çš„èµ„æºæ€»å’Œ</span></span><br><span class="line"><span class="keyword">int</span> totalResource = Math.max((getResourceValue(totalResources, type) -</span><br><span class="line">    takenResources), <span class="number">0</span>);</span><br><span class="line">totalResource = Math.min(totalMaxShare, totalResource);</span><br></pre></td></tr></table></figure><p>æ±‚å‡ºè¿™äº›é˜Ÿåˆ—çš„æ€»èµ„æºï¼Œåˆ™ä¸‹é¢å°±æ˜¯å°†è¿™äº›èµ„æºæ ¹æ®å„ä¸ªé˜Ÿåˆ—çš„weightè¿›è¡Œåˆ†é…ã€‚</p><p>åœ¨è€ƒè™‘minResourceså’ŒmaxResourcesæ—¶å°½å¯èƒ½çš„è¿›è¡Œå…¬å¹³åˆ†é…èµ„æºï¼Œ<em>fair schedulerè§„å®šFairShareéœ€åœ¨minResourceså’ŒmaxResourcesä¹‹é—´</em>ã€‚</p><p>fair schedulerå®šä¹‰ä¸€ä¸ªæ¯”å€¼Rï¼Œåˆ™å„ä¸ªé˜Ÿåˆ—åº”åˆ†é…çš„èµ„æºåˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><ul><li>å½“é˜Ÿåˆ—Sçš„_minShare &gt; R*weight_ï¼Œåˆ™åˆ†é…minShare</li><li>å½“é˜Ÿåˆ—Sçš„_manShare &lt; R*weight_ï¼Œåˆ™åˆ†é…manShare</li><li>å…¶å®ƒæƒ…å†µç›´æ¥åˆ†é…_R*weight_<br>è¿™äº›åˆ†é…çš„æ€»å’Œç­‰äºtotalSlotsã€‚è¿™ä¸ªæ¯”å€¼Rä¹Ÿç§°ä¸ºweight-to-slotsï¼Œå› ä¸ºå…¶å€¼å°†é˜Ÿåˆ—çš„weightè½¬æ¢ä¸ºå®é™…çš„èµ„æºä¸ªæ•°ã€‚</li></ul><p>é‚£ä¹ˆRçš„å–å€¼æ˜¯å…³é”®ï¼ŒRè¿‡å°åˆ™å¯¼è‡´åˆ†é…ç»™é˜Ÿåˆ—çš„slotsæ€»å’Œå°äºtotalSlotsï¼ŒRè¿‡å¤§åˆ™å¯¼è‡´åˆ†é…çš„slotsæ€»å’Œå¤šä½™totalSlotsã€‚</p><p>Rçš„æŸ¥æ‰¾å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œåˆ™å¦ä¸€ä¸ªå…³é”®ç‚¹å°±æ˜¯Rä¸Šé™çš„ç¡®å®šï¼Œç”±ä¸Šé¢å¯¹Rçš„å®šä¹‰ï¼Œå¾—çŸ¥Rçš„ä¸Šé™å°±æ˜¯å°½å¯èƒ½çš„è®©åˆ†é…çš„slotsæ¥è¿‘totalSlotsã€‚Rä¸Šé™çš„ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™éƒ¨åˆ†ä»£ç åœ¨computeSharesInternalä¸­</span></span><br><span class="line"><span class="keyword">double</span> rMax = <span class="number">1.0</span>;</span><br><span class="line"><span class="comment">// rMaxä¸æ»¡è¶³ä¸Šé™çš„æ ‡å‡†åˆ™ä½¿å…¶ä¹˜ä»¥2ï¼Œç»§ç»­å¾ªç¯</span></span><br><span class="line"><span class="keyword">while</span> (resourceUsedWithWeightToResourceRatio(rMax, schedulables, type)</span><br><span class="line">    &lt; totalResource) &#123;</span><br><span class="line">  rMax *= <span class="number">2.0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>resourceUsedWithWeightToResourceRatioè¿”å›çš„å€¼æ˜¯å½“Rä¸ºrMaxæ—¶ï¼Œå„ä¸ªé˜Ÿåˆ—åˆ†é…çš„slotsæ€»å’Œã€‚è€Œå„ä¸ªé˜Ÿåˆ—åº”è¯¥åˆ†é…çš„slotsæ˜¯é€šè¿‡computeShareè®¡ç®—çš„ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">resourceUsedWithWeightToResourceRatio</span><span class="params">(<span class="keyword">double</span> w2rRatio,</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;? extends Schedulable&gt; schedulables, ResourceType type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> resourcesTaken = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (Schedulable sched : schedulables) &#123;</span><br><span class="line">    <span class="keyword">int</span> share = computeShare(sched, w2rRatio, type);</span><br><span class="line">    resourcesTaken += share;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> resourcesTaken;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">computeShare</span><span class="params">(Schedulable sched, <span class="keyword">double</span> w2rRatio,</span></span></span><br><span class="line"><span class="params"><span class="function">    ResourceType type)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">double</span> share = sched.getWeights().getWeight(type) * w2rRatio;</span><br><span class="line">  share = Math.max(share, getResourceValue(sched.getMinShare(), type));</span><br><span class="line">  share = Math.min(share, getResourceValue(sched.getMaxShare(), type));</span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>) share;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>æ‰¾åˆ°Rçš„æœ€å¤§å€¼ä¹‹åï¼Œå°±æ˜¯è¿›è¡ŒäºŒåˆ†æŸ¥æ‰¾ï¼Œæ‰¾åˆ°æœ€å…¬å¹³çš„åˆ†é…æ–¹æ¡ˆï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™éƒ¨åˆ†ä»£ç åœ¨computeSharesInternalä¸­</span></span><br><span class="line"><span class="keyword">double</span> left = <span class="number">0</span>;</span><br><span class="line"><span class="keyword">double</span> right = rMax;</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; COMPUTE_FAIR_SHARES_ITERATIONS; i++) &#123;</span><br><span class="line">  <span class="keyword">double</span> mid = (left + right) / <span class="number">2.0</span>;</span><br><span class="line">  <span class="keyword">int</span> plannedResourceUsed = resourceUsedWithWeightToResourceRatio(</span><br><span class="line">      mid, schedulables, type);</span><br><span class="line">  <span class="keyword">if</span> (plannedResourceUsed == totalResource) &#123;</span><br><span class="line">    right = mid;</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (plannedResourceUsed &lt; totalResource) &#123;</span><br><span class="line">    left = mid;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    right = mid;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åæ ¹æ®<code>isSteadyShare</code>æ ‡è¯†è®¾ç½®æ¯ä¸ªé˜Ÿåˆ—çš„FairShareæˆ–è€…SteadyFairShareçš„å€¼ã€‚</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬ç¯‡ä¸»è¦è§£æäº†ä¸‹é˜Ÿåˆ—FairShareå’ŒSteadyFairShareçš„è®¡ç®—è¿‡ç¨‹ï¼Œå…¶ä¸­<em>FairShareå’ŒSteadyFairShareçš„åŒºåˆ«ä¸ºFairShareåˆ†ä¸ºInstantaneous FairShareå’ŒSteadyFairShareï¼Œä½†æ˜¯Instantaneous FairShareä¸€èˆ¬ç®€ç§°ä¸ºFairShare</em>ï¼Œåˆ™FairShareå’ŒSteadyFairShareçš„åŒºåˆ«ä¸ºå‰è€…è®¡ç®—æ—¶ä¸åŒ…æ‹¬æœªactiveçš„é˜Ÿåˆ—ï¼Œåè€…è®¡ç®—æ—¶åŒ…æ‹¬æ‰€æœ‰çš„é˜Ÿåˆ—ã€‚</p><p>FairShareå’ŒSteadyFairShareçš„è®¡ç®—æ€æƒ³ä¸ºï¼š<br>å…ˆæ‰¾åˆ°ä¸€ä¸ªæ¯”å€¼Rï¼Œåˆ™å„ä¸ªé˜Ÿåˆ—åº”åˆ†é…çš„èµ„æºåˆ†ä¸ºå¦‚ä¸‹ä¸‰ç§æƒ…å†µï¼š</p><ul><li>å½“é˜Ÿåˆ—Sçš„_minShare &gt; R*weight_ï¼Œåˆ™åˆ†é…minShare</li><li>å½“é˜Ÿåˆ—Sçš„_maxShare &lt; R*weight_ï¼Œåˆ™åˆ†é…maxShare</li><li>å…¶å®ƒæƒ…å†µç›´æ¥åˆ†é…_R*weight_<br>è¿™äº›åˆ†é…çš„æ€»å’Œç­‰äºtotalSlotsã€‚è¿™ä¸ªæ¯”å€¼Rä¹Ÿç§°ä¸ºweight-to-slotsï¼Œå› ä¸ºå…¶å€¼å°†é˜Ÿåˆ—çš„weightè½¬æ¢ä¸ºå®é™…çš„èµ„æºä¸ªæ•°ã€‚</li></ul><p>å…¶ä¸­æ¯”å€¼Rçš„æŸ¥æ‰¾æ¯”è¾ƒéº»çƒ¦ï¼Œå¹³æ—¶å¦‚æœæƒ³ç®€å•çš„è¯„ä¼°ä¸‹å„ä¸ªé˜Ÿåˆ—åº”åˆ†é…çš„èµ„æºå¯ä»¥ä½¿ç”¨å¦‚ä¸‹å…¬å¼ï¼š<br>Steady FairShareçš„è®¡ç®—å…¬å¼æ˜¯<code>totalResources(é›†ç¾¤æ€»èµ„æº)/weights(æ‰€æœ‰é˜Ÿåˆ—çš„weightæ€»å’Œ)*weight(æŸä¸ªé˜Ÿåˆ—çš„weight)</code><br>FairShareçš„è®¡ç®—å…¬å¼æ˜¯<code>totalResources(é›†ç¾¤æ€»èµ„æº)/activeWeights(activeé˜Ÿåˆ—çš„weightæ€»å’Œ)*activeWeight(activeé˜Ÿåˆ—çš„weight)</code></p><p>è¿™ä¸¤ä¸ªå…¬å¼æˆç«‹çš„<strong>å‰ææ˜¯æ‰€æ±‚å‡ºçš„SteadyFairShareå’ŒFairShareåœ¨minResourceså’ŒmaxResourcesä¹‹é—´</strong>ã€‚å¦‚æœå°äºminResources(å¤§äºmaxResources)åˆ™steadyFairShareæˆ–è€…FairShareåº”è¯¥ä¸ºminResources(maxResources)ï¼Œè¿™ç§æƒ…å†µåˆ†é…ç»™é˜Ÿåˆ—çš„slotsæ€»å’Œä¼šè¶…å‡ºtotalSlotsã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> FairShare </tag>
            
            <tag> SteadyFairShare </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Longest Palindromic</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Longest%20Palindromic.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Longest%20Palindromic.html</url>
      
        <content type="html"><![CDATA[<p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ±‚æœ€é•¿å›æ–‡<em>å­ä¸²</em>(å‡è®¾å­—ç¬¦ä¸²ä¸­åªæœ‰å”¯ä¸€çš„ä¸€ä¸ªæœ€é•¿å›æ–‡å­ä¸²)ã€‚</p><p><em>æ³¨æ„å­ä¸²å’Œå­åºåˆ—çš„åŒºåˆ«ï¼Œå­ä¸²æ˜¯è¿ç»­çš„ï¼Œå­åºåˆ—æ˜¯éè¿ç»­çš„</em><br>ä¾‹å¦‚ï¼š<br>å­—ç¬¦ä¸²â€xyzabccbadâ€, æœ€é•¿å›æ–‡ä¸ºâ€abccbaâ€<br>å­—ç¬¦ä¸²â€aaaâ€, æœ€é•¿å›æ–‡ä¸ºâ€aaaâ€<br>å­—ç¬¦ä¸²â€bananasâ€, æœ€é•¿å›æ–‡ä¸ºâ€ananaâ€</p><span id="more"></span><blockquote><p>å›æ–‡å°±æ˜¯é¡ºç€è¯»å’Œé€†ç€è¯»æ˜¯ä¸€æ ·çš„ã€‚</p></blockquote><h2 id="åŠ¨æ€è§„åˆ’ç®—æ³•"><a href="#åŠ¨æ€è§„åˆ’ç®—æ³•" class="headerlink" title="åŠ¨æ€è§„åˆ’ç®—æ³•"></a>åŠ¨æ€è§„åˆ’ç®—æ³•</h2><p>æœ€é•¿å›æ–‡å­ä¸²å¯è§æ˜¯æ±‚æœ€ä¼˜è§£ï¼Œå¹¶ä¸”å¯ä»¥å¯¹å°†æ­¤é—®é¢˜æ‹†åˆ†ï¼Œåˆ™è§‚å¯Ÿèƒ½å¦ç”¨åŠ¨æ€è§„åˆ’å»å°è¯•ã€‚</p><p>è¦ç”¨åŠ¨æ€è§„åˆ’é¦–å…ˆè¦æ‰¾åˆ°<em>è½¬ç§»æ–¹ç¨‹</em>ï¼Œ</p><blockquote><p>è¿™é‡Œéœ€è¦æ³¨æ„ï¼Œå‡å¦‚ä½ å‘ç°è‡ªå·±çš„è½¬ç§»æ–¹ç¨‹çš„ç‰¹åˆ«ç¹çæˆ–è€…éœ€è¦è€ƒè™‘å¾ˆå¤šä¸åŒçš„æƒ…å†µæ›´æˆ–è€…æ˜¯æ€»ä¸€äº›æƒ…å†µæ— æ³•ç”¨è½¬ç§»æ–¹ç¨‹è¡¨ç¤ºæ—¶ï¼Œè¿™æ—¶ä½ å°±åº”è¯¥è€ƒè™‘æ˜¯å¦åº”è¯¥<strong>é‡æ–°å®šä¹‰çŠ¶æ€ï¼Œè¿›è¡Œé‡æ–°æ•´ç†è½¬ç§»æ–¹ç¨‹</strong>ã€‚</p></blockquote><p>å‡è®¾ï¼šdp[i][j]è¡¨ç¤ºiä¸ºå¼€å§‹jä¸ºç»“å°¾çš„å­—ç¬¦ä¸²æ˜¯å¦ä¸ºå›æ–‡ï¼Œåˆ™è½¬ç§»æ–¹ç¨‹å¦‚ä¸‹ï¼š<br>dp[i][j] = true (chars[j] == chars[i] &amp;&amp; dp[i+1][j-1])</p><p>åˆå§‹æ¡ä»¶æ˜¯dp[i][i] = true (0&lt;i&lt;chars.length); dp[i][i+1] = chars[i] == chars<a href="i%E5%88%B0i+1%E6%97%B6%E4%B8%8D%E9%80%82%E7%94%A8%E4%B8%8A%E9%9D%A2%E7%9A%84%E8%BD%AC%E7%A7%BB%E6%96%B9%E7%A8%8B">i+1</a></p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">dp</span><span class="params">(String str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span>[][] dp = <span class="keyword">new</span> <span class="keyword">boolean</span>[str.length()][str.length()];</span><br><span class="line">    <span class="keyword">char</span>[] chars = str.toCharArray();</span><br><span class="line">    <span class="keyword">int</span> longest = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–dpæ•°ç»„ï¼Œæ•°ç»„çš„å€¼æ˜¯å½“å‰å­ä¸²æ˜¯å¦ä¸ºå›æ–‡</span></span><br><span class="line">    <span class="comment">// å•ä¸ªå­—ç¬¦æ˜¯å›æ–‡ï¼Œå½“chars[i] == chars[i+1]æ—¶ï¼Œdp[i][i+1]çš„å€¼ä¸ºtrue</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;chars.length; i++)&#123;</span><br><span class="line">        dp[i][i] = <span class="keyword">true</span>;</span><br><span class="line">        <span class="keyword">if</span> ((i - i + <span class="number">1</span>) &gt; longest)&#123;</span><br><span class="line">            start = i;</span><br><span class="line">            longest = i - i + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (i+<span class="number">1</span>&lt;chars.length &amp;&amp; chars[i] == chars[i+<span class="number">1</span>])&#123;</span><br><span class="line">            dp[i][i+<span class="number">1</span>] = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">if</span> (((i+<span class="number">1</span>) - i + <span class="number">1</span>) &gt; longest)&#123;</span><br><span class="line">                start = i;</span><br><span class="line">                longest = (i+<span class="number">1</span>) - i + <span class="number">1</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (i+<span class="number">1</span> &lt; chars.length)&#123;</span><br><span class="line">            dp[i][i+<span class="number">1</span>] = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// k æ˜¯æ­¥é•¿ï¼Œk=1å³i+1å·²åˆå§‹åŒ–ï¼Œåˆ™ä»2å¼€å§‹</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> k=<span class="number">2</span>; k&lt;chars.length; k++)&#123;</span><br><span class="line">        <span class="keyword">int</span> j = k;</span><br><span class="line">        <span class="comment">// i jç»„æˆä¸€ä¸ªäºŒç»´æ•°ç»„(å³ä¸ŠåŠè§’çŸ©é˜µ)ï¼ŒæŒ‰ç…§æ–œçº¿å‘ä¸Šå¡«è¡¥çŸ©é˜µ</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;chars.length-k; i++)&#123;</span><br><span class="line">        <span class="comment">// kä»2å¼€å§‹çš„å¥½å¤„æ˜¯å½“i=0ï¼Œj=2æ—¶ï¼Œdp[i+1][j-1]çš„å€¼å·²è¢«åˆå§‹åŒ–</span></span><br><span class="line">            <span class="keyword">if</span> (chars[i] == chars[j] &amp;&amp; dp[i+<span class="number">1</span>][j-<span class="number">1</span>])&#123;</span><br><span class="line">                dp[i][j] = <span class="keyword">true</span>;</span><br><span class="line">                <span class="keyword">if</span> ((j - i + <span class="number">1</span>) &gt; longest)&#123;</span><br><span class="line">                    start = i;</span><br><span class="line">                    longest = j - i + <span class="number">1</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                dp[i][j] = <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;longest; i++)&#123;</span><br><span class="line">        stringBuffer.append(chars[start+i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stringBuffer.toString();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¶é—´å¤æ‚åº¦æ˜¯nçš„å¹³æ–¹ï¼Œç©ºé—´å¤æ‚åº¦ä¹Ÿæ˜¯nçš„å¹³æ–¹</p><p><em>è¿™ä¹Ÿæ˜¯ä¸ªäºŒç»´åŠ¨æ€è§„åˆ’ï¼Œè¿™ç§æƒ…å†µä¸‹æœ€å¥½ç”»å‡ºçŸ©é˜µå›¾ï¼Œç„¶åä»çŸ©é˜µä¸­å¯»æ‰¾dpæ•°ç»„çš„æ±‚è§£è§„å¾‹</em></p><h2 id="Manacherç®—æ³•"><a href="#Manacherç®—æ³•" class="headerlink" title="Manacherç®—æ³•"></a>Manacherç®—æ³•</h2><p>åœ¨æ€è€ƒçš„è¿‡ç¨‹ä¸­ï¼Œæˆ–è®¸å·²ç»æ³¨æ„åˆ°å›æ–‡çš„æ˜¯å¯¹ç§°çš„ï¼Œåˆ™å¯¹ç§°å°±æ¶‰åŠåˆ°<em>å¥‡å¶æ€§çš„å¯¹ç§°è½´</em>ï¼Œåˆ™æˆ‘ä»¬å¯ä»¥<em>æƒ³åŠæ³•å°†å­—ç¬¦ä¸²æ— è®ºå¥‡å¶ç»Ÿä¸€ä¸ºå¥‡æ•°æˆ–è€…å¶æ•°</em>ã€‚</p><p>æ–¹æ³•æ˜¯åœ¨å­—ç¬¦é¦–ä½å’Œä¹‹é—´æ·»åŠ ç‰¹æ®Šå­—ç¬¦(å³ä¸ä¼šåœ¨åŸå­—ç¬¦ä¸²ä¸­å‡ºç°çš„å­—ç¬¦)ï¼Œä½¿å­—ç¬¦ä¸²ç»Ÿä¸€å˜ä¸ºå¥‡æ•°ã€‚</p><p>å¦‚å­—ç¬¦ä¸²abaï¼Œæ·»åŠ #å­—ç¬¦å˜ä¸º#a#b#a#<br>å­—ç¬¦ä¸²abbaï¼Œæ·»åŠ #å­—ç¬¦å˜ä¸º#a#b#b#a#</p><p><em>æˆ‘ä»¬æŠŠä¸€ä¸ªå›æ–‡ä¸²ä¸­æœ€å·¦æˆ–æœ€å³ä½ç½®çš„å­—ç¬¦ä¸å…¶å¯¹ç§°è½´çš„è·ç¦»ç§°ä¸ºå›æ–‡åŠå¾„</em>ã€‚å¯¹äºå·²ç»é¢„å¤„ç†å¥½çš„å­—ç¬¦ä¸²æˆ‘ä»¬ç”¨æ•°ç»„rl[i]æ¥è®°å½•ä»¥å­—ç¬¦S[i]ä¸ºä¸­å¿ƒçš„æœ€é•¿å›æ–‡å­ä¸²å‘å·¦/å³æ‰©å¼ çš„é•¿åº¦(<strong>æ³¨æ„åŒ…æ‹¬S[i]</strong>)ã€‚æˆ‘ä»¬ä¸€èˆ¬å¯¹å­—ç¬¦ä¸²ä»å·¦å¾€å³å¤„ç†ï¼Œå› æ­¤è¿™é‡Œå®šä¹‰RL[i]ä¸ºç¬¬iä¸ªå­—ç¬¦ä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²çš„æœ€å³ä¸€ä¸ªå­—ç¬¦ä¸å­—ç¬¦içš„è·ç¦»ã€‚å¯¹äºä¸Šé¢æ’å…¥åˆ†éš”ç¬¦ä¹‹åçš„ä¸¤ä¸ªä¸²ï¼Œå¯ä»¥å¾—åˆ°RLæ•°ç»„ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">char</span>:    # a # b # a #</span><br><span class="line"> RL :    <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">RL-<span class="number">1</span>:    <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">3</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span></span><br><span class="line">  i :    <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">char</span>:    # a # b # b # a #</span><br><span class="line"> RL :    <span class="number">1</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">5</span> <span class="number">2</span> <span class="number">1</span> <span class="number">2</span> <span class="number">1</span></span><br><span class="line">RL-<span class="number">1</span>:    <span class="number">0</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">4</span> <span class="number">1</span> <span class="number">0</span> <span class="number">1</span> <span class="number">0</span></span><br><span class="line">  i :    <span class="number">0</span> <span class="number">1</span> <span class="number">2</span> <span class="number">3</span> <span class="number">4</span> <span class="number">5</span> <span class="number">6</span> <span class="number">7</span> <span class="number">8</span></span><br></pre></td></tr></table></figure><p>ä¸Šé¢æˆ‘ä»¬è¿˜æ±‚äº†ä¸€ä¸‹RL[i]-1ã€‚é€šè¿‡è§‚å¯Ÿå¯ä»¥å‘ç°ï¼ŒRL[i]-1çš„å€¼ï¼Œæ­£æ˜¯åœ¨åŸæœ¬é‚£ä¸ªæ²¡æœ‰æ’å…¥è¿‡åˆ†éš”ç¬¦çš„ä¸²ä¸­ï¼Œä»¥ä½ç½®char[i]ä¸ºå¯¹ç§°è½´çš„æœ€é•¿å›æ–‡ä¸²çš„é•¿åº¦ã€‚é‚£ä¹ˆåªè¦æˆ‘ä»¬æ±‚å‡ºäº†RLæ•°ç»„ï¼Œå°±èƒ½å¾—åˆ°æœ€é•¿å›æ–‡å­ä¸²çš„é•¿åº¦ã€‚</p><p><em>äºæ˜¯é—®é¢˜å˜æˆäº†ï¼Œæ€æ ·é«˜æ•ˆåœ°æ±‚çš„RLæ•°ç»„ã€‚åŸºæœ¬æ€è·¯æ˜¯åˆ©ç”¨å›æ–‡ä¸²çš„å¯¹ç§°æ€§ï¼Œæ‰©å±•å›æ–‡ä¸²ã€‚</em></p><p>æˆ‘ä»¬å†å¼•å…¥ä¸€ä¸ªè¾…åŠ©å˜é‡<em>MaxRightï¼Œè¡¨ç¤ºå½“å‰è®¿é—®åˆ°çš„æ‰€æœ‰å›æ–‡å­ä¸²ï¼Œæ‰€èƒ½è§¦åŠçš„æœ€å³ä¸€ä¸ªå­—ç¬¦çš„ä½ç½®</em>ã€‚å¦å¤–è¿˜è¦è®°å½•ä¸‹MaxRightå¯¹åº”çš„å›æ–‡ä¸²çš„å¯¹ç§°è½´æ‰€åœ¨çš„ä½ç½®ï¼Œè®°ä¸ºposï¼Œå®ƒä»¬çš„ä½ç½®å…³ç³»å¦‚ä¸‹ã€‚<br><img src="/blogimgs/LongestPalindromic/01.png"><br>æˆ‘ä»¬ä»å·¦å¾€å³åœ°è®¿é—®å­—ç¬¦ä¸²æ¥æ±‚RLï¼Œå‡è®¾å½“å‰è®¿é—®åˆ°çš„ä½ç½®ä¸ºiï¼Œå³è¦æ±‚RL[i]ï¼Œåœ¨å¯¹åº”ä¸Šå›¾ï¼Œiå¿…ç„¶æ˜¯åœ¨<code>pos</code>å³è¾¹çš„ã€‚ä½†æˆ‘ä»¬æ›´å…³æ³¨çš„æ˜¯ï¼Œ<em>iæ˜¯åœ¨MaxRightçš„å·¦è¾¹è¿˜æ˜¯å³è¾¹</em>ã€‚æˆ‘ä»¬åˆ†æƒ…å†µæ¥è®¨è®ºã€‚</p><p>1ã€iåœ¨MaxRightå·¦è¾¹<br>iåœ¨å·¦è¾¹å³åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œ</p><ul><li>ç¬¬ä¸€ç§æƒ…å†µç”¨å›¾è¡¨ç¤ºå¦‚ä¸‹<br><img src="/blogimgs/LongestPalindromic/02.png"></li></ul><p>æˆ‘ä»¬çŸ¥é“ï¼Œå›¾ä¸­ä¸¤ä¸ªçº¢è‰²å—ä¹‹é—´ï¼ˆåŒ…æ‹¬çº¢è‰²å—ï¼‰çš„ä¸²æ˜¯å›æ–‡ã€‚å¹¶ä¸”<em>ä»¥iä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²ï¼Œæ˜¯ä¸çº¢è‰²å—é—´çš„å›æ–‡ä¸²æœ‰æ‰€é‡å çš„</em>ã€‚æˆ‘ä»¬æ‰¾åˆ°iå…³äºposçš„å¯¹ç§°ä½ç½®jï¼Œè¿™ä¸ªjå¯¹åº”çš„RL[j]æˆ‘ä»¬æ˜¯å·²ç»ç®—è¿‡çš„ã€‚æ ¹æ®å›æ–‡ä¸²çš„å¯¹ç§°æ€§ï¼Œ<em>ä»¥iä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²å’Œä»¥jä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²ï¼Œæœ‰ä¸€éƒ¨åˆ†æ˜¯ç›¸åŒçš„</em>ã€‚è¿™é‡Œåˆæœ‰ä¸¤ç§ç»†åˆ†çš„æƒ…å†µã€‚</p><ul><li>ä»¥jä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²æ¯”è¾ƒçŸ­ï¼ŒçŸ­åˆ°åƒä¸‹å›¾è¿™æ ·(å³rl[j] &lt;= maxRigth - i)ã€‚<br><img src="/blogimgs/LongestPalindromic/03.png"><br>è¿™æ—¶æˆ‘ä»¬çŸ¥é“RL[i]è‡³å°‘ä¸ä¼šå°äºRL[j]ï¼Œå¹¶ä¸”å·²ç»çŸ¥é“äº†éƒ¨åˆ†çš„ä»¥iä¸ºä¸­å¿ƒçš„å›æ–‡ä¸²ï¼Œäºæ˜¯å¯ä»¥ä»¤RL[i]=RL[j]ã€‚ä½†æ˜¯ä»¥iä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²å¯èƒ½å®é™…ä¸Šæ›´é•¿ï¼Œå› æ­¤æˆ‘ä»¬è¯•ç€ä»¥iä¸ºå¯¹ç§°è½´ï¼Œç»§ç»­å¾€å·¦å³ä¸¤è¾¹æ‰©å±•ï¼Œç›´åˆ°å·¦å³ä¸¤è¾¹å­—ç¬¦ä¸åŒï¼Œæˆ–è€…åˆ°è¾¾è¾¹ç•Œã€‚<br>æˆ–è€…çœ‹è¿™ä¸ªå›¾<br><img src="/blogimgs/LongestPalindromic/031.png"><br>å½“mx â€“ i &gt;= rl[j], è¿™æ—¶å€™ä»¥S[j]ä¸ºä¸­å¿ƒçš„å›æ–‡å­ä¸²åŒ…å«åœ¨ä»¥S[id]ä¸ºä¸­å¿ƒçš„å›æ–‡å­ä¸²ä¸­ï¼Œç”±äºiå’Œjå¯¹ç§°ï¼Œä»¥S[i]ä¸ºä¸­å¿ƒçš„å›æ–‡å­ä¸²å¿…ç„¶åŒ…å«åœ¨ä»¥S[id]ä¸ºä¸­å¿ƒçš„å›æ–‡å­ä¸²ä¸­ï¼Œæ‰€ä»¥P[i]è‡³å°‘ç­‰äºp[j], åé¢çš„å†ç»§ç»­åŒ¹é…ã€‚</li></ul><blockquote><p>æ³¨ï¼šä¸Šå›¾ä¸­å…¶å®rl[i]ä¸€å®šç­‰äºrl[j],åé¢ä¸ç”¨å†åŒ¹é…äº†ã€‚å› ä¸ºå¦‚æœrl[i]åé¢è¿˜å¯ä»¥ç»§ç»­åŒ¹é…ï¼Œæ ¹æ®å¯¹ç§°æ€§ï¼Œrl[j]ä¹Ÿå¯ä»¥ç»§ç»­æ‰©å±•äº†</p></blockquote><ul><li>ä»¥jä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²å¾ˆé•¿ï¼Œåƒä¸‹å›¾(å³rl[j] &gt; maxRigth - i)ï¼š<br><img src="/blogimgs/LongestPalindromic/04.png"><br>è¿™æ—¶ï¼Œæˆ‘ä»¬åªèƒ½ç¡®å®šï¼Œä¸¤æ¡è“çº¿ä¹‹é—´çš„éƒ¨åˆ†ï¼ˆå³ä¸è¶…è¿‡MaxRightçš„éƒ¨åˆ†ï¼‰æ˜¯å›æ–‡çš„ï¼Œäºæ˜¯ä»è¿™ä¸ªé•¿åº¦å¼€å§‹ï¼Œå°è¯•ä»¥iä¸ºä¸­å¿ƒå‘å·¦å³ä¸¤è¾¹æ‰©å±•ï¼Œï¼Œç›´åˆ°å·¦å³ä¸¤è¾¹å­—ç¬¦ä¸åŒï¼Œæˆ–è€…åˆ°è¾¾è¾¹ç•Œã€‚<br>æˆ–è€…çœ‹è¿™ä¸ªå›¾<br><img src="/blogimgs/LongestPalindromic/041.png"><br>å½“mx â€“ i &lt; rl[j]ï¼Œä»¥S[j]ä¸ºä¸­å¿ƒçš„å›æ–‡å­ä¸²ä¸å®Œå…¨åŒ…å«äºä»¥S[id]ä¸ºä¸­å¿ƒçš„å›æ–‡å­ä¸²ä¸­ï¼Œä½†æ˜¯åŸºäºå¯¹ç§°æ€§å¯çŸ¥ï¼Œä¸Šå›¾ä¸­ä¸¤ä¸ªç»¿æ¡†æ‰€åŒ…å›´çš„éƒ¨åˆ†æ˜¯ç›¸åŒçš„ï¼Œä¹Ÿå°±æ˜¯è¯´ä»¥S[i]ä¸ºä¸­å¿ƒçš„å›æ–‡å­ä¸²ï¼Œå…¶å‘å³è‡³å°‘ä¼šæ‰©å¼ åˆ°mxçš„ä½ç½®ï¼Œä¹Ÿå°±æ˜¯è¯´rl[i] è‡³å°‘ç­‰äº mx - iï¼Œè‡³äºmxä¹‹åçš„éƒ¨åˆ†æ˜¯å¦å¯¹ç§°ï¼Œå°±åªèƒ½è€è€å®å®å»åŒ¹é…äº†ã€‚</li></ul><blockquote><p>å½“iåœ¨MaxRightå·¦è¾¹æ—¶ï¼Œä¸»è¦æ˜¯æ±‚chars[i]å‘å³æŸ¥æ‰¾å›æ–‡çš„åˆå§‹æ­¥é•¿æ˜¯å¤šå°‘ï¼Œ<em>å…¶å®å®Œå…¨å¯ä»¥æ— è®ºiè½åœ¨ä½•å¤„ï¼Œç›´æ¥å°†rl[i]åˆå§‹åŒ–ä¸º1ï¼Œç„¶åå‘å³æŸ¥æ‰¾ã€‚</em>è¿™æ ·åˆ†æƒ…å†µè®¨è®ºåªæ˜¯ä»¥å…é‡å¤è®¡ç®—ã€‚</p></blockquote><p>ä¸è®ºä»¥ä¸Šå“ªç§æƒ…å†µï¼Œä¹‹åéƒ½è¦å°è¯•æ›´æ–°MaxRightå’Œposï¼Œå› ä¸ºæœ‰å¯èƒ½å¾—åˆ°æ›´å¤§çš„MaxRightã€‚</p><p>å…·ä½“æ“ä½œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">step <span class="number">1</span>: ä»¤RL[i]=min(RL[<span class="number">2</span>*pos-i], MaxRight-i)</span><br><span class="line">step <span class="number">2</span>: ä»¥iä¸ºä¸­å¿ƒæ‰©å±•å›æ–‡ä¸²ï¼Œç›´åˆ°å·¦å³ä¸¤è¾¹å­—ç¬¦ä¸åŒï¼Œæˆ–è€…åˆ°è¾¾è¾¹ç•Œã€‚</span><br><span class="line">step <span class="number">3</span>: æ›´æ–°MaxRightå’Œpos</span><br></pre></td></tr></table></figure><p>2ã€å½“iåœ¨MaxRightçš„å³è¾¹<br><img src="/blogimgs/LongestPalindromic/05.png"><br>é‡åˆ°è¿™ç§æƒ…å†µï¼Œè¯´æ˜ä»¥iä¸ºå¯¹ç§°è½´çš„å›æ–‡ä¸²è¿˜æ²¡æœ‰ä»»ä½•ä¸€ä¸ªéƒ¨åˆ†è¢«è®¿é—®è¿‡ï¼Œäºæ˜¯åªèƒ½ä»içš„å·¦å³ä¸¤è¾¹å¼€å§‹å°è¯•æ‰©å±•äº†ï¼Œå½“å·¦å³ä¸¤è¾¹å­—ç¬¦ä¸åŒï¼Œæˆ–è€…åˆ°è¾¾å­—ç¬¦ä¸²è¾¹ç•Œæ—¶åœæ­¢ã€‚ç„¶åæ›´æ–°MaxRightå’Œposã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">proString</span><span class="params">(String s)</span></span>&#123;</span><br><span class="line">    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;s.length(); i++)&#123;</span><br><span class="line">        stringBuffer.append(<span class="string">&quot;#&quot;</span>).append(s.substring(i, i+<span class="number">1</span>));</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stringBuffer.append(<span class="string">&quot;#&quot;</span>).toString();</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">manacher</span><span class="params">(String s)</span></span>&#123;</span><br><span class="line">    String proStr = proString(s);</span><br><span class="line">    <span class="keyword">char</span>[] chars = proStr.toCharArray();</span><br><span class="line">    <span class="keyword">int</span>[] rl = <span class="keyword">new</span> <span class="keyword">int</span>[chars.length];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> pos = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> maxRight = <span class="number">0</span>;</span><br><span class="line">    rl[<span class="number">0</span>] = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;chars.length; i++)&#123;</span><br><span class="line">    <span class="comment">// åˆ†æƒ…å†µå¯¹rl[i]èµ‹åˆå§‹å€¼</span></span><br><span class="line">        <span class="keyword">if</span> (i &gt; maxRight)&#123;</span><br><span class="line">            rl[i] = <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 2*pos-1 æ˜¯ pos - (pos - i)</span></span><br><span class="line">            rl[i] = Math.min(rl[<span class="number">2</span> * pos - i], maxRight - i);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ((i - rl[i] &gt;= <span class="number">0</span>) &amp;&amp; (i + rl[i] &lt; chars.length) )&#123;</span><br><span class="line">            <span class="keyword">if</span> (chars[i+rl[i]] == chars[i-rl[i]])&#123;</span><br><span class="line">                <span class="keyword">if</span> (rl[i] &gt;= maxRight)&#123;</span><br><span class="line">                    maxRight = i + rl[i];</span><br><span class="line">                    pos = i;</span><br><span class="line">                &#125;</span><br><span class="line">                rl[i]++;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">int</span> longest = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">    <span class="comment">// ä»rlä¸­æ‰¾å‡ºæœ€å¤§çš„åŠå¾„</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;rl.length; i++)&#123;</span><br><span class="line">        <span class="keyword">if</span> (rl[i] &gt; longest )&#123;</span><br><span class="line">            longest = rl[i] - <span class="number">1</span>;</span><br><span class="line">            start = i;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    StringBuffer stringBuffer = <span class="keyword">new</span> StringBuffer();</span><br><span class="line">    <span class="comment">// ä»startä¸ºä¸­å¿ƒï¼Œåˆ†åˆ«å‘å·¦å‘å³æ‹¼å­—ç¬¦ä¸²</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=longest; i&gt;<span class="number">0</span>; i--)&#123;</span><br><span class="line">        stringBuffer.append(chars[start-i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;longest; i++)&#123;</span><br><span class="line">        stringBuffer.append(chars[start + i]);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> stringBuffer.toString().replace(<span class="string">&quot;#&quot;</span>,<span class="string">&quot;&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤ç®—æ³•ä¸­è§£å†³å¥‡å¶çš„æ–¹æ³•å€¼å¾—å€Ÿé‰´ã€‚</p><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://segmentfault.com/a/1190000003914228">æœ€é•¿å›æ–‡å­ä¸²â€”â€”Manacher ç®—æ³•</a><br><a href="http://www.cnblogs.com/TenosDoIt/p/3675788.html">LeetCode:Longest Palindromic Substring æœ€é•¿å›æ–‡å­ä¸²</a></p>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> leetcode </tag>
            
            <tag> Longest Palindromic </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Longest Substring</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Longest%20Substring.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Longest%20Substring.html</url>
      
        <content type="html"><![CDATA[<p>ç»™å®šä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ‰¾åˆ°æ²¡æœ‰é‡å¤å­—ç¬¦çš„æœ€é•¿å­ä¸²çš„é•¿åº¦ã€‚</p><p>ä¾‹å¦‚:<br>å­—ç¬¦ä¸²â€abcabcbbâ€, æœ€é•¿éé‡å¤å­ä¸²é•¿åº¦æ˜¯3(â€œabcâ€).<br>å­—ç¬¦ä¸²â€pwwkewâ€, æœ€é•¿éé‡å¤å­ä¸²é•¿åº¦æ˜¯3(â€œwkeâ€).</p><h2 id="æš´åŠ›æ±‚è§£"><a href="#æš´åŠ›æ±‚è§£" class="headerlink" title="æš´åŠ›æ±‚è§£"></a>æš´åŠ›æ±‚è§£</h2><p>ç®€å•ç²—æš´çš„æ–¹æ³•å°±æ˜¯æ‰¾åˆ°ä»¥å­—æ¯iå¼€å¤´çš„éé‡å¤å­ä¸²ï¼Œæ¯”è¾ƒå…¶é•¿åº¦ï¼Œæ‰¾åˆ°æœ€å¤§çš„å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><span id="more"></span><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        Map&lt;Character, Integer&gt; hashmap = <span class="keyword">new</span> HashMap&lt;Character, Integer&gt;();</span><br><span class="line">        <span class="keyword">char</span>[] charArr = s.toCharArray();</span><br><span class="line">        <span class="keyword">int</span> lengthest = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;charArr.length; i++)&#123;</span><br><span class="line">            hashmap.put(charArr[i],<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">int</span> length = <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j=i+<span class="number">1</span>; j&lt;charArr.length; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (hashmap.containsKey(charArr[j]))&#123;</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                hashmap.put(charArr[j], <span class="number">1</span>);</span><br><span class="line">                length++;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; lengthest)&#123;</span><br><span class="line">                lengthest = length;</span><br><span class="line">            &#125;</span><br><span class="line">            hashmap.clear();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lengthest;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»¥iä¸ºå‰ç¼€ï¼Œç„¶åéå†i+1ï¼Œç”¨HashMapå­˜æ”¾éå†è¿‡çš„å­—ç¬¦ã€‚</p><h2 id="æŒ‡é’ˆ"><a href="#æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆ"></a>æŒ‡é’ˆ</h2><p>é€šè¿‡ä¸¤ä¸ªæŒ‡é’ˆstartå’Œendæ¥æ ‡è¯†ä¸€ä¸ªéé‡å¤çš„å­ä¸²subï¼Œç„¶åéå†å­—ç¬¦ä¸²ä¸­çš„æ¯ä¸ªå­—ç¬¦ï¼Œåˆ¤æ–­æ˜¯å¦åœ¨subä¸­æœ‰é‡å¤ï¼Œæ²¡æœ‰åˆ™é€šè¿‡ç§»åŠ¨endæŒ‡é’ˆï¼Œå°†å½“å‰å­—ç¬¦åŠ å…¥subä¸­ï¼Œæœ‰é‡å¤çš„åˆ™é€šè¿‡ç§»åŠ¨startæŒ‡é’ˆå¯¹subçš„èµ·å§‹ä½ç½®è¿›è¡Œé‡æ–°æ ‡è¯†(<em>å¯ä»¥ä¸€ä¸ªå­—ç¬¦ä¸€ä¸ªå­—ç¬¦çš„ç§»åŠ¨ï¼Œä¹Ÿå¯ä»¥ç›´æ¥ç§»åŠ¨åˆ°subä¸­å‘ç”Ÿé‡å¤å­—ç¬¦çš„ä¸‹ä¸€ä¸ªä½ç½®</em>)ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lengthest = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span>[] charArr = s.toCharArray();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> end = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> length = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">1</span>; i&lt;charArr.length; i++)&#123;</span><br><span class="line">        <span class="comment">// éå†å½“å‰å­—ç¬¦ä¹‹å‰çš„å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="comment">// è®°å½•å½“å‰å­ä¸²çš„èµ·å§‹ä½ç½®start</span></span><br><span class="line">        <span class="comment">// å½“å‰å­ä¸²çš„ç»“æŸä½ç½®æ˜¯æ­£åœ¨éå†çš„ç¬¬iä¸ªå­—ç¬¦çš„å‰ä¸€ä¸ªä½ç½®</span></span><br><span class="line">            end = i - <span class="number">1</span>;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j=start; j&lt;i; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span> (charArr[i] == charArr[j])&#123;</span><br><span class="line">                    length = end - start + <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (length &gt; lengthest)&#123;</span><br><span class="line">                        lengthest = length;</span><br><span class="line">                    &#125;</span><br><span class="line">                    start = j + <span class="number">1</span>;</span><br><span class="line">                    length = <span class="number">0</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// è®¡ç®—æœ€åä¸€ç»„å­ä¸²çš„é•¿åº¦</span></span><br><span class="line">        <span class="comment">// æœ€åä¸€ä¸ªå­—ç¬¦å¯èƒ½å’Œå½“å‰å­ä¸²ç»„æˆä¸€ä¸ªæ–°çš„éé‡å¤å­ä¸²</span></span><br><span class="line">        <span class="comment">// ä¹Ÿå¯èƒ½ç‹¬è‡ªç»„æˆä¸€ä¸ªéé‡å¤çš„å­ä¸²</span></span><br><span class="line">        length = charArr.length-<span class="number">1</span> - start + <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">if</span> (length &gt; lengthest)&#123;</span><br><span class="line">            lengthest = length;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lengthest;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ—¶é—´å¤æ‚åº¦æ˜¯nçš„å¹³æ–¹ï¼Œä½†æ˜¯ç©ºé—´å¤æ‚åº¦æ˜¯0ï¼Œåˆ™æ˜¯å¦å¯ä»¥é€šè¿‡å¢åŠ ç©ºé—´å¤æ‚åº¦æ¥å‡å°‘æ—¶é—´å¤æ‚åº¦ã€‚ä»ä»£ç ä¸­å¯ä»¥çœ‹åˆ°ï¼Œ<em>ç¬¬äºŒä¸ªforå¾ªç¯ä¸»è¦å°±æ˜¯ä»å½“å‰å­ä¸²ä¸­æŸ¥æ‰¾æ˜¯å¦æœ‰é‡å¤çš„å­—ç¬¦å¹¶æ‰¾åˆ°è¯¥å­—ç¬¦çš„ç´¢å¼•</em>ï¼Œè¿™æ˜æ˜¾æ˜¯ä¸€ä¸ªkey/valueçš„ç»“æ„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨mapï¼Œé€šè¿‡O(1)çš„æ—¶é—´å¤æ‚åº¦æ¥æ‰¾åˆ°é‡å¤çš„å­—ç¬¦å¯¹åº”çš„ç´¢å¼•ã€‚</p><p>è¿™ç§å¹³æ»‘æŒ‡é’ˆçš„æ–¹æ³•ä¹Ÿå«<em>å¹³æ»‘çª—å£</em>ï¼Œå¹³æ»‘çª—å£æ˜¯ä¸€ä¸ªæŠ½è±¡çš„æ¦‚å¿µï¼Œé€šå¸¸ç”¨äºè§£å†³æ•°ç»„å’Œå­—ç¬¦ä¸²çš„é—®é¢˜ã€‚<br>ä¸‹é¢çœ‹ä¸‹ä¼˜åŒ–åçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lengthest = <span class="number">0</span>;</span><br><span class="line">        Map&lt;Character, Integer&gt; map = <span class="keyword">new</span> HashMap&lt;Character, Integer&gt;();</span><br><span class="line">        <span class="keyword">char</span>[] chars = src.toCharArray();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> start=<span class="number">0</span>,end=<span class="number">0</span>; end&lt;chars.length; end++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (map.containsKey(chars[end]))&#123;</span><br><span class="line">            <span class="comment">// å‡ºç°é‡å¤çš„ï¼Œåˆ™ç›´æ¥å°†é‡å¤å­—ç¬¦çš„ä¸‹ä¸€ä½èµ‹å€¼ç»™start</span></span><br><span class="line">            <span class="comment">// æŸ¥æ‰¾é‡å¤å­—ç¬¦æ˜¯åœ¨startä¹‹åï¼Œåˆ™å°†é‡å¤å­—ç¬¦çš„ç´¢å¼•ä¸startè¿›è¡Œæ¯”è¾ƒï¼Œ</span></span><br><span class="line">            <span class="comment">// å–è¾ƒå¤§çš„å¯¹startè¿›è¡Œèµ‹å€¼</span></span><br><span class="line">                start = Math.max(map.get(chars[end]), start);</span><br><span class="line">            &#125;</span><br><span class="line">            lengthest = Math.max(lengthest, end - start + <span class="number">1</span>);</span><br><span class="line">            <span class="comment">// ç›´æ¥å°†endå¤„å­—ç¬¦çš„ä¸‹ä¸€ä½ç´¢å¼•è¿›è¡Œèµ‹å€¼</span></span><br><span class="line">            map.put(chars[end], end + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lengthest;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åŠ¨æ€è§„åˆ’"><a href="#åŠ¨æ€è§„åˆ’" class="headerlink" title="åŠ¨æ€è§„åˆ’"></a>åŠ¨æ€è§„åˆ’</h2><p>è¿˜æœ‰ä¸€ç§æ€è·¯æ˜¯åŠ¨æ€è§„åˆ’ï¼Œè¿™ä¹Ÿæ˜¯æœ€ä¼˜çš„ä¸€ç§ã€‚<br>åŠ¨æ€è§„åˆ’å¾€å¾€ç”¨äºæ±‚è§£æœ€ä¼˜è§£(æœ€å¤§å€¼ã€æœ€çŸ­è·¯å¾„ã€æœ€é•¿å…¬å…±å­åºåˆ—)é—®é¢˜ã€‚</p><h3 id="åŠ¨æ€è§„åˆ’ç®€ä»‹"><a href="#åŠ¨æ€è§„åˆ’ç®€ä»‹" class="headerlink" title="åŠ¨æ€è§„åˆ’ç®€ä»‹"></a>åŠ¨æ€è§„åˆ’ç®€ä»‹</h3><p>åŠ¨æ€è§„åˆ’çš„åŸºæœ¬æ€æƒ³ä¸åˆ†æ²»æ³•ç±»ä¼¼ï¼Œä¹Ÿæ˜¯å°†<em>å¾…æ±‚è§£çš„é—®é¢˜åˆ†è§£ä¸ºè‹¥å¹²ä¸ªå­é—®é¢˜(é˜¶æ®µ)<em>ã€‚æŒ‰é¡ºåºæ±‚è§£å­é˜¶æ®µï¼Œ</em>å‰ä¸€å­é—®é¢˜çš„è§£ï¼Œä¸ºåä¸€å­é—®é¢˜çš„æ±‚è§£æä¾›äº†æœ‰ç”¨çš„ä¿¡æ¯</em>ã€‚åœ¨<strong>æ±‚è§£ä»»ä¸€å­é—®é¢˜æ—¶ï¼Œåˆ—å‡ºå„ç§å¯èƒ½çš„å±€éƒ¨è§£ï¼Œé€šè¿‡å†³ç­–ä¿ç•™é‚£äº›æœ‰å¯èƒ½è¾¾åˆ°æœ€ä¼˜çš„å±€éƒ¨è§£ï¼Œä¸¢å¼ƒå…¶ä»–å±€éƒ¨è§£()æœ€ä¼˜è§£</strong>ã€‚ä¾æ¬¡è§£å†³å„å­é—®é¢˜ï¼Œæœ€åä¸€ä¸ªå­é—®é¢˜å°±æ˜¯åˆå§‹é—®é¢˜çš„è§£ã€‚</p><p>åŠ¨æ€è§„åˆ’æ˜¯é€šè¿‡<em>æ‹†åˆ†é—®é¢˜</em>ï¼Œå®šä¹‰<em>é—®é¢˜çŠ¶æ€å’ŒçŠ¶æ€ä¹‹é—´çš„å…³ç³»</em>ï¼Œä½¿å¾—é—®é¢˜èƒ½å¤Ÿä»¥<em>é€’æ¨</em>(æˆ–è€…è¯´åˆ†æ²»)çš„æ–¹å¼å»è§£å†³ã€‚åˆ™<em>åŠ¨æ€è§„åˆ’çš„æœ¬è´¨</em>æ˜¯<strong>çŠ¶æ€çš„å®šä¹‰</strong>å’Œ<strong>çŠ¶æ€è½¬ç§»æ–¹ç¨‹</strong></p><p>åŠ¨æ€è§„åˆ’é€šè¿‡æ‹†åˆ†é—®é¢˜ï¼Œå°†åŸå§‹é—®é¢˜æ‹†åˆ†ä¸ºå­é—®é¢˜ï¼Œè€Œå„å­é—®é¢˜ä¹‹é—´çš„å…³ç³»æ˜¯<em>åä¸€å­é—®é¢˜çš„è§£å¾€å¾€åˆå‰ä¸€å­é—®é¢˜çš„è§£æ±‚å‡º</em>ï¼Œåˆ™**å­é—®é¢˜ä¹‹é—´æ˜¯é‡å çš„(åˆ™ä¸æ˜¯ç›¸äº’ç‹¬ç«‹çš„)**ï¼Œä¸ºå‡å°‘é‡å¤è®¡ç®—ï¼Œå¯¹æ¯ä¸€ä¸ªå­é—®é¢˜åªè§£ä¸€æ¬¡ï¼Œå°†å…¶ä¸åŒé˜¶æ®µçš„ä¸åŒçŠ¶æ€ä¿å­˜åœ¨ä¸€ä¸ªäºŒç»´æ•°ç»„ä¸­ã€‚</p><p>åŠ¨æ€è§„åˆ’ä¸åˆ†æ²»æ³•<em>æœ€å¤§çš„å·®åˆ«</em>æ˜¯:é€‚åˆäºç”¨åŠ¨æ€è§„åˆ’æ³•æ±‚è§£çš„é—®é¢˜ï¼Œç»åˆ†è§£åå¾—åˆ°çš„å­é—®é¢˜å¾€å¾€<em>ä¸æ˜¯äº’ç›¸ç‹¬ç«‹</em>çš„ï¼ˆå³ä¸‹ä¸€ä¸ªå­é˜¶æ®µçš„æ±‚è§£æ˜¯å»ºç«‹åœ¨ä¸Šä¸€ä¸ªå­é˜¶æ®µçš„è§£çš„åŸºç¡€ä¸Šï¼Œè¿›è¡Œè¿›ä¸€æ­¥çš„æ±‚è§£ï¼‰ã€‚</p><h3 id="é€‚ç”¨æ¡ä»¶"><a href="#é€‚ç”¨æ¡ä»¶" class="headerlink" title="é€‚ç”¨æ¡ä»¶"></a>é€‚ç”¨æ¡ä»¶</h3><p>èƒ½é‡‡ç”¨åŠ¨æ€è§„åˆ’æ±‚è§£çš„é—®é¢˜çš„ä¸€èˆ¬è¦å…·æœ‰3ä¸ªæ€§è´¨ï¼š<br>(1) <strong>æœ€ä¼˜åŒ–åŸç†</strong>ï¼šå¦‚æœé—®é¢˜çš„æœ€ä¼˜è§£æ‰€åŒ…å«çš„å­é—®é¢˜çš„è§£ä¹Ÿæ˜¯æœ€ä¼˜çš„ï¼Œå°±ç§°è¯¥é—®é¢˜å…·æœ‰æœ€ä¼˜å­ç»“æ„ï¼Œå³æ»¡è¶³æœ€ä¼˜åŒ–åŸç†ã€‚<br>(2) <strong>æ— åæ•ˆæ€§</strong>ï¼šå³æŸé˜¶æ®µçŠ¶æ€ä¸€æ—¦ç¡®å®šï¼Œå°±ä¸å—è¿™ä¸ªçŠ¶æ€ä»¥åå†³ç­–çš„å½±å“ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒæŸçŠ¶æ€ä»¥åçš„è¿‡ç¨‹ä¸ä¼šå½±å“ä»¥å‰çš„çŠ¶æ€ï¼Œåªä¸å½“å‰çŠ¶æ€æœ‰å…³ã€‚<br>(3) <strong>æœ‰é‡å å­é—®é¢˜</strong>ï¼šå³å­é—®é¢˜ä¹‹é—´æ˜¯<em>ä¸ç‹¬ç«‹</em>çš„ï¼Œä¸€ä¸ªå­é—®é¢˜åœ¨ä¸‹ä¸€é˜¶æ®µå†³ç­–ä¸­å¯èƒ½è¢«å¤šæ¬¡ä½¿ç”¨åˆ°ã€‚ï¼ˆè¯¥æ€§è´¨å¹¶ä¸æ˜¯åŠ¨æ€è§„åˆ’é€‚ç”¨çš„å¿…è¦æ¡ä»¶ï¼Œä½†æ˜¯å¦‚æœæ²¡æœ‰è¿™æ¡æ€§è´¨ï¼ŒåŠ¨æ€è§„åˆ’ç®—æ³•åŒå…¶ä»–ç®—æ³•ç›¸æ¯”å°±ä¸å…·å¤‡ä¼˜åŠ¿ï¼‰</p><p>ä¸‹é¢æ¥çœ‹ä¸‹ç”¨åŠ¨æ€è§„çŸ©è§£å†³æ­¤é—®é¢˜çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">lengthOfLongestSubstring</span><span class="params">(String s)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> lengthest = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">char</span>[] chars = src.toCharArray();</span><br><span class="line">        <span class="comment">// çŠ¶æ€æ•°ç»„</span></span><br><span class="line">        <span class="keyword">int</span>[] dp_status = <span class="keyword">new</span> <span class="keyword">int</span>[chars.length];</span><br><span class="line">        Map&lt;Character, Integer&gt; hashMap = <span class="keyword">new</span> HashMap&lt;Character, Integer&gt;();</span><br><span class="line">        <span class="keyword">int</span> start = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;chars.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span> (hashMap.containsKey(chars[i]))&#123;</span><br><span class="line">                start = Math.max(start, hashMap.get(chars[i]));</span><br><span class="line">                dp_status[i] = i - start + <span class="number">1</span>;</span><br><span class="line">                hashMap.put(chars[i], i+<span class="number">1</span>);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            hashMap.put(chars[i], i+<span class="number">1</span>);</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>)&#123;</span><br><span class="line">                dp_status[i] = <span class="number">1</span>;</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            dp_status[i] = dp_status[i-<span class="number">1</span>] + <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> length : dp_status)&#123;</span><br><span class="line">            <span class="keyword">if</span> (length &gt; lengthest)&#123;</span><br><span class="line">                lengthest = length;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> lengthest;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡åœ¨leetcodeä¸Šæäº¤ä»£ç å‘ç°ï¼Œ<em>ä½¿ç”¨HashMapæ¥æŸ¥è¯¢é‡å¤å­—ç¬¦çš„æ–¹æ³•è²Œä¼¼æ²¡æœ‰ç›´æ¥ç”¨forå¾ªç¯é€ä¸ªå­—ç¬¦åŒ¹é…æ‰§è¡Œçš„å¿«</em>ã€‚</p><h2 id="é™„åŠ ï¼šé€’å½’ä¸é€’æ¨"><a href="#é™„åŠ ï¼šé€’å½’ä¸é€’æ¨" class="headerlink" title="é™„åŠ ï¼šé€’å½’ä¸é€’æ¨"></a>é™„åŠ ï¼šé€’å½’ä¸é€’æ¨</h2><p>é€’å½’æ˜¯ä¸€ä¸ªç¨‹åºè°ƒç”¨è‡ªèº«<br>é€’æ¨å°±æ˜¯è¿­ä»£</p>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> leetcode </tag>
            
            <tag> Longest Substring </tag>
            
            <tag> Without Repeating Characters </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Median of two arrays</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Median%20of%20two%20arrays.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Median%20of%20two%20arrays.html</url>
      
        <content type="html"><![CDATA[<p>ä¸¤ä¸ªæ’å¥½åºçš„æ•°ç»„nums1å’Œnums2ï¼Œé•¿åº¦åˆ†åˆ«ä¸ºmå’Œnã€‚æ‰¾åˆ°è¿™ä¸¤ä¸ªæ•°ç»„çš„ä¸­ä½æ•°ï¼Œå¦‚æœæ˜¯å¶æ•°ï¼Œåˆ™ä¸­ä½æ•°æ˜¯ä¸Šä¸‹ä¸­ä½æ•°çš„å¹³å‡å€¼ã€‚</p><p>Example 1:</p><blockquote><p>nums1 = [1, 3]<br>nums2 = [2]<br>The median is 2.0</p></blockquote><p>Example 2:</p><blockquote><p>nums1 = [1, 2]<br>nums2 = [3, 4]<br>The median is (2 + 3)/2 = 2.5</p></blockquote><h2 id="æš´åŠ›æ±‚è§£"><a href="#æš´åŠ›æ±‚è§£" class="headerlink" title="æš´åŠ›æ±‚è§£"></a>æš´åŠ›æ±‚è§£</h2><p>æŒ‰ç…§æƒ¯ä¾‹å…ˆæ¥ä¸ªæœ€ç®€å•ä¹Ÿæœ€ç²—æš´çš„æ–¹æ³•ï¼Œå°†ä¸¤ä¸ªæ•°ç»„åˆå¹¶ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œç„¶åæ ¹æ®æ•°ç»„çš„ç´¢å¼•æ‰¾åˆ°ä¸­ä½æ•°ã€‚</p><span id="more"></span><p>ç”±äºä¸¤ä¸ªæ•°ç»„éƒ½æ˜¯æ’å¥½åºçš„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ä¸¤ä¸ªæŒ‡é’ˆè¿›è¡Œä¸€è¾¹æ¯”è¾ƒå…ƒç´ çš„å¤§å°ä¸€è¾¹æ”¾å…¥ç¬¬ä¸‰ä¸ªæ•°ç»„ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(<span class="keyword">int</span>[] nums1, <span class="keyword">int</span>[] nums2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span>[] num3 = <span class="keyword">new</span> <span class="keyword">int</span>[nums1.length+nums2.length];</span><br><span class="line">        <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> j = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> index = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">double</span> median = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span> (i&lt;nums1.length &amp;&amp; j&lt;nums2.length)&#123;</span><br><span class="line">            <span class="keyword">if</span> (nums1[i] &lt; nums2[j])&#123;</span><br><span class="line">                num3[index++] = nums1[i];</span><br><span class="line">                i++;</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                num3[index++] = nums2[j];</span><br><span class="line">                j++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (i &lt; nums1.length)&#123;</span><br><span class="line">            num3[index++] = nums1[i];</span><br><span class="line">            i++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> (j &lt; nums2.length)&#123;</span><br><span class="line">            num3[index++] = nums2[j];</span><br><span class="line">            j++;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (num3.length%<span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            median = (num3[num3.length/<span class="number">2</span>] + num3[num3.length/<span class="number">2</span> - <span class="number">1</span>]) / <span class="number">2.0</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            median = num3[num3.length/<span class="number">2</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> median;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="åˆ©ç”¨æŠ˜åŠæŸ¥æ‰¾çš„æ€æƒ³"><a href="#åˆ©ç”¨æŠ˜åŠæŸ¥æ‰¾çš„æ€æƒ³" class="headerlink" title="åˆ©ç”¨æŠ˜åŠæŸ¥æ‰¾çš„æ€æƒ³"></a>åˆ©ç”¨æŠ˜åŠæŸ¥æ‰¾çš„æ€æƒ³</h2><p>åœ¨è¿›è¡Œæ€è·¯è§£è¯»å‰ï¼Œå…ˆä»‹ç»ä¸¤ä¸ªæ¦‚å¿µï¼Œ</p><ul><li>æ¦‚å¿µ1ï¼šæŸä¸ªæ•°ç»„ä¸­æœ‰ä¸€åŠçš„å…ƒç´ ä¸è¶…è¿‡æ•°ç»„çš„ä¸­ä½æ•°ï¼Œæœ‰ä¸€åŠçš„å…ƒç´ ä¸å°äºä¸­ä½æ•°ï¼ˆå¦‚æœæ•°ç»„ä¸­å…ƒç´ ä¸ªæ•°æ˜¯å¶æ•°ï¼Œé‚£ä¹ˆè¿™é‡Œçš„ä¸€åŠå¹¶ä¸æ˜¯ä¸¥æ ¼æ„ä¹‰çš„1/2ï¼‰</li><li>æ¦‚å¿µ2ï¼šå¦‚æœæˆ‘ä»¬å»æ‰æ•°ç»„æ¯”ä¸­ä½æ•°å°çš„kä¸ªæ•°ï¼Œå†å»æ‰æ¯”ä¸­ä½æ•°å¤§çš„kä¸ªæ•°ï¼Œå¾—åˆ°çš„å­æ•°ç»„çš„ä¸­ä½æ•°å’ŒåŸæ¥çš„ä¸­ä½æ•°ç›¸åŒ</li></ul><h3 id="å¼¯è·¯"><a href="#å¼¯è·¯" class="headerlink" title="å¼¯è·¯"></a>å¼¯è·¯</h3><p>æŠ˜åŠçš„æ€è·¯æ˜¯nums1çš„ä¸­ä½æ•°med1å’Œnums2çš„ä¸­ä½æ•°med2åšæ¯”è¾ƒ(<em>å¦‚æœæ•°ç»„æ˜¯å¶æ•°ï¼Œåˆ™ä¸­ä½æ•°æ˜¯ä¸Šä¸­ä½æ•°å’Œä¸‹ä¸­ä½æ•°ä¹‹å’Œçš„å¹³å‡å€¼</em>)ï¼Œæœ‰3ä¸­æ¯”è¾ƒç»“æœï¼š<br>1ã€med1 == med2 åˆ™med1å°±æ˜¯ä¸¤ä¸ªæ•°ç»„çš„ä¸­ä½æ•°<br>2ã€med1 &lt; med2 åˆ™ä¸­ä½æ•°åªå¯èƒ½å‡ºç°åœ¨nums1[nums1.length/2 - 1]<del>nums[nums1.length]å’Œnums2[0]</del>nums2[nums2.length - nums1.length/2 - 1]ä¸­ã€‚<br>3ã€med1 &gt; med2 åˆ™ä¸­ä½æ•°åªå¯èƒ½å‡ºç°åœ¨nums1[0]<del>nums1[nums1.length/2]å’Œnums2[nums2.length-nums1.length/2]</del>nums2[nums2.length]åŒºé—´ä¸­ã€‚</p><blockquote><p>è¿™é‡Œå‡è®¾nums1çš„é•¿åº¦å°äºç­‰äºnums2.lengthï¼Œç”±ä¸Šé¢çš„æ¦‚å¿µ2å¾—çŸ¥ï¼Œæ¯æ¬¡å‡å»çš„ä¸ªæ•°åº”è¯¥æ˜¯ä¸¤ä¸ªæ•°ç»„æŠ˜åŠçš„è¾ƒå°å€¼ã€‚</p></blockquote><p>æŒ‰ç…§è¿™ä¸ªæ€è·¯å»æ•²ä»£ç ï¼Œå‘ç°ä»£ç å°¼ç›è¶Šå†™è¶Šé•¿ï¼Œè€ƒè™‘çš„æƒ…å†µè¶Šæ¥è¶Šå¤šï¼Œå¦‚ä¸¤ä¸ªæ•°ç»„ä¸€ä¸ªæ˜¯å¥‡æ•°ä¸€ä¸ªæ˜¯å¶æ•°ï¼›ä¸€ä¸ªæ•°ç»„åªæœ‰ä¸¤ä¸ªå…ƒç´ å¹¶ä¸”å¦ä¸€ä¸ªæ•°ç»„åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œæˆ–è€…å¦ä¸€ä¸ªæ•°ç»„æ˜¯å¤šä¸ªå…ƒç´ (å¥‡å¶ä¹Ÿä¸å®š)ï¼Œå„ç§æƒ…å†µä¸­ä½æ•°éƒ½ä¸ä¸€æ ·ï¼Œ(<em>ç½‘ä¸Šæœ‰å¾ˆå¤šå¸–å­æ˜¯ç”¨ä¸Šé¢çš„æ€è·¯è§£å†³çš„ï¼Œé‚£æ˜¯å› ä¸ºä»–ä»¬é‡åˆ°å¶æ•°çš„æƒ…å†µå–çš„ä¸­ä½æ•°æ˜¯ä¸Šä¸­ä½æ•°æˆ–è€…ä¸‹ä¸­ä½æ•°ï¼Œè€Œæœ¬é¢˜ä¸­å´è¦ä¸Šä¸‹ä¸­ä½æ•°çš„å¹³å‡å€¼ï¼Œè¿™å°±è¦æ±‚éœ€è¦ä¿ç•™å¹¶ä¸”å»æ¯”è¾ƒä¸Šä¸‹ä¸­ä½æ•°ï¼Œ__å› ä¸ºè¿™ä¸¤ä¸ªæ•°å­—å¯èƒ½æ¥è‡ªäºåŒä¸€ä¸ªæ•°ç»„ï¼Œä¹Ÿå¯èƒ½æ¥è‡ªä¸¤ä¸ªæ•°ç»„__è¿™ç§æƒ…å†µå°±æ¯”è¾ƒç¹çï¼Œå¾ˆå®¹æ˜“æ¼æ‰æŸç§æƒ…å†µ</em>)ã€‚æ’¸åˆ°åŠå¤œéƒ½æ²¡æœ‰æå®šï¼Œæ„Ÿè§‰å¯èƒ½ä¸æ˜¯è¿™ä¹ˆå›äº‹ï¼Œè¿˜æ˜¯googleä¸‹å§ã€‚</p><h3 id="æ‰©å±•é—®é¢˜è‡³æŸ¥æ‰¾ç¬¬kä¸ªå…ƒç´ "><a href="#æ‰©å±•é—®é¢˜è‡³æŸ¥æ‰¾ç¬¬kä¸ªå…ƒç´ " class="headerlink" title="æ‰©å±•é—®é¢˜è‡³æŸ¥æ‰¾ç¬¬kä¸ªå…ƒç´ "></a>æ‰©å±•é—®é¢˜è‡³æŸ¥æ‰¾ç¬¬kä¸ªå…ƒç´ </h3><p>ç”±äºæŒ‰ç…§ä¸Šé¢çš„æ€è·¯æ’¸äº†ä¸¤ç™¾å¤šè¡Œä»£ç éƒ½æ²¡æœ‰æå®šï¼Œæ„Ÿè§‰å¿…æœ‰è¹Šè··ï¼Œç„¶ågoogleä¸‹ï¼Œå‘ç°æœ‰åŒå‘½ç›¸è¿è€…ï¼Œè§‚å…¶æ€è·¯çš„æ ¸å¿ƒæ€æƒ³ä¸º<br><em>å°†å…¶è½¬åŒ–ä¸ºå»æ‰¾ä¸¤ä¸ªæ•°ç»„çš„ä»å°åˆ°å¤§æ’çš„ç¬¬kä¸ªæ•°</em>ã€‚<strong>ä¸¤ä¸ªæ•°ç»„å…±æœ‰m+nä¸ªæ•°ï¼Œè‹¥m+næ˜¯å¥‡æ•°ï¼Œé‚£ä¹ˆå°±æ˜¯æ‰¾ç¬¬(m+n)/2+1ä¸ªæ•°ï¼Œå¶æ•°çš„è¯å°±æ˜¯æ‰¾ç¬¬(m+n)/2ä¸ªæ•°å’Œç¬¬(m+n)/2+1ä¸ªæ•°çš„å¹³å‡æ•°</strong>ã€‚è½¬æ¢æˆæ‰¾ç¬¬kä¸ªå…ƒç´ ä¹‹åï¼Œåœ¨äºŒåˆ†æŸ¥æ‰¾æ—¶å°±é¿å¼€äº†å¥‡æ•°å¶æ•°æƒ…å†µä¸åŒçš„é—®é¢˜ï¼Œåªç®¡å»ç¬¬kä¸ªå…ƒç´ ã€‚</p><p>å…·ä½“æ€è·¯å¦‚ä¸‹ï¼š<br>å‡è®¾è¦åœ¨æ•°ç»„Aå’Œæ•°ç»„Bä¸­æŸ¥æ‰¾ç¬¬kä¸ªæ•°(<em>å‡è®¾Açš„é•¿åº¦mä¸å¤§äºBçš„é•¿åº¦nï¼Œè¿™é‡Œkä¸€å®šä¸å¤§äºm+n</em>)ã€‚ä¹Ÿå°±æ˜¯æ‰¾Aå’ŒBçš„ç¬¬kä¸ªæ•°ã€‚(<strong>å¾ˆæ˜¾ç„¶ï¼Œæ•°åˆ—â€œå‰xä¸ªæ•°ä¸­çš„æœ€åä¸€ä¸ªæ•°â€å°±æ˜¯æ•°åˆ—çš„â€œç¬¬xä¸ªæ•°â€ã€‚æ‰€ä»¥æ‰¾ç¬¬xä¸ªæ•°å’Œæ‰¾å‰xä¸ªæ•°æ˜¯ä¸€æ ·çš„ã€‚å› ä¸ºä¸€ä½†ç¡®å®šäº†å‰xä¸ªæ•°ï¼Œè¿™äº›æ•°çš„æœ€åä¸€ä¸ªæ•°å°±æ˜¯ç¬¬xä¸ªæ•°</strong>)ã€‚</p><p><em>å…ˆå‡å®šæœ€ç»ˆçš„å‰kä¸ªæ•°ä¸­æœ‰ä¸€åŠ(k/2)åœ¨Aä¸­ï¼Œå¦ä¸€åŠ(k-k/2)åœ¨Bä¸­ã€‚å½“ç„¶ï¼Œå¦‚æœAä¸­æ€»ä¸ªæ•°må°‘äºk/2ï¼Œåªå¥½å‡å®šæœ€ç»ˆçš„å‰kä¸ªæ•°ä¸­æœ‰mä¸ªåœ¨Aä¸­ï¼Œå¦å¤–k-mä¸ªåœ¨Bä¸­ã€‚</em></p><p><strong>åšå¥½ä¸Šé¢çš„å‡å®šä¹‹å</strong>ï¼Œæ ¹æ®ä¹‹å‰çš„å‡å®šï¼Œ<em>Aä¸­çš„åœ¨å‰kä¸ªæ•°ä¸­çš„å…ƒç´ çš„æœ€åä¸€ä¸ªæ•°æ˜¯ç¬¬paä¸ªæ•°ï¼ŒBä¸­çš„åœ¨å‰kä¸ªæ•°ä¸­çš„æ•°çš„æœ€åä¸€ä¸ªæ•°å«ç¬¬pbä¸ªæ•°</em>ã€‚<br>1ã€<em>å¦‚æœç¬¬paæ•°ç­‰äºç¬¬pbæ•°</em>ï¼Œé‚£ä¹ˆæœ€ç»ˆçš„å‰kä¸ªæ•°çš„æœ€åä¸€ä¸ªæ•°ä¸€å®šç­‰äºç¬¬paæ•°ï¼ˆæ˜¯paè¿˜æ˜¯pbæ— æ‰€è°“äº†ï¼‰ï¼Œä¹Ÿå°±æ˜¯è¯´æœ€ç»ˆçš„ç¬¬kä¸ªæ•°å°±æ˜¯ç¬¬paæ•°ã€‚<br>2ã€<em>å¦‚æœç¬¬paæ•°å¤§äºç¬¬pbæ•°</em>ï¼Œé‚£ä¹ˆè¯´æ˜ï¼Œæˆ‘æ‰€å‡å®šçš„Bä¸­ç›®å‰å±äºå‰kä¸ªæ•°çš„æ•°ç¡®å®æ˜¯å±äºæœ€ç»ˆçš„å‰kä¸ªæ•°ï¼Œå¹¶ä¸”åé¢è¿˜æœ‰éƒ¨åˆ†æ•°ä¹Ÿå±äºã€‚æˆ‘æ‰€å‡å®šçš„Aä¸­ç›®å‰å±äºå‰kä¸ªæ•°çš„æ•°ä¸ä¸€å®šéƒ½å±äºæœ€ç»ˆçš„å‰kä¸ªæ•°ã€‚å¥½äº†ï¼Œäºæ˜¯æˆ‘å°±æŠŠBä¸­ç¡®å®æ˜¯å±äºæœ€ç»ˆçš„å‰kä¸ªæ•°çš„è¿™pbä¸ªæ•°ï¼ˆå³ç¬¬pbå’Œç¬¬pbä¹‹å‰çš„è¿™äº›æ•°ï¼‰åˆ‡æ‰ï¼Œå˜æˆBâ€™ã€‚é—®é¢˜å°±å˜ä¸ºå»æ‰¾Aå’ŒBâ€™ä¸­çš„å‰k-pbä¸ªæ•°ã€‚<br>3ã€<em>å¦‚æœç¬¬paæ•°å°äºç¬¬pbæ•°</em>ï¼Œé‚£ä¹ˆè¯´æ˜ï¼Œæˆ‘æ‰€å‡å®šçš„Aä¸­ç›®å‰å±äºå‰kä¸ªæ•°çš„æ•°ç¡®å®æ˜¯å±äºæœ€ç»ˆçš„å‰kä¸ªæ•°ï¼Œå¹¶ä¸”åé¢è¿˜æœ‰éƒ¨åˆ†æ•°ä¹Ÿå±äºï¼ˆæœ‰å¯èƒ½åé¢å·²ç»æ²¡æ•°äº†ï¼‰ã€‚æˆ‘æ‰€å‡å®šçš„Bä¸­ç›®å‰å±äºå‰kä¸ªæ•°çš„æ•°ä¸ä¸€å®šéƒ½å±äºæœ€ç»ˆçš„å‰kä¸ªæ•°ã€‚å¥½äº†ï¼Œäºæ˜¯æˆ‘å°±æŠŠAä¸­ç¡®å®æ˜¯å±äºæœ€ç»ˆçš„å‰kä¸ªæ•°çš„è¿™paä¸ªæ•°ï¼ˆå³ç¬¬paå’Œç¬¬paä¹‹å‰çš„è¿™äº›æ•°ï¼Œæœ‰å¯èƒ½å°±æ˜¯Aä¸­æ‰€æœ‰çš„æ•°ï¼‰åˆ‡æ‰ï¼Œå˜æˆäº†Aâ€™ï¼ˆå¯èƒ½æ˜¯ç©ºçš„ï¼‰ã€‚é—®é¢˜å˜ä¸ºå»æ‰¾Aâ€™å’ŒBä¸­çš„å‰k-paä¸ªæ•°ã€‚</p><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">findMedianSortedArrays</span><span class="params">(<span class="keyword">int</span>[] nums1, <span class="keyword">int</span>[] nums2)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">int</span> length = nums1.length + nums2.length;</span><br><span class="line">        <span class="keyword">if</span> (length % <span class="number">2</span> == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> (findKth(nums1, nums2, length/<span class="number">2</span>) + findKth(nums1, nums2, length/<span class="number">2</span> + <span class="number">1</span>))/<span class="number">2.0</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> findKth(nums1, nums2, length/<span class="number">2</span> + <span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">findKth</span><span class="params">(<span class="keyword">int</span>[] arr1, <span class="keyword">int</span>[] arr2, <span class="keyword">int</span> k)</span></span>&#123;</span><br><span class="line">        <span class="comment">// ç¼–ç æŠ€å·§ï¼šåœ¨ç®—æ³•ä¸­ï¼Œä½ ä¼šå‡å®šè®¸å¤šä¸œè¥¿ï¼Œæ¯”å¦‚ä¸¤ä¸ªåŒç­‰åœ°ä½çš„æ•°ç»„ï¼Œ</span></span><br><span class="line">        <span class="comment">// å‡å®šä¸€ä¸ªæ¯”å¦ä¸€ä¸ªé•¿ï¼Œé‚£ä¹ˆåœ¨ç¼–ç çš„æ—¶å€™ï¼Œ</span></span><br><span class="line">        <span class="comment">// å®Œå…¨æ²¡æœ‰å¿…è¦å°†å¯¹ç§°çš„æƒ…å†µé‡å†™ä¸€è¾¹å¯¹ç§°çš„ä»£ç ï¼Œè€Œæ˜¯åº”è¯¥å°†å‚æ•°åè¿‡æ¥é€’å½’è°ƒç”¨ä¸€æ¬¡ï¼</span></span><br><span class="line">        <span class="keyword">if</span> (arr1.length &gt; arr2.length)&#123;</span><br><span class="line">            <span class="keyword">return</span> findKth(arr2, arr1, k);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// arr1 ä¸ºç©º</span></span><br><span class="line">        <span class="keyword">if</span> (arr1.length == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> arr2[k - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (k == <span class="number">1</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> arr1[<span class="number">0</span>] &gt; arr2[<span class="number">0</span>] ? arr2[<span class="number">0</span>] : arr1[<span class="number">0</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span> pos1 = k/<span class="number">2</span> &lt; arr1.length ? k/<span class="number">2</span> : arr1.length;</span><br><span class="line">        <span class="keyword">int</span> pos2 = k - pos1;</span><br><span class="line">        <span class="keyword">if</span> (arr1.length == <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> arr2[k - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (arr1[pos1 - <span class="number">1</span>] &gt; arr2[pos2 - <span class="number">1</span>])&#123;</span><br><span class="line">            <span class="comment">// copyOfRangeçš„åŒºé—´æ˜¯[from, to)</span></span><br><span class="line">            arr2 = Arrays.copyOfRange(arr2, pos2, arr2.length);</span><br><span class="line">            <span class="keyword">return</span> findKth(arr1, arr2, k - pos2);</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (arr1[pos1 - <span class="number">1</span>] &lt; arr2[pos2 - <span class="number">1</span>])&#123;</span><br><span class="line">            arr1 = Arrays.copyOfRange(arr1, pos1, arr1.length);</span><br><span class="line">            <span class="keyword">return</span> findKth(arr1, arr2, k - pos1);</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> arr1[pos1 - <span class="number">1</span>];</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> leetcode </tag>
            
            <tag> median </tag>
            
            <tag> two arrays </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NameNodeç›‘æ§ç”¨æˆ·ä½¿ç”¨èµ„æº</title>
      <link href="/NameNode%E7%9B%91%E6%8E%A7%E7%94%A8%E6%88%B7%E4%BD%BF%E7%94%A8%E8%B5%84%E6%BA%90.html"/>
      <url>/NameNode%E7%9B%91%E6%8E%A7%E7%94%A8%E6%88%B7%E4%BD%BF%E7%94%A8%E8%B5%84%E6%BA%90.html</url>
      
        <content type="html"><![CDATA[<p>HDFSæ˜¯Hadoopçš„åŸºçŸ³ï¼Œå¯¹å…¶çš„ä½¿ç”¨æƒ…å†µè¿›è¡Œç›‘æ§æ˜¾çš„å°¤ä¸ºé‡è¦ã€‚é‚£ä¹ˆæ€ä¹ˆæ¥è¡¡é‡ä¸€ä¸ªç”¨æˆ·å¯¹hdfsçš„ä½¿ç”¨æƒ…å†µå‘¢ï¼Œç”¨ä»€ä¹ˆæ¥è¡¡é‡å‘¢ï¼Ÿä¼—æ‰€å‘¨çŸ¥HDFSæ˜¯ç”±NameNodeå’ŒDataNodeç»„æˆï¼Œè€ŒNameNodeåˆæ˜¯HDFSçš„æ ¸å¿ƒï¼ŒNameNodeä¸­æœ€é‡è¦çš„å°±æ˜¯è®°å½•æ•´ä¸ªé›†ç¾¤çŠ¶æ€çš„å…ƒæ•°æ®ã€‚äº†è§£é›†ç¾¤çš„ä½¿ç”¨æƒ…å†µä¹Ÿå°±æ˜¯ç›®å‰çš„çŠ¶æ€ï¼Œè¿™äº›çŠ¶æ€è®°å½•åœ¨å…ƒæ•°æ®ä¸­ï¼Œè€Œå…ƒæ•°æ®ä¸­æ˜¯é€šè¿‡è®°å½•å„ä¸ªç”¨æˆ·å¯¹HDFSçš„æ“ä½œæ¥æç»˜é›†ç¾¤çš„çŠ¶æ€ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥é€šè¿‡ç»Ÿè®¡å„ä¸ªç”¨æˆ·åœ¨æŸä¸ªæ—¶é—´æ®µå¯¹HDFSçš„æ“ä½œæ•°æ¥è¡¡é‡ä»–ä»¬ä½¿ç”¨HDFSçš„èµ„æºã€‚ç­”æ¡ˆæ˜¯è‚¯å®šæ˜¯ï¼Œè€Œä¸”æ­¤åŠŸèƒ½å·²ç»mergeåˆ°2.7ç‰ˆæœ¬ä¸­ï¼Œä¸‹é¢å°±æ¥äº†è§£ä¸‹è¿™ä¸ª<a href="https://issues.apache.org/jira/browse/HDFS-6982">patch</a>ã€‚</p><span id="more"></span><h2 id="æ¶æ„"><a href="#æ¶æ„" class="headerlink" title="æ¶æ„"></a>æ¶æ„</h2><p>nntopçš„æ¶æ„å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/nntop/nntop-architecture.png" alt="nntopæ¶æ„å›¾" title="nntopæ¶æ„å›¾"><br>nntopæ˜¯åœ¨NNä¸­çš„audit loggersä¸­è¿›è¡Œæ‹¦æˆªï¼Œaudit logä»NNä¸­æ¥æ”¶æ‰€æœ‰userçš„æ“ä½œã€‚åœ¨audit logä¸­è¿›è¡Œæ‹¦æˆªèƒ½å¤Ÿå¾ˆå¥½çš„æ‰©å±•åˆ°å…¶ä½™çš„NNä¸­ã€‚<br>HDFSé»˜è®¤çš„å®¡è®¡æ—¥å¿—æ˜¯DefaultAuditLoggerï¼Œnntopæ˜¯åœ¨HDFSä¸­æ·»åŠ äº†ä¸€ä¸ªæ–°çš„å®¡è®¡æ—¥å¿—ç±»TopAuditLoggerï¼Œç”±TopAuditLoggerè§£æå®¡è®¡äº‹ä»¶å¹¶ä¼ é€ç»™TopMetricsã€‚TopMetricsä¸­è®°å½•æ¯ä¸ªæ“ä½œçš„top user listï¼ŒTopMetricsä¹Ÿå‘Hadoop metrics systemæ³¨å†Œæ­¤metricsï¼Œå®ç°äº†getMetricsæ–¹æ³•ï¼Œä»¥ä¾¿å¾—åˆ°å½“å‰æ—¶é—´æ®µçš„top user listã€‚<br>TopMetricsèƒ½å¾—åˆ°å¤šä¸ªæ—¶é—´åŒºé—´çš„top usersï¼Œé»˜è®¤æ˜¯1mï¼Œ5må’Œ25mï¼Œè¿™æ˜¯ä¸ºäº†å¼¥è¡¥æ²¡æœ‰ç”»å›¾æ¥å£ã€‚</p><h2 id="ç»†èŠ‚è®¾è®¡"><a href="#ç»†èŠ‚è®¾è®¡" class="headerlink" title="ç»†èŠ‚è®¾è®¡"></a>ç»†èŠ‚è®¾è®¡</h2><p>æ­¤åŠŸèƒ½çš„ä¸»è¦å°±æ˜¯ç»Ÿè®¡æ¯ä¸ªuserçš„æ“ä½œæ•°ï¼Œä½†æ˜¯æ€ä¹ˆç»Ÿè®¡å‘¢ï¼Ÿè¿™æ˜¯ä¸ªé—®é¢˜ã€‚</p><p>æäº¤patchçš„è¿™ä½å¤§ç¥é‡‡ç”¨çš„<em>æ»‘åŠ¨çª—å£</em>çš„æ€æƒ³ï¼Œå¹¶æŠŠ<em>å½“å‰çª—å£åˆ†ä¸ºnä¸ªbucket</em>(é»˜è®¤æ˜¯10)ï¼Œåˆ†åˆ«åœ¨æ¯ä¸ªbucketä¸­è¿›è¡Œè®¡æ•°ï¼Œç„¶åå¯¹å…¶çª—å£å†…çš„bucketè¿›è¡Œæ±‚å’Œå¾—åˆ°æ€»å’Œã€‚æ¯ä¸ªbucketæœ‰ä¸€ä¸ªæ—¶é—´æ ‡è¯†updatetimeï¼Œå½“updatetimeä¸nowçš„å·®å€¼è¶…è¿‡äº†çª—å£çš„é•¿åº¦ï¼Œåˆ™å°†æ­¤bucketç½®0ï¼Œæ›´æ–°updatetimeï¼Œçª—å£ä¹Ÿå°±å³ç§»äº†ä¸€ä¸ªbucketã€‚</p><p>è¿™æ ·è®¾è®¡å¾ˆå·§å¦™æ²¡æ¯›ç—…ï¼Œä½†æ˜¯HDFSä¸­çš„æ“ä½œç±»å‹å’Œç”¨æˆ·éƒ½å¾ˆå¤šï¼Œç»Ÿè®¡åº”è¯¥æ€æ ·é€çº§ç»Ÿè®¡å‘¢ï¼Ÿåˆ<em>ä¸ºäº†å¼¥è¡¥æ­¤åŠŸèƒ½æ²¡æœ‰å‹å¥½çš„ç”»å›¾æ¥å£ï¼Œæ­¤patchæ”¯æŒå¯¹å¤šä¸ªæ—¶é—´é—´éš”è¿›è¡Œç»Ÿè®¡</em>ï¼Œåˆ™å¤§ç¥å°†ç»Ÿè®¡çš„æµç¨‹è®¾è®¡ä¸ºæ ‘å½¢ç»“æ„ï¼Œç»Ÿè®¡çš„å…¥å£æ˜¯TopMetricsï¼Œç„¶åTopMetricsä¼šæ ¹æ®è®¾ç½®çš„éœ€è¦ç»Ÿè®¡çš„æ—¶é—´åŒºé—´ä¸ªæ•°åˆå§‹åŒ–å¯¹åº”çš„RollingWindowManager(ä¸€ä¸ªåŒºé—´ä¸€ä¸ªRollingWindowManager)ï¼ŒRollingWindowManagerä¸­åˆæœ‰ä¸€ä¸ªmetricsMapï¼Œç”¨æ¥è®°å½•metricsä¸RollingWindowMapçš„æ˜ å°„ï¼ŒRollingWindowMapä¸­åˆæ˜¯userå’ŒRollingWindowçš„æ˜ å°„ï¼ŒRollingWindowå°±æ˜¯æ‰€è°“çš„æ»‘åŠ¨çª—å£ï¼Œé‡Œé¢ç”±nä¸ªbucketè¿›è¡Œç»Ÿè®¡ã€‚æ ‘å½¢å›¾å¦‚ä¸‹ï¼š<br><img src="/blogimgs/nntop/%E7%BB%9F%E8%AE%A1%E6%B5%81%E7%A8%8B%E5%9B%BE.png" alt="ç»Ÿè®¡æµç¨‹" title="ç»Ÿè®¡æµç¨‹"></p><h2 id="ä»£ç è·Ÿè¯»"><a href="#ä»£ç è·Ÿè¯»" class="headerlink" title="ä»£ç è·Ÿè¯»"></a>ä»£ç è·Ÿè¯»</h2><p>ä»ä¸Šå›¾çš„nntopæ¶æ„å›¾ä¸­å¯ä»¥çœ‹å‡ºæ˜¯åœ¨å†™å…¥auditlogä¹‹å‰è¿›è¡Œäº†æ‹¦æˆªï¼Œä¹Ÿå°±æ˜¯åœ¨<code>FSNamesystem.logAuditEvent()</code>ä¸­è¿›è¡Œåˆ¤æ–­çš„ï¼ŒlogAuditEventæ˜¯å°†è¯¥æ“ä½œåœ¨æ³¨å†Œçš„å„ä¸ªauditsLoggersä¸­éƒ½è®°å½•ä¸€è¾¹ï¼ŒauditsLoggersæ˜¯é€šè¿‡<code>initAuditLoggers</code>å‘nnæ³¨å†Œçš„ï¼Œçœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> List&lt;AuditLogger&gt; <span class="title">initAuditLoggers</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Initialize the custom access loggers if configured.</span></span><br><span class="line">  Collection&lt;String&gt; alClasses = conf.getStringCollection(DFS_NAMENODE_AUDIT_LOGGERS_KEY);</span><br><span class="line">  List&lt;AuditLogger&gt; auditLoggers = Lists.newArrayList();</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// Make sure there is at least one logger installed.</span></span><br><span class="line">  <span class="keyword">if</span> (auditLoggers.isEmpty()) &#123;</span><br><span class="line">    auditLoggers.add(<span class="keyword">new</span> DefaultAuditLogger());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¼€å¯nntopåŠŸèƒ½æ—¶ï¼Œå‘auditsLoggersé‡Œæ³¨å†ŒTopAuditLogger</span></span><br><span class="line">  <span class="comment">// å¼€å¯çš„å¼€å…³ç”±dfs.namenode.top.enabledæ§åˆ¶</span></span><br><span class="line">  <span class="comment">// Add audit logger to calculate top users</span></span><br><span class="line">  <span class="keyword">if</span> (topConf.isEnabled) &#123;</span><br><span class="line">    topMetrics = <span class="keyword">new</span> TopMetrics(conf, topConf.nntopReportingPeriodsMs);</span><br><span class="line">    auditLoggers.add(<span class="keyword">new</span> TopAuditLogger(topMetrics));</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> Collections.unmodifiableList(auditLoggers);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯ä»¥çœ‹å‡º<code>DefaultAuditLogger</code>å’Œ<code>TopAuditLogger</code>éƒ½å‘auditsLoggersä¸­æ³¨å†Œï¼Œåˆ™è¿™ä¸¤ä¸ªauditLoggerçš„åŠŸèƒ½åº”è¯¥ç±»ä¼¼ï¼ŒDefaultAuditLoggeråªæ˜¯å°†æ“ä½œç›¸å…³çš„ä¿¡æ¯è®°å½•åœ¨audit-logä¸­ï¼Œè€ŒTopAuditLoggeræ˜¯åœ¨è®°å½•ä¹‹å‰è¿›è¡Œäº†ä¸€æ¬¡metricsçš„reportï¼Œæ­¤æ—¶çš„metricsæ˜¯TopMetricsçš„å¯¹è±¡ï¼Œåœ¨æ„é€ TopAuditLoggerå¯¹è±¡æ—¶è¢«ä¼ å…¥ã€‚</p><p>TopAuditLoggeråˆå§‹åŒ–å¹¶å‘auditsLoggersä¸­æ³¨å†Œä¹‹åï¼Œå½“æœ‰hdfsæ“ä½œæ—¶ï¼Œä¼šè°ƒç”¨<code>FSNamesystem.logAuditEvent()</code>æ–¹æ³•å¯¹æ“ä½œè¿›è¡Œè®°å½•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">logAuditEvent</span><span class="params">(<span class="keyword">boolean</span> succeeded,</span></span></span><br><span class="line"><span class="params"><span class="function">    UserGroupInformation ugi, InetAddress addr, String cmd, String src,</span></span></span><br><span class="line"><span class="params"><span class="function">    String dst, HdfsFileStatus stat)</span> </span>&#123;</span><br><span class="line">  FileStatus status = <span class="keyword">null</span>;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">for</span> (AuditLogger logger : auditLoggers) &#123;</span><br><span class="line">  <span class="comment">// DefaultAuditLogger extends HdfsAuditLogger</span></span><br><span class="line">  <span class="comment">// HdfsAuditLogger implements AuditLogger</span></span><br><span class="line">    <span class="keyword">if</span> (logger <span class="keyword">instanceof</span> HdfsAuditLogger) &#123;</span><br><span class="line">      HdfsAuditLogger hdfsLogger = (HdfsAuditLogger) logger;</span><br><span class="line">      hdfsLogger.logAuditEvent(succeeded, ugi.toString(), addr, cmd, src, dst,</span><br><span class="line">          status, ugi, dtSecretManager);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// TopAuditLogger implements AuditLogger </span></span><br><span class="line">      <span class="comment">// åˆ™æ­¤å¤„è°ƒç”¨TopAuditLoggerçš„logAuditEventæ–¹æ³•</span></span><br><span class="line">      logger.logAuditEvent(succeeded, ugi.toString(), addr,</span><br><span class="line">          cmd, src, dst, status);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>FSNamesystem.logAuditEvent()</code>ä¸­ä¼šå¯¹auditsLoggersè¿›è¡Œéå†ï¼Œå°†æ“ä½œè®°å½•åœ¨æ‰€æœ‰çš„auditsLoggerä¸­ï¼Œé€šè¿‡è°ƒç”¨auditsLoggerçš„<code>logAuditEvent</code>æ–¹æ³•ï¼Œçœ‹ä¸‹<code>TopAuditLogger.logAuditEvent</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">logAuditEvent</span><span class="params">(<span class="keyword">boolean</span> succeeded, String userName,</span></span></span><br><span class="line"><span class="params"><span class="function">    InetAddress addr, String cmd, String src, String dst, FileStatus status)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ ¸å¿ƒä»£ç </span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    topMetrics.report(succeeded, userName, addr, cmd, src, dst, status);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;An error occurred while reflecting the event in top service, &quot;</span></span><br><span class="line">        + <span class="string">&quot;event: (cmd=&#123;&#125;,userName=&#123;&#125;)&quot;</span>, cmd, userName);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¸DefaultAuditLoggerä¸­çš„logAuditEventç±»ä¼¼</span></span><br><span class="line">  <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">    <span class="keyword">final</span> StringBuilder sb = <span class="keyword">new</span> StringBuilder();</span><br><span class="line">    sb.append(<span class="string">&quot;allowed=&quot;</span>).append(succeeded).append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;ugi=&quot;</span>).append(userName).append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;ip=&quot;</span>).append(addr).append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;cmd=&quot;</span>).append(cmd).append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;src=&quot;</span>).append(src).append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">    sb.append(<span class="string">&quot;dst=&quot;</span>).append(dst).append(<span class="string">&quot;\t&quot;</span>);</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">null</span> == status) &#123;</span><br><span class="line">      sb.append(<span class="string">&quot;perm=null&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      sb.append(<span class="string">&quot;perm=&quot;</span>);</span><br><span class="line">      sb.append(status.getOwner()).append(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">      sb.append(status.getGroup()).append(<span class="string">&quot;:&quot;</span>);</span><br><span class="line">      sb.append(status.getPermission());</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.debug(<span class="string">&quot;------------------- logged event for top service: &quot;</span> + sb);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>logAuditEventåœ¨å†™å…¥audit-logä¹‹å‰å…ˆå‘metricsç³»ç»Ÿreportï¼Œreportä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">report</span><span class="params">(<span class="keyword">long</span> currTime, String userName, String cmd)</span> </span>&#123;</span><br><span class="line">  LOG.debug(<span class="string">&quot;a metric is reported: cmd: &#123;&#125; user: &#123;&#125;&quot;</span>, cmd, userName);</span><br><span class="line">  userName = UserGroupInformation.trimLoginMethod(userName);</span><br><span class="line">  <span class="comment">// ä¸€ä¸ªæ—¶é—´åŒºé—´ä¸€ä¸ªrollingWindowManager</span></span><br><span class="line">  <span class="comment">// éå†æ‰€æœ‰çš„managerï¼Œè®©æ‰€æœ‰åŒºé—´ä¸­çš„metricsåŠ 1</span></span><br><span class="line">  <span class="keyword">for</span> (RollingWindowManager rollingWindowManager : rollingWindowManagers</span><br><span class="line">      .values()) &#123;</span><br><span class="line">    rollingWindowManager.recordMetric(currTime, cmd, userName, <span class="number">1</span>);</span><br><span class="line">    rollingWindowManager.recordMetric(currTime,</span><br><span class="line">        TopConf.ALL_CMDS, userName, <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­æœ‰ä¸€ä¸ªé‡è¦çš„å±æ€§éœ€è¦è¯´ä¸€ä¸‹<code>rollingWindowManagers</code>ï¼ŒrollingWindowManagersæ˜¯ä¸€ä¸ªkeyä¸ºIntegerï¼Œvalueä¸ºRollingWindowManagerçš„mapï¼Œmapçš„é•¿åº¦ç”±<code>dfs.namenode.top.windows.minutes</code>å±æ€§çš„å…ƒç´ ä¸ªæ•°æ§åˆ¶ï¼Œkeyçš„å€¼å°±æ˜¯è¯¥å±æ€§çš„å…ƒç´ ï¼Œè¯¥å±æ€§çš„å€¼æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œé»˜è®¤æ˜¯<code>&#123;&quot;1&quot;,&quot;5&quot;,&quot;25&quot;&#125;</code>ã€‚æ­¤å±æ€§ä»£è¡¨è¿™æˆ‘è¦ç»Ÿè®¡ä¸‰ä¸ªæ—¶é—´åŒºé—´çš„å€¼ï¼Œä¸‰ä¸ªåŒºé—´åˆ†åˆ«ä¸º1åˆ†é’Ÿã€5åˆ†é’Ÿå’Œ25åˆ†é’Ÿã€‚è¿™æ ·åšæ˜¯ä¸ºäº†è§‚å¯Ÿä¸€ä¸ªè¶‹åŠ¿ã€‚</p><p>æ¯ä¸ªæ—¶é—´åŒºé—´å¯¹åº”ä¸€ä¸ª<code>RollingWindowManager</code>ï¼Œè€ŒrollingWindowManagersæ˜¯å­˜æ”¾è¿™äº›managerçš„mapï¼Œå„ä¸ªåŒºé—´å…·ä½“çš„metricsç»Ÿè®¡ç”±å„è‡ªçš„manageræ§åˆ¶ã€‚manageré€šè¿‡è°ƒç”¨<code>recordMetric</code>å¯¹metricsè¿›è¡Œæ›´æ–°ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">recordMetric</span><span class="params">(<span class="keyword">long</span> time, String command, String user, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">  RollingWindow window = getRollingWindow(command, user);</span><br><span class="line">  window.incAt(time, delta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RollingWindowæ˜¯é€šè¿‡<code>getRollingWindow</code>å¾—åˆ°çš„ï¼Œä»ä¸Šé¢ç»Ÿè®¡æµç¨‹çš„åˆ†æä¸­å¾—çŸ¥RollingWindowä½äºç»Ÿè®¡ä¸­çš„æœ€åº•å±‚ï¼Œç”±RollingWindowè¿›è¡Œæ»‘åŠ¨çª—å£è¿›è¡Œç»Ÿè®¡ï¼Œä¸‹é¢çœ‹ä¸‹getRollingWindowä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RollingWindow <span class="title">getRollingWindow</span><span class="params">(String metric, String user)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ConcurrentHashMap&lt;String, RollingWindowMap&gt; metricMap</span></span><br><span class="line">  RollingWindowMap rwMap = metricMap.get(metric);</span><br><span class="line">  <span class="keyword">if</span> (rwMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">    rwMap = <span class="keyword">new</span> RollingWindowMap();</span><br><span class="line">    RollingWindowMap prevRwMap = metricMap.putIfAbsent(metric, rwMap);</span><br><span class="line">    <span class="keyword">if</span> (prevRwMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">      rwMap = prevRwMap;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  RollingWindow window = rwMap.get(user);</span><br><span class="line">  <span class="keyword">if</span> (window != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> window;</span><br><span class="line">  &#125;</span><br><span class="line">  window = <span class="keyword">new</span> RollingWindow(windowLenMs, bucketsPerWindow);</span><br><span class="line">  RollingWindow prevWindow = rwMap.putIfAbsent(user, window);</span><br><span class="line">  <span class="keyword">if</span> (prevWindow != <span class="keyword">null</span>) &#123;</span><br><span class="line">    window = prevWindow;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> window;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±æ­¤ä»£ç å¯ä»¥çœ‹å‡ºRollingWindowã€RollingWindowMapã€metricsMapå’ŒRollingWindowManagerçš„å…³ç³»ï¼ŒmetricsMapæ˜¯RollingWindowManagerçš„ä¸€ä¸ªå±æ€§ï¼ŒmetricsMapæ˜¯ConcurrentHashMap(<em>çº¿ç¨‹å®‰å…¨</em>)ç±»å‹ï¼Œkeyæ˜¯æ“ä½œåï¼Œvalueæ˜¯RollingWindowMapï¼Œè€ŒRollingWindowMapä¹Ÿæ˜¯ConcurrentHashMapç±»å‹çš„mapï¼Œkeyæ˜¯user nameï¼Œvalueæ˜¯RollingWindowã€‚</p><p>recordMetricæ—¶é€šè¿‡commandå’Œuserå®šä½åˆ°RollingWindowï¼Œç„¶åè°ƒç”¨RollingWindow.incAtè¿›è¡Œç´¯åŠ ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">incAt</span><span class="params">(<span class="keyword">long</span> time, <span class="keyword">long</span> delta)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> bi = computeBucketIndex(time);</span><br><span class="line">  Bucket bucket = buckets[bi];</span><br><span class="line">  <span class="comment">// If the last time the bucket was updated is out of the scope of the</span></span><br><span class="line">  <span class="comment">// rolling window, reset the bucket.</span></span><br><span class="line">  <span class="keyword">if</span> (bucket.isStaleNow(time)) &#123;</span><br><span class="line">    bucket.safeReset(time);</span><br><span class="line">  &#125;</span><br><span class="line">  bucket.inc(delta);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RollingWindowè¿›è¡Œmetricsç´¯åŠ æ—¶ï¼Œé€šè¿‡å½“å‰timeå®šä½åˆ°æŸä¸ªbucketä¸­ï¼Œè®©bucketè¿›è¡Œç´¯åŠ ã€‚bucketè¿›è¡Œç´¯åŠ æ—¶å…ˆåˆ¤æ–­å½“å‰bucketæ˜¯å¦è¿‡æ—¶ï¼Œä¹Ÿå°±æ˜¯è¯´å½“å‰bucketæ˜¯å¦è¿˜åœ¨ä»¥å½“å‰timeä¸ºç»“å°¾çš„æ—¶é—´çª—å£ä¸­ï¼Œä¸åœ¨åˆ™è¿›è¡Œé‡ç½®ã€‚</p><p>å®šä½bucketçš„ä»£ç æ˜¯åœ¨<code>computeBucketIndex</code>ä¸­ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">computeBucketIndex</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// time%windwoLenMs å¾—åˆ°timeæ‰€åœ¨windowä¸­çš„åç§»é‡</span></span><br><span class="line">  <span class="keyword">int</span> positionOnWindow = (<span class="keyword">int</span>) (time % windowLenMs);</span><br><span class="line">  <span class="keyword">int</span> bucketIndex = positionOnWindow * buckets.length / windowLenMs;</span><br><span class="line">  <span class="keyword">return</span> bucketIndex;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è®¡ç®—timeæ‰€åœ¨çš„bucketæ—¶ï¼Œå…ˆè®¡ç®—timeæ‰€åœ¨windowçš„åç§»é‡positionOnWindow*(time%windowLenMs)<em>ï¼Œç„¶åè®¡ç®—æ¯ä¸ªbucketçš„æ—¶é—´é•¿åº¦time_length</em>(windowLenMs/buckets.length)*ï¼Œç„¶åè®©<code>positionOnWindow/time_length</code>å°±å¾—åˆ°äº†bucketIndexï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢çš„ä»£ç <code>bucketIndex = positionOnWindow * buckets.length / windowLenMs</code></p><p>ç„¶åè°ƒç”¨bucket.isStaleNowåˆ¤æ–­æ˜¯å¦è¿‡æ—¶ï¼Œè¿‡æ—¶åˆ™é‡ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">boolean</span> <span class="title">isStaleNow</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> utime = updateTime.get();</span><br><span class="line">  <span class="keyword">return</span> time - utime &gt;= windowLenMs;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">safeReset</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// At any point in time, only one thread is allowed to reset the</span></span><br><span class="line">  <span class="comment">// bucket</span></span><br><span class="line">  <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isStaleNow(time)) &#123;</span><br><span class="line">      <span class="comment">// reset the value before setting the time, it allows other</span></span><br><span class="line">      <span class="comment">// threads to safely assume that the value is updated if the</span></span><br><span class="line">      <span class="comment">// time is not stale</span></span><br><span class="line">      value.set(<span class="number">0</span>);</span><br><span class="line">      updateTime.set(time);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// else a concurrent thread has already reset it: do nothing</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;    </span><br></pre></td></tr></table></figure><p>Bucketæ˜¯RollingWindowçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œæœ‰ä¸¤ä¸ªå±æ€§valueå’ŒupdateTimeï¼Œéƒ½æ˜¯<em>AtomicLong</em>ç±»å‹çš„ï¼Œè¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯updateTimeå¹¶ä¸æ˜¯åœ¨valueæ¯æ¬¡é€’å¢çš„æ—¶å€™æ”¹å˜ï¼ŒupdateTimeåªæ”¹å˜ä¸€æ¬¡ï¼Œå…¶å®ç›¸å½“äºbucketå¼€å§‹è®¡æ•°çš„startTimeï¼Œå½“æ¬¡startTimeä¸å½“å‰æ—¶é—´timeçš„å·®å€¼å¤§äºwindowLenMsæ—¶ï¼Œå°±è®¤ä¸ºbucketè¿‡æ—¶äº†ï¼Œéœ€è¦é‡ç½®ã€‚</p><h2 id="getç»Ÿè®¡æ•°æ®"><a href="#getç»Ÿè®¡æ•°æ®" class="headerlink" title="getç»Ÿè®¡æ•°æ®"></a>getç»Ÿè®¡æ•°æ®</h2><p>é€šè¿‡jmxè·å¾—æ•°æ®çš„å…¥å£å‡½æ•°æ˜¯getTopUserOpCountsï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">getTopUserOpCounts</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Date now = <span class="keyword">new</span> Date();</span><br><span class="line">  <span class="comment">// get ç»Ÿè®¡ç»“æœ</span></span><br><span class="line">  <span class="comment">// private TopMetrics topMetrics;</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;RollingWindowManager.TopWindow&gt; topWindows =</span><br><span class="line">      topMetrics.getTopWindows();</span><br><span class="line">  Map&lt;String, Object&gt; topMap = <span class="keyword">new</span> TreeMap&lt;String, Object&gt;();</span><br><span class="line">  topMap.put(<span class="string">&quot;windows&quot;</span>, topWindows);</span><br><span class="line">  topMap.put(<span class="string">&quot;timestamp&quot;</span>, DFSUtil.dateToIso8601String(now));</span><br><span class="line">  ObjectMapper mapper = <span class="keyword">new</span> ObjectMapper();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> mapper.writeValueAsString(topMap);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Failed to fetch TopUser metrics&quot;</span>, e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡TopMetrics.getTopWindowså¾—åˆ°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> List&lt;TopWindow&gt; <span class="title">getTopWindows</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> monoTime = Time.monotonicNow();</span><br><span class="line">  List&lt;TopWindow&gt; windows = Lists.newArrayListWithCapacity</span><br><span class="line">      (rollingWindowManagers.size());</span><br><span class="line">  <span class="keyword">for</span> (Entry&lt;Integer, RollingWindowManager&gt; entry : rollingWindowManagers</span><br><span class="line">      .entrySet()) &#123;</span><br><span class="line">    TopWindow window = entry.getValue().snapshot(monoTime);</span><br><span class="line">    windows.add(window);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> windows;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>getTopWindowsåªæ˜¯éå†rollingWindowManagerså¾—åˆ°å¤šä¸ªæ—¶é—´æ®µçš„ç»Ÿè®¡ç»“æœï¼Œè€ŒçœŸæ­£å–å¾—topuserçš„æ˜¯å„ä¸ªæ—¶é—´åŒºé—´å¯¹åº”çš„RollingWindowManager.snapshotã€‚</p><p>åœ¨è·Ÿè¯»snapshotä»£ç ä¹‹å‰ï¼Œå…ˆè·Ÿè¯»ä¸‹RollingWindowManagerç±»ï¼Œæ­¤ç±»ä¸­æœ‰ä¸€äº›å†…éƒ¨ç±»ï¼Œ</p><blockquote><p>é¦–å…ˆçœ‹ä¸‹<code>TopWindow</code>ã€<code>Op</code>å’Œ<code>User</code>ï¼Œè¿™ä¸‰è€…çš„å…³ç³»æ˜¯<code>TopWindow</code>ä¸­æœ‰ä¸ªå±æ€§topï¼Œç±»å‹<code>List&lt;Op&gt;</code>ï¼Œ<code>Op</code>æœ‰ä¸€ä¸ªå±æ€§topUsersï¼Œç±»å‹æ˜¯<code>List&lt;User&gt;</code>ã€‚TopWindowæ˜¯å½“å‰windowä¸­å„ä¸ªmetricsçš„ä¸€ä¸ªå¿«ç…§ï¼Œå„ä¸ªmetricsä»¥Opä¸ºå¯¹è±¡å­˜æ”¾åœ¨topçš„listä¸­ï¼Œlistä¸­ä¸€ä¸ªOpå°±æ˜¯ä¸€ä¸ªmetricsï¼ŒOpä¸­å­˜æ”¾çš„æ˜¯æ“ä½œæ­¤metricsçš„æ‰€æœ‰useråŠå…¶æ“ä½œæ€»æ¬¡æ•°ï¼ŒOpä¸­çš„å„ä¸ªuserä¿¡æ¯æ˜¯å­˜æ”¾åœ¨Userå¯¹è±¡ä¸­ï¼ŒUserå¯¹è±¡ä¸­è®°å½•ç€å½“å‰userå¯¹Opçš„æ“ä½œæ¬¡æ•°ã€‚</p></blockquote><blockquote><p>è¿˜æœ‰ä¸¤ä¸ªå†…éƒ¨ç±»<code>TopN</code>å’Œ<code>NameValuePair</code>ï¼ŒTopNæ˜¯ä¸€ä¸ªä¼˜å…ˆçº§é˜Ÿåˆ—(PriorityQueueï¼Œå…³äºä¼˜å…ˆçº§é˜Ÿåˆ—ä¼šåœ¨éšåçš„blogä¸­è¿›è¡Œåˆ†æ)ï¼Œå­˜æ”¾çš„å…ƒç´ æ˜¯NameValuePairå¯¹è±¡ï¼ŒNameValuePairå®ç°äº†<code>Comparable</code>æ¥å£ï¼Œé‡å†™compareToæ–¹æ³•ï¼Œå®ç°NameValuePairå¯¹è±¡ä»¥valueçš„å¤§å°ä½œä¸ºæ¯”è¾ƒçš„ä¾æ®*(NameValuePairä¸­çš„nameæ˜¯userï¼Œvalueæ˜¯userå¯¹Opçš„æ“ä½œæ¬¡æ•°)*ã€‚NameValuePairå®ç°äº†è‡ªå·±å®šä¹‰çš„compareToæ–¹æ³•ä¹‹ååœ¨TopNçš„ä¼˜å…ˆçº§é˜Ÿåˆ—ä¸­å°±å¯ä»¥ä¾é valueçš„å€¼è¿›è¡Œæ’åºï¼Œåˆ™TopNçš„å¯¹è±¡å°±æ˜¯æ“ä½œè¿‡Opçš„æ‰€æœ‰userçš„topNæ’åºçš„ç»“æœã€‚</p></blockquote><p>RollingWindowManagerä¸­çš„å†…éƒ¨ç±»çš„å…³ç³»å±¡æ¸…æ¥šä¹‹åå°±æ¥çœ‹ä¸‹snapshotä»£ç ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> TopWindow <span class="title">snapshot</span><span class="params">(<span class="keyword">long</span> time)</span> </span>&#123;</span><br><span class="line">  TopWindow window = <span class="keyword">new</span> TopWindow(windowLenMs);</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// metricMap å­˜æ”¾çš„æ˜¯ metrics -&gt; RollingWindowMap</span></span><br><span class="line">  <span class="keyword">for</span> (Map.Entry&lt;String, RollingWindowMap&gt; entry : metricMap.entrySet()) &#123;</span><br><span class="line">    String metricName = entry.getKey();</span><br><span class="line">    <span class="comment">// RollingWindowMap å­˜æ”¾çš„æ˜¯ username -&gt; RollingWindow</span></span><br><span class="line">    RollingWindowMap rollingWindows = entry.getValue();</span><br><span class="line">    <span class="comment">// é€šè¿‡metricNameå’Œtimeå¾—åˆ°å½“å‰windowä¸­userçš„topN</span></span><br><span class="line">    <span class="comment">// é¡ºåºæ˜¯ä»å°åˆ°å¤§ï¼Œå‡åº</span></span><br><span class="line">    TopN topN = getTopUsersForMetric(time, metricName, rollingWindows);</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> size = topN.size();</span><br><span class="line">    <span class="keyword">if</span> (size == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    Op op = <span class="keyword">new</span> Op(metricName, topN.getTotal());</span><br><span class="line">    window.addOp(op);</span><br><span class="line">    <span class="comment">// Reverse the users from the TopUsers using a stack, </span></span><br><span class="line">    <span class="comment">// since we&#x27;d like them sorted in descending rather than ascending order</span></span><br><span class="line">    <span class="comment">// æ ˆï¼Œåˆ©ç”¨æ ˆå…ˆè¿›åå‡ºçš„ç‰¹ç‚¹ï¼Œå°†topNä¸­çš„å‡åºå˜ä¸ºé™åº</span></span><br><span class="line">    Stack&lt;NameValuePair&gt; reverse = <span class="keyword">new</span> Stack&lt;NameValuePair&gt;();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">      reverse.push(topN.poll());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; size; i++) &#123;</span><br><span class="line">      NameValuePair userEntry = reverse.pop();</span><br><span class="line">      <span class="comment">// topNä¸­çš„NameValuePairä»¥Userçš„å½¢æ€å­˜æ”¾åˆ°Opçš„topUsers listä¸­</span></span><br><span class="line">      User user = <span class="keyword">new</span> User(userEntry.name, Long.valueOf(userEntry.value));</span><br><span class="line">      op.addUser(user);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> window;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>snapshotå°†å½“å‰çŠ¶æ€å­˜æ”¾åœ¨TopWindowä¸­è¿”å›ï¼Œæ¯ä¸ªOpçš„topUsersæ˜¯é€šè¿‡æ–¹æ³•<code>getTopUsersForMetric</code>å¾—åˆ°çš„ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> TopN <span class="title">getTopUsersForMetric</span><span class="params">(<span class="keyword">long</span> time, String metricName, </span></span></span><br><span class="line"><span class="params"><span class="function">    RollingWindowMap rollingWindows)</span> </span>&#123;</span><br><span class="line">  TopN topN = <span class="keyword">new</span> TopN(topUsersCnt);</span><br><span class="line">  Iterator&lt;Map.Entry&lt;String, RollingWindow&gt;&gt; iterator =</span><br><span class="line">      rollingWindows.entrySet().iterator();</span><br><span class="line">  <span class="keyword">while</span> (iterator.hasNext()) &#123;</span><br><span class="line">    Map.Entry&lt;String, RollingWindow&gt; entry = iterator.next();</span><br><span class="line">    String userName = entry.getKey();</span><br><span class="line">    RollingWindow aWindow = entry.getValue();</span><br><span class="line">    <span class="comment">// getSum å¾—åˆ°å½“å‰windowä¸­å„ä¸ªbucketè®¡æ•°çš„æ€»å’Œ</span></span><br><span class="line">    <span class="keyword">long</span> windowSum = aWindow.getSum(time);</span><br><span class="line">    <span class="comment">// do the gc here</span></span><br><span class="line">    <span class="keyword">if</span> (windowSum == <span class="number">0</span>) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot;gc window of metric: &#123;&#125; userName: &#123;&#125;&quot;</span>,</span><br><span class="line">          metricName, userName);</span><br><span class="line">      iterator.remove();</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    LOG.debug(<span class="string">&quot;offer window of metric: &#123;&#125; userName: &#123;&#125; sum: &#123;&#125;&quot;</span>,</span><br><span class="line">        metricName, userName, windowSum);</span><br><span class="line">    <span class="comment">// å°†NameValuePairæ”¾å…¥TopNä¸­ï¼Œé‡å†™offerï¼Œå¯¹NameValuePairè¿›è¡Œæ’åºæ”¾å…¥å †ä¸­</span></span><br><span class="line">    topN.offer(<span class="keyword">new</span> NameValuePair(userName, windowSum));</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.info(<span class="string">&quot;topN size for command &#123;&#125; is: &#123;&#125;&quot;</span>, metricName, topN.size());</span><br><span class="line">  <span class="keyword">return</span> topN;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="é™„åŠ "><a href="#é™„åŠ " class="headerlink" title="é™„åŠ "></a>é™„åŠ </h2><ul><li><p>windowä¸­bucketçš„ä¸ªæ•°å…³ç³»åˆ°ç»Ÿè®¡çš„ç²¾åº¦ï¼Œwindowä¸­bucketçš„ä¸ªæ•°è¶Šå¤šï¼Œç²¾åº¦è¶Šé«˜ã€‚<br>è§£æï¼šwindowä¸­bucketä¸­çš„ç»Ÿè®¡æ¬¡æ•°æ˜¯ä»¥bucketçš„updateTimeä¸ºå¼€å§‹æ—¶é—´ï¼Œåˆ™å¦‚æœwindowçš„é•¿åº¦æ˜¯60sï¼Œbucketçš„ä¸ªæ•°æ˜¯6ä¸ªï¼Œåˆ™æ¯ä¸ªbucketçš„é•¿åº¦æ˜¯10sã€‚å¦‚æœä»æ—¶é—´0å¼€å§‹ç»Ÿè®¡ï¼Œåˆ™bucket0çš„updateTimeæ˜¯ç¬¬0sï¼Œbucket1çš„updateTimeæ˜¯ç¬¬10sï¼Œbucket9çš„updateTimeæ˜¯ç¬¬50sï¼Œåœ¨65æ—¶ï¼Œç”¨æˆ·è°ƒç”¨getTopUserOpCountsæ–¹æ³•ç»Ÿè®¡ç¬¬65sæ—¶çš„topN userï¼Œåˆ™å½“å‰windowåº”è¯¥æ˜¯5såˆ°65sï¼Œå¯æ˜¯bucket0ç»Ÿè®¡çš„æ—¶é—´åŒºé—´æ˜¯0-10sï¼Œæ­¤æ—¶bucket0çš„updateTimeå·²ç»è¶…è¿‡äº†ç»Ÿè®¡çš„é˜ˆå€¼ï¼Œbucket0å·²ç»è¿‡æ—¶ï¼Œåˆ™æ­¤æ—¶ç»Ÿè®¡çš„åŒºé—´åªèƒ½ä»bucket1ï¼Œä¹Ÿå°±æ˜¯ä»10så¤„å¼€å§‹ç»Ÿè®¡ï¼Œä»10s-65så¤„ï¼Œ<em>ä¹Ÿå°±æ˜¯å°‘ç»Ÿè®¡äº†5sï¼Œå³5s-10såŒºé—´ä¸­çš„å€¼</em>ï¼Œè¯¯å·®æ˜¯5sï¼Œå¦‚æœä»bucketçš„é•¿åº¦ä¸º5sï¼Œåˆ™ç»Ÿè®¡çš„ç»“æœå€¼å°±æ˜¯æ­£ç¡®çš„ï¼Œä¸ä¼šå‡ºç°è¯¯å·®ï¼Œåˆ™å¾—å‡ºç»“è®ºï¼Œbucketä¸ªæ•°è¶Šå¤šï¼Œåˆ™ç²¾åº¦è¶Šé«˜ã€‚ä½†æ˜¯bucketä¹Ÿä¸èƒ½å¤ªå¤šï¼Œä¼šæŸè€—æ€§èƒ½ã€‚</p></li><li><p>ä¸ºä»€ä¹ˆé‡‡ç”¨æ»‘åŠ¨çª—å£</p></li></ul><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="https://issues.apache.org/jira/browse/HDFS-6982">Patchåœ°å€</a><br><a href="https://issues.apache.org/jira/secure/attachment/12665990/nntop-design-v1.pdf">HDFS-6982è®¾è®¡æ–‡æ¡£</a><br><a href="http://blog.csdn.net/androidlushangderen/article/details/52586560">HDFS nnTopç»Ÿè®¡åŠŸèƒ½</a></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> nntop </tag>
            
            <tag> ä½¿ç”¨èµ„æº </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Add Two Numbers</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Add%20Two%20Numbers.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Add%20Two%20Numbers.html</url>
      
        <content type="html"><![CDATA[<p>ä¸¤ä¸ªéè´Ÿæ•´æ•°çš„åˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ éƒ½æ˜¯ä¸€ä¸ªæ•°å­—ï¼ŒæŒ‰ç…§ç”±ä½ä½åˆ°é«˜ä½æ’åºï¼Œæ±‚ä¸¤ä¸ªé“¾è¡¨ä¸­çš„æ•°ç›¸åŠ å¹¶å·²é“¾è¡¨çš„æ–¹å¼è¿”å›ã€‚</p><p>ä¾‹å¦‚ï¼š<br>Input: (2 -&gt; 4 -&gt; 3) + (5 -&gt; 6 -&gt; 4)<br>Output: 7 -&gt; 0 -&gt; 8</p><p>è¿™é‡Œè²Œä¼¼æ²¡æœ‰ä»€ä¹ˆé«˜æ•ˆç®—æ³•ï¼Œå¯¹ä¸¤ä¸ªé“¾è¡¨åŒæ—¶éå†ç›¸åŠ ï¼Œå¹¶è®¾ç½®ä¸€ä¸ªæ ‡è¯†ä½ç”¨æ¥è¡¨ç¤ºæ˜¯å¦éœ€è¦è¿›ä½ã€‚</p><span id="more"></span><p>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        ListNode result = <span class="keyword">null</span>;</span><br><span class="line">        Stack&lt;ListNode&gt; stack = <span class="keyword">new</span> Stack&lt;ListNode&gt;(); </span><br><span class="line">        <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(l1 != <span class="keyword">null</span> &amp;&amp; l2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> sum = l1.val + l2.val + flag;</span><br><span class="line">            <span class="keyword">int</span> val = sum - <span class="number">10</span>;</span><br><span class="line">            flag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(val &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                val = sum;</span><br><span class="line">            &#125;</span><br><span class="line">            ListNode nt = <span class="keyword">new</span> ListNode(val);</span><br><span class="line">            stack.push(nt);</span><br><span class="line">            l1 = l1.next;</span><br><span class="line">            l2 = l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(l1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> sum = l1.val + flag;</span><br><span class="line">            <span class="keyword">int</span> val = sum - <span class="number">10</span>;</span><br><span class="line">            flag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(val &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                val = sum;</span><br><span class="line">            &#125;</span><br><span class="line">            ListNode nt = <span class="keyword">new</span> ListNode(val);</span><br><span class="line">            stack.push(nt);</span><br><span class="line">            l1 = l1.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(l2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> sum = l2.val + flag;</span><br><span class="line">            <span class="keyword">int</span> val = sum - <span class="number">10</span>;</span><br><span class="line">            flag = <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">if</span>(val &gt;= <span class="number">0</span>)&#123;</span><br><span class="line">                flag = <span class="number">1</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                val = sum;</span><br><span class="line">            &#125;</span><br><span class="line">            ListNode nt = <span class="keyword">new</span> ListNode(val);</span><br><span class="line">            stack.push(nt);</span><br><span class="line">            l2 = l2.next;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span>(flag &gt; <span class="number">0</span>)&#123;</span><br><span class="line">            ListNode nt = <span class="keyword">new</span> ListNode(<span class="number">1</span>);</span><br><span class="line">            stack.push(nt);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span>(!stack.empty())&#123;</span><br><span class="line">            ListNode temp = <span class="keyword">null</span>;</span><br><span class="line">            temp = stack.pop();</span><br><span class="line">            <span class="keyword">if</span>(result == <span class="keyword">null</span>)&#123;</span><br><span class="line">                temp.next = <span class="keyword">null</span>;</span><br><span class="line">                result = temp;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                temp.next = result;</span><br><span class="line">                result = temp;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯ä¸æ˜¯å¾ˆé•¿ï¼Œè¿™é‡Œè¿˜ç”¨åˆ°äº†Stackï¼Œç”¨Stackæ¥å­˜æ”¾å„ä¸ªé“¾è¡¨ä¸­çš„å„ä¸ªListNodeã€‚ç”¨Stackä¸»è¦æ˜¯ä¸ºäº†æŠŠå„ä¸ªListNodeæŒ‰ç…§ä»åå¾€å‰çš„é¡ºåºæ‹¼æˆé“¾è¡¨ã€‚</p><blockquote><p>é“¾è¡¨çš„ç»„å»ºæ–¹å¼æœ‰ä¸¤ç§ï¼Œä¸€ç§æ˜¯ä»åå¾€å‰å»ºç«‹è¿æ¥ï¼Œè¿™æ ·åªéœ€è¦ä¸€ä¸ªæŒ‡é’ˆï¼›å¦ä¸€ç§æ˜¯æŒ‰ç…§ä»å‰å¾€åå»ºç«‹è¿æ¥ï¼Œæ­¤æ—¶éœ€è¦ä¸¤ä¸ªæŒ‡é’ˆï¼Œä¸€ä¸ªæ˜¯æŒ‡å‘é“¾å¤´çš„firstæŒ‡é’ˆï¼Œå¹¶ä¸”firståœ¨åç»­ä¸­ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œå¦ä¸€ä¸ªæŒ‡é’ˆæ˜¯lastï¼Œlastä¼šæ ¹æ®é“¾è¡¨çš„å…ƒç´ å‘åç§»åŠ¨ï¼Œlastå§‹ç»ˆæŒ‡å‘é“¾è¡¨çš„æœ€åä¸€ä¸ªå…ƒç´ ã€‚</p></blockquote><p>ä¸‹é¢çœ‹ä¸‹ä»é“¾è¡¨å¤´ç»„å»ºé“¾è¡¨çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Definition for singly-linked list.</span></span><br><span class="line"><span class="comment"> * public class ListNode &#123;</span></span><br><span class="line"><span class="comment"> *     int val;</span></span><br><span class="line"><span class="comment"> *     ListNode next;</span></span><br><span class="line"><span class="comment"> *     ListNode(int x) &#123; val = x; &#125;</span></span><br><span class="line"><span class="comment"> * &#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> ListNode <span class="title">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">        ListNode first = <span class="keyword">null</span>;</span><br><span class="line">        ListNode last = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">int</span> flag = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>(l1 != <span class="keyword">null</span> || l2 != <span class="keyword">null</span> || flag != <span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">int</span> sum = flag;</span><br><span class="line">            <span class="keyword">if</span>(l1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">                sum += l1.val;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(l2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">                sum += l2.val;</span><br><span class="line">            &#125;</span><br><span class="line">            flag = sum / <span class="number">10</span>;</span><br><span class="line">            <span class="keyword">int</span> val = sum % <span class="number">10</span>;</span><br><span class="line">            ListNode temp = <span class="keyword">new</span> ListNode(val);</span><br><span class="line">            <span class="keyword">if</span>(first == <span class="keyword">null</span>)&#123;</span><br><span class="line">                first = temp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(last == <span class="keyword">null</span>)&#123;</span><br><span class="line">                last = temp;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                last.next = temp;</span><br><span class="line">                last = temp;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(l1 != <span class="keyword">null</span>)&#123;</span><br><span class="line">                l1 = l1.next;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(l2 != <span class="keyword">null</span>)&#123;</span><br><span class="line">                l2 = l2.next;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> first;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è™½ç„¶è¿™é‡Œå¤šå£°æ˜äº†ä¸€ä¸ªå˜é‡æŒ‡é’ˆï¼Œä½†æ˜¯ç›¸è¾ƒäºç¬¬ä¸€ä¸ªä»£ç ä¹Ÿç®—æ˜¯ä¸€ç§ä¼˜åŒ–ï¼Œè¿™é‡Œä¸éœ€è¦é¢å¤–çš„ç©ºé—´å»å­˜å‚¨ç›¸åŠ ä¹‹åçš„å„ä¸ªListNodeã€‚æ—¶é—´å¤æ‚åº¦éƒ½ä¸€æ ·åªæ˜¯ç©ºé—´å¤æ‚åº¦ä¸ºO(1)</p><p>è¯»ä¸Šé¢ä»£ç é“¾è¡¨ç»„å»ºä¸­firstå’ŒlastæŒ‡é’ˆçš„èµ‹å€¼æ˜¯ä¸æ˜¯æœ‰ä¸€ç§ä¸€å¤´é›¾æ°´çš„æ„Ÿè§‰ï¼Œå¾—ä»”ç»†è¯»ä¸‹æ‰èƒ½æ’¸æ˜ç™½ï¼Œä¸‹é¢çœ‹ä¸‹leetcodeä¸Šé¢çš„è§£ç­”ä»£ç ï¼Œæ„Ÿè§‰æ¯”è¾ƒæ¸…æ™°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ListNode <span class="title">addTwoNumbers</span><span class="params">(ListNode l1, ListNode l2)</span> </span>&#123;</span><br><span class="line">    ListNode dummyHead = <span class="keyword">new</span> ListNode(<span class="number">0</span>);</span><br><span class="line">    ListNode p = l1, q = l2, curr = dummyHead;</span><br><span class="line">    <span class="keyword">int</span> carry = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">while</span> (p != <span class="keyword">null</span> || q != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">int</span> x = (p != <span class="keyword">null</span>) ? p.val : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> y = (q != <span class="keyword">null</span>) ? q.val : <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> sum = carry + x + y;</span><br><span class="line">        carry = sum / <span class="number">10</span>;</span><br><span class="line">        curr.next = <span class="keyword">new</span> ListNode(sum % <span class="number">10</span>);</span><br><span class="line">        curr = curr.next;</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="keyword">null</span>) p = p.next;</span><br><span class="line">        <span class="keyword">if</span> (q != <span class="keyword">null</span>) q = q.next;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (carry &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        curr.next = <span class="keyword">new</span> ListNode(carry);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> dummyHead.next;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><strong>è¿™é‡Œå£°æ˜äº†ä¸€ä¸ªvalä¸º0çš„dummyHeadï¼Œä½¿dummyHeadä½œä¸ºé“¾è¡¨çš„å¤´èŠ‚ç‚¹</strong>ï¼Œå¹¶å£°æ˜ä¸€ä¸ªç§»åŠ¨æŒ‡é’ˆcurrä¹ŸæŒ‡å‘è¯¥èŠ‚ç‚¹ï¼Œè¿™æ ·åœ¨é“¾è¡¨åˆ›å»ºçš„è¿‡ç¨‹ä¸­ä¸ç”¨è¿›è¡Œå¤ªå¤šçš„åˆ¤æ–­ï¼Œåªéœ€ç§»åŠ¨æŒ‡é’ˆcurrå³å¯(<em>è¿™ä¹Ÿæ˜¯é“¾è¡¨çš„ä¸€ç§åˆ›å»ºæ–¹æ³•ï¼Œè²Œä¼¼å½“åˆå­¦æ•°æ®ç»“æ„æ—¶æ•™ç§‘ä¹¦å°±æ˜¯ç”¨è¿™ç§æ–¹æ³•åˆ›å»ºé“¾è¡¨çš„</em>)ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> leetcode </tag>
            
            <tag> add two numbers </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Markdown åŠ Sublime Textä½¿ç”¨æŠ€å·§</title>
      <link href="/Markdown%20%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7.html"/>
      <url>/Markdown%20%E4%BD%BF%E7%94%A8%E6%8A%80%E5%B7%A7.html</url>
      
        <content type="html"><![CDATA[<h1 id="Markdown-åŠ-Sublime-Textä½¿ç”¨æŠ€å·§"><a href="#Markdown-åŠ-Sublime-Textä½¿ç”¨æŠ€å·§" class="headerlink" title="Markdown åŠ Sublime Textä½¿ç”¨æŠ€å·§"></a>Markdown åŠ Sublime Textä½¿ç”¨æŠ€å·§</h1><p>åœ¨å·²æ‰“å¼€çš„æ–‡ä»¶ä¸­éšæ„è·³è½¬</p><blockquote><p><code>ctrl+p</code>, ç„¶åè¾“å…¥æ–‡ä»¶åï¼ŒæŒ‰<code>Esc</code> é€€å‡ºè¯¥åŠŸèƒ½</p></blockquote><p>åœ¨æµè§ˆå™¨ä¸­æŸ¥çœ‹æ•ˆæœ</p><blockquote><p><code>ctrl</code> + <code>shift</code> + <code>p</code> ç„¶åè¾“å…¥<code>mp</code>ï¼Œé€‰æ‹©<code>Preview in Browser</code> then é€‰æ‹©<code>markdown</code></p></blockquote><p>å›è½¦ç©ºè¡Œè¡¨ç¤ºä¸€æ®µ<br><code>#</code>è¡¨ç¤ºä¸€çº§æ ‡é¢˜ï¼Œ<code>##</code>è¡¨ç¤ºäºŒçº§ï¼Œä¾æ¬¡ç±»æ¨ï¼Œä¸€å…±å…­çº§</p><p>å¼ºè°ƒ</p><blockquote><p>è¢«<code>*</code>æˆ–è€…<code>_</code>åŒ…å›´çš„å†…å®¹ä¸ºæ–œä½“ï¼Œè¢«<code>**</code>æˆ–è€…<code>__</code>åŒ…å›´çš„å†…å®¹ä¸ºé»‘ä½“</p></blockquote><p>æ— åºåˆ—è¡¨</p><blockquote><p><code>*</code></p></blockquote><p>æœ‰åºåˆ—è¡¨</p><blockquote><p><code>1</code></p></blockquote>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> markdown </tag>
            
            <tag> sublime text </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹leetcode Two Sum</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Two%20Sum.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bleetcode%20Two%20Sum.html</url>
      
        <content type="html"><![CDATA[<p>ç»™å®šä¸€ä¸ªæ•´å½¢æ•°ç»„å’Œä¸€ä¸ªæ•´æ•°nï¼Œä»æ•°ç»„ä¸­æ‰¾åˆ°ä¸¤ä¸ªæ•°çš„ç´¢å¼•ä½¿è¿™ä¸¤ä¸ªæ•°ä¹‹å’Œç­‰äºnï¼Œä»¥æ•°ç»„çš„å½¢å¼è¿”å›è¿™ä¸¤ä¸ªæ•°çš„ç´¢å¼•ã€‚(å‡è®¾æ•°ç»„ä¸­åªå­˜åœ¨ä¸€ç»„è¿™æ ·çš„æ•°)</p><p>ä¾‹å¦‚ï¼š<br>Given nums = [2, 7, 11, 15], target = 9,</p><p>Because nums[0] + nums[1] = 2 + 7 = 9,<br>return [0, 1].</p><span id="more"></span><h2 id="å¾ªç¯éå†"><a href="#å¾ªç¯éå†" class="headerlink" title="å¾ªç¯éå†"></a>å¾ªç¯éå†</h2><p>é¦–å…ˆæ˜ å…¥è„‘æµ·çš„è§£å†³æ–¹æ¡ˆï¼Œé€æ­¥éå†æ•°ç»„ä¸­çš„æ¯ä¸ªå…ƒç´ ï¼ŒæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] twoSum(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        <span class="keyword">int</span>[] result = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt; nums.length; i++)   &#123;</span><br><span class="line">            <span class="keyword">int</span> first = nums[i];</span><br><span class="line">            result[<span class="number">0</span>] = i;</span><br><span class="line">            <span class="keyword">int</span> second = target - first;</span><br><span class="line">            <span class="keyword">for</span>(<span class="keyword">int</span> j=i+<span class="number">1</span>; j&lt;nums.length; j++)&#123;</span><br><span class="line">                <span class="keyword">if</span>(second == nums[j])&#123;</span><br><span class="line">                    result[<span class="number">1</span>] = j;</span><br><span class="line">                    <span class="keyword">break</span>;    </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(result[<span class="number">1</span>] != <span class="number">0</span>)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»£ç ä¸­æ¶‰åŠä¸¤ä¸ªforå¾ªç¯ï¼Œæ³¨æ„åˆ°ç¬¬äºŒä¸ªforå¾ªç¯å…¶å®æ˜¯åœ¨å‰©ä½™çš„æ•°ç»„å…ƒç´ ä¸­<em>æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ç›®æ ‡æ•°å­—second</em>ï¼Œåˆ™å¯ä»¥æƒ³åˆ°å¦‚æœæ•°ç»„æ˜¯æœ‰åºçš„ï¼Œåˆ™å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ¥æé«˜æ•ˆç‡ã€‚</p><blockquote><p>åˆ™å¯¹ä¸Šé¢æ€è·¯çš„ä¸€ç§æ”¹è¿›æ˜¯å‡å¦‚æ•°ç»„æ˜¯æ— åºçš„ï¼Œåˆ™å…ˆä½¿ç”¨å¿«æ’å¯¹å…¶è¿›è¡Œæ’åºï¼Œç„¶åéå†æ•°ç»„ä¸­çš„æ¯ä¸€ä¸ªå…ƒç´ ï¼Œä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾å†æ•°ç»„ä¸­æŸ¥çœ‹æ˜¯å¦å­˜åœ¨secondï¼Œå­˜åœ¨åˆ™æ‰¾åˆ°secondå¯¹åº”çš„ç´¢å¼•iã€‚</p></blockquote><h2 id="ä½¿ç”¨hashmapè¿›è¡Œæ”¹è¿›"><a href="#ä½¿ç”¨hashmapè¿›è¡Œæ”¹è¿›" class="headerlink" title="ä½¿ç”¨hashmapè¿›è¡Œæ”¹è¿›"></a>ä½¿ç”¨hashmapè¿›è¡Œæ”¹è¿›</h2><p>ä»ä¸Šé¢çš„æ€è·¯ä¸­å¯ä»¥çœ‹å‡ºç¬¬ä¸€ä¸ªforå¾ªç¯æ˜¯ä¸å¯å°‘çš„ï¼Œç¬¬äºŒä¸ªforå¾ªç¯å…¶å®æ˜¯å……å½“ä¸€ä¸ªæŸ¥æ‰¾çš„åŠŸèƒ½ï¼Œåˆ™å¯ä»¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾è¿›è¡Œæ”¹è¿›ï¼Œä½†æ˜¯æ˜¯å¦å¯ä»¥å€ŸåŠ©åˆ«çš„æ•°æ®ç»“æ„ä½¿å…¶èƒ½å¤Ÿæ›´å¿«çš„æ‰¾åˆ°secondçš„ç´¢å¼•iã€‚</p><p>ç›®çš„æ˜¯èƒ½å¤Ÿå¿«é€Ÿçš„æ‰¾åˆ°secondå¯¹åº”çš„ç´¢å¼•iï¼Œåˆ™secondå’Œiæ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œå­˜æ”¾è¿™ç§å…³ç³»çš„æ•°æ®ç»“æ„å¾ˆå®¹æ˜“æƒ³åˆ°HashMapï¼Œ<em>ä¹Ÿå°±æ˜¯å°†æ•°ç»„ä¸­çš„å…ƒç´ å’Œç´¢å¼•æ”¾å…¥mapä¸­ï¼Œå…ƒç´ ä½œä¸ºkeyï¼Œè¿™æ ·ç›´æ¥å»mapä¸­get keyå¯¹åº”çš„valueå°±okäº†</em>ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] twoSum(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        Map&lt;Integer, Integer&gt; numsMap = <span class="keyword">new</span> HashMap&lt;Integer, Integer&gt;();</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;nums.length; i++)&#123;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == numsMap.get(nums[i]))&#123;</span><br><span class="line">                numsMap.put(nums[i], i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">int</span>[] result = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;nums.length; i++)&#123;</span><br><span class="line">            Integer j = numsMap.get(target - nums[i]);</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> != j)&#123;</span><br><span class="line">                <span class="keyword">if</span>(j &lt; i)&#123;</span><br><span class="line">                    result[<span class="number">0</span>] = j;</span><br><span class="line">                    result[<span class="number">1</span>] = i;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(j &gt; i)&#123;</span><br><span class="line">                    result[<span class="number">0</span>] = i;</span><br><span class="line">                    result[<span class="number">1</span>] = j;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯¹äºä¸Šè¿°ä»£ç ä¾ç„¶å¯ä»¥ç²¾ç®€ï¼Œä½†åªæ˜¯ç²¾ç®€ä»£ç è¡Œæ•°è€Œå·²ï¼Œå¹¶ä¸èƒ½æé«˜æ—¶é—´å¤æ‚åº¦ã€‚</p><p>ç²¾ç®€çš„æ–¹æ³•æ˜¯åœ¨ç¬¬ä¸€ééå†æ•°ç»„çš„æ—¶å€™å°±å¯¹HashMapè¿›è¡Œåˆ¤æ–­ï¼Œæ‰¾åˆ°åˆ™é€€å‡ºï¼Œæ²¡æœ‰æ‰¾åˆ°åˆ™ç»§ç»­å¾ªç¯ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Solution</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">int</span>[] twoSum(<span class="keyword">int</span>[] nums, <span class="keyword">int</span> target) &#123;</span><br><span class="line">        Map&lt;Integer, Integer&gt; numsMap = <span class="keyword">new</span> HashMap&lt;Integer, Integer&gt;();</span><br><span class="line">        <span class="keyword">int</span>[] result = <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">2</span>];</span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;nums.length; i++)&#123;</span><br><span class="line">            <span class="keyword">int</span> second = target - nums[i];</span><br><span class="line">            <span class="keyword">if</span>(numsMap.containsKey(second))&#123;</span><br><span class="line">                Integer j = numsMap.get(second);</span><br><span class="line">                <span class="keyword">if</span>(j &lt; i)&#123;</span><br><span class="line">                    result[<span class="number">0</span>] = j;</span><br><span class="line">                    result[<span class="number">1</span>] = i;</span><br><span class="line">                &#125;<span class="keyword">else</span> <span class="keyword">if</span>(j &gt; i)&#123;</span><br><span class="line">                    result[<span class="number">0</span>] = i;</span><br><span class="line">                    result[<span class="number">1</span>] = j;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span>(<span class="keyword">null</span> == numsMap.get(nums[i]))&#123;</span><br><span class="line">                numsMap.put(nums[i], i);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>é‡åˆ°æ­¤é¢˜é¦–å…ˆæƒ³åˆ°çš„æ˜¯ä½¿ç”¨å¾ªç¯éå†æ‰¾åˆ°ä¸¤ä¸ªæ•°çš„ç´¢å¼•ï¼Œå…¶æ¬¡åœ¨éå†çš„è¿‡ç¨‹ä¸­å‘ç°ç¬¬äºŒä¸ªforå¾ªç¯å…¶å®æ˜¯éå†æŸ¥æ‰¾çš„åŠŸèƒ½ï¼Œè¯´åˆ°æŸ¥æ‰¾çš„ä¼˜åŒ–å¾ˆå®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯äºŒåˆ†æŸ¥æ‰¾ï¼Œç„¶åæŸ¥çœ‹æ˜¯å¦å¯ä»¥ç”¨äºŒåˆ†æŸ¥æ‰¾ï¼Œå¦‚æœä¸å¯ä»¥åˆ™å»åˆ›é€ æ¡ä»¶ä½¿å…¶æ»¡è¶³äºŒåˆ†æŸ¥æ‰¾çš„æ¡ä»¶ã€‚</p><p>å†è€…<em>åœ¨æ•°ç»„ä¸­æŸ¥æ‰¾ä¸€ä¸ªæ•°æ˜¯å¦åœ¨æ•°ç»„ä¸­ï¼Œä½¿ç”¨hashæ˜ å°„æŸ¥æ‰¾åªéœ€O(1)çš„æ—¶é—´å¤æ‚åº¦</em>ï¼Œåˆ™æ„å»ºä¸€ä¸ªHashMapï¼Œä½¿ç”¨hashæ˜ å°„æŸ¥æ‰¾ä¼˜åŒ–äºŒåˆ†æŸ¥æ‰¾ã€‚</p><blockquote><p>æ³¨æ„ï¼Œå¹¶ä¸æ˜¯åœ¨ä»»ä½•æƒ…å†µä¸‹æ„å»ºHashMapè¿›è¡ŒæŸ¥æ‰¾éƒ½ä¼šæ¯”äºŒåˆ†æŸ¥æ‰¾è¦å¿«ã€‚å› ä¸ºæ„å»ºHashMapéœ€è¦O(n)çš„æ—¶é—´å¤æ‚åº¦å»éå†æ•°ç»„ã€‚</p></blockquote>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> leetcode </tag>
            
            <tag> Two Sum </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>æ•°æ®ç»“æ„ç®—æ³•ä¹‹nçš„å¹³æ–¹æ ¹ä¿ç•™mä½å°æ•°</title>
      <link href="/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bn%E7%9A%84%E5%B9%B3%E6%96%B9%E6%A0%B9%E4%BF%9D%E7%95%99m%E4%BD%8D%E5%B0%8F%E6%95%B0.html"/>
      <url>/%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E7%AE%97%E6%B3%95%E4%B9%8Bn%E7%9A%84%E5%B9%B3%E6%96%B9%E6%A0%B9%E4%BF%9D%E7%95%99m%E4%BD%8D%E5%B0%8F%E6%95%B0.html</url>
      
        <content type="html"><![CDATA[<p>æ±‚nçš„å¹³æ–¹æ ¹xï¼Œxç²¾ç¡®åˆ°mä½å°æ•°ã€‚ä¾‹å¦‚æ±‚nç²¾ç¡®åˆ°å°æ•°ç‚¹å4ä½çš„å¹³æ–¹æ ¹ã€‚</p><p>æ€è·¯ï¼š</p><blockquote><p>æ±‚nçš„å¹³æ–¹æ ¹xï¼Œåˆ™é¦–å…ˆæƒ³åˆ°çš„æ˜¯å¯ä¸å¯ä»¥ä»1å¼€å§‹ï¼Œåˆ†åˆ«æ±‚1ã€2ã€3ç­‰çš„å¹³æ–¹ï¼Œçœ‹æ˜¯å¦ç­‰äºnã€‚è¿™é‡Œå°±æœ‰ä¸ªé—®é¢˜æˆ‘ä¸ºä»€ä¹ˆé¦–å…ˆä»1å¼€å§‹ï¼Œè€Œä¸”ä¸ºä»€ä¹ˆå„ä¸ªæ•°çš„æ­¥é•¿ä¸º1ï¼Ÿä¹Ÿå°±æ˜¯è¯´æˆ‘ä»¬åº”è¯¥ä»å“ªé‡Œå¼€å§‹å»è¯•ï¼Œæ¯æ¬¡å»è¯•æ—¶ï¼Œå„ä¸ªæ•°çš„æ­¥é•¿åº”è¯¥æ€ä¹ˆé€‰ï¼Ÿ</p></blockquote><p>ä»ä¸Šé¢çš„åˆ†æä¸­å¾—å‡ºæ±‚nçš„å¹³æ–¹æ ¹å…¶å®å°±æ˜¯ä»å°äºnçš„æ•°ä¸­æ‰¾åˆ°xï¼Œä½¿x*xç­‰äºnï¼Œè¿™å°±å˜æˆäº†ä¸€ä¸ªæŸ¥æ‰¾çš„é—®é¢˜ï¼Œè€Œä¸”æ˜¯åœ¨æœ‰åºæ•°æ®é›†ä¸­æŸ¥æ‰¾ï¼Œåˆ™æœ€å®¹æ˜“æƒ³åˆ°çš„å°±æ˜¯äºŒåˆ†æŸ¥æ‰¾ï¼Œåˆ™ä»å“ªé‡Œå¼€å§‹å»è¯•ï¼Œæ¯æ¬¡å»è¯•æ—¶ï¼Œå„ä¸ªæ•°çš„æ­¥é•¿é—®é¢˜å°±éƒ½è§£å†³äº†ã€‚</p><p>ä¸‹é¢çœ‹ä¸‹äºŒåˆ†æŸ¥æ‰¾çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">binarySearch</span><span class="params">(<span class="keyword">int</span>[] arr, <span class="keyword">int</span> target)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> low = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> high = arr.length-<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high)&#123;</span><br><span class="line">        <span class="keyword">int</span> mid = (low + high) / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (target &gt; arr[mid])&#123;</span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (target &lt; arr[mid])&#123;</span><br><span class="line">            high = mid - <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> mid;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><span id="more"></span><h2 id="ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°å¹³æ–¹æ ¹çš„èŒƒå›´ç„¶åé€’å¢æ­¥é•¿"><a href="#ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°å¹³æ–¹æ ¹çš„èŒƒå›´ç„¶åé€’å¢æ­¥é•¿" class="headerlink" title="ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°å¹³æ–¹æ ¹çš„èŒƒå›´ç„¶åé€’å¢æ­¥é•¿"></a>ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°å¹³æ–¹æ ¹çš„èŒƒå›´ç„¶åé€’å¢æ­¥é•¿</h2><p>å¯¹äºä¸€ä¸ªæ•°çš„å¹³æ–¹æ ¹èƒ½å¤Ÿæ‰¾åˆ°è¯¥è·Ÿçš„èŒƒå›´ï¼Œå³_x<em>x &lt; n &lt; y</em>y_ï¼Œåˆ™nçš„å¹³æ–¹æ ¹åœ¨xå’Œyä¹‹é—´ï¼Œä¸”_x+1=y_ã€‚<br>æ‰¾åˆ°å¹³æ–¹æ ¹æ‰€åœ¨çš„åŒºåŸŸä¹‹åï¼ŒæŠŠæ‰€è¦ä¿ç•™çš„<em>ç²¾åº¦çš„å¹³æ–¹æ ¹</em>åšä¸ºæ­¥é•¿å¯¹xè¿›è¡Œé€’å¢ï¼Œç›´åˆ°_|n-x*x|&lt;0.0001(ç²¾åº¦)_ä¸ºæ­¢ã€‚</p><p>ä¾‹å¦‚æ±‚12çš„å¹³æ–¹æ ¹ï¼Œç²¾åº¦ä¸ºå°æ•°ç‚¹å2ä½ã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">sqrtByInc</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">double</span> precision)</span></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> low = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">int</span> high = n;</span><br><span class="line">    <span class="keyword">int</span> mid = (low + high) / <span class="number">2</span>;</span><br><span class="line">    <span class="comment">// äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°å¹³æ–¹æ ¹çš„åŒºåŸŸ</span></span><br><span class="line">    <span class="keyword">while</span> (low &lt;= high)&#123;</span><br><span class="line">        <span class="keyword">if</span> (mid * mid &gt; n)&#123;</span><br><span class="line">            high = mid - <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> <span class="keyword">if</span> (mid * mid &lt; n)&#123;</span><br><span class="line">            <span class="keyword">if</span> ((mid+<span class="number">1</span>)*(mid+<span class="number">1</span>) &gt; n)&#123;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            low = mid + <span class="number">1</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mid = (low + high) / <span class="number">2</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ç²¾åº¦çš„å¹³æ–¹æ ¹åšä¸ºæ­¥é•¿</span></span><br><span class="line">    <span class="keyword">double</span> r = mid;</span><br><span class="line">    <span class="keyword">while</span> (Math.abs(n-r*r) &gt; <span class="number">0.0001</span>)&#123;</span><br><span class="line">        <span class="keyword">if</span> (r * r &lt; n)&#123;</span><br><span class="line">            r += <span class="number">0.01</span>;</span><br><span class="line">            r = BigDecimal.valueOf(r).setScale(<span class="number">2</span>, RoundingMode.HALF_UP).doubleValue();</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> r;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ”¹è¿›"><a href="#æ”¹è¿›" class="headerlink" title="æ”¹è¿›"></a>æ”¹è¿›</h2><p>ä¸Šé¢çš„æ–¹æ³•åªæ˜¯ç”¨äºŒåˆ†æŸ¥æ‰¾æ‰¾åˆ°å¹³æ–¹æ ¹çš„èŒƒå›´ï¼Œç„¶åé€’å¢æ­¥é•¿è¿›è¡Œå°è¯•ï¼Œè™½ç„¶èƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°æ ¹çš„èŒƒå›´ï¼Œä½†æ˜¯é€’å¢æ­¥é•¿å°†æ˜¯ä¸€ä¸ªæ¼«é•¿çš„ç­‰å¾…ã€‚</p><p>ç”±_|n-x*x|&lt;0.0001(ç²¾åº¦)_å¯å¾—nçš„å¹³æ–¹æ ¹å‡å»xå°äº0.01ï¼Œnçš„å¹³æ–¹æ ¹å’Œxéƒ½æ˜¯æ ¹çš„å€™é€‰è€…ï¼Œåˆ™åªè¦åªè¦ä¸¤ä¸ªå€™é€‰è€…çš„å·®å€¼å°äº0.01ï¼Œåˆ™xå°±æ˜¯æ‰€è¦æ±‚çš„å¹³æ–¹æ ¹ã€‚è¿™æ ·å°±å¯ä»¥ç›´æ¥ä½¿ç”¨äºŒåˆ†æŸ¥æ‰¾è¿›è¡ŒæŸ¥æ‰¾ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> String <span class="title">sqrt</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">double</span> precision)</span></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> start = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">double</span> end = (<span class="keyword">double</span>) n;</span><br><span class="line">    <span class="keyword">double</span> last = end;</span><br><span class="line">    <span class="keyword">double</span> mid = (start + end) / <span class="number">2.0</span>;</span><br><span class="line">    <span class="keyword">while</span> (Math.abs(last - mid) &gt; precision)&#123;</span><br><span class="line">        <span class="keyword">if</span> (mid * mid &gt; n)&#123;</span><br><span class="line">            end = mid;</span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            start = mid;</span><br><span class="line">        &#125;</span><br><span class="line">        last = mid;</span><br><span class="line">        mid = (start + end) / <span class="number">2.0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    DecimalFormat df = <span class="keyword">new</span> DecimalFormat(<span class="string">&quot;0.00&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> df.format(mid);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è¿­ä»£è®¡ç®—å¹³æ–¹æ ¹"><a href="#è¿­ä»£è®¡ç®—å¹³æ–¹æ ¹" class="headerlink" title="è¿­ä»£è®¡ç®—å¹³æ–¹æ ¹"></a>è¿­ä»£è®¡ç®—å¹³æ–¹æ ¹</h2><p>å¯¹äºè¿™ç§æ•°å­¦ç±»å‹çš„é—®é¢˜ï¼Œä½¿ç”¨æ•°å­¦å…¬å¼åº”è¯¥æ˜¯æœ€å¿«çš„ã€‚æ±‚nçš„å¹³æ–¹æ ¹æœ‰ä¸€ä¸ªå…¬å¼å¯ä»¥ä½¿ç”¨ï¼Œå«ç‰›é¡¿è¿­ä»£æ³•ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">double</span> <span class="title">SqrtByNewton</span><span class="params">(<span class="keyword">int</span> n, <span class="keyword">double</span> precision)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">double</span> val = n; <span class="comment">//æœ€ç»ˆ</span></span><br><span class="line">    <span class="keyword">double</span> last; <span class="comment">//ä¿å­˜ä¸Šä¸€ä¸ªè®¡ç®—çš„å€¼</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">        last = val;</span><br><span class="line">        val =(val + n/val) / <span class="number">2</span>;</span><br><span class="line">    &#125;<span class="keyword">while</span>(Math.abs(val-last) &gt; precision);</span><br><span class="line">    <span class="keyword">return</span> val;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> algorithm </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ•°æ®ç»“æ„ </tag>
            
            <tag> ç®—æ³• </tag>
            
            <tag> å¹³æ–¹æ ¹ </tag>
            
            <tag> mä½å°æ•° </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSä¸­LightWeightGSetä¸HashMapç»“æ„è§£æ</title>
      <link href="/HDFS%E4%B8%ADLightWeightGSet%E4%B8%8EHashMap%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90.html"/>
      <url>/HDFS%E4%B8%ADLightWeightGSet%E4%B8%8EHashMap%E7%BB%93%E6%9E%84%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p>çœ‹è§HashMapæˆ‘å°±æƒ³èµ·äº†ä¸€é“HashMapçš„é¢è¯•é¢˜ï¼Œå…ˆæ¥ç…ä¸‹è¿™ä¸ªé¢è¯•é¢˜ï¼š<br>HashMapå’ŒHashTableçš„åŒºåˆ«ï¼Ÿ</p><ol><li>HashMapæ˜¯éçº¿ç¨‹å®‰å…¨çš„ï¼ŒHashTableæ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</li><li>HashMapçš„é”®å€¼éƒ½å¯ä»¥ä¸ºnullï¼ŒHashTableåˆ™ä¸è¡Œã€‚</li><li>HashMapæ˜¯éçº¿ç¨‹å®‰å…¨çš„åˆ™æ•ˆç‡ä¼šé«˜äºHashTableï¼Œè¿™ä¹Ÿæ˜¯ä¸€èˆ¬éƒ½ç”¨HashMapçš„åŸå› ã€‚</li></ol><p>æ·±å…¥çš„é—®é¢˜ï¼ŒJavaä¸­å¦ä¸€ä¸ªçº¿ç¨‹å®‰å…¨çš„ä¸HashMapç±»ä¼¼çš„ç±»æ˜¯ï¼Ÿ<br>ConcurrentHashMapä¹Ÿæ˜¯ä¸€ä¸ªçº¿ç¨‹å®‰å…¨ç±»ï¼Œä¸HashTableä¸åŒçš„æ˜¯æä¾›çš„é”æœºåˆ¶ä¸ä¸€æ ·(ä¸SynchronizedMapä¹Ÿä¸ä¸€æ ·)<br>HashTableä¸­é‡‡ç”¨çš„é”æœºåˆ¶æ˜¯ä¸€æ¬¡é”ä½æ•´ä¸ªhashè¡¨ï¼Œä»è€ŒåŒä¸€æ—¶åˆ»åªèƒ½ç”±ä¸€ä¸ªçº¿ç¨‹å¯¹å…¶è¿›è¡Œæ“ä½œï¼›<br>ConcurrentHashMapæ˜¯ä¸€æ¬¡é”ä½ä¸€ä¸ªæ¡¶ï¼Œhashè¡¨é»˜è®¤æ˜¯16ä¸ªæ¡¶ï¼Œè¯¸å¦‚getã€putã€removeç­‰æ“ä½œåªé”ä½å½“å‰éœ€è¦çš„æ¡¶ã€‚</p><p>ä¸Šé¢ç®€å•å›å¿†äº†ä¸‹HashMapï¼Œä¸‹é¢è¯´ä¸‹LightWeightGSetï¼ŒLightWeightGSetæ˜¯HDFSä¸­çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œç±»ä¼¼HashMapï¼Œç”¨æ¥å­˜å‚¨blockå’Œå‰¯æœ¬æ‰€åœ¨dnçš„æ˜ å°„ï¼Œæ˜¯Namenodeä¸­å­˜å‚¨å…¨éƒ¨æ•°æ®å—ä¿¡æ¯ç±»BlocksMapçš„ä¸€ä¸ªé‡è¦çš„æ•°æ®ç»“æ„ã€‚</p><p>LightWeightGSetä½¿ç”¨æ•°ç»„æ¥å­˜å‚¨å…ƒç´ ï¼Œä½¿ç”¨é“¾è¡¨æ¥è§£å†³å†²çªï¼Œéçº¿ç¨‹å®‰å…¨ã€‚<em>è¿™ç‚¹ä¸HashMapç±»ä¼¼ï¼Œä½†æ˜¯LightWeightGSetä¸­æ•°ç»„çš„å¤§å°ä¸ä¼šå‘ç”Ÿå˜åŒ–ï¼Œè€ŒHashMapä¼šæ ¹æ®å…¶å†…éƒ¨ç©ºé—´åˆ©ç”¨ç‡å¯¹æ•°ç»„çš„å¤§å°è¿›è¡Œå†åˆ†é…ï¼Œè¿›è¡Œé‡æ–°å“ˆå¸Œåˆ†åŒº</em>ã€‚å†è€…å°±æ˜¯LightWeightGSetä¸èƒ½å­˜nullå…ƒç´ ã€‚</p><span id="more"></span><p>ä¸‹é¢ä»æºç è§’åº¦å¯¹æ¯”ä¸€ä¸‹LightWeightGSetå’ŒHashMapçš„åŒºåˆ«ã€‚</p><h2 id="LightWeightGSetå’ŒHashMapçš„åˆå§‹åŒ–"><a href="#LightWeightGSetå’ŒHashMapçš„åˆå§‹åŒ–" class="headerlink" title="LightWeightGSetå’ŒHashMapçš„åˆå§‹åŒ–"></a>LightWeightGSetå’ŒHashMapçš„åˆå§‹åŒ–</h2><h3 id="æ¥å£å®ç°"><a href="#æ¥å£å®ç°" class="headerlink" title="æ¥å£å®ç°"></a>æ¥å£å®ç°</h3><p>LightWeightGSetå®ç°äº†GSetæ¥å£ï¼ŒHashMapå®ç°äº†Mapæ¥å£ã€‚å…¶ä¸­GSetå’ŒMapæ¥å£åˆ†åˆ«å®šä¹‰äº†é”®æ˜ å°„åˆ°å€¼çš„è§„åˆ™ã€‚</p><h3 id="åˆå§‹åŒ–"><a href="#åˆå§‹åŒ–" class="headerlink" title="åˆå§‹åŒ–"></a>åˆå§‹åŒ–</h3><p>LightWeightGSetåªæœ‰ä¸€ä¸ªæ„é€ å‡½æ•°ï¼Œåˆå§‹åŒ–æ—¶ä¼ å…¥æ•°ç»„çš„å¤§å°ï¼Œåœ¨BlocksMapä¸­åˆå§‹åŒ–ä»£ç å¦‚ä¸‹ï¼š<br><code>blocks = new LightWeightGSet&lt;Block, BlockInfo&gt;(capacity)</code></p><p>HashMapæä¾›äº†ä¸‰ä¸ªæ„é€ å‡½æ•°ï¼š<br>HashMap()ï¼šæ„é€ ä¸€ä¸ªå…·æœ‰é»˜è®¤åˆå§‹å®¹é‡(16)å’Œé»˜è®¤loadFactor(0.75)çš„ç©ºHashMapã€‚<br>HashMap(int initialCapacity)ï¼šæ„é€ ä¸€ä¸ªå¸¦æŒ‡å®šåˆå§‹å®¹é‡å’Œé»˜è®¤loadFactor(0.75)çš„ç©ºHashMapã€‚<br>HashMap(int initialCapacity, float loadFactor)ï¼šæ„é€ ä¸€ä¸ªå¸¦æŒ‡å®šåˆå§‹å®¹é‡å’ŒloadFactorçš„ç©ºHashMapã€‚</p><p>åœ¨è¿™é‡Œæåˆ°äº†ä¸¤ä¸ªå‚æ•°ï¼šåˆå§‹å®¹é‡ï¼ŒloadFactorã€‚è¿™ä¸¤ä¸ªå‚æ•°æ˜¯å½±å“HashMapæ€§èƒ½çš„é‡è¦å‚æ•°ï¼Œå…¶ä¸­å®¹é‡è¡¨ç¤ºå“ˆå¸Œè¡¨ä¸­æ¡¶çš„æ•°é‡ï¼Œåˆå§‹å®¹é‡æ˜¯åˆ›å»ºå“ˆå¸Œè¡¨æ—¶çš„å®¹é‡ï¼Œ<em>loadFactoræ˜¯å“ˆå¸Œè¡¨åœ¨å…¶å®¹é‡è‡ªåŠ¨å¢åŠ ä¹‹å‰å¯ä»¥è¾¾åˆ°å¤šæ»¡çš„ä¸€ç§å°ºåº¦</em>ï¼Œå®ƒè¡¡é‡çš„æ˜¯ä¸€ä¸ªæ•£åˆ—è¡¨çš„ç©ºé—´çš„ä½¿ç”¨ç¨‹åº¦ï¼ŒloadFactorè¶Šå¤§è¡¨ç¤ºæ•£åˆ—è¡¨çš„è£…å¡«ç¨‹åº¦è¶Šé«˜ï¼Œåä¹‹æ„ˆå°ã€‚å¯¹äºä½¿ç”¨é“¾è¡¨æ³•çš„æ•£åˆ—è¡¨æ¥è¯´ï¼ŒæŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ çš„å¹³å‡æ—¶é—´æ˜¯O(1+a)ï¼Œå› æ­¤å¦‚æœè´Ÿè½½å› å­è¶Šå¤§ï¼Œå¯¹ç©ºé—´çš„åˆ©ç”¨æ›´å……åˆ†ï¼Œç„¶è€Œåæœæ˜¯æŸ¥æ‰¾æ•ˆç‡çš„é™ä½ï¼›å¦‚æœè´Ÿè½½å› å­å¤ªå°ï¼Œé‚£ä¹ˆæ•£åˆ—è¡¨çš„æ•°æ®å°†è¿‡äºç¨€ç–ï¼Œå¯¹ç©ºé—´é€ æˆä¸¥é‡æµªè´¹ã€‚ç³»ç»Ÿé»˜è®¤è´Ÿè½½å› å­ä¸º0.75ï¼Œä¸€èˆ¬æƒ…å†µä¸‹æˆ‘ä»¬æ˜¯æ— éœ€ä¿®æ”¹çš„ã€‚</p><h2 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h2><p>æˆ‘ä»¬çŸ¥é“åœ¨Javaä¸­æœ€å¸¸ç”¨çš„ä¸¤ç§ç»“æ„æ˜¯æ•°ç»„å’Œæ¨¡æ‹ŸæŒ‡é’ˆ(å¼•ç”¨)ï¼Œå‡ ä¹æ‰€æœ‰çš„æ•°æ®ç»“æ„éƒ½å¯ä»¥åˆ©ç”¨è¿™ä¸¤ç§æ¥ç»„åˆå®ç°ï¼ŒHashMapå’ŒLightWeightGSetå°±æ˜¯å¦‚æ­¤ã€‚</p><p>æ•°ç»„çš„ç‰¹ç‚¹ï¼šè¿ç»­ç©ºé—´ï¼Œå¯»å€è¿…é€Ÿï¼Œä½†æ˜¯åœ¨åˆ é™¤æˆ–è€…æ·»åŠ å…ƒç´ çš„æ—¶å€™éœ€è¦æœ‰è¾ƒå¤§å¹…åº¦ç§»åŠ¨ï¼Œ<em>æ‰€ä»¥æŸ¥è¯¢é€Ÿåº¦å¿«ï¼Œå¢åˆ è¾ƒæ…¢</em>ã€‚<br>é“¾è¡¨æ­£å¥½ç›¸åï¼Œç”±äºç©ºé—´ä¸è¿ç»­ï¼Œå¯»å€å›°éš¾ï¼Œå¢åˆ å…ƒç´ åªéœ€ä¿®æ”¹æŒ‡é’ˆï¼Œ<em>æ‰€ä»¥æŸ¥è¯¢æ…¢ï¼Œå¢åˆ å¿«</em>ã€‚</p><h3 id="HashMapæ•°æ®ç»“æ„"><a href="#HashMapæ•°æ®ç»“æ„" class="headerlink" title="HashMapæ•°æ®ç»“æ„"></a>HashMapæ•°æ®ç»“æ„</h3><p>å®é™…ä¸ŠHashMapå’ŒLightWeightGSetéƒ½æ˜¯ä¸€ä¸ªâ€œé“¾è¡¨æ•£åˆ—â€ï¼Œå¦‚ä¸‹æ˜¯HashMapæ•°æ®ç»“æ„ï¼š<br><img src="/blogimgs/LightWeightGSet%E4%B8%8EHashMap/hashmap%E7%BB%93%E6%9E%84.png" alt="HashMapæ•°æ®ç»“æ„" title="HashMapæ•°æ®ç»“æ„"><br>ä»ä¸Šå›¾æˆ‘ä»¬å¯ä»¥çœ‹å‡ºHashMapåº•å±‚å®ç°è¿˜æ˜¯æ•°ç»„ï¼Œåªæ˜¯æ•°ç»„çš„æ¯ä¸€é¡¹éƒ½æ˜¯ä¸€æ¡é“¾ã€‚å…¶ä¸­å‚æ•°initialCapacityå°±ä»£è¡¨äº†è¯¥æ•°ç»„çš„é•¿åº¦ã€‚ä¸‹é¢ä¸ºHashMapæ„é€ å‡½æ•°çš„æºç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">HashMap</span><span class="params">(<span class="keyword">int</span> initialCapacity, <span class="keyword">float</span> loadFactor)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//åˆå§‹å®¹é‡ä¸èƒ½&lt;0</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &lt; <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal initial capacity: &quot;</span></span><br><span class="line">                + initialCapacity);</span><br><span class="line">    <span class="comment">//åˆå§‹å®¹é‡ä¸èƒ½ &gt; æœ€å¤§å®¹é‡å€¼ï¼ŒHashMapçš„æœ€å¤§å®¹é‡å€¼ä¸º2^30</span></span><br><span class="line">    <span class="keyword">if</span> (initialCapacity &gt; MAXIMUM_CAPACITY)</span><br><span class="line">        initialCapacity = MAXIMUM_CAPACITY;</span><br><span class="line">    <span class="comment">//è´Ÿè½½å› å­ä¸èƒ½ &lt; 0</span></span><br><span class="line">    <span class="keyword">if</span> (loadFactor &lt;= <span class="number">0</span> || Float.isNaN(loadFactor))</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Illegal load factor: &quot;</span></span><br><span class="line">                + loadFactor);</span><br><span class="line">    <span class="comment">// è®¡ç®—å‡ºå¤§äº initialCapacity çš„æœ€å°çš„ 2 çš„ n æ¬¡æ–¹å€¼ã€‚</span></span><br><span class="line">    <span class="keyword">int</span> capacity = <span class="number">1</span>;</span><br><span class="line">    <span class="comment">// è¿™é‡Œä¿è¯äº†tableæ•°ç»„çš„é•¿åº¦æ˜¯2çš„næ¬¡æ–¹ï¼Œè¿™æ ·ä¼šå‡ºç°ä¼ å…¥çš„initialCapacityæ¯”å®é™…</span></span><br><span class="line">    <span class="keyword">while</span> (capacity &lt; initialCapacity)     </span><br><span class="line">        <span class="comment">// åˆ†é…çš„capacityå°ã€‚è¿™æ ·çš„å¥½å¤„æ˜¯åœ¨åˆ©ç”¨hashå¯»å€æ—¶æ–¹ä¾¿ï¼Œå¿«é€Ÿï¼Œä¸”keyåˆ†å¸ƒå‡åŒ€</span></span><br><span class="line">        capacity &lt;&lt;= <span class="number">1</span>;                    </span><br><span class="line">    <span class="keyword">this</span>.loadFactor = loadFactor;</span><br><span class="line">    <span class="comment">//è®¾ç½®HashMapçš„å®¹é‡æé™ï¼Œå½“HashMapçš„å®¹é‡è¾¾åˆ°è¯¥æé™æ—¶å°±ä¼šè¿›è¡Œæ‰©å®¹æ“ä½œ</span></span><br><span class="line">    threshold = (<span class="keyword">int</span>) (capacity * loadFactor);</span><br><span class="line">    <span class="comment">//åˆå§‹åŒ–tableæ•°ç»„</span></span><br><span class="line">    table = <span class="keyword">new</span> Entry[capacity];</span><br><span class="line">    init();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»æºç ä¸­å¯ä»¥çœ‹å‡ºï¼Œæ¯æ¬¡æ–°å»ºä¸€ä¸ªHashMapæ—¶ï¼Œéƒ½ä¼šåˆå§‹åŒ–ä¸€ä¸ªtableæ•°ç»„ã€‚tableæ•°ç»„çš„å…ƒç´ ä¸ºEntryèŠ‚ç‚¹ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; <span class="keyword">implements</span> <span class="title">Map</span>.<span class="title">Entry</span>&lt;<span class="title">K</span>,<span class="title">V</span>&gt; </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> K key;</span><br><span class="line">    V value;</span><br><span class="line">    Entry&lt;K,V&gt; next;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> hash;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Creates new entry.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Entry(<span class="keyword">int</span> h, K k, V v, Entry&lt;K,V&gt; n) &#123;</span><br><span class="line">        value = v;</span><br><span class="line">        next = n;</span><br><span class="line">        key = k;</span><br><span class="line">        hash = h;</span><br><span class="line">    &#125;</span><br><span class="line">    .......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶ä¸­Entryä¸ºHashMapçš„å†…éƒ¨ç±»ï¼Œå®ƒåŒ…å«äº†é”®keyã€å€¼valueã€ä¸‹ä¸€ä¸ªèŠ‚ç‚¹nextï¼Œä»¥åŠhashå€¼ï¼ˆè¿™ä¸ªhashå€¼æ˜¯keyçš„hashèµ‹å€¼çš„ï¼‰ï¼Œè¿™æ˜¯éå¸¸é‡è¦çš„ï¼Œæ­£æ˜¯ç”±äºEntryæ‰æ„æˆäº†tableæ•°ç»„çš„é¡¹ä¸ºé“¾è¡¨ã€‚</p><h3 id="LightWeightGSetæ•°æ®ç»“æ„"><a href="#LightWeightGSetæ•°æ®ç»“æ„" class="headerlink" title="LightWeightGSetæ•°æ®ç»“æ„"></a>LightWeightGSetæ•°æ®ç»“æ„</h3><p>å…ˆæ¥çœ‹ä¸‹LightWeightGSetçš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">LightWeightGSet</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> recommended_length)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> actual = actualArrayLength(recommended_length);</span><br><span class="line">  ...</span><br><span class="line">  entries = <span class="keyword">new</span> LinkedElement[actual];</span><br><span class="line">  hash_mask = entries.length - <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç”±ä»£ç å¯ä»¥çœ‹å‡ºLightWeightGSetçš„æ•°æ®ç»“æ„å’ŒHashMapç±»ä¼¼ï¼ŒLightWeightGSetåˆå§‹åŒ–æ—¶ä¼šåˆ›å»ºä¸€ä¸ªLinkedElementç±»å‹çš„æ•°ç»„ï¼ŒLinkedElementæ˜¯LightWeightGSetçš„å†…éƒ¨æ¥å£ï¼Œç”±æ­¤è§£å†³äº†å…ƒç´ çš„å†²çªé—®é¢˜ï¼Œä½¿å†²çªçš„å…ƒç´ å½¢æˆä¸€ä¸ªé“¾è¡¨ã€‚<em>BlocksMapçš„ç»“æ„ä¸­é€šè¿‡BlockInfoå®ç°LinkedElementæ¥å£ï¼Œé€šè¿‡nextLinkedElementè¿æ¥ä¸‹ä¸€ä¸ªBlockInfo</em>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">interface</span> <span class="title">LinkedElement</span> </span>&#123;</span><br><span class="line">  <span class="comment">/** Set the next element. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setNext</span><span class="params">(LinkedElement next)</span></span>;</span><br><span class="line">  <span class="comment">/** Get the next element. */</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> LinkedElement <span class="title">getNext</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>LightWeightGSetä¸HashMapç±»ä¼¼ï¼Œéƒ½æ˜¯åˆ›å»ºä¸€ä¸ªæ•°ç»„ï¼ŒLightWeightGSetçš„æ•°ç»„ä¸­å­˜å‚¨LinkedElementç±»å‹çš„å…ƒç´ ï¼ŒHashMapçš„æ•°ç»„ä¸­å­˜å‚¨Entryç±»å‹çš„å…ƒç´ ï¼Œè¿™äº›å…ƒç´ éƒ½ä¼šå°†keyå†²çªçš„å…ƒç´ é€šè¿‡å¼•ç”¨è¿æˆä¸€ä¸ªé“¾è¡¨ã€‚</p><p>ä¸Šé¢ç®€å•åˆ†æäº†LightWeightGSetå’ŒHashMapçš„æ•°æ®ç»“æ„ï¼Œä¸‹é¢å°†æ¢è®¨ä»–ä»¬æ˜¯å¦‚ä½•å®ç°å¿«é€Ÿå­˜å–çš„ã€‚</p><h2 id="å­˜å‚¨å®ç°put"><a href="#å­˜å‚¨å®ç°put" class="headerlink" title="å­˜å‚¨å®ç°put"></a>å­˜å‚¨å®ç°put</h2><p>åˆ†åˆ«çœ‹ä¸‹LightWeightGSetå’ŒHashMapçš„putæ–¹æ³•<br><code>LightWeightGSet.put</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// LightWeightGSet</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">put</span><span class="params">(<span class="keyword">final</span> E element)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//validate element</span></span><br><span class="line">  <span class="keyword">if</span> (element == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;Null element is not supported.&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!(element <span class="keyword">instanceof</span> LinkedElement)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HadoopIllegalArgumentException(</span><br><span class="line">        <span class="string">&quot;!(element instanceof LinkedElement), element.getClass()=&quot;</span></span><br><span class="line">        + element.getClass());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> LinkedElement e = (LinkedElement)element;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//find index</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> index = getIndex(element);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//remove if it already exists</span></span><br><span class="line">  <span class="keyword">final</span> E existing = remove(index, element);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//insert the element to the head of the linked list</span></span><br><span class="line">  modification++;</span><br><span class="line">  size++;</span><br><span class="line">  e.setNext(entries[index]);</span><br><span class="line">  entries[index] = e;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> existing;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>HashMap.put</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">put</span><span class="params">(K key, V value)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//å½“keyä¸ºnullï¼Œè°ƒç”¨putForNullKeyæ–¹æ³•ï¼Œä¿å­˜nullä¸tableç¬¬ä¸€ä¸ªä½ç½®ä¸­ï¼Œè¿™æ˜¯HashMapå…è®¸ä¸ºnullçš„åŸå› </span></span><br><span class="line">        <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">            <span class="keyword">return</span> putForNullKey(value);</span><br><span class="line">        <span class="comment">//è®¡ç®—keyçš„hashå€¼</span></span><br><span class="line">        <span class="keyword">int</span> hash = hash(key.hashCode());           </span><br><span class="line">        <span class="comment">//è®¡ç®—key hash å€¼åœ¨ table æ•°ç»„ä¸­çš„ä½ç½®</span></span><br><span class="line">        <span class="keyword">int</span> i = indexFor(hash, table.length); </span><br><span class="line">        <span class="comment">//ä»iå‡ºå¼€å§‹è¿­ä»£ e,æ‰¾åˆ° key ä¿å­˜çš„ä½ç½®</span></span><br><span class="line">        <span class="keyword">for</span> (Entry&lt;K, V&gt; e = table[i]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">            Object k;</span><br><span class="line">            <span class="comment">//åˆ¤æ–­è¯¥æ¡é“¾ä¸Šæ˜¯å¦æœ‰hashå€¼ç›¸åŒçš„(keyç›¸åŒ)</span></span><br><span class="line">            <span class="comment">//è‹¥å­˜åœ¨ç›¸åŒï¼Œåˆ™ç›´æ¥è¦†ç›–valueï¼Œè¿”å›æ—§value</span></span><br><span class="line">            <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;</span><br><span class="line">                V oldValue = e.value;    <span class="comment">//æ—§å€¼ = æ–°å€¼</span></span><br><span class="line">                e.value = value;</span><br><span class="line">                e.recordAccess(<span class="keyword">this</span>);</span><br><span class="line">                <span class="keyword">return</span> oldValue;     <span class="comment">//è¿”å›æ—§å€¼            </span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">//ä¿®æ”¹æ¬¡æ•°å¢åŠ 1</span></span><br><span class="line">        modCount++;</span><br><span class="line">        <span class="comment">//å°†keyã€valueæ·»åŠ è‡³iä½ç½®å¤„       </span></span><br><span class="line">        addEntry(hash, key, value, i);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ä¿å­˜â€œbucketIndexâ€ä½ç½®çš„å€¼åˆ°â€œeâ€ä¸­</span></span><br><span class="line">    Entry&lt;K,V&gt; e = table[bucketIndex];</span><br><span class="line">    <span class="comment">// è®¾ç½®â€œbucketIndexâ€ä½ç½®çš„å…ƒç´ ä¸ºâ€œæ–°Entryâ€ï¼Œ</span></span><br><span class="line">    <span class="comment">// è®¾ç½®â€œeâ€ä¸ºâ€œæ–°Entryçš„ä¸‹ä¸€ä¸ªèŠ‚ç‚¹â€</span></span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;K,V&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">// è‹¥HashMapçš„å®é™…å¤§å° ä¸å°äº â€œé˜ˆå€¼â€ï¼Œåˆ™è°ƒæ•´HashMapçš„å¤§å°</span></span><br><span class="line">    <span class="keyword">if</span> (size++ &gt;= threshold)</span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸¤ä¸ªputéƒ½æ˜¯å…ˆå¯¹elementè¿›è¡Œæ ¡éªŒï¼Œç„¶åæ‹¿åˆ°keyå¯¹åº”æ•°ç»„çš„indexï¼Œå…¶indexéƒ½æ˜¯å¯¹keyå–hashcodeå€¼ä¸<em>è¿ç®—å› </em>å­è¿›è¡Œ&amp;æ“ä½œå¾—å‡ºçš„ã€‚ä¸¤éƒ¨åˆ†ä»£ç å¦‚ä¸‹ï¼š<br><em>LightWeightGSet</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getIndex</span><span class="params">(<span class="keyword">final</span> K key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> key.hashCode() &amp; hash_mask;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// BlockInfo.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Super implementation is sufficient</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">super</span>.hashCode();</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// Block.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">hashCode</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//GenerationStamp is IRRELEVANT and should not be used here</span></span><br><span class="line">  <span class="keyword">return</span> (<span class="keyword">int</span>)(blockId^(blockId&gt;&gt;&gt;<span class="number">32</span>));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>HashMap</em></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">hash</span><span class="params">(<span class="keyword">int</span> h)</span> </span>&#123; </span><br><span class="line">h ^= (h &gt;&gt;&gt; <span class="number">20</span>) ^ (h &gt;&gt;&gt; <span class="number">12</span>); </span><br><span class="line"><span class="keyword">return</span> h ^ (h &gt;&gt;&gt; <span class="number">7</span>) ^ (h &gt;&gt;&gt; <span class="number">4</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">indexFor</span><span class="params">(<span class="keyword">int</span> h, <span class="keyword">int</span> length)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> h &amp; (length-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œé‡ç‚¹è¯´ä¸‹<em>è¿ç®—å› å­</em>ï¼ŒLightWeightGSetçš„è¿ç®—å› å­æ˜¯<em>hash_mask</em>ï¼Œåœ¨æ„é€ å‡½æ•°ä¸­èµ‹å€¼ï¼Œ<code>hash_mask = entries.length - 1</code>ï¼Œæ˜¯entriesæ•°ç»„é•¿åº¦å‡ä¸€ã€‚HashMapçš„è¿ç®—å› å­ä¹Ÿæ˜¯entryæ•°ç»„çš„é•¿åº¦å‡ä¸€ã€‚ä¹‹æ‰€ä»¥è¿™æ ·æ˜¯ä¸ºäº†è®©æ•°æ®åœ¨LightWeightGSetå’ŒHashMapä¸­çš„åˆ†å¸ƒå°½é‡å‡åŒ€(æœ€å¥½æ¯é¡¹éƒ½åªæœ‰ä¸€ä¸ªå…ƒç´ ï¼Œè¿™æ ·å°±å¯ä»¥ç›´æ¥æ‰¾åˆ°)ï¼Œä¸èƒ½å¤ªç´§ä¹Ÿä¸èƒ½å¤ªæ¾ï¼Œå¤ªç´§ä¼šå¯¼è‡´æŸ¥è¯¢é€Ÿåº¦æ…¢ï¼Œå¤ªæ¾åˆ™æµªè´¹ç©ºé—´ã€‚</p><p>ç”±äºLightWeightGSetå’ŒHashMapåº•å±‚æ•°ç»„çš„é•¿åº¦éƒ½æ˜¯2çš„næ¬¡æ–¹ï¼ŒLightWeightGSetä¸­æ•°ç»„çš„é•¿åº¦è®¡ç®—å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">actualArrayLength</span><span class="params">(<span class="keyword">int</span> recommended)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (recommended &gt; MAX_ARRAY_LENGTH) &#123;</span><br><span class="line">    <span class="keyword">return</span> MAX_ARRAY_LENGTH;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (recommended &lt; MIN_ARRAY_LENGTH) &#123;</span><br><span class="line">    <span class="keyword">return</span> MIN_ARRAY_LENGTH;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> a = Integer.highestOneBit(recommended);</span><br><span class="line">    <span class="keyword">return</span> a == recommended? a: a &lt;&lt; <span class="number">1</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HashMapä¸­æ•°ç»„çš„é•¿åº¦è®¡ç®—ä¸º<code>capacity &lt;&lt;= 1</code>ã€‚åˆ™ä½¿ç”¨<code>h&amp;(length - 1)</code>å¯¹lengthå–æ¨¡ã€‚åŒæ—¶è¿ç®—å› å­<code>length-1</code>è¿˜æœ‰ä¸€ä¸ªéå¸¸é‡è¦çš„è´£ä»»ï¼š<strong>å‡åŒ€åˆ†å¸ƒtableæ•°æ®å’Œå……åˆ†åˆ©ç”¨ç©ºé—´</strong>ã€‚</p><blockquote><p>å½“lengthä¸º2çš„næ¬¡æ–¹æ—¶ï¼Œh&amp;(length - 1)å°±ç›¸å½“äºå¯¹lengthå–æ¨¡(åªæœ‰å…·å¤‡lengthä¸º2çš„næ¬¡æ–¹çš„æ¡ä»¶æ—¶ï¼Œæ‰æˆç«‹)ï¼Œä¹Ÿå°±æ˜¯h%lengthï¼Œè€Œä¸”é€Ÿåº¦æ¯”ç›´æ¥å–æ¨¡(%)å¿«å¾—å¤šï¼Œè¿™æ˜¯HashMapåœ¨é€Ÿåº¦ä¸Šçš„ä¸€ä¸ªä¼˜åŒ–ã€‚</p></blockquote><p>å¾—åˆ°keyå¯¹åº”çš„indexä¹‹åï¼Œè¿›è¡ŒæŸ¥é‡putï¼ŒLightWeightGSeté€šè¿‡<code>remove</code>æ–¹æ³•è¿›è¡ŒæŸ¥é‡ï¼Œå¦‚æœé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ ä¸ç­‰äºæ­¤å€¼ï¼Œåˆ™éå†è¯¥é“¾è¡¨ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰ç›¸åŒå€¼ï¼Œæœ‰åˆ™åˆ é™¤ã€‚å¦‚æœç­‰äºé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå€¼åˆ™ç›´æ¥åˆ é™¤ã€‚LightWeightGSetçš„æ’å…¥é“¾è¡¨æ“ä½œæ¯”è¾ƒç®€å•ï¼Œç›´æ¥è°ƒç”¨<code>setNext</code>æ–¹æ³•æŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ ï¼Œå¹¶å°†æ­¤å€¼æ”¾å…¥indexå¤„å°±å¯ä»¥äº†(è¿™é‡Œå®é™…å­˜å‚¨çš„æ˜¯BlockInfoå¯¹è±¡ï¼ŒBlockInfoå®ç°äº†<code>LightWeightGSet.LinkedElement</code>æ¥å£ï¼Œå¹¶ä¸”å£°æ˜äº†ä¸€ä¸ª<code>nextLinkedElement</code>å±æ€§ï¼Œè¯¥å±æ€§æ˜¯ä¸‹ä¸€ä¸ªå…ƒç´ çš„å¼•ç”¨)ã€‚removeä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> E <span class="title">remove</span><span class="params">(<span class="keyword">final</span> <span class="keyword">int</span> index, <span class="keyword">final</span> K key)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (entries[index] == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (entries[index].equals(key)) &#123;</span><br><span class="line">  <span class="comment">// ç­‰äºé“¾è¡¨ä¸­çš„ç¬¬ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    <span class="comment">//remove the head of the linked list</span></span><br><span class="line">    modification++;</span><br><span class="line">    size--;</span><br><span class="line">    <span class="comment">// å¾—åˆ°indexå¤„çš„å€¼</span></span><br><span class="line">    <span class="keyword">final</span> LinkedElement e = entries[index];</span><br><span class="line">    <span class="comment">// å°†indexæŒ‡å‘ä¸‹ä¸€ä¸ªå…ƒç´ </span></span><br><span class="line">    entries[index] = e.getNext();</span><br><span class="line">    <span class="comment">// å°†å…ƒç´ eä»é“¾è¡¨ä¸­ç§»é™¤</span></span><br><span class="line">    e.setNext(<span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> convert(e);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//head != null and key is not equal to head</span></span><br><span class="line">    <span class="comment">//search the element</span></span><br><span class="line">    <span class="comment">// å¦‚æœä¸ç­‰äºç¬¬ä¸€ä¸ªå…ƒç´ åˆ™éå†è¯¥é“¾è¡¨æŸ¥æ‰¾æ˜¯å¦æœ‰ç›¸åŒå€¼</span></span><br><span class="line">    LinkedElement prev = entries[index];</span><br><span class="line">    <span class="keyword">for</span>(LinkedElement curr = prev.getNext(); curr != <span class="keyword">null</span>; ) &#123;</span><br><span class="line">      <span class="keyword">if</span> (curr.equals(key)) &#123;</span><br><span class="line">        <span class="comment">//found the element, remove it</span></span><br><span class="line">        modification++;</span><br><span class="line">        size--;</span><br><span class="line">        prev.setNext(curr.getNext());</span><br><span class="line">        curr.setNext(<span class="keyword">null</span>);</span><br><span class="line">        <span class="keyword">return</span> convert(curr);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        prev = curr;</span><br><span class="line">        curr = curr.getNext();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//element not found</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HashMapæ˜¯åœ¨putä¸­å®ç°ï¼Œè‹¥è¯¥ä½ç½®æ²¡æœ‰å…ƒç´ ï¼Œåˆ™ç›´æ¥æ’å…¥ã€‚å¦åˆ™è¿­ä»£è¯¥å¤„å…ƒç´ é“¾è¡¨å¹¶ä¾æ­¤æ¯”è¾ƒå…¶keyçš„hashå€¼ã€‚å¦‚æœä¸¤ä¸ªhashå€¼ç›¸ç­‰ä¸”keyå€¼ç›¸ç­‰<code>(e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</code>,åˆ™ç”¨æ–°çš„Entryçš„valueè¦†ç›–åŸæ¥èŠ‚ç‚¹çš„valueã€‚å¦‚æœä¸¤ä¸ªhashå€¼ç›¸ç­‰ä½†keyå€¼ä¸ç­‰ ï¼Œåˆ™å°†è¯¥èŠ‚ç‚¹æ’å…¥è¯¥é“¾è¡¨çš„é“¾å¤´ã€‚å…·ä½“çš„å®ç°è¿‡ç¨‹è§addEntryæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addEntry</span><span class="params">(<span class="keyword">int</span> hash, K key, V value, <span class="keyword">int</span> bucketIndex)</span> </span>&#123;</span><br><span class="line">    <span class="comment">//è·å–bucketIndexå¤„çš„Entry</span></span><br><span class="line">    Entry&lt;K, V&gt; e = table[bucketIndex];</span><br><span class="line">    <span class="comment">//å°†æ–°åˆ›å»ºçš„Entryæ”¾å…¥bucketIndex ç´¢å¼•å¤„ï¼Œå¹¶è®©æ–°çš„EntryæŒ‡å‘åŸæ¥çš„Entry </span></span><br><span class="line">    table[bucketIndex] = <span class="keyword">new</span> Entry&lt;K, V&gt;(hash, key, value, e);</span><br><span class="line">    <span class="comment">//è‹¥HashMapä¸­å…ƒç´ çš„ä¸ªæ•°è¶…è¿‡æé™äº†ï¼Œåˆ™å®¹é‡æ‰©å¤§ä¸¤å€</span></span><br><span class="line">    <span class="keyword">if</span> (size++ &gt;= threshold)</span><br><span class="line">        resize(<span class="number">2</span> * table.length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œéœ€è¦æ³¨æ„ä¸€ç‚¹ï¼Œ<em>LightWeightGSetä¸ä¼šæ ¹æ®æ•°æ®çš„å¤šå°‘è€Œè¿›è¡ŒäºŒæ¬¡æ‰©å®¹</em>ï¼Œ<em>è€ŒHashMapä¼šæœ‰ä¸ªä¸´ç•Œç‚¹æ¥è§¦å‘æ‰©å®¹</em>ã€‚è¯¥ä¸´ç•Œç‚¹åœ¨å½“HashMapä¸­å…ƒç´ çš„æ•°é‡ç­‰äºtableæ•°ç»„é•¿åº¦*åŠ è½½å› å­ã€‚ä½†æ˜¯æ‰©å®¹æ˜¯ä¸€ä¸ªéå¸¸è€—æ—¶çš„è¿‡ç¨‹ï¼Œå› ä¸ºå®ƒéœ€è¦é‡æ–°è®¡ç®—è¿™äº›æ•°æ®åœ¨æ–°tableæ•°ç»„ä¸­çš„ä½ç½®å¹¶è¿›è¡Œå¤åˆ¶å¤„ç†ã€‚æ‰€ä»¥å¦‚æœæˆ‘ä»¬å·²ç»é¢„çŸ¥HashMapä¸­å…ƒç´ çš„ä¸ªæ•°ï¼Œé‚£ä¹ˆé¢„è®¾å…ƒç´ çš„ä¸ªæ•°èƒ½å¤Ÿæœ‰æ•ˆçš„æé«˜HashMapçš„æ€§èƒ½ã€‚</p><h2 id="è¯»å–å®ç°get"><a href="#è¯»å–å®ç°get" class="headerlink" title="è¯»å–å®ç°get"></a>è¯»å–å®ç°get</h2><p>getå°±æ¯”è¾ƒç®€å•ï¼Œéƒ½æ˜¯é€šè¿‡keyçš„hashå€¼æ‰¾åˆ°åœ¨åº•å±‚æ•°ç»„çš„indexï¼Œç„¶åéå†è¯¥é“¾è¡¨æ‰¾åˆ°keyå¯¹åº”çš„valueã€‚<br><code>LightWeightGSet.get</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> E <span class="title">get</span><span class="params">(<span class="keyword">final</span> K key)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//validate key</span></span><br><span class="line">  <span class="keyword">if</span> (key == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> NullPointerException(<span class="string">&quot;key == null&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//find element</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> index = getIndex(key);</span><br><span class="line">  <span class="keyword">for</span>(LinkedElement e = entries[index]; e != <span class="keyword">null</span>; e = e.getNext()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (e.equals(key)) &#123;</span><br><span class="line">      <span class="keyword">return</span> convert(e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//element not found</span></span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>HashMap.get</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> V <span class="title">get</span><span class="params">(Object key)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// è‹¥ä¸ºnullï¼Œè°ƒç”¨getForNullKeyæ–¹æ³•è¿”å›ç›¸å¯¹åº”çš„value</span></span><br><span class="line">    <span class="keyword">if</span> (key == <span class="keyword">null</span>)</span><br><span class="line">        <span class="keyword">return</span> getForNullKey();</span><br><span class="line">    <span class="comment">// æ ¹æ®è¯¥ key çš„ hashCode å€¼è®¡ç®—å®ƒçš„ hash ç   </span></span><br><span class="line">    <span class="keyword">int</span> hash = hash(key.hashCode());</span><br><span class="line">    <span class="comment">// å–å‡º table æ•°ç»„ä¸­æŒ‡å®šç´¢å¼•å¤„çš„å€¼</span></span><br><span class="line">    <span class="keyword">for</span> (Entry&lt;K, V&gt; e = table[indexFor(hash, table.length)]; e != <span class="keyword">null</span>; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        <span class="comment">//è‹¥æœç´¢çš„keyä¸æŸ¥æ‰¾çš„keyç›¸åŒï¼Œåˆ™è¿”å›ç›¸å¯¹åº”çš„value</span></span><br><span class="line">        <span class="keyword">if</span> (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k)))</span><br><span class="line">            <span class="keyword">return</span> e.value;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨HashMapä¸­èƒ½å¤Ÿæ ¹æ®keyå¿«é€Ÿçš„å–åˆ°valueé™¤äº†å’ŒHashMapçš„æ•°æ®ç»“æ„å¯†ä¸å¯åˆ†å¤–ï¼Œè¿˜å’ŒEntryæœ‰è«å¤§çš„å…³ç³»ï¼Œåœ¨å‰é¢å°±æåˆ°è¿‡ï¼Œ<em>HashMapåœ¨å­˜å‚¨è¿‡ç¨‹ä¸­å¹¶æ²¡æœ‰å°†keyï¼Œvalueåˆ†å¼€æ¥å­˜å‚¨ï¼Œè€Œæ˜¯å½“åšä¸€ä¸ªæ•´ä½“key-valueæ¥å¤„ç†çš„ï¼Œè¿™ä¸ªæ•´ä½“å°±æ˜¯Entryå¯¹è±¡</em>ã€‚åŒæ—¶valueä¹Ÿåªç›¸å½“äºkeyçš„é™„å±è€Œå·²ã€‚åœ¨å­˜å‚¨çš„è¿‡ç¨‹ä¸­ï¼Œç³»ç»Ÿæ ¹æ®keyçš„hashcodeæ¥å†³å®šEntryåœ¨tableæ•°ç»„ä¸­çš„å­˜å‚¨ä½ç½®ï¼Œåœ¨å–çš„è¿‡ç¨‹ä¸­åŒæ ·æ ¹æ®keyçš„hashcodeå–å‡ºç›¸å¯¹åº”çš„Entryå¯¹è±¡ã€‚</p><p>åœ¨LightWeightGSetä¸­ï¼Œkeyå’Œvalueéƒ½æ˜¯BlockInfoå¯¹è±¡ã€‚</p><h2 id="é™„åŠ "><a href="#é™„åŠ " class="headerlink" title="é™„åŠ "></a>é™„åŠ </h2><p>LightWeightGSetä¸­åº•å±‚æ•°ç»„çš„å¤§å°æ˜¯åœ¨æ„é€ å‡½æ•°ä¸­å›ºå®šçš„ï¼Œå¹¶ä¸”å…¶æ•°ç»„çš„å¤§å°ä¸ä¼šæ‰©å®¹ï¼Œåˆ™å…¶æ•°ç»„çš„åˆå§‹åŒ–å°±å°¤ä¸ºé‡è¦ï¼Œä¸‹é¢çœ‹ä¸‹BlocksMapè®¾ç½®çš„LightWeightGSetæ•°ç»„çš„å¤§å°ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Let t = percentage of max memory.</span></span><br><span class="line"><span class="comment"> * Let e = round(log_2 t).</span></span><br><span class="line"><span class="comment"> * Then, we choose capacity = 2^e/(size of reference),</span></span><br><span class="line"><span class="comment"> * unless it is outside the close interval [1, 2^30].</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">computeCapacity</span><span class="params">(<span class="keyword">double</span> percentage, String mapName)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> computeCapacity(Runtime.getRuntime().maxMemory(), percentage,</span><br><span class="line">      mapName);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">int</span> <span class="title">computeCapacity</span><span class="params">(<span class="keyword">long</span> maxMemory, <span class="keyword">double</span> percentage,</span></span></span><br><span class="line"><span class="params"><span class="function">    String mapName)</span> </span>&#123;</span><br><span class="line">  ... <span class="comment">// å‚æ•°æ ¡éªŒ</span></span><br><span class="line">  <span class="comment">//VM detection</span></span><br><span class="line">  <span class="comment">//See http://java.sun.com/docs/hotspot/HotSpotFAQ.html#64bit_detection</span></span><br><span class="line">  <span class="keyword">final</span> String vmBit = System.getProperty(<span class="string">&quot;sun.arch.data.model&quot;</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">//Percentage of max memory</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">double</span> percentDivisor = <span class="number">100.0</span>/percentage;</span><br><span class="line">  <span class="comment">// è¿è¡Œæ—¶çš„æœ€å¤§å†…å­˜Runtime.getRuntime().maxMemory()</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">double</span> percentMemory = maxMemory/percentDivisor;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">//compute capacity</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> e1 = (<span class="keyword">int</span>)(Math.log(percentMemory)/Math.log(<span class="number">2.0</span>) + <span class="number">0.5</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> e2 = e1 - (<span class="string">&quot;32&quot;</span>.equals(vmBit)? <span class="number">2</span>: <span class="number">3</span>);</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> exponent = e2 &lt; <span class="number">0</span>? <span class="number">0</span>: e2 &gt; <span class="number">30</span>? <span class="number">30</span>: e2;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> c = <span class="number">1</span> &lt;&lt; exponent;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> LightWeightGSet </tag>
            
            <tag> HashMap </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹StateMachineFactoryçŠ¶æ€æœº</title>
      <link href="/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BStateMachineFactory%E7%8A%B6%E6%80%81%E6%9C%BA.html"/>
      <url>/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BStateMachineFactory%E7%8A%B6%E6%80%81%E6%9C%BA.html</url>
      
        <content type="html"><![CDATA[<p>çŠ¶æ€æœºç”±ä¸€ç»„çŠ¶æ€ç»„æˆï¼Œè¿™äº›çŠ¶æ€å¤§ä½“åˆ†ä¸ºä¸‰ç±»ï¼Œåˆ†åˆ«ä¸ºåˆå§‹çŠ¶æ€ã€ä¸­é—´çŠ¶æ€å’Œæœ€ç»ˆçŠ¶æ€ã€‚çŠ¶æ€æœºé¦–å…ˆç”±åˆå§‹çŠ¶æ€Aå¼€å§‹è¿è¡Œï¼Œç»è¿‡ä¸€ç³»åˆ—çš„ä¸­é—´çŠ¶æ€ååˆ°è¾¾æœ€ç»ˆçŠ¶æ€ï¼Œå¹¶åœ¨æœ€ç»ˆçŠ¶æ€é€€å‡ºï¼Œä»è€Œå½¢æˆä¸€ä¸ªæœ‰å‘æ— ç¯å›¾ã€‚å…¶<em>çŠ¶æ€å¤„ç†çš„é€»è¾‘æ˜¯æ”¶åˆ°ä¸€ä¸ªäº‹ä»¶ï¼Œè§¦å‘çŠ¶æ€Aåˆ°çŠ¶æ€Bçš„è½¬æ¢ï¼Œè€Œè½¬æ¢æ“ä½œæ˜¯ç”±äº‹ä»¶å¯¹åº”çš„hookå®Œæˆçš„</em>ã€‚</p><p>YARNä¸­å¼•å…¥äº†äº‹ä»¶æœºåˆ¶å’ŒçŠ¶æ€æœºæœºåˆ¶ï¼Œäº‹ä»¶æœºåˆ¶å¯ä»¥åœ¨<a href="http://bigdatadecode.top/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BAsyncDispatcher%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%99%A8.html">è¿™ç¯‡æ–‡ç« </a>ä¸­äº†è§£ä¸‹äº‹ä»¶æœºåˆ¶çš„è°ƒåº¦å™¨ï¼Œæœ¬ç¯‡ä¸»è¦ä»æºç çš„è§’åº¦è§£æä¸‹çŠ¶æ€æœºæœºåˆ¶ä¸­çš„å…³é”®ç±»StateMachineFactoryï¼Œä»¥ApplicationMasterçš„çŠ¶æ€è½¬æ¢ä¸ºä¾‹ã€‚</p><span id="more"></span><h2 id="RMAppImplä¸­çš„StateMachineFactory"><a href="#RMAppImplä¸­çš„StateMachineFactory" class="headerlink" title="RMAppImplä¸­çš„StateMachineFactory"></a>RMAppImplä¸­çš„StateMachineFactory</h2><p>ApplicationMasterçš„å®ç°åœ¨RMAPPImplç±»ä¸­ï¼Œå…¶çŠ¶æ€è½¬æ¢åœ¨RMAppImplä¸­å£°æ˜ï¼Œé¦–å…ˆå£°æ˜äº†ä¸€ä¸ªé™æ€finalç±»å‹çš„å±æ€§stateMachineFactoryï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> StateMachineFactory&lt;RMAppImpl,</span><br><span class="line">                                         RMAppState,</span><br><span class="line">                                         RMAppEventType,</span><br><span class="line">                                         RMAppEvent&gt; stateMachineFactory</span><br><span class="line">                             = <span class="keyword">new</span> StateMachineFactory&lt;RMAppImpl,</span><br><span class="line">                                         RMAppState,</span><br><span class="line">                                         RMAppEventType,</span><br><span class="line">                                         RMAppEvent&gt;(RMAppState.NEW)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="comment">// Transitions from NEW state</span></span><br><span class="line">  .addTransition(RMAppState.NEW, RMAppState.NEW,</span><br><span class="line">      RMAppEventType.NODE_UPDATE, <span class="keyword">new</span> RMAppNodeUpdateTransition())</span><br><span class="line">  .addTransition(RMAppState.NEW, RMAppState.NEW_SAVING,</span><br><span class="line">      RMAppEventType.START, <span class="keyword">new</span> RMAppNewlySavingTransition())</span><br><span class="line">  ...<span class="comment">// è‹¥å¹²çŠ¶æ€è½¬æ¢çš„å®šä¹‰</span></span><br><span class="line">  .installTopology();    </span><br></pre></td></tr></table></figure><p>StateMachineFactoryä»åå­—å¯ä»¥çœ‹å‡ºå…¶æ˜¯ä¸€ä¸ªå·¥å‚ï¼Œè´Ÿè´£äº§ç”ŸçŠ¶æ€æœºï¼Œåˆ™RMAPPImplä¸­å¿…æœ‰ä¸€ä¸ªå±æ€§æ¥æ¥æ”¶è¯¥å·¥å‚äº§ç”Ÿçš„çŠ¶æ€æœºç±»ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> StateMachine&lt;RMAppState, RMAppEventType, RMAppEvent&gt; stateMachine;</span><br><span class="line"><span class="comment">// ä»stateMachineFactoryä¸­å¾—åˆ°ä¸€ä¸ªstateMachineå¯¹è±¡</span></span><br><span class="line"><span class="keyword">this</span>.stateMachine = stateMachineFactory.make(<span class="keyword">this</span>);</span><br></pre></td></tr></table></figure><p>ä¸‹é¢ä»çŠ¶æ€æœºçš„è°ƒç”¨æµç¨‹ä¸­è§£æä¸‹StateMachineFactoryä¸­çš„æ–¹æ³•ã€‚</p><p>é¦–å…ˆçœ‹ä¸‹StateMachineFactoryç±»çš„å£°æ˜ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * State machine topology.</span></span><br><span class="line"><span class="comment"> * This object is semantically immutable.  If you have a</span></span><br><span class="line"><span class="comment"> * StateMachineFactory there&#x27;s no operation in the API that changes</span></span><br><span class="line"><span class="comment"> * its semantic properties.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;OPERAND&gt; The object type on which this state machine operates.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;STATE&gt; The state of the entity.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;EVENTTYPE&gt; The external eventType to be handled.</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> &lt;EVENT&gt; The event object.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">final</span> <span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">StateMachineFactory</span></span></span><br><span class="line"><span class="class">             &lt;<span class="title">OPERAND</span>, <span class="title">STATE</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">STATE</span>&gt;,</span></span><br><span class="line"><span class="class">              <span class="title">EVENTTYPE</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">EVENTTYPE</span>&gt;, <span class="title">EVENT</span>&gt; </span>&#123;...&#125;</span><br></pre></td></tr></table></figure><p>ä»ç±»çš„æ³¨é‡Šä¸­å¯ä»¥å¾—çŸ¥StateMachineFactoryæ˜¯ä¸€ç»„çŠ¶æ€çš„æ‹“æ‰‘å›¾ï¼ŒOPERANDæ˜¯è¿™ç»„çŠ¶æ€æœºçš„æ“ä½œè€…ï¼ŒSTATEæ˜¯è¿™ç»„çŠ¶æ€æœºä¸­çš„çŠ¶æ€ï¼ŒEVENTTYPEæ˜¯è§¦å‘çŠ¶æ€è½¬ç§»çš„äº‹ä»¶ç±»å‹ï¼ŒEVENTæ˜¯è§¦å‘çŠ¶æ€è½¬ç§»çš„äº‹ä»¶ã€‚</p><p><em>StateMachineFactoryçš„çŠ¶æ€æ‹“æ‰‘å›¾æ˜¯é€šè¿‡å¤šç§addTransitionè®©ç”¨æˆ·æ·»åŠ å„ç§çŠ¶æ€è½¬ç§»ï¼Œæœ€åé€šè¿‡installTopologyå®Œæˆä¸€ä¸ªçŠ¶æ€æœºæ‹“æ‰‘çš„æ­å»ºï¼Œå…¶ä¸­åˆå§‹çŠ¶æ€æ˜¯é€šè¿‡StateMachineFactoryçš„æ„é€ å‡½æ•°æŒ‡å®šçš„</em>ã€‚ä¸‹é¢çœ‹ä¸‹æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">StateMachineFactory</span><span class="params">(STATE defaultInitialState)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ„æˆä¸€ä¸ªtransitioné“¾</span></span><br><span class="line">  <span class="keyword">this</span>.transitionsListNode = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">this</span>.defaultInitialState = defaultInitialState;</span><br><span class="line">  <span class="keyword">this</span>.optimized = <span class="keyword">false</span>;</span><br><span class="line">  <span class="comment">// ä¸»è¦ç”¨äºå­˜æ”¾preStateã€eventTypeå’Œtransitionçš„æ˜ å°„å…³ç³»</span></span><br><span class="line">  <span class="keyword">this</span>.stateMachineTable = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>RMAPPImplä¸­çš„åˆå§‹çŠ¶æ€æ˜¯<code>RMAppState.NEW</code>ï¼Œç”±å…¶åˆå§‹çŠ¶æ€åˆå§‹åŒ–ä¸€ä¸ªStateMachineFactoryå®ä¾‹ï¼Œç„¶åé€šè¿‡addTransitionæ³¨å†Œå„ç§çŠ¶æ€è½¬ç§»ã€‚</p><h2 id="addTransition"><a href="#addTransition" class="headerlink" title="addTransition"></a>addTransition</h2><p>StateMachineFactoryä¸­æœ‰äº”ä¸ªaddTransitionæ–¹æ³•ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> StateMachineFactory</span><br><span class="line">           &lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">        addTransition(STATE preState, STATE postState, EVENTTYPE eventType) &#123;</span><br><span class="line">  <span class="keyword">return</span> addTransition(preState, postState, eventType, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; <span class="title">addTransition</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    STATE preState, STATE postState, Set&lt;EVENTTYPE&gt; eventTypes)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> addTransition(preState, postState, eventTypes, <span class="keyword">null</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; <span class="title">addTransition</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    STATE preState, STATE postState, Set&lt;EVENTTYPE&gt; eventTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">    SingleArcTransition&lt;OPERAND, EVENT&gt; hook)</span> </span>&#123;</span><br><span class="line">  StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; factory = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (EVENTTYPE event : eventTypes) &#123;</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      factory = addTransition(preState, postState, event, hook);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      factory = factory.addTransition(preState, postState, event, hook);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> StateMachineFactory</span><br><span class="line">           &lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">        addTransition(STATE preState, STATE postState,</span><br><span class="line">                      EVENTTYPE eventType,</span><br><span class="line">                      SingleArcTransition&lt;OPERAND, EVENT&gt; hook)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">      (<span class="keyword">this</span>, <span class="keyword">new</span> ApplicableSingleOrMultipleTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">         (preState, eventType, <span class="keyword">new</span> SingleInternalArc(postState, hook)));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> StateMachineFactory</span><br><span class="line">           &lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">        addTransition(STATE preState, Set&lt;STATE&gt; postStates,</span><br><span class="line">                      EVENTTYPE eventType,</span><br><span class="line">                      MultipleArcTransition&lt;OPERAND, EVENT, STATE&gt; hook)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">      (<span class="keyword">this</span>,</span><br><span class="line">       <span class="keyword">new</span> ApplicableSingleOrMultipleTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">         (preState, eventType, <span class="keyword">new</span> MultipleInternalArc(postStates, hook)));</span><br><span class="line">&#125;        </span><br></pre></td></tr></table></figure><p>ç”±å…¶ä¸Šçš„addTransitionæ–¹æ³•å¯ä»¥çœ‹å‡ºå®šä¹‰äº†ä¸‰ç§çŠ¶æ€è½¬æ¢æ–¹å¼ï¼Œåˆ†åˆ«æ˜¯</p><ol><li>preStateé€šè¿‡<em>æŸä¸ªäº‹ä»¶</em>è½¬æ¢ä¸ºpostStateï¼Œä¹Ÿå°±æ˜¯çŠ¶æ€æœºåœ¨preStateæ—¶ï¼Œæ¥æ”¶åˆ°Eventäº‹ä»¶åï¼Œæ‰§è¡Œå¯¹åº”çš„hookï¼Œå¹¶åœ¨æ‰§è¡Œå®Œæˆåå°†å½“å‰çš„çŠ¶æ€è½¬æ¢ä¸ºpostStateã€‚<br><code>addTransition(STATE preState, STATE postState, EVENTTYPE eventType, SingleArcTransition&lt;OPERAND, EVENT&gt; hook)</code></li><li>preStateé€šè¿‡<em>å¤šä¸ªäº‹ä»¶</em>è½¬æ¢ä¸ºpostStateï¼Œä¹Ÿå°±æ˜¯çŠ¶æ€æœºåœ¨preStateæ—¶ï¼Œæ¥æ”¶åˆ°æŸäº›Eventäº‹ä»¶åï¼Œæ‰§è¡Œå¯¹åº”çš„hookï¼Œå¹¶åœ¨æ‰§è¡Œå®Œæˆåå°†å½“å‰çš„çŠ¶æ€è½¬æ¢ä¸ºpostStateã€‚<br><code>addTransition(STATE preState, STATE postState, Set&lt;EVENTTYPE&gt; eventTypes, SingleArcTransition&lt;OPERAND, EVENT&gt; hook)</code></li><li>preStateé€šè¿‡æŸä¸ªäº‹ä»¶è½¬æ¢ä¸º<em>å¤šä¸ªpostState</em>ï¼Œä¹Ÿå°±æ˜¯çŠ¶æ€æœºåœ¨preStateæ—¶ï¼Œæ¥æ”¶åˆ°Eventäº‹ä»¶åï¼Œæ‰§è¡Œå¯¹åº”çš„hookï¼Œå¹¶åœ¨æ‰§è¡Œå®Œæˆåå°†è¿”å›hookçš„è¿”å›å€¼æ‰€è¡¨ç¤ºçš„çŠ¶æ€ã€‚<br><code>addTransition(STATE preState, Set&lt;STATE&gt; postStates, EVENTTYPE eventType, MultipleArcTransition&lt;OPERAND, EVENT, STATE&gt; hook)</code></li></ol><p>ä¸‹é¢å…ˆçœ‹ä¸‹1ä¸­çš„addTransition</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> StateMachineFactory</span><br><span class="line">           &lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">        addTransition(STATE preState, STATE postState,</span><br><span class="line">                      EVENTTYPE eventType,</span><br><span class="line">                      SingleArcTransition&lt;OPERAND, EVENT&gt; hook)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">      (<span class="keyword">this</span>, <span class="keyword">new</span> ApplicableSingleOrMultipleTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">         (preState, eventType, <span class="keyword">new</span> SingleInternalArc(postState, hook)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»å…¶ä»£ç å¯ä»¥çœ‹å‡ºåœ¨addTransitionä¸­åˆnewäº†ä¸€ä¸ªæ–°çš„StateMachineFactoryã€‚è¿™é‡Œæ¶‰åŠåˆ°ä¸¤ä¸ªç±»<code>ApplicableSingleOrMultipleTransition</code>å’Œ<code>SingleInternalArc</code>ã€‚</p><p>å…ˆæ¥çœ‹ä¸‹SingleInternalArcç±»</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">SingleInternalArc</span></span></span><br><span class="line"><span class="class">                  <span class="keyword">implements</span> <span class="title">Transition</span>&lt;<span class="title">OPERAND</span>, <span class="title">STATE</span>, <span class="title">EVENTTYPE</span>, <span class="title">EVENT</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> STATE postState;</span><br><span class="line">  <span class="keyword">private</span> SingleArcTransition&lt;OPERAND, EVENT&gt; hook; <span class="comment">// transition hook</span></span><br><span class="line"></span><br><span class="line">  SingleInternalArc(STATE postState,</span><br><span class="line">      SingleArcTransition&lt;OPERAND, EVENT&gt; hook) &#123;</span><br><span class="line">    <span class="keyword">this</span>.postState = postState;</span><br><span class="line">    <span class="keyword">this</span>.hook = hook;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> STATE <span class="title">doTransition</span><span class="params">(OPERAND operand, STATE oldState,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EVENT event, EVENTTYPE eventType)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (hook != <span class="keyword">null</span>) &#123;</span><br><span class="line">      hook.transition(operand, event);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> postState;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç±»æœ‰ä¸¤ä¸ªå±æ€§ï¼Œåˆ†åˆ«ä¸ºè¡¨ç¤ºSTATEçš„postStateå±æ€§å’Œè¡¨ç¤ºäº‹ä»¶å‘ç”Ÿä¹‹åè°ƒç”¨å¯¹åº”hookè¿›è¡Œå¤„ç†çš„SingleArcTransitionå±æ€§ã€‚</p><p>è¯¥ç±»åªæœ‰ä¸€ä¸ª<code>doTransition</code>æ–¹æ³•ï¼Œè¯¥æ–¹æ³•ä¸­ä¼šè°ƒç”¨<code>hook.transition</code>å»å¤„ç†å‘ç”Ÿè¯¥äº‹ä»¶ä¹‹åçš„çŠ¶æ€å˜åŒ–ï¼Œhookæ­£å¸¸å¤„ç†ç»“æŸä¹‹åï¼Œè¿”å›postStateçŠ¶æ€ã€‚</p><p>è¯¥ç±»æ˜¯ç”¨æ¥å¤„ç†<em>ä¸€ä¸ªçŠ¶æ€è¢«ä¸€ä¸ªäº‹ä»¶è§¦å‘ä¹‹åè½¬ç§»åˆ°ä¸‹ä¸€ä¸ªçŠ¶æ€</em>çš„ï¼Œè¿˜æœ‰ä¸€ä¸ªå¯¹åº”çš„å¤„ç†å¤šä¸ªçŠ¶æ€<code>MultipleInternalArc</code>ç±»ï¼Œå…¶é€»è¾‘ç»“æ„å’Œ<code>SingleInternalArc</code>ç±»ä¼¼ï¼Œåªæ˜¯åœ¨hookå¤„ç†ç»“æŸä¹‹åï¼Œåˆ¤æ–­ä¸‹postStateæ˜¯å¦åœ¨å¤‡é€‰çš„çŠ¶æ€é›†ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">MultipleInternalArc</span></span></span><br><span class="line"><span class="class">            <span class="keyword">implements</span> <span class="title">Transition</span>&lt;<span class="title">OPERAND</span>, <span class="title">STATE</span>, <span class="title">EVENTTYPE</span>, <span class="title">EVENT</span>&gt;</span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Fields</span></span><br><span class="line">  <span class="comment">// å­˜å‚¨å¯ä¾›é€‰æ‹©çš„postStateçŠ¶æ€</span></span><br><span class="line">  <span class="keyword">private</span> Set&lt;STATE&gt; validPostStates;</span><br><span class="line">  <span class="comment">// äº‹ä»¶å¯¹åº”çš„hook</span></span><br><span class="line">  <span class="keyword">private</span> MultipleArcTransition&lt;OPERAND, EVENT, STATE&gt; hook;  <span class="comment">// transition hook</span></span><br><span class="line"></span><br><span class="line">  MultipleInternalArc(Set&lt;STATE&gt; postStates,</span><br><span class="line">                 MultipleArcTransition&lt;OPERAND, EVENT, STATE&gt; hook) &#123;</span><br><span class="line">    <span class="keyword">this</span>.validPostStates = postStates;</span><br><span class="line">    <span class="keyword">this</span>.hook = hook;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> STATE <span class="title">doTransition</span><span class="params">(OPERAND operand, STATE oldState,</span></span></span><br><span class="line"><span class="params"><span class="function">                            EVENT event, EVENTTYPE eventType)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> InvalidStateTransitonException </span>&#123;</span><br><span class="line">    STATE postState = hook.transition(operand, event);</span><br><span class="line">    <span class="comment">// æ ¡éªŒpostStateæ˜¯å¦åœ¨å¯é€‰çš„çŠ¶æ€é›†ä¸­</span></span><br><span class="line">    <span class="keyword">if</span> (!validPostStates.contains(postState)) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> InvalidStateTransitonException(oldState, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> postState;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹ä¸‹<code>ApplicableSingleOrMultipleTransition</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicableSingleOrMultipleTransition</span></span></span><br><span class="line"><span class="class">           &lt;<span class="title">OPERAND</span>, <span class="title">STATE</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">STATE</span>&gt;,</span></span><br><span class="line"><span class="class">            <span class="title">EVENTTYPE</span> <span class="keyword">extends</span> <span class="title">Enum</span>&lt;<span class="title">EVENTTYPE</span>&gt;, <span class="title">EVENT</span>&gt;</span></span><br><span class="line"><span class="class">        <span class="keyword">implements</span> <span class="title">ApplicableTransition</span>&lt;<span class="title">OPERAND</span>, <span class="title">STATE</span>, <span class="title">EVENTTYPE</span>, <span class="title">EVENT</span>&gt; </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> STATE preState;</span><br><span class="line">  <span class="keyword">final</span> EVENTTYPE eventType;</span><br><span class="line">  <span class="keyword">final</span> Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; transition;</span><br><span class="line"></span><br><span class="line">  ApplicableSingleOrMultipleTransition</span><br><span class="line">      (STATE preState, EVENTTYPE eventType,</span><br><span class="line">       Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; transition) &#123;</span><br><span class="line">    <span class="keyword">this</span>.preState = preState;</span><br><span class="line">    <span class="keyword">this</span>.eventType = eventType;</span><br><span class="line">    <span class="keyword">this</span>.transition = transition;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span></span></span><br><span class="line"><span class="function">           <span class="params">(StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; subject)</span> </span>&#123;</span><br><span class="line">    Map&lt;EVENTTYPE, Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt; transitionMap</span><br><span class="line">      = subject.stateMachineTable.get(preState);</span><br><span class="line">    <span class="keyword">if</span> (transitionMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// I use HashMap here because I would expect most EVENTTYPE&#x27;s to not</span></span><br><span class="line">      <span class="comment">//  apply out of a particular state, so FSM sizes would be </span></span><br><span class="line">      <span class="comment">//  quadratic if I use EnumMap&#x27;s here as I do at the top level.</span></span><br><span class="line">      transitionMap = <span class="keyword">new</span> HashMap&lt;EVENTTYPE,</span><br><span class="line">        Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt;();</span><br><span class="line">      subject.stateMachineTable.put(preState, transitionMap);</span><br><span class="line">    &#125;</span><br><span class="line">    transitionMap.put(eventType, transition);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>ApplicableSingleOrMultipleTransition</code>ä¸»è¦æ˜¯å°†preStateã€eventTypeå’Œtransitionçš„æ˜ å°„å…³ç³»æ”¾å…¥<code>stateMachineTable</code>å±æ€§ä¸­ã€‚</p><p>addTransitionè°ƒç”¨çš„æ„é€ æ–¹æ³•ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">StateMachineFactory</span></span></span><br><span class="line"><span class="function">    <span class="params">(StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; that,</span></span></span><br><span class="line"><span class="params"><span class="function">     ApplicableTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; t)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.defaultInitialState = that.defaultInitialState;</span><br><span class="line">  <span class="keyword">this</span>.transitionsListNode </span><br><span class="line">      = <span class="keyword">new</span> TransitionsListNode(t, that.transitionsListNode);</span><br><span class="line">  <span class="keyword">this</span>.optimized = <span class="keyword">false</span>;</span><br><span class="line">  <span class="keyword">this</span>.stateMachineTable = <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªæ„é€ å‡½æ•°ä¸»è¦æ˜¯å¯¹å±æ€§<code>transitionsListNode</code>è¿›è¡Œå®ä¾‹åŒ–ï¼ŒtransitionsListNodeçš„ä¸»è¦ä½œç”¨çš„æŠŠçŠ¶æ€æœºä¸­çš„transitionæŒ‰ç…§<em>çŠ¶æ€è½¬ç§»çš„é¡ºåˆ©é€†åº</em>çš„é“¾æˆä¸€ä¸ªé“¾è¡¨ã€‚ä¸‹é¢çœ‹ä¸‹transitionsListNodeæ˜¯æ€ä¹ˆå®ç°è¿™ä¸ªé“¾è¡¨çš„ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="class"><span class="keyword">class</span> <span class="title">TransitionsListNode</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> ApplicableTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; transition;</span><br><span class="line">  <span class="keyword">final</span> TransitionsListNode next;</span><br><span class="line"></span><br><span class="line">  TransitionsListNode</span><br><span class="line">      (ApplicableTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; transition,</span><br><span class="line">      TransitionsListNode next) &#123;</span><br><span class="line">    <span class="keyword">this</span>.transition = transition;</span><br><span class="line">    <span class="keyword">this</span>.next = next;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰ä¸¤ä¸ªå±æ€§ï¼Œåˆ†åˆ«ä¸ºApplicableTransition(ä¸€ä¸ªæ¥å£ï¼ŒApplicableSingleOrMultipleTransitionå®ç°äº†è¯¥æ¥å£)çš„transitionå’ŒTransitionsListNodeçš„nextå±æ€§ã€‚ä»æ„é€ å‡½æ•°ä¸­å¯ä»¥çœ‹å‡ºtransitionæ˜¯å½“å‰çŠ¶æ€è½¬ç§»å¯¹åº”çš„å¤„ç†ç±»ï¼ŒnextæŒ‡å‘çš„æ˜¯ä¸‹ä¸€ä¸ªTransitionsListNodeï¼Œ<em>æ­¤æ—¶çš„ä¸‹ä¸€ä¸ªTransitionsListNodeå…¶å®æ˜¯ä¸Šä¸€ä¸ªStateMachineFactoryä¸­çš„TransitionListNode</em>ã€‚</p><p>è·³è¿‡2ä¸­çš„addTransitionï¼Œå…ˆçœ‹ä¸‹3ä¸­çš„addTransitionï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> StateMachineFactory</span><br><span class="line">           &lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">        addTransition(STATE preState, Set&lt;STATE&gt; postStates,</span><br><span class="line">                      EVENTTYPE eventType,</span><br><span class="line">                      MultipleArcTransition&lt;OPERAND, EVENT, STATE&gt; hook)&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">      (<span class="keyword">this</span>,</span><br><span class="line">       <span class="keyword">new</span> ApplicableSingleOrMultipleTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">         (preState, eventType, <span class="keyword">new</span> MultipleInternalArc(postStates, hook)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å’Œ1ä¸­çš„addTransitionç±»ä¼¼ï¼Œåªæ˜¯å°†<code>SingleArcTransition</code>æ¢æˆäº†<code>MultipleInternalArc</code>ï¼Œè¿™ä¸¤ä¸ªç±»çš„åŒºåˆ«åœ¨ä¸Šé¢å·²ç»ä»‹ç»è¿‡ï¼Œå…¶ä½™çš„ä»£ç é€»è¾‘æ˜¯ä¸€æ ·çš„ã€‚</p><p>ç°åœ¨çœ‹ä¸‹2ä¸­çš„addTransition</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; <span class="title">addTransition</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    STATE preState, STATE postState, Set&lt;EVENTTYPE&gt; eventTypes,</span></span></span><br><span class="line"><span class="params"><span class="function">    SingleArcTransition&lt;OPERAND, EVENT&gt; hook)</span> </span>&#123;</span><br><span class="line">  StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; factory = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">for</span> (EVENTTYPE event : eventTypes) &#123;</span><br><span class="line">    <span class="keyword">if</span> (factory == <span class="keyword">null</span>) &#123;</span><br><span class="line">      factory = addTransition(preState, postState, event, hook);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      factory = factory.addTransition(preState, postState, event, hook);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> factory;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2ä¸­åªæ˜¯å¾ªç¯æ‰€æœ‰çš„äº‹ä»¶ç±»å‹å¯¹æ¯ä¸€ä¸ªäº‹ä»¶ç±»å‹è°ƒç”¨1ä¸­çš„addTransitionã€‚</p><p>é€šè¿‡å¯¹æ‰€æœ‰addTransitionçš„åˆ†æå‘ç°æ¯ä¸ªaddTransitionéƒ½ä¼šnewä¸€ä¸ªæ–°çš„StateMachineFactoryï¼Œå¹¶å°†ä¸Šä¸€ä¸ªStateMachineFactoryçš„ä¸€äº›å±æ€§å€¼èµ‹å€¼åˆ°å½“å‰StateMachineFactoryä¸­ã€‚</p><h2 id="installTopology"><a href="#installTopology" class="headerlink" title="installTopology"></a>installTopology</h2><p>addTransitionæŠŠçŠ¶æ€éƒ½æ·»åŠ åˆ°StateMachineFactoryä¸­ä¹‹åï¼Œé€šè¿‡è°ƒç”¨installTopologyè¿›è¡ŒçŠ¶æ€é“¾çš„åˆå§‹åŒ–ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> StateMachineFactory</span><br><span class="line">           &lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;</span><br><span class="line">        installTopology() &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;(<span class="keyword">this</span>, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¹Ÿå®ä¾‹åŒ–äº†ä¸€ä¸ªæ–°çš„StateMachineFactoryï¼Œä¸åŒçš„æ˜¯å°†å±æ€§<code>optimized</code>è®¾ç½®ä¸ºtrueã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="title">StateMachineFactory</span></span></span><br><span class="line"><span class="function">    <span class="params">(StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; that,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">boolean</span> optimized)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.defaultInitialState = that.defaultInitialState;</span><br><span class="line">  <span class="keyword">this</span>.transitionsListNode = that.transitionsListNode;</span><br><span class="line">  <span class="keyword">this</span>.optimized = optimized;</span><br><span class="line">  <span class="keyword">if</span> (optimized) &#123;</span><br><span class="line">    makeStateMachineTable();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    stateMachineTable = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“optimizedä¸ºtrueæ˜¯ï¼Œä¼šåœ¨æ„é€ å‡½æ•°ä¸­è°ƒç”¨<code>makeStateMachineTable</code>å¯¹<code>stateMachineTable</code>è¿›è¡Œèµ‹å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">makeStateMachineTable</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å£°æ˜ä¸€ä¸ªstackæ•°æ®ç»“æ„ï¼Œç”¨æ¥å­˜å‚¨TransitionsListNodeé“¾ä¸­çš„TransitionsListNode</span></span><br><span class="line">  <span class="comment">// ä¹‹æ‰€ä»¥ç”¨stackï¼Œæ˜¯å› ä¸ºTransitionsListNodeé“¾æ˜¯æŒ‰ç…§çŠ¶æ€è½¬ç§»çš„é€†åºæ’åˆ—çš„</span></span><br><span class="line">  <span class="comment">// ä¹Ÿå°±æ˜¯è¯´TransitionsListNodeé“¾ä¸­çš„ç¬¬ä¸€ä¸ªæ˜¯çŠ¶æ€è½¬ç§»ä¸­æœ€åä¸€ä¸ªçŠ¶æ€å¯¹åº”çš„ApplicableSingleOrMultipleTransition</span></span><br><span class="line">  Stack&lt;ApplicableTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt; stack =</span><br><span class="line">    <span class="keyword">new</span> Stack&lt;ApplicableTransition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt;();</span><br><span class="line"></span><br><span class="line">  Map&lt;STATE, Map&lt;EVENTTYPE, Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt;&gt;</span><br><span class="line">    prototype = <span class="keyword">new</span> HashMap&lt;STATE, Map&lt;EVENTTYPE, Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt;&gt;();</span><br><span class="line"></span><br><span class="line">  prototype.put(defaultInitialState, <span class="keyword">null</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// I use EnumMap here because it&#x27;ll be faster and denser.  I would</span></span><br><span class="line">  <span class="comment">//  expect most of the states to have at least one transition.</span></span><br><span class="line">  stateMachineTable</span><br><span class="line">     = <span class="keyword">new</span> EnumMap&lt;STATE, Map&lt;EVENTTYPE,</span><br><span class="line">                         Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt;&gt;(prototype);</span><br><span class="line">  <span class="comment">// å°†TransitionsListNodeé“¾ä¸­çš„ApplicableSingleOrMultipleTransitionå…¥stack</span></span><br><span class="line">  <span class="keyword">for</span> (TransitionsListNode cursor = transitionsListNode;</span><br><span class="line">       cursor != <span class="keyword">null</span>;</span><br><span class="line">       cursor = cursor.next) &#123;</span><br><span class="line">    stack.push(cursor.transition);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†ApplicableSingleOrMultipleTransitionå‡ºstackï¼Œ</span></span><br><span class="line">  <span class="comment">// è°ƒç”¨applyå¯¹stateMachineTableè¿›è¡Œèµ‹å€¼</span></span><br><span class="line">  <span class="keyword">while</span> (!stack.isEmpty()) &#123;</span><br><span class="line">    stack.pop().apply(<span class="keyword">this</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸‹é¢çœ‹ä¸‹<code>ApplicableSingleOrMultipleTransition.apply</code>æ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">apply</span></span></span><br><span class="line"><span class="function">         <span class="params">(StateMachineFactory&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; subject)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä»stateMachineTableä¸­æ‹¿åˆ°preStateå¯¹åº”çš„transitionMap</span></span><br><span class="line">  Map&lt;EVENTTYPE, Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt; transitionMap</span><br><span class="line">    = subject.stateMachineTable.get(preState);</span><br><span class="line">  <span class="comment">// transitionMapä¸ºnullåˆ™newä¸€ä¸ªtransitionMapçš„HashMap</span></span><br><span class="line">  <span class="keyword">if</span> (transitionMap == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// I use HashMap here because I would expect most EVENTTYPE&#x27;s to not</span></span><br><span class="line">    <span class="comment">//  apply out of a particular state, so FSM sizes would be </span></span><br><span class="line">    <span class="comment">//  quadratic if I use EnumMap&#x27;s here as I do at the top level.</span></span><br><span class="line">    transitionMap = <span class="keyword">new</span> HashMap&lt;EVENTTYPE,</span><br><span class="line">      Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt;();</span><br><span class="line">    subject.stateMachineTable.put(preState, transitionMap);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†eventTypeå¯¹åº”çš„Transitionæ”¾å…¥transitionMapä¸­</span></span><br><span class="line">  transitionMap.put(eventType, transition);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="è§¦å‘çŠ¶æ€è½¬ç§»"><a href="#è§¦å‘çŠ¶æ€è½¬ç§»" class="headerlink" title="è§¦å‘çŠ¶æ€è½¬ç§»"></a>è§¦å‘çŠ¶æ€è½¬ç§»</h2><p>RMAPPImplä¸­çŠ¶æ€è½¬ç§»çš„è§¦å‘æ˜¯åœ¨<code>RMAPPImpl.handle</code>ä¸­è§¦å‘çš„ï¼Œåœ¨handleä¸­è°ƒç”¨<code>this.stateMachine.doTransition(event.getType(), event)</code>ï¼Œå…¶ä¸­stateMachineæ˜¯åœ¨RMAPPImplçš„æ„é€ æ–¹æ³•ä¸­è°ƒç”¨<code>stateMachineFactory.make(this)</code>è¿›è¡Œå®ä¾‹åŒ–çš„ã€‚</p><p>çœ‹ä¸‹makeæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> StateMachine&lt;STATE, EVENTTYPE, EVENT&gt; <span class="title">make</span><span class="params">(OPERAND operand)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> InternalStateMachine(operand, defaultInitialState);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨makeä¸­newäº†ä¸€ä¸ªInternalStateMachineå¯¹è±¡ï¼Œåˆ™stateMachineå…¶å®æ˜¯InternalStateMachineç±»çš„å¯¹è±¡ï¼Œ<code>stateMachine.doTransition</code>çš„è°ƒç”¨å…¶å®å°±æ˜¯stateMachine.doTransitionçš„doTransitionæ–¹æ³•ï¼Œç„¶è€Œåœ¨<code>stateMachine.doTransition</code>æ–¹æ³•ä¸­åˆè°ƒç”¨äº†StateMachineFactoryçš„doTransitionæ–¹æ³•ï¼Œ<code>StateMachineFactory.doTransition</code>ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// StateMachineFactory.doTransition</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> STATE <span class="title">doTransition</span></span></span><br><span class="line"><span class="function">         <span class="params">(OPERAND operand, STATE oldState, EVENTTYPE eventType, EVENT event)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InvalidStateTransitonException </span>&#123;</span><br><span class="line">  <span class="comment">// We can assume that stateMachineTable is non-null because we call</span></span><br><span class="line">  <span class="comment">//  maybeMakeStateMachineTable() when we build an InnerStateMachine ,</span></span><br><span class="line">  <span class="comment">//  and this code only gets called from inside a working InnerStateMachine .</span></span><br><span class="line">  Map&lt;EVENTTYPE, Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt;&gt; transitionMap</span><br><span class="line">    = stateMachineTable.get(oldState);</span><br><span class="line">  <span class="keyword">if</span> (transitionMap != <span class="keyword">null</span>) &#123;</span><br><span class="line">    Transition&lt;OPERAND, STATE, EVENTTYPE, EVENT&gt; transition</span><br><span class="line">        = transitionMap.get(eventType);</span><br><span class="line">    <span class="keyword">if</span> (transition != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> transition.doTransition(operand, oldState, event, eventType);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> InvalidStateTransitonException(oldState, eventType);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>StateMachineFactory.doTransition</code>åªèƒ½é€šè¿‡å†…éƒ¨ç±»<code>InnerStateMachine</code>çš„doTransitionæ–¹æ³•è°ƒç”¨ï¼Œè°ƒç”¨<code>StateMachineFactory.doTransition</code>æ—¶å‡è®¾<code>stateMachineTable</code>ä¸ä¸ºnullï¼Œå› ä¸ºåœ¨InnerStateMachineçš„æ„é€ æ–¹æ³•ä¸­å¯èƒ½ä¼šè°ƒç”¨<code>maybeMakeStateMachineTable</code>æ–¹æ³•ã€‚</p><p>ä»stateMachineTableä¸­å¾—åˆ°å½“å‰stateå’ŒeventTypeå¯¹åº”çš„transitionï¼Œç„¶åè°ƒç”¨<em>transition.doTransition</em>æ–¹æ³•ï¼Œè°ƒç”¨eventTypeå¯¹åº”çš„hookå»æ‰§è¡Œç›¸å…³é€»è¾‘ã€‚</p><p>transitionæ˜¯ä¸€ä¸ªæ¥å£ï¼Œå®ç°è¯¥æ¥å£çš„æœ‰ä¸¤ä¸ªç±»SingleInternalArcå’ŒMultipleInternalArcï¼Œç›¸åº”çš„hookå¤„ç†å®Œä¹‹åï¼ŒdoTransitionè¿”å›ç»“æŸæ—¶çš„çŠ¶æ€ã€‚</p><p>è‡³æ­¤ä¸€æ¬¡çŠ¶æ€è½¬ç§»å°±å®Œæˆäº†ã€‚</p><h2 id="çŠ¶æ€è½¬ç§»ä»£ç ç¤ºä¾‹"><a href="#çŠ¶æ€è½¬ç§»ä»£ç ç¤ºä¾‹" class="headerlink" title="çŠ¶æ€è½¬ç§»ä»£ç ç¤ºä¾‹"></a>çŠ¶æ€è½¬ç§»ä»£ç ç¤ºä¾‹</h2><p>ä¸‹é¢ä»¥RMAppEventType.STARTäº‹ä»¶ç±»å‹è¢«è§¦å‘ä¹‹åï¼Œå‘é€çš„çŠ¶æ€è½¬ç§»ã€‚</p><p>é¦–å…ˆè¯¥äº‹ä»¶åœ¨RMAppImpl.handleä¸­è¢«å¤„ç†ï¼Œè°ƒç”¨<code>this.stateMachine.doTransition(event.getType(), event)</code>æ–¹æ³•ï¼Œè·Ÿè¸ªåˆ°<code>InternalStateMachine.doTransition</code>ï¼Œåœ¨å…¶å†…åˆç»§ç»­è°ƒç”¨<code>StateMachineFactory.this.doTransition</code>ï¼Œç„¶åæ ¹æ®<em>RMAppEventType.START</em>äº‹ä»¶è¢«è§¦å‘æ—¶çš„çŠ¶æ€<em>RMAppState.NEW</em>ï¼Œä»<code>stateMachineTable</code>ä¸­EventTypeå’ŒTransitionçš„æ˜ å°„å…³ç³»transitionMapï¼Œæ¥ç€ä»transitionMapä¸­æ‹¿åˆ°<em>RMAppEventType.START</em>å¯¹åº”çš„transition*(SingleInternalArc)*ï¼Œæ¥ç€è°ƒç”¨transitionçš„doTransitionæ–¹æ³•ï¼Œè¿™é‡Œæ‰è°ƒç”¨åˆ°è¯¥çŠ¶æ€è½¬ç§»æ¶‰åŠåˆ°çš„hookï¼Œä¹Ÿå°±æ˜¯åœ¨addTransitionä¸­æ³¨å†Œçš„hookç±»<code>RMAppNewlySavingTransition</code></p><p>ä»£ç æµç¨‹ä¸ºï¼š<br><em>stateMachine__[InternalStateMachine]__.doTransition</em> -&gt; <em>StateMachineFactory.this.doTransition</em> -&gt; <em>transition__[SingleInternalArc]__.doTransition</em> -&gt; <em>hook__[RMAppNewlySavingTransition]__.transition</em></p><p>æ­¤æµç¨‹ç»“æŸä¹‹åRMAppMasterçš„çŠ¶æ€ç”±<em>RMAppState.NEW</em>è½¬ç§»ä¸º<em>RMAppState.NEW_SAVING</em>ï¼Œè¿™å¥—æµç¨‹æ˜¯åœ¨<code>addTransition(RMAppState.NEW, RMAppState.NEW_SAVING, RMAppEventType.START, new RMAppNewlySavingTransition())</code>ä¸­è§„å®šçš„ã€‚</p><p>æœ€ååˆ—ä¸€ä¸ªRMAppçš„çŠ¶æ€è½¬ç§»æµç¨‹å›¾<br><img src="/blogimgs/StateMachine/RMApp.png" alt="RMAppçŠ¶æ€æœº" title="RMAppçŠ¶æ€æœº"><br>å›¾ä¸­çš„é¡¶ç‚¹æ˜¯<em>çŠ¶æ€</em>ï¼Œè¾¹æ˜¯è§¦å‘çŠ¶æ€è½¬ç§»çš„<em>äº‹ä»¶ç±»å‹</em>ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> StateMachineFactory </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>YARNæºç åˆ†æä¹‹AsyncDispatcheräº‹ä»¶è°ƒåº¦å™¨</title>
      <link href="/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BAsyncDispatcher%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%99%A8.html"/>
      <url>/YARN%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90%E4%B9%8BAsyncDispatcher%E4%BA%8B%E4%BB%B6%E8%B0%83%E5%BA%A6%E5%99%A8.html</url>
      
        <content type="html"><![CDATA[<p>YARNé‡‡ç”¨äº†äº‹ä»¶é©±åŠ¨æœºåˆ¶ï¼Œå…¶æ ¸å¿ƒæœåŠ¡å®é™…ä¸Šéƒ½æ˜¯ä¸€ä¸ªå¼‚æ­¥è°ƒåº¦å™¨ï¼ŒåŒ…æ‹¬Resourcemanagerã€Nodemanagerã€MRAppMasterç­‰ã€‚æœ¬ç¯‡ä»¥MRAppMasterä¸ºä¾‹ï¼Œå…¶å†…éƒ¨åŒ…å«ä¸€ä¸ªå¼‚æ­¥è°ƒåº¦å™¨AsyncDispatcherï¼ŒAsyncDispatcheråœ¨yarnä¸­çš„ä¸»è¦ä½œç”¨æ˜¯å¯¹å‘ç”Ÿçš„ä¸€ç³»åˆ—äº‹ä»¶æ‰¾åˆ°å„ä¸ªäº‹ä»¶å¯¹åº”çš„handleè¿›è¡Œå¤„ç†ï¼Œä»å…¶åŠŸèƒ½ä¸Šå¯ä»¥çœ‹å‡ºå…¶å†…éƒ¨åº”è¯¥æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œé˜Ÿåˆ—ä¸»è¦ç”¨æ¥å­˜æ”¾ç­‰å¾…è°ƒåº¦çš„äº‹ä»¶ï¼Œè¿˜åº”è¯¥æœ‰ä¸€ä¸ªäº‹ä»¶ä¸handleçš„æ˜ å°„è¡¨ï¼Œç”¨æ¥å¤„ç†å„ä¸ªäº‹ä»¶ã€‚</p><p>é€šè¿‡æŸ¥çœ‹ä»£ç é¦–å…ˆå¯ä»¥å‘ç°AsyncDispatcheræ˜¯ä¸€ä¸ªæœåŠ¡ï¼Œç»§æ‰¿äº†AbstractServiceï¼Œå…¶æ¬¡æ˜¯é€šè¿‡<em>é˜»å¡é˜Ÿåˆ—</em>å­˜æ”¾äº‹ä»¶ï¼Œç„¶åå•ç‹¬èµ·ä¸€ä¸ªçº¿ç¨‹ä»é˜»å¡é˜Ÿåˆ—ä¸­æ¶ˆè´¹äº‹ä»¶ï¼Œé€šè¿‡äº‹å…ˆå®šä¹‰å¥½çš„äº‹ä»¶å’Œå¤„ç†å™¨çš„æ˜ å°„è¡¨æ‰¾åˆ°å„è‡ªçš„å¤„ç†å™¨è¿›è¡Œå¤„ç†ã€‚</p><span id="more"></span><p>ä¸‹é¢çœ‹ä¸‹ä»£ç å†…å®¹ï¼Œé¦–å…ˆçœ‹ä¸‹å±æ€§ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// é˜»å¡é˜Ÿåˆ—ï¼Œç”¨äºå­˜æ”¾å‘ç”Ÿçš„äº‹ä»¶</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> BlockingQueue&lt;Event&gt; eventQueue;</span><br><span class="line"><span class="comment">// AsyncDispatcher event handlerçº¿ç¨‹æ˜¯å¦åœæ­¢çš„æ ‡è¯†</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> stopped = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// Configuration flag for enabling/disabling draining dispatcher&#x27;s events on</span></span><br><span class="line"><span class="comment">// stop functionality.</span></span><br><span class="line"><span class="comment">// å½“åœæ­¢AsyncDispatcheræœåŠ¡æ—¶ï¼Œæ˜¯å¦ç­‰å¾…eventQueueä¸­çš„äº‹ä»¶è¢«å¤„ç†å®Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> drainEventsOnStop = <span class="keyword">false</span>;</span><br><span class="line"><span class="comment">// Indicates all the remaining dispatcher&#x27;s events on stop have been drained</span></span><br><span class="line"><span class="comment">// and processed.</span></span><br><span class="line"><span class="comment">// åœ¨åœæ­¢AsyncDispatcheræœåŠ¡æ—¶ï¼Œæ ‡è¯†æ‰€æœ‰å‰©ä½™çš„äº‹ä»¶è¢«å¤„ç†å®Œ</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> drained = <span class="keyword">true</span>;</span><br><span class="line"><span class="comment">// å¯¹è±¡é”</span></span><br><span class="line"><span class="keyword">private</span> Object waitForDrained = <span class="keyword">new</span> Object();</span><br><span class="line"><span class="comment">// For drainEventsOnStop enabled only, block newly coming events into the</span></span><br><span class="line"><span class="comment">// queue while stopping.</span></span><br><span class="line"><span class="comment">// åœ¨åœæ­¢AsyncDispatcheræœåŠ¡æ—¶ï¼Œ</span></span><br><span class="line"><span class="comment">// å¦‚æœdrainEventsOnStopä¸ºtrueï¼Œåˆ™é˜»å¡æ–°çš„äº‹ä»¶è¿›å…¥queue</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">volatile</span> <span class="keyword">boolean</span> blockNewEvents = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> EventHandler handlerInstance = <span class="keyword">null</span>;</span><br><span class="line"><span class="comment">// æ¶ˆè´¹queueä¸­äº‹ä»¶çš„çº¿ç¨‹</span></span><br><span class="line"><span class="keyword">private</span> Thread eventHandlingThread;</span><br><span class="line"><span class="comment">// å­˜æ”¾äº‹ä»¶å’Œäº‹ä»¶å¤„ç†å™¨çš„æ˜ å°„</span></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">final</span> Map&lt;Class&lt;? extends Enum&gt;, EventHandler&gt; eventDispatchers;</span><br><span class="line"><span class="comment">// å½“è°ƒåº¦å™¨å‘ç”Ÿå¼‚å¸¸æ—¶ï¼Œrmæ˜¯å¦é€€å‡º</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">boolean</span> exitOnDispatchException;</span><br></pre></td></tr></table></figure><p>ç±»åœ¨ä½¿ç”¨ä¹‹å‰éœ€è¦è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¸€èˆ¬éƒ½æ˜¯é€šè¿‡æ„é€ å‡½æ•°è¿›è¡Œå®ä¾‹åŒ–ï¼Œä¸‹é¢å°±çœ‹ä¸‹è¯¥ç±»çš„æ„é€ å‡½æ•°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncDispatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>(<span class="keyword">new</span> LinkedBlockingQueue&lt;Event&gt;());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">AsyncDispatcher</span><span class="params">(BlockingQueue&lt;Event&gt; eventQueue)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">super</span>(<span class="string">&quot;Dispatcher&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.eventQueue = eventQueue;</span><br><span class="line">  <span class="keyword">this</span>.eventDispatchers = <span class="keyword">new</span> HashMap&lt;Class&lt;? extends Enum&gt;, EventHandler&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯¥ç±»æœ‰ä¸¤ä¸ªæ„é€ å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯é»˜è®¤çš„æ„é€ å‡½æ•°ï¼Œä¸€ä¸ªæ˜¯å¸¦ä¸€ä¸ªBlockingQueueå‚æ•°çš„æ„é€ å‡½æ•°ï¼Œè€Œé»˜è®¤çš„æ„é€ å‡½æ•°åœ¨å…¶å†…éƒ¨åˆè°ƒç”¨äº†å¸¦BlockingQueueå‚æ•°çš„æ„é€ å‡½æ•°ã€‚</p><p>æ„é€ å‡½æ•°ä¸­å¯¹å…¶å…³é”®å±æ€§<code>eventQueue</code>å’Œ<code>eventDispatchers</code>è¿›è¡Œäº†èµ‹å€¼ï¼Œå…¶ä¸­å¦‚æœeventQueueä¸æŒ‡å®šçš„è¯å°±å®ä¾‹åŒ–ä¸€ä¸ªLinkedBlockingQueueå¯¹è±¡ã€‚</p><p>AsyncDispatcheræ˜¯åœ¨Resourcemanagerä¸­è¢«å½“åšä¸€ä¸ªæœåŠ¡è€Œå¯åŠ¨çš„ï¼Œçœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> Dispatcher <span class="title">createDispatcher</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> AsyncDispatcher();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">rmDispatcher = setupDispatcher();</span><br><span class="line">addIfService(rmDispatcher);</span><br></pre></td></tr></table></figure><p>å°†AsyncDispatcherå®ä¾‹èµ‹å€¼ç»™rmDispatcherï¼Œç„¶åå°†rmDispatcherä½œä¸ºä¸€ä¸ªæœåŠ¡å¯åŠ¨ã€‚æœåŠ¡å¯åŠ¨æ—¶éƒ½ä¼šå…ˆè¿›è¡Œinitç„¶åstartï¼Œinitå’Œstartä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceInit</span><span class="params">(Configuration conf)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.exitOnDispatchException =</span><br><span class="line">      conf.getBoolean(Dispatcher.DISPATCHER_EXIT_ON_ERROR_KEY,</span><br><span class="line">        Dispatcher.DEFAULT_DISPATCHER_EXIT_ON_ERROR);</span><br><span class="line">  <span class="keyword">super</span>.serviceInit(conf);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStart</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">//start all the components</span></span><br><span class="line">  <span class="keyword">super</span>.serviceStart();</span><br><span class="line">  eventHandlingThread = <span class="keyword">new</span> Thread(createThread());</span><br><span class="line">  eventHandlingThread.setName(<span class="string">&quot;AsyncDispatcher event handler&quot;</span>);</span><br><span class="line">  eventHandlingThread.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœåŠ¡å¯åŠ¨æ—¶ï¼Œåœ¨serviceStartæ–¹æ³•ä¸­èµ·ä¸€ä¸ª<em>AsyncDispatcher event handler</em>çº¿ç¨‹ï¼Œä»<em>eventQueue</em>ä¸­å–å‡ºeventè¿›è¡Œè°ƒåº¦ã€‚<br>çœ‹ä¸‹eventHandlingThreadçº¿ç¨‹çš„runæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Runnable <span class="title">createThread</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="keyword">while</span> (!stopped &amp;&amp; !Thread.currentThread().isInterrupted()) &#123;</span><br><span class="line">      <span class="comment">// æ ‡è¯†eventQueueæ˜¯å¦ä¸ºç©º</span></span><br><span class="line">        drained = eventQueue.isEmpty();</span><br><span class="line">        <span class="comment">// blockNewEvents is only set when dispatcher is draining to stop,</span></span><br><span class="line">        <span class="comment">// adding this check is to avoid the overhead of acquiring the lock</span></span><br><span class="line">        <span class="comment">// and calling notify every time in the normal run of the loop.</span></span><br><span class="line">        <span class="keyword">if</span> (blockNewEvents) &#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (waitForDrained) &#123;</span><br><span class="line">            <span class="keyword">if</span> (drained) &#123;</span><br><span class="line">              waitForDrained.notify();</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        Event event;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="comment">// ä»eventQueueä¸­ç§»é™¤ç¬¬ä¸€ä¸ªevent</span></span><br><span class="line">          event = eventQueue.take();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(InterruptedException ie) &#123;</span><br><span class="line">          <span class="keyword">if</span> (!stopped) &#123;</span><br><span class="line">            LOG.warn(<span class="string">&quot;AsyncDispatcher thread interrupted&quot;</span>, ie);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// eventä¸ä¸ºnullåˆ™è°ƒåº¦äº‹ä»¶ï¼Œè®©äº‹ä»¶å¤„ç†å™¨å¤„ç†</span></span><br><span class="line">        <span class="keyword">if</span> (event != <span class="keyword">null</span>) &#123;</span><br><span class="line">          dispatch(event);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨runä¸­ï¼Œé¦–å…ˆåˆ¤æ–­è¯¥æœåŠ¡æ˜¯å¦å¤„äºæ­£åœ¨stopè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ­£åœ¨stopå¹¶ä¸”<code>drainEventsOnStop</code>ä¸ºtrueï¼Œåˆ™è¿›å…¥<code>if (blockNewEvents)</code>è¯­å¥ä¸­(<em>blockNewEventsåœ¨serviceStopä¸­ï¼Œå½“drainEventsOnStopä¸ºtrueæ—¶ï¼ŒblockNewEventsè¢«èµ‹å€¼ä¸ºtrue</em>)ï¼Œé€šè¿‡<code>drained</code>åˆ¤æ–­eventQueueä¸­æ˜¯å¦è¿˜æœ‰å‰©ä½™çš„eventï¼Œå¦‚æœæ²¡æœ‰å‰©ä½™eventåˆ™é€šçŸ¥åœ¨<code>serviceStop</code>ä¸­é˜»å¡çš„çº¿ç¨‹ç»§ç»­è¿›è¡Œstopæ“ä½œã€‚å¦‚æœæœ‰å‰©ä½™åˆ™å’Œæ­£å¸¸é€»è¾‘(æ­£å¸¸é€»è¾‘æŒ‡åœ¨æ²¡æœ‰è¿›è¡Œstopæ“ä½œæ—¶çš„é€»è¾‘)ä¸€æ ·ï¼Œä»eventQueueä¸­å–å‡ºä¸€ä¸ªeventï¼Œé€šè¿‡<code>dispatch</code>è¿›è¡Œè°ƒåº¦ã€‚dispatchä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">dispatch</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">//all events go thru this loop</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// å¾—åˆ°eventçš„classå</span></span><br><span class="line">  Class&lt;? extends Enum&gt; type = event.getType().getDeclaringClass();</span><br><span class="line">  <span class="keyword">try</span>&#123;</span><br><span class="line">  <span class="comment">// ä»mapé›†åˆeventDispatchersä¸­å¾—åˆ°è¯¥äº‹ä»¶æ³¨å†Œçš„å¤„ç†å™¨</span></span><br><span class="line">    EventHandler handler = eventDispatchers.get(type);</span><br><span class="line">    <span class="keyword">if</span>(handler != <span class="keyword">null</span>) &#123;</span><br><span class="line">      <span class="comment">// äº‹ä»¶å¤„ç†å™¨çš„handleæ–¹æ³•è¿›è¡Œå¤„ç†event</span></span><br><span class="line">      handler.handle(event);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> Exception(<span class="string">&quot;No handler for registered for &quot;</span> + type);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    <span class="comment">//TODO Maybe log the state of the queue</span></span><br><span class="line">    LOG.fatal(<span class="string">&quot;Error in dispatcher thread&quot;</span>, t);</span><br><span class="line">    <span class="comment">// If serviceStop is called, we should exit this thread gracefully.</span></span><br><span class="line">    <span class="keyword">if</span> (exitOnDispatchException</span><br><span class="line">        &amp;&amp; (ShutdownHookManager.get().isShutdownInProgress()) == <span class="keyword">false</span></span><br><span class="line">        &amp;&amp; stopped == <span class="keyword">false</span>) &#123;</span><br><span class="line">      LOG.info(<span class="string">&quot;Exiting, bbye..&quot;</span>);</span><br><span class="line">      System.exit(-<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ¶‰åŠåˆ°ä¸€ä¸ªå±æ€§<code>eventDispatchers</code>ï¼Œè¿™ä¸ªmapä¸­å­˜æ”¾çš„æ˜¯äº‹ä»¶ç±»å‹å’Œå¯¹åº”çš„äº‹ä»¶å¤„ç†å™¨ï¼Œé€šè¿‡keyäº‹ä»¶ç±»å‹å¾—åˆ°äº‹ä»¶å¤„ç†å™¨ä¹‹åï¼Œç”¨è¯¥äº‹ä»¶å¤„ç†å™¨çš„<code>handle</code>æ–¹æ³•è¿›è¡Œå¤„ç†ã€‚</p><p>è¿™é‡Œåªæ˜¯ä»<code>eventDispatchers</code>ä¸­å–å‡ºkeyå¯¹åº”çš„valueï¼Œé‚£ä¹ˆ<code>eventDispatchers</code>ä¸­çš„keyå’Œvalueæ˜¯æ€ä¹ˆputè¿›å»çš„å‘¢ï¼Ÿåœ¨<code>ResourceManager.java</code>ä¸­ä¸éš¾å‘ç°eventDispatchersä¸­çš„å€¼æ˜¯é€šè¿‡<code>register</code>æ–¹æ³•æ³¨å†Œè¿›å»çš„ï¼Œä¸‹é¢çœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">register</span><span class="params">(Class&lt;? extends Enum&gt; eventType,</span></span></span><br><span class="line"><span class="params"><span class="function">    EventHandler handler)</span> </span>&#123;</span><br><span class="line">  <span class="comment">/* check to see if we have a listener registered */</span></span><br><span class="line">  <span class="comment">// æ£€æŸ¥æ˜¯å¦å·²ç»æ³¨å†Œäº†è¯¥äº‹ä»¶ç±»å‹çš„å¤„ç†å™¨</span></span><br><span class="line">  EventHandler&lt;Event&gt; registeredHandler = (EventHandler&lt;Event&gt;)</span><br><span class="line">  eventDispatchers.get(eventType);</span><br><span class="line">  LOG.info(<span class="string">&quot;Registering &quot;</span> + eventType + <span class="string">&quot; for &quot;</span> + handler.getClass());</span><br><span class="line">  <span class="comment">// å¦‚æœæ²¡æœ‰åˆ™ç›´æ¥put</span></span><br><span class="line">  <span class="keyword">if</span> (registeredHandler == <span class="keyword">null</span>) &#123;</span><br><span class="line">    eventDispatchers.put(eventType, handler);</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!(registeredHandler <span class="keyword">instanceof</span> MultiListenerHandler))&#123;</span><br><span class="line">    <span class="comment">/* for multiple listeners of an event add the multiple listener handler */</span></span><br><span class="line">    <span class="comment">// å¦‚æœå·²ç»æ³¨å†Œäº†è¯¥äº‹ä»¶ç±»å‹çš„å¤„ç†å™¨ï¼Œ</span></span><br><span class="line">    <span class="comment">// å¹¶ä¸”registeredHandlerä¸æ˜¯MultiListenerHandlerç±»å‹</span></span><br><span class="line">    <span class="comment">// åˆ™å°†å·²å­˜åœ¨çš„registeredHandlerå’Œæ–°æ¥çš„handleréƒ½addåˆ°MultiListenerHandlerä¸­</span></span><br><span class="line">    MultiListenerHandler multiHandler = <span class="keyword">new</span> MultiListenerHandler();</span><br><span class="line">    multiHandler.addHandler(registeredHandler);</span><br><span class="line">    multiHandler.addHandler(handler);</span><br><span class="line">    eventDispatchers.put(eventType, multiHandler);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">/* already a multilistener, just add to it */</span></span><br><span class="line">    <span class="comment">// å¦‚æœregisteredHandlerå·²ç»æ˜¯MultiListenerHandlerç±»å‹</span></span><br><span class="line">    <span class="comment">// åˆ™ç›´æ¥åŠ å…¥MultiListenerHandlerä¸­</span></span><br><span class="line">    MultiListenerHandler multiHandler</span><br><span class="line">    = (MultiListenerHandler) registeredHandler;</span><br><span class="line">    multiHandler.addHandler(handler);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä»registeræ–¹æ³•ä¸­å¯ä»¥å¾—å‡ºå¯ä»¥å¯¹åŒä¸€ä¸ªäº‹ä»¶ç±»å‹æ³¨å†Œå¤šä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œå¤šä¸ªäº‹ä»¶å¤„ç†å™¨ç”¨<code>MultiListenerHandler</code>å­˜å‚¨ã€‚</p><p>å¯¹æŸä¸€ä¸ªäº‹ä»¶æ³¨å†Œäº‹ä»¶å¤„ç†å™¨æ—¶ï¼Œå…ˆåˆ¤æ–­eventDispatchersæ˜¯å¦å­˜åœ¨è¯¥äº‹ä»¶çš„å¤„ç†å™¨ï¼Œæ²¡æœ‰åˆ™ç›´æ¥æ³¨å†Œï¼Œå¦‚æœå­˜åœ¨å¹¶ä¸”ä¸æ˜¯<code>MultiListenerHandler</code>ç±»å‹ï¼Œåˆ™æ„å»ºä¸€ä¸ª<code>MultiListenerHandler</code>çš„å®ä¾‹ï¼Œå°†å·²ç»å­˜åœ¨çš„å¤„ç†å™¨å’Œæ–°æ·»åŠ çš„å¤„ç†å™¨éƒ½æ·»åŠ åˆ°<code>MultiListenerHandler</code>ä¸­ï¼Œå¦‚æœå­˜åœ¨å¹¶ä¸”æ˜¯<code>MultiListenerHandler</code>ç±»å‹ï¼Œåˆ™ç›´æ¥å‘å…¶è¿½åŠ å¤„ç†å™¨handlerã€‚ä¸‹é¢çœ‹ä¸‹<code>MultiListenerHandler</code>æ˜¯ä¸ªä»€ä¹ˆé¬¼</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">MultiListenerHandler</span> <span class="keyword">implements</span> <span class="title">EventHandler</span>&lt;<span class="title">Event</span>&gt; </span>&#123;</span><br><span class="line">  List&lt;EventHandler&lt;Event&gt;&gt; listofHandlers;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="title">MultiListenerHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    listofHandlers = <span class="keyword">new</span> ArrayList&lt;EventHandler&lt;Event&gt;&gt;();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">for</span> (EventHandler&lt;Event&gt; handler: listofHandlers) &#123;</span><br><span class="line">      handler.handle(event);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">void</span> <span class="title">addHandler</span><span class="params">(EventHandler&lt;Event&gt; handler)</span> </span>&#123;</span><br><span class="line">    listofHandlers.add(handler);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>MultiListenerHandleræ˜¯AsyncDispatcherçš„ä¸€ä¸ªå†…éƒ¨é™æ€ç±»ï¼Œæœ‰ä¸€ä¸ªlistå±æ€§<code>listofHandlers</code>æ¥å­˜æ”¾å¤šä¸ªäº‹ä»¶å¤„ç†å™¨ã€‚è¯¥ç±»ä¹Ÿå®ç°äº†<code>EventHandler</code>æ¥å£ï¼Œé€šè¿‡è°ƒç”¨<code>handle</code>æ–¹æ³•ï¼Œå°†äº‹ä»¶ä¾æ¬¡é€šè¿‡åˆ—è¡¨ä¸­çš„äº‹ä»¶å¤„ç†å™¨handleræ¥å¤„ç†ã€‚</p><p>ç»†å¿ƒçš„æœ‹å‹å¯èƒ½å·²ç»åœ¨æƒ³eventQueueä¸­çš„eventæ˜¯åœ¨å“ªputè¿›å»çš„å‘¢ï¼Ÿ</p><p>åœ¨AsyncDispatcherä¸­æŸ¥çœ‹eventQueueçš„putæ–¹æ³•éƒ½åœ¨å“ªé‡Œè°ƒç”¨äº†ã€‚å…¶å®åœ¨AsyncDispatcherä¸­åªæœ‰ä¸€å¤„è°ƒç”¨äº†<code>eventQueue.put</code>æ–¹æ³•ï¼Œé‚£å°±æ˜¯åœ¨<code>GenericEventHandler</code>ç±»çš„handleä¸­ã€‚GenericEventHandleræ˜¯AsyncDispatcherçš„ä¸€ä¸ªå†…éƒ¨ç±»ï¼Œåœ¨<code>AsyncDispatcher.getEventHandler()</code>æ–¹æ³•ä¸­å®ä¾‹åŒ–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> EventHandler <span class="title">getEventHandler</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (handlerInstance == <span class="keyword">null</span>) &#123;</span><br><span class="line">    handlerInstance = <span class="keyword">new</span> GenericEventHandler();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> handlerInstance;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¯ä»¥çœ‹å‡ºä¸€ä¸ªè°ƒåº¦å™¨é‡Œå®ä¾‹åŒ–ä¸€ä¸ªGenericEventHandlerå¯¹è±¡ï¼Œä¸‹æ¬¡è·å–å°±å¯ä»¥ç›´æ¥è¿”å›handlerInstanceäº†ã€‚</p><p>å‘eventQueueä¸­putæ•°æ®æ—¶ï¼Œå…ˆé€šè¿‡<code>AsyncDispatcher.getEventHandler()</code>æ–¹æ³•ï¼Œå¾—åˆ°GenericEventHandlerå®ä¾‹handlerInstanceï¼Œç„¶åè°ƒç”¨<code>GenericEventHandler.handle(Event)</code>æ–¹æ³•putè¿›å»çš„ï¼Œä¸‹é¢çœ‹ä¸‹GenericEventHandler.handleæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handle</span><span class="params">(Event event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å½“drainEventsOnStopä¸ºtrueå¹¶ä¸”å½“å‰è°ƒåº¦å™¨æ­£åœ¨stopæ—¶ï¼Œ</span></span><br><span class="line">  <span class="comment">// ç¦æ­¢æ–°æ·»åŠ eventï¼Œç›´æ¥return</span></span><br><span class="line">  <span class="keyword">if</span> (blockNewEvents) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  drained = <span class="keyword">false</span>;</span><br><span class="line">  <span class="comment">/* all this method does is enqueue all the events onto the queue */</span></span><br><span class="line">  <span class="keyword">int</span> qSize = eventQueue.size();</span><br><span class="line">  <span class="comment">// eventQueue sizeä¸ä¸º0ä¸”æ˜¯1000çš„æ•´æ•°å€åˆ™æ‰“å°ä¸€æ¡log</span></span><br><span class="line">  <span class="keyword">if</span> (qSize !=<span class="number">0</span> &amp;&amp; qSize %<span class="number">1000</span> == <span class="number">0</span>) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Size of event-queue is &quot;</span> + qSize);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¾—åˆ°å‰©ä½™çš„ç©ºé—´</span></span><br><span class="line">  <span class="keyword">int</span> remCapacity = eventQueue.remainingCapacity();</span><br><span class="line">  <span class="comment">// å‰©ä½™çš„ç©ºé—´å°äº1000æ—¶æ‰“å°ä¸€ä¸ªwarn log</span></span><br><span class="line">  <span class="keyword">if</span> (remCapacity &lt; <span class="number">1000</span>) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Very low remaining capacity in the event-queue: &quot;</span></span><br><span class="line">        + remCapacity);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// putè¿›eventQueueä¸­</span></span><br><span class="line">    eventQueue.put(event);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!stopped) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;AsyncDispatcher thread interrupted&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> YarnRuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å‘eventQueueä¸­putæ•°æ®æ—¶ï¼Œå…ˆç»Ÿè®¡ä¸‹å½“å‰eventQueueæ˜¯çš„ä½¿ç”¨æƒ…å†µï¼Œå¦‚æœå‰©ä½™ç©ºé—´å°äº1000ï¼Œåˆ™æ‰“å°ä¸€æ¡warnæ—¥å¿—ã€‚eventQueueæ˜¯LinkedBlockingQueueç±»å‹çš„å¯¹è±¡ï¼Œ<em>è°ƒç”¨LinkedBlockingQueueé»˜è®¤æ„é€ å‡½æ•°åœ¨å®ä¾‹åŒ–æ—¶ä¼šå°†Integer.MAX_VALUEä½œä¸ºç©ºé—´å¤§å°ã€‚</em></p><p>è‡³æ­¤AsyncDispatcherç±»ä»startã€putã€takeéƒ½å·²ä»‹ç»å®Œï¼Œæœ€åä»‹ç»ä¸‹AsyncDispatcherçš„stopã€‚çœ‹ä¸‹<code>serviceStop</code>æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">serviceStop</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">// è¿™é‡Œé¦–å…ˆæ ¡éªŒdrainEventsOnStopï¼Œé»˜è®¤ä¸ºfalse</span></span><br><span class="line">  <span class="comment">// å¦‚æœä¸ºtrueåˆ™ç­‰å¾…eventQueueä¸­çš„eventå¤„ç†å®Œä¹‹åå†stopè°ƒåº¦å™¨</span></span><br><span class="line">  <span class="keyword">if</span> (drainEventsOnStop) &#123;</span><br><span class="line">  <span class="comment">// blockNewEventsåœ¨æ­¤è®¾ä¸ºtrueï¼Œåœ¨eventHandlingThreadçº¿ç¨‹ä¸­æ£€æŸ¥æ˜¯å¦å·²å¤„ç†å®Œ</span></span><br><span class="line">    blockNewEvents = <span class="keyword">true</span>;</span><br><span class="line">    LOG.info(<span class="string">&quot;AsyncDispatcher is draining to stop, igonring any new events.&quot;</span>);</span><br><span class="line">    <span class="comment">// ç­‰å¾…eventHandlingThreadçº¿ç¨‹çš„notify</span></span><br><span class="line">    <span class="keyword">synchronized</span> (waitForDrained) &#123;</span><br><span class="line">      <span class="keyword">while</span> (!drained &amp;&amp; eventHandlingThread.isAlive()) &#123;</span><br><span class="line">        waitForDrained.wait(<span class="number">1000</span>);</span><br><span class="line">        LOG.info(<span class="string">&quot;Waiting for AsyncDispatcher to drain.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  stopped = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">if</span> (eventHandlingThread != <span class="keyword">null</span>) &#123;</span><br><span class="line">    eventHandlingThread.interrupt();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      eventHandlingThread.join();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Interrupted Exception while stopping&quot;</span>, ie);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// stop all the components</span></span><br><span class="line">  <span class="keyword">super</span>.serviceStop();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒåº¦å™¨stopæ—¶ï¼Œä¸»è¦æ˜¯æ ¡éªŒä¸‹drainEventsOnStopçš„å€¼ï¼Œä¸ºfalseåˆ™ç›´æ¥stopæ‰è°ƒåº¦å™¨ï¼Œä¸ºtrueåˆ™é˜»å¡æ–°eventputè¿›eventQueueï¼Œç­‰å¾…eventQueueä¸­çš„eventè¢«å¤„ç†å®Œå†stopã€‚</p><p><strong>äº‹ä»¶é©±åŠ¨è®¾è®¡æ€æƒ³çš„å¼•å…¥ï¼Œä½¿å¾—YARNå…·æœ‰ä½è€¦åˆï¼Œé«˜å†…èšçš„ç‰¹ç‚¹ï¼Œå„ä¸ªæ¨¡å—åªéœ€å®Œæˆå„è‡ªçš„åŠŸèƒ½ï¼Œè€Œæ¨¡å—ä¹‹é—´åˆ™é‡‡ç”¨äº‹ä»¶è”ç³»èµ·æ¥ï¼Œç³»ç»Ÿè®¾è®¡ç®€å•ä¸”ç»´æŠ¤æ–¹ä¾¿ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> YARN </tag>
            
            <tag> AsyncDispatcher </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hadoop RPC è§£æ</title>
      <link href="/Hadoop%20RPC%20%E8%A7%A3%E6%9E%90.html"/>
      <url>/Hadoop%20RPC%20%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<h2 id="RPC"><a href="#RPC" class="headerlink" title="RPC"></a>RPC</h2><p>RPCç”±å››ä¸ªæ¨¡å—ç»„æˆï¼š<br>1ã€é€šä¿¡æ¨¡å—ã€‚<br>ä¸¤ä¸ªç›¸äº’åä½œçš„é€šä¿¡æ¨¡å—å®ç°è¯·æ±‚-åº”ç­”åè®®,å®ƒä»¬åœ¨å®¢æˆ·å’ŒæœåŠ¡å™¨ä¹‹é—´ä¼ é€’è¯·æ±‚å’Œåº”ç­”æ¶ˆæ¯,ä¸€èˆ¬ä¸ä¼šå¯¹æ•°æ®åŒ…è¿›è¡Œä»»ä½•å¤„ç†ã€‚è¯·æ±‚â€“åº”ç­”åè®®çš„å®ç°æ–¹å¼æœ‰åŒæ­¥æ–¹å¼å’Œå¼‚æ­¥æ–¹å¼ä¸¤ç§ã€‚åŒæ­¥æ¨¡å¼ä¸‹å®¢æˆ·ç«¯ç¨‹åºä¸€ç›´é˜»å¡åˆ°æœåŠ¡å™¨ç«¯å‘é€çš„åº”ç­”è¯·æ±‚åˆ°è¾¾æœ¬åœ°; è€Œå¼‚æ­¥æ¨¡å¼ä¸åŒ,å®¢æˆ·ç«¯å°†è¯·æ±‚å‘é€åˆ°æœåŠ¡å™¨ç«¯å,ä¸å¿…ç­‰å¾…åº”ç­”è¿”å›,å¯ä»¥åšå…¶ä»–äº‹æƒ…,å¾…æœåŠ¡å™¨ç«¯å¤„ç†å®Œè¯·æ±‚å,ä¸»åŠ¨é€šçŸ¥å®¢æˆ·ç«¯ã€‚åœ¨é«˜å¹¶å‘åº”ç”¨åœºæ™¯ä¸­,ä¸€èˆ¬é‡‡ç”¨å¼‚æ­¥æ¨¡å¼ä»¥é™ä½è®¿é—®å»¶è¿Ÿå’Œæé«˜å¸¦å®½åˆ©ç”¨ç‡ã€‚<br>2ã€Stub ç¨‹åºï¼ˆä»£ç†ç¨‹åºï¼‰ã€‚<br>å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ç«¯å‡åŒ…å«Stubç¨‹åº,å¯å°†ä¹‹çœ‹åš<strong>ä»£ç†ç¨‹åº</strong>ã€‚å®ƒä½¿å¾—è¿œç¨‹å‡½æ•°è°ƒç”¨è¡¨ç°å¾—è·Ÿæœ¬åœ°è°ƒç”¨ä¸€æ ·,å¯¹ç”¨æˆ·ç¨‹åºå®Œå…¨é€æ˜ã€‚åœ¨å®¢æˆ·ç«¯,å®ƒè¡¨ç°å¾—å°±åƒä¸€ä¸ªæœ¬åœ°ç¨‹åº,ä½†ä¸ç›´æ¥æ‰§è¡Œæœ¬åœ°è°ƒç”¨,è€Œæ˜¯å°†è¯·æ±‚ä¿¡æ¯é€šè¿‡ç½‘ç»œæ¨¡å—å‘é€ç»™æœåŠ¡å™¨ç«¯ã€‚æ­¤å¤–,å½“æœåŠ¡å™¨å‘é€åº”ç­”å,å®ƒä¼šè§£ç å¯¹åº”ç»“æœã€‚åœ¨æœåŠ¡å™¨ç«¯,Stubç¨‹åºä¾æ¬¡è¿›è¡Œè§£ç è¯·æ±‚æ¶ˆæ¯ä¸­çš„å‚æ•°ã€è°ƒç”¨ç›¸åº”çš„æœåŠ¡è¿‡ç¨‹å’Œç¼–ç åº”ç­”ç»“æœçš„è¿”å›å€¼ç­‰å¤„ç†ã€‚<br>3ã€è°ƒåº¦ç¨‹åºã€‚<br>è°ƒåº¦ç¨‹åºæ¥æ”¶æ¥è‡ªé€šä¿¡æ¨¡å—çš„è¯·æ±‚æ¶ˆæ¯,å¹¶æ ¹æ®å…¶ä¸­çš„æ ‡è¯†é€‰æ‹©ä¸€ä¸ªStubç¨‹åºè¿›è¡Œå¤„ç†ã€‚é€šå¸¸å®¢æˆ·ç«¯å¹¶å‘è¯·æ±‚é‡æ¯”è¾ƒå¤§æ—¶,ä¼šé‡‡ç”¨çº¿ç¨‹æ± æé«˜å¤„ç†æ•ˆç‡ã€‚<br>4ã€å®¢æˆ·ç¨‹åº/æœåŠ¡è¿‡ç¨‹ã€‚<br>è¯·æ±‚çš„å‘å‡ºè€…å’Œè¯·æ±‚çš„å¤„ç†è€…ã€‚</p><span id="more"></span><p>é€šå¸¸è€Œè¨€,ä¸€ä¸ª RPCè¯·æ±‚ä»å‘é€åˆ°è·å–å¤„ç†ç»“æœ,æ‰€ç»å†çš„æ­¥éª¤å¦‚ä¸‹æ‰€ç¤ºã€‚</p><ol><li>å®¢æˆ·ç¨‹åºä»¥æœ¬åœ°æ–¹å¼é€šè¿‡ç³»ç»Ÿäº§ç”Ÿçš„Stubç¨‹åºè°ƒç”¨å®¢æˆ·ç¨‹åº; </li><li>è¯¥Stubç¨‹åºå°†å‡½æ•°è°ƒç”¨ä¿¡æ¯æŒ‰ç…§ç½‘ç»œé€šä¿¡æ¨¡å—çš„è¦æ±‚å°è£…æˆæ¶ˆæ¯åŒ…,å¹¶äº¤ç»™é€šä¿¡æ¨¡å—å‘é€åˆ°è¿œç¨‹æœåŠ¡å™¨ç«¯ã€‚ </li><li>è¿œç¨‹æœåŠ¡å™¨ç«¯æ¥æ”¶æ­¤æ¶ˆæ¯å,å°†æ­¤æ¶ˆæ¯å‘é€ç»™ç›¸åº”çš„Stubç¨‹åº;</li><li>Stubç¨‹åºæ‹†å°æ¶ˆæ¯,å½¢æˆè¢«è°ƒè¿‡ç¨‹è¦æ±‚çš„å½¢å¼,å¹¶è°ƒç”¨å¯¹åº”å‡½æ•°;</li><li>è¢«è°ƒç”¨å‡½æ•°æŒ‰ç…§æ‰€è·å‚æ•°æ‰§è¡Œ,å¹¶å°†ç»“æœè¿”å›ç»™Stubç¨‹åº;</li><li>Stubç¨‹åºå°†æ­¤ç»“æœå°è£…æˆæ¶ˆæ¯,é€šè¿‡ç½‘ç»œé€šä¿¡æ¨¡å—é€çº§åœ°ä¼ é€ç»™å®¢æˆ·ç¨‹åºã€‚</li></ol><h2 id="Hadoop-RPC"><a href="#Hadoop-RPC" class="headerlink" title="Hadoop RPC"></a>Hadoop RPC</h2><p>Hadoop RPCä¸»è¦åˆ†ä¸ºå››ä¸ªéƒ¨åˆ†,åˆ†åˆ«æ˜¯åºåˆ—åŒ–å±‚ã€å‡½æ•°è°ƒç”¨å±‚ã€ç½‘ç»œä¼ è¾“å±‚å’ŒæœåŠ¡å™¨ç«¯å¤„ç†æ¡†æ¶,å…·ä½“å®ç°æœºåˆ¶å¦‚ä¸‹:</p><p>åºåˆ—åŒ–å±‚ã€‚åºåˆ—åŒ–ä¸»è¦ä½œç”¨æ˜¯å°†ç»“æ„åŒ–å¯¹è±¡è½¬ä¸ºå­—èŠ‚æµä»¥ä¾¿äºé€šè¿‡ç½‘ç»œè¿›è¡Œä¼ è¾“æˆ–å†™å…¥æŒä¹…å­˜å‚¨,åœ¨RPCæ¡†æ¶ä¸­,<br>          å®ƒä¸»è¦ç”¨äºå°†ç”¨æˆ·è¯·æ±‚ä¸­çš„å‚æ•°æˆ–è€…åº”ç­”è½¬åŒ–æˆå­—èŠ‚æµä»¥ä¾¿è·¨æœºå™¨ä¼ è¾“ã€‚Hadoop2.0ä¹‹åï¼Œ<br>          ä¸»è¦ç”¨Protocol Bufferså’ŒApache Avroï¼ŒHadoopæœ¬èº«ä¹Ÿæä¾›äº†ä¸€å¥—åºåˆ—åŒ–æ¡†æ¶ï¼Œ<br>          ä¸€ä¸ªç±»åªè¦å®ç°Writableæ¥å£å³å¯æ”¯æŒå¯¹è±¡åºåˆ—åŒ–ä¸ååºåˆ—åŒ–ã€‚<br>å‡½æ•°è°ƒç”¨å±‚ã€‚å‡½æ•°è°ƒç”¨å±‚ä¸»è¦åŠŸèƒ½æ˜¯å®šä½è¦è°ƒç”¨çš„å‡½æ•°å¹¶æ‰§è¡Œè¯¥å‡½æ•°ï¼Œ<br>            Hadoop RPCé‡‡ç”¨äº†Javaåå°„æœºåˆ¶ï¼ˆ<strong>æœåŠ¡å™¨ç«¯</strong>ï¼‰ä¸åŠ¨æ€ä»£ç†ï¼ˆ<strong>å®¢æˆ·ç«¯</strong>ï¼‰å®ç°äº†å‡½æ•°è°ƒç”¨ã€‚<br>ç½‘ç»œä¼ è¾“å±‚ã€‚ç½‘ç»œä¼ è¾“å±‚æè¿°äº†Clientä¸Serverä¹‹é—´æ¶ˆæ¯ä¼ è¾“çš„æ–¹å¼ï¼ŒHadoop RPCé‡‡ç”¨äº†<strong>åŸºäºTCP/IPçš„Socketæœºåˆ¶</strong>ã€‚<br>æœåŠ¡å™¨ç«¯å¤„ç†æ¡†æ¶ã€‚æœåŠ¡å™¨ç«¯å¤„ç†æ¡†æ¶å¯è¢«<strong>æŠ½è±¡ä¸ºç½‘ç»œI/Oæ¨¡å‹</strong>ï¼Œå®ƒæè¿°äº†å®¢æˆ·ç«¯ä¸æœåŠ¡å™¨ç«¯é—´ä¿¡æ¯äº¤äº’æ–¹å¼,<br>                  å®ƒçš„è®¾è®¡ç›´æ¥å†³å®šç€æœåŠ¡å™¨ç«¯çš„å¹¶å‘å¤„ç†èƒ½åŠ›,å¸¸è§çš„ç½‘ç»œ I/O æ¨¡å‹æœ‰é˜»å¡å¼ I/Oã€éé˜»å¡å¼ I/Oã€äº‹ä»¶é©±åŠ¨ I/O ç­‰,è€ŒHadoop RPCé‡‡ç”¨äº†<strong>åŸºäºReactorè®¾è®¡æ¨¡å¼çš„äº‹ä»¶é©±åŠ¨ I/O æ¨¡å‹ï¼ˆNIOï¼‰</strong>ã€‚</p><h3 id="Hadoop-RPC-Demo"><a href="#Hadoop-RPC-Demo" class="headerlink" title="Hadoop RPC Demo"></a>Hadoop RPC Demo</h3><p>ä½¿ç”¨Hadoop RPCå‰è¦å…ˆå®šä¹‰ä¸€ä¸ªRPCåè®®ï¼Œè¿™ä¸ªåè®®å…¶å®å°±æ˜¯ä¸€ä¸ªæ¥å£ç±»ï¼Œæ¥å£ä¸­çš„æ–¹æ³•å°±æ˜¯å¯¹å¤–æä¾›çš„è¿œç¨‹è°ƒç”¨æ–¹æ³•ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Hadoopä¸­æ‰€æœ‰è‡ªå®šä¹‰ RPC æ¥å£éƒ½éœ€è¦ç»§æ‰¿ VersionedProtocol æ¥å£</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">MyClientProtocol</span> <span class="keyword">extends</span> <span class="title">VersionedProtocol</span> </span>&#123;</span><br><span class="line"><span class="comment">// ç‰ˆæœ¬å·,é»˜è®¤æƒ…å†µä¸‹,ä¸åŒç‰ˆæœ¬å·çš„ RPC Client å’Œ Server ä¹‹é—´ä¸èƒ½ç›¸äº’é€šä¿¡</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">long</span> versionID = <span class="number">1L</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String str)</span> <span class="keyword">throws</span> IOException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">throws</span>  IOException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å†å£°æ˜ä¸€ä¸ªç±»å»å®ç°è¿™ä¸ªåè®®ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClientProtocolImpl</span> <span class="keyword">implements</span> <span class="title">MyClientProtocol</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"><span class="comment">// RPC åè®®å¯¹å¤–æä¾›æ–¹æ³•çš„å…·ä½“å®ç°</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">echo</span><span class="params">(String str)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> str;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">add</span><span class="params">(<span class="keyword">int</span> a, <span class="keyword">int</span> b)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> a + b;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä¸‹é¢ä¸¤ä¸ªæ–¹æ³•æ˜¯ä» VersionedProtocol ä¸­é‡å†™çš„</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getProtocolVersion</span><span class="params">(String s, <span class="keyword">long</span> l)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> MyClientProtocol.versionID;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> ProtocolSignature <span class="title">getProtocolSignature</span><span class="params">(String s, <span class="keyword">long</span> l, <span class="keyword">int</span> i)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProtocolSignature(MyClientProtocol.versionID, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ‰äº†RPCåè®®ï¼Œå†åˆ›å»ºserverç«¯å’Œclientç«¯å°±å¯ä»¥ä½¿ç”¨äº†ï¼Œä¸‹é¢é€šè¿‡Hadoop RPC åˆ›å»ºserverç«¯ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyServer</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">        Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line"><span class="comment">// ä½¿ç”¨RPCç±»getä¸€ä¸ªsever  é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ WritableRpcEngineï¼Œ</span></span><br><span class="line"><span class="comment">// å¯ä»¥ä½¿ç”¨RPC.setProtocolEngine è®¾ç½®åºåˆ—å·å¼•æ“</span></span><br><span class="line"><span class="comment">// server é€šè¿‡ Builderæ¨¡å¼ å¾—åˆ°ä¸€ä¸ªserverå¯¹è±¡</span></span><br><span class="line">        RPC.Server server = <span class="keyword">new</span> RPC.Builder(conf).setProtocol(MyClientProtocol.class)</span><br><span class="line">                .setInstance(<span class="keyword">new</span> MyClientProtocolImpl()).setBindAddress(<span class="string">&quot;127.0.0.1&quot;</span>).setPort(<span class="number">9876</span>)</span><br><span class="line">                .setNumHandlers(<span class="number">10</span>).build();</span><br><span class="line">        server.start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç°åœ¨å°±å¯ä»¥åœ¨clientç«¯è°ƒç”¨RPCåè®®å¯¹å¤–æä¾›çš„æ¥å£æ–¹æ³•äº†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyClient</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException, InterruptedException </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Configuration conf = <span class="keyword">new</span> Configuration();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">30000</span>; i++)&#123;</span><br><span class="line">            Thread t = <span class="keyword">new</span> Thread(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                    MyClientProtocol proxy = <span class="keyword">null</span>;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                    <span class="comment">// ä»RPC.getProxyæ–¹æ³•çš„åå­—å¯ä»¥çŒœå‡ºclientå…¶å®å°±æ˜¯ä¸€ä¸ªä»£ç†</span></span><br><span class="line">                    <span class="comment">// Hadoop RPCå®¢æˆ·ç«¯æ˜¯é€šè¿‡java åŠ¨æ€ä»£ç†å®ç°è¿œç¨‹è°ƒç”¨çš„</span></span><br><span class="line">                        proxy = (MyClientProtocol) RPC.getProxy(MyClientProtocol.class, MyClientProtocol.versionID,</span><br><span class="line">                                <span class="keyword">new</span> InetSocketAddress(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">9876</span>), conf);</span><br><span class="line">                        <span class="keyword">int</span> result = proxy.add(<span class="number">5</span>, <span class="number">6</span>);</span><br><span class="line"><span class="comment">//                        System.out.println(result);</span></span><br><span class="line">                        String echoResult = proxy.echo(result + <span class="string">&quot;&quot;</span>); <span class="comment">// just for string</span></span><br><span class="line"><span class="comment">//                        System.out.println(echoResult);</span></span><br><span class="line">                    &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">            t.start();</span><br><span class="line">            t.join();</span><br><span class="line">        &#125;</span><br><span class="line">        System.out.println(<span class="string">&quot;end&quot;</span>);</span><br><span class="line">        System.out.println(System.currentTimeMillis() - startTime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>å¦‚æœåªæ˜¯æƒ³å†™ä¸ªdemoï¼Œclientä¸ç”¨å†™forå¾ªç¯ï¼Œæˆ‘å†™è¿™ä¸ªforå¾ªç¯æ˜¯æƒ³æµ‹è¯•ä¸‹è½½serverç«¯è®¾ç½®ä¸åŒçš„<strong>handler</strong>æ•°å¯¹å…¶æ€§èƒ½çš„å½±å“ï¼Œä½†æ˜¯é€šè¿‡ä¸Šé¢çš„ä»£ç å¹¶æ²¡æœ‰è¾¾åˆ°æˆ‘æƒ³è¦çš„ç»“æœã€‚å¯èƒ½æ˜¯æˆ‘æ€è·¯ä¸å¯¹å§ï¼Œæœ‰å“ªä½å¤§ç¥çœ‹è§äº†ç»™æˆ‘æŒ‡ç‚¹ä¸‹ã€‚ã€‚ã€‚</p></blockquote><h2 id="Hadoop-RPC-æºç è§£æ"><a href="#Hadoop-RPC-æºç è§£æ" class="headerlink" title="Hadoop RPC æºç è§£æ"></a>Hadoop RPC æºç è§£æ</h2><p>é€šè¿‡ä¸Šé¢çš„Demoï¼Œå¯ä»¥çœ‹å‡ºåªæœ‰RPCåè®®æ˜¯è‡ªå·±å®ç°çš„ï¼Œserverå’Œclientéƒ½æ˜¯é€šè¿‡RPCæä¾›çš„æ¥å£getåˆ°çš„ã€‚åˆ™å…·ä½“ä¸Šé¢çš„Demoæ¥çœ‹ä¸‹RPCç›¸å…³çš„æºç ã€‚<br>ä¸RPCç›¸å…³çš„ç±»åœ¨commonä¸­çš„ipcä¸­ï¼Œipcæ˜¯inter-process communication çš„ç¼©å†™<br>RPCä¸»è¦å‘å¤–æä¾›äº†ä¸€äº›ç¼–ç¨‹æ¥å£ï¼Œç”¨äºget server å’Œ clientï¼Œæ˜¯å¯¹åº•å±‚å®¢æˆ·æœºâ€“æœåŠ¡å™¨ç½‘ç»œæ¨¡å‹çš„å°è£…ã€‚<br><em>clientå¯ä»¥é€šè¿‡RPCæä¾›çš„getProxyå’ŒwaitForProxyä¸¤ç§æ–¹æ³•å¾—åˆ°</em>ï¼Œçœ‹ä¸‹getProxyçš„å…·ä½“å®ç°ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">T <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; protocol, <span class="keyword">long</span> clientVersion, InetSocketAddress addr, Configuration conf)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> getProtocolProxy(protocol, clientVersion, addr, conf).getProxy();</span><br><span class="line">&#125;</span><br><span class="line">....</span><br><span class="line"><span class="comment">// getProtocolProxy é€šè¿‡ä¸€äº›åˆ—çš„æ–¹æ³•è°ƒç”¨ï¼ŒåŸºæœ¬éƒ½æ˜¯æ–¹æ³•çš„é‡å†™ï¼Œæœ€åå®šä½åˆ°å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">ProtocolProxy&lt;T&gt; <span class="title">getProtocolProxy</span><span class="params">(Class&lt;T&gt; protocol, <span class="keyword">long</span> clientVersion, InetSocketAddress addr, UserGroupInformation ticket, Configuration conf, SocketFactory factory, <span class="keyword">int</span> rpcTimeout, RetryPolicy connectionRetryPolicy, AtomicBoolean fallbackToSimpleAuth)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(UserGroupInformation.isSecurityEnabled()) &#123;</span><br><span class="line">        SaslRpcServer.init(conf);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> getProtocolEngine(protocol, conf).getProxy(protocol, clientVersion, addr, ticket, conf, factory, rpcTimeout, connectionRetryPolicy, fallbackToSimpleAuth);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Hadoop2.0ä¹‹åæ”¯æŒprotocol bufferåºåˆ—åŒ–ï¼Œæ‰€ä»¥åœ¨åŸHadoop RPCçš„åŸºç¡€ä¸Šè¿›è¡Œäº†ä¿®æ”¹ï¼Œæå‡ºä¸€ä¸ªRpcEngineæ¥å£ï¼Œä»¥æ”¯æŒç¬¬ä¸‰æ–¹åºåˆ—åŒ–æ–¹æ³•ï¼Œhadoopæœ¬èº«åªå®ç°äº†protocol å’Œ Writableåºåˆ—åŒ–çš„engineã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">static</span> <span class="keyword">synchronized</span> RpcEngine <span class="title">getProtocolEngine</span><span class="params">(Class&lt;?&gt; protocol, Configuration conf)</span> </span>&#123;</span><br><span class="line">    RpcEngine engine = (RpcEngine)PROTOCOL_ENGINES.get(protocol);</span><br><span class="line">    <span class="comment">// Hadoop é»˜è®¤ä½¿ç”¨Writableåºåˆ—åŒ–</span></span><br><span class="line">    <span class="keyword">if</span>(engine == <span class="keyword">null</span>) &#123;</span><br><span class="line">        Class impl = conf.getClass(<span class="string">&quot;rpc.engine.&quot;</span> + protocol.getName(), WritableRpcEngine.class);</span><br><span class="line">        engine = (RpcEngine)ReflectionUtils.newInstance(impl, conf);</span><br><span class="line">        PROTOCOL_ENGINES.put(protocol, engine);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> engine;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨å¯¹åº”RpcEngineçš„getProxyæ–¹æ³•ï¼Œè¿™é‡Œä»¥WritableRPCEngineä¸ºä¾‹ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">ProtocolProxy&lt;T&gt; <span class="title">getProxy</span><span class="params">(Class&lt;T&gt; protocol, <span class="keyword">long</span> clientVersion, InetSocketAddress addr, UserGroupInformation ticket, Configuration conf, SocketFactory factory, <span class="keyword">int</span> rpcTimeout, RetryPolicy connectionRetryPolicy, AtomicBoolean fallbackToSimpleAuth)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(connectionRetryPolicy != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> UnsupportedOperationException(<span class="string">&quot;Not supported: connectionRetryPolicy=&quot;</span> + connectionRetryPolicy);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//Static Object newProxyInstance(ClassLoader loader, Class[] interfaces, InvocationHandler h)</span></span><br><span class="line">        <span class="comment">//è¿”å›ä»£ç†ç±»çš„ä¸€ä¸ªå®ä¾‹ï¼Œè¿”å›åçš„ä»£ç†ç±»å¯ä»¥å½“ä½œè¢«ä»£ç†ç±»ä½¿ç”¨</span></span><br><span class="line">        <span class="comment">//(å¯ä½¿ç”¨è¢«ä»£ç†ç±»çš„åœ¨Subjectæ¥å£ä¸­å£°æ˜è¿‡çš„æ–¹æ³•)ã€‚</span></span><br><span class="line">        <span class="comment">//InvocationHandler æ˜¯ä»£ç†è§’è‰²ï¼Œå…·ä½“æ–¹æ³•çš„è°ƒç”¨åœ¨è¿™é‡Œinvokeæ–¹æ³•ä¸­</span></span><br><span class="line">        Object proxy = Proxy.newProxyInstance(protocol.getClassLoader(), <span class="keyword">new</span> Class[]&#123;protocol&#125;, <span class="keyword">new</span> WritableRpcEngine.Invoker(protocol, addr, ticket, conf, factory, rpcTimeout, fallbackToSimpleAuth));</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ProtocolProxy(protocol, proxy, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Proxyå®ä¾‹åŒ–æ—¶ä¼ è¿›å»çš„InvocationHandlerçš„å®ç°ç±»æ˜¯WritableRpcEngineçš„å†…éƒ¨ç±»Invokerï¼Œæ„é€ æ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Invoker</span><span class="params">(Class&lt;?&gt; protocol, InetSocketAddress address, UserGroupInformation ticket, Configuration conf, SocketFactory factory, <span class="keyword">int</span> rpcTimeout, AtomicBoolean fallbackToSimpleAuth)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.remoteId = ConnectionId.getConnectionId(address, protocol, ticket, rpcTimeout, conf);</span><br><span class="line">    <span class="keyword">this</span>.client = WritableRpcEngine.CLIENTS.getClient(conf, factory);</span><br><span class="line">    <span class="keyword">this</span>.fallbackToSimpleAuth = fallbackToSimpleAuth;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“clientç«¯é€šè¿‡Proxyçš„å®ä¾‹åŒ–å¯¹è±¡è°ƒç”¨åè®®çš„ç›¸å…³æ¥å£æ—¶ï¼ˆå³demoä¸­<code>proxy.add(5, 6)</code>ï¼‰,ä¼šè°ƒç”¨WritableRpcEngine.Invokerä¸­çš„invokeæ–¹æ³•ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, Object[] args)</span> <span class="keyword">throws</span> Throwable </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    ObjectWritable value;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        value = (ObjectWritable)<span class="keyword">this</span>.client.call(RpcKind.RPC_WRITABLE, <span class="keyword">new</span> WritableRpcEngine.Invocation(method, args), <span class="keyword">this</span>.remoteId, <span class="keyword">this</span>.fallbackToSimpleAuth);</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">        <span class="keyword">if</span>(traceScope != <span class="keyword">null</span>) &#123;</span><br><span class="line">            traceScope.close();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> value.get();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œè°ƒç”¨äº†Clientç±»çš„callæ–¹æ³•ï¼Œ<strong>WritableRpcEngine.Invocationclientå®ç°äº†Writableæ¥å£ï¼Œè¿™é‡Œçš„ä½œç”¨æ˜¯å°†method å’Œ args è¿›è¡Œåºåˆ—åŒ–</strong>ã€‚clientæ˜¯åœ¨Invokerçš„æ„é€ æ–¹æ³•ä¸­å®ä¾‹åŒ–çš„ï¼Œcallçš„å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Writable <span class="title">call</span><span class="params">(RpcKind rpcKind, Writable rpcRequest, Client.ConnectionId remoteId, <span class="keyword">int</span> serviceClass, AtomicBoolean fallbackToSimpleAuth)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="comment">// å°†è¿œç¨‹è°ƒç”¨ä¿¡æ¯å°è£…æˆä¸€ä¸ªClient.Callå¯¹è±¡ æ¯ä¸ªCalléƒ½æœ‰ä¸€ä¸ªå”¯ä¸€çš„callId</span></span><br><span class="line">    Client.Call call = <span class="keyword">this</span>.createCall(rpcKind, rpcRequest);</span><br><span class="line">    <span class="comment">// æ ¹æ®remoteIdåˆ›å»ºä¸€ä¸ªconnectionå¯¹è±¡ï¼Œå¹¶å°†callæ”¾åˆ°è¯¥å¯¹è±¡çš„hashtable callsä¸­</span></span><br><span class="line">    Client.Connection connection = <span class="keyword">this</span>.getConnection(remoteId, call, serviceClass, fallbackToSimpleAuth);</span><br><span class="line">    ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨callæ–¹æ³•ä¸­å…ˆå°†è¿œç¨‹è°ƒç”¨ä¿¡æ¯å°è£…æˆä¸€ä¸ª<code>Client.Call</code>å¯¹è±¡ï¼Œç„¶åé€šè¿‡getConnectionå¾—åˆ°connectionå¯¹è±¡ï¼Œå°†å°è£…å¥½çš„callå¯¹è±¡æ”¾å…¥connectionå¯¹è±¡çš„hashtable callsä¸­ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Client.<span class="function">Connection <span class="title">getConnection</span><span class="params">(Client.ConnectionId remoteId, Client.Call call, <span class="keyword">int</span> serviceClass, AtomicBoolean fallbackToSimpleAuth)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(!<span class="keyword">this</span>.running.get()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;The client is stopped&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        Client.Connection connection;</span><br><span class="line">        <span class="keyword">do</span> &#123;</span><br><span class="line">            Hashtable var6 = <span class="keyword">this</span>.connections;  <span class="comment">// connections æ˜¯ä¸ª hashtable</span></span><br><span class="line">            <span class="keyword">synchronized</span>(<span class="keyword">this</span>.connections) &#123;</span><br><span class="line">                <span class="comment">// å…ˆä» connectionsä¸­æŸ¥æ‰¾æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ™åˆ›å»º</span></span><br><span class="line">                connection = (Client.Connection)<span class="keyword">this</span>.connections.get(remoteId);</span><br><span class="line">                <span class="keyword">if</span>(connection == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="comment">// è¿™é‡Œnew åªæ˜¯å¯¹ä¸€äº›ç›¸å…³å±æ€§è¿›è¡Œèµ‹å€¼ï¼Œå¹¶æ²¡æœ‰çœŸæ­£çš„å»ºç«‹è¿æ¥</span></span><br><span class="line">                    connection = <span class="keyword">new</span> Client.Connection(remoteId, serviceClass);</span><br><span class="line">                    <span class="keyword">this</span>.connections.put(remoteId, connection);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">while</span>(!connection.addCall(call)); <span class="comment">// å¾—åˆ°connectionä¹‹åå°†callæ”¾å…¥callsçš„hashtableä¸­</span></span><br><span class="line">        <span class="comment">// å»ºç«‹è¿æ¥</span></span><br><span class="line">        connection.setupIOstreams(fallbackToSimpleAuth);</span><br><span class="line">        <span class="keyword">return</span> connection;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>setupIOstreams</code>ä¸­å»ºç«‹è¿æ¥ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** Connect to the server and set up the I/O streams. It then sends</span></span><br><span class="line"><span class="comment"> * a header to the server and starts</span></span><br><span class="line"><span class="comment"> * the connection thread that waits for responses.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setupIOstreams</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    AtomicBoolean fallbackToSimpleAuth)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (socket != <span class="keyword">null</span> || shouldCloseConnection.get()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot;Connecting to &quot;</span>+server);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (Trace.isTracing()) &#123;</span><br><span class="line">      Trace.addTimelineAnnotation(<span class="string">&quot;IPC client connecting to &quot;</span> + server);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">short</span> numRetries = <span class="number">0</span>;</span><br><span class="line">    Random rand = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">      <span class="comment">// å»ºç«‹socketè¿›è¡Œè¿æ¥     å¯è§clientæ˜¯ç”¨socketè¿›è¡Œé€šä¿¡</span></span><br><span class="line">      setupConnection();</span><br><span class="line">      InputStream inStream = NetUtils.getInputStream(socket);</span><br><span class="line">      OutputStream outStream = NetUtils.getOutputStream(socket);</span><br><span class="line">      <span class="comment">// Write the connection header - this is sent when connection is established</span></span><br><span class="line">      writeConnectionHeader(outStream); </span><br><span class="line">      <span class="keyword">if</span> (authProtocol == AuthProtocol.SASL) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å‘é€ping messageï¼Œ</span></span><br><span class="line">      <span class="comment">// The time after which a RPC will timeout.</span></span><br><span class="line">      <span class="comment">// If ping is not enabled (via ipc.client.ping), then the timeout value is the</span></span><br><span class="line">      <span class="comment">// same as the pingInterval.</span></span><br><span class="line">      <span class="comment">// If ping is enabled, then there is no timeout value.</span></span><br><span class="line">      <span class="keyword">if</span> (doPing) &#123;</span><br><span class="line">        inStream = <span class="keyword">new</span> PingInputStream(inStream);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.in = <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> BufferedInputStream(inStream));</span><br><span class="line"></span><br><span class="line">      <span class="comment">// SASL may have already buffered the stream</span></span><br><span class="line">      <span class="keyword">if</span> (!(outStream <span class="keyword">instanceof</span> BufferedOutputStream)) &#123;</span><br><span class="line">        outStream = <span class="keyword">new</span> BufferedOutputStream(outStream);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.out = <span class="keyword">new</span> DataOutputStream(outStream);</span><br><span class="line">      <span class="comment">// å‘å†…å®¹ä¸­å†™å…¥æ¶ˆæ¯ï¼Œè¿™é‡Œé¢å°† connectionContextHeaderçš„åºåˆ—åŒ–åè®®å†™æ­»äº†ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆï¼Ÿï¼Ÿ</span></span><br><span class="line">      <span class="comment">// RpcRequestHeaderProto connectionContextHeader = ProtoUtil</span></span><br><span class="line">      <span class="comment">//  .makeRpcRequestHeader(RpcKind.RPC_PROTOCOL_BUFFER,</span></span><br><span class="line">      <span class="comment">//      OperationProto.RPC_FINAL_PACKET, CONNECTION_CONTEXT_CALL_ID,</span></span><br><span class="line">      <span class="comment">//      RpcConstants.INVALID_RETRY_COUNT, clientId);</span></span><br><span class="line">      <span class="comment">// è¿™ä¸ªæ–¹æ³•ä¸ writeConnectionHeader()çš„åŒºåˆ«æ˜¯ä»€ä¹ˆ ï¼Œæš‚æ—¶è¿˜æ²¡æœ‰ææ¸…ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚ã€‚</span></span><br><span class="line">      writeConnectionContext(remoteId, authMethod);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// update last activity time</span></span><br><span class="line">      touch();</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (Trace.isTracing()) &#123;</span><br><span class="line">        Trace.addTimelineAnnotation(<span class="string">&quot;IPC client connected to &quot;</span> + server);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// start the receiver thread after the socket connection has been set</span></span><br><span class="line">      <span class="comment">// up</span></span><br><span class="line">      start();    <span class="comment">// å¯åŠ¨connectionçº¿ç¨‹ï¼Œç­‰å¾…æ¥å—serverçš„response</span></span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    <span class="keyword">if</span> (t <span class="keyword">instanceof</span> IOException) &#123;</span><br><span class="line">      markClosed((IOException)t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      markClosed(<span class="keyword">new</span> IOException(<span class="string">&quot;Couldn&#x27;t set up IO streams&quot;</span>, t));</span><br><span class="line">    &#125;</span><br><span class="line">    close();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡<code>setupConnection</code>æ–¹æ³•è¿›è¡Œsocketè¿æ¥</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setupConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">short</span> ioFailures = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">short</span> timeoutFailures = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// åˆ›å»ºä¸€ä¸ªç½‘ç»œsocket</span></span><br><span class="line">      <span class="keyword">this</span>.socket = socketFactory.createSocket();</span><br><span class="line">      <span class="keyword">this</span>.socket.setTcpNoDelay(tcpNoDelay);</span><br><span class="line">      <span class="keyword">this</span>.socket.setKeepAlive(<span class="keyword">true</span>);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * Bind the socket to the host specified in the principal name of the</span></span><br><span class="line"><span class="comment">       * client, to ensure Server matching address of the client connection</span></span><br><span class="line"><span class="comment">       * to host name in principal passed.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      UserGroupInformation ticket = remoteId.getTicket();</span><br><span class="line">      <span class="keyword">if</span> (ticket != <span class="keyword">null</span> &amp;&amp; ticket.hasKerberosCredentials()) &#123;</span><br><span class="line">        KerberosInfo krbInfo = </span><br><span class="line">          remoteId.getProtocol().getAnnotation(KerberosInfo.class);</span><br><span class="line">        <span class="keyword">if</span> (krbInfo != <span class="keyword">null</span> &amp;&amp; krbInfo.clientPrincipal() != <span class="keyword">null</span>) &#123;</span><br><span class="line">          String host = </span><br><span class="line">            SecurityUtil.getHostFromPrincipal(remoteId.getTicket().getUserName());</span><br><span class="line">          </span><br><span class="line">          <span class="comment">// If host name is a valid local address then bind socket to it</span></span><br><span class="line">          InetAddress localAddr = NetUtils.getLocalInetAddress(host);</span><br><span class="line">          <span class="keyword">if</span> (localAddr != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">this</span>.socket.bind(<span class="keyword">new</span> InetSocketAddress(localAddr, <span class="number">0</span>));</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// server åœ¨ connectionçš„æ„é€ æ–¹æ³•ä¸­è¿›è¡Œèµ‹å€¼ï¼Œ</span></span><br><span class="line">      <span class="comment">// this.server = remoteId.getAddress();</span></span><br><span class="line">      <span class="comment">// åœ¨connectä¸­è¿›è¡Œsocketä¸ipçš„ç»‘å®šè¿æ¥</span></span><br><span class="line">      NetUtils.connect(<span class="keyword">this</span>.socket, server, connectionTimeout);</span><br><span class="line">      <span class="keyword">if</span> (rpcTimeout &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        pingInterval = rpcTimeout;  <span class="comment">// rpcTimeout overwrites pingInterval</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">this</span>.socket.setSoTimeout(pingInterval);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ConnectTimeoutException toe) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ie) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å»ºç«‹è¿æ¥ä¹‹åï¼Œå¯åŠ¨connectionçº¿ç¨‹ï¼Œè¿è¡Œ<code>run</code>æ–¹æ³•ï¼Œç­‰å¾…serverç«¯çš„responseã€‚ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (LOG.isDebugEnabled())</span><br><span class="line">    LOG.debug(getName() + <span class="string">&quot;: starting, having connections &quot;</span> </span><br><span class="line">        + connections.size());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">while</span> (waitForWork()) &#123;<span class="comment">//wait here for work - read or close connection</span></span><br><span class="line">      receiveRpcResponse();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    <span class="comment">// This truly is unexpected, since we catch IOException in receiveResponse</span></span><br><span class="line">    <span class="comment">// -- this is only to be really sure that we don&#x27;t leave a client hanging</span></span><br><span class="line">    <span class="comment">// forever.</span></span><br><span class="line">    LOG.warn(<span class="string">&quot;Unexpected error reading responses on connection &quot;</span> + <span class="keyword">this</span>, t);</span><br><span class="line">    markClosed(<span class="keyword">new</span> IOException(<span class="string">&quot;Error reading responses&quot;</span>, t));</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  close();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (LOG.isDebugEnabled())</span><br><span class="line">    LOG.debug(getName() + <span class="string">&quot;: stopped, remaining connections &quot;</span></span><br><span class="line">        + connections.size());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>getConnection</code>é€»è¾‘å·²ç»åˆæ­¥å®Œç»“ï¼Œç°åœ¨å›åˆ°<code>call</code>ä»£ç ä¸­ï¼Œç»§ç»­åˆ†æå…¶ä»£ç ï¼Œä¸‹é¢çš„å…³é”®ä»£ç æ˜¯<code>connection.sendRpcRequest(call)</code>ï¼Œå‘é€callå¯¹è±¡åˆ°serverç«¯ï¼Œå¹¶è¿›å…¥é˜»å¡çŠ¶æ€ç­‰å¾…serverçš„responseã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Writable <span class="title">call</span><span class="params">(RpcKind rpcKind, Writable rpcRequest, Client.ConnectionId remoteId, <span class="keyword">int</span> serviceClass, AtomicBoolean fallbackToSimpleAuth)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// å°†è¿œç¨‹è°ƒç”¨ä¿¡æ¯å‘é€ç»™serverç«¯</span></span><br><span class="line">        connection.sendRpcRequest(call);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (RejectedExecutionException var13) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;connection has been closed&quot;</span>, var13);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException var14) &#123;</span><br><span class="line">        Thread.currentThread().interrupt();</span><br><span class="line">        LOG.warn(<span class="string">&quot;interrupted waiting to send rpc request to server&quot;</span>, var14);</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IOException(var14);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> interrupted = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(call) &#123;</span><br><span class="line">        <span class="comment">// åˆ¤æ–­callæ˜¯å¦å®Œæˆï¼Œç­‰å¾…serverç«¯notify</span></span><br><span class="line">        <span class="keyword">while</span>(!call.done) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                 call.wait();   <span class="comment">// å½“å‰çº¿ç¨‹blockingä½ï¼Œç­‰å¾…Connectionçº¿ç¨‹ä¸­receiveRpcResponseè°ƒç”¨call.notify</span></span><br><span class="line">            &#125; <span class="keyword">catch</span> (InterruptedException var12) &#123;</span><br><span class="line">                interrupted = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(interrupted) &#123;</span><br><span class="line">            Thread.currentThread().interrupt();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(call.error != <span class="keyword">null</span>) &#123;</span><br><span class="line">            ...</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// get server çš„ç»“æœ</span></span><br><span class="line">            <span class="keyword">return</span> call.getRpcResponse();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRpcRequest</span><span class="params">(<span class="keyword">final</span> Call call)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> InterruptedException, IOException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (shouldCloseConnection.get()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Serialize the call to be sent. This is done from the actual</span></span><br><span class="line">  <span class="comment">// caller thread, rather than the sendParamsExecutor thread,</span></span><br><span class="line">  </span><br><span class="line">  <span class="comment">// so that if the serialization throws an error, it is reported</span></span><br><span class="line">  <span class="comment">// properly. This also parallelizes the serialization.</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Format of a call on the wire:</span></span><br><span class="line">  <span class="comment">// 0) Length of rest below (1 + 2)</span></span><br><span class="line">  <span class="comment">// 1) RpcRequestHeader  - is serialized Delimited hence contains length</span></span><br><span class="line">  <span class="comment">// 2) RpcRequest</span></span><br><span class="line">  <span class="comment">//</span></span><br><span class="line">  <span class="comment">// Items &#x27;1&#x27; and &#x27;2&#x27; are prepared here. </span></span><br><span class="line">  <span class="keyword">final</span> DataOutputBuffer d = <span class="keyword">new</span> DataOutputBuffer();</span><br><span class="line">  RpcRequestHeaderProto header = ProtoUtil.makeRpcRequestHeader(</span><br><span class="line">      call.rpcKind, OperationProto.RPC_FINAL_PACKET, call.id, call.retry,</span><br><span class="line">      clientId);</span><br><span class="line">  header.writeDelimitedTo(d);</span><br><span class="line">  call.rpcRequest.write(d);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span> (sendRpcRequestLock) &#123;</span><br><span class="line">    Future&lt;?&gt; senderFuture = sendParamsExecutor.submit(<span class="keyword">new</span> Runnable() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (Connection.<span class="keyword">this</span>.out) &#123;</span><br><span class="line">            <span class="keyword">if</span> (shouldCloseConnection.get()) &#123;</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">if</span> (LOG.isDebugEnabled())</span><br><span class="line">              LOG.debug(getName() + <span class="string">&quot; sending #&quot;</span> + call.id);</span><br><span class="line">     </span><br><span class="line">            <span class="keyword">byte</span>[] data = d.getData();</span><br><span class="line">            <span class="keyword">int</span> totalLength = d.getLength();</span><br><span class="line">            out.writeInt(totalLength); <span class="comment">// Total Length</span></span><br><span class="line">            out.write(data, <span class="number">0</span>, totalLength);<span class="comment">// RpcRequestHeader + RpcRequest</span></span><br><span class="line">            out.flush();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          <span class="comment">// exception at this point would leave the connection in an</span></span><br><span class="line">          <span class="comment">// unrecoverable state (eg half a call left on the wire).</span></span><br><span class="line">          <span class="comment">// So, close the connection, killing any outstanding calls</span></span><br><span class="line">          markClosed(e);</span><br><span class="line">        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">          <span class="comment">//the buffer is just an in-memory buffer, but it is still polite to</span></span><br><span class="line">          <span class="comment">// close early</span></span><br><span class="line">          IOUtils.closeStream(d);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// ç­‰å¾…callå‘é€å®Œæ¯•ä¹‹åæ‰é€€å‡ºè¯¥æ–¹æ³•ï¼Œå›åˆ°callæ–¹æ³•ä¸­ç»§ç»­æ‰§è¡Œ</span></span><br><span class="line">      senderFuture.get();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (ExecutionException e) &#123;</span><br><span class="line">      Throwable cause = e.getCause();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// cause should only be a RuntimeException as the Runnable above</span></span><br><span class="line">      <span class="comment">// catches IOException</span></span><br><span class="line">      <span class="keyword">if</span> (cause <span class="keyword">instanceof</span> RuntimeException) &#123;</span><br><span class="line">        <span class="keyword">throw</span> (RuntimeException) cause;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;unexpected checked exception&quot;</span>, cause);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ¥ä¸‹æ¥çœ‹ä¸‹serverç«¯çš„ä»£ç ï¼Œserveræ˜¯é€šè¿‡RPC.Builderçš„buildæ–¹æ³•æ„å»ºå‡ºæ¥çš„ï¼Œæ¥çœ‹ä¸‹buildä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Server <span class="title">build</span><span class="params">()</span> <span class="keyword">throws</span> IOException, HadoopIllegalArgumentException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> getProtocolEngine(<span class="keyword">this</span>.protocol, <span class="keyword">this</span>.conf).getServer(</span><br><span class="line">      <span class="keyword">this</span>.protocol, <span class="keyword">this</span>.instance, <span class="keyword">this</span>.bindAddress, <span class="keyword">this</span>.port,</span><br><span class="line">      <span class="keyword">this</span>.numHandlers, <span class="keyword">this</span>.numReaders, <span class="keyword">this</span>.queueSizePerHandler,</span><br><span class="line">      <span class="keyword">this</span>.verbose, <span class="keyword">this</span>.conf, <span class="keyword">this</span>.secretManager, <span class="keyword">this</span>.portRangeConfig);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">public</span> RPC.<span class="function">Server <span class="title">getServer</span><span class="params">(Class&lt;?&gt; protocolClass,</span></span></span><br><span class="line"><span class="params"><span class="function">                    Object protocolImpl, String bindAddress, <span class="keyword">int</span> port,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">int</span> numHandlers, <span class="keyword">int</span> numReaders, <span class="keyword">int</span> queueSizePerHandler,</span></span></span><br><span class="line"><span class="params"><span class="function">                    <span class="keyword">boolean</span> verbose, Configuration conf,</span></span></span><br><span class="line"><span class="params"><span class="function">                    SecretManager&lt;? extends TokenIdentifier&gt; secretManager,</span></span></span><br><span class="line"><span class="params"><span class="function">                    String portRangeConfig)</span> </span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> Server(protocolClass, protocolImpl, conf, bindAddress, port,</span><br><span class="line">      numHandlers, numReaders, queueSizePerHandler, verbose, secretManager,</span><br><span class="line">      portRangeConfig);</span><br><span class="line">&#125;</span><br><span class="line">...</span><br><span class="line"><span class="comment">//åœ¨ Serverçš„æ„é€ æ–¹æ³•ä¸­ï¼Œä¸€è¿½è¿½æº¯åˆ°ipc.Serverçš„æ„é€ æ–¹æ³•</span></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="title">Server</span><span class="params">(String bindAddress, <span class="keyword">int</span> port,</span></span></span><br><span class="line"><span class="params"><span class="function">    Class&lt;? extends Writable&gt; rpcRequestClass, <span class="keyword">int</span> handlerCount,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> numReaders, <span class="keyword">int</span> queueSizePerHandler, Configuration conf,</span></span></span><br><span class="line"><span class="params"><span class="function">    String serverName, SecretManager&lt;? extends TokenIdentifier&gt; secretManager,</span></span></span><br><span class="line"><span class="params"><span class="function">    String portRangeConfig)</span></span></span><br><span class="line"><span class="function">  <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  ...  </span><br><span class="line">  <span class="comment">// Start the listener here and let it bind to the port</span></span><br><span class="line">  listener = <span class="keyword">new</span> Listener();</span><br><span class="line">  <span class="keyword">this</span>.port = listener.getAddress().getPort();    </span><br><span class="line">  connectionManager = <span class="keyword">new</span> ConnectionManager();</span><br><span class="line">  <span class="keyword">this</span>.rpcMetrics = RpcMetrics.create(<span class="keyword">this</span>, conf);</span><br><span class="line">  <span class="keyword">this</span>.rpcDetailedMetrics = RpcDetailedMetrics.create(<span class="keyword">this</span>.port);</span><br><span class="line">  <span class="keyword">this</span>.tcpNoDelay = conf.getBoolean(</span><br><span class="line">      CommonConfigurationKeysPublic.IPC_SERVER_TCPNODELAY_KEY,</span><br><span class="line">      CommonConfigurationKeysPublic.IPC_SERVER_TCPNODELAY_DEFAULT);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Create the responder here</span></span><br><span class="line">  responder = <span class="keyword">new</span> Responder();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (secretManager != <span class="keyword">null</span> || UserGroupInformation.isSecurityEnabled()) &#123;</span><br><span class="line">    SaslRpcServer.init(conf);</span><br><span class="line">    saslPropsResolver = SaslPropertiesResolver.getInstance(conf);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">this</span>.exceptionsHandler.addTerseExceptions(StandbyException.class);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨ipc.Serverçš„æ„é€ æ–¹æ³•ä¸­ä¼šå®ä¾‹åŒ–<code>Listener</code>å’Œ<code>Responder</code>ä¸¤ä¸ªçº¿ç¨‹ï¼Œå…ˆçœ‹ä¸‹Listenerçš„æ„é€ æ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">Listener</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  address = <span class="keyword">new</span> InetSocketAddress(bindAddress, port);</span><br><span class="line">  <span class="comment">// Create a new server socket and set to non blocking mode</span></span><br><span class="line">  acceptChannel = ServerSocketChannel.open();</span><br><span class="line">  acceptChannel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Bind the server socket to the local host and port</span></span><br><span class="line">  bind(acceptChannel.socket(), address, backlogLength, conf, portRangeConfig);</span><br><span class="line">  port = acceptChannel.socket().getLocalPort(); <span class="comment">//Could be an ephemeral port</span></span><br><span class="line">  <span class="comment">// create a selector;</span></span><br><span class="line">  selector= Selector.open();</span><br><span class="line">  <span class="comment">// åˆ›å»ºreaderæ•°ç»„ï¼Œé»˜è®¤é•¿åº¦ä¸º1</span></span><br><span class="line">  readers = <span class="keyword">new</span> Reader[readThreads];</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; readThreads; i++) &#123;</span><br><span class="line">    Reader reader = <span class="keyword">new</span> Reader(</span><br><span class="line">        <span class="string">&quot;Socket Reader #&quot;</span> + (i + <span class="number">1</span>) + <span class="string">&quot; for port &quot;</span> + port);</span><br><span class="line">    readers[i] = reader;</span><br><span class="line">    reader.start();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Register accepts on the server socket with the selector.</span></span><br><span class="line">  acceptChannel.register(selector, SelectionKey.OP_ACCEPT);</span><br><span class="line">  <span class="keyword">this</span>.setName(<span class="string">&quot;IPC Server listener on &quot;</span> + port);</span><br><span class="line">  <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªServeråªæœ‰ä¸€ä¸ªListenerçº¿ç¨‹ï¼Œåœ¨Listenerçº¿ç¨‹ä¸­ä½¿ç”¨Java NIOæ¥ç›‘å¬clientå‘æ¥çš„requestè¿æ¥ï¼Œåˆå§‹åŒ–Readeræ•°ç»„readersï¼ŒReaderä¸»è¦ç”¨äºååºåˆ—åŒ–æ•°æ®ï¼Œç”ŸæˆæœåŠ¡å™¨ç«¯çš„Callå¯¹è±¡ã€‚Listeneræ³¨å†Œçš„äº‹ä»¶æ˜¯SelectionKey.OP_ACCEPTï¼ŒReaderæ³¨å†Œçš„äº‹ä»¶æ˜¯SelectionKey.OP_READã€‚<br>Serverä¸­è¿˜å®ä¾‹åŒ–äº†ä¸€ä¸ª<code>Responder</code>çº¿ç¨‹ï¼Œæ„é€ æ–¹æ³•ä¸­åªæ˜¯å¾—åˆ°ä¸€ä¸ªSelectorå¯¹è±¡ï¼ŒListenerå’ŒReaderä¸­ä¹Ÿå„è‡ªå«æœ‰ä¸€ä¸ªSelectorå¯¹è±¡ï¼Œç”¨æ¥é€‰æ‹©è‡ªå·±å…³å¿ƒçš„äº‹ä»¶ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Responder() <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">this</span>.setName(<span class="string">&quot;IPC Server Responder&quot;</span>);</span><br><span class="line">  <span class="keyword">this</span>.setDaemon(<span class="keyword">true</span>);</span><br><span class="line">  writeSelector = Selector.open(); <span class="comment">// create a selector</span></span><br><span class="line">  pending = <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤Serveråˆå§‹åŒ–å®Œæ¯•ï¼Œç„¶åè°ƒç”¨<code>start</code>æ–¹æ³•ï¼Œå¯åŠ¨serverï¼Œå¯åŠ¨Serverä¸­<code>responder</code>ã€<code>listener</code>è¿˜æœ‰<code>handers</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  responder.start();</span><br><span class="line">  listener.start();</span><br><span class="line">  <span class="comment">//å¯åŠ¨Handerçº¿ç¨‹ï¼Œè¿™ä¸ªä¸ªæ•°æ˜¯åˆå§‹åŒ–Serveræ—¶é€šè¿‡setHanderè®¾ç½®çš„</span></span><br><span class="line">  handlers = <span class="keyword">new</span> Handler[handlerCount];</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; handlerCount; i++) &#123;</span><br><span class="line">    handlers[i] = <span class="keyword">new</span> Handler(i);</span><br><span class="line">    handlers[i].start();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ¥çœ‹ä¸‹listenerçš„runæ–¹æ³•ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(Thread.currentThread().getName() + <span class="string">&quot;: starting&quot;</span>);</span><br><span class="line">  SERVER.set(Server.<span class="keyword">this</span>);  <span class="comment">// ThreadLocal&lt;Server&gt; SERVER    çº¿ç¨‹å±€éƒ¨å˜é‡</span></span><br><span class="line">  connectionManager.startIdleScan();</span><br><span class="line">  <span class="keyword">while</span> (running) &#123;</span><br><span class="line">    SelectionKey key = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// å¾—åˆ°selector  </span></span><br><span class="line">      getSelector().select();</span><br><span class="line">      Iterator&lt;SelectionKey&gt; iter = getSelector().selectedKeys().iterator();</span><br><span class="line">      <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        key = iter.next();</span><br><span class="line">        iter.remove();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (key.isValid()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (key.isAcceptable())</span><br><span class="line">              <span class="comment">// SelectionKey.OP_ACCEPT å‘ç”Ÿåç”±doAcceptæ¥å¤„ç†</span></span><br><span class="line">              doAccept(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        key = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">      <span class="comment">// we can run out of memory if we have too many threads</span></span><br><span class="line">      <span class="comment">// log the event and sleep for a minute and give </span></span><br><span class="line">      <span class="comment">// some thread(s) a chance to finish</span></span><br><span class="line">      LOG.warn(<span class="string">&quot;Out of Memory in server select&quot;</span>, e);</span><br><span class="line">      closeCurrentConnection(key, e);</span><br><span class="line">      connectionManager.closeIdle(<span class="keyword">true</span>);</span><br><span class="line">      <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">60000</span>); &#125; <span class="keyword">catch</span> (Exception ie) &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      closeCurrentConnection(key, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Listeneré€šè¿‡selectorç›‘å¬SelectionKey.OP_ACCEPTäº‹ä»¶ï¼Œ<em>å®¢æˆ·ç«¯Client.callä¸­çš„getConnectionä¼šè§¦å‘è¯¥äº‹ä»¶</em>ï¼Œå½“äº‹ä»¶å‘ç”Ÿåè°ƒç”¨<code>doAccept</code>ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doAccept</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> InterruptedException, IOException,  OutOfMemoryError </span>&#123;</span><br><span class="line">  ServerSocketChannel server = (ServerSocketChannel) key.channel();</span><br><span class="line">  SocketChannel channel;</span><br><span class="line">  <span class="keyword">while</span> ((channel = server.accept()) != <span class="keyword">null</span>) &#123;</span><br><span class="line"></span><br><span class="line">    channel.configureBlocking(<span class="keyword">false</span>);</span><br><span class="line">    channel.socket().setTcpNoDelay(tcpNoDelay);</span><br><span class="line">    channel.socket().setKeepAlive(<span class="keyword">true</span>);</span><br><span class="line">    <span class="comment">// Listener å¾—åˆ°clientçš„è¿æ¥ä¹‹åï¼Œäº¤ç»™Readerå¤„ç†</span></span><br><span class="line">    <span class="comment">// ä»readersæ•°ç»„ä¸­å¾—åˆ°ä¸€ä¸ªReader</span></span><br><span class="line">    Reader reader = getReader();</span><br><span class="line">    <span class="comment">// Server ç«¯çš„Connectionä¸æ˜¯ä¸€ä¸ªçº¿ç¨‹ï¼Œæ³¨æ„å’ŒClientçš„Connectionçš„åŒºåˆ«</span></span><br><span class="line">    <span class="comment">// Connectionç›¸å½“äºhander</span></span><br><span class="line">    Connection c = connectionManager.register(channel);</span><br><span class="line">    <span class="comment">// å°†å½“å‰Connectionå·²ç»è¢«å»ºç«‹è¿æ¥ï¼Œç­‰å¾…closeCurrentConnectionå…³é—­è¿æ¥</span></span><br><span class="line">    key.attach(c);  <span class="comment">// so closeCurrentConnection can get the object</span></span><br><span class="line">    <span class="comment">// å°†Connectionæ”¾å…¥Reader.pendingConnectionsï¼Œç­‰å¾…Readerå¤„ç†</span></span><br><span class="line">    reader.addConnection(c);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>reader.addConnection(c)</code>çš„ä»£ç æ˜¯ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addConnection</span><span class="params">(Connection conn)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  pendingConnections.put(conn);</span><br><span class="line">  <span class="comment">// è°ƒç”¨wakeup æ˜¯è®©çº¿ç¨‹ä»select()æ–¹æ³•çš„é˜»å¡ä¸­è·³å‡ºæ¥</span></span><br><span class="line">  <span class="comment">// å› ä¸ºpendingConnectionså·²ç»åŠ å…¥äº†æ–°çš„Connection</span></span><br><span class="line">  readSelector.wakeup();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹ä»<code>select()</code>ä¸­è·³å‡ºæ¥ä¹‹åï¼Œç»§ç»­è¿è¡Œ<code>Reader.run()</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;Starting &quot;</span> + Thread.currentThread().getName());</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    doRunLoop();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      readSelector.close();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ioe) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Error closing read selector in &quot;</span> + Thread.currentThread().getName(), ioe);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">doRunLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (running) &#123;</span><br><span class="line">    SelectionKey key = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// consume as many connections as currently queued to avoid</span></span><br><span class="line">      <span class="comment">// unbridled acceptance of connections that starves the select</span></span><br><span class="line">      <span class="keyword">int</span> size = pendingConnections.size();</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i=size; i&gt;<span class="number">0</span>; i--) &#123;</span><br><span class="line">        <span class="comment">// pendingConnections æ˜¯ä¸€ä¸ª BlockingQueue</span></span><br><span class="line">        Connection conn = pendingConnections.take();</span><br><span class="line">        conn.channel.register(readSelector, SelectionKey.OP_READ, conn);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// æ­¤æ–¹æ³•ä¼šé˜»å¡ï¼Œè°ƒç”¨readSelector.wakeup()è·³å‡ºé˜»å¡</span></span><br><span class="line">      readSelector.select();</span><br><span class="line"></span><br><span class="line">      Iterator&lt;SelectionKey&gt; iter = readSelector.selectedKeys().iterator();</span><br><span class="line">      <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        key = iter.next();</span><br><span class="line">        iter.remove();</span><br><span class="line">        <span class="keyword">if</span> (key.isValid()) &#123;</span><br><span class="line">          <span class="keyword">if</span> (key.isReadable()) &#123;</span><br><span class="line">            doRead(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        key = <span class="keyword">null</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      <span class="keyword">if</span> (running) &#123;                      <span class="comment">// unexpected -- log it</span></span><br><span class="line">        LOG.info(Thread.currentThread().getName() + <span class="string">&quot; unexpectedly interrupted&quot;</span>, e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (IOException ex) &#123;</span><br><span class="line">      LOG.error(<span class="string">&quot;Error in Reader&quot;</span>, ex);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doRead</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> count = <span class="number">0</span>;</span><br><span class="line">  Connection c = (Connection)key.attachment();</span><br><span class="line">  <span class="keyword">if</span> (c == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;  </span><br><span class="line">  &#125;</span><br><span class="line">  c.setLastContact(Time.now());</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    count = c.readAndProcess();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (InterruptedException ieo) &#123;</span><br><span class="line">    LOG.info(Thread.currentThread().getName() + <span class="string">&quot;: readAndProcess caught InterruptedException&quot;</span>, ieo);</span><br><span class="line">    <span class="keyword">throw</span> ieo;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    <span class="comment">// a WrappedRpcServerException is an exception that has been sent</span></span><br><span class="line">    <span class="comment">// to the client, so the stacktrace is unnecessary; any other</span></span><br><span class="line">    <span class="comment">// exceptions are unexpected internal server errors and thus the</span></span><br><span class="line">    <span class="comment">// stacktrace should be logged</span></span><br><span class="line">    LOG.info(Thread.currentThread().getName() + <span class="string">&quot;: readAndProcess from client &quot;</span> +</span><br><span class="line">        c.getHostAddress() + <span class="string">&quot; threw exception [&quot;</span> + e + <span class="string">&quot;]&quot;</span>,</span><br><span class="line">        (e <span class="keyword">instanceof</span> WrappedRpcServerException) ? <span class="keyword">null</span> : e);</span><br><span class="line">    count = -<span class="number">1</span>; <span class="comment">//so that the (count &lt; 0) block is executed</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (count &lt; <span class="number">0</span>) &#123;</span><br><span class="line">    closeConnection(c);</span><br><span class="line">    c = <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span> &#123;</span><br><span class="line">    c.setLastContact(Time.now());</span><br><span class="line">  &#125;</span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">readAndProcess</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> WrappedRpcServerException, IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">    <span class="comment">/* Read at most one RPC. If the header is not read completely yet</span></span><br><span class="line"><span class="comment">     * then iterate until we read first RPC or until there is no data left.</span></span><br><span class="line"><span class="comment">     */</span>    </span><br><span class="line">    <span class="keyword">int</span> count = -<span class="number">1</span>;</span><br><span class="line">    <span class="comment">// this.dataLengthBuffer = ByteBuffer.allocate(4)</span></span><br><span class="line">    <span class="keyword">if</span> (dataLengthBuffer.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      count = channelRead(channel, dataLengthBuffer);       </span><br><span class="line">      <span class="keyword">if</span> (count &lt; <span class="number">0</span> || dataLengthBuffer.remaining() &gt; <span class="number">0</span>) </span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¯»å–RPC header RPC headerä¸€å…±4éƒ¨åˆ†</span></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Write the connection header - this is sent when connection is established</span></span><br><span class="line"><span class="comment">     * +----------------------------------+</span></span><br><span class="line"><span class="comment">     * |  &quot;hrpc&quot; 4 bytes                  |   hrpc åœ¨ä¸Šé¢çš„ifè¯­å¥ä¸­è¯»å–     </span></span><br><span class="line"><span class="comment">     * +----------------------------------+</span></span><br><span class="line"><span class="comment">     * |  Version (1 byte)                |</span></span><br><span class="line"><span class="comment">     * +----------------------------------+</span></span><br><span class="line"><span class="comment">     * |  Service Class (1 byte)          |</span></span><br><span class="line"><span class="comment">     * +----------------------------------+</span></span><br><span class="line"><span class="comment">     * |  AuthProtocol (1 byte)           |      </span></span><br><span class="line"><span class="comment">     * +----------------------------------+</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">if</span> (!connectionHeaderRead) &#123;</span><br><span class="line">      <span class="comment">//Every connection is expected to send the header.</span></span><br><span class="line">      <span class="keyword">if</span> (connectionHeaderBuf == <span class="keyword">null</span>) &#123;</span><br><span class="line">        connectionHeaderBuf = ByteBuffer.allocate(<span class="number">3</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å°† Versionã€Service Classã€AuthProtocolè¯»å‡º </span></span><br><span class="line">      count = channelRead(channel, connectionHeaderBuf);</span><br><span class="line">      <span class="keyword">if</span> (count &lt; <span class="number">0</span> || connectionHeaderBuf.remaining() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">int</span> version = connectionHeaderBuf.get(<span class="number">0</span>);</span><br><span class="line">      <span class="comment">// TODO we should add handler for service class later</span></span><br><span class="line">      <span class="keyword">this</span>.setServiceClass(connectionHeaderBuf.get(<span class="number">1</span>));</span><br><span class="line">      dataLengthBuffer.flip();</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// Check if it looks like the user is hitting an IPC port</span></span><br><span class="line">      <span class="comment">// with an HTTP GET - this is a common error, so we can</span></span><br><span class="line">      <span class="comment">// send back a simple string indicating as much.</span></span><br><span class="line">      <span class="keyword">if</span> (HTTP_GET_BYTES.equals(dataLengthBuffer)) &#123;</span><br><span class="line">        setupHttpRequestOnIpcPortResponse();</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (!RpcConstants.HEADER.equals(dataLengthBuffer)</span><br><span class="line">          || version != CURRENT_VERSION) &#123;</span><br><span class="line">        <span class="comment">//Warning is ok since this is not supposed to happen.</span></span><br><span class="line">        LOG.warn(<span class="string">&quot;Incorrect header or version mismatch from &quot;</span> + </span><br><span class="line">                 hostAddress + <span class="string">&quot;:&quot;</span> + remotePort +</span><br><span class="line">                 <span class="string">&quot; got version &quot;</span> + version + </span><br><span class="line">                 <span class="string">&quot; expected version &quot;</span> + CURRENT_VERSION);</span><br><span class="line">        setupBadVersionResponse(version);</span><br><span class="line">        <span class="keyword">return</span> -<span class="number">1</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// this may switch us into SIMPLE</span></span><br><span class="line">      authProtocol = initializeAuthContext(connectionHeaderBuf.get(<span class="number">2</span>));          </span><br><span class="line">      </span><br><span class="line">      dataLengthBuffer.clear();</span><br><span class="line">      connectionHeaderBuf = <span class="keyword">null</span>;</span><br><span class="line">      connectionHeaderRead = <span class="keyword">true</span>;</span><br><span class="line">      <span class="comment">// è¯»å®Œrpc headä¹‹åè·³å‡ºæ­¤æ¬¡å¾ªç¯</span></span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¯»å–rpcrequestçš„å†…å®¹</span></span><br><span class="line">    <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">      dataLengthBuffer.flip();</span><br><span class="line">      dataLength = dataLengthBuffer.getInt();</span><br><span class="line">      checkDataLength(dataLength);</span><br><span class="line">      data = ByteBuffer.allocate(dataLength);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    count = channelRead(channel, data);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (data.remaining() == <span class="number">0</span>) &#123;</span><br><span class="line">      dataLengthBuffer.clear();</span><br><span class="line">      data.flip();</span><br><span class="line">      <span class="keyword">boolean</span> isHeaderRead = connectionContextRead;</span><br><span class="line">      <span class="comment">// å…ˆè¿›è¡Œæˆæƒç„¶åè¿›è¡Œå†…å®¹çš„è¯»å–</span></span><br><span class="line">      processOneRpc(data.array());</span><br><span class="line">      data = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> (!isHeaderRead) &#123;</span><br><span class="line">        <span class="comment">// è¯»å–requestå†…å®¹æ—¶å…ˆè¿›è¡Œæˆæƒï¼ŒæˆæƒæˆåŠŸä¹‹åconnectionContextReadå˜ä¸ºtrue</span></span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    <span class="keyword">return</span> count;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processOneRpc</span><span class="params">(<span class="keyword">byte</span>[] buf)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, WrappedRpcServerException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> callId = -<span class="number">1</span>;</span><br><span class="line">  <span class="keyword">int</span> retry = RpcConstants.INVALID_RETRY_COUNT;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> DataInputStream dis =</span><br><span class="line">        <span class="keyword">new</span> DataInputStream(<span class="keyword">new</span> ByteArrayInputStream(buf));</span><br><span class="line">    <span class="keyword">final</span> RpcRequestHeaderProto header =</span><br><span class="line">        decodeProtobufFromStream(RpcRequestHeaderProto.newBuilder(), dis);</span><br><span class="line">    callId = header.getCallId();</span><br><span class="line">    retry = header.getRetryCount();</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot; got #&quot;</span> + callId);</span><br><span class="line">    &#125;</span><br><span class="line">    checkRpcHeaders(header);</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€æ¬¡è¿æ¥callIdæ˜¯CONNECTION_CONTEXT_CALL_IDçš„å€¼ä¸º</span></span><br><span class="line">    <span class="comment">// -3ï¼Œå¤„ç†æˆæƒï¼ŒéªŒè¯é€šè¿‡åè®¾ç½®connectionContextReadçš„å€¼ä¸ºtrue</span></span><br><span class="line">    <span class="keyword">if</span> (callId &lt; <span class="number">0</span>) &#123; <span class="comment">// callIds typically used during connection setup</span></span><br><span class="line">      processRpcOutOfBandRequest(header, dis);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (!connectionContextRead) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> WrappedRpcServerException(</span><br><span class="line">          RpcErrorCodeProto.FATAL_INVALID_RPC_HEADER,</span><br><span class="line">          <span class="string">&quot;Connection context not established&quot;</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// éšåçš„è¿æ¥å¤„ç†é€»è¾‘  </span></span><br><span class="line">      processRpcRequest(header, dis);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (WrappedRpcServerException wrse) &#123; <span class="comment">// inform client of error</span></span><br><span class="line">    Throwable ioe = wrse.getCause();</span><br><span class="line">    <span class="keyword">final</span> Call call = <span class="keyword">new</span> Call(callId, retry, <span class="keyword">null</span>, <span class="keyword">this</span>);</span><br><span class="line">    setupResponse(authFailedResponse, call,</span><br><span class="line">        RpcStatusProto.FATAL, wrse.getRpcErrorCodeProto(), <span class="keyword">null</span>,</span><br><span class="line">        ioe.getClass().getName(), ioe.getMessage());</span><br><span class="line">    responder.doRespond(call);</span><br><span class="line">    <span class="keyword">throw</span> wrse;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processRpcRequest</span><span class="params">(RpcRequestHeaderProto header,</span></span></span><br><span class="line"><span class="params"><span class="function">     DataInputStream dis)</span> <span class="keyword">throws</span> WrappedRpcServerException,</span></span><br><span class="line"><span class="function">     InterruptedException </span>&#123;</span><br><span class="line">   Class&lt;? extends Writable&gt; rpcRequestClass = </span><br><span class="line">       getRpcRequestWrapper(header.getRpcKind());</span><br><span class="line">   ...</span><br><span class="line">   Writable rpcRequest;</span><br><span class="line">   <span class="keyword">try</span> &#123; <span class="comment">//Read the rpc request</span></span><br><span class="line">     rpcRequest = ReflectionUtils.newInstance(rpcRequestClass, conf);</span><br><span class="line">     <span class="comment">// è¿›è¡Œååºåˆ—åŒ–ï¼Œä»Writableæµä¸­è¯»å–æ•°æ®</span></span><br><span class="line">     rpcRequest.readFields(dis);</span><br><span class="line">   &#125; <span class="keyword">catch</span> (Throwable t) &#123; <span class="comment">// includes runtime exception from newInstance</span></span><br><span class="line">     ...</span><br><span class="line">   &#125;</span><br><span class="line">   ...</span><br><span class="line">   <span class="comment">// å®ä¾‹åŒ–Serverç«¯çš„Callå¯¹è±¡ï¼Œç„¶åæ”¾å…¥callQueueä¸­ï¼Œç­‰å¾…handleræ¥å¤„ç†</span></span><br><span class="line">   Call call = <span class="keyword">new</span> Call(header.getCallId(), header.getRetryCount(),</span><br><span class="line">       rpcRequest, <span class="keyword">this</span>, ProtoUtil.convert(header.getRpcKind()),</span><br><span class="line">       header.getClientId().toByteArray(), traceSpan);</span><br><span class="line"></span><br><span class="line">   callQueue.put(call);              <span class="comment">// queue the call; maybe blocked here</span></span><br><span class="line">   incRpcCount();  <span class="comment">// Increment the rpc count</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure><p>è‡³æ­¤Serverç«¯çš„æ¥å—è¯·æ±‚é˜¶æ®µå·²ç»å¤„ç†å®Œæˆï¼Œä¸‹é¢ç”±å„ä¸ªhandleråŒºå…±äº«é˜Ÿåˆ—callQueueä¸­å–å‡ºcallè¿›è¡Œå¤„ç†ã€‚Handleræœ‰å¤šä¸ªçº¿ç¨‹ç»„æˆï¼Œåˆ™çœ‹Handlerçš„runæ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.debug(Thread.currentThread().getName() + <span class="string">&quot;: starting&quot;</span>);</span><br><span class="line">  SERVER.set(Server.<span class="keyword">this</span>);</span><br><span class="line">  ByteArrayOutputStream buf = </span><br><span class="line">    <span class="keyword">new</span> ByteArrayOutputStream(INITIAL_RESP_BUF_SIZE);</span><br><span class="line">  <span class="keyword">while</span> (running) &#123;</span><br><span class="line">    TraceScope traceScope = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="keyword">final</span> Call call = callQueue.take(); <span class="comment">// pop the queue; maybe blocked here</span></span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(Thread.currentThread().getName() + <span class="string">&quot;: &quot;</span> + call + <span class="string">&quot; for RpcKind &quot;</span> + call.rpcKind);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (!call.connection.channel.isOpen()) &#123;</span><br><span class="line">        LOG.info(Thread.currentThread().getName() + <span class="string">&quot;: skipped &quot;</span> + call);</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      String errorClass = <span class="keyword">null</span>;</span><br><span class="line">      String error = <span class="keyword">null</span>;</span><br><span class="line">      RpcStatusProto returnStatus = RpcStatusProto.SUCCESS;</span><br><span class="line">      RpcErrorCodeProto detailedErr = <span class="keyword">null</span>;</span><br><span class="line">      Writable value = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">      CurCall.set(call);</span><br><span class="line">      <span class="keyword">if</span> (call.traceSpan != <span class="keyword">null</span>) &#123;</span><br><span class="line">        traceScope = Trace.continueSpan(call.traceSpan);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        <span class="comment">// Make the call as the user via Subject.doAs, thus associating</span></span><br><span class="line">        <span class="comment">// the call with the Subject</span></span><br><span class="line">        <span class="keyword">if</span> (call.connection.user == <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// å¯¹callå¯¹è±¡è¿›è¡Œå¤„ç†</span></span><br><span class="line">          value = call(call.rpcKind, call.connection.protocolName, call.rpcRequest, </span><br><span class="line">                       call.timestamp);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          value = </span><br><span class="line">            call.connection.user.doAs</span><br><span class="line">              (<span class="keyword">new</span> PrivilegedExceptionAction&lt;Writable&gt;() &#123;</span><br><span class="line">                 <span class="meta">@Override</span></span><br><span class="line">                 <span class="function"><span class="keyword">public</span> Writable <span class="title">run</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">                   <span class="comment">// make the call</span></span><br><span class="line">                   <span class="keyword">return</span> call(call.rpcKind, call.connection.protocolName, </span><br><span class="line">                               call.rpcRequest, call.timestamp);</span><br><span class="line"></span><br><span class="line">                 &#125;</span><br><span class="line">               &#125;</span><br><span class="line">              );</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        ...</span><br><span class="line">      &#125;</span><br><span class="line">      CurCall.set(<span class="keyword">null</span>);</span><br><span class="line">      <span class="keyword">synchronized</span> (call.connection.responseQueue) &#123;</span><br><span class="line">        <span class="comment">// setupResponse() needs to be sync&#x27;ed together with </span></span><br><span class="line">        <span class="comment">// responder.doResponse() since setupResponse may use</span></span><br><span class="line">        <span class="comment">// SASL to encrypt response data and SASL enforces</span></span><br><span class="line">        <span class="comment">// its own message ordering.</span></span><br><span class="line">        setupResponse(buf, call, returnStatus, detailedErr, </span><br><span class="line">            value, errorClass, error);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// Discard the large buf and reset it back to smaller size </span></span><br><span class="line">        <span class="comment">// to free up heap</span></span><br><span class="line">        <span class="keyword">if</span> (buf.size() &gt; maxRespSize) &#123;</span><br><span class="line">          LOG.warn(<span class="string">&quot;Large response size &quot;</span> + buf.size() + <span class="string">&quot; for call &quot;</span></span><br><span class="line">              + call.toString());</span><br><span class="line">          buf = <span class="keyword">new</span> ByteArrayOutputStream(INITIAL_RESP_BUF_SIZE);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// å¤„ç†å®Œä¹‹åå°†callæ”¾å…¥responseQueueä¸­</span></span><br><span class="line">        responder.doRespond(call);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">      <span class="keyword">if</span> (traceScope != <span class="keyword">null</span>) &#123;</span><br><span class="line">        traceScope.close();</span><br><span class="line">      &#125;</span><br><span class="line">      IOUtils.cleanup(LOG, traceScope);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.debug(Thread.currentThread().getName() + <span class="string">&quot;: exiting&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>handlerä¸­å¤„ç†callçš„ä»£ç <code>value = call(call.rpcKind, call.connection.protocolName, call.rpcRequest, call.timestamp)</code>ï¼Œå®ç°æ˜¯åœ¨<code>RPC.Server.call</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Writable <span class="title">call</span><span class="params">(RPC.RpcKind rpcKind, String protocol,</span></span></span><br><span class="line"><span class="params"><span class="function">    Writable rpcRequest, <span class="keyword">long</span> receiveTime)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  <span class="comment">// getPpcInvoker å¾—åˆ°åºåˆ—åŒ–Engine      </span></span><br><span class="line">  <span class="keyword">return</span> getRpcInvoker(rpcKind).call(<span class="keyword">this</span>, protocol, rpcRequest,</span><br><span class="line">      receiveTime);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// WritableRpcEngine.Serverä¸­calçš„å®ç°</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> Writable <span class="title">call</span><span class="params">(org.apache.hadoop.ipc.RPC.Server server,</span></span></span><br><span class="line"><span class="params"><span class="function">    String protocolName, Writable rpcRequest, <span class="keyword">long</span> receivedTime)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> IOException, RPC.VersionMismatch </span>&#123;</span><br><span class="line"> ...</span><br><span class="line">    <span class="comment">// Invoke the protocol method</span></span><br><span class="line"> <span class="keyword">long</span> startTime = Time.now();</span><br><span class="line"> <span class="keyword">int</span> qTime = (<span class="keyword">int</span>) (startTime-receivedTime);</span><br><span class="line"> Exception exception = <span class="keyword">null</span>;</span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// å¾—åˆ°Method</span></span><br><span class="line">    Method method =</span><br><span class="line">        protocolImpl.protocolClass.getMethod(call.getMethodName(),</span><br><span class="line">        call.getParameterClasses());</span><br><span class="line">    method.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">    server.rpcDetailedMetrics.init(protocolImpl.protocolClass);</span><br><span class="line">    <span class="comment">// æ–¹æ³•çš„è°ƒç”¨ï¼Œç”±åè®®çš„å®ç°ç±»æ‰§è¡Œæ–¹æ³•    åå°„</span></span><br><span class="line">    Object value = </span><br><span class="line">        method.invoke(protocolImpl.protocolImpl, call.getParameters());</span><br><span class="line">    <span class="keyword">if</span> (server.verbose) log(<span class="string">&quot;Return: &quot;</span>+value);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> ObjectWritable(method.getReturnType(), value);</span><br><span class="line"></span><br><span class="line">  &#125; <span class="keyword">catch</span> (InvocationTargetException e) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>callæ‰§è¡Œå®Œä¹‹åï¼Œè¿”å›åˆ°Handlerçš„runæ–¹æ³•ä¸­ç»§ç»­æ‰§è¡Œï¼Œå°†calläº¤ç»™<code>responder.doRespond</code>å¤„ç†ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">doRespond</span><span class="params">(Call call)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">synchronized</span> (call.connection.responseQueue) &#123;</span><br><span class="line">    <span class="comment">// å°†callåŠ å…¥åˆ°responseQueueä¸­ï¼Œæ¯ä¸ªconnectionéƒ½æœ‰ä¸€ä¸ªresponseQueue</span></span><br><span class="line">    call.connection.responseQueue.addLast(call);</span><br><span class="line">    <span class="comment">// å½“responseQueueçš„å¤§å°ä¸º1æ—¶ï¼Œç›´æ¥ç”±Handlerçº¿ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="comment">// å½“responseQueueçš„å¤§å°å¤§äº1æ—¶ï¼Œç”±Responderçº¿ç¨‹è¿›è¡Œå¤„ç†</span></span><br><span class="line">    <span class="keyword">if</span> (call.connection.responseQueue.size() == <span class="number">1</span>) &#123;</span><br><span class="line">      processResponse(call.connection.responseQueue, <span class="keyword">true</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¯·æ±‚å·²ç»å¤„ç†å®Œæˆï¼Œå¦‚æœresponseQueueå¤§å°ä¸º1ï¼Œåˆ™ç›´æ¥ç”±Handlerè°ƒç”¨<code>processResponse</code>è¿”å›ç»“æœï¼Œå¦‚æœresponseQueueçš„å¤§å°å¤§äº1ï¼Œåˆ™ç”±Responderçº¿ç¨‹è¿”å›ç»“æœï¼Œå…ˆçœ‹ä¸‹runä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  LOG.info(Thread.currentThread().getName() + <span class="string">&quot;: starting&quot;</span>);</span><br><span class="line">  SERVER.set(Server.<span class="keyword">this</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    doRunLoop();</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doRunLoop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">long</span> lastPurgeTime = <span class="number">0</span>;   <span class="comment">// last check for old calls.</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">while</span> (running) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      waitPending();     <span class="comment">// If a channel is being registered, wait.</span></span><br><span class="line">      writeSelector.select(PURGE_INTERVAL);</span><br><span class="line">      Iterator&lt;SelectionKey&gt; iter = writeSelector.selectedKeys().iterator();</span><br><span class="line">      <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">        SelectionKey key = iter.next();</span><br><span class="line">        iter.remove();</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">          <span class="keyword">if</span> (key.isValid() &amp;&amp; key.isWritable()) &#123;</span><br><span class="line">            <span class="comment">// ä»åå­—æ¥çœ‹æ˜¯å¼‚æ­¥å¤„ç†ï¼Œä½†æ€ä¹ˆä½“ç°å‡ºæ¥çš„ï¼Ÿ</span></span><br><span class="line">              doAsyncWrite(key);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">          LOG.info(Thread.currentThread().getName() + <span class="string">&quot;: doAsyncWrite threw exception &quot;</span> + e);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">long</span> now = Time.now();</span><br><span class="line">      <span class="keyword">if</span> (now &lt; lastPurgeTime + PURGE_INTERVAL) &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      lastPurgeTime = now;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// If there were some calls that have not been sent out for a</span></span><br><span class="line">      <span class="comment">// long time, discard them.</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="keyword">if</span>(LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(<span class="string">&quot;Checking for old call responses.&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      ArrayList&lt;Call&gt; calls;</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// get the list of channels from list of keys.</span></span><br><span class="line">      <span class="comment">// å¾—åˆ°æ‰€æœ‰çš„æ³¨å†Œé”®çš„é›†åˆ</span></span><br><span class="line">      <span class="keyword">synchronized</span> (writeSelector.keys()) &#123;</span><br><span class="line">        calls = <span class="keyword">new</span> ArrayList&lt;Call&gt;(writeSelector.keys().size());</span><br><span class="line">        iter = writeSelector.keys().iterator();</span><br><span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span><br><span class="line">          SelectionKey key = iter.next();</span><br><span class="line">          Call call = (Call)key.attachment();</span><br><span class="line">          <span class="comment">// è¿™é‡Œå¾—åˆ°çš„listæ˜¯ä»€ä¹ˆï¼Ÿï¼Ÿï¼Ÿï¼Ÿ æ²¡æœ‰å¤„ç†å®Œå†æ¬¡è¿›å…¥responseQueueçš„call</span></span><br><span class="line">          <span class="keyword">if</span> (call != <span class="keyword">null</span> &amp;&amp; key.channel() == call.connection.channel) &#123; </span><br><span class="line">            calls.add(call);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">for</span>(Call call : calls) &#123;</span><br><span class="line">        doPurge(call, now);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (OutOfMemoryError e) &#123;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// we can run out of memory if we have too many threads</span></span><br><span class="line">      <span class="comment">// log the event and sleep for a minute and give</span></span><br><span class="line">      <span class="comment">// some thread(s) a chance to finish</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      LOG.warn(<span class="string">&quot;Out of Memory in server select&quot;</span>, e);</span><br><span class="line">      <span class="keyword">try</span> &#123; Thread.sleep(<span class="number">60000</span>); &#125; <span class="keyword">catch</span> (Exception ie) &#123;&#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Exception in Responder&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doAsyncWrite</span><span class="params">(SelectionKey key)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  Call call = (Call)key.attachment();</span><br><span class="line">  <span class="keyword">if</span> (call == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (key.channel() != call.connection.channel) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">&quot;doAsyncWrite: bad channel&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">synchronized</span>(call.connection.responseQueue) &#123;</span><br><span class="line">    <span class="keyword">if</span> (processResponse(call.connection.responseQueue, <span class="keyword">false</span>)) &#123;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">        key.interestOps(<span class="number">0</span>);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (CancelledKeyException e) &#123;</span><br><span class="line">        <span class="comment">/* The Listener/reader might have closed the socket.</span></span><br><span class="line"><span class="comment">         * We don&#x27;t explicitly cancel the key, so not sure if this will</span></span><br><span class="line"><span class="comment">         * ever fire.</span></span><br><span class="line"><span class="comment">         * This warning could be removed.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        LOG.warn(<span class="string">&quot;Exception while changing ops : &quot;</span> + e);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Processes one response. Returns true if there are no more pending</span></span><br><span class="line"><span class="comment">// data for this channel.</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">processResponse</span><span class="params">(LinkedList&lt;Call&gt; responseQueue,</span></span></span><br><span class="line"><span class="params"><span class="function">                                <span class="keyword">boolean</span> inHandler)</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  <span class="keyword">boolean</span> error = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">boolean</span> done = <span class="keyword">false</span>;       <span class="comment">// there is more data for this channel.</span></span><br><span class="line">  <span class="keyword">int</span> numElements = <span class="number">0</span>;</span><br><span class="line">  Call call = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (responseQueue) &#123;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// If there are no items for this channel, then we are done</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      numElements = responseQueue.size();</span><br><span class="line">      <span class="keyword">if</span> (numElements == <span class="number">0</span>) &#123;</span><br><span class="line">        error = <span class="keyword">false</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;              <span class="comment">// no more data for this channel.</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Extract the first call</span></span><br><span class="line">      call = responseQueue.removeFirst();</span><br><span class="line">      SocketChannel channel = call.connection.channel;</span><br><span class="line">      <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">        LOG.debug(Thread.currentThread().getName() + <span class="string">&quot;: responding to &quot;</span> + call);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="comment">// Send as much data as we can in the non-blocking fashion</span></span><br><span class="line">      <span class="comment">//</span></span><br><span class="line">      <span class="keyword">int</span> numBytes = channelWrite(channel, call.rpcResponse);</span><br><span class="line">      <span class="keyword">if</span> (numBytes &lt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¦‚æœcall.rpcResponseå†™å®Œäº†åˆ™å°†call.rpcResponseæ¸…ç©º</span></span><br><span class="line">      <span class="comment">// å¦‚æœæ²¡æœ‰å†™å®Œï¼Œåˆ™å†å°†å…¶æ”¾å…¥responseQueueçš„è¿å¤´</span></span><br><span class="line">      <span class="comment">// å½“Handleræ²¡èƒ½å°†ç»“æœä¸€æ¬¡æ€§å‘é€åˆ°å®¢æˆ·ç«¯æ—¶,ä¼šå‘è¯¥Selectorå¯¹è±¡æ³¨å†ŒSelectionKey.OP_WRITEäº‹ä»¶</span></span><br><span class="line">      <span class="keyword">if</span> (!call.rpcResponse.hasRemaining()) &#123;</span><br><span class="line">        <span class="comment">//Clear out the response buffer so it can be collected</span></span><br><span class="line">        call.rpcResponse = <span class="keyword">null</span>;</span><br><span class="line">        call.connection.decRpcCount();</span><br><span class="line">        <span class="keyword">if</span> (numElements == <span class="number">1</span>) &#123;    <span class="comment">// last call fully processes.</span></span><br><span class="line">          done = <span class="keyword">true</span>;             <span class="comment">// no more data for this channel.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          done = <span class="keyword">false</span>;            <span class="comment">// more calls pending to be sent.</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">          LOG.debug(Thread.currentThread().getName() + <span class="string">&quot;: responding to &quot;</span> + call</span><br><span class="line">              + <span class="string">&quot; Wrote &quot;</span> + numBytes + <span class="string">&quot; bytes.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        <span class="comment">// If we were unable to write the entire response out, then </span></span><br><span class="line">        <span class="comment">// insert in Selector queue. </span></span><br><span class="line">        <span class="comment">//</span></span><br><span class="line">        call.connection.responseQueue.addFirst(call);</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (inHandler) &#123;</span><br><span class="line">          <span class="comment">// set the serve time when the response has to be sent later</span></span><br><span class="line">          call.timestamp = Time.now();</span><br><span class="line">          </span><br><span class="line">          incPending();</span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// Wakeup the thread blocked on select, only then can the call </span></span><br><span class="line">            <span class="comment">// to channel.register() complete.</span></span><br><span class="line">            writeSelector.wakeup();</span><br><span class="line">            channel.register(writeSelector, SelectionKey.OP_WRITE, call);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (ClosedChannelException e) &#123;</span><br><span class="line">            <span class="comment">//Its ok. channel might be closed else where.</span></span><br><span class="line">            done = <span class="keyword">true</span>;</span><br><span class="line">          &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">            decPending();</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (LOG.isDebugEnabled()) &#123;</span><br><span class="line">          LOG.debug(Thread.currentThread().getName() + <span class="string">&quot;: responding to &quot;</span> + call</span><br><span class="line">              + <span class="string">&quot; Wrote partial &quot;</span> + numBytes + <span class="string">&quot; bytes.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      error = <span class="keyword">false</span>;              <span class="comment">// everything went off well</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (error &amp;&amp; call != <span class="keyword">null</span>) &#123;</span><br><span class="line">      LOG.warn(Thread.currentThread().getName()+<span class="string">&quot;, call &quot;</span> + call + <span class="string">&quot;: output error&quot;</span>);</span><br><span class="line">      done = <span class="keyword">true</span>;               <span class="comment">// error. no more data for this channel.</span></span><br><span class="line">      closeConnection(call.connection);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> done;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>Serverç«¯è¿”å›ç»“æœçš„è¿‡ç¨‹åˆ°æ­¤ç»“æŸï¼Œæ¥ä¸‹æ¥åˆå›åˆ°äº†clinetç«¯ï¼Œç”±Connectionçº¿ç¨‹æ¥å—Serverçš„Responseã€‚ä»£ç åœ¨Connectionä¸­runæ–¹æ³•ä¸­çš„receiveRpcResponseï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/* Receive a response.</span></span><br><span class="line"><span class="comment"> * Because only one receiver, so no synchronization on in.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">receiveRpcResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (shouldCloseConnection.get()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  touch();</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">int</span> totalLen = in.readInt();</span><br><span class="line">    RpcResponseHeaderProto header = </span><br><span class="line">        RpcResponseHeaderProto.parseDelimitedFrom(in);</span><br><span class="line">    checkResponse(header);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> headerLen = header.getSerializedSize();</span><br><span class="line">    headerLen += CodedOutputStream.computeRawVarint32Size(headerLen);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> callId = header.getCallId();</span><br><span class="line">    <span class="keyword">if</span> (LOG.isDebugEnabled())</span><br><span class="line">      LOG.debug(getName() + <span class="string">&quot; got value #&quot;</span> + callId);</span><br><span class="line"></span><br><span class="line">    Call call = calls.get(callId);</span><br><span class="line">    RpcStatusProto status = header.getStatus();</span><br><span class="line">    <span class="keyword">if</span> (status == RpcStatusProto.SUCCESS) &#123;</span><br><span class="line">      Writable value = ReflectionUtils.newInstance(valueClass, conf);</span><br><span class="line">      value.readFields(in);                 <span class="comment">// read value</span></span><br><span class="line">      calls.remove(callId);</span><br><span class="line">      <span class="comment">// å°† value å€¼è®¾ç½®ä¸ºcallçš„Response</span></span><br><span class="line">      call.setRpcResponse(value);</span><br><span class="line">      </span><br><span class="line">      <span class="comment">// verify that length was correct</span></span><br><span class="line">      <span class="comment">// only for ProtobufEngine where len can be verified easily</span></span><br><span class="line">      <span class="keyword">if</span> (call.getRpcResponse() <span class="keyword">instanceof</span> ProtobufRpcEngine.RpcWrapper) &#123;</span><br><span class="line">        ProtobufRpcEngine.RpcWrapper resWrapper = </span><br><span class="line">            (ProtobufRpcEngine.RpcWrapper) call.getRpcResponse();</span><br><span class="line">        <span class="keyword">if</span> (totalLen != headerLen + resWrapper.getLength()) &#123; </span><br><span class="line">          <span class="keyword">throw</span> <span class="keyword">new</span> RpcClientException(</span><br><span class="line">              <span class="string">&quot;RPC response length mismatch on rpc success&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;<span class="keyword">else</span> &#123; <span class="comment">// Rpc Request failed</span></span><br><span class="line">      ...</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (IOException e) &#123;</span><br><span class="line">    markClosed(e);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">setRpcResponse</span><span class="params">(Writable rpcResponse)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.rpcResponse = rpcResponse;</span><br><span class="line">  callComplete();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">callComplete</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">this</span>.done = <span class="keyword">true</span>;</span><br><span class="line">  <span class="comment">// é€šçŸ¥åœ¨callä¸­ç”±connection.sendRpcRequestä¹‹åè°ƒç”¨call.wait()çš„çº¿ç¨‹</span></span><br><span class="line">  notify();                                 <span class="comment">// notify caller</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>notifyä¹‹åå†æ¬¡å›åˆ°Client.callçš„çº¿ç¨‹ä¸­æ‰§è¡Œ<code>call.getRpcResponse()</code>,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> Writable <span class="title">getRpcResponse</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> rpcResponse;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>ä»£ç åˆ†æå®Œæ¯•ï¼Œç”¨æ–‡å­—æ€»ç»“ä¸‹Hadoop RPCçš„å¤§è‡´æµç¨‹ï¼š</p><blockquote><p>Clienté€šè¿‡ä»£ç†åœ¨invokeä¸­è°ƒç”¨client.callä¹‹åçš„æµç¨‹</p></blockquote><ol><li>è¿œç¨‹æ–¹æ³•è°ƒç”¨ä¿¡æ¯å°è£…æˆCallå¯¹è±¡ï¼ŒæŸ¥çœ‹å½“å‰clientä¸serveræ˜¯å¦å·²ç»å»ºç«‹connectionï¼Œå¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºä¸€ä¸ªConnectionå¯¹è±¡ï¼Œå¦åˆ™ç›´æ¥getä¸€ä¸ªconnectionï¼Œå°†Callå¯¹è±¡æ”¾åˆ°Connectionå¯¹è±¡ä¸­çš„å“ˆå¸Œè¡¨callsä¸­; </li><li>è°ƒç”¨ Connection ç±»ä¸­çš„sendRpcRequest()æ–¹æ³•å°†å½“å‰Callå¯¹è±¡å‘é€ç»™Serverç«¯ï¼Œå¹¶è°ƒç”¨call.wait()é˜»å¡çº¿ç¨‹; </li><li>Serverç«¯å¤„ç†å®ŒRPCè¯·æ±‚å,å°†ç»“æœé€šè¿‡ç½‘ç»œè¿”å›ç»™Clientç«¯,Clientç«¯é€šè¿‡Connectionçº¿ç¨‹è°ƒç”¨receiveRpcResponse()å‡½æ•°è·å–ç»“æœ; </li><li>Clientæ£€æŸ¥ç»“æœå¤„ç†çŠ¶æ€(æˆåŠŸè¿˜æ˜¯å¤±è´¥),å¹¶å°†å¯¹åº” Call å¯¹è±¡ä»å“ˆå¸Œè¡¨callsä¸­åˆ é™¤ï¼Œå°†ç»“æœèµ‹å€¼ç»™call.rpcResponseã€‚ </li></ol><blockquote><p>Server</p></blockquote><ol><li><p>æ¥æ”¶è¯·æ±‚;è¯¥é˜¶æ®µä¸»è¦ä»»åŠ¡æ˜¯æ¥æ”¶æ¥è‡ªå„ä¸ªå®¢æˆ·ç«¯çš„RPCè¯·æ±‚,å¹¶å°†å®ƒä»¬å°è£…æˆå›ºå®šçš„æ ¼å¼(Callç±»)æ”¾åˆ°ä¸€ä¸ªå…±äº«é˜Ÿåˆ—(callQueue)ä¸­,ä»¥ä¾¿è¿›è¡Œåç»­å¤„ç†ã€‚<br>è¯¥é˜¶æ®µå†…éƒ¨åˆåˆ†ä¸ºå»ºç«‹è¿æ¥å’Œæ¥æ”¶è¯·æ±‚ä¸¤ä¸ªå­é˜¶æ®µ,åˆ†åˆ«ç”±Listenerå’ŒReaderä¸¤ç§çº¿ç¨‹å®Œæˆã€‚æ•´ä¸ªServer<strong>åªæœ‰ä¸€ä¸ª</strong>Listenerçº¿ç¨‹,ç»Ÿä¸€è´Ÿè´£ç›‘å¬æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥è¯·æ±‚,ä¸€æ—¦æœ‰æ–°çš„è¯·æ±‚åˆ°è¾¾,å®ƒä¼šé‡‡ç”¨è½®è¯¢çš„æ–¹å¼ä»çº¿ç¨‹æ± ä¸­é€‰æ‹©ä¸€ä¸ªReaderçº¿ç¨‹è¿›è¡Œå¤„ç†,è€ŒReaderçº¿ç¨‹å¯åŒæ—¶å­˜åœ¨å¤šä¸ª,å®ƒä»¬åˆ†åˆ«è´Ÿè´£æ¥æ”¶ä¸€éƒ¨åˆ†å®¢æˆ·ç«¯è¿æ¥çš„RPCè¯·æ±‚,è‡³äºæ¯ä¸ªReaderçº¿ç¨‹è´Ÿè´£å“ªäº›å®¢æˆ·ç«¯è¿æ¥,å®Œå…¨ç”±Listenerå†³å®š,å½“å‰Listeneråªæ˜¯é‡‡ç”¨äº†ç®€å•çš„è½®è¯¢åˆ†é…æœºåˆ¶ã€‚Listenerå’ŒReaderçº¿ç¨‹å†…éƒ¨å„è‡ªåŒ…å«ä¸€ä¸ªSelectorå¯¹è±¡,åˆ†åˆ«ç”¨äºç›‘å¬SelectionKey.OP_ACCEPTå’ŒSelectionKey.OP_READ äº‹ä»¶ã€‚å¯¹äºListenerçº¿ç¨‹,ä¸»å¾ªç¯çš„å®ç°ä½“æ˜¯ç›‘å¬æ˜¯å¦æœ‰æ–°çš„è¿æ¥è¯·æ±‚åˆ°è¾¾,å¹¶é‡‡ç”¨è½®è¯¢ç­–ç•¥é€‰æ‹©ä¸€ä¸ªReaderçº¿ç¨‹å¤„ç†æ–°è¿æ¥;å¯¹äºReaderçº¿ç¨‹,ä¸»å¾ªç¯çš„å®ç°ä½“æ˜¯ç›‘å¬(å®ƒè´Ÿè´£çš„é‚£éƒ¨åˆ†)å®¢æˆ·ç«¯è¿æ¥ä¸­æ˜¯å¦æœ‰æ–°çš„RPCè¯·æ±‚åˆ°è¾¾,å¹¶å°†æ–°çš„RPCè¯·æ±‚å°è£…æˆCallå¯¹è±¡,æ”¾åˆ°å…±äº«é˜Ÿåˆ—callQueue ä¸­ã€‚</p></li><li><p>å¤„ç†è¯·æ±‚;è¯¥é˜¶æ®µä¸»è¦ä»»åŠ¡æ˜¯ä»å…±äº«é˜Ÿåˆ—callQueueä¸­è·å–Callå¯¹è±¡,æ‰§è¡Œå¯¹åº”çš„å‡½æ•°è°ƒç”¨,å¹¶å°†ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯,è¿™å…¨éƒ¨ç”±<strong>Handlerçº¿ç¨‹å®Œæˆ</strong>ã€‚Server ç«¯å¯åŒæ—¶å­˜åœ¨å¤šä¸ªHandlerçº¿ç¨‹,å®ƒä»¬å¹¶è¡Œä»_å…±äº«é˜Ÿåˆ—_ä¸­è¯»å–Callå¯¹è±¡,ç»æ‰§è¡Œå¯¹åº”çš„å‡½æ•°è°ƒç”¨å,å°†å°è¯•ç€ç›´æ¥å°†ç»“æœè¿”å›ç»™å¯¹åº”çš„å®¢æˆ·ç«¯ã€‚ä½†è€ƒè™‘åˆ°æŸäº›å‡½æ•°è°ƒç”¨è¿”å›ç»“æœå¾ˆå¤§æˆ–è€…ç½‘ç»œé€Ÿåº¦è¿‡æ…¢,å¯èƒ½éš¾ä»¥å°†ç»“æœä¸€æ¬¡æ€§å‘é€åˆ°å®¢æˆ·ç«¯,æ­¤æ—¶Handlerå°†å°è¯•ç€å°†åç»­å‘é€ä»»åŠ¡äº¤ç»™Responderçº¿ç¨‹ã€‚</p></li><li><p>è¿”å›ç»“æœ;å‰é¢æåˆ°,æ¯ä¸ªHandlerçº¿ç¨‹æ‰§è¡Œå®Œå‡½æ•°è°ƒç”¨å,ä¼šå°è¯•ç€å°†æ‰§è¡Œç»“æœè¿”å›ç»™å®¢æˆ·ç«¯,ä½†å¯¹äºç‰¹æ®Šæƒ…å†µ,æ¯”å¦‚å‡½æ•°è°ƒç”¨è¿”å›ç»“æœè¿‡å¤§æˆ–è€…ç½‘ç»œå¼‚å¸¸æƒ…å†µ(ç½‘é€Ÿè¿‡æ…¢),ä¼šå°†å‘é€ä»»åŠ¡äº¤ç»™Responderçº¿ç¨‹ã€‚Serverç«¯<strong>ä»…å­˜åœ¨ä¸€ä¸ª</strong>Responderçº¿ç¨‹,å®ƒçš„å†…éƒ¨åŒ…å«ä¸€ä¸ªSelectorå¯¹è±¡,ç”¨äºç›‘å¬SelectionKey.OP_WRITEäº‹ä»¶ã€‚å½“Handleræ²¡èƒ½å°†ç»“æœä¸€æ¬¡æ€§å‘é€åˆ°å®¢æˆ·ç«¯æ—¶,ä¼šå‘è¯¥Selectorå¯¹è±¡æ³¨å†ŒSelectionKey.OP_WRITEäº‹ä»¶,è¿›è€Œç”±Responder çº¿ç¨‹é‡‡ç”¨<em>å¼‚æ­¥æ–¹å¼</em>ç»§ç»­å‘é€æœªå‘é€å®Œæˆçš„ç»“æœ</p></li></ol><h2 id="å‚è€ƒ"><a href="#å‚è€ƒ" class="headerlink" title="å‚è€ƒ"></a>å‚è€ƒ</h2><p><a href="http://jomolangma.com/?p=130">http://jomolangma.com/?p=130</a></p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> RPC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>NameNodeå…ƒæ•°æ®åŠcheckpointåˆ†æ</title>
      <link href="/NameNode%E5%85%83%E6%95%B0%E6%8D%AE%E5%8F%8Acheckpoint%E5%88%86%E6%9E%90.html"/>
      <url>/NameNode%E5%85%83%E6%95%B0%E6%8D%AE%E5%8F%8Acheckpoint%E5%88%86%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<h2 id="NamNode"><a href="#NamNode" class="headerlink" title="NamNode"></a>NamNode</h2><p>NameNode çš„ä¸»è¦ä½œç”¨æ˜¯</p><ol><li>è´Ÿè´£ç®¡ç†æ–‡ä»¶ç³»ç»Ÿçš„å‘½åç©ºé—´ã€é›†ç¾¤é…ç½®ä¿¡æ¯å’Œå­˜å‚¨å—çš„å¤åˆ¶ï¼›</li><li>ç»´æŠ¤ç€æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿçš„æ–‡ä»¶ç›®å½•æ ‘å’Œæ–‡ä»¶æ ¹ç›®å½•çš„å…ƒä¿¡æ¯å’Œæ¯ä¸ªæ–‡ä»¶å¯¹åº”çš„æ•°æ®å—åˆ—è¡¨ï¼›</li><li>æ¥æ”¶ç”¨æˆ·çš„æ“ä½œè¯·æ±‚ï¼›</li><li>ç®¡ç†æ–‡ä»¶ä¸blockä¹‹é—´çš„å…³ç³»ï¼Œblockä¸DataNodeä¹‹é—´çš„å…³ç³»ï¼›</li></ol><p>NameNode çš„å¯åŠ¨æµç¨‹ä¸ºï¼š</p><ol><li>Loading fsimage - ä»fsimage fileä¸­è¯»å–æœ€æ–°çš„æ–‡ä»¶ç³»ç»Ÿçš„å…ƒæ•°æ®å¿«ç…§(æœ€è¿‘ç”Ÿæˆçš„fsimage_xx)</li><li>Loading edits - è¯»å–åŒ…å«fsimage_xxä¹‹åçš„æ‰€æœ‰txçš„edit logså¹¶å°†edit logsä¸­çš„æ“ä½œä»æ–°æ“ä½œä¸€éæ›´æ–°åˆ°å…ƒæ•°æ®ä¸­ï¼Œåˆ™æ­¤æ—¶NNæ›´æ–°åˆ°ä¸Šæ¬¡åœæ­¢æ—¶çš„çŠ¶æ€ã€‚</li><li>checkpoint - å°†å½“å‰çŠ¶æ€å†™å…¥æ–°çš„checkpointä¸­ï¼Œå³äº§ç”Ÿä¸€ä¸ªæ–°çš„fsimage_xxæ–‡ä»¶</li><li>Safe mode - ç­‰å¾…å„ä¸ª<em>datanodes report</em>å„è‡ªçš„blockä¿¡æ¯ï¼Œå½¢æˆblockMapï¼Œç„¶åé€€å‡ºå®‰å…¨æ¨¡å¼ã€‚</li></ol><p>æ­¤æ—¶NNå¯åŠ¨ç»“æŸï¼Œç­‰å¾…æ¥å—ç”¨æˆ·çš„æ“ä½œè¯·æ±‚ï¼Œå¹¶æŠŠå„ç§æ“ä½œå†™å…¥æ–°çš„edit logä¸­ï¼Œå®šæœŸè¿›è¡Œcheckpointï¼Œå¯¹å…ƒæ•°æ®è¿›è¡Œå¿«ç…§ã€‚</p><span id="more"></span><h2 id="NameNode-å…ƒæ•°æ®"><a href="#NameNode-å…ƒæ•°æ®" class="headerlink" title="NameNode å…ƒæ•°æ®"></a>NameNode å…ƒæ•°æ®</h2><p>NameNodeçš„æ‰€æœ‰æ“ä½œåŠæ•´ä¸ªé›†ç¾¤çš„çŠ¶æ€éƒ½å­˜å‚¨åœ¨_å…ƒæ•°æ®_ä¸­ã€‚NNçš„å…ƒæ•°æ®å­˜å‚¨æ˜¯ç”±fsimageå’Œeditsæ–‡ä»¶ç»„æˆã€‚fsimageå­˜æ”¾ä¸Šæ¬¡checkpointç”Ÿæˆçš„æ–‡ä»¶ç³»ç»Ÿå…ƒæ•°æ®ï¼ŒEditså­˜æ”¾æ–‡ä»¶ç³»ç»Ÿ_æ“ä½œæ—¥å¿—_ã€‚checkpointçš„è¿‡ç¨‹ï¼Œå°±æ˜¯åˆå¹¶fsimageå’ŒEditsæ–‡ä»¶ï¼Œç„¶åç”Ÿæˆæœ€æ–°çš„fsimageçš„è¿‡ç¨‹ã€‚</p><p>NameNodeåœ¨æ‰§è¡ŒHDFSå®¢æˆ·ç«¯æäº¤çš„åˆ›å»ºæ–‡ä»¶æˆ–è€…ç§»åŠ¨æ–‡ä»¶è¿™æ ·çš„_å†™æ“ä½œ_çš„æ—¶å€™ï¼Œä¼šé¦–å…ˆæŠŠè¿™äº›æ“ä½œè®°å½•åœ¨Edit Log æ–‡ä»¶ä¹‹ä¸­ï¼Œç„¶åå†æ›´æ–°å†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿé•œåƒã€‚å†…å­˜ä¸­çš„_æ–‡ä»¶ç³»ç»Ÿé•œåƒ_ç”¨äºNameNodeå‘å®¢æˆ·ç«¯æä¾›_è¯»æœåŠ¡_ï¼Œè€Œ EditLogä»…ä»…åªæ˜¯åœ¨æ•°æ®æ¢å¤çš„æ—¶å€™èµ·ä½œç”¨ã€‚è®°å½•åœ¨ EditLogä¹‹ä¸­çš„æ¯ä¸€ä¸ªæ“ä½œåˆç§°ä¸ºä¸€ä¸ªäº‹åŠ¡ï¼Œæ¯ä¸ªäº‹åŠ¡æœ‰ä¸€ä¸ªæ•´æ•°å½¢å¼çš„äº‹åŠ¡idä½œä¸ºç¼–å·ã€‚EditLogä¼šè¢«åˆ‡å‰²ä¸ºå¾ˆå¤šæ®µï¼Œæ¯ä¸€æ®µç§°ä¸ºä¸€ä¸ªSegmentã€‚æ­£åœ¨å†™å…¥çš„EditLog Segmentå¤„äºin-progressçŠ¶æ€ï¼Œå…¶æ–‡ä»¶åå½¢å¦‚edits_inprogress_${start_txid}ï¼Œå…¶ä¸­${start_txid}è¡¨ç¤ºè¿™ä¸ªsegmentçš„èµ·å§‹äº‹åŠ¡idã€‚è€Œå·²ç»å†™å…¥å®Œæˆçš„EditLog Segmentå¤„äºfinalizedçŠ¶æ€ï¼Œå…¶æ–‡ä»¶åå½¢å¦‚edits_${start_txid}-${end_txid}ï¼Œå…¶ä¸­${start_txid}è¡¨ç¤ºè¿™ä¸ªsegmentçš„èµ·å§‹äº‹åŠ¡idï¼Œ${end_txid}è¡¨ç¤ºè¿™ä¸ªsegment çš„ç»“æŸäº‹åŠ¡idã€‚</p><p>NameNodeä¼šå®šæœŸå¯¹å†…å­˜ä¸­çš„æ–‡ä»¶ç³»ç»Ÿé•œåƒè¿›è¡Œcheckpointæ“ä½œï¼Œåœ¨ç£ç›˜ä¸Šç”ŸæˆFSImageæ–‡ä»¶ï¼ŒFSImageæ–‡ä»¶çš„æ–‡ä»¶åå½¢å¦‚fsimage_${end_txid}ï¼Œå…¶ä¸­${end_txid}è¡¨ç¤ºè¿™ä¸ªfsimageæ–‡ä»¶çš„ç»“æŸäº‹åŠ¡idã€‚åœ¨NameNodeå¯åŠ¨çš„æ—¶å€™ä¼šè¿›è¡Œæ•°æ®æ¢å¤ï¼Œé¦–å…ˆæŠŠFSImageæ–‡ä»¶åŠ è½½åˆ°å†…å­˜ä¸­å½¢æˆæ–‡ä»¶ç³»ç»Ÿé•œåƒï¼Œç„¶åå†æŠŠEditLogä¹‹ä¸­__FsImageçš„ç»“æŸäº‹åŠ¡idä¹‹åçš„EditLog__å›æ”¾åˆ°è¿™ä¸ªæ–‡ä»¶ç³»ç»Ÿé•œåƒä¸Šã€‚</p><h2 id="å…ƒæ•°æ®åœ¨ç£ç›˜ä¸­çš„ç›®å½•ç»“æ„"><a href="#å…ƒæ•°æ®åœ¨ç£ç›˜ä¸­çš„ç›®å½•ç»“æ„" class="headerlink" title="å…ƒæ•°æ®åœ¨ç£ç›˜ä¸­çš„ç›®å½•ç»“æ„"></a>å…ƒæ•°æ®åœ¨ç£ç›˜ä¸­çš„ç›®å½•ç»“æ„</h2><h3 id="NameNodeä¸­dfs-namenode-name-dirä¸‹çš„å…ƒæ•°æ®"><a href="#NameNodeä¸­dfs-namenode-name-dirä¸‹çš„å…ƒæ•°æ®" class="headerlink" title="NameNodeä¸­dfs.namenode.name.dirä¸‹çš„å…ƒæ•°æ®"></a>NameNodeä¸­dfs.namenode.name.dirä¸‹çš„å…ƒæ•°æ®</h3><p>NameNodeå…ƒæ•°æ®ä¼šå‘¨æœŸæ€§çš„å›ºåŒ–åˆ°ç£ç›˜ï¼Œæ‰€åœ¨ç£ç›˜ç›®å½•æ˜¯åœ¨<code>hdfs-site.xml</code>ä¸­ç”±<code>dfs.namenode.name.dir</code>é…ç½®çš„ã€‚ç›®å½•ç»“æ„å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&gt; ll <span class="variable">$dfs</span>.namenode.name.dir</span><br><span class="line">drwxrwxr-x 2 hadoop hadoop 4096 Aug  1 19:03 current</span><br><span class="line">-rw-rw-r-- 1 hadoop hadoop   14 Jul 29 15:49 in_use.lock</span><br></pre></td></tr></table></figure><p>currenté‡Œçš„å†…å®¹å¦‚ä¸‹ï¼š<br><img src="/blogimgs/namenode-checkpoint/namenode-metadata-dir.png" alt="currentç›®å½•" title="currentç›®å½•"></p><p>ä¸Šé¢æ˜¯å°†fsimageå’Œeditséƒ½æ”¾åœ¨ä¸€ä¸ªç›®å½•ä¸­ï¼Œä¹Ÿå¯ä»¥é€šè¿‡é…ç½®å°†fsimageå’Œeditsåˆ†åˆ«æ”¾åœ¨ä¸åŒçš„ç›®å½•ä¸­ã€‚ä¸‹é¢å°±å…·ä½“ä»‹ç»ä¸‹ç›®å½•ä¸­å„ä¸ªæ–‡ä»¶çš„ä½œç”¨ï¼š</p><ul><li>in_use.lock â€“ çœ‹åå­—å¯ä»¥å¾—çŸ¥è¿™æ˜¯ä¸€ä¸ªé”æ–‡ä»¶ï¼Œç”±NameNodeæŒæœ‰ï¼Œç”¨æ¥é˜»æ­¢å¤šä¸ªNameNodeåŒæ—¶ä¿®æ”¹è¯¥ç›®å½•</li><li>VERSION - Javaå±æ€§æ–‡ä»¶ï¼Œå†…å®¹å¤§è‡´å¦‚ä¸‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#Fri Jul 29 15:50:00 CST 2016</span></span><br><span class="line">namespaceID=1793378918</span><br><span class="line">clusterID=CID-0bcbc37e-90e2-40c5-91c2-101db9fc4f9b</span><br><span class="line">cTime=0</span><br><span class="line">storageType=NAME_NODE</span><br><span class="line">blockpoolID=BP-2041947102-172.16.2.126-1451322470514</span><br><span class="line">layoutVersion=-60</span><br></pre></td></tr></table></figure><ul><li>layoutVersion â€“ HDFSå…ƒæ•°æ®æ ¼å¼åŒ–çš„ç‰ˆæœ¬ã€‚å¦‚æœç»™HDFSæ·»åŠ æ–°çš„featureè€Œéœ€è¦æ”¹å˜å…ƒæ•°æ®çš„æ ¼å¼åŒ–ç‰ˆæœ¬ï¼Œåˆ™æ”¹å˜æ­¤å±æ€§ï¼Œç‰ˆæœ¬å·æ˜¯é€’å‡çš„ã€‚</li><li>storageType â€“ è¯´æ˜è¿™ä¸ªæ–‡ä»¶å­˜å‚¨çš„æ˜¯ä»€ä¹ˆè¿›ç¨‹çš„æ•°æ®ç»“æ„ä¿¡æ¯ã€‚(NAME_NODEæˆ–è€…JOURNAL_NODEï¼ŒJOURNAL_NODEæ˜¯JouranlNodeçš„å…ƒæ•°æ®ï¼Œåœ¨DataNodeä¸­æ˜¯DATA_NODE)</li><li>cTime â€“ æ–‡ä»¶ç³»ç»Ÿåˆ›å»ºçš„æ—¶é—´ï¼Œéšç€HDFSçš„å‡çº§è€Œæ”¹å˜ã€‚(è¿™é‡Œæ²¡æœ‰å¯¹HDFSå‡çº§ï¼Œåˆ™è®°å½•å€¼ä¸º0)</li><li>namespaceID/clusterID/blockpoolID â€“ è¿™äº›éƒ½å”¯ä¸€æ ‡è¯†äº†HDFSé›†ç¾¤ã€‚è¿™äº›æ ‡è¯†ä¸»è¦æ˜¯ç”¨æ¥é˜²æ­¢DataNodeæ³¨å†Œåˆ°åˆ«çš„å…¶å®ƒé›†ç¾¤çš„NameNodeä¸­ã€‚è¿™äº›æ ‡è¯†ç¬¦åœ¨è”é‚¦éƒ¨ç½²ä¸­å°¤å…¶é‡è¦ã€‚åœ¨è”é‚¦æ¨¡å¼ä¸‹ï¼Œæ¯ä¸ªNameSpaceéƒ½å”¯ä¸€çš„namespaceIDï¼Œç®¡ç†ç€å¯¹åº”çš„å”¯ä¸€blockpoolIDï¼Œè€ŒclusterIDåˆ™æ˜¯æ•´ä¸ªè”é‚¦é›†ç¾¤çš„å”¯ä¸€é€»è¾‘å•å…ƒï¼Œé›†ç¾¤ä¸­æ‰€æœ‰çš„èŠ‚ç‚¹éƒ½ç›¸åŒã€‚</li><li>seen_txid â€“ è¿™ä¸ªæ–‡ä»¶é‡Œè®°å½•äº†æœ€åä¸€æ¬¡checkpoint(å°†editsåˆå¹¶åˆ°fsimageä¸­)æˆ–è€…editå›æ»š(å°†edits_inprogress_xxæ–‡ä»¶å›æ»šæˆä¸€ä¸ªæ–°çš„editsæ–‡ä»¶)ä¹‹åçš„transactionIDã€‚æ³¨æ„è¿™é‡Œè®°å½•çš„ä¸æ˜¯NameNodeæ¥å—çš„æœ€åä¸€ä¸ªtransactionIDï¼Œæ­¤æ–‡ä»¶ä¸ä¼šåœ¨æ¯æ¬¡transactionéƒ½ä¼šæ›´æ–°ï¼Œåªåœ¨checkpointå’Œeditå›æ»šæ—¶æ›´æ–°**(ä½†æ˜¯é€šè¿‡è§‚å¯Ÿ2.6.0ç‰ˆæœ¬çš„æœ¬åœ°å…ƒæ•°æ®ç£ç›˜ç›®å½•ä¸­è®°å½•çš„æ­¤å€¼ï¼Œæ˜¯å®æ—¶æ›´æ–°çš„ï¼Œæ¯æ¬¡transactionéƒ½ä¼šæ›´æ–°ï¼Œè¿™ä¸ªå…·ä½“éšåæ›´ä»£ç çœ‹ä¸‹ä»€ä¹ˆæƒ…å†µï¼Œåœ¨æ­¤åªåšè®°å½•ä¸‹)**ã€‚æ­¤æ–‡ä»¶çš„ç›®çš„æ˜¯åœ¨NameNodeå¯åŠ¨è¿‡ç¨‹ä¸­å‘ç°editsæ–‡ä»¶ä¸¢å¤±çš„æƒ…å†µã€‚å¦‚æœeditsæ–‡ä»¶ä¸¢å¤±ï¼ŒNameNodeå¯åŠ¨çš„è¿‡ç¨‹ä¸­åŠ è½½fsimageæ–‡ä»¶ï¼Œæ­¤æ—¶fsimageå¹¶ä¸æ˜¯æœ€æ–°çš„NameNodeçŠ¶æ€ï¼Œè€Œæ­¤æ—¶åˆç¼ºå¤±ä¸€äº›editsæ–‡ä»¶ï¼Œä½†NameNodeå¹¶ä¸çŸ¥é“ï¼Œè€Œæ˜¯æ­£å¸¸å¯åŠ¨äº†ï¼Œæ­¤æ—¶å°±ä¼šé€ æˆä¸€äº›æ•°æ®ä¸¢å¤±ã€‚seen_txidèƒ½ç”¨æ¥é˜²æ­¢è¿™ç§æƒ…å†µå‘ç”Ÿï¼Œå¦‚æœå‘ç°seen_txidä¸­è®°å½•çš„å€¼å’Œeditsçš„å€¼ä¸ä¸€æ ·ï¼Œåˆ™å¯åŠ¨å¤±è´¥ã€‚</li></ul><h3 id="JournalNodeä¸‹çš„å…ƒæ•°æ®"><a href="#JournalNodeä¸‹çš„å…ƒæ•°æ®" class="headerlink" title="JournalNodeä¸‹çš„å…ƒæ•°æ®"></a>JournalNodeä¸‹çš„å…ƒæ•°æ®</h3><p>åœ¨HAæ¨¡å¼ä¸‹ï¼Œeditsç”±ä¸€ç»„ç‹¬ç«‹çš„å®ˆæŠ¤è¿›ç¨‹JournalNodesè¿›è¡Œæ”¶é›†ã€‚JournalNodeçš„å…ƒæ•°æ®ç›®å½•é…ç½®åœ¨hdfs-site.xmlçš„<code>dfs.journalnode.edits.dir</code>ã€‚JournalNodeçš„å…ƒæ•°æ®åŒ…å«ä¸€ä¸ªVERSIONæ–‡ä»¶ï¼Œå¤šä¸ªedits_xxæ–‡ä»¶å’Œä¸€ä¸ªedits_inprogress_xxï¼Œè¿˜åŒ…å«ä¸€äº›ä¸HAå®ç°ç›¸å…³çš„æ–‡ä»¶ï¼Œè¿™äº›æ–‡ä»¶ä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢è„‘è£‚ï¼Œ<em>ä½†æ˜¯JournalNodeå¹¶ä¸åŒ…å«fsimageå’Œseen_txid</em>ã€‚</p><p>ä¸‹é¢ä¸»è¦ä»‹ç»ä¸‹ä¸NameNodeå…ƒæ•°æ®ä¸ä¸€æ ·çš„æ–‡ä»¶ï¼š</p><ul><li>committed-txid â€“ è®°å½•ç”±NameNodeæäº¤çš„æœ€åä¸€ä¸ªtransaction ID</li><li>last-promised-epoch â€“ è¿™ä¸ªæ–‡ä»¶è®°å½•äº†epochï¼Œepochæ˜¯ä¸€ä¸ªå•è°ƒé€’å¢çš„æ•°å­—ã€‚å½“standbyå˜ä¸ºactiveæ—¶ï¼ŒJournalNodeä¼šä¼šå¢åŠ epochå¹¶å­˜å‚¨ã€‚NameNodeä¸»è¦é€šè¿‡è¯¥å€¼æ¥å‘Šè¯‰JournalNodeè°æ˜¯activeï¼Œå°äºè¯¥å€¼çš„NameNodeç¦æ­¢å¯¹JournalNodeå…ƒæ•°æ®å†™æ“ä½œï¼Œå†™è¯·æ±‚è¢«å¿½ç•¥ã€‚</li><li>last-writer-epoch â€“ å’Œä¸Šé¢çš„å€¼ç±»ä¼¼ï¼Œè¯¥æ–‡ä»¶è®°å½•ä¸‹æœ€åä¸€æ¬¡å‘ç”Ÿå†™æ“ä½œçš„epochã€‚</li><li>paxos â€“ æ­¤ç›®å½•åŒ…å«ä¸€äº›ä¸´æ—¶æ–‡ä»¶ï¼Œä¸»è¦åœ¨å®ç°paxosåˆ†å¸ƒå¼ç®—æ³•åè®®ä¸­ä½¿ç”¨ã€‚è¿™ä¸ªç›®å½•é€šå¸¸æ˜¯ç©ºçš„ã€‚</li></ul><h2 id="Checkpoint"><a href="#Checkpoint" class="headerlink" title="Checkpoint"></a>Checkpoint</h2><blockquote><p>æ¯ä¸ªå†™æ“ä½œéƒ½ä¼šå†™å…¥Edit logä¸­ï¼Œéšç€æ—¶é—´çš„ç§¯ç´¯edit logä¼šå˜çš„å¾ˆå¤§ï¼Œæç«¯æƒ…å†µä¸‹ä¸ä»…ä¼šå æ»¡æ•´ä¸ªç£ç›˜ï¼Œè€Œä¸”åœ¨NNå¯åŠ¨çš„æ—¶å€™ä¼šå»¶é•¿å¯åŠ¨æ—¶é—´ï¼Œå› ä¸ºNNéœ€è¦å°†edits logä¸­çš„æ“ä½œé‡æ–°æ‰§è¡Œä¸€éã€‚è¿™å°±éœ€è¦checkpointå®šæœŸå¯¹å…ƒæ•°æ®è¿›è¡Œåˆå¹¶ã€‚</p></blockquote><p>Checkpointä¸»è¦æ˜¯å°†fsimageå’Œedit logçš„å†…å®¹è¿›è¡Œåˆå¹¶ç”Ÿæˆä¸€ä¸ªæ–°çš„fsimageã€‚è¿™æ ·åœ¨NNå¯åŠ¨çš„æ—¶å€™å°±ä¸ç”¨å°†å·¨å¤§çš„editsé‡Œçš„äº‹åŠ¡å†æ¬¡æ‰§è¡Œä¸€éäº†ï¼Œè€Œæ˜¯ç›´æ¥åŠ è½½åˆå¹¶ä¹‹åçš„æ–°fsimageï¼Œç„¶åé‡æ–°æ‰§è¡Œæœªè¢«åˆå¹¶çš„editsæ–‡ä»¶å°±å¯ä»¥äº†ã€‚</p><p><em>åˆ›å»ºæ–°fsimageçš„è¿‡ç¨‹éœ€è¦å¤§é‡çš„I/Oã€å†…å­˜ç­‰èµ„æºï¼Œè€Œä¸”namesystemåœ¨Checkpointçš„æ—¶å€™ä¼šé™åˆ¶ç”¨æˆ·çš„è®¿é—®ã€‚åˆ™NNå°†Checkpointè¿‡ç¨‹æ”¾åœ¨SecondaryNameNodeæˆ–è€…StandbyNameNodeä¸­ã€‚</em></p><p>Checkpointçš„è§¦å‘æ¡ä»¶æœ‰ä¸¤ä¸ªï¼Œæ»¡è¶³å…¶ä¸­ä¸€ä¸ªå³å¯ï¼š</p><ol><li>ä¸¤æ¬¡checkpointçš„æ—¶é—´é—´éš”è¾¾åˆ°é˜ˆå€¼ï¼Œç”±å±æ€§<code>dfs.namenode.checkpoint.period</code>æ§åˆ¶ï¼Œé»˜è®¤æ˜¯3600s</li><li>æ–°ç”Ÿæˆçš„edit logä¸­ç§¯ç´¯çš„äº‹åŠ¡æ•°é‡è¾¾åˆ°äº†é˜ˆå€¼ï¼Œç”±å±æ€§<code>dfs.namenode.checkpoint.txns</code>æ§åˆ¶ï¼Œé»˜è®¤1000000</li></ol><p>SecondaryNameNodeæˆ–è€…StandbyNameNodeå‘¨æœŸæ€§çš„å»æ£€æŸ¥æ˜¯å¦ç¬¦åˆè§¦å‘Checkpointçš„æ¡ä»¶ï¼Œé—´éš”å‘¨æœŸæ˜¯ç”±<code>dfs.namenode.checkpoint.check.period</code>æ§åˆ¶çš„ï¼Œé»˜è®¤æ˜¯60s</p><blockquote><p>Fsimageå›æ»šæ¡ä»¶</p></blockquote><ol><li>fsimageä¼šåœ¨æ¯æ¬¡checkpointæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„fsimage</li><li>NNé‡å¯çš„æ—¶å€™ä¹Ÿä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„fsimage</li></ol><p><em>fsimageé»˜è®¤ä¼šä¿å­˜ä¸¤ä¸ª</em>ï¼Œç”±å±æ€§<code>dfs.namenode.num.checkpoints.retained</code>æ§åˆ¶</p><blockquote><p>Edits logå›æ»šæ¡ä»¶</p></blockquote><ol><li>NameNode(active)å‘¨æœŸæ€§çš„æ£€æŸ¥å½“å‰çš„äº‹åŠ¡æ•°æ˜¯å¦è¶…è¿‡äº†editså›æ»šé˜ˆå€¼ã€‚<br>é—´éš”å‘¨æœŸæ˜¯ç”±<code>dfs.namenode.edit.log.autoroll.check.interval.ms</code>æ§åˆ¶ï¼Œé»˜è®¤æ˜¯300000msã€‚<br>å›æ»šçš„é˜ˆå€¼æ˜¯<code>dfs.namenode.edit.log.autoroll.multiplier.threshold</code>å’Œ<code>dfs.namenode.checkpoint.txns</code>çš„ä¹˜ç§¯ï¼Œ<code>dfs.namenode.edit.log.autoroll.multiplier.threshold</code>é»˜è®¤æ˜¯2.0f</li><li>åœ¨HAæ¨¡å¼ä¸‹ï¼Œstandby NNä¼šå‘¨æœŸçš„è®©active NNå¯¹editsè¿›è¡Œå›æ»šï¼Œé—´éš”å‘¨æœŸç”±<code>dfs.ha.log-roll.period</code><br>æ§åˆ¶ï¼Œé»˜è®¤æ˜¯120s</li></ol><p>standby NNä¹‹æ‰€ä»¥å‘¨æœŸçš„è®©active NNå›æ»šedits logæ˜¯å› ä¸ºstandby NNä¸ä¼šè¯»å–_inprogress_çš„editsï¼Œåªæ˜¯å‘¨æœŸï¼ˆ<code>dfs.ha.tail-edits.period</code>ï¼Œé»˜è®¤æ˜¯60sï¼‰çš„å»æ£€æµ‹å·²ç»å®Œæˆçš„editsæ–‡ä»¶ï¼Œå¹¶å°†è¯¥editsæ–‡ä»¶é€šè¿‡JournalNodeè¯»å–åˆ°å†…å­˜æ›´æ–°fsimageåœ¨å†…å­˜ä¸­çš„çŠ¶æ€ã€‚</p><p><strong>HAæ¨¡å¼ä¸‹ï¼Œclientåªå’Œactiveè¿›è¡Œé€šä¿¡ï¼Œå°†å†™æ“ä½œä¿¡æ¯åˆ†åˆ«å†™å…¥æœ¬åœ°çš„editsä¸­å’ŒJournalNodeä¸­çš„editsä¸­ï¼Œstandby NNå‘¨æœŸçš„å»JournalNodeä¸­è¯»å–è¿›è¡ŒåŒæ­¥ã€‚åªæœ‰åœ¨activeå®•æœºä¹‹åï¼Œstandbyæ‰å¯¹å¤–æä¾›æœåŠ¡ï¼Œå¹³æ—¶åªæ˜¯å®ç°äº†activeçš„çƒ­å¤‡</strong></p><p>edits logé»˜è®¤ä¼šä¿å­˜<code>dfs.namenode.num.extra.edits.retained</code>æ¡äº‹åŠ¡ï¼Œé»˜è®¤æ˜¯1000000æ¡</p><h2 id="æŸ¥çœ‹fsimageå’Œeditså†…å®¹çš„å‘½ä»¤"><a href="#æŸ¥çœ‹fsimageå’Œeditså†…å®¹çš„å‘½ä»¤" class="headerlink" title="æŸ¥çœ‹fsimageå’Œeditså†…å®¹çš„å‘½ä»¤"></a>æŸ¥çœ‹fsimageå’Œeditså†…å®¹çš„å‘½ä»¤</h2><blockquote><p>æŸ¥çœ‹fsimageå‘½ä»¤</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs oiv -p XML -i fsimage -o fsimage.xml</span><br></pre></td></tr></table></figure><p><code>-i</code>æ˜¯è¾“å…¥çš„fsimageæ–‡ä»¶åï¼Œ<code>-o</code>æ˜¯è¾“å‡ºçš„æ–‡ä»¶åï¼Œ<code>-p</code>æ˜¯è¾“å‡ºçš„æ ¼å¼ã€‚å…·ä½“çš„ç»†èŠ‚å¯ä»¥æŸ¥çœ‹å®˜ç½‘æˆ–è€…ä½¿ç”¨helpå‘½ä»¤æŸ¥çœ‹ã€‚</p><blockquote><p>æŸ¥çœ‹editså‘½ä»¤</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs oev -i edits -o edits.xml</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> Checkpoint </tag>
            
            <tag> FSImage </tag>
            
            <tag> Edits </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFS ReplicationMonitorå‰¯æœ¬ç›‘æ§çº¿ç¨‹è§£æ</title>
      <link href="/HDFS%20ReplicationMonitor%E5%89%AF%E6%9C%AC%E7%9B%91%E6%8E%A7%E7%BA%BF%E7%A8%8B%E8%A7%A3%E6%9E%90.html"/>
      <url>/HDFS%20ReplicationMonitor%E5%89%AF%E6%9C%AC%E7%9B%91%E6%8E%A7%E7%BA%BF%E7%A8%8B%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<p><a href="http://bigdatadecode.top/HDFS%E7%BB%B4%E6%8C%81%E5%89%AF%E6%9C%AC%E5%B9%B3%E8%A1%A1%E7%9A%84%E6%B5%81%E7%A8%8B.html">ä¸Šç¯‡</a>æ–‡ç« ä»‹ç»äº†HDFSä¸­å‰¯æœ¬æ•°çš„ç»´æŒï¼Œå½“æŸä¸ªblockçš„å‰¯æœ¬æ•°å¤§äºæœŸæœ›çš„å‰¯æœ¬æ•°æ—¶ï¼Œé€šè¿‡<code>BlockManager.processOverReplicatedBlock</code>ï¼Œå¯¹å‰¯æœ¬è¿›è¡Œå¤„ç†ï¼Œæ ¹æ®è§„åˆ™é€‰æ‹©è¦åˆ é™¤å‰¯æœ¬çš„dnï¼Œå°†dnå’Œblockæ”¾å…¥<em>invalidateBlocks</em>ä¸­ï¼Œç„¶åReplicationMonitorçº¿ç¨‹ä¼šä»ä¸­å–å‡ºblockå‰¯æœ¬è¿›è¡Œåˆ é™¤ã€‚å½“æŸä¸ªblockçš„å‰¯æœ¬æ•°å°‘äºæœŸæœ›çš„å‰¯æœ¬æ•°æ—¶ï¼Œé€šè¿‡<code>BlockManager.processMisReplicatedBlock</code>ï¼Œå¯¹å‰¯æœ¬æ ¹æ®å…¶å¤åˆ¶ä¼˜å…ˆçº§è¿›è¡Œåˆ’åˆ†ï¼Œæ”¾å…¥<em>neededReplications</em>ï¼Œç„¶åReplicationMonitorçº¿ç¨‹ä¼šä»ä¸­å–å‡ºblockå‰¯æœ¬è¿›è¡Œå¤åˆ¶ã€‚</p><span id="more"></span><h2 id="ReplicationMonitorçº¿ç¨‹"><a href="#ReplicationMonitorçº¿ç¨‹" class="headerlink" title="ReplicationMonitorçº¿ç¨‹"></a>ReplicationMonitorçº¿ç¨‹</h2><p>ReplicationMonitorå®ç°äº†Runnableæ¥å£ï¼Œé€šè¿‡<code>FSNameSystem.startCommonServices -&gt; blockManager.activate(conf) -&gt; this.replicationThread.start()</code>è¢«å¯åŠ¨ï¼Œä¸»è¦ä½œç”¨å°±æ˜¯è®¡ç®—DataNodeå·¥ä½œï¼Œå¹¶å°†å¤åˆ¶è¯·æ±‚è¶…æ—¶çš„å—é‡æ–°åŠ å…¥åˆ°å¾…è°ƒåº¦é˜Ÿåˆ—ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (namesystem.isRunning()) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// Process replication work only when active NN is out of safe mode.</span></span><br><span class="line">      <span class="keyword">if</span> (namesystem.isPopulatingReplQueues()) &#123;</span><br><span class="line">        computeDatanodeWork();</span><br><span class="line">        processPendingReplications();</span><br><span class="line">      &#125;</span><br><span class="line">      Thread.sleep(replicationRecheckInterval);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>çº¿ç¨‹ä¸­é€šè¿‡<code>computeDatanodeWork</code>è®¡ç®—DataNodeçš„å·¥ä½œï¼Œé€šè¿‡<code>processPendingReplications</code>å°†è¶…æ—¶çš„è¯·æ±‚æ”¾å…¥<em>neededReplication</em>é˜Ÿåˆ—ã€‚</p><p>Datanodeçš„å·¥ä½œåŒ…æ‹¬å¤åˆ¶å’Œåˆ é™¤ï¼Œçœ‹ä¸‹<code>computeDatanodeWork</code>çš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Compute block replication and block invalidation work that can be scheduled</span></span><br><span class="line"><span class="comment"> * on data-nodes. The datanode will be informed of this work at the next</span></span><br><span class="line"><span class="comment"> * heartbeat.</span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span> number of blocks scheduled for replication or removal.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">computeDatanodeWork</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Blocks should not be replicated or removed if in safe mode.</span></span><br><span class="line">  <span class="comment">// It&#x27;s OK to check safe mode here w/o holding lock, in the worst</span></span><br><span class="line">  <span class="comment">// case extra replications will be scheduled, and these will get</span></span><br><span class="line">  <span class="comment">// fixed up later.</span></span><br><span class="line">  <span class="keyword">if</span> (namesystem.isInSafeMode()) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numlive = heartbeatManager.getLiveDatanodeCount();</span><br><span class="line">  <span class="comment">// dfs.namenode.replication.work.multiplier.per.iteration é»˜è®¤ä¸º2</span></span><br><span class="line">  <span class="comment">// ä¸€æ¬¡å¿ƒè·³æ€»å…±æœ‰å¤šå°‘ä¸ªblockè¿›è¡Œè½¬ç§»</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> blocksToProcess = numlive</span><br><span class="line">      * <span class="keyword">this</span>.blocksReplWorkMultiplier;</span><br><span class="line">  <span class="comment">// ä¸€æ¬¡å¿ƒè·³åˆ é™¤å¤šä¸ªdnä¸Šçš„invalidate blockï¼Œè®¡æ•°å•ä½æ˜¯xä¸ªdn</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> nodesToProcess = (<span class="keyword">int</span>) Math.ceil(numlive</span><br><span class="line">      * <span class="keyword">this</span>.blocksInvalidateWorkPct);</span><br><span class="line">  <span class="comment">// è®¡ç®—å¤åˆ¶çš„å·¥ä½œé‡</span></span><br><span class="line">  <span class="keyword">int</span> workFound = <span class="keyword">this</span>.computeReplicationWork(blocksToProcess);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Update counters</span></span><br><span class="line">  namesystem.writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.updateState();</span><br><span class="line">    <span class="keyword">this</span>.scheduledReplicationBlocksCount = workFound;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    namesystem.writeUnlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è®¡ç®—åˆ é™¤çš„å·¥ä½œé‡</span></span><br><span class="line">  workFound += <span class="keyword">this</span>.computeInvalidateWork(nodesToProcess);</span><br><span class="line">  <span class="keyword">return</span> workFound;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>computeDatanodeWorké€šè¿‡numLiveå¾—åˆ°ä¸€æ¬¡å¿ƒè·³éœ€è¦å¤åˆ¶å‰¯æœ¬çš„æœŸæœ›ä¸ªæ•°<em>blocksToProcess</em>å’Œä¸€æ¬¡å¿ƒè·³éœ€è¦åˆ é™¤å‰¯æœ¬çš„æœŸæœ›ä¸ªæ•°<em>nodesToProcess</em>ï¼Œç„¶ååˆ†åˆ«æœ‰<em>computeReplicationWork</em>å’Œ<em>computeInvalidateWork</em>åˆ†åˆ«è¿›è¡Œå¤åˆ¶å’Œåˆ é™¤ã€‚</p><h2 id="å¤åˆ¶"><a href="#å¤åˆ¶" class="headerlink" title="å¤åˆ¶"></a>å¤åˆ¶</h2><p>ä¸‹é¢å…ˆæ¥çœ‹ä¸‹å¤åˆ¶å·¥ä½œ<code>computeReplicationWork</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">computeReplicationWork</span><span class="params">(<span class="keyword">int</span> blocksToProcess)</span> </span>&#123;</span><br><span class="line">  List&lt;List&lt;Block&gt;&gt; blocksToReplicate = <span class="keyword">null</span>;</span><br><span class="line">  namesystem.writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// Choose the blocks to be replicated</span></span><br><span class="line">    <span class="comment">// ä»neededReplicationsä¸­æŒ‰ç…§ä¼˜å…ˆçº§æŒ‘é€‰å‡ºblock</span></span><br><span class="line">    blocksToReplicate = neededReplications</span><br><span class="line">        .chooseUnderReplicatedBlocks(blocksToProcess);</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    namesystem.writeUnlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å¯¹é€‰ä¸­çš„block listè¿›è¡Œå¤åˆ¶</span></span><br><span class="line">  <span class="keyword">return</span> computeReplicationWorkForBlocks(blocksToReplicate);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>computeReplicationWorkçš„åŠŸèƒ½æ˜¯ä»<em>neededReplications</em>ä¸­æŒ‰ç…§ä¼˜å…ˆçº§é€‰å–blocksToProcessä¸ªblockï¼Œç„¶åè°ƒç”¨<em>computeReplicationWorkForBlocks</em>è¿›è¡Œå¤åˆ¶ã€‚<em>neededReplications.chooseUnderReplicatedBlocks</em>çš„é€‰å–è§„åˆ™å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> List&lt;List&lt;Block&gt;&gt; chooseUnderReplicatedBlocks(</span><br><span class="line">    <span class="keyword">int</span> blocksToProcess) &#123;</span><br><span class="line">  <span class="comment">// initialize data structure for the return value</span></span><br><span class="line">  List&lt;List&lt;Block&gt;&gt; blocksToReplicate = <span class="keyword">new</span> ArrayList&lt;List&lt;Block&gt;&gt;(LEVEL);</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; LEVEL; i++) &#123;</span><br><span class="line">    blocksToReplicate.add(<span class="keyword">new</span> ArrayList&lt;Block&gt;());</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (size() == <span class="number">0</span>) &#123; <span class="comment">// There are no blocks to collect.</span></span><br><span class="line">    <span class="keyword">return</span> blocksToReplicate;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">int</span> blockCount = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">int</span> priority = <span class="number">0</span>; priority &lt; LEVEL; priority++) &#123; </span><br><span class="line">    <span class="comment">// Go through all blocks that need replications with current priority.</span></span><br><span class="line">    <span class="comment">// ä»priorityQueuesä¸­å–å‡ºå¯¹åº”ä¼˜å…ˆçº§çš„listï¼Œå¹¶è½¬æ¢ä¸ºiterator</span></span><br><span class="line">    BlockIterator neededReplicationsIterator = iterator(priority);</span><br><span class="line">    <span class="comment">// priorityToReplIdxæ˜¯ä¸€ä¸ªmapï¼Œå­˜æ”¾å„ä¸ªä¼˜å…ˆçº§ä¸­éœ€è¦å¤åˆ¶å‰¯æœ¬åœ¨listä¸­çš„index</span></span><br><span class="line">    <span class="comment">// å¾—åˆ°priorityå¼€å§‹å¤åˆ¶çš„index</span></span><br><span class="line">    Integer replIndex = priorityToReplIdx.get(priority);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// skip to the first unprocessed block, which is at replIndex</span></span><br><span class="line">    <span class="comment">// ä»neededReplicationsIteratorä¸­è·³è¿‡æ‰¾åˆ°replIndexå¯¹åº”çš„block</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; replIndex &amp;&amp; neededReplicationsIterator.hasNext(); i++) &#123;</span><br><span class="line">      neededReplicationsIterator.next();</span><br><span class="line">    &#125;</span><br><span class="line">    blocksToProcess = Math.min(blocksToProcess, size());</span><br><span class="line">    <span class="comment">// blockCountç»Ÿè®¡å¤åˆ¶äº†å¤šä¸ªblockï¼Œè¾¾åˆ°blocksToProcessåˆ™è·³å‡ºå¾ªç¯</span></span><br><span class="line">    <span class="keyword">if</span> (blockCount == blocksToProcess) &#123;</span><br><span class="line">      <span class="keyword">break</span>;  <span class="comment">// break if already expected blocks are obtained</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// Loop through all remaining blocks in the list.</span></span><br><span class="line">    <span class="comment">// å°†blockæ·»åŠ åˆ°blocksToReplicateå¯¹åº”çš„ä¼˜å…ˆçº§listä¸­</span></span><br><span class="line">    <span class="keyword">while</span> (blockCount &lt; blocksToProcess</span><br><span class="line">        &amp;&amp; neededReplicationsIterator.hasNext()) &#123;</span><br><span class="line">      Block block = neededReplicationsIterator.next();</span><br><span class="line">      blocksToReplicate.get(priority).add(block);</span><br><span class="line">      replIndex++;</span><br><span class="line">      blockCount++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœneededReplicationsIteratorä¸­æ²¡æœ‰blockï¼Œå¹¶ä¸”æ­¤æ—¶çš„ä¼˜å…ˆçº§ä¸º4ï¼Œå³æœ€ä½ä¼˜å…ˆçº§</span></span><br><span class="line">    <span class="comment">// åˆ™è¯´æ˜blockå·²è¢«å¤åˆ¶ç»“æŸï¼ŒpriorityToReplIdxè¿›è¡Œé‡æ–°èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (!neededReplicationsIterator.hasNext()</span><br><span class="line">        &amp;&amp; neededReplicationsIterator.getPriority() == LEVEL - <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// reset all priorities replication index to 0 because there is no</span></span><br><span class="line">      <span class="comment">// recently added blocks in any list.</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; LEVEL; i++) &#123;</span><br><span class="line">        priorityToReplIdx.put(i, <span class="number">0</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¦‚æœneededReplicationsIteratorä¸­æ²¡æœ‰blockï¼Œåˆ™è¿›è¡Œä¸‹ä¸€æ¬¡å¾ªç¯ï¼Œå–å‡ºä¸‹ä¼˜å…ˆçº§çš„list</span></span><br><span class="line">    <span class="comment">// å°†å½“å‰ä¼˜å…ˆçº§å¤åˆ¶çš„indexå†™å…¥priorityToReplIdx</span></span><br><span class="line">    priorityToReplIdx.put(priority, replIndex); </span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> blocksToReplicate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><em>chooseUnderReplicatedBlocks</em>è´Ÿè´£é€‰å–<em>blocksToProcess</em>ä¸ªblockï¼Œå…ˆä»priorityQueuesä¸­æŒ‰ç…§ä¼˜å…ˆçº§å–å‡ºå¯¹åº”çš„block listï¼Œåˆ©ç”¨blockCountè¿›è¡Œè®¡æ•°ï¼Œå¦‚æœè¾¾åˆ°blocksToProcessï¼Œåˆ™è·³å‡ºforï¼Œè¿”å›blocksToReplicateï¼Œå¦åˆ™å–ä¸‹ä¸€ä¼˜å…ˆçº§çš„block listï¼Œæ¥ç€è®¡æ•°ï¼Œç›´åˆ°blocksToProcessä¸ºæ­¢ã€‚</p><p>é€‰å‡ºblocksToReplicateï¼Œåˆ™è°ƒç”¨<code>computeReplicationWorkForBlocks</code>è¿›è¡Œå¤åˆ¶</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">computeReplicationWorkForBlocks</span><span class="params">(List&lt;List&lt;Block&gt;&gt; blocksToReplicate)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> requiredReplication, numEffectiveReplicas;</span><br><span class="line">  List&lt;DatanodeDescriptor&gt; containingNodes;</span><br><span class="line">  DatanodeDescriptor srcNode;</span><br><span class="line">  BlockCollection bc = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">int</span> additionalReplRequired;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">int</span> scheduledWork = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// å­˜æ”¾éœ€è¦copyçš„blockåˆ—è¡¨</span></span><br><span class="line">  List&lt;ReplicationWork&gt; work = <span class="keyword">new</span> LinkedList&lt;ReplicationWork&gt;();</span><br><span class="line">  namesystem.writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (neededReplications) &#123;</span><br><span class="line">    <span class="comment">// æŒ‰ç…§ä¼˜å…ˆçº§è¿›è¡Œå¤åˆ¶ï¼Œå…ˆå¤åˆ¶é«˜ä¼˜å…ˆçº§çš„</span></span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> priority = <span class="number">0</span>; priority &lt; blocksToReplicate.size(); priority++) &#123;</span><br><span class="line">      <span class="comment">// å¾—åˆ°å¯¹åº”ä¼˜å…ˆçº§çš„block list</span></span><br><span class="line">        <span class="keyword">for</span> (Block block : blocksToReplicate.get(priority)) &#123;</span><br><span class="line">          <span class="comment">// block should belong to a file</span></span><br><span class="line">          bc = blocksMap.getBlockCollection(block);</span><br><span class="line">          <span class="comment">// abandoned block or block reopened for append</span></span><br><span class="line">          <span class="comment">// å¦‚æœblockè¢«é—å¼ƒ(è¯¥blockæ²¡æœ‰å¯¹åº”çš„æ–‡ä»¶)æˆ–è€…è¯¥blockæ­£åœ¨è¢«è¿½åŠ ï¼Œåˆ™ä¸å¤åˆ¶</span></span><br><span class="line">          <span class="keyword">if</span>(bc == <span class="keyword">null</span> || (bc.isUnderConstruction() &amp;&amp; block.equals(bc.getLastBlock()))) &#123;</span><br><span class="line">            neededReplications.remove(block, priority); <span class="comment">// remove from neededReplications</span></span><br><span class="line">            neededReplications.decrementReplicationIndex(priority);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å¾—åˆ°expect replication</span></span><br><span class="line">          requiredReplication = bc.getBlockReplication();</span><br><span class="line">          <span class="comment">// get a source data-node</span></span><br><span class="line">          <span class="comment">// å­˜æ”¾è¯¥blockæ‰€æœ‰å‰¯æœ¬(åŒ…æ‹¬liveã€corruptã€excess)çš„datanode</span></span><br><span class="line">          <span class="comment">// åœ¨chooseSourceDatanodeä¸­èµ‹å€¼</span></span><br><span class="line">          containingNodes = <span class="keyword">new</span> ArrayList&lt;DatanodeDescriptor&gt;();</span><br><span class="line">          List&lt;DatanodeStorageInfo&gt; liveReplicaNodes = <span class="keyword">new</span> ArrayList&lt;DatanodeStorageInfo&gt;();</span><br><span class="line">          NumberReplicas numReplicas = <span class="keyword">new</span> NumberReplicas();</span><br><span class="line">          <span class="comment">// é€‰æ‹©ä¸€ä¸ªå¤åˆ¶æºç‚¹srcDodeï¼Œ</span></span><br><span class="line">          srcNode = chooseSourceDatanode(</span><br><span class="line">              block, containingNodes, liveReplicaNodes, numReplicas,</span><br><span class="line">              priority);</span><br><span class="line">          <span class="keyword">if</span>(srcNode == <span class="keyword">null</span>) &#123; <span class="comment">// block can not be replicated from any node</span></span><br><span class="line">            LOG.debug(<span class="string">&quot;Block &quot;</span> + block + <span class="string">&quot; cannot be repl from any node&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// liveReplicaNodes can include READ_ONLY_SHARED replicas which are </span></span><br><span class="line">          <span class="comment">// not included in the numReplicas.liveReplicas() count</span></span><br><span class="line">          <span class="keyword">assert</span> liveReplicaNodes.size() &gt;= numReplicas.liveReplicas();</span><br><span class="line">          <span class="comment">// do not schedule more if enough replicas is already pending</span></span><br><span class="line">          <span class="comment">// æœ‰æ•ˆå‰¯æœ¬çš„ä¸ªæ•°ç”±liveçš„ä¸ªæ•°+pendingçš„ä¸ªæ•°(å‡†å¤‡å¤åˆ¶çš„ä¸ªæ•°)</span></span><br><span class="line">          numEffectiveReplicas = numReplicas.liveReplicas() +</span><br><span class="line">                                  pendingReplications.getNumReplicas(block);</span><br><span class="line">          <span class="comment">// live+å‡†å¤‡å¤åˆ¶çš„ä¸ªæ•°è¾¾åˆ°äº†requiredReplicationï¼Œä¸è¿›è¡Œå†æ¬¡å¤åˆ¶</span></span><br><span class="line">          <span class="keyword">if</span> (numEffectiveReplicas &gt;= requiredReplication) &#123;</span><br><span class="line">            <span class="keyword">if</span> ( (pendingReplications.getNumReplicas(block) &gt; <span class="number">0</span>) ||</span><br><span class="line">                 (blockHasEnoughRacks(block)) ) &#123;</span><br><span class="line">              neededReplications.remove(block, priority); <span class="comment">// remove from neededReplications</span></span><br><span class="line">              neededReplications.decrementReplicationIndex(priority);</span><br><span class="line">              blockLog.info(<span class="string">&quot;BLOCK* Removing &quot;</span> + block</span><br><span class="line">                  + <span class="string">&quot; from neededReplications as it has enough replicas&quot;</span>);</span><br><span class="line">              <span class="keyword">continue</span>;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// additionalReplRequiredè¡¨ç¤ºå‡†å¤‡è¦å¤åˆ¶çš„ä¸ªæ•°</span></span><br><span class="line">          <span class="keyword">if</span> (numReplicas.liveReplicas() &lt; requiredReplication) &#123;</span><br><span class="line">            additionalReplRequired = requiredReplication</span><br><span class="line">                - numEffectiveReplicas;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            additionalReplRequired = <span class="number">1</span>; <span class="comment">// Needed on a new rack</span></span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// å°†blockã€srcDodeç­‰ä¿¡æ¯åŒ…è£…æˆReplicationWorkï¼Œæ”¾å…¥workçš„listä¸­</span></span><br><span class="line">          work.add(<span class="keyword">new</span> ReplicationWork(block, bc, srcNode,</span><br><span class="line">              containingNodes, liveReplicaNodes, additionalReplRequired,</span><br><span class="line">              priority));</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    namesystem.writeUnlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ç”¨äºå­˜æ”¾blockå‰¯æœ¬æ‰€åœ¨dné›†åˆï¼Œé¿å…é€‰targetæ—¶é€‰åˆ°å·²æœ‰å‰¯æœ¬çš„dn</span></span><br><span class="line">  <span class="keyword">final</span> Set&lt;Node&gt; excludedNodes = <span class="keyword">new</span> HashSet&lt;Node&gt;();</span><br><span class="line">  <span class="keyword">for</span>(ReplicationWork rw : work)&#123;</span><br><span class="line">    <span class="comment">// Exclude all of the containing nodes from being targets.</span></span><br><span class="line">    <span class="comment">// This list includes decommissioning or corrupt nodes.</span></span><br><span class="line">    excludedNodes.clear();</span><br><span class="line">    <span class="keyword">for</span> (DatanodeDescriptor dn : rw.containingNodes) &#123;</span><br><span class="line">      excludedNodes.add(dn);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// choose replication targets: NOT HOLDING THE GLOBAL LOCK</span></span><br><span class="line">    <span class="comment">// It is costly to extract the filename for which chooseTargets is called,</span></span><br><span class="line">    <span class="comment">// so for now we pass in the block collection itself.</span></span><br><span class="line">    rw.chooseTargets(blockplacement, storagePolicySuite, excludedNodes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  namesystem.writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">for</span>(ReplicationWork rw : work)&#123;</span><br><span class="line">      <span class="keyword">final</span> DatanodeStorageInfo[] targets = rw.targets;</span><br><span class="line">      <span class="keyword">if</span>(targets == <span class="keyword">null</span> || targets.length == <span class="number">0</span>)&#123;</span><br><span class="line">        rw.targets = <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">synchronized</span> (neededReplications) &#123;</span><br><span class="line">        Block block = rw.block;</span><br><span class="line">        <span class="keyword">int</span> priority = rw.priority;</span><br><span class="line">        <span class="comment">// Recheck since global lock was released</span></span><br><span class="line">        <span class="comment">// block should belong to a file</span></span><br><span class="line">        bc = blocksMap.getBlockCollection(block);</span><br><span class="line">        <span class="comment">// abandoned block or block reopened for append</span></span><br><span class="line">        <span class="keyword">if</span>(bc == <span class="keyword">null</span> || (bc.isUnderConstruction() &amp;&amp; block.equals(bc.getLastBlock()))) &#123;</span><br><span class="line">          neededReplications.remove(block, priority); <span class="comment">// remove from neededReplications</span></span><br><span class="line">          rw.targets = <span class="keyword">null</span>;</span><br><span class="line">          neededReplications.decrementReplicationIndex(priority);</span><br><span class="line">          <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        requiredReplication = bc.getBlockReplication();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// do not schedule more if enough replicas is already pending</span></span><br><span class="line">        NumberReplicas numReplicas = countNodes(block);</span><br><span class="line">        numEffectiveReplicas = numReplicas.liveReplicas() +</span><br><span class="line">          pendingReplications.getNumReplicas(block);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (numEffectiveReplicas &gt;= requiredReplication) &#123;</span><br><span class="line">          <span class="keyword">if</span> ( (pendingReplications.getNumReplicas(block) &gt; <span class="number">0</span>) ||</span><br><span class="line">               (blockHasEnoughRacks(block)) ) &#123;</span><br><span class="line">            neededReplications.remove(block, priority); <span class="comment">// remove from neededReplications</span></span><br><span class="line">            neededReplications.decrementReplicationIndex(priority);</span><br><span class="line">            rw.targets = <span class="keyword">null</span>;</span><br><span class="line">            blockLog.info(<span class="string">&quot;BLOCK* Removing &quot;</span> + block</span><br><span class="line">                + <span class="string">&quot; from neededReplications as it has enough replicas&quot;</span>);</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( (numReplicas.liveReplicas() &gt;= requiredReplication) &amp;&amp;</span><br><span class="line">             (!blockHasEnoughRacks(block)) ) &#123;</span><br><span class="line">          <span class="keyword">if</span> (rw.srcNode.getNetworkLocation().equals(</span><br><span class="line">              targets[<span class="number">0</span>].getDatanodeDescriptor().getNetworkLocation())) &#123;</span><br><span class="line">            <span class="comment">//No use continuing, unless a new rack in this case</span></span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Add block to the to be replicated list</span></span><br><span class="line">        <span class="comment">// å°†å¤åˆ¶blockçš„ä¸ªæ•°æ”¾å…¥dnä¸­ï¼Œç”¨äºç»Ÿè®¡dnä¸Šæœ‰å¤šå°‘ä¸ªå‰¯æœ¬è¦å¤åˆ¶ï¼Œæ˜¯å¦è¾¾åˆ°ä¸Šé™</span></span><br><span class="line">        rw.srcNode.addBlockToBeReplicated(block, targets);</span><br><span class="line">        scheduledWork++;</span><br><span class="line">        DatanodeStorageInfo.incrementBlocksScheduled(targets);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Move the block-replication into a &quot;pending&quot; state.</span></span><br><span class="line">        <span class="comment">// The reason we use &#x27;pending&#x27; is so we can retry</span></span><br><span class="line">        <span class="comment">// replications that fail after an appropriate amount of time.</span></span><br><span class="line">        <span class="comment">// æ”¾å…¥pendingé˜Ÿåˆ—ç­‰å¾…è°ƒåº¦</span></span><br><span class="line">        pendingReplications.increment(block,</span><br><span class="line">            DatanodeStorageInfo.toDatanodeDescriptors(targets));</span><br><span class="line">        <span class="keyword">if</span>(blockLog.isDebugEnabled()) &#123;</span><br><span class="line">          blockLog.debug(</span><br><span class="line">              <span class="string">&quot;BLOCK* block &quot;</span> + block</span><br><span class="line">              + <span class="string">&quot; is moved from neededReplications to pendingReplications&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// remove from neededReplications</span></span><br><span class="line">        <span class="keyword">if</span>(numEffectiveReplicas + targets.length &gt;= requiredReplication) &#123;</span><br><span class="line">          neededReplications.remove(block, priority); <span class="comment">// remove from neededReplications</span></span><br><span class="line">          neededReplications.decrementReplicationIndex(priority);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    namesystem.writeUnlock();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">return</span> scheduledWork;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>computeReplicationWorkForBlocksä»£ç æ¯”è¾ƒé•¿ï¼Œå·®ä¸å¤š200è¡Œï¼Œçœ‹çš„æ—¶å€™å¯ä»¥æŠŠä»£ç é€»è¾‘å†™åœ¨çº¸ä¸Šï¼Œæ…¢æ…¢åˆ†æã€‚ä¸»è¦åŒ…æ‹¬3ä¸ªå¤§forå¾ªç¯ï¼Œç¬¬ä¸€ä¸ªforå¾ªç¯æ˜¯æ‰¾åˆ°å„ä¸ªblockçš„srcNodeï¼Œç¬¬äºŒä¸ªforå¾ªç¯æ˜¯æ‰¾åˆ°ä¸ªäººblockçš„targetsï¼Œç¬¬ä¸‰ä¸ªforå¾ªç¯åˆ™æ˜¯æŠŠå„ä¸ªblockæ”¾å…¥pendingé˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦ã€‚</p><h3 id="ç¬¬ä¸€ä¸ªforå¾ªç¯"><a href="#ç¬¬ä¸€ä¸ªforå¾ªç¯" class="headerlink" title="ç¬¬ä¸€ä¸ªforå¾ªç¯"></a>ç¬¬ä¸€ä¸ªforå¾ªç¯</h3><p>ç¬¬ä¸€ä¸ªforå¾ªç¯ä¸­çš„srcNodeæ˜¯åœ¨<code>chooseSourceDatanode</code>ä¸­é€‰å–çš„ï¼Œé€‰å–è§„åˆ™ä¸ºï¼Œ<strong>ä¼˜å…ˆé€‰æ‹©æ­£åœ¨ä¸‹çº¿çš„èŠ‚ç‚¹ï¼Œç„¶åéšæœºé€‰æ‹©ä¸€ä¸ªæ²¡æœ‰è¾¾åˆ°å¤åˆ¶ä¸Šé™çš„èŠ‚ç‚¹ï¼Œå¦‚æœå¤åˆ¶çš„ä¼˜å…ˆçº§æœ€é«˜å¹¶ä¸”æ‰€ä»¥çš„èŠ‚ç‚¹éƒ½è¾¾åˆ°äº†ä¸Šé™ï¼Œåˆ™éšæœºé€‰ä¸€ä¸ª</strong>ã€‚ä¸‹é¢çœ‹ä¸‹ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"> <span class="function">DatanodeDescriptor <span class="title">chooseSourceDatanode</span><span class="params">(Block block,</span></span></span><br><span class="line"><span class="params"><span class="function">     List&lt;DatanodeDescriptor&gt; containingNodes,</span></span></span><br><span class="line"><span class="params"><span class="function">     List&lt;DatanodeStorageInfo&gt;  nodesContainingLiveReplicas,</span></span></span><br><span class="line"><span class="params"><span class="function">     NumberReplicas numReplicas,</span></span></span><br><span class="line"><span class="params"><span class="function">     <span class="keyword">int</span> priority)</span> </span>&#123;</span><br><span class="line">  containingNodes.clear();</span><br><span class="line">  nodesContainingLiveReplicas.clear();</span><br><span class="line">  DatanodeDescriptor srcNode = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">int</span> live = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> decommissioned = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> corrupt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> excess = <span class="number">0</span>;</span><br><span class="line">  </span><br><span class="line">  Collection&lt;DatanodeDescriptor&gt; nodesCorrupt = corruptReplicas.getNodes(block);</span><br><span class="line">  <span class="keyword">for</span>(DatanodeStorageInfo storage : blocksMap.getStorages(block)) &#123;</span><br><span class="line">    <span class="keyword">final</span> DatanodeDescriptor node = storage.getDatanodeDescriptor();</span><br><span class="line">    LightWeightLinkedSet&lt;Block&gt; excessBlocks =</span><br><span class="line">      excessReplicateMap.get(node.getDatanodeUuid());</span><br><span class="line">    <span class="comment">// ç»Ÿè®¡çš„å‰ææ˜¯å½“å‰ç£ç›˜æ­£å¸¸</span></span><br><span class="line">    <span class="keyword">int</span> countableReplica = storage.getState() == State.NORMAL ? <span class="number">1</span> : <span class="number">0</span>; </span><br><span class="line">    <span class="keyword">if</span> ((nodesCorrupt != <span class="keyword">null</span>) &amp;&amp; (nodesCorrupt.contains(node)))</span><br><span class="line">      corrupt += countableReplica;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (node.isDecommissionInProgress() || node.isDecommissioned())</span><br><span class="line">      decommissioned += countableReplica;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (excessBlocks != <span class="keyword">null</span> &amp;&amp; excessBlocks.contains(block)) &#123;</span><br><span class="line">      excess += countableReplica;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ç»Ÿè®¡åŒ…å«read onlyçš„æƒ…å†µ</span></span><br><span class="line">      <span class="comment">// å½“Stateä¸ºread onlyæ—¶ï¼ŒcountableReplicaä¸º0ï¼Œliveæ²¡æœ‰ç»Ÿè®¡read onlyçš„æƒ…å†µ</span></span><br><span class="line">      nodesContainingLiveReplicas.add(storage);</span><br><span class="line">      live += countableReplica;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å°†blockçš„å‰¯æœ¬æ‰€åœ¨dnéƒ½æ”¾å…¥containingNodesä¸­</span></span><br><span class="line">    containingNodes.add(node);</span><br><span class="line">    <span class="comment">// Check if this replica is corrupt</span></span><br><span class="line">    <span class="comment">// If so, do not select the node as src node</span></span><br><span class="line">    <span class="keyword">if</span> ((nodesCorrupt != <span class="keyword">null</span>) &amp;&amp; nodesCorrupt.contains(node))</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// å¦‚æœpriorityæ˜¯æœ€é«˜ä¼˜å…ˆçº§ï¼Œåˆ™å¯ä»¥å¿½ç•¥æ˜¯å¦è¾¾åˆ°å¤åˆ¶çš„ä¸Šçº¿</span></span><br><span class="line">    <span class="keyword">if</span>(priority != UnderReplicatedBlocks.QUEUE_HIGHEST_PRIORITY</span><br><span class="line">        &amp;&amp; node.getNumberOfBlocksToBeReplicated() &gt;= maxReplicationStreams)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">continue</span>; <span class="comment">// already reached replication limit</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä½†æ˜¯å¦‚æœå½“å‰nodeçš„å¤åˆ¶ä¸ªæ•°è¶…è¿‡äº†replicationStreamsHardLimitï¼Œä¸ç®¡ä»€ä¹ˆä¼˜å…ˆçº§éƒ½è·³è¿‡</span></span><br><span class="line">    <span class="keyword">if</span> (node.getNumberOfBlocksToBeReplicated() &gt;= replicationStreamsHardLimit)</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// the block must not be scheduled for removal on srcNode</span></span><br><span class="line">    <span class="keyword">if</span>(excessBlocks != <span class="keyword">null</span> &amp;&amp; excessBlocks.contains(block))</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// never use already decommissioned nodes</span></span><br><span class="line">    <span class="keyword">if</span>(node.isDecommissioned())</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// we prefer nodes that are in DECOMMISSION_INPROGRESS state</span></span><br><span class="line">    <span class="comment">// ä¼˜å…ˆé€‰æ‹©æ­£åœ¨ä¸‹çº¿çš„dn</span></span><br><span class="line">    <span class="keyword">if</span>(node.isDecommissionInProgress() || srcNode == <span class="keyword">null</span>) &#123;</span><br><span class="line">      srcNode = node;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span>(srcNode.isDecommissionInProgress())</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    <span class="comment">// switch to a different node randomly</span></span><br><span class="line">    <span class="comment">// this to prevent from deterministically selecting the same node even</span></span><br><span class="line">    <span class="comment">// if the node failed to replicate the block on previous iterations</span></span><br><span class="line">    <span class="comment">// æ²¡æœ‰æ­£åœ¨ä¸‹çº¿çš„ï¼Œåˆ™éšæœºé€‰ä¸€ä¸ª</span></span><br><span class="line">    <span class="keyword">if</span>(DFSUtil.getRandom().nextBoolean())</span><br><span class="line">      srcNode = node;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(numReplicas != <span class="keyword">null</span>)</span><br><span class="line">    numReplicas.initialize(live, decommissioned, corrupt, excess, <span class="number">0</span>);</span><br><span class="line">  <span class="keyword">return</span> srcNode;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chooseSourceDatanodeä¸­ä¸»è¦æ˜¯é€‰æ‹©srcNodeï¼Œé€‰å–è§„åˆ™ä¸Šé¢å·²ç»ä»‹ç»ï¼Œè¿™é‡Œä»‹ç»ä¸¤ä¸ª<em>é™åˆ¶å€¼</em>ï¼š</p><ol><li>maxReplicationStreamsï¼šä¸€ä¸ªç»™å®šèŠ‚ç‚¹<em>é™¤æœ€é«˜ä¼˜å…ˆçº§å¤åˆ¶å¤–å¤åˆ¶æµçš„æœ€å¤§æ•°ç›®</em>ï¼Œå–å‚æ•°dfs.namenode.replication.max-streamsï¼Œå‚æ•°æœªé…ç½®é»˜è®¤ä¸º2ï¼›</li><li>replicationStreamsHardLimitï¼šä¸€ä¸ªç»™å®šèŠ‚ç‚¹<em>å…¨éƒ¨ä¼˜å…ˆçº§å¤åˆ¶å¤åˆ¶æµçš„æœ€å¤§æ•°ç›®</em>ï¼Œå–å‚æ•°dfs.namenode.replication.max-streams-hard-limitï¼Œå‚æ•°æœªé…ç½®é»˜è®¤ä¸º4ã€‚é’ˆå¯¹æ‰€æœ‰çš„ä¼˜å…ˆçº§ï¼Œç®—æ˜¯ä¸€ä¸ªç¡¬æ€§æŒ‡æ ‡å§ï¼Œæ‰€æœ‰ä¸ºhard limitå§ã€‚</li></ol><h3 id="ç¬¬äºŒä¸ªforå¾ªç¯"><a href="#ç¬¬äºŒä¸ªforå¾ªç¯" class="headerlink" title="ç¬¬äºŒä¸ªforå¾ªç¯"></a>ç¬¬äºŒä¸ªforå¾ªç¯</h3><p>ç¬¬äºŒä¸ªforå¾ªç¯æ˜¯è°ƒç”¨<code>ReplicationWork.chooseTargets</code>ä¸ºæ¯ä¸ªblocké€‰å–targetsï¼ŒchooseTargetsä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">chooseTargets</span><span class="params">(BlockPlacementPolicy blockplacement,</span></span></span><br><span class="line"><span class="params"><span class="function">    BlockStoragePolicySuite storagePolicySuite,</span></span></span><br><span class="line"><span class="params"><span class="function">    Set&lt;Node&gt; excludedNodes)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    targets = blockplacement.chooseTarget(bc.getName(),</span><br><span class="line">        additionalReplRequired, srcNode, liveReplicaStorages, <span class="keyword">false</span>,</span><br><span class="line">        excludedNodes, block.getNumBytes(),</span><br><span class="line">        storagePolicySuite.getPolicy(bc.getStoragePolicyID()));</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    srcNode.decrementPendingReplicationWithoutTargets();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ç„¶åè°ƒç”¨BlockPlacementPolicyçš„chooseTargetè¿›è¡Œé€‰å–ï¼Œè¿™é‡Œ<code>BlockPlacementPolicyDefault</code>å¯¹chooseTargetè¿›è¡Œäº†é‡å†™ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DatanodeStorageInfo[] chooseTarget(<span class="keyword">int</span> numOfReplicas,</span><br><span class="line">                                  Node writer,</span><br><span class="line">                                  List&lt;DatanodeStorageInfo&gt; chosenStorage,</span><br><span class="line">                                  <span class="keyword">boolean</span> returnChosenNodes,</span><br><span class="line">                                  Set&lt;Node&gt; excludedNodes,</span><br><span class="line">                                  <span class="keyword">long</span> blocksize,</span><br><span class="line">                                  <span class="keyword">final</span> BlockStoragePolicy storagePolicy) &#123;</span><br><span class="line">  ...</span><br><span class="line">   <span class="comment">// ç›¸åŒblockçš„å‰¯æœ¬åœ¨æ¯ä¸ªæœºæ¶ä¸Šæœ€å¤šçš„ä¸ªæ•°</span></span><br><span class="line">  <span class="keyword">int</span>[] result = getMaxNodesPerRack(chosenStorage.size(), numOfReplicas);</span><br><span class="line">  numOfReplicas = result[<span class="number">0</span>];</span><br><span class="line">  <span class="keyword">int</span> maxNodesPerRack = result[<span class="number">1</span>];</span><br><span class="line">  <span class="comment">// chosenStorageå‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹çš„listï¼Œè¿™é‡Œçš„å‰¯æœ¬åªåŒ…æ‹¬æ­£å¸¸çš„å’Œread only</span></span><br><span class="line">  <span class="comment">// resultsä¸º</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; results = <span class="keyword">new</span> ArrayList&lt;DatanodeStorageInfo&gt;(chosenStorage);</span><br><span class="line">  <span class="comment">// å°†å‰¯æœ¬æ‰€åœ¨çš„èŠ‚ç‚¹åŠ å…¥excludeNodesä¸­ï¼Œé¿å…å…¶é€‰ä¸ºtarget</span></span><br><span class="line">  <span class="keyword">for</span> (DatanodeStorageInfo storage : chosenStorage) &#123;</span><br><span class="line">    <span class="comment">// add localMachine and related nodes to excludedNodes</span></span><br><span class="line">    addToExcludedNodes(storage.getDatanodeDescriptor(), excludedNodes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">boolean</span> avoidStaleNodes = (stats != <span class="keyword">null</span></span><br><span class="line">      &amp;&amp; stats.isAvoidingStaleDataNodesForWrite());</span><br><span class="line">  <span class="comment">// æ ¹æ®éœ€è¦å¤åˆ¶çš„å‰¯æœ¬æ•°é€‰æ‹©targetsï¼Œå°†targetsæ”¾å…¥resultsä¸­ï¼Œè¿”å›srcNode</span></span><br><span class="line">  <span class="keyword">final</span> Node localNode = chooseTarget(numOfReplicas, writer, excludedNodes,</span><br><span class="line">      blocksize, maxNodesPerRack, results, avoidStaleNodes, storagePolicy,</span><br><span class="line">      EnumSet.noneOf(StorageType.class), results.isEmpty());</span><br><span class="line">  <span class="keyword">if</span> (!returnChosenNodes) &#123;  </span><br><span class="line">    results.removeAll(chosenStorage);</span><br><span class="line">  &#125;</span><br><span class="line">    </span><br><span class="line">  <span class="comment">// sorting nodes to form a pipeline</span></span><br><span class="line">  <span class="comment">// å¯¹targetsè¿›è¡Œæ’åºï¼Œå¾—åˆ°pipeline</span></span><br><span class="line">  <span class="keyword">return</span> getPipeline(</span><br><span class="line">      (writer != <span class="keyword">null</span> &amp;&amp; writer <span class="keyword">instanceof</span> DatanodeDescriptor) ? writer</span><br><span class="line">          : localNode,</span><br><span class="line">      results.toArray(<span class="keyword">new</span> DatanodeStorageInfo[results.size()]));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chooseTargetä¸­åˆè°ƒç”¨äº†ä¸€ä¸ªåŒåå‡½æ•°<em>chooseTarget</em>æ¥è¿›è¡Œtargetsé€‰å–ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">chooseTarget</span><span class="params">(<span class="keyword">int</span> numOfReplicas,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Node writer,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> Set&lt;Node&gt; excludedNodes,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">long</span> blocksize,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">int</span> maxNodesPerRack,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; results,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">boolean</span> avoidStaleNodes,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> BlockStoragePolicy storagePolicy,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> EnumSet&lt;StorageType&gt; unavailableStorages,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">boolean</span> newBlock)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numOfResults = results.size();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> totalReplicasExpected = numOfReplicas + numOfResults;</span><br><span class="line">  <span class="keyword">if</span> ((writer == <span class="keyword">null</span> || !(writer <span class="keyword">instanceof</span> DatanodeDescriptor)) &amp;&amp; !newBlock) &#123;</span><br><span class="line">    writer = results.get(<span class="number">0</span>).getDatanodeDescriptor();</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((numOfReplicas = requiredStorageTypes.size()) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughReplicasException(</span><br><span class="line">          <span class="string">&quot;All required storage types are unavailable: &quot;</span></span><br><span class="line">          + <span class="string">&quot; unavailableStorages=&quot;</span> + unavailableStorages</span><br><span class="line">          + <span class="string">&quot;, storagePolicy=&quot;</span> + storagePolicy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// munOfResultsä¸º0æ˜¯è¯´resultsä¸­æ²¡æœ‰æ•°æ®ï¼Œä¹Ÿå°±æ˜¯å½“å‰blockæ²¡æœ‰å‰¯æœ¬</span></span><br><span class="line">    <span class="keyword">if</span> (numOfResults == <span class="number">0</span>) &#123;</span><br><span class="line">      writer = chooseLocalStorage(writer, excludedNodes, blocksize,</span><br><span class="line">          maxNodesPerRack, results, avoidStaleNodes, storageTypes, <span class="keyword">true</span>)</span><br><span class="line">              .getDatanodeDescriptor();</span><br><span class="line">      <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»resultsä¸­å–å‡ºç¬¬ä¸€ä¸ªå‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹</span></span><br><span class="line">    <span class="keyword">final</span> DatanodeDescriptor dn0 = results.get(<span class="number">0</span>).getDatanodeDescriptor();</span><br><span class="line">    <span class="comment">// numOfResults&lt;=1åˆ™å½“å‰blockåªæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œåˆ™ä»åˆ«çš„æœºæ¶ä¸Šé€‰ä¸€ä¸ªèŠ‚ç‚¹æ”¾ç¬¬äºŒä¸ªå‰¯æœ¬</span></span><br><span class="line">    <span class="keyword">if</span> (numOfResults &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">      chooseRemoteRack(<span class="number">1</span>, dn0, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">          results, avoidStaleNodes, storageTypes);</span><br><span class="line">      <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// numOfResults&lt;=2åˆ™å½“å‰blockæœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œåˆ™è¦åˆ¤æ–­å½“å‰ä¸¤ä¸ªå‰¯æœ¬æ˜¯å¦åœ¨åŒä¸€æœºæ¶</span></span><br><span class="line">    <span class="keyword">if</span> (numOfResults &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="keyword">final</span> DatanodeDescriptor dn1 = results.get(<span class="number">1</span>).getDatanodeDescriptor();</span><br><span class="line">      <span class="keyword">if</span> (clusterMap.isOnSameRack(dn0, dn1)) &#123;</span><br><span class="line">      <span class="comment">// åœ¨åŒä¸€æœºæ¶åˆ™ä»åˆ«çš„æœºæ¶ä¸Šé€‰ä¸€ä¸ªèŠ‚ç‚¹å­˜æ”¾ç¬¬ä¸‰ä¸ªå‰¯æœ¬</span></span><br><span class="line">        chooseRemoteRack(<span class="number">1</span>, dn0, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">            results, avoidStaleNodes, storageTypes);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newBlock)&#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯æ–°blockåˆ™ä»dn1æ‰€åœ¨çš„æœºæ¶ä¸Šé€‰æ‹©ä¸€ä¸ªèŠ‚ç‚¹æ”¾ç¬¬ä¸‰ä¸ªå‰¯æœ¬</span></span><br><span class="line">      <span class="comment">// results.isEmptyåˆ™ä¸ºnewBlock</span></span><br><span class="line">        chooseLocalRack(dn1, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">            results, avoidStaleNodes, storageTypes);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// ä¸åœ¨åŒä¸€æœºæ¶åˆ™ä»writeræ‰€åœ¨æœºæ¶ä¸Šé€‰ä¸€ä¸ªèŠ‚ç‚¹æ”¾ç¬¬ä¸‰ä¸ªå‰¯æœ¬</span></span><br><span class="line">        chooseLocalRack(writer, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">            results, avoidStaleNodes, storageTypes);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¶…è¿‡3å‰¯æœ¬çš„è¯ï¼Œå‰©ä½™å‰¯æœ¬åˆ™éšæœºé€‰æ‹©</span></span><br><span class="line">    chooseRandom(numOfReplicas, NodeBase.ROOT, excludedNodes, blocksize,</span><br><span class="line">        maxNodesPerRack, results, avoidStaleNodes, storageTypes);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NotEnoughReplicasException e) &#123;</span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> writer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€‰å®Œtargetsä¹‹åï¼Œè¿˜è¦è°ƒç”¨<code>getPipeline</code>å¯¹targetsè¿›è¡Œæ’åºï¼Œæ’åºé—®é¢˜æ˜¯ä¸ªæ—…è¡Œå®¶é—®é¢˜ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> DatanodeStorageInfo[] getPipeline(Node writer,</span><br><span class="line">    DatanodeStorageInfo[] storages) &#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">synchronized</span>(clusterMap) &#123;</span><br><span class="line">    <span class="keyword">int</span> index=<span class="number">0</span>;</span><br><span class="line">    <span class="keyword">if</span> (writer == <span class="keyword">null</span> || !clusterMap.contains(writer)) &#123;</span><br><span class="line">      writer = storages[<span class="number">0</span>].getDatanodeDescriptor();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span>(; index &lt; storages.length; index++) &#123;</span><br><span class="line">      DatanodeStorageInfo shortestStorage = storages[index];</span><br><span class="line">      <span class="keyword">int</span> shortestDistance = clusterMap.getDistance(writer,</span><br><span class="line">          shortestStorage.getDatanodeDescriptor());</span><br><span class="line">      <span class="keyword">int</span> shortestIndex = index;</span><br><span class="line">      <span class="keyword">for</span>(<span class="keyword">int</span> i = index + <span class="number">1</span>; i &lt; storages.length; i++) &#123;</span><br><span class="line">        <span class="keyword">int</span> currentDistance = clusterMap.getDistance(writer,</span><br><span class="line">            storages[i].getDatanodeDescriptor());</span><br><span class="line">        <span class="keyword">if</span> (shortestDistance&gt;currentDistance) &#123;</span><br><span class="line">          shortestDistance = currentDistance;</span><br><span class="line">          shortestStorage = storages[i];</span><br><span class="line">          shortestIndex = i;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">//switch position index &amp; shortestIndex</span></span><br><span class="line">      <span class="keyword">if</span> (index != shortestIndex) &#123;</span><br><span class="line">        storages[shortestIndex] = storages[index];</span><br><span class="line">        storages[index] = shortestStorage;</span><br><span class="line">      &#125;</span><br><span class="line">      writer = shortestStorage.getDatanodeDescriptor();</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> storages;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="ç¬¬ä¸‰ä¸ªforå¾ªç¯"><a href="#ç¬¬ä¸‰ä¸ªforå¾ªç¯" class="headerlink" title="ç¬¬ä¸‰ä¸ªforå¾ªç¯"></a>ç¬¬ä¸‰ä¸ªforå¾ªç¯</h3><p>ç¬¬ä¸‰ä¸ªforå¾ªç¯åªæ˜¯è°ƒç”¨<code>pendingReplications.increment(block, DatanodeStorageInfo.toDatanodeDescriptors(targets))</code>ï¼Œå°†blockæ”¾å…¥<code>PendingReplicationBlocks.pendingReplications</code>ä¸­</p><blockquote><p>pendingReplications åœ¨å“ªè¢«æ¶ˆè´¹   PendingReplicationBlocksçº¿ç¨‹ä¸­ï¼Ÿï¼Ÿï¼Ÿ</p></blockquote><h2 id="åˆ é™¤"><a href="#åˆ é™¤" class="headerlink" title="åˆ é™¤"></a>åˆ é™¤</h2><p>å›åˆ°<em>computeDatanodeWork</em>ä¸­ï¼Œå¤åˆ¶ç»“æŸä¹‹åï¼Œå¯¹<em>pendingReplicationBlocksCount</em>ã€<em>underReplicatedBlocksCount</em>ã€<em>corruptReplicaBlocksCount</em>å’Œ<em>scheduledReplicationBlocksCount</em>è¿›è¡ŒçŠ¶æ€æ›´æ–°ä¹‹åï¼Œå°±å¼€å§‹è¿›è¡Œè®¡ç®—åˆ é™¤å·¥ä½œ<code>computeInvalidateWork</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">computeInvalidateWork</span><span class="params">(<span class="keyword">int</span> nodesToProcess)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// å¾—åˆ°å«æœ‰æ— æ•ˆblockçš„dn</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;DatanodeInfo&gt; nodes = invalidateBlocks.getDatanodes();</span><br><span class="line">  Collections.shuffle(nodes);</span><br><span class="line">  nodesToProcess = Math.min(nodes.size(), nodesToProcess);</span><br><span class="line">  <span class="keyword">int</span> blockCnt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">for</span> (DatanodeInfo dnInfo : nodes) &#123;</span><br><span class="line">  <span class="comment">// åˆ é™¤dnä¸Šçš„æ— æ•ˆblock</span></span><br><span class="line">    <span class="keyword">int</span> blocks = invalidateWorkForOneNode(dnInfo);</span><br><span class="line">    <span class="keyword">if</span> (blocks &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      blockCnt += blocks;</span><br><span class="line">      <span class="keyword">if</span> (--nodesToProcess == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> blockCnt;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>computeInvalidateWorkä¼ è¿›å»çš„å‚æ•°æ˜¯èŠ‚ç‚¹çš„ä¸ªæ•°ï¼Œè€Œä¸æ˜¯è¦åˆ é™¤blockçš„ä¸ªæ•°ï¼Œå¹¶ä¸”åˆ é™¤blockæ—¶æ²¡æœ‰ä¼˜å…ˆçº§ï¼Œåˆ™ç›´æ¥ä»<em>invalidateBlocks</em>ä¸­æ‹¿åˆ°æ‰€æœ‰å«æœ‰æ— æ•ˆblockçš„dnï¼Œè¿›è¡Œforå¾ªç¯åˆ¤æ–­nodesToProcessæ˜¯å¦æ»¡è¶³ï¼Œç”±blockCntç»Ÿè®¡åˆ é™¤çš„å·¥ä½œé‡ã€‚</p><p>å…·ä½“çš„åˆ é™¤å·¥ä½œåœ¨<code>invalidateWorkForOneNode</code>ä¸­å®Œæˆã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">invalidateWorkForOneNode</span><span class="params">(DatanodeInfo dn)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> List&lt;Block&gt; toInvalidate;</span><br><span class="line">  namesystem.writeLock();</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// blocks should not be replicated or removed if safe mode is on</span></span><br><span class="line">    <span class="keyword">if</span> (namesystem.isInSafeMode()) &#123;</span><br><span class="line">      LOG.debug(<span class="string">&quot;In safemode, not computing replication work&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// ä»InvalidateBlocks.node2blocksä¸­æ‹¿åˆ°dnå¯¹åº”çš„blockå‰¯æœ¬</span></span><br><span class="line">      toInvalidate = invalidateBlocks.invalidateWork(datanodeManager.getDatanode(dn));</span><br><span class="line">      </span><br><span class="line">      <span class="keyword">if</span> (toInvalidate == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span>(UnregisteredNodeException une) &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    namesystem.writeUnlock();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (NameNode.stateChangeLog.isInfoEnabled()) &#123;</span><br><span class="line">    NameNode.stateChangeLog.info(<span class="string">&quot;BLOCK* &quot;</span> + getClass().getSimpleName()</span><br><span class="line">        + <span class="string">&quot;: ask &quot;</span> + dn + <span class="string">&quot; to delete &quot;</span> + toInvalidate);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> toInvalidate.size();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>invalidateWorkä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// InvalidateBlocks.class</span></span><br><span class="line"><span class="function"><span class="keyword">synchronized</span> List&lt;Block&gt; <span class="title">invalidateWork</span><span class="params">(<span class="keyword">final</span> DatanodeDescriptor dn)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">long</span> delay = getInvalidationDelay();</span><br><span class="line">  <span class="keyword">if</span> (delay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (BlockManager.LOG.isDebugEnabled()) &#123;</span><br><span class="line">      BlockManager.LOG</span><br><span class="line">          .debug(<span class="string">&quot;Block deletion is delayed during NameNode startup. &quot;</span></span><br><span class="line">                     + <span class="string">&quot;The deletion will start after &quot;</span> + delay + <span class="string">&quot; ms.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> LightWeightHashSet&lt;Block&gt; set = node2blocks.get(dn);</span><br><span class="line">  <span class="keyword">if</span> (set == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// # blocks that can be sent in one message is limited</span></span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> limit = blockInvalidateLimit;</span><br><span class="line">  <span class="keyword">final</span> List&lt;Block&gt; toInvalidate = set.pollN(limit);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// If we send everything in this message, remove this node entry</span></span><br><span class="line">  <span class="keyword">if</span> (set.isEmpty()) &#123;</span><br><span class="line">    remove(dn);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†è¦åˆ é™¤çš„blockæ”¾å…¥dnä¸­</span></span><br><span class="line">  dn.addBlocksToBeInvalidated(toInvalidate);</span><br><span class="line">  numBlocks -= toInvalidate.size();</span><br><span class="line">  <span class="keyword">return</span> toInvalidate;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åˆ é™¤åº”è¯¥æ˜¯åœ¨dnä¸Šè¢«åˆ é™¤ï¼Œé€šè¿‡<code>dn.addBlocksToBeInvalidated</code>å°†å‰¯æœ¬æ”¾å…¥DatanodeDescriptor.invalidateBlocksä¸­ã€‚</p><p>è¿˜æ˜¯æ²¡æœ‰æ‰¾åˆ°å…·ä½“çš„åˆ é™¤æ“ä½œï¼Œå¤åˆ¶æ˜¯ç­‰å¾…è°ƒåº¦ï¼Œåˆ é™¤å‘¢ï¼Ÿåªè¿”å›è¦åˆ é™¤çš„blockä¸ªæ•°ï¼Ÿå…·ä½“çš„åˆ é™¤æ“ä½œåº”è¯¥åœ¨dnä¸Šï¼Œä»£ç è¿˜æ²¡æœ‰å»è·Ÿè¸ªï¼Œæœ‰æ—¶é—´å†è·Ÿè¸ªéªŒè¯æƒ³æ³•</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> ReplicationMonitor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFS HAæœºåˆ¶è§£æ</title>
      <link href="/HDFS%20HA%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90.html"/>
      <url>/HDFS%20HA%E6%9C%BA%E5%88%B6%E8%A7%A3%E6%9E%90.html</url>
      
        <content type="html"><![CDATA[<h2 id="HAæ•´ä½“æ¶æ„"><a href="#HAæ•´ä½“æ¶æ„" class="headerlink" title="HAæ•´ä½“æ¶æ„"></a>HAæ•´ä½“æ¶æ„</h2><p>![HAæ•´ä½“æ¶æ„å›¾](/blogimgs/HDFS HAæœºåˆ¶è§£æ/haæ¶æ„å›¾.png â€œHAæ•´ä½“æ¶æ„å›¾â€)</p><p>ä»ä¸Šå›¾ä¸­ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹å‡ºNameNodeçš„é«˜å¯ç”¨æ¶æ„ä¸»è¦åˆ†ä¸ºä¸‹é¢å‡ ä¸ªéƒ¨åˆ†ï¼š</p><p>Active NameNodeå’ŒStandby NameNodeï¼šä¸¤å°NameNodeå½¢æˆäº’å¤‡ï¼Œä¸€å°å¤„äºActiveçŠ¶æ€ï¼Œä¸ºä¸»NameNodeï¼Œå¦å¤–ä¸€å°å¤„äºStandbyçŠ¶æ€ï¼Œä¸ºå¤‡NameNodeï¼Œ<strong>åªæœ‰ä¸»NameNodeæ‰èƒ½å¯¹å¤–æä¾›è¯»å†™æœåŠ¡</strong>ã€‚</p><p>ä¸»å¤‡åˆ‡æ¢æ§åˆ¶å™¨ZKFailoverControllerï¼šZKFailoverControllerä½œä¸ºç‹¬ç«‹çš„è¿›ç¨‹è¿è¡Œï¼Œå¯¹NameNodeçš„ä¸»å¤‡åˆ‡æ¢è¿›è¡Œæ€»ä½“æ§åˆ¶ï¼ˆZKFailoverControlleræ˜¯æŠ½è±¡ç±»ï¼Œå®ƒçš„å®ç°ç±»æ˜¯DFSZKFailoverControllerï¼‰ã€‚ZKFailoverControlleré€šè¿‡HealthMonitorçº¿ç¨‹èƒ½åŠæ—¶æ£€æµ‹åˆ°NameNodeçš„å¥åº·çŠ¶å†µï¼Œåœ¨ä¸»NameNodeæ•…éšœæ—¶å€ŸåŠ©Zookeeperå®ç°è‡ªåŠ¨çš„ä¸»å¤‡é€‰ä¸¾å’Œåˆ‡æ¢ï¼Œå½“ç„¶NameNodeç›®å‰ä¹Ÿæ”¯æŒä¸ä¾èµ–äºZookeeperçš„æ‰‹åŠ¨ä¸»å¤‡åˆ‡æ¢ã€‚</p><blockquote><p>ä¸ºå•¥æŠŠç›‘æ§åˆ†å¼€<br>   æ˜¾ç„¶ï¼Œæˆ‘ä»¬ä¸èƒ½åœ¨NNè¿›ç¨‹å†…è¿›è¡Œå¿ƒè·³ç­‰ä¿¡æ¯åŒæ­¥ï¼Œæœ€ç®€å•çš„åŸå› ï¼Œä¸€æ¬¡FullGCå°±å¯ä»¥è®©NNæŒ‚èµ·åå‡ åˆ†é’Ÿï¼Œæ‰€ä»¥ï¼Œå¿…é¡»è¦æœ‰ä¸€ä¸ªç‹¬ç«‹çš„çŸ­å°ç²¾æ‚çš„watchdogæ¥ä¸“é—¨è´Ÿè´£ç›‘æ§ã€‚è¿™ä¹Ÿæ˜¯ä¸€ä¸ªæ¾è€¦åˆçš„è®¾è®¡ï¼Œä¾¿äºæ‰©å±•æˆ–æ›´æ”¹ã€‚</p></blockquote><p>Zookeeperé›†ç¾¤ï¼šä¸ºä¸»å¤‡åˆ‡æ¢æ§åˆ¶å™¨æä¾›ä¸»å¤‡é€‰ä¸¾æ”¯æŒã€‚</p><p>å…±äº«å­˜å‚¨ç³»ç»Ÿï¼šå…±äº«å­˜å‚¨ç³»ç»Ÿæ˜¯å®ç°NameNodeçš„é«˜å¯ç”¨æœ€ä¸ºå…³é”®çš„éƒ¨åˆ†ï¼Œå…±äº«å­˜å‚¨ç³»ç»Ÿä¿å­˜äº†NameNodeåœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ‰€äº§ç”Ÿçš„HDFSçš„å…ƒæ•°æ®ã€‚åªæœ‰active namenodeæ‰èƒ½å¾€å…±äº«å­˜å‚¨ç³»ç»Ÿä¸­å†™æ•°æ®ï¼Œactive NameNodeå’Œstandby NameNodeé€šè¿‡å…±äº«å­˜å‚¨ç³»ç»Ÿå®ç°å…ƒæ•°æ®åŒæ­¥ã€‚åœ¨è¿›è¡Œä¸»å¤‡åˆ‡æ¢çš„æ—¶å€™ï¼Œæ–°çš„ä¸»NameNodeåœ¨ç¡®è®¤å…ƒæ•°æ®å®Œå…¨åŒæ­¥ä¹‹åæ‰èƒ½ç»§ç»­å¯¹å¤–æä¾›æœåŠ¡ã€‚</p><p>DataNodeèŠ‚ç‚¹ï¼šé™¤äº†é€šè¿‡å…±äº«å­˜å‚¨ç³»ç»Ÿå…±äº«HDFSçš„å…ƒæ•°æ®ä¿¡æ¯ä¹‹å¤–ï¼Œ<strong>ä¸»NameNodeå’Œå¤‡NameNodeè¿˜éœ€è¦å…±äº«HDFSçš„æ•°æ®å—å’ŒDataNodeä¹‹é—´çš„æ˜ å°„å…³ç³»</strong>ã€‚_DataNodeä¼šåŒæ—¶å‘ä¸»NameNodeå’Œå¤‡NameNodeä¸ŠæŠ¥æ•°æ®å—çš„ä½ç½®ä¿¡æ¯ï¼Œä½†åªæ¥æ”¶æ¥è‡ªactive namenodeçš„è¯»å†™å‘½ä»¤_ã€‚</p><span id="more"></span><p>è¿™é‡Œä¸»è¦ä»‹ç»é€šè¿‡__éš”ç¦»å’ŒQuorum Journal Manager(QJM)å…±äº«å­˜å‚¨ç©ºé—´__å®ç°HDFS HAã€‚</p><h2 id="éš”ç¦»ï¼ˆFencingï¼‰"><a href="#éš”ç¦»ï¼ˆFencingï¼‰" class="headerlink" title="éš”ç¦»ï¼ˆFencingï¼‰"></a>éš”ç¦»ï¼ˆFencingï¼‰</h2><p><strong>éš”ç¦»(Fencing)æ˜¯ä¸ºäº†é˜²æ­¢è„‘è£‚ï¼Œå°±æ˜¯ä¿è¯åœ¨ä»»ä½•æ—¶å€™HDFSåªæœ‰ä¸€ä¸ªActive NN</strong>ï¼Œä¸»è¦åŒ…æ‹¬ä¸‰ä¸ªæ–¹é¢ï¼š</p><ul><li>å…±äº«å­˜å‚¨fencingï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªNNå¯ä»¥å†™å…¥editsã€‚QJMä¸­æ¯ä¸€ä¸ªJournalNodeä¸­å‡æœ‰ä¸€ä¸ªepochnumberï¼ŒåŒ¹é…epochnumberçš„QJMæ‰æœ‰æƒé™æ›´æ–°JNã€‚å½“NNç”±standbyçŠ¶æ€åˆ‡æ¢æˆactiveçŠ¶æ€æ—¶ï¼Œä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ªepoch numberï¼Œå¹¶æ›´æ–°JNä¸­çš„epochnumberï¼Œä»¥è‡³äºä»¥å‰çš„ActiveNNä¸­çš„QJMä¸­çš„epoch numberå’ŒJNçš„epochnumberä¸åŒ¹é…ï¼Œæ•…è€ŒåŸActiveNNä¸Šçš„QJMæ²¡æ³•å¾€JNä¸­å†™å…¥æ•°æ®ï¼ˆåé¢ä¼šä»‹ç»æºç ï¼‰ï¼Œå³å½¢æˆäº†fencing</li><li>å®¢æˆ·ç«¯fencingï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªNNå¯ä»¥å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ã€‚</li><li>DataNode fencingï¼šç¡®ä¿åªæœ‰ä¸€ä¸ªNNå¯ä»¥å‘DNä¸‹å‘å‘½ä»¤ï¼Œè­¬å¦‚åˆ é™¤å—ï¼Œå¤åˆ¶å—ï¼Œç­‰ç­‰ã€‚</li></ul><p>QJMçš„Fencingæ–¹æ¡ˆåªèƒ½è®©åŸæ¥çš„Active NNå¤±å»å¯¹JNçš„å†™æƒé™ï¼Œä½†æ˜¯åŸæ¥çš„Active NNè¿˜æ˜¯å¯ä»¥å“åº”å®¢æˆ·ç«¯çš„è¯·æ±‚ï¼Œå¯¹DNè¿›è¡Œè¯»ã€‚å¯¹å®¢æˆ·ç«¯å’ŒDataNodeçš„fenceæ˜¯é€šè¿‡é…ç½®dfs.ha.fencing.methodså®ç°çš„ã€‚Hadoopå…¬å…±åº“ä¸­æœ‰ä¸¤ç§Fencingå®ç°ï¼šsshfenceã€shell<br>   sshfenceï¼šsshåˆ°åŸActive NNä¸Šï¼Œä½¿ç”¨fuserç»“æŸè¿›ç¨‹ï¼ˆé€šè¿‡tcpç«¯å£å·å®šä½è¿›ç¨‹pidï¼Œè¯¥æ–¹æ³•æ¯”jpså‘½ä»¤æ›´å‡†ç¡®ï¼‰ã€‚<br>   shell: run an arbitrary shell command to fence the Active NameNodeï¼Œå³æ‰§è¡Œä¸€ä¸ªç”¨æˆ·äº‹å…ˆå®šä¹‰çš„shellå‘½ä»¤ï¼ˆè„šæœ¬ï¼‰å®Œæˆéš”ç¦»ã€‚</p><h2 id="QJMå…±äº«å­˜å‚¨"><a href="#QJMå…±äº«å­˜å‚¨" class="headerlink" title="QJMå…±äº«å­˜å‚¨"></a>QJMå…±äº«å­˜å‚¨</h2><p>Qurom Journal Manager(QJM)æ˜¯ä¸€ä¸ªåŸºäºPaxosç®—æ³•å®ç°çš„HDFS å…ƒæ•°æ®å…±äº«å­˜å‚¨çš„æ–¹æ¡ˆã€‚QJMçš„åŸºæœ¬åŸç†å°±æ˜¯ç”¨2N+1å°JournalNodeå­˜å‚¨EditLogï¼Œæ¯æ¬¡å†™æ•°æ®æ“ä½œæœ‰å¤§å¤šæ•°ï¼ˆ&gt;=N+1ï¼‰è¿”å›æˆåŠŸæ—¶å³è®¤ä¸ºè¯¥æ¬¡å†™æˆåŠŸï¼Œæ•°æ®ä¸ä¼šä¸¢å¤±ã€‚è¿™ä¸ªç®—æ³•æ‰€èƒ½å®¹å¿çš„æ˜¯æœ€å¤šæœ‰Nå°æœºå™¨æŒ‚æ‰ï¼Œå¦‚æœå¤šäºNå°æŒ‚æ‰ï¼Œè¿™ä¸ªç®—æ³•å°±å¤±æ•ˆäº†ã€‚è¿™ä¸ªåŸç†æ˜¯åŸºäºPaxosç®—æ³•çš„ã€‚<br>ç”¨QJMçš„æ–¹å¼æ¥å®ç°HAçš„ä¸»è¦å¥½å¤„æœ‰ï¼š1ï¼‰ä¸éœ€è¦é…ç½®é¢å¤–çš„é«˜å…±äº«å­˜å‚¨ï¼Œè¿™æ ·å¯¹äºåŸºäºcommodity hardwareçš„äº‘è®¡ç®—æ•°æ®ä¸­å¿ƒæ¥è¯´ï¼Œé™ä½äº†å¤æ‚åº¦å’Œç»´æŠ¤æˆæœ¬ï¼›2ï¼‰ä¸åœ¨éœ€è¦å•ç‹¬é…ç½®fencingå®ç°ï¼Œå› ä¸ºQJMæœ¬èº«å†…ç½®äº†fencingçš„åŠŸèƒ½ï¼›3ï¼‰ä¸å­˜åœ¨Single Point Of Failureï¼›4ï¼‰ç³»ç»Ÿé²æ£’æ€§çš„ç¨‹åº¦æ˜¯å¯é…ç½®çš„ï¼ˆQJMåŸºäºPaxosç®—æ³•ï¼Œæ‰€ä»¥å¦‚æœé…ç½®2N+1å°JournalNodeç»„æˆçš„é›†ç¾¤ï¼Œèƒ½å®¹å¿æœ€å¤šNå°æœºå™¨æŒ‚æ‰ï¼‰ï¼›5ï¼‰QJMä¸­å­˜å‚¨æ—¥å¿—çš„JournalNodeä¸ä¼šå› ä¸ºå…¶ä¸­ä¸€å°çš„å»¶è¿Ÿè€Œå½±å“æ•´ä½“çš„å»¶è¿Ÿï¼Œè€Œä¸”ä¹Ÿä¸ä¼šå› ä¸ºJournalNodeçš„æ•°é‡å¢å¤šè€Œå½±å“æ€§èƒ½ï¼ˆå› ä¸ºNNå‘JournalNodeå‘é€æ—¥å¿—æ˜¯å¹¶è¡Œçš„ï¼‰ã€‚</p><h2 id="æºç åˆ†æä¸»å¤‡åˆ‡æ¢"><a href="#æºç åˆ†æä¸»å¤‡åˆ‡æ¢" class="headerlink" title="æºç åˆ†æä¸»å¤‡åˆ‡æ¢"></a>æºç åˆ†æä¸»å¤‡åˆ‡æ¢</h2><p>ä¸»å¤‡åˆ‡æ¢ä¸»è¦æ˜¯é€šè¿‡<code>ZKFailoverController</code>å®ç°çš„ï¼Œæ˜¯ä¸€ä¸ªç‹¬ç«‹çš„è¿›ç¨‹ï¼Œåœ¨hdfså¯åŠ¨è„šæœ¬ä¹‹ä¸­çš„è¿›ç¨‹åä¸º_zkfc_ã€‚<code>ZKFailoverController</code>æ˜¯ä¸€ä¸ªæŠ½è±¡ç±»ï¼Œå…¶å®ç°ç±»çš„<code>DFSZKFailoverController</code>ï¼Œå…¶å†…éƒ¨æœ‰ä¸‰ä¸ªç»„ä»¶ï¼Œåˆ†åˆ«ä¸º_HealthMonitorã€ActiveStandbyElectorå’ŒFailoverController_ã€‚å…¶ä¸­HealthMonitoræ˜¯ä¸€ä¸ªç‹¬ç«‹çš„çº¿ç¨‹ï¼Œå¾ªç¯çš„æ£€æµ‹nnçš„çŠ¶æ€ï¼ŒActiveStandbyElectorä¸»è¦ç”¨æ¥ä¸zkä¿æŒå¿ƒè·³å’Œé€šè¿‡åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹è¿›è¡ŒèŠ‚ç‚¹çš„é€‰ä¸¾ï¼ŒFailoverControlleræ˜¯è¿›è¡ŒçŠ¶æ€è½¬æ¢ã€‚</p><p>zkfcçš„ç¨‹åºå…¥å£åœ¨<code>DFSZKFailoverController</code>ä¸­çš„mainæ–¹æ³•ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  DFSZKFailoverController zkfc = DFSZKFailoverController.create(</span><br><span class="line">      parser.getConfiguration());</span><br><span class="line">  </span><br><span class="line">  System.exit(zkfc.run(parser.getRemainingArgs()));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>DFSZKFailoverController</code>é€šè¿‡createåˆ›å»ºä¸€ä¸ªå®ä¾‹ï¼Œç„¶åè°ƒç”¨runæ–¹æ³•å¯åŠ¨zkfcã€‚createæ–¹æ³•é‡Œæ„é€ äº†ä¸€ä¸ªNNHAServiceTargetå¯¹è±¡ï¼Œå¹¶ç”±æ­¤æ„å»ºDFSZKFailoverControllerå¯¹è±¡ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> DFSZKFailoverController <span class="title">create</span><span class="params">(Configuration conf)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  NNHAServiceTarget localTarget = <span class="keyword">new</span> NNHAServiceTarget(</span><br><span class="line">      localNNConf, nsId, nnId);</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> DFSZKFailoverController(localNNConf, localTarget);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>NNHAServiceTargetä¸»è¦æ˜¯ç”¨æ¥å­˜æ”¾ç›®æ ‡nnçš„fenceç›¸å…³çš„å±æ€§ï¼Œæºç å¯¹ç±»çš„è§£é‡Šæ˜¯_One of the NN NameNodes acting as the target of an administrative command(e.g. failover) ,è¯‘ï¼šNNsä¸­çš„ä¸€ä¸ªnnä½œä¸ºç®¡ç†å‘½ä»¤çš„ç›®æ ‡_ã€‚åœ¨å…¶æ„é€ æ–¹æ³•ä¸­å¯¹nsIdã€nnIdã€addrã€zkfc addrå’Œfencerè¿›è¡Œèµ‹å€¼ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">NNHAServiceTarget</span><span class="params">(Configuration conf,</span></span></span><br><span class="line"><span class="params"><span class="function">    String nsId, String nnId)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">this</span>.addr = NetUtils.createSocketAddr(serviceAddr,</span><br><span class="line">      NameNode.DEFAULT_PORT);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">this</span>.autoFailoverEnabled = targetConf.getBoolean(</span><br><span class="line">      DFSConfigKeys.DFS_HA_AUTO_FAILOVER_ENABLED_KEY,</span><br><span class="line">      DFSConfigKeys.DFS_HA_AUTO_FAILOVER_ENABLED_DEFAULT);</span><br><span class="line">  <span class="keyword">if</span> (autoFailoverEnabled) &#123;</span><br><span class="line">    <span class="keyword">int</span> port = DFSZKFailoverController.getZkfcPort(targetConf);</span><br><span class="line">    <span class="keyword">if</span> (port != <span class="number">0</span>) &#123;</span><br><span class="line">      setZkfcPort(port);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.fencer = NodeFencer.create(targetConf,</span><br><span class="line">        DFSConfigKeys.DFS_HA_FENCE_METHODS_KEY);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (BadFencingConfigurationException e) &#123;</span><br><span class="line">    <span class="keyword">this</span>.fenceConfigError = e;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">this</span>.nnId = nnId;</span><br><span class="line">  <span class="keyword">this</span>.nsId = nsId;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>DFSZKFailoverControllerçš„å¯¹è±¡zkfcåˆ›å»ºæˆåŠŸä¹‹åï¼Œä¼šæ‰§è¡Œrunæ–¹æ³•ï¼Œrunæ–¹æ³•æ˜¯åœ¨<code>ZKFailoverController</code>ä¸­å®ç°çš„ï¼Œ_è€Œrunä¸­åˆè°ƒç”¨äº†doRunæ–¹æ³•_ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">doRun</span><span class="params">(String[] args)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> HadoopIllegalArgumentException, IOException, InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    initZK(); <span class="comment">// new ActiveStandbyElectorï¼Œä¸zkå»ºç«‹è¿æ¥</span></span><br><span class="line">  &#125; <span class="keyword">catch</span> (KeeperException ke) &#123;</span><br><span class="line">    ...</span><br><span class="line">    <span class="keyword">return</span> ERR_CODE_NO_ZK;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// åœ¨å¯åŠ¨zkfcä¹‹å‰ï¼Œè¦å…ˆå¯¹zkè¿›è¡Œæ ¼å¼åŒ–</span></span><br><span class="line">  <span class="comment">// æ ¼å¼åŒ–æ—¶è¾“å…¥å‚æ•°ï¼Œå¯åŠ¨æ—¶ä¸åŠ å‚æ•°</span></span><br><span class="line">  <span class="keyword">if</span> (args.length &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="string">&quot;-formatZK&quot;</span>.equals(args[<span class="number">0</span>])) &#123;</span><br><span class="line">      <span class="keyword">boolean</span> force = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">boolean</span> interactive = <span class="keyword">true</span>;</span><br><span class="line">      <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">1</span>; i &lt; args.length; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (<span class="string">&quot;-force&quot;</span>.equals(args[i])) &#123;</span><br><span class="line">          force = <span class="keyword">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="string">&quot;-nonInteractive&quot;</span>.equals(args[i])) &#123;</span><br><span class="line">          interactive = <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          badArg(args[i]);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// å¯¹zkæ ¼å¼åŒ–ï¼Œé»˜è®¤ä¼šzkä¸Šåˆ›å»º/hadoop-haèŠ‚ç‚¹</span></span><br><span class="line">      <span class="keyword">return</span> formatZK(force, interactive);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      badArg(args[<span class="number">0</span>]);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  initRPC(); <span class="comment">// åˆå§‹åŒ–rpcServerï¼Œåˆ›å»ºZKFCRpcServerå¯¹è±¡ï¼Œä½¿ç”¨çš„æ˜¯hadoop rpcæ¥å£å’ŒPBåºåˆ—åŒ–</span></span><br><span class="line">  initHM();  <span class="comment">// å¯åŠ¨HealthMonitorçº¿ç¨‹</span></span><br><span class="line">  startRPC(); <span class="comment">// å¯åŠ¨rpcServer</span></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    mainLoop(); <span class="comment">// å¾ªç¯é˜»å¡ç­‰å¾…fatalErroré”™è¯¯ï¼Œç„¶åé€€å‡ºzkfcè¿›ç¨‹</span></span><br><span class="line">  &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    rpcServer.stopAndJoin();</span><br><span class="line">    elector.quitElection(<span class="keyword">true</span>); <span class="comment">// å…³é—­zkè¿æ¥ï¼Œé€€å‡ºé€‰ä¸¾</span></span><br><span class="line">    healthMonitor.shutdown();</span><br><span class="line">    healthMonitor.join();</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆè°ƒç”¨<code>initZK()</code>ï¼Œä¸zkå»ºç«‹è¿æ¥ï¼Œä¸zkçš„è¿æ¥æ˜¯åœ¨<code>ActiveStandbyElector</code>ç±»ä¸­ï¼Œ<code>ActiveStandbyElector</code>åœ¨æ„é€ å‡½æ•°ä¸­æ³¨å†Œäº†ä¸€ä¸ªå›è°ƒå‡½æ•°<code>ElectorCallbacks</code>ï¼Œè€Œ<code>ActiveStandbyElector</code>åˆå®ç°äº†<code>StatCallback</code>å’Œ<code>StringCallback</code>ï¼Œåˆ†åˆ«åœ¨è°ƒç”¨<code>zkClient.exists</code>å’Œ<code>zkClient.create</code>ä¹‹åé€šè¿‡<code>processResult</code>å¯¹å…¶è°ƒç”¨ç»“æœçŠ¶æ€è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initZK</span><span class="params">()</span> <span class="keyword">throws</span> HadoopIllegalArgumentException, IOException,</span></span><br><span class="line"><span class="function">    KeeperException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  elector = <span class="keyword">new</span> ActiveStandbyElector(zkQuorum,</span><br><span class="line">      zkTimeout, getParentZnode(), zkAcls, zkAuths,</span><br><span class="line">      <span class="keyword">new</span> ElectorCallbacks(), maxRetryNum);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">ActiveStandbyElector</span><span class="params">(String zookeeperHostPorts,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> zookeeperSessionTimeout, String parentZnodeName, List&lt;ACL&gt; acl,</span></span></span><br><span class="line"><span class="params"><span class="function">    List&lt;ZKAuthInfo&gt; authInfo,</span></span></span><br><span class="line"><span class="params"><span class="function">    ActiveStandbyElectorCallback app, <span class="keyword">int</span> maxRetryNum)</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">    HadoopIllegalArgumentException, KeeperException </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (app == <span class="keyword">null</span> || acl == <span class="keyword">null</span> || parentZnodeName == <span class="keyword">null</span></span><br><span class="line">      || zookeeperHostPorts == <span class="keyword">null</span> || zookeeperSessionTimeout &lt;= <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HadoopIllegalArgumentException(<span class="string">&quot;Invalid argument&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  zkHostPort = zookeeperHostPorts;</span><br><span class="line">  zkSessionTimeout = zookeeperSessionTimeout;</span><br><span class="line">  zkAcl = acl;</span><br><span class="line">  zkAuthInfo = authInfo;</span><br><span class="line">  appClient = app;</span><br><span class="line">  znodeWorkingDir = parentZnodeName;</span><br><span class="line">  <span class="comment">// ä¸´æ—¶èŠ‚ç‚¹ActiveStandbyElectorLockï¼Œç”¨äºæ ‡è¯†é”</span></span><br><span class="line">  zkLockFilePath = znodeWorkingDir + <span class="string">&quot;/&quot;</span> + LOCK_FILENAME;</span><br><span class="line">  <span class="comment">// æ°¸ä¹…èŠ‚ç‚¹ActiveBreadCrumbï¼Œç”¨äºå­˜æ”¾activeä¿¡æ¯</span></span><br><span class="line">  zkBreadCrumbPath = znodeWorkingDir + <span class="string">&quot;/&quot;</span> + BREADCRUMB_FILENAME;</span><br><span class="line">  <span class="keyword">this</span>.maxRetryNum = maxRetryNum;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// createConnection for future API calls</span></span><br><span class="line">  <span class="comment">// åˆ›å»ºzkè¿æ¥</span></span><br><span class="line">  createConnection();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createConnection</span><span class="params">()</span> <span class="keyword">throws</span> IOException, KeeperException </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  zkClient = getNewZooKeeper();</span><br><span class="line">  LOG.debug(<span class="string">&quot;Created new connection for &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">synchronized</span> ZooKeeper <span class="title">getNewZooKeeper</span><span class="params">()</span> <span class="keyword">throws</span> IOException,</span></span><br><span class="line"><span class="function">    KeeperException </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// Unfortunately, the ZooKeeper constructor connects to ZooKeeper and</span></span><br><span class="line">  <span class="comment">// may trigger the Connected event immediately. So, if we register the</span></span><br><span class="line">  <span class="comment">// watcher after constructing ZooKeeper, we may miss that event. Instead,</span></span><br><span class="line">  <span class="comment">// we construct the watcher first, and have it block any events it receives</span></span><br><span class="line">  <span class="comment">// before we can set its ZooKeeper reference.</span></span><br><span class="line">  <span class="comment">// ä¸å¹¸çš„æ˜¯ï¼Œzkçš„æ„é€ æ–¹æ³•è¿æ¥ä¸Šzkä¹‹åï¼Œå¯èƒ½é©¬ä¸Šè§¦å‘è¿æ¥äº‹ä»¶ã€‚</span></span><br><span class="line">  <span class="comment">// å› æ­¤å¦‚æœæ„é€ zkä¹‹åæ³¨å†Œwatcherï¼Œå¯èƒ½ä¸ä¼šæ•è·åˆ°è¿æ¥äº‹ä»¶ã€‚</span></span><br><span class="line">  <span class="comment">// å–è€Œä»£ä¹‹çš„æ–¹æ³•æ˜¯ï¼Œå…ˆæ„é€ Watcherï¼Œåœ¨è®¾ç½®äº†zkçš„å¼•ç”¨ä¹‹å‰ï¼Œä½¿å®ƒé˜»å¡æ‰€æœ‰çš„äº‹ä»¶</span></span><br><span class="line">  watcher = <span class="keyword">new</span> WatcherWithClientRef();</span><br><span class="line">  ZooKeeper zk = <span class="keyword">new</span> ZooKeeper(zkHostPort, zkSessionTimeout, watcher);</span><br><span class="line">  <span class="comment">// åœ¨watcherä¸­è®¾ç½®zkçš„å¼•ç”¨</span></span><br><span class="line">  watcher.setZooKeeperRef(zk);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Wait for the asynchronous success/failure. This may throw an exception</span></span><br><span class="line">  <span class="comment">// if we don&#x27;t connect within the session timeout.</span></span><br><span class="line">  watcher.waitForZKConnectionEvent(zkSessionTimeout);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">for</span> (ZKAuthInfo auth : zkAuthInfo) &#123;</span><br><span class="line">    zk.addAuthInfo(auth.getScheme(), auth.getAuth());</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> zk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>initZkä¸»è¦æ˜¯é€šè¿‡å®ä¾‹åŒ–ActiveStandbyElectorï¼Œä»è€Œå¾—åˆ°zkClientï¼Œå¹¶å‘å…¶æ³¨å†Œä¸€ä¸ªwatcherï¼Œè¿™é‡Œç®€å•ä»‹ç»ä¸‹watcherçš„å®ç°ç±»<code>WatcherWithClientRef</code>ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">WatcherWithClientRef</span> <span class="keyword">implements</span> <span class="title">Watcher</span> </span>&#123;</span><br><span class="line">  <span class="keyword">private</span> ZooKeeper zk;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Latch fired whenever any event arrives. This is used in order</span></span><br><span class="line"><span class="comment">   * to wait for the Connected event when the client is first created.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> CountDownLatch hasReceivedEvent = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Latch used to wait until the reference to ZooKeeper is set.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> CountDownLatch hasSetZooKeeper = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * Waits for the next event from ZooKeeper to arrive.</span></span><br><span class="line"><span class="comment">   * </span></span><br><span class="line"><span class="comment">   * <span class="doctag">@param</span> connectionTimeoutMs zookeeper connection timeout in milliseconds</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> KeeperException if the connection attempt times out. This will</span></span><br><span class="line"><span class="comment">   * be a ZooKeeper ConnectionLoss exception code.</span></span><br><span class="line"><span class="comment">   * <span class="doctag">@throws</span> IOException if interrupted while connecting to ZooKeeper</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="comment">// æ¥æ”¶è¿æ¥æ˜¯å¦è¿æ¥æˆåŠŸ </span></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">waitForZKConnectionEvent</span><span class="params">(<span class="keyword">int</span> connectionTimeoutMs)</span></span></span><br><span class="line"><span class="function">      <span class="keyword">throws</span> KeeperException, IOException </span>&#123;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// await() å¦‚æœhasReceivedEventä¸º0åˆ™ç«‹å³è¿”å›trueï¼Œ</span></span><br><span class="line">    <span class="comment">// å¦‚æœåœ¨connectionTimeoutMså†…hasReceivedEventä¾ç„¶ä¸ä¸º0ï¼Œçº¿ç¨‹ä¾ç„¶é˜»å¡åˆ™è¿”å›false</span></span><br><span class="line">    <span class="comment">// å½“è°ƒç”¨countDown()ä¹‹åï¼ŒhasReceivedEventçš„å€¼ä¼šå‘ç”Ÿå˜åŒ–å‡1</span></span><br><span class="line">      <span class="keyword">if</span> (!hasReceivedEvent.await(connectionTimeoutMs, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">        LOG.error(<span class="string">&quot;Connection timed out: couldn&#x27;t connect to ZooKeeper in &quot;</span></span><br><span class="line">            + connectionTimeoutMs + <span class="string">&quot; milliseconds&quot;</span>);</span><br><span class="line">        zk.close();</span><br><span class="line">        <span class="keyword">throw</span> KeeperException.create(Code.CONNECTIONLOSS);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">      Thread.currentThread().interrupt();</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> IOException(</span><br><span class="line">          <span class="string">&quot;Interrupted when connecting to zookeeper server&quot;</span>, e);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setZooKeeperRef</span><span class="params">(ZooKeeper zk)</span> </span>&#123;</span><br><span class="line">    Preconditions.checkState(<span class="keyword">this</span>.zk == <span class="keyword">null</span>,</span><br><span class="line">        <span class="string">&quot;zk already set -- must be set exactly once&quot;</span>);</span><br><span class="line">    <span class="keyword">this</span>.zk = zk;</span><br><span class="line">    hasSetZooKeeper.countDown();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">process</span><span class="params">(WatchedEvent event)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ¥æ”¶åˆ°äº‹ä»¶ä¹‹åï¼ŒhasReceivedEventçš„å€¼å‡1</span></span><br><span class="line">    hasReceivedEvent.countDown();</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      hasSetZooKeeper.await(zkSessionTimeout, TimeUnit.MILLISECONDS);</span><br><span class="line">      <span class="comment">// æ•è·åˆ°äº‹ä»¶ä¹‹åå…·ä½“çš„å¤„ç†é€»è¾‘</span></span><br><span class="line">      ActiveStandbyElector.<span class="keyword">this</span>.processWatchEvent(</span><br><span class="line">          zk, event);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      fatalError(</span><br><span class="line">          <span class="string">&quot;Failed to process watcher event &quot;</span> + event + <span class="string">&quot;: &quot;</span> +</span><br><span class="line">          StringUtils.stringifyException(t));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>WatcherWithClientRefåœ¨æ„é€ zkæ—¶è¢«æ³¨å†Œä¸ºé»˜è®¤watcherï¼Œä¸»è¦ç›‘å¬è¿æ¥æˆ–è€…æ–­å¼€äº‹ä»¶ã€‚å½“è°ƒç”¨initZkä¹‹åï¼Œwatcher.processä¼šå¯¹äº‹ä»¶è¿›è¡Œå¤„ç†ï¼Œè¿æ¥ã€æ–­å¼€ã€è¿‡æœŸçš„çŠ¶æ€ç±»å‹éƒ½æ˜¯EventType.Noneã€‚</p><p><code>initZK()</code>ä¹‹åä¹Ÿå°±å¾—åˆ°äº†zkClientï¼Œç»§ç»­<code>doRun</code>ï¼ŒæŸ¥çœ‹æ˜¯å¦æœ‰å‚æ•°_-formatZK_ï¼Œæœ‰åˆ™æ‰§è¡ŒformatZKï¼Œå¯¹zkè¿›è¡Œæ ¼å¼åŒ–ï¼Œç„¶åç»“æŸç¨‹åºã€‚è¿™é‡Œä¸»è¦ä»‹ç»å¯¹nnçš„FailoverControllerï¼Œæ˜¯æ²¡æœ‰å‚æ•°çš„æƒ…å†µï¼Œæ¥ä¸‹æ¥æ˜¯åˆå§‹åŒ–rpcæœåŠ¡initRPCï¼Œzkfcçš„rpcç±»æ˜¯<code>ZKFCRpcServer</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">initRPC</span><span class="params">()</span> <span class="keyword">throws</span> IOException </span>&#123;</span><br><span class="line">  InetSocketAddress bindAddr = getRpcAddressToBindTo();</span><br><span class="line">  rpcServer = <span class="keyword">new</span> ZKFCRpcServer(conf, bindAddr, <span class="keyword">this</span>, getPolicyProvider());</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ZKFCRpcServer.class</span></span><br><span class="line">ZKFCRpcServer(Configuration conf,</span><br><span class="line">    InetSocketAddress bindAddr,</span><br><span class="line">    ZKFailoverController zkfc,</span><br><span class="line">    PolicyProvider policy) <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">  <span class="keyword">this</span>.zkfc = zkfc;</span><br><span class="line">  <span class="comment">// ä½¿ç”¨protocol bufferåºåˆ—åŒ–</span></span><br><span class="line">  RPC.setProtocolEngine(conf, ZKFCProtocolPB.class,</span><br><span class="line">      ProtobufRpcEngine.class);</span><br><span class="line">  ZKFCProtocolServerSideTranslatorPB translator =</span><br><span class="line">      <span class="keyword">new</span> ZKFCProtocolServerSideTranslatorPB(<span class="keyword">this</span>);</span><br><span class="line">  BlockingService service = ZKFCProtocolService</span><br><span class="line">      .newReflectiveBlockingService(translator);</span><br><span class="line">  <span class="comment">// ä½¿ç”¨hadoop rpcæ¥å£å¾—åˆ°rpc server</span></span><br><span class="line">  <span class="comment">// ZKFCProtocolæ˜¯rpcåè®®ï¼Œserviceæ˜¯rpcåè®®çš„å®ç°ç±»</span></span><br><span class="line">  <span class="comment">// ZKFCProtocolPBæ˜¯protobuf rpcæ¥å£çš„ä¸€ä¸ªè¿‡æ¸¡ç±»</span></span><br><span class="line">  <span class="keyword">this</span>.server = <span class="keyword">new</span> RPC.Builder(conf).setProtocol(ZKFCProtocolPB.class)</span><br><span class="line">      .setInstance(service).setBindAddress(bindAddr.getHostName())</span><br><span class="line">      .setPort(bindAddr.getPort()).setNumHandlers(HANDLER_COUNT)</span><br><span class="line">      .setVerbose(<span class="keyword">false</span>).build();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// set service-level authorization security policy</span></span><br><span class="line">  <span class="keyword">if</span> (conf.getBoolean(</span><br><span class="line">      CommonConfigurationKeys.HADOOP_SECURITY_AUTHORIZATION, <span class="keyword">false</span>)) &#123;</span><br><span class="line">    server.refreshServiceAcl(conf, policy);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™é‡Œä¸»è¦æ˜¯æ„é€ äº†ä¸€ä¸ªzkfcçš„rpc serverï¼Œæ­¤rpcä½¿ç”¨protocol bufferåºåˆ—åŒ–æ¶ˆæ¯ï¼Œhadoop rpcæä¾›çš„æ¥å£æ¥æ„é€ rpc serverã€‚rpcåè®®æ˜¯åœ¨<code>ZKFCProtocol</code>æ¥å£ä¸­å®šä¹‰çš„ï¼ŒåŒ…å«ä¸¤ä¸ªæ–¹æ³•<code>cedeActive</code>å’Œ<code>gracefulFailover</code>ï¼Œå…¶æ¥å£çš„å®ç°ç±»æ˜¯<code>ZKFCProtocolServerSideTranslatorPB</code>ï¼Œæ¶ˆæ¯æ ¼å¼ä¼ è¾“çš„æ ¼å¼æ˜¯åœ¨ZKFCProtocol.protoä¸­å®šä¹‰çš„ã€‚æœ‰å…³hadoop rpcæ›´è¯¦ç»†çš„å†…å®¹å¯ä»¥æŸ¥çœ‹å…ˆå‰çš„åšå®¢[Hadoop RPC è§£æ](<a href="http://bigdatadecode.top/Hadoop">http://bigdatadecode.top/Hadoop</a> RPC è§£æ.html)ã€‚</p><p>initRPCä¹‹åå¼€å§‹è°ƒç”¨initHMï¼Œåˆå§‹åŒ–HealthMonitor</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initHM</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  healthMonitor = <span class="keyword">new</span> HealthMonitor(conf, localTarget);</span><br><span class="line">  <span class="comment">// æ·»åŠ å›è°ƒå‡½æ•°</span></span><br><span class="line">  healthMonitor.addCallback(<span class="keyword">new</span> HealthCallbacks());</span><br><span class="line">  healthMonitor.addServiceStateCallback(<span class="keyword">new</span> ServiceStateCallBacks());</span><br><span class="line">  healthMonitor.start();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…ˆæ¥çœ‹ä¸‹HealthMonitorçš„æ„é€ å‡½æ•°ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">HealthMonitor(Configuration conf, HAServiceTarget target) &#123;</span><br><span class="line">  <span class="keyword">this</span>.targetToMonitor = target;</span><br><span class="line">  <span class="keyword">this</span>.conf = conf;</span><br><span class="line">  <span class="comment">// ha.health-monitor.sleep-after-disconnect.ms</span></span><br><span class="line">  <span class="keyword">this</span>.sleepAfterDisconnectMillis = conf.getLong(</span><br><span class="line">      HA_HM_SLEEP_AFTER_DISCONNECT_KEY,</span><br><span class="line">      HA_HM_SLEEP_AFTER_DISCONNECT_DEFAULT);</span><br><span class="line">  <span class="comment">// ha.health-monitor.check-interval.ms éš”å¤šä¹…å»æ£€æŸ¥nnæ˜¯å¦å¥åº·ï¼Œé»˜è®¤æ˜¯1000 </span></span><br><span class="line">  <span class="keyword">this</span>.checkIntervalMillis = conf.getLong(</span><br><span class="line">      HA_HM_CHECK_INTERVAL_KEY,</span><br><span class="line">      HA_HM_CHECK_INTERVAL_DEFAULT);</span><br><span class="line">  <span class="comment">// ha.health-monitor.connect-retry-interval.ms é»˜è®¤æ˜¯1000    </span></span><br><span class="line">  <span class="keyword">this</span>.connectRetryInterval = conf.getLong(</span><br><span class="line">      HA_HM_CONNECT_RETRY_INTERVAL_KEY,</span><br><span class="line">      HA_HM_CONNECT_RETRY_INTERVAL_DEFAULT);</span><br><span class="line">  <span class="comment">// ha.health-monitor.rpc-timeout.ms</span></span><br><span class="line">  <span class="keyword">this</span>.rpcTimeout = conf.getInt(</span><br><span class="line">      HA_HM_RPC_TIMEOUT_KEY,</span><br><span class="line">      HA_HM_RPC_TIMEOUT_DEFAULT);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">this</span>.daemon = <span class="keyword">new</span> MonitorDaemon();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>HealthMonitoræ„é€ å®Œä¹‹åï¼Œæ·»åŠ å›è°ƒç±»ï¼Œç„¶åå°†HealthMonitorçº¿ç¨‹ä½œä¸ºä¸€ä¸ª_å®ˆæŠ¤è¿›ç¨‹_å»å¯åŠ¨ã€‚æŸ¥çœ‹å…¶runæ–¹æ³•</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// MonitorDaemon.run HealthMonitorçš„å†…éƒ¨ç±»</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (shouldRun) &#123;</span><br><span class="line">    <span class="keyword">try</span> &#123; </span><br><span class="line">      <span class="comment">// å¾—åˆ°rpcçš„å®¢æˆ·ç«¯ï¼Œæ­¤æ—¶çš„rpc serveræ˜¯åœ¨nnä¸­å¯åŠ¨çš„rpc server</span></span><br><span class="line">      loopUntilConnected();</span><br><span class="line">      <span class="comment">// å¯¹nnè¿›è¡Œå¾ªç¯æ£€æŸ¥</span></span><br><span class="line">      doHealthChecks();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException ie) &#123;</span><br><span class="line">      Preconditions.checkState(!shouldRun,</span><br><span class="line">          <span class="string">&quot;Interrupted but still supposed to run&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doHealthChecks</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span><br><span class="line">  <span class="keyword">while</span> (shouldRun) &#123;</span><br><span class="line">    HAServiceStatus status = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">boolean</span> healthy = <span class="keyword">false</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      status = proxy.getServiceStatus();</span><br><span class="line">      <span class="comment">// å¥åº·çŠ¶æ€æ£€æŸ¥ï¼Œå¼‚å¸¸ä¼šæŠ›å‡º</span></span><br><span class="line">      proxy.monitorHealth();</span><br><span class="line">      healthy = <span class="keyword">true</span>;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (HealthCheckFailedException e) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Service health check failed for &quot;</span> + targetToMonitor</span><br><span class="line">          + <span class="string">&quot;: &quot;</span> + e.getMessage());</span><br><span class="line">      enterState(State.SERVICE_UNHEALTHY);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">      LOG.warn(<span class="string">&quot;Transport-level exception trying to monitor health of &quot;</span> +</span><br><span class="line">          targetToMonitor + <span class="string">&quot;: &quot;</span> + t.getLocalizedMessage());</span><br><span class="line">      RPC.stopProxy(proxy);</span><br><span class="line">      proxy = <span class="keyword">null</span>;</span><br><span class="line">      enterState(State.SERVICE_NOT_RESPONDING);</span><br><span class="line">      Thread.sleep(sleepAfterDisconnectMillis);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (status != <span class="keyword">null</span>) &#123;</span><br><span class="line">      setLastServiceStatus(status);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (healthy) &#123;</span><br><span class="line">      enterState(State.SERVICE_HEALTHY);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// é—´éš”checkIntervalMillisä¹‹åç»§ç»­check healthy</span></span><br><span class="line">    Thread.sleep(checkIntervalMillis);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¥åº·çŠ¶æ€çš„æ£€æµ‹ä¸»è¦æ˜¯åœ¨<code>doHealthChecks</code>ä¸­è°ƒç”¨<code>monitorHealth</code>ï¼Œå…¶è°ƒç”¨é€»è¾‘æ˜¯NameNodeRpcServer.monitorHealthâ€“&gt;NameNode.monitorHealthï¼Œè¯¥æ–¹æ³•ä¼šè°ƒç”¨<code>getNamesystem().checkAvailableResources()</code>å»æ£€æŸ¥ç£ç›˜æ˜¯å¦æœ‰è¶³å¤Ÿçš„å¯ç”¨ç©ºé—´ï¼Œä¸å¤Ÿåˆ™æŠ›å‡º<code>HealthCheckFailedException</code>å¼‚å¸¸ï¼Œåœ¨<code>doHealthChecks</code>ä¸­è¢«æ•è·ï¼Œè®¾ç½®çŠ¶æ€ä¸º_SERVICE_UNHEALTHY_ï¼Œè¯¥æ–¹æ³•ä¹Ÿå¯èƒ½æŠ›å‡ºåˆ«çš„å¼‚å¸¸è¢«Throwableæ•è·ï¼Œè®¾ç½®çŠ¶æ€ä¸º_SERVICE_NOT_RESPONDING_ã€‚ç„¶åè°ƒç”¨<code>enterState</code>è¿›è¡ŒçŠ¶æ€çš„æ›´æ–°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">enterState</span><span class="params">(State newState)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (newState != state) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Entering state &quot;</span> + newState);</span><br><span class="line">    state = newState;</span><br><span class="line">    <span class="keyword">synchronized</span> (callbacks) &#123;</span><br><span class="line">      <span class="comment">// è°ƒç”¨åœ¨æ„é€ HealthMonitoræ—¶æ³¨å†Œçš„å›è°ƒç±»</span></span><br><span class="line">      <span class="keyword">for</span> (Callback cb : callbacks) &#123;</span><br><span class="line">        cb.enteredState(newState);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HealthCallbacks</span> <span class="keyword">implements</span> <span class="title">HealthMonitor</span>.<span class="title">Callback</span> </span>&#123;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">enteredState</span><span class="params">(HealthMonitor.State newState)</span> </span>&#123;</span><br><span class="line">    setLastHealthState(newState);</span><br><span class="line">    <span class="comment">// æ£€æŸ¥å½“å‰nnçš„çŠ¶æ€ï¼Œåˆ¤æ–­æ˜¯å¦å¯ç”¨è¿›è¡Œé€‰ä¸¾</span></span><br><span class="line">    recheckElectability();</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">recheckElectability</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">// Maintain lock ordering of elector -&gt; ZKFC</span></span><br><span class="line">  <span class="keyword">synchronized</span> (elector) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">      <span class="keyword">boolean</span> healthy = lastHealthState == State.SERVICE_HEALTHY;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">long</span> remainingDelay = delayJoiningUntilNanotime - System.nanoTime(); </span><br><span class="line">      <span class="keyword">if</span> (remainingDelay &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (healthy) &#123;</span><br><span class="line">          LOG.info(<span class="string">&quot;Would have joined master election, but this node is &quot;</span> +</span><br><span class="line">              <span class="string">&quot;prohibited from doing so for &quot;</span> +</span><br><span class="line">              TimeUnit.NANOSECONDS.toMillis(remainingDelay) + <span class="string">&quot; more ms&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        scheduleRecheck(remainingDelay);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">      &#125;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">switch</span> (lastHealthState) &#123;</span><br><span class="line">      <span class="keyword">case</span> SERVICE_HEALTHY:</span><br><span class="line">        elector.joinElection(targetToData(localTarget));</span><br><span class="line">        <span class="keyword">if</span> (quitElectionOnBadState) &#123;</span><br><span class="line">          quitElectionOnBadState = <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">      <span class="keyword">case</span> INITIALIZING:</span><br><span class="line">        LOG.info(<span class="string">&quot;Ensuring that &quot;</span> + localTarget + <span class="string">&quot; does not &quot;</span> +</span><br><span class="line">            <span class="string">&quot;participate in active master election&quot;</span>);</span><br><span class="line">        elector.quitElection(<span class="keyword">false</span>);</span><br><span class="line">        serviceState = HAServiceState.INITIALIZING;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">  </span><br><span class="line">      <span class="keyword">case</span> SERVICE_UNHEALTHY:</span><br><span class="line">      <span class="keyword">case</span> SERVICE_NOT_RESPONDING:</span><br><span class="line">        LOG.info(<span class="string">&quot;Quitting master election for &quot;</span> + localTarget +</span><br><span class="line">            <span class="string">&quot; and marking that fencing is necessary&quot;</span>);</span><br><span class="line">        elector.quitElection(<span class="keyword">true</span>);</span><br><span class="line">        serviceState = HAServiceState.INITIALIZING;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">      <span class="keyword">case</span> HEALTH_MONITOR_FAILED:</span><br><span class="line">        fatalError(<span class="string">&quot;Health monitor failed!&quot;</span>);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">        </span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">&quot;Unhandled state:&quot;</span> + lastHealthState);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨<code>recheckElectability</code>ä¸­åŒ¹é…åˆ°nnçš„çŠ¶æ€æ˜¯<em>SERVICE_UNHEALTHY</em>æˆ–è€…<em>SERVICE_NOT_RESPONDING</em>åˆ™è°ƒç”¨<code>elector.quitElection(true)</code>æ”¾å¼ƒé€‰ä¸¾</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// needFenceä¸ºtrueåˆ™éœ€è¦æ‰§è¡Œfence</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">quitElection</span><span class="params">(<span class="keyword">boolean</span> needFence)</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;Yielding from election&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (!needFence &amp;&amp; state == State.ACTIVE) &#123;</span><br><span class="line">    <span class="comment">// If active is gracefully going back to standby mode, remove</span></span><br><span class="line">    <span class="comment">// our permanent znode so no one fences us.</span></span><br><span class="line">    tryDeleteOwnBreadCrumbNode();</span><br><span class="line">  &#125;</span><br><span class="line">  reset();</span><br><span class="line">  wantToBeInElection = <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  state = State.INIT;</span><br><span class="line">  terminateConnection();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">terminateConnection</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (zkClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  LOG.debug(<span class="string">&quot;Terminating ZK connection for &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">  ZooKeeper tempZk = zkClient;</span><br><span class="line">  zkClient = <span class="keyword">null</span>;</span><br><span class="line">  watcher = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    tempZk.close();</span><br><span class="line">  &#125; <span class="keyword">catch</span>(InterruptedException e) &#123;</span><br><span class="line">    LOG.warn(e);</span><br><span class="line">  &#125;</span><br><span class="line">  zkConnectionState = ConnectionState.TERMINATED;</span><br><span class="line">  wantToBeInElection = <span class="keyword">false</span>;</span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>æ”¾å¼ƒé€‰ä¸¾å…¶å®å°±æ˜¯è°ƒç”¨ActiveStandbyElectorçš„quitElectionï¼Œå°†zkClinetå…³é—­ï¼Œzkè¿æ¥å…³é—­ä¹‹åï¼Œä¹‹å‰åˆ›å»ºçš„ä¸´æ—¶èŠ‚ç‚¹<code>ActiveStandbyElectorLock</code>è¢«åˆ é™¤ï¼Œæ­¤æ—¶standbyèŠ‚ç‚¹ä¸Šçš„ActiveStandbyElectoré€šè¿‡watcherç›‘å¬åˆ°_NodeDeleted_äº‹ä»¶è¿›è¡Œé€‰ä¸¾æŠ¢é”ï¼ˆåªæœ‰standbyèŠ‚ç‚¹ä¸Šçš„watcherèƒ½ç›‘å¬åˆ°NodeDeletedäº‹ä»¶ï¼Œå› ä¸ºactiveèŠ‚ç‚¹ä¸Šçš„watcheréšç€zkClinetçš„å…³é—­å·²ç»æ¶ˆå¤±äº†ï¼Œæ— æ³•è¿›è¡Œç›‘å¬ï¼‰ã€‚</p><p>activeèŠ‚ç‚¹ä¸Šçš„ActiveStandbyElectoré€€å‡ºé€‰ä¸¾ä¹‹åï¼ŒHealthMonitorçº¿ç¨‹ç»§ç»­check nnï¼Œç­‰åˆ°active nnæ¢å¤æ­£å¸¸ä¹‹åé‡æ–°è¿›è¡Œé€‰ä¸¾ã€‚è€ŒstandbyèŠ‚ç‚¹ä¸Šçš„watcherç›‘å¬åˆ°NodeDeletedäº‹ä»¶ï¼Œç”±watcher.processå¤„ç†äº‹ä»¶ï¼Œåœ¨processä¸­åˆè°ƒç”¨äº†<code>ActiveStandbyElector.this.processWatchEvent</code>ï¼Œä¸‹é¢çœ‹ä¸‹processWatchEventçš„ä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">processWatchEvent</span><span class="params">(ZooKeeper zk, WatchedEvent event)</span> </span>&#123;</span><br><span class="line">  Event.EventType eventType = event.getType();</span><br><span class="line">  <span class="keyword">if</span> (isStaleClient(zk)) <span class="keyword">return</span>;</span><br><span class="line">  LOG.debug(<span class="string">&quot;Watcher event type: &quot;</span> + eventType + <span class="string">&quot; with state:&quot;</span></span><br><span class="line">      + event.getState() + <span class="string">&quot; for path:&quot;</span> + event.getPath()</span><br><span class="line">      + <span class="string">&quot; connectionState: &quot;</span> + zkConnectionState</span><br><span class="line">      + <span class="string">&quot; for &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (eventType == Event.EventType.None) &#123;</span><br><span class="line">    <span class="comment">// the connection state has changed</span></span><br><span class="line">    <span class="keyword">switch</span> (event.getState()) &#123;</span><br><span class="line">    <span class="keyword">case</span> SyncConnected:</span><br><span class="line">      LOG.info(<span class="string">&quot;Session connected.&quot;</span>);</span><br><span class="line">      <span class="comment">// if the listener was asked to move to safe state then it needs to</span></span><br><span class="line">      <span class="comment">// be undone</span></span><br><span class="line">      ConnectionState prevConnectionState = zkConnectionState;</span><br><span class="line">      zkConnectionState = ConnectionState.CONNECTED;</span><br><span class="line">      <span class="keyword">if</span> (prevConnectionState == ConnectionState.DISCONNECTED &amp;&amp;</span><br><span class="line">          wantToBeInElection) &#123;</span><br><span class="line">        monitorActiveStatus();</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Disconnected:</span><br><span class="line">      LOG.info(<span class="string">&quot;Session disconnected. Entering neutral mode...&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ask the app to move to safe state because zookeeper connection</span></span><br><span class="line">      <span class="comment">// is not active and we dont know our state</span></span><br><span class="line">      zkConnectionState = ConnectionState.DISCONNECTED;</span><br><span class="line">      enterNeutralMode();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> Expired:</span><br><span class="line">      <span class="comment">// the connection got terminated because of session timeout</span></span><br><span class="line">      <span class="comment">// call listener to reconnect</span></span><br><span class="line">      LOG.info(<span class="string">&quot;Session expired. Entering neutral mode and rejoining...&quot;</span>);</span><br><span class="line">      enterNeutralMode();</span><br><span class="line">      reJoinElection(<span class="number">0</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> SaslAuthenticated:</span><br><span class="line">      LOG.info(<span class="string">&quot;Successfully authenticated to ZooKeeper using SASL.&quot;</span>);</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      fatalError(<span class="string">&quot;Unexpected Zookeeper watch event state: &quot;</span></span><br><span class="line">          + event.getState());</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// a watch on lock path in zookeeper has fired. so something has changed on</span></span><br><span class="line">  <span class="comment">// the lock. ideally we should check that the path is the same as the lock</span></span><br><span class="line">  <span class="comment">// path but trusting zookeeper for now</span></span><br><span class="line">  String path = event.getPath();</span><br><span class="line">  <span class="keyword">if</span> (path != <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">switch</span> (eventType) &#123;</span><br><span class="line">    <span class="keyword">case</span> NodeDeleted:</span><br><span class="line">      <span class="keyword">if</span> (state == State.ACTIVE) &#123;</span><br><span class="line">        enterNeutralMode();</span><br><span class="line">      &#125;</span><br><span class="line">      joinElectionInternal();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">case</span> NodeDataChanged:</span><br><span class="line">      monitorActiveStatus();</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      LOG.debug(<span class="string">&quot;Unexpected node event: &quot;</span> + eventType + <span class="string">&quot; for path: &quot;</span> + path);</span><br><span class="line">      monitorActiveStatus();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// some unexpected error has occurred</span></span><br><span class="line">  fatalError(<span class="string">&quot;Unexpected watch error from Zookeeper&quot;</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åŒ¹é…åˆ°<code>NodeDeleted</code>äº‹ä»¶ï¼Œç„¶åæ‰§è¡Œ<code>joinElectionInternal</code>å»åˆ›å»ºä¸´æ—¶èŠ‚ç‚¹ï¼Œè¿›è¡ŒæŠ¢é”,</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">joinElectionInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Preconditions.checkState(appData != <span class="keyword">null</span>,</span><br><span class="line">      <span class="string">&quot;trying to join election without any app data&quot;</span>);</span><br><span class="line">  <span class="keyword">if</span> (zkClient == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!reEstablishSession()) &#123;</span><br><span class="line">      fatalError(<span class="string">&quot;Failed to reEstablish connection with ZooKeeper&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  createRetryCount = <span class="number">0</span>;</span><br><span class="line">  wantToBeInElection = <span class="keyword">true</span>;</span><br><span class="line">  createLockNodeAsync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">createLockNodeAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  zkClient.create(zkLockFilePath, appData, zkAcl, CreateMode.EPHEMERAL,</span><br><span class="line">      <span class="keyword">this</span>, zkClient);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ˜¯å¦åˆ›å»ºæˆåŠŸçš„ç»“æœæ˜¯åœ¨<code>processResult</code>ä¸­è¿›è¡Œæ•è·çš„ï¼Œæ­¤æ—¶çš„<code>ActiveStandbyElector.processResult</code>æ˜¯å®ç°StringCallbackæ¥å£éœ€è¦é‡å†™çš„æ–¹æ³•ï¼Œè¯¥ç±»ä¸­è¿˜æœ‰ä¸ªåŒåçš„æ–¹æ³•ï¼Œæ˜¯å®ç°StatCallbackæ¥å£éœ€è¦é‡å†™çš„æ–¹æ³•ã€‚å…ˆæ¥çœ‹ä¸‹æ•è·createç»“æœçš„processResultä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * interface implementation of Zookeeper callback for create</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">    String name)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Code code = Code.get(rc);</span><br><span class="line">  <span class="keyword">if</span> (isSuccess(code)) &#123;</span><br><span class="line">    <span class="comment">// we successfully created the znode. we are the leader. start monitoring</span></span><br><span class="line">    <span class="comment">// åˆ›å»ºæˆåŠŸï¼Œåˆ™è¿›è¡Œè§’è‰²çš„è½¬å˜</span></span><br><span class="line">    <span class="keyword">if</span> (becomeActive()) &#123;</span><br><span class="line">      monitorActiveStatus();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      reJoinElectionAfterFailureToBecomeActive();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// èŠ‚ç‚¹å·²å­˜åœ¨</span></span><br><span class="line">  <span class="keyword">if</span> (isNodeExists(code)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (createRetryCount == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// znode exists and we did not retry the operation. so a different</span></span><br><span class="line">      <span class="comment">// instance has created it. become standby and monitor lock.</span></span><br><span class="line">      becomeStandby();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// if we had retried then the znode could have been created by our first</span></span><br><span class="line">    <span class="comment">// attempt to the server (that we lost) and this node exists response is</span></span><br><span class="line">    <span class="comment">// for the second attempt. verify this case via ephemeral node owner. this</span></span><br><span class="line">    <span class="comment">// will happen on the callback for monitoring the lock.</span></span><br><span class="line">    monitorActiveStatus();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">  fatalError(errorMessage);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å¦‚æœåˆ›å»ºæˆåŠŸåˆ™å°†å½“å‰èŠ‚ç‚¹è½¬æ¢ä¸ºactiveï¼Œæ‰§è¡Œ<code>becomeActive</code>ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">becomeActive</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    Stat oldBreadcrumbStat = fenceOldActive();</span><br><span class="line">    writeBreadCrumbNode(oldBreadcrumbStat);</span><br><span class="line">    </span><br><span class="line">    LOG.debug(<span class="string">&quot;Becoming active for &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">    appClient.becomeActive();</span><br><span class="line">    state = State.ACTIVE;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">    LOG.warn(<span class="string">&quot;Exception handling the winning of election&quot;</span>, e);</span><br><span class="line">    <span class="comment">// Caller will handle quitting and rejoining the election.</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>ä¸ºé˜²æ­¢è„‘è£‚ï¼Œåœ¨å˜ä¸ºactiveä¹‹å‰ï¼Œå…ˆæ£€æŸ¥ä¸‹æ˜¯å¦éœ€è¦fenceï¼Œåˆ¤æ–­æ˜¯å¦éœ€è¦fenceçš„ä¾æ®æ˜¯zkä¸Šæ˜¯å¦æœ‰_breadcrumb_èŠ‚ç‚¹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Stat <span class="title">fenceOldActive</span><span class="params">()</span> <span class="keyword">throws</span> InterruptedException, KeeperException </span>&#123;</span><br><span class="line">  <span class="keyword">final</span> Stat stat = <span class="keyword">new</span> Stat();</span><br><span class="line">  <span class="keyword">byte</span>[] data;</span><br><span class="line">  LOG.info(<span class="string">&quot;Checking for any old active which needs to be fenced...&quot;</span>);</span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// è¯»å–å½“å‰zkä¸­èŠ‚ç‚¹çš„å†…å®¹</span></span><br><span class="line">    data = zkDoWithRetries(<span class="keyword">new</span> ZKAction&lt;<span class="keyword">byte</span>[]&gt;() &#123;</span><br><span class="line">      <span class="meta">@Override</span></span><br><span class="line">      <span class="keyword">public</span> <span class="keyword">byte</span>[] run() <span class="keyword">throws</span> KeeperException, InterruptedException &#123;</span><br><span class="line">        <span class="keyword">return</span> zkClient.getData(zkBreadCrumbPath, <span class="keyword">false</span>, stat);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (KeeperException ke) &#123;</span><br><span class="line">    <span class="keyword">if</span> (isNodeDoesNotExist(ke.code())) &#123;</span><br><span class="line">      LOG.info(<span class="string">&quot;No old node to fence&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// If we failed to read for any other reason, then likely we lost</span></span><br><span class="line">    <span class="comment">// our session, or we don&#x27;t have permissions, etc. In any case,</span></span><br><span class="line">    <span class="comment">// we probably shouldn&#x27;t become active, and failing the whole</span></span><br><span class="line">    <span class="comment">// thing is the best bet.</span></span><br><span class="line">    <span class="keyword">throw</span> ke;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  LOG.info(<span class="string">&quot;Old node exists: &quot;</span> + StringUtils.byteToHexString(data));</span><br><span class="line">  <span class="comment">// appDataæ˜¯å½“å‰èŠ‚ç‚¹åŠ å…¥é€‰ä¸¾æ—¶çš„èŠ‚ç‚¹ä¿¡æ¯ï¼Œä¹Ÿå°±æ˜¯standbyèŠ‚ç‚¹çš„ä¿¡æ¯</span></span><br><span class="line">  <span class="keyword">if</span> (Arrays.equals(data, appData)) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;But old node has our own data, so don&#x27;t need to fence it.&quot;</span>);</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">  <span class="comment">// å½“å‰zkèŠ‚ç‚¹çš„ä¿¡æ¯ä¸APPDataçš„ä¿¡æ¯ä¸ç¬¦ï¼Œè¿›è¡Œfence</span></span><br><span class="line">    appClient.fenceOldActive(data);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> stat;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å½“å‰zkçš„ActiveBreadCrumbèŠ‚ç‚¹è®°å½•çš„æ˜¯activeèŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œä¸appDataï¼ˆè®°å½•çš„æ˜¯standbyèŠ‚ç‚¹çš„ä¿¡æ¯ï¼‰ä¸ä¸€æ ·ï¼Œåˆ™è¿›è¡ŒfenceOldActiveæ“ä½œï¼ŒfenceOldActiveè°ƒç”¨çš„æ˜¯åœ¨ActiveStandbyElectoråˆå§‹åŒ–æ—¶æ³¨å†Œçš„å›è°ƒç±»é‡Œçš„æ–¹æ³•ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ElectorCallbacks.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">fenceOldActive</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">  ZKFailoverController.<span class="keyword">this</span>.fenceOldActive(data);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// ZKFailoverController.class</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">fenceOldActive</span><span class="params">(<span class="keyword">byte</span>[] data)</span> </span>&#123;</span><br><span class="line">  HAServiceTarget target = dataToTarget(data);</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    doFence(target);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">    recordActiveAttempt(<span class="keyword">new</span> ActiveAttemptRecord(<span class="keyword">false</span>, <span class="string">&quot;Unable to fence old active: &quot;</span> + StringUtils.stringifyException(t)));</span><br><span class="line">    Throwables.propagate(t);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">doFence</span><span class="params">(HAServiceTarget target)</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;Should fence: &quot;</span> + target);</span><br><span class="line">  <span class="comment">// ç”±FailoverControllerè¿›è¡Œåˆ‡æ¢ï¼Œå¦‚æœæ²¡æœ‰åˆ‡æ¢æˆåŠŸåˆ™è¿›è¡Œfence</span></span><br><span class="line">  <span class="keyword">boolean</span> gracefulWorked = <span class="keyword">new</span> FailoverController(conf,</span><br><span class="line">      RequestSource.REQUEST_BY_ZKFC).tryGracefulFence(target);</span><br><span class="line">  <span class="keyword">if</span> (gracefulWorked) &#123;</span><br><span class="line">    <span class="comment">// It&#x27;s possible that it&#x27;s in standby but just about to go into active,</span></span><br><span class="line">    <span class="comment">// no? Is there some race here?</span></span><br><span class="line">    LOG.info(<span class="string">&quot;Successfully transitioned &quot;</span> + target + <span class="string">&quot; to standby &quot;</span> +</span><br><span class="line">        <span class="string">&quot;state without fencing&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    target.checkFencingConfigured();</span><br><span class="line">  &#125; <span class="keyword">catch</span> (BadFencingConfigurationException e) &#123;</span><br><span class="line">    LOG.error(<span class="string">&quot;Couldn&#x27;t fence old active &quot;</span> + target, e);</span><br><span class="line">    recordActiveAttempt(<span class="keyword">new</span> ActiveAttemptRecord(<span class="keyword">false</span>, <span class="string">&quot;Unable to fence old active&quot;</span>));</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(e);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// è°ƒç”¨NodeFencerç±»ï¼Œè¿›è¡Œfence</span></span><br><span class="line">  <span class="keyword">if</span> (!target.getFencer().fence(target)) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">&quot;Unable to fence &quot;</span> + target);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><code>doFence</code>æ—¶å…ˆè°ƒç”¨FailoverController.tryGracefulFenceè¿›è¡ŒçŠ¶æ€çš„è½¬æ¢ï¼Œè¯¥æ–¹æ³•é€šè¿‡rpcæœ€ç»ˆè°ƒç”¨*NameNode.transitionToStandby()*æ–¹æ³•ï¼Œé€šè¿‡<code>state.setState(haContext, STANDBY_STATE)</code>å°†çŠ¶æ€è®¾ç½®ä¸ºstandbyï¼Œå¦‚æœè®¾ç½®å¤±è´¥åˆ™è°ƒç”¨NodeFencerç±»çš„fenceæ–¹æ³•è¿›è¡Œå¼ºåˆ¶fenceã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">fence</span><span class="params">(HAServiceTarget fromSvc)</span> </span>&#123;</span><br><span class="line">  LOG.info(<span class="string">&quot;====== Beginning Service Fencing Process... ======&quot;</span>);</span><br><span class="line">  <span class="keyword">int</span> i = <span class="number">0</span>;</span><br><span class="line">  <span class="comment">// å¯ä»¥è®¾ç½®å¤šä¸ªfence methodï¼Œä»¥å›è½¦åˆ†éš”</span></span><br><span class="line">  <span class="keyword">for</span> (FenceMethodWithArg method : methods) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Trying method &quot;</span> + (++i) + <span class="string">&quot;/&quot;</span> + methods.size() +<span class="string">&quot;: &quot;</span> + method);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="comment">// SshFenceByTcpPort å’Œ ShellCommandFencer å®ç°äº†tryFenceçš„å…·ä½“é€»è¾‘</span></span><br><span class="line">      <span class="keyword">if</span> (method.method.tryFence(fromSvc, method.arg)) &#123;</span><br><span class="line">        LOG.info(<span class="string">&quot;====== Fencing successful by method &quot;</span> + method + <span class="string">&quot; ======&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; </span><br><span class="line">    ...</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>fenceOldActiveæˆåŠŸä¹‹ååˆ™è°ƒç”¨<code>writeBreadCrumbNode</code>å°†å½“å‰standbyèŠ‚ç‚¹çš„ä¿¡æ¯å†™å…¥zkä¸­ï¼Œé€šè¿‡å›è°ƒç±»<code>ElectorCallbacks</code>çš„becomeActiveæ–¹æ³•å°†standbyèŠ‚ç‚¹å˜ä¸ºactiveã€‚çŠ¶æ€è½¬å˜çš„è¿‡ç¨‹æ˜¯é€šè¿‡rpcæœ€ç»ˆè°ƒç”¨NameNodeçš„transitionToActiveæ–¹æ³•å°†ACTIVE_STATEè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹çš„çŠ¶æ€ã€‚åˆ‡æ¢æˆåŠŸä¹‹ååˆ™è¿›å…¥ç›‘æ§ï¼Œè°ƒç”¨<code>monitorActiveStatus</code></p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">monitorActiveStatus</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> wantToBeInElection;</span><br><span class="line">  LOG.debug(<span class="string">&quot;Monitoring active leader for &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">  statRetryCount = <span class="number">0</span>;</span><br><span class="line">  monitorLockNodeAsync();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">monitorLockNodeAsync</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  zkClient.exists(zkLockFilePath, </span><br><span class="line">      watcher, <span class="keyword">this</span>,</span><br><span class="line">      zkClient);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>zkClient.existså°†WatcherWithClientRefæ³¨å†Œä¸ºwatcherï¼Œç›‘å¬ActiveStandbyElectorLock znodeçš„çŠ¶æ€ï¼Œexistsçš„æ‰§è¡Œç»“æœåœ¨processResultä¸­æ•è·ï¼Œæ­¤å¤„çš„processResultæ˜¯ActiveStandbyElectorå®ç°StatCallbackæ¥å£éœ€è¦é‡å†™çš„æ–¹æ³•ã€‚å…ˆæ¥çœ‹ä¸‹æ•è·existsç»“æœçš„processResultä»£ç ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * interface implementation of Zookeeper callback for monitor (exists)</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">processResult</span><span class="params">(<span class="keyword">int</span> rc, String path, Object ctx,</span></span></span><br><span class="line"><span class="params"><span class="function">    Stat stat)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  Code code = Code.get(rc);</span><br><span class="line">  <span class="keyword">if</span> (isSuccess(code)) &#123;</span><br><span class="line">    <span class="comment">// the following owner check completes verification in case the lock znode</span></span><br><span class="line">    <span class="comment">// creation was retried</span></span><br><span class="line">    <span class="keyword">if</span> (stat.getEphemeralOwner() == zkClient.getSessionId()) &#123;</span><br><span class="line">      <span class="comment">// we own the lock znode. so we are the leader</span></span><br><span class="line">      <span class="keyword">if</span> (!becomeActive()) &#123;</span><br><span class="line">        reJoinElectionAfterFailureToBecomeActive();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// we dont own the lock znode. so we are a standby.</span></span><br><span class="line">      becomeStandby();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// the watch set by us will notify about changes</span></span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (isNodeDoesNotExist(code)) &#123;</span><br><span class="line">    <span class="comment">// the lock znode disappeared before we started monitoring it</span></span><br><span class="line">    enterNeutralMode();</span><br><span class="line">    joinElectionInternal();</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶çŠ¶æ€å·²ç»åˆ‡æ¢å®Œæˆï¼ŒåŸactiveèŠ‚ç‚¹å¾ªç¯è¿›è¡Œ<code>doHealthChecks</code>ï¼Œå½“èŠ‚ç‚¹æ¢å¤æ­£å¸¸ä¹‹ååˆ™è°ƒç”¨ActiveStandbyElector.joinElectionæ¢å¤é€‰ä¸¾ã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">joinElection</span><span class="params">(<span class="keyword">byte</span>[] data)</span></span></span><br><span class="line"><span class="function">    <span class="keyword">throws</span> HadoopIllegalArgumentException </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (data == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="keyword">throw</span> <span class="keyword">new</span> HadoopIllegalArgumentException(<span class="string">&quot;data cannot be null&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">if</span> (wantToBeInElection) &#123;</span><br><span class="line">    LOG.info(<span class="string">&quot;Already in election. Not re-connecting.&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// å°†èŠ‚ç‚¹ä¿¡æ¯å†™å…¥appDataä¸­</span></span><br><span class="line">  appData = <span class="keyword">new</span> <span class="keyword">byte</span>[data.length];</span><br><span class="line">  System.arraycopy(data, <span class="number">0</span>, appData, <span class="number">0</span>, data.length);</span><br><span class="line"></span><br><span class="line">  LOG.debug(<span class="string">&quot;Attempting active election for &quot;</span> + <span class="keyword">this</span>);</span><br><span class="line">  joinElectionInternal();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æ•´ä¸ªHAçš„æ•…éšœè½¬ç§»åˆ°æ­¤åˆ†æå®Œæ¯•</p><h2 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h2><p>æœ¬æ–‡ä¸»è¦åˆ†æäº†HAæ¨¡å¼ä¸‹ï¼Œactiveä¸standbyè¿›è¡Œåˆ‡æ¢çš„æµç¨‹ï¼Œå…¶å¤§è‡´æµç¨‹æ˜¯active nné€šè¿‡HealthMonitorçº¿ç¨‹(ha.health-monitor.check-interval.ms é»˜è®¤1000)æ£€æµ‹åˆ°<em>ç£ç›˜ç©ºé—´ä¸è¶³</em>æˆ–è€…<em>rpcè°ƒç”¨æ²¡æœ‰å“åº”</em>ï¼Œæ•è·åˆ°<em>SERVICE_UNHEALTHY</em>æˆ–è€…<em>SERVICE_NOT_RESPONDING</em>çŠ¶æ€ï¼Œå°†é€€å‡ºé€‰ä¸¾ï¼Œå…³é—­zkè¿æ¥ï¼Œæ­¤æ—¶zkä¸Š<em>ActiveStandbyElectorLock</em>ä¸´æ—¶èŠ‚ç‚¹è‡ªåŠ¨åˆ é™¤ï¼ŒstandbyèŠ‚ç‚¹ä¸Šçš„watcherç›‘å¬åˆ°NODEDELETEDäº‹ä»¶ï¼Œè¿›è¡ŒæŠ¢é”ï¼Œå»zkä¸Šåˆ›å»ºActiveStandbyElectorLockèŠ‚ç‚¹ï¼Œ<em>åˆ›å»ºæˆåŠŸä¹‹åè¿›è¡ŒçŠ¶æ€çš„è½¬æ¢becomActive</em>ï¼Œåœ¨becomeActiveæ—¶ä¼šåˆ¤æ–­zkä¸Šæ˜¯å¦å­˜æœ‰åŸactiveèŠ‚ç‚¹åˆ›å»ºçš„<em>ActiveBreadCrumb</em>èŠ‚ç‚¹ï¼Œå¦‚æœæœ‰åˆ™è¿›è¡Œfenceæ“ä½œï¼Œå…ˆç”±<em>FailoverController</em>æ‰§è¡ŒgracefullFenceï¼Œå¦‚æœä¸æˆåŠŸåˆ™æ‰§è¡ŒNodeFenceçš„fenceæ–¹æ³•(fence methodæœ‰ä¸¤ä¸ªï¼Œåˆ†åˆ«æ˜¯SSHFenceå’ŒShellFence)ï¼ŒfenceæˆåŠŸä¹‹åå°†å½“å‰èŠ‚ç‚¹çš„ä¿¡æ¯å†™å…¥ActiveBreadCrumbèŠ‚ç‚¹ï¼Œå¹¶å°†å½“å‰èŠ‚ç‚¹çš„çŠ¶æ€è½¬æ¢ä¸ºactiveã€‚</p><p>åŸactiveèŠ‚ç‚¹çš„HealthMonitorçº¿ç¨‹ä¸€ç›´å¾ªç¯æ£€æµ‹nnçš„å¥åº·çŠ¶å†µï¼Œç­‰åˆ°nnå¥åº·ä¹‹åå†å°†å…¶åŠ å…¥é€‰ä¸¾ï¼ŒåŠ å…¥é€‰ä¸¾ä¹Ÿå°±æ˜¯åˆ›å»ºäºzkçš„è¿æ¥ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> HA </tag>
            
            <tag> ZKFC </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexoå¯åŠ¨4000ç«¯å£æ— æ³•è®¿é—®</title>
      <link href="/hexo%E5%90%AF%E5%8A%A84000%E7%AB%AF%E5%8F%A3%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE.html"/>
      <url>/hexo%E5%90%AF%E5%8A%A84000%E7%AB%AF%E5%8F%A3%E6%97%A0%E6%B3%95%E8%AE%BF%E9%97%AE.html</url>
      
        <content type="html"><![CDATA[<h2 id="hexo-blogå¯åŠ¨æµç¨‹"><a href="#hexo-blogå¯åŠ¨æµç¨‹" class="headerlink" title="hexo blogå¯åŠ¨æµç¨‹"></a>hexo blogå¯åŠ¨æµç¨‹</h2><ul><li>æ–°å»ºä¸€ä¸ªç›®å½•<code>hexo-demo</code></li><li>æŒ‰ä½<code>shift</code>ï¼Œç‚¹å‡»é¼ æ ‡å³é”®ï¼Œé€‰æ‹©<code>åœ¨æ­¤å¤„æ‰“å¼€å‘½ä»¤çª—å£</code></li><li><code>hexo init</code> ï¼ˆç¬¬ä¸€æ¬¡åˆ›å»ºblogï¼‰</li><li><code>npm install</code> å®‰è£…ä¾èµ–</li><li><code>hexo g</code> ç”Ÿæˆé™æ€æ–‡ä»¶</li><li><code>hexo s</code> å¯åŠ¨hexoæœåŠ¡, debugæ¨¡å¼å¯åŠ¨<code>hexo s --debug</code>ï¼ŒæŒ‡å®šç«¯å£å¯åŠ¨ <code>hexo server -p port</code></li><li><code>hexo d</code> éƒ¨ç½²blogåˆ°github</li></ul><h2 id="å‡çº§hexoå’Œä¸»é¢˜"><a href="#å‡çº§hexoå’Œä¸»é¢˜" class="headerlink" title="å‡çº§hexoå’Œä¸»é¢˜"></a>å‡çº§hexoå’Œä¸»é¢˜</h2><p>åœ¨blogç›®å½•æ‰§è¡Œ <code>npm update</code></p><h2 id="æ‰€é‡é—®é¢˜åŠè§£å†³æ–¹æ³•"><a href="#æ‰€é‡é—®é¢˜åŠè§£å†³æ–¹æ³•" class="headerlink" title="æ‰€é‡é—®é¢˜åŠè§£å†³æ–¹æ³•"></a>æ‰€é‡é—®é¢˜åŠè§£å†³æ–¹æ³•</h2><p>è¿è¡Œæ­£å¸¸æ—¶ä¼šæ˜¾ç¤ºå¦‚ä¸‹</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">INFO  Hexo is running at http://0.0.0.0:4000/. Press Ctrl+C to stop.</span><br></pre></td></tr></table></figure><p>è¿™æ—¶æ‰“å¼€<code>localhost:4000</code>å¯ä»¥çœ‹åˆ°hexoçš„åšå®¢ã€‚</p><p>å¦‚æœ<code>localhost:4000</code>æ‰“å¼€å¤±è´¥ï¼Œä¸€ç›´å¤„äºç¼“å†²çŠ¶æ€æ—¶ï¼Œå¯èƒ½çš„åŸå› å¾ˆå¤šï¼Œæˆ‘é‡åˆ°ä¸¤ç§æƒ…å†µ</p><ol><li>å¦‚æœä¸æ‰§è¡Œ<code>npm install</code>ï¼Œä¼šå¯¼è‡´<code>localhost:4000</code>æ‰“å¼€å¤±è´¥</li><li>4000ç«¯å£å ç”¨ï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç«¯å£å ç”¨ï¼Œhexoä¼šæç¤º<code>FATAL Port 4000 has been used. Try other port instead.</code>ï¼Œä½†æ˜¯ä¸æ’é™¤ç‰¹æ®Šæƒ…å†µï¼Œä¿é™©çš„æ–¹æ³•è¿˜æ˜¯æ£€æŸ¥ä¸€éæ˜¯å¦æ˜¯ç«¯å£å ç”¨ã€‚</li></ol><h2 id="windowsä¸‹æ£€æŸ¥ç«¯å£æ˜¯å¦å ç”¨å¹¶æ€æ­»è¯¥è¿›ç¨‹"><a href="#windowsä¸‹æ£€æŸ¥ç«¯å£æ˜¯å¦å ç”¨å¹¶æ€æ­»è¯¥è¿›ç¨‹" class="headerlink" title="windowsä¸‹æ£€æŸ¥ç«¯å£æ˜¯å¦å ç”¨å¹¶æ€æ­»è¯¥è¿›ç¨‹"></a>windowsä¸‹æ£€æŸ¥ç«¯å£æ˜¯å¦å ç”¨å¹¶æ€æ­»è¯¥è¿›ç¨‹</h2><ul><li><code>netstat -ano | findstr 4000</code>  ï¼ˆæœ€åä¸€åˆ—æ˜¯pidï¼‰</li><li><code>tasklist | findstr pid</code></li><li><code>taskkill -PID pid -F</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> hexo </tag>
            
            <tag> 4000 </tag>
            
            <tag> æ‰“å¼€å¤±è´¥ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>HDFSç»´æŒå‰¯æœ¬å¹³è¡¡çš„æµç¨‹</title>
      <link href="/HDFS%E7%BB%B4%E6%8C%81%E5%89%AF%E6%9C%AC%E5%B9%B3%E8%A1%A1%E7%9A%84%E6%B5%81%E7%A8%8B.html"/>
      <url>/HDFS%E7%BB%B4%E6%8C%81%E5%89%AF%E6%9C%AC%E5%B9%B3%E8%A1%A1%E7%9A%84%E6%B5%81%E7%A8%8B.html</url>
      
        <content type="html"><![CDATA[<p>HDFSä¸Šæ–‡ä»¶çš„blocké»˜è®¤ä¼šå­˜æ”¾3ä¸ªå‰¯æœ¬ï¼Œä¸€ä¸ªå‰¯æœ¬å­˜åœ¨ä¸€ä¸ªrackçš„æŸä¸ªdnä¸Šï¼Œç¬¬äºŒä¸ªå’Œç¬¬ä¸‰ä¸ªå‰¯æœ¬å­˜æ”¾åœ¨å¦ä¸€ä¸ªæœºæ¶çš„æŸä¸¤ä¸ªdnä¸Šï¼Œnnä¼šç»´æŒblockçš„å‰¯æœ¬å¹³è¡¡ï¼Œä½†æ˜¯å½“é›†ç¾¤ä¸Šçš„å‰¯æœ¬æ•°è¶…è¿‡3ä¸ªæ—¶ï¼Œnnä¼šåˆ é™¤é‚£äº›èŠ‚ç‚¹ä¸Šçš„å‰¯æœ¬æ¥ç»´æŠ¤å‰¯æœ¬å¹³è¡¡å‘¢ï¼Ÿå½“é›†ç¾¤ä¸Šçš„å‰¯æœ¬æ•°å°‘äº3ä¸ªæ—¶ï¼Œä¼šåŸåˆ™é‚£äº›èŠ‚ç‚¹ä½œä¸ºåŸç‚¹è¿›è¡Œå¤åˆ¶å‘¢ï¼Ÿé‚£å°±æŸ¥ä¸‹ä»£ç çœ‹nnæ˜¯æ€ä¹ˆæçš„</p><span id="more"></span><h2 id="HDFSåˆ é™¤å¤šä½™å‰¯æœ¬"><a href="#HDFSåˆ é™¤å¤šä½™å‰¯æœ¬" class="headerlink" title="HDFSåˆ é™¤å¤šä½™å‰¯æœ¬"></a>HDFSåˆ é™¤å¤šä½™å‰¯æœ¬</h2><h3 id="å¤šä½™å‰¯æœ¬çš„åœºæ™¯"><a href="#å¤šä½™å‰¯æœ¬çš„åœºæ™¯" class="headerlink" title="å¤šä½™å‰¯æœ¬çš„åœºæ™¯"></a>å¤šä½™å‰¯æœ¬çš„åœºæ™¯</h3><ul><li>rack0ä¸Šæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œrack1ä¸Šæœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œæ­¤æ—¶rack0çš„dnä¸‹çº¿ï¼Œnnç»´æŒå‰¯æœ¬å¹³è¡¡ï¼Œå¤åˆ¶ä¸€ä¸ªå‰¯æœ¬åˆ°å…¶å®ƒçš„rackä¸Šï¼Œ3å‰¯æœ¬å¹³è¡¡ï¼Œä½†æ˜¯ä¸‹çº¿çš„dnåˆé‡æ–°ä¸Šçº¿äº†ï¼Œè¿™å°±å‡ºç°äº†4ä¸ªå‰¯æœ¬ï¼Œéœ€è¦åˆ é™¤ä¸€ä¸ªå‰¯æœ¬</li><li>è°ƒç”¨<code>hadoop fs -setrep -R 3</code>ç›¸å…³å‘½ä»¤äººä¸ºä¿®æ”¹å‰¯æœ¬çš„ä¸ªæ•°ï¼Œ</li></ul><h3 id="åˆ é™¤å¤šä½™å‰¯æœ¬"><a href="#åˆ é™¤å¤šä½™å‰¯æœ¬" class="headerlink" title="åˆ é™¤å¤šä½™å‰¯æœ¬"></a>åˆ é™¤å¤šä½™å‰¯æœ¬</h3><p>BlockManagerä¸»è¦ç®¡ç†blockå­˜å‚¨åœ¨é›†ç¾¤ä¸­çš„ç›¸å…³ä¿¡æ¯ï¼ŒæŸ¥çœ‹å…¶<code>processOverReplicatedBlock</code>æ–¹æ³•ï¼Œå¤„ç†å¤šä½™å‰¯æœ¬ï¼Œ</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * æŸ¥å‡ºæœ‰å¤šå°‘ä¸ªå‰¯æœ¬</span></span><br><span class="line"><span class="comment"> * å¦‚æœæœ‰å¤šä½™çš„å‰¯æœ¬ï¼Œåˆ™è°ƒç”¨chooseExcessReplicates()</span></span><br><span class="line"><span class="comment"> * å°†å¤šä½™å‰¯æœ¬æ”¾å…¥excessReplicateMapä¸­</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">processOverReplicatedBlock</span><span class="params">(<span class="keyword">final</span> Block block,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> <span class="keyword">short</span> replication, <span class="keyword">final</span> DatanodeDescriptor addedNode,</span></span></span><br><span class="line"><span class="params"><span class="function">    DatanodeDescriptor delNodeHint)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">// blockæ­£å¸¸å‰¯æœ¬æ‰€åœ¨èŠ‚ç‚¹çš„é›†åˆ</span></span><br><span class="line">  Collection&lt;DatanodeStorageInfo&gt; nonExcess = <span class="keyword">new</span> ArrayList&lt;DatanodeStorageInfo&gt;();</span><br><span class="line">  <span class="comment">// ç”¨äºå­˜æ”¾è¯¥blockæŸåçš„å‰¯æœ¬æ‰€åœ¨çš„èŠ‚ç‚¹(å¤šä½™çš„å‰¯æœ¬ä¸åŒ…å«æŸåçš„å‰¯æœ¬)</span></span><br><span class="line">  Collection&lt;DatanodeDescriptor&gt; corruptNodes = corruptReplicas</span><br><span class="line">      .getNodes(block);</span><br><span class="line">  <span class="keyword">for</span>(DatanodeStorageInfo storage : blocksMap.getStorages(block, State.NORMAL)) &#123;</span><br><span class="line">    <span class="keyword">final</span> DatanodeDescriptor cur = storage.getDatanodeDescriptor();</span><br><span class="line">    ...</span><br><span class="line">    LightWeightLinkedSet&lt;Block&gt; excessBlocks = excessReplicateMap.get(cur</span><br><span class="line">        .getDatanodeUuid());</span><br><span class="line">    <span class="keyword">if</span> (excessBlocks == <span class="keyword">null</span> || !excessBlocks.contains(block)) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!cur.isDecommissionInProgress() &amp;&amp; !cur.isDecommissioned()) &#123;</span><br><span class="line">        <span class="comment">// exclude corrupt replicas</span></span><br><span class="line">        <span class="keyword">if</span> (corruptNodes == <span class="keyword">null</span> || !corruptNodes.contains(cur)) &#123;</span><br><span class="line">          nonExcess.add(storage);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// </span></span><br><span class="line">  chooseExcessReplicates(nonExcess, block, replication, </span><br><span class="line">      addedNode, delNodeHint, blockplacement);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processOverReplicatedBlockå°†blockçš„å‰¯æœ¬æ‰€åœ¨çš„èŠ‚ç‚¹æ”¾åœ¨nonExcessé›†åˆä¸­ï¼Œç„¶åè°ƒç”¨chooseExcessReplicates</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * We want &quot;replication&quot; replicates for the block, but we now have too many.  </span></span><br><span class="line"><span class="comment"> * In this method, copy enough nodes from &#x27;srcNodes&#x27; into &#x27;dstNodes&#x27; such that:</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * srcNodes.size() - dstNodes.size() == replication</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * å°½é‡ä½¿å‰¯æœ¬éå¸ƒrackï¼Œå°½é‡é€‰æ‹©å‰©ä½™ç©ºé—´ä¸è¶³çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * é€‰å–è§„åˆ™æ˜¯é¦–å…ˆä»ä¸åªä¸€ä¸ªå‰¯æœ¬çš„æœºæ¶ä¸Šé€‰å–å‰©ä½™ç©ºé—´æœ€å°çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> * So removing such a replica won&#x27;t remove a rack.  ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿä»€ä¹ˆæ„æ€</span></span><br><span class="line"><span class="comment"> * å¦‚æœæ²¡æœ‰è¿™æ ·çš„èŠ‚ç‚¹å¯ä»¥é€‰æ‹©é‚£å°±é€‰å‰©ä½™ç©ºé—´æœ€å°çš„èŠ‚ç‚¹</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">chooseExcessReplicates</span><span class="params">(<span class="keyword">final</span> Collection&lt;DatanodeStorageInfo&gt; nonExcess, </span></span></span><br><span class="line"><span class="params"><span class="function">                            Block b, <span class="keyword">short</span> replication,</span></span></span><br><span class="line"><span class="params"><span class="function">                            DatanodeDescriptor addedNode,</span></span></span><br><span class="line"><span class="params"><span class="function">                            DatanodeDescriptor delNodeHint,</span></span></span><br><span class="line"><span class="params"><span class="function">                            BlockPlacementPolicy replicator)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> namesystem.hasWriteLock();</span><br><span class="line">  <span class="comment">// first form a rack to datanodes map and</span></span><br><span class="line">  <span class="comment">// BlockCollectionæ˜¯è¯¥blockçš„æ‰€å±ä¿¡æ¯ï¼ŒINodeFileå®ç°æ­¤æ¥å£</span></span><br><span class="line">  BlockCollection bc = getBlockCollection(b);</span><br><span class="line">  <span class="keyword">final</span> BlockStoragePolicy storagePolicy = storagePolicySuite.getPolicy(bc.getStoragePolicyID());</span><br><span class="line">  <span class="comment">// è¿™æ˜¯ä¸ªä»€ä¹ˆä¸œè¥¿å¾…éªŒè¯ï¼Ÿï¼Ÿï¼Ÿï¼Ÿ</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;StorageType&gt; excessTypes = storagePolicy.chooseExcess(</span><br><span class="line">      replication, DatanodeStorageInfo.toStorageTypes(nonExcess));</span><br><span class="line">  <span class="comment">// rackå’Œdnçš„æ˜ å°„</span></span><br><span class="line">  <span class="keyword">final</span> Map&lt;String, List&lt;DatanodeStorageInfo&gt;&gt; rackMap</span><br><span class="line">      = <span class="keyword">new</span> HashMap&lt;String, List&lt;DatanodeStorageInfo&gt;&gt;();</span><br><span class="line">  <span class="comment">// æŸä¸ªæœºæ¶ä¸Šå‰¯æœ¬æ•°è¶…è¿‡1ä¸ªçš„dné›†åˆ    </span></span><br><span class="line">  <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; moreThanOne = <span class="keyword">new</span> ArrayList&lt;DatanodeStorageInfo&gt;();</span><br><span class="line">  <span class="comment">// æœºæ¶ä¸Šåªæœ‰ä¸€ä¸ªå‰¯æœ¬çš„dné›†åˆ</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; exactlyOne = <span class="keyword">new</span> ArrayList&lt;DatanodeStorageInfo&gt;();</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// split nodes into two sets</span></span><br><span class="line">  <span class="comment">// moreThanOne contains nodes on rack with more than one replica</span></span><br><span class="line">  <span class="comment">// exactlyOne contains the remaining nodes</span></span><br><span class="line">  <span class="comment">// å°†nonExcessæ ¹æ®æ‰€åœ¨æœºæ¶ä¸Šå‰¯æœ¬çš„ä¸ªæ•°åˆ†ä¸ºä¸¤ä¸ªé›†åˆ</span></span><br><span class="line">  replicator.splitNodesWithRack(nonExcess, rackMap, moreThanOne, exactlyOne);</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// pick one node to delete that favors the delete hint</span></span><br><span class="line">  <span class="comment">// otherwise pick one with least space from priSet if it is not empty</span></span><br><span class="line">  <span class="comment">// otherwise one node with least space from remains</span></span><br><span class="line">  <span class="keyword">boolean</span> firstOne = <span class="keyword">true</span>;</span><br><span class="line">  <span class="keyword">final</span> DatanodeStorageInfo delNodeHintStorage</span><br><span class="line">      = DatanodeStorageInfo.getDatanodeStorageInfo(nonExcess, delNodeHint);</span><br><span class="line">  <span class="keyword">final</span> DatanodeStorageInfo addedNodeStorage</span><br><span class="line">      = DatanodeStorageInfo.getDatanodeStorageInfo(nonExcess, addedNode);</span><br><span class="line">  <span class="comment">// åˆ é™¤å¤šä½™å‰¯æœ¬ï¼Œreplicationä¸ºæœŸæœ›å‰¯æœ¬æ•°    </span></span><br><span class="line">  <span class="keyword">while</span> (nonExcess.size() - replication &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">final</span> DatanodeStorageInfo cur;</span><br><span class="line">    <span class="comment">// delNodeHintä¸ä¸ºnullï¼Œåˆ™å…ˆä»delNodeHintä¸­åˆ é™¤</span></span><br><span class="line">    <span class="comment">// åªæœ‰ç¬¬ä¸€æ¬¡æ‰ä¼šåˆ¤æ–­</span></span><br><span class="line">    <span class="keyword">if</span> (useDelHint(firstOne, delNodeHintStorage, addedNodeStorage,</span><br><span class="line">        moreThanOne, excessTypes)) &#123;</span><br><span class="line">      cur = delNodeHintStorage;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123; <span class="comment">// regular excessive replica removal</span></span><br><span class="line">      cur = replicator.chooseReplicaToDelete(bc, b, replication,</span><br><span class="line">          moreThanOne, exactlyOne, excessTypes);</span><br><span class="line">    &#125;</span><br><span class="line">    firstOne = <span class="keyword">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// adjust rackmap, moreThanOne, and exactlyOne</span></span><br><span class="line">    replicator.adjustSetsWithChosenReplica(rackMap, moreThanOne,</span><br><span class="line">        exactlyOne, cur);</span><br><span class="line"></span><br><span class="line">    nonExcess.remove(cur);</span><br><span class="line">    addToExcessReplicate(cur.getDatanodeDescriptor(), b);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The &#x27;excessblocks&#x27; tracks blocks until we get confirmation</span></span><br><span class="line">    <span class="comment">// that the datanode has deleted them; the only way we remove them</span></span><br><span class="line">    <span class="comment">// is when we get a &quot;removeBlock&quot; message.  </span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">// The &#x27;invalidate&#x27; list is used to inform the datanode the block </span></span><br><span class="line">    <span class="comment">// should be deleted.  Items are removed from the invalidate list</span></span><br><span class="line">    <span class="comment">// upon giving instructions to the namenode.</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    addToInvalidates(b, cur.getDatanodeDescriptor());</span><br><span class="line">    blockLog.info(<span class="string">&quot;BLOCK* chooseExcessReplicates: &quot;</span></span><br><span class="line">              +<span class="string">&quot;(&quot;</span>+cur+<span class="string">&quot;, &quot;</span>+b+<span class="string">&quot;) is added to invalidated blocks set&quot;</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>chooseExcessReplicatesçš„å¤„ç†é€»è¾‘æ˜¯ï¼Œè°ƒç”¨<code>replicator.splitNodesWithRack</code>å°†nonExcessåˆ†ä¸ºä¸¤ä¸ªé›†åˆï¼Œç„¶åå¾ªç¯çš„è°ƒç”¨<code>replicator.chooseReplicaToDelete</code>é€‰å‡ºè¦åˆ é™¤å‰¯æœ¬çš„èŠ‚ç‚¹ï¼Œæ”¾å…¥excessReplicateMapå’ŒinvalidateBlocksä¸­ï¼Œç­‰å¾…deleteæ‰ã€‚</p><p>moreThanOneå’ŒexactlyOneçš„åˆ’åˆ†è§„åˆ™åœ¨<code>splitNodesWithRack</code>ä¸­ï¼Œä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">splitNodesWithRack</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Iterable&lt;DatanodeStorageInfo&gt; storages,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> Map&lt;String, List&lt;DatanodeStorageInfo&gt;&gt; rackMap,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; moreThanOne,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; exactlyOne)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// æ„å»ºrackMap</span></span><br><span class="line">  <span class="comment">// rackMapä¸­keyæ˜¯rack nameï¼Œvalueæ˜¯å‰¯æœ¬çš„list</span></span><br><span class="line">  <span class="keyword">for</span>(DatanodeStorageInfo s: storages) &#123;</span><br><span class="line">    <span class="keyword">final</span> String rackName = getRack(s.getDatanodeDescriptor());</span><br><span class="line">    List&lt;DatanodeStorageInfo&gt; storageList = rackMap.get(rackName);</span><br><span class="line">    <span class="keyword">if</span> (storageList == <span class="keyword">null</span>) &#123;</span><br><span class="line">      storageList = <span class="keyword">new</span> ArrayList&lt;DatanodeStorageInfo&gt;();</span><br><span class="line">      rackMap.put(rackName, storageList);</span><br><span class="line">    &#125;</span><br><span class="line">    storageList.add(s);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// split nodes into two sets</span></span><br><span class="line">  <span class="comment">// æ ¹æ®valueçš„ä¸ªæ•°è¿›è¡Œåˆ’åˆ†exactlyOneå’ŒmoreThanOne</span></span><br><span class="line">  <span class="keyword">for</span>(List&lt;DatanodeStorageInfo&gt; storageList : rackMap.values()) &#123;</span><br><span class="line">    <span class="keyword">if</span> (storageList.size() == <span class="number">1</span>) &#123;</span><br><span class="line">      <span class="comment">// exactlyOne contains nodes on rack with only one replica</span></span><br><span class="line">      exactlyOne.add(storageList.get(<span class="number">0</span>));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// moreThanOne contains nodes on rack with more than one replica</span></span><br><span class="line">      moreThanOne.addAll(storageList);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>splitNodesWithRackåˆ’åˆ†ç»“æŸä¹‹åï¼Œåœ¨chooseExcessReplicatesä¸­è¿›è¡Œwhileå¾ªç¯æ¥åˆ é™¤å¤šä½™çš„å‰¯æœ¬ï¼Œç›´åˆ°è¾¾åˆ°æœŸæœ›å‰¯æœ¬ä¸ªæ•°ã€‚</p><p>åˆ é™¤èŠ‚ç‚¹çš„é€‰æ‹©æ˜¯åœ¨<code>chooseReplicaToDelete</code>ä¸­å†³å®šçš„ï¼Œè¯¥æ–¹æ³•åœ¨<em>BlockPlacementPolicyDefault</em>ä¸­è¢«é‡å†™ã€‚é€‰å–è§„åˆ™ä¸º</p><ul><li>å¦‚æœmoreThanOneä¸æ˜¯emptyï¼Œåˆ™å…ˆæŠŠmoreThanOneåšä¸ºèŠ‚ç‚¹é›†åˆ</li><li>é¦–å…ˆé€‰æ‹©å¿ƒè·³æ—¶é—´é—´éš”æœ€é•¿çš„èŠ‚ç‚¹æˆ–è€…</li><li>å¦‚æœæ‰€æœ‰çš„å¿ƒè·³éƒ½åœ¨å…è®¸çš„é—´éš”ä¹‹å†…ï¼Œåˆ™é€‰æ‹©å‰©ä½™ç©ºé—´æœ€å°‘çš„èŠ‚ç‚¹ï¼Œ</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// BlockPlacementPolicyDefault.class</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> DatanodeStorageInfo <span class="title">chooseReplicaToDelete</span><span class="params">(BlockCollection bc,</span></span></span><br><span class="line"><span class="params"><span class="function">    Block block, <span class="keyword">short</span> replicationFactor,</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;DatanodeStorageInfo&gt; first,</span></span></span><br><span class="line"><span class="params"><span class="function">    Collection&lt;DatanodeStorageInfo&gt; second,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">final</span> List&lt;StorageType&gt; excessTypes)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ä¸¤æ¬¡å¿ƒè·³ä¹‹é—´å…è®¸çš„æœ€å¤§é—´éš”ï¼Œä¸ºæ—¶é—´ç‚¹æ•°å€¼  </span></span><br><span class="line">  <span class="keyword">long</span> oldestHeartbeat =</span><br><span class="line">    now() - heartbeatInterval * tolerateHeartbeatMultiplier;</span><br><span class="line">  DatanodeStorageInfo oldestHeartbeatStorage = <span class="keyword">null</span>;</span><br><span class="line">  <span class="keyword">long</span> minSpace = Long.MAX_VALUE;</span><br><span class="line">  DatanodeStorageInfo minSpaceStorage = <span class="keyword">null</span>;</span><br><span class="line">  <span class="comment">// å¦‚æœfirsté›†åˆä¸ä¸ºnullï¼Œåˆ™ä»firsté›†åˆä¸­é€‰å–è¦åˆ é™¤çš„èŠ‚ç‚¹ï¼Œå¦åˆ™ä»second</span></span><br><span class="line">  <span class="keyword">for</span>(DatanodeStorageInfo storage : pickupReplicaSet(first, second)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (!excessTypes.contains(storage.getStorageType())) &#123;</span><br><span class="line">      <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">final</span> DatanodeDescriptor node = storage.getDatanodeDescriptor();</span><br><span class="line">    <span class="keyword">long</span> free = node.getRemaining();</span><br><span class="line">    <span class="keyword">long</span> lastHeartbeat = node.getLastUpdate();</span><br><span class="line">    <span class="comment">// å¿ƒè·³é—´éš”æœ€é•¿çš„èŠ‚ç‚¹èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">if</span>(lastHeartbeat &lt; oldestHeartbeat) &#123;</span><br><span class="line">      oldestHeartbeat = lastHeartbeat;</span><br><span class="line">      oldestHeartbeatStorage = storage;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// å¯¹å‰©ä½™ç©ºé—´æœ€å°çš„èŠ‚ç‚¹èµ‹å€¼</span></span><br><span class="line">    <span class="keyword">if</span> (minSpace &gt; free) &#123;</span><br><span class="line">      minSpace = free;</span><br><span class="line">      minSpaceStorage = storage;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// é¦–å…ˆé€‰æ‹©å¿ƒè·³æ—¶é—´é—´éš”æœ€é•¿çš„èŠ‚ç‚¹æˆ–è€…</span></span><br><span class="line">  <span class="comment">// å¦‚æœæ‰€æœ‰çš„å¿ƒè·³éƒ½åœ¨å…è®¸çš„é—´éš”ä¹‹å†…ï¼Œåˆ™é€‰æ‹©å‰©ä½™ç©ºé—´æœ€å°‘çš„èŠ‚ç‚¹ï¼Œ</span></span><br><span class="line">  <span class="keyword">final</span> DatanodeStorageInfo storage;</span><br><span class="line">  <span class="keyword">if</span> (oldestHeartbeatStorage != <span class="keyword">null</span>) &#123;</span><br><span class="line">    storage = oldestHeartbeatStorage;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (minSpaceStorage != <span class="keyword">null</span>) &#123;</span><br><span class="line">    storage = minSpaceStorage;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  excessTypes.remove(storage.getStorageType());</span><br><span class="line">  <span class="keyword">return</span> storage;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€‰å‡ºè¦åˆ é™¤çš„èŠ‚ç‚¹curä¹‹åï¼Œè°ƒç”¨<code>adjustSetsWithChosenReplica</code>é‡æ–°è°ƒæ•´rackMapã€moreThanOneå’ŒexactlyOneï¼Œå¹¶è°ƒç”¨<code>addToExcessReplicate</code>å°†curæ”¾å…¥<em>excessReplicateMap</em>ä¸­</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">addToExcessReplicate</span><span class="params">(DatanodeInfo dn, Block block)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> namesystem.hasWriteLock();</span><br><span class="line">  LightWeightLinkedSet&lt;Block&gt; excessBlocks = excessReplicateMap.get(dn.getDatanodeUuid());</span><br><span class="line">  <span class="keyword">if</span> (excessBlocks == <span class="keyword">null</span>) &#123;</span><br><span class="line">    excessBlocks = <span class="keyword">new</span> LightWeightLinkedSet&lt;Block&gt;();</span><br><span class="line">    excessReplicateMap.put(dn.getDatanodeUuid(), excessBlocks);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (excessBlocks.add(block)) &#123;</span><br><span class="line">    excessBlocksCount.incrementAndGet();</span><br><span class="line">    <span class="keyword">if</span>(blockLog.isDebugEnabled()) &#123;</span><br><span class="line">      blockLog.debug(<span class="string">&quot;BLOCK* addToExcessReplicate:&quot;</span></span><br><span class="line">          + <span class="string">&quot; (&quot;</span> + dn + <span class="string">&quot;, &quot;</span> + block</span><br><span class="line">          + <span class="string">&quot;) is added to excessReplicateMap&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>æœ€åä¼šå°†curæ”¾å…¥<em>invalidateBlocks</em>ä¸­ï¼Œéšåcurä¼šè¢«åˆ é™¤</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">addToInvalidates</span><span class="params">(<span class="keyword">final</span> Block block, <span class="keyword">final</span> DatanodeInfo datanode)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!namesystem.isPopulatingReplQueues()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  invalidateBlocks.add(block, datanode, <span class="keyword">true</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><blockquote><p>invalidateBlocksåœ¨å“ªè¢«åˆ é™¤(åœ¨ReplicationMonitorçš„ä¸­)</p></blockquote><h2 id="HDFSä¿®å¤ç¼ºå°‘å‰¯æœ¬"><a href="#HDFSä¿®å¤ç¼ºå°‘å‰¯æœ¬" class="headerlink" title="HDFSä¿®å¤ç¼ºå°‘å‰¯æœ¬"></a>HDFSä¿®å¤ç¼ºå°‘å‰¯æœ¬</h2><p>å½“HDFSä¸ŠæŸä¸ªblockçš„å‰¯æœ¬æ•°ä½äºæœŸæœ›çš„å‰¯æœ¬æ•°æ—¶ï¼Œä¼šè°ƒç”¨<code>processMisReplicatedBlock</code>è¿›è¡Œå¤„ç†</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Process a single possibly misreplicated block. This adds it to the</span></span><br><span class="line"><span class="comment"> * appropriate queues if necessary, and returns a result code indicating</span></span><br><span class="line"><span class="comment"> * what happened with it.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> MisReplicationResult <span class="title">processMisReplicatedBlock</span><span class="params">(BlockInfo block)</span> </span>&#123;</span><br><span class="line">  BlockCollection bc = block.getBlockCollection();</span><br><span class="line">  <span class="comment">// bc ä¸ºnullï¼Œåˆ™è¯¥blockæ²¡æœ‰æ‰€å±æ–‡ä»¶ä¿¡æ¯ï¼Œæ˜¯æ— æ•ˆçš„ï¼Œåº”è¯¥è¢«åˆ é™¤</span></span><br><span class="line">  <span class="keyword">if</span> (bc == <span class="keyword">null</span>) &#123;</span><br><span class="line">    <span class="comment">// block does not belong to any file</span></span><br><span class="line">    addToInvalidates(block);</span><br><span class="line">    <span class="keyword">return</span> MisReplicationResult.INVALID;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (!block.isComplete()) &#123;</span><br><span class="line">    <span class="comment">// Incomplete blocks are never considered mis-replicated --</span></span><br><span class="line">    <span class="comment">// they&#x27;ll be reached when they are completed or recovered.</span></span><br><span class="line">    <span class="keyword">return</span> MisReplicationResult.UNDER_CONSTRUCTION;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// calculate current replication</span></span><br><span class="line">  <span class="keyword">short</span> expectedReplication = bc.getBlockReplication();</span><br><span class="line">  <span class="comment">// è®¡ç®—è¯¥blockçš„å‰¯æœ¬æ•°ï¼Œä¸åŒ…å«æŸåçš„</span></span><br><span class="line">  NumberReplicas num = countNodes(block);</span><br><span class="line">  <span class="keyword">int</span> numCurrentReplica = num.liveReplicas();</span><br><span class="line">  <span class="comment">// add to under-replicated queue if need to be</span></span><br><span class="line">  <span class="keyword">if</span> (isNeededReplication(block, expectedReplication, numCurrentReplica)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (neededReplications.add(block, numCurrentReplica, num</span><br><span class="line">        .decommissionedReplicas(), expectedReplication)) &#123;</span><br><span class="line">      <span class="keyword">return</span> MisReplicationResult.UNDER_REPLICATED;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (numCurrentReplica &gt; expectedReplication) &#123;</span><br><span class="line">    <span class="keyword">if</span> (num.replicasOnStaleNodes() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="comment">// If any of the replicas of this block are on nodes that are</span></span><br><span class="line">      <span class="comment">// considered &quot;stale&quot;, then these replicas may in fact have</span></span><br><span class="line">      <span class="comment">// already been deleted. So, we cannot safely act on the</span></span><br><span class="line">      <span class="comment">// over-replication until a later point in time, when</span></span><br><span class="line">      <span class="comment">// the &quot;stale&quot; nodes have block reported.</span></span><br><span class="line">      <span class="keyword">return</span> MisReplicationResult.POSTPONE;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// over-replicated block</span></span><br><span class="line">    <span class="comment">// è¶…å‡ºäº†expectedReplicationï¼Œåˆ™åˆ é™¤å¤šä½™å‰¯æœ¬</span></span><br><span class="line">    processOverReplicatedBlock(block, expectedReplication, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    <span class="keyword">return</span> MisReplicationResult.OVER_REPLICATED;</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">return</span> MisReplicationResult.OK;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processMisReplicatedBlockæ ¹æ®è¯¥blockçš„ä¿¡æ¯ï¼Œå°†blockæ‰“ä¸Šæ ‡ç­¾å¹¶æ”¾å…¥ä¸åŒçš„é˜Ÿåˆ—ä¸­è¿›è¡Œå¤„ç†ã€‚åˆ©ç”¨<code>countNodes</code>è®¡ç®—å…¶å‰¯æœ¬æ•°</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Return the number of nodes hosting a given block, grouped</span></span><br><span class="line"><span class="comment"> * by the state of those replicas.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> NumberReplicas <span class="title">countNodes</span><span class="params">(Block b)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">int</span> decommissioned = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> live = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> corrupt = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> excess = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">int</span> stale = <span class="number">0</span>;</span><br><span class="line">  Collection&lt;DatanodeDescriptor&gt; nodesCorrupt = corruptReplicas.getNodes(b);</span><br><span class="line">  <span class="keyword">for</span>(DatanodeStorageInfo storage : blocksMap.getStorages(b, State.NORMAL)) &#123;</span><br><span class="line">    <span class="keyword">final</span> DatanodeDescriptor node = storage.getDatanodeDescriptor();</span><br><span class="line">    <span class="keyword">if</span> ((nodesCorrupt != <span class="keyword">null</span>) &amp;&amp; (nodesCorrupt.contains(node))) &#123;</span><br><span class="line">      corrupt++;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (node.isDecommissionInProgress() || node.isDecommissioned()) &#123;</span><br><span class="line">      decommissioned++;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      LightWeightLinkedSet&lt;Block&gt; blocksExcess = excessReplicateMap.get(node</span><br><span class="line">          .getDatanodeUuid());</span><br><span class="line">      <span class="keyword">if</span> (blocksExcess != <span class="keyword">null</span> &amp;&amp; blocksExcess.contains(b)) &#123;</span><br><span class="line">        excess++;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        live++;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (storage.areBlockContentsStale()) &#123;</span><br><span class="line">      stale++;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">new</span> NumberReplicas(live, decommissioned, corrupt, excess, stale);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>processMisReplicatedBlockä¸­ç”¨isNeededReplicationåˆ¤æ–­æ˜¯å¦éœ€è¦è¿›è¡Œå¢åŠ å‰¯æœ¬æ•°ï¼Œ<code>current &lt; expected || !blockHasEnoughRacks(b)</code>ä¸ºtrueæ—¶ï¼Œåˆ™è°ƒç”¨<code>neededReplications.add</code>è¿›è¡Œå¢åŠ å‰¯æœ¬ï¼ŒneededReplicationsæ˜¯UnderReplicatedBlocksçš„å®ä¾‹ï¼Œ<em>UnderReplicatedBlocksæ˜¯HDFSä¸­å…³äºå—å¤åˆ¶çš„ä¸€ä¸ªé‡è¦æ•°æ®ç»“æ„</em>ã€‚addæ–¹æ³•å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">synchronized</span> <span class="keyword">boolean</span> <span class="title">add</span><span class="params">(Block block,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">int</span> curReplicas, </span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">int</span> decomissionedReplicas,</span></span></span><br><span class="line"><span class="params"><span class="function">                         <span class="keyword">int</span> expectedReplicas)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> curReplicas &gt;= <span class="number">0</span> : <span class="string">&quot;Negative replicas!&quot;</span>;</span><br><span class="line">  <span class="keyword">int</span> priLevel = getPriority(block, curReplicas, decomissionedReplicas,</span><br><span class="line">                             expectedReplicas);</span><br><span class="line">  <span class="keyword">if</span>(priLevel != LEVEL &amp;&amp; priorityQueues.get(priLevel).add(block)) &#123;</span><br><span class="line">    <span class="keyword">if</span>(NameNode.blockStateChangeLog.isDebugEnabled()) &#123;</span><br><span class="line">      NameNode.blockStateChangeLog.debug(</span><br><span class="line">        <span class="string">&quot;BLOCK* NameSystem.UnderReplicationBlock.add:&quot;</span></span><br><span class="line">        + block</span><br><span class="line">        + <span class="string">&quot; has only &quot;</span> + curReplicas</span><br><span class="line">        + <span class="string">&quot; replicas and need &quot;</span> + expectedReplicas</span><br><span class="line">        + <span class="string">&quot; replicas so is added to neededReplications&quot;</span></span><br><span class="line">        + <span class="string">&quot; at priority level &quot;</span> + priLevel);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>addå°†æ ¹æ®blockç›¸å…³å‰¯æœ¬çš„ä¼˜å…ˆçº§æ”¾å…¥under replication queueä¸­ï¼Œä¼˜å…ˆçº§ä»<code>getPriority</code>ä¸­è·å–ï¼Œçº§åˆ«æœ‰5ä¸­ï¼Œä»0å¼€å§‹ï¼Œ0çš„ä¼˜å…ˆçº§æœ€é«˜ï¼Œåˆ™4æœ€ä½ã€‚</p><ol><li>QUEUE_HIGHEST_PRIORITY = 0<br> æœ€é«˜ä¼˜å…ˆçº§ï¼Œä¸»è¦é’ˆå¯¹æ•°æ®å—å‰¯æœ¬æ•°éå¸¸çš„ã€ä¸¥é‡çš„ä¸è¶³çš„æƒ…å†µï¼Œå½“å‰å‰¯æœ¬æ•°ä½äºæœŸæœ›å€¼ï¼Œä¸”ä»…æœ‰1ä¸ªæˆ–è€…å¹²è„†æ²¡æœ‰ï¼Œæ¯”å¦‚å‰¯æœ¬æ•°ä»…æœ‰1ä¸ªï¼Œæˆ–è€…å‰¯æœ¬æ•°å¹²è„†ä¸º0ï¼Œä½†æ˜¯è¿˜å­˜åœ¨é€€å½¹å‰¯æœ¬ï¼Œè¿™ç§æƒ…å†µæœ€å±é™©ï¼Œæ•°æ®æœ€å®¹æ˜“ä¸¢å¤±ï¼Œæ‰€ä»¥å¤åˆ¶çš„ä¼˜å…ˆçº§ä¹Ÿæœ€é«˜</li><li>QUEUE_VERY_UNDER_REPLICATED = 1<br> ä¸»è¦é’ˆå¯¹æ•°æ®å—å‰¯æœ¬æ•°ä¸è¶³ä½†æ²¡æœ‰ä¸Šé¢ä¸¥é‡çš„æƒ…å†µï¼Œå¦‚<em>å½“å‰å‰¯æœ¬æ•°ä½äºæœŸæœ›å€¼ï¼Œä½†æ˜¯å‰¯æœ¬æ•°å¤§äº1</em>ï¼Œ<strong>å…¶åˆ¤æ–­å…¬å¼ä¸ºå½“å‰å‰¯æœ¬æ•°curReplicasä¹˜ä»¥3è¿˜å°äºæœŸæœ›å‰¯æœ¬æ•°expectedReplicas</strong>ï¼Œè¿™ç§æƒ…å†µä¹Ÿæ¯”è¾ƒå±é™©ï¼Œæ•°æ®ä¹Ÿå®¹æ˜“ä¸¢å¤±ï¼Œæ‰€ä»¥å¤åˆ¶çš„ä¼˜å…ˆçº§ä¹Ÿå¾ˆé«˜</li><li>QUEUE_UNDER_REPLICATED = 2<br> ä¸»è¦é’ˆå¯¹æ•°æ®å—å‰¯æœ¬æ•°ä½äºæœŸæœ›å€¼ï¼Œä½†æ˜¯è¿˜ä¸æ˜¯å¾ˆä¸¥é‡ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºæ­£å¸¸ç¼ºå¤±å‰¯æœ¬å—</li><li>QUEUE_REPLICAS_BADLY_DISTRIBUTED = 3<br> æœ‰è¶³å¤Ÿ(å¤§äºæˆ–è€…ç­‰äºæ­£ç¡®çš„å‰¯æœ¬æ•°)çš„å‰¯æœ¬ä¸ªæ•°ï¼Œä½†æ˜¯å¹¶ä¸ç¬¦åˆå‰¯æœ¬çš„æ”¾ç½®ç­–ç•¥ï¼Œå‰¯æœ¬åˆ†å¸ƒä¸å‡è¡¡</li><li>QUEUE_WITH_CORRUPT_BLOCKS = 4<br> ä¸»è¦é’ˆå¯¹<em>æŸåçš„æ•°æ®å—çš„æƒ…å†µï¼Œå…¶å‰¯æœ¬æ•°ä½0</em>ï¼Œä½†æ˜¯è¿˜æ²¡æœ‰é€€å½¹å‰¯æœ¬</li></ol><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">int</span> <span class="title">getPriority</span><span class="params">(Block block,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">int</span> curReplicas, </span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">int</span> decommissionedReplicas,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="keyword">int</span> expectedReplicas)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">assert</span> curReplicas &gt;= <span class="number">0</span> : <span class="string">&quot;Negative replicas!&quot;</span>;</span><br><span class="line">  <span class="keyword">if</span> (curReplicas &gt;= expectedReplicas) &#123;</span><br><span class="line">    <span class="comment">// Block has enough copies, but not enough racks</span></span><br><span class="line">    <span class="keyword">return</span> QUEUE_REPLICAS_BADLY_DISTRIBUTED;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (curReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="comment">// If there are zero non-decommissioned replicas but there are</span></span><br><span class="line">    <span class="comment">// some decommissioned replicas, then assign them highest priority</span></span><br><span class="line">    <span class="keyword">if</span> (decommissionedReplicas &gt; <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> QUEUE_HIGHEST_PRIORITY;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//all we have are corrupt blocks</span></span><br><span class="line">    <span class="keyword">return</span> QUEUE_WITH_CORRUPT_BLOCKS;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (curReplicas == <span class="number">1</span>) &#123;</span><br><span class="line">    <span class="comment">//only on replica -risk of loss</span></span><br><span class="line">    <span class="comment">// highest priority</span></span><br><span class="line">    <span class="keyword">return</span> QUEUE_HIGHEST_PRIORITY;</span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> ((curReplicas * <span class="number">3</span>) &lt; expectedReplicas) &#123;</span><br><span class="line">    <span class="comment">//there is less than a third as many blocks as requested;</span></span><br><span class="line">    <span class="comment">//this is considered very under-replicated</span></span><br><span class="line">    <span class="keyword">return</span> QUEUE_VERY_UNDER_REPLICATED;</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="comment">//add to the normal queue for under replicated blocks</span></span><br><span class="line">    <span class="keyword">return</span> QUEUE_UNDER_REPLICATED;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>é€šè¿‡getPriorityå¾—åˆ°ä¼˜å…ˆçº§ä¹‹åï¼Œä»<em>priorityQueues</em> listä¸­æ‹¿åˆ°ç›¸åŒä¼˜å…ˆçº§çš„<em>LightWeightLinkedSet</em> setï¼Œå°†blockæ”¾å…¥setä¸­ã€‚æœ€ååœ¨<code>processMisReplicatedBlock</code>æ–¹æ³•ä¸­è¿”å›è¯¥blockçš„æ ‡è®°<em>MisReplicationResult.UNDER_REPLICATED</em></p><p>é€šè¿‡ä¸Šé¢çš„ä»£ç nnå°†ç¼ºå°‘å‰¯æœ¬çš„blockæ ¹æ®å¤åˆ¶ä¼˜å…ˆçº§æ”¾å…¥ä¸åŒçš„queueä¸­ï¼Œç­‰å¾…å¤åˆ¶çº¿ç¨‹è¿›è¡Œå¤åˆ¶ã€‚</p><h2 id="é™„åŠ ï¼šå‰¯æœ¬é»˜è®¤æ”¾ç½®ç­–ç•¥"><a href="#é™„åŠ ï¼šå‰¯æœ¬é»˜è®¤æ”¾ç½®ç­–ç•¥" class="headerlink" title="é™„åŠ ï¼šå‰¯æœ¬é»˜è®¤æ”¾ç½®ç­–ç•¥"></a>é™„åŠ ï¼šå‰¯æœ¬é»˜è®¤æ”¾ç½®ç­–ç•¥</h2><p>é»˜è®¤çš„æ”¾ç½®ç­–ç•¥å¤§å®¶éƒ½ç†Ÿæ‚‰ï¼Œ3å‰¯æœ¬åˆ†å¸ƒåœ¨ä¸¤ä¸ªrackä¸Šï¼Œä¸€ä¸ªrackä¸Šæœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œå¦ä¸€ä¸ªrackä¸Šæœ‰ä¸¤ä¸ªå‰¯æœ¬ï¼Œè¿™é‡Œå°±åªç®€å•çš„åˆ—å‡ºä»£ç çš„éƒ¨åˆ†å®ç°ï¼Œä»£ç å…¥å£æ˜¯BlockPlacementPolicyDefault.chooseTargetï¼Œè¿™é‡Œåªåˆ—ä¸»è¦çš„é€»è¾‘ä»£ç chooseTargetï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Node <span class="title">chooseTarget</span><span class="params">(<span class="keyword">int</span> numOfReplicas,</span></span></span><br><span class="line"><span class="params"><span class="function">                          Node writer,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> Set&lt;Node&gt; excludedNodes,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">long</span> blocksize,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">int</span> maxNodesPerRack,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> List&lt;DatanodeStorageInfo&gt; results,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">boolean</span> avoidStaleNodes,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> BlockStoragePolicy storagePolicy,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> EnumSet&lt;StorageType&gt; unavailableStorages,</span></span></span><br><span class="line"><span class="params"><span class="function">                          <span class="keyword">final</span> <span class="keyword">boolean</span> newBlock)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (numOfReplicas == <span class="number">0</span> || clusterMap.getNumOfLeaves()==<span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> (writer <span class="keyword">instanceof</span> DatanodeDescriptor) ? writer : <span class="keyword">null</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> numOfResults = results.size();</span><br><span class="line">  <span class="keyword">final</span> <span class="keyword">int</span> totalReplicasExpected = numOfReplicas + numOfResults;</span><br><span class="line">  <span class="keyword">if</span> ((writer == <span class="keyword">null</span> || !(writer <span class="keyword">instanceof</span> DatanodeDescriptor)) &amp;&amp; !newBlock) &#123;</span><br><span class="line">    writer = results.get(<span class="number">0</span>).getDatanodeDescriptor();</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Keep a copy of original excludedNodes</span></span><br><span class="line">  <span class="keyword">final</span> Set&lt;Node&gt; oldExcludedNodes = <span class="keyword">new</span> HashSet&lt;Node&gt;(excludedNodes);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// choose storage types; use fallbacks for unavailable storages</span></span><br><span class="line">  <span class="keyword">final</span> List&lt;StorageType&gt; requiredStorageTypes = storagePolicy</span><br><span class="line">      .chooseStorageTypes((<span class="keyword">short</span>) totalReplicasExpected,</span><br><span class="line">          DatanodeStorageInfo.toStorageTypes(results),</span><br><span class="line">          unavailableStorages, newBlock);</span><br><span class="line">  <span class="keyword">final</span> EnumMap&lt;StorageType, Integer&gt; storageTypes =</span><br><span class="line">      getRequiredStorageTypes(requiredStorageTypes);</span><br><span class="line">  <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">    LOG.trace(<span class="string">&quot;storageTypes=&quot;</span> + storageTypes);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> ((numOfReplicas = requiredStorageTypes.size()) == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">throw</span> <span class="keyword">new</span> NotEnoughReplicasException(</span><br><span class="line">          <span class="string">&quot;All required storage types are unavailable: &quot;</span></span><br><span class="line">          + <span class="string">&quot; unavailableStorages=&quot;</span> + unavailableStorages</span><br><span class="line">          + <span class="string">&quot;, storagePolicy=&quot;</span> + storagePolicy);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ç¬¬ä¸€ä¸ªdnçš„é€‰æ‹©ï¼Œå¦‚æœclientåœ¨dnä¸Šï¼Œåˆ™é€‰æ‹©æ­¤dnï¼Œå¦åˆ™éšæœºé€‰dn</span></span><br><span class="line">    <span class="keyword">if</span> (numOfResults == <span class="number">0</span>) &#123;</span><br><span class="line">      writer = chooseLocalStorage(writer, excludedNodes, blocksize,</span><br><span class="line">          maxNodesPerRack, results, avoidStaleNodes, storageTypes, <span class="keyword">true</span>)</span><br><span class="line">              .getDatanodeDescriptor();</span><br><span class="line">      <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ä»resultsåˆ—è¡¨ä¸­å–å‡ºç¬¬ä¸€ä¸ªå‰¯æœ¬æ‰€åœ¨çš„dn0</span></span><br><span class="line">    <span class="keyword">final</span> DatanodeDescriptor dn0 = results.get(<span class="number">0</span>).getDatanodeDescriptor();</span><br><span class="line">    <span class="comment">// ç¬¬äºŒä¸ªå‰¯æœ¬ä»édn0çš„æœºæ¶ä¸Šé€‰æ‹©ä¸€ä¸ªdn</span></span><br><span class="line">    <span class="keyword">if</span> (numOfResults &lt;= <span class="number">1</span>) &#123;</span><br><span class="line">      chooseRemoteRack(<span class="number">1</span>, dn0, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">          results, avoidStaleNodes, storageTypes);</span><br><span class="line">      <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (numOfResults &lt;= <span class="number">2</span>) &#123;</span><br><span class="line">      <span class="comment">// ä»resultsä¸­å–å‡ºç¬¬äºŒä¸ªå‰¯æœ¬æ‰€åœ¨çš„dn1</span></span><br><span class="line">      <span class="keyword">final</span> DatanodeDescriptor dn1 = results.get(<span class="number">1</span>).getDatanodeDescriptor();</span><br><span class="line">      <span class="comment">// å¦‚æœdn0å’Œdn1åœ¨ä¸€ä¸ªæœºæ¶ä¸Šï¼Œåˆ™ä»å¦ä¸€ä¸ªæœºæ¶ä¸­é€‰æ‹©ä¸€ä¸ªdn</span></span><br><span class="line">      <span class="keyword">if</span> (clusterMap.isOnSameRack(dn0, dn1)) &#123;</span><br><span class="line">        chooseRemoteRack(<span class="number">1</span>, dn0, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">            results, avoidStaleNodes, storageTypes);</span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (newBlock)&#123;</span><br><span class="line">      <span class="comment">// å¦‚æœæ˜¯æ–°blockï¼Œå³results.isEmptyã€‚</span></span><br><span class="line">      <span class="comment">// dn0å’Œdn1ä¸åœ¨åŒä¸€ä¸ªæœºæ¶ï¼Œåˆ™ä»dn1æ‰€åœ¨çš„æœºæ¶ä¸Šé€‰ä¸€ä¸ªdn</span></span><br><span class="line">        chooseLocalRack(dn1, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">            results, avoidStaleNodes, storageTypes);</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// é€‰æ‹©ä¸€ä¸ªåŒwriteråŒrackçš„dn</span></span><br><span class="line">        chooseLocalRack(writer, excludedNodes, blocksize, maxNodesPerRack,</span><br><span class="line">            results, avoidStaleNodes, storageTypes);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (--numOfReplicas == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">return</span> writer;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¶…å‡º3ä¸ªå‰¯æœ¬çš„æƒ…å†µï¼Œåˆ™åé¢çš„å‰¯æœ¬éšæœºé€‰æ‹©dn</span></span><br><span class="line">    chooseRandom(numOfReplicas, NodeBase.ROOT, excludedNodes, blocksize,</span><br><span class="line">        maxNodesPerRack, results, avoidStaleNodes, storageTypes);</span><br><span class="line">  &#125; <span class="keyword">catch</span> (NotEnoughReplicasException e) &#123;</span><br><span class="line">    <span class="keyword">final</span> String message = <span class="string">&quot;Failed to place enough replicas, still in need of &quot;</span></span><br><span class="line">        + (totalReplicasExpected - results.size()) + <span class="string">&quot; to reach &quot;</span></span><br><span class="line">        + totalReplicasExpected</span><br><span class="line">        + <span class="string">&quot; (unavailableStorages=&quot;</span> + unavailableStorages</span><br><span class="line">        + <span class="string">&quot;, storagePolicy=&quot;</span> + storagePolicy</span><br><span class="line">        + <span class="string">&quot;, newBlock=&quot;</span> + newBlock + <span class="string">&quot;)&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (LOG.isTraceEnabled()) &#123;</span><br><span class="line">      LOG.trace(message, e);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      LOG.warn(message + <span class="string">&quot; &quot;</span> + e.getMessage());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (avoidStaleNodes) &#123;</span><br><span class="line">      <span class="comment">// Retry chooseTarget again, this time not avoiding stale nodes.</span></span><br><span class="line"></span><br><span class="line">      <span class="comment">// excludedNodes contains the initial excludedNodes and nodes that were</span></span><br><span class="line">      <span class="comment">// not chosen because they were stale, decommissioned, etc.</span></span><br><span class="line">      <span class="comment">// We need to additionally exclude the nodes that were added to the </span></span><br><span class="line">      <span class="comment">// result list in the successful calls to choose*() above.</span></span><br><span class="line">      <span class="keyword">for</span> (DatanodeStorageInfo resultStorage : results) &#123;</span><br><span class="line">        addToExcludedNodes(resultStorage.getDatanodeDescriptor(), oldExcludedNodes);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="comment">// Set numOfReplicas, since it can get out of sync with the result list</span></span><br><span class="line">      <span class="comment">// if the NotEnoughReplicasException was thrown in chooseRandom().</span></span><br><span class="line">      numOfReplicas = totalReplicasExpected - results.size();</span><br><span class="line">      <span class="keyword">return</span> chooseTarget(numOfReplicas, writer, oldExcludedNodes, blocksize,</span><br><span class="line">          maxNodesPerRack, results, <span class="keyword">false</span>, storagePolicy, unavailableStorages,</span><br><span class="line">          newBlock);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">boolean</span> retry = <span class="keyword">false</span>;</span><br><span class="line">    <span class="comment">// simply add all the remaining types into unavailableStorages and give</span></span><br><span class="line">    <span class="comment">// another try. No best effort is guaranteed here.</span></span><br><span class="line">    <span class="keyword">for</span> (StorageType type : storageTypes.keySet()) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!unavailableStorages.contains(type)) &#123;</span><br><span class="line">        unavailableStorages.add(type);</span><br><span class="line">        retry = <span class="keyword">true</span>;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (retry) &#123;</span><br><span class="line">      <span class="keyword">for</span> (DatanodeStorageInfo resultStorage : results) &#123;</span><br><span class="line">        addToExcludedNodes(resultStorage.getDatanodeDescriptor(),</span><br><span class="line">            oldExcludedNodes);</span><br><span class="line">      &#125;</span><br><span class="line">      numOfReplicas = totalReplicasExpected - results.size();</span><br><span class="line">      <span class="keyword">return</span> chooseTarget(numOfReplicas, writer, oldExcludedNodes, blocksize,</span><br><span class="line">          maxNodesPerRack, results, <span class="keyword">false</span>, storagePolicy, unavailableStorages,</span><br><span class="line">          newBlock);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> writer;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> replication </tag>
            
            <tag> excess </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Sparkç¼–è¯‘ä¸éƒ¨ç½²</title>
      <link href="/Spark%E7%BC%96%E8%AF%91%E4%B8%8E%E9%83%A8%E7%BD%B2.html"/>
      <url>/Spark%E7%BC%96%E8%AF%91%E4%B8%8E%E9%83%A8%E7%BD%B2.html</url>
      
        <content type="html"><![CDATA[<h2 id="ç¼–è¯‘spark-1-6-1"><a href="#ç¼–è¯‘spark-1-6-1" class="headerlink" title="ç¼–è¯‘spark-1.6.1"></a>ç¼–è¯‘spark-1.6.1</h2><h3 id="ä½¿ç”¨mavenç¼–è¯‘"><a href="#ä½¿ç”¨mavenç¼–è¯‘" class="headerlink" title="ä½¿ç”¨mavenç¼–è¯‘"></a>ä½¿ç”¨mavenç¼–è¯‘</h3><p>ç¼–è¯‘sparkæ—¶éœ€è¦å…ˆå°†maven(<em>mavenéœ€è¦3.3ä»¥ä¸Š</em>)çš„å†…å­˜åŠ å¤§ï¼Œæ‰§è¡Œå‘½ä»¤<br><code>export MAVEN_OPTS=&quot;-Xmx2g -XX:MaxPermSize=512M -XX:ReservedCodeCacheSize=512m&quot;</code></p><p>ç„¶åæ‰§è¡Œç¼–è¯‘å‘½ä»¤(<em>ç¼–è¯‘ç»§æ‰¿hadoopå’Œhiveçš„ç‰ˆæœ¬</em>)<br><code>mvn -Pyarn -Phadoop-2.6 -Dhadoop.version=2.6.0 -Phive -Phive-thriftserver -DskipTests clean package</code></p><p>æ­¤å¤„åªæ˜¯å°†sparkæºç è¿›è¡Œç¼–è¯‘ï¼Œå¹¶æ²¡æœ‰æ‰“åŒ…æˆå¯éƒ¨ç½²çš„taråŒ…ï¼Œç±»ä¼¼å¯éƒ¨ç½²tarè§£å‹ä¹‹åçš„ç»“æœï¼Œä½†åŒ…å«æºç å’Œåˆ«çš„jaråŒ…ã€‚ä¸ºäº†éƒ¨ç½²æ–¹ä¾¿è¿˜æ˜¯è¦å°†sparkç¼–è¯‘ä¸ºtaråŒ…ï¼Œæ‰§è¡Œå‘½ä»¤<br><code>./make-distribution.sh --tgz -Phadoop-2.6 -Phive -Phive-thriftserver -Pyarn -DskipTests -Dhadoop.version=2.6.0</code><br><em>æ‰§è¡Œæ­¤æ¡å‘½ä»¤æ—¶å¯èƒ½éœ€è¦ç­‰å¾…ä¸€æ®µæ—¶é—´æ‰ä¼šæ˜¾ç¤ºç¼–è¯‘çš„è¿‡ç¨‹ï¼Œä¸è¦å¿ƒæ€¥ï¼Œæ…¢æ…¢ç­‰ä¼š</em></p><p>ç¼–è¯‘æ—¶å¦‚æœä¸æŒ‡å®šscalaçš„ç‰ˆæœ¬ï¼Œé»˜è®¤æ˜¯2.10ã€‚å¦‚æœéœ€è¦æ”¹å˜scalaçš„ç‰ˆæœ¬ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š<br><code>./dev/change-scala-version.sh 2.11</code><br>ç„¶åå†æ‰§è¡Œç¼–è¯‘å‘½ä»¤ã€‚</p><span id="more"></span><h2 id="éƒ¨ç½²spark-on-yarn"><a href="#éƒ¨ç½²spark-on-yarn" class="headerlink" title="éƒ¨ç½²spark on yarn"></a>éƒ¨ç½²spark on yarn</h2><p>spark on yarnéƒ¨ç½²æ¯”è¾ƒç®€å•<br>åœ¨spark-env.shä¸­é…ç½®HADOOP_CONF_DIRå’ŒYARN_CONF_DIRï¼ŒHADOOP_CONF_DIRç”¨æ¥è¿æ¥HDFSï¼ŒYARN_CONF_DIRç”¨æ¥è¿æ¥ResourceManagerã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">HADOOP_CONF_DIR=/home/hadoop/hadoop/etc/hadoop</span><br><span class="line">YARN_CONF_DIR=/home/hadoop/hadoop/etc/hadoop</span><br></pre></td></tr></table></figure><p>éƒ¨ç½²å¥½ä¹‹åè¿è¡Œä¸ªä¾‹å­æ£€æµ‹ä¸‹</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">./bin/spark-submit --<span class="class"><span class="keyword">class</span>\ <span class="title">org</span>.<span class="title">apache</span>.<span class="title">spark</span>.<span class="title">examples</span>.<span class="title">SparkPi</span> --<span class="title">master</span> <span class="title">yarn</span> --<span class="title">deploy</span>-<span class="title">mode</span> <span class="title">cluster</span> --<span class="title">driver</span>-<span class="title">memory</span> 4<span class="title">g</span> --<span class="title">executor</span>-<span class="title">memory</span> 2<span class="title">g</span> --<span class="title">executor</span>-<span class="title">cores</span> 1 <span class="title">lib</span>/<span class="title">spark</span>-<span class="title">examples</span>-1.6.1-<span class="title">hadoop2</span>.6.0.<span class="title">jar</span> 100</span></span><br></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨<code>--jars</code>å‚æ•°æ·»åŠ ä¾èµ–çš„jaråŒ…</p><h2 id="spark-sql-with-hive"><a href="#spark-sql-with-hive" class="headerlink" title="spark sql with hive"></a>spark sql with hive</h2><ul><li>å°†hive-site.xml scp åˆ°hadoop03çš„spark/confä¸­ (<em>hive clientå¯ä»¥å’Œspark clientä¸åœ¨ä¸€å°æœºå™¨ä¸Š</em>)</li><li>å°†lib/mysql-connector-java-5.1.38-bin.jar scp hadoop03çš„spark/lib</li></ul><p>è¿è¡Œspark-shellæ£€éªŒæ˜¯å¦éƒ¨ç½²æˆåŠŸ<br><code>bin/spark-shell --driver-class-path lib/mysql-connector-java-5.1.38-bin.jar</code><br>æ‰“å¼€spark-shellæ‰§è¡Œä¸€äº›hiveå‘½ä»¤è¿›è¡Œæµ‹è¯•ã€‚<br>ä¹Ÿå¯æ‰§è¡Œspark-sql<br><code>bin/spark-sql --master yarn --driver-class-path lib/mysql-connector-java-5.1.38-bin.jar</code></p><p>ç”¨spark sqlæ“ä½œhiveæ—¶ï¼Œå¿…é¡»æ„å»ºä¸€ä¸ªHiveContextå¯¹è±¡ï¼Œå…¶ç»§æ‰¿è‡ªSQLContextã€‚</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// sc is an existing SparkContext.</span></span><br><span class="line">val sqlContext = <span class="keyword">new</span> org.apache.spark.sql.hive.HiveContext(sc)</span><br><span class="line"><span class="comment">// SQLContext</span></span><br><span class="line"><span class="comment">// val sqlContext = new org.apache.spark.sql.SQLContext(sc)</span></span><br><span class="line"><span class="comment">// val df = sqlContext.sql(&quot;SELECT * FROM table&quot;)</span></span><br><span class="line">sqlContext.sql(<span class="string">&quot;CREATE TABLE IF NOT EXISTS src (key INT, value STRING)&quot;</span>)</span><br><span class="line">sqlContext.sql(<span class="string">&quot;LOAD DATA LOCAL INPATH &#x27;examples/src/main/resources/kv1.txt&#x27; INTO TABLE src&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// Queries are expressed in HiveQL</span></span><br><span class="line">sqlContext.sql(<span class="string">&quot;FROM src SELECT key, value&quot;</span>).collect().foreach(println)</span><br></pre></td></tr></table></figure><h2 id="å¯åŠ¨history-server"><a href="#å¯åŠ¨history-server" class="headerlink" title="å¯åŠ¨history server"></a>å¯åŠ¨history server</h2><ul><li>åœ¨hdfsä¸Šåˆ›å»ºå­˜æ”¾spark logçš„ç›®å½•<br><code>hadoop fs -mkdir /spark_hislog</code></li><li>spark-env.shä¸­æ·»åŠ SPARK_DAEMON_MEMORYã€SPARK_DAEMON_JAVA_OPTSã€SPARK_PUBLIC_DNSã€SPARK_HISTORY_OPTS</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#SPARK_DAEMON_MEMORY=2g # è¿™ä¸ªè²Œä¼¼æ²¡æœ‰èµ·ä½œç”¨ï¼Œéšåå†æµ‹</span><br><span class="line">#SPARK_PUBLIC_DNS=xx.xx.xx.xx # å¯èƒ½æ˜¯ipåœ°å€ </span><br><span class="line">PARK_HISTORY_OPTS=<span class="string">&quot;-Dspark.history.ui.port=18080 -Dspark.history.fs.logDirectory=hdfs://localhost:8020/spark_hislog&quot;</span></span><br></pre></td></tr></table></figure><ul><li>spark-default.conf ä¸­æ·»åŠ å¦‚ä¸‹é…ç½®</li></ul><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># å¼€å¯æ—¥å¿—è®°å½•</span><br><span class="line">spark.eventLog.enabled             <span class="keyword">true</span></span><br><span class="line"># æ—¥å¿—å­˜å‚¨åœ°å€</span><br><span class="line"># spark.eventLog.diråº”è¯¥ä¸spark.history.fs.logDirectoryç›®å½•ä¸€æ ·</span><br><span class="line"># spark.history.fs.logDirectoryï¼šspark history serveré¡µé¢åªå±•ç¤ºè¯¥æŒ‡å®šè·¯å¾„ä¸‹çš„ä¿¡æ¯</span><br><span class="line"># spark.eventLog.dirï¼šapplicationåœ¨è¿è¡Œè¿‡ç¨‹ä¸­æ‰€æœ‰çš„ä¿¡æ¯å‡è®°å½•åœ¨è¯¥å±æ€§æŒ‡å®šçš„è·¯å¾„ä¸‹</span><br><span class="line">spark.eventLog.dir                 hdfs:<span class="comment">//localhost:8020/spark_hislog</span></span><br><span class="line"># æ˜¯å¦è¿›è¡Œå‹ç¼©</span><br><span class="line">spark.eventLog.compress            <span class="keyword">true</span></span><br></pre></td></tr></table></figure><ul><li>å¯åŠ¨history server <code>sbin/start-history-server.sh</code></li><li>è®¿é—®xx.xx.xx.xx:18080</li></ul><h2 id="å¤‡æ³¨"><a href="#å¤‡æ³¨" class="headerlink" title="å¤‡æ³¨"></a>å¤‡æ³¨</h2><p><strong>åœ¨ç¼–è¯‘å’Œéƒ¨ç½²çš„è¿‡ç¨‹ä¸­æˆ‘å¹¶æ²¡æœ‰å®‰è£…scalaï¼Œscalaä½•æ—¶éœ€è¦å®‰è£…æ˜¯å¿…é¡»çš„è¿˜æ˜¯ä»€ä¹ˆï¼Ÿæš‚æ—¶è¿˜ä¸æ¸…æ¥šï¼Œä½†ä¹‹å‰åœ¨å·¥ä½œä¸­è²Œä¼¼é‡åˆ°spark on yarnæ—¶ï¼Œspark clientéœ€è¦å®‰è£…scalaï¼Œä½†ç°åœ¨è¿˜æ²¡æœ‰é‡åˆ°ã€‚</strong></p>]]></content>
      
      
      <categories>
          
          <category> Spark </category>
          
      </categories>
      
      
        <tags>
            
            <tag> BigData </tag>
            
            <tag> éƒ¨ç½² </tag>
            
            <tag> Spark </tag>
            
            <tag> Build </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>linuxé…ç½®sshå¹¶æ›´æ”¹é»˜è®¤ç«¯å£</title>
      <link href="/linux%E9%85%8D%E7%BD%AEssh%E5%B9%B6%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3.html"/>
      <url>/linux%E9%85%8D%E7%BD%AEssh%E5%B9%B6%E6%9B%B4%E6%94%B9%E9%BB%98%E8%AE%A4%E7%AB%AF%E5%8F%A3.html</url>
      
        <content type="html"><![CDATA[<h2 id="å„æœºå™¨æ‰“é€šssh"><a href="#å„æœºå™¨æ‰“é€šssh" class="headerlink" title="å„æœºå™¨æ‰“é€šssh"></a>å„æœºå™¨æ‰“é€šssh</h2><ol><li><p>å®‰è£… ssh(hadoop ç”¨æˆ·)<br> <code>mkdir .ssh  #( __åˆ›å»ºçš„.sshç›®å½•çš„æƒé™å¿…é¡»æ˜¯ 700__ï¼Œå¦åˆ™ä¼šå¯¼è‡´sshä¸é€š )</code><br> <code>ssh-keygen -t rsa</code><br> <code>cat .ssh/id\_rsa.pub &gt;&gt; .ssh/authorized\_keys</code><br> <strong><code>chmod 600 .ssh/authorized_keys #(ä¿®æ”¹æ–‡ä»¶æƒé™ï¼Œå¦åˆ™ä¸èµ·ä½œç”¨ )  å¿…é¡»ä¸º600</code></strong><br>æ‰§è¡Œå®Œä»¥åï¼Œå¯ä»¥åœ¨æœ¬æœºä¸Šæµ‹è¯•ä¸‹ï¼Œç”¨ sshè¿æ¥è‡ªå·±ï¼Œå³ï¼š<code>ssh localhost</code> (æˆ– ssh master),å¦‚æœä¸å¹¸è¿˜æ˜¯æç¤ºè¦è¾“å…¥å¯†ç ï¼Œè¯´æ˜è¿˜æ²¡èµ·ä½œç”¨ï¼ˆ <em><code>ssh user@hostname â€“v</code>  æ˜¯debug æ¨¡å¼</em>ï¼‰</p></li><li><p>åœ¨å…¶å®ƒæœºå™¨ä¸Šç”Ÿæˆå…¬é’¥ã€å¯†é’¥ï¼Œå¹¶å°†å…¬é’¥æ–‡ä»¶å¤åˆ¶åˆ° master<br>a) ä»¥ hadoopèº«ä»½ç™»å½•å…¶å®ƒäºŒå°æœºå™¨ slave01ã€ slave02ï¼Œæ‰§è¡Œ <code>ssh-keygen -t rsa -P &#39;&#39;</code> ç”Ÿæˆå…¬é’¥ã€å¯†é’¥<br>b) ç„¶åç”¨ scpå‘½ä»¤ï¼ŒæŠŠå…¬é’¥æ–‡ä»¶å‘æ”¾ç»™ masterï¼ˆå³ï¼šåˆšæ‰å·²ç»æå®šçš„é‚£å°æœºå™¨ï¼‰<br>slave01ä¸Šï¼š<br> <code>scp .ssh/id\_rsa.pub hadoop@master:/home/hadoop/id\_rsa\_01.pub</code><br>slave02ä¸Šï¼š<br> <code>scp .ssh/id\_rsa.pub hadoop@master:/home/hadoop/id\_rsa\_02.pub</code><br>è¿™äºŒè¡Œæ‰§è¡Œå®Œåï¼Œå›åˆ°masterä¸­ï¼ŒæŸ¥çœ‹ä¸‹ /home/hadoopç›®å½•ï¼Œåº”è¯¥æœ‰äºŒä¸ªæ–°æ–‡ä»¶ id_rsa_01.pubã€id_rsa_02.pub ï¼Œç„¶ååœ¨ masterä¸Šï¼Œå¯¼å…¥è¿™äºŒä¸ªå…¬é’¥<br> <code>cat id\_rsa\_01.pub &gt;&gt; .ssh/authorized_keys</code><br> <code>cat id\_rsa\_02.pub &gt;&gt; .ssh/authorized_keys</code><br>è¿™æ ·ï¼Œmaster è¿™å°æœºå™¨ä¸Šï¼Œå°±æœ‰æ‰€æœ‰ 3å°æœºå™¨çš„å…¬é’¥äº†ã€‚</p></li><li><p>å°† masterä¸Šçš„â€œ æœ€å…¨â€å…¬é’¥ï¼Œå¤åˆ¶åˆ°å…¶å®ƒæœºå™¨<br>a) ç»§ç»­ä¿æŒåœ¨ masterä¸Šï¼Œ<br> <code>scp .ssh/authorized\_keys hadoop@slave01:/home/hadoop/.ssh/authorized\_keys</code><br> <code>scp .ssh/authorized\_keys hadoop@slave02:/home/hadoop/.ssh/authorized\_keys</code><br>b) ä¿®æ”¹å…¶å®ƒæœºå™¨ä¸Š authorized_keysæ–‡ä»¶çš„æƒé™<br>slave01ä»¥åŠ slave02æœºå™¨ä¸Šï¼Œå‡æ‰§è¡Œå‘½ä»¤<br> <code>chmod 600 .ssh/authorized_keys</code></p></li><li><p>éªŒè¯<br>åœ¨æ¯ä¸ªè™šæ‹Ÿæœºä¸Šï¼Œå‡ç”¨ ssh å…¶å®ƒæœºå™¨çš„ hostname éªŒè¯ä¸‹ï¼Œå¦‚æœèƒ½æ­£å¸¸æ— å¯†ç è¿æ¥æˆåŠŸï¼Œè¡¨ç¤º ok</p></li></ol><span id="more"></span><h2 id="æ”¹é»˜è®¤ç«¯å£"><a href="#æ”¹é»˜è®¤ç«¯å£" class="headerlink" title="æ”¹é»˜è®¤ç«¯å£"></a>æ”¹é»˜è®¤ç«¯å£</h2><p>ï¼ˆé˜²ç«å¢™å…³é—­çŠ¶æ€ï¼‰<br>    <code>cp /etc/ssh/ssh\_config   /etc/ssh/ssh\_configbak</code><br>    <code>cp /etc/ssh/sshd\_config  /etc/ssh/sshd\_configbak</code></p><p>ä¿®æ”¹sshç«¯å£ä¸ºï¼š2222<br>    <code>vi /etc/ssh/sshd_config</code><br>åœ¨ç«¯å£#Port 22ä¸‹é¢å¢åŠ <code>Port 2222</code><br>    <code>vi /etc/ssh/ssh_config</code><br>åœ¨ç«¯å£#Port 22ä¸‹é¢å¢åŠ <code>Port 2222</code></p><p>é‡å¯ï¼š<br>    <code>/etc/init.d/sshd restart</code><br>    <code>service sshd restart</code></p><p>ç”¨2222ç«¯å£å¯ä»¥æ­£å¸¸è¿æ¥ä¹‹åï¼Œå†è¿”å›å»é‡å¤ä¸Šé¢çš„æ­¥éª¤ã€‚æŠŠ22ç«¯å£ç¦ç”¨äº†ï¼Œä»¥åsshå°±åªèƒ½ç”¨2222ç«¯å£è¿æ¥äº†ï¼å¢å¼ºäº†ç³»ç»Ÿçš„å®‰å…¨æ€§ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> linux </tag>
            
            <tag> ssh </tag>
            
            <tag> ç«¯å£ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>pythonå¼€å‘ç¯å¢ƒå®‰è£…åŠrestapi demoå¼€å‘</title>
      <link href="/python%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%8F%8Arestapi%20demo%E5%BC%80%E5%8F%91.html"/>
      <url>/python%E5%BC%80%E5%8F%91%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85%E5%8F%8Arestapi%20demo%E5%BC%80%E5%8F%91.html</url>
      
        <content type="html"><![CDATA[<h2 id="linuxä¸‹å®‰è£…"><a href="#linuxä¸‹å®‰è£…" class="headerlink" title="linuxä¸‹å®‰è£…"></a>linuxä¸‹å®‰è£…</h2><p>linuxä¸­ä¸€èˆ¬é»˜è®¤å®‰è£…pythonï¼Œåœ¨å‘½ä»¤è¡Œä¸­è¾“å…¥pythonï¼ŒæŸ¥çœ‹å½“å‰ç‰ˆæœ¬</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">$ python</span><br><span class="line"></span><br><span class="line">Python 2.6.6 (r266:84292, Nov 22 2013, 12:16:22) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)] on linux2</span><br></pre></td></tr></table></figure><span id="more"></span><p>åœ¨å®‰è£…pythonä¹‹å‰å…ˆå®‰è£…<code>sqlite-devel</code>ï¼Œå¦åˆ™éšåè¿è¡Œdjangoæ—¶å¯èƒ½ä¼šæŠ¥é”™ï¼Œé”™è¯¯å†…å®¹ä¸º<code>django.core.exceptions.ImproperlyConfigured: Error loading either pysqlite2 or sqlite3 modules (tried in that order): No module named _sqlite3</code>ã€‚è¿è¡Œå‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install sqlite-devel</span><br></pre></td></tr></table></figure><p>å½“å‰ç‰ˆæœ¬æ˜¯2.6.6ï¼Œå®‰è£…çš„ç‰ˆæœ¬æ˜¯2.7.11</p><ul><li>ä¸‹è½½pythonçš„äºŒè¿›åˆ¶åŒ… Python-2.7.11.tgz å¹¶è§£å‹</li><li>è¿›å…¥è§£å‹åçš„ç›®å½•ä¸­ è¿è¡Œ å¦‚ä¸‹å‘½ä»¤</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">./configure</span><br><span class="line">make</span><br><span class="line">make install  (æƒé™æœ‰é—®é¢˜ï¼Œåˆ™æ‰§è¡Œ sudo make install)</span><br></pre></td></tr></table></figure><p>(<code>source ~/.bashrc</code>)å†æ¬¡è¿è¡Œ<code>python</code>ï¼Œå¦‚æœå‘ç°ç‰ˆæœ¬ä¾ç„¶æ²¡æœ‰å‘ç”Ÿå˜åŒ–ï¼Œåˆ™ç»§ç»­æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sudo su - root</span><br><span class="line"><span class="built_in">cd</span> /usr/bin</span><br><span class="line">rm -rf python</span><br><span class="line">ln -s <span class="variable">$&#123;PYTHON_HOME&#125;</span>/python python</span><br></pre></td></tr></table></figure><p>æ­¤æ—¶pythonå®‰è£…æˆåŠŸï¼Œä½†å¯èƒ½ä¼šå¯¼è‡´centosçš„<code>yum</code>å‘½ä»¤æ— æ³•ä½¿ç”¨ï¼Œæç¤ºå¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">$ yum</span><br><span class="line">There was a problem importing one of the Python modules</span><br><span class="line">required to run yum. The error leading to this problem was:</span><br><span class="line"></span><br><span class="line">   No module named yum</span><br><span class="line"></span><br><span class="line">Please install a package <span class="built_in">which</span> provides this module, or</span><br><span class="line">verify that the module is installed correctly.</span><br><span class="line"></span><br><span class="line">It<span class="string">&#x27;s possible that the above module doesn&#x27;</span>t match the</span><br><span class="line">current version of Python, <span class="built_in">which</span> is:</span><br><span class="line">2.7.11 (default, Apr 19 2016, 14:52:39) </span><br><span class="line">[GCC 4.4.7 20120313 (Red Hat 4.4.7-4)]</span><br><span class="line"></span><br><span class="line">If you cannot solve this problem yourself, please go to </span><br><span class="line">the yum faq at:</span><br><span class="line">  http://yum.baseurl.org/wiki/Faq</span><br></pre></td></tr></table></figure><p>æ­¤é—®é¢˜æ˜¯ç”±äºæœºå™¨ä¸Šæœ‰å¤šä¸ªpythonç‰ˆæœ¬ï¼Œè€Œyumä¾èµ–çš„ç‰ˆæœ¬ä¸é»˜è®¤çš„pythonç‰ˆæœ¬ä¸ä¸€è‡´é€ æˆçš„ï¼Œä¿®æ”¹yumï¼Œå°†å¼€å¤´çš„<code>#!/usr/bin/python</code>æ”¹ä¸º<code>#!/usr/bin/python2.6</code>ï¼š</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">which</span> yum</span><br><span class="line">vim /usr/bin/yum</span><br></pre></td></tr></table></figure><h2 id="å®‰è£…pipï¼Œç”¨æ¥å®‰è£…ç¬¬ä¸‰æ–¹åŒ…"><a href="#å®‰è£…pipï¼Œç”¨æ¥å®‰è£…ç¬¬ä¸‰æ–¹åŒ…" class="headerlink" title="å®‰è£…pipï¼Œç”¨æ¥å®‰è£…ç¬¬ä¸‰æ–¹åŒ…"></a>å®‰è£…pipï¼Œç”¨æ¥å®‰è£…ç¬¬ä¸‰æ–¹åŒ…</h2><p>åœ¨å®‰è£…pipä¹‹å‰ï¼Œè¦å…ˆå®‰è£…setuptools</p><ul><li>wget â€“no-check-certificate <a href="https://bootstrap.pypa.io/ez_setup.py">https://bootstrap.pypa.io/ez_setup.py</a></li><li>python ez_setup.py â€“user  ï¼ˆåœ¨ç”¨æˆ·ç›®å½•ä¸‹å®‰è£…ï¼‰</li><li>python ez_setup.py â€“insecure  ï¼ˆéœ€è¦ç®¡ç†å‘˜æƒé™ï¼‰<br>ã€å¦‚æœä½¿ç”¨ â€“userï¼Œå®‰è£…pipæ—¶ï¼ŒæŠ¥æ‰¾ä¸åˆ°setuptoolsæ¨¡å—ï¼Œåˆ™ä½¿ç”¨â€“insecureå®‰è£…ã€‘</li></ul><p>å®‰è£…pip</p><ul><li>ä¸‹è½½pip pip-8.1.1.tar.gzï¼Œè§£å‹å¹¶è¿›å…¥è¯¥ç›®å½•ä¸­</li><li>sudo python setup.py install </li></ul><!-- sudo yum install MySQL-python --><h2 id="å®‰è£…pythonçš„è™šæ‹Ÿç¯å¢ƒvirtualenv"><a href="#å®‰è£…pythonçš„è™šæ‹Ÿç¯å¢ƒvirtualenv" class="headerlink" title="å®‰è£…pythonçš„è™šæ‹Ÿç¯å¢ƒvirtualenv"></a>å®‰è£…pythonçš„è™šæ‹Ÿç¯å¢ƒvirtualenv</h2><p>pip install virtualenv ï¼ˆroot or sudoï¼‰</p><h2 id="åœ¨virtualenvç¯å¢ƒä¸­åˆ›å»ºåº”ç”¨"><a href="#åœ¨virtualenvç¯å¢ƒä¸­åˆ›å»ºåº”ç”¨" class="headerlink" title="åœ¨virtualenvç¯å¢ƒä¸­åˆ›å»ºåº”ç”¨"></a>åœ¨virtualenvç¯å¢ƒä¸­åˆ›å»ºåº”ç”¨</h2><p>æ–°å»ºä¸ªç›®å½•ï¼Œç”¨äºå­˜æ”¾pythoné¡¹ç›®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">mkdir djangorest</span><br><span class="line"><span class="built_in">cd</span> djangorest</span><br></pre></td></tr></table></figure><ol><li>åˆ›å»ºè™šæ‹Ÿç¯å¢ƒï¼Œå‘½ä»¤<code>virtualenv djangoenv</code></li><li>æ¿€æ´»è™šæ‹Ÿç¯å¢ƒï¼Œå‘½ä»¤<code>source djangoenv/bin/activate</code>ï¼Œæ­¤æ—¶å‘½ä»¤è¡Œæ˜¾ç¤ºå¦‚ä¸‹</li></ol><!-- é€€å‡º deactivate --><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(djangoenv) [hadoop@centos djangorest]$</span><br></pre></td></tr></table></figure><h2 id="rest-api-demoå¼€å‘"><a href="#rest-api-demoå¼€å‘" class="headerlink" title="rest api demoå¼€å‘"></a>rest api demoå¼€å‘</h2><p>å®‰è£…ç¬¬ä¸‰æ–¹ä¾èµ–åŒ…</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">pip install django</span><br><span class="line">pip install djangorestframework</span><br><span class="line">pip install uwsgi</span><br><span class="line">pip install MySQL-python</span><br></pre></td></tr></table></figure><blockquote><p>å®‰è£…pyhs2<br>    yum install gcc-c++<br>    yum install python-devel.x86_64 cyrus-sasl-devel.x86_64<br>    pip install pyhs2</p></blockquote><p>åˆ›å»ºweb application</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">django-admin.py startproject restful .   <span class="comment">#(&quot;.&quot;ä»£è¡¨å½“å‰ç›®å½•)</span></span><br><span class="line">python manage.py startapp rest</span><br></pre></td></tr></table></figure><p>ç¼–è¾‘<code>rest/views.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.decorators <span class="keyword">import</span> api_view</span><br><span class="line"><span class="keyword">from</span> rest_framework.response <span class="keyword">import</span> Response</span><br><span class="line"><span class="keyword">from</span> rest_framework <span class="keyword">import</span> status</span><br><span class="line"><span class="keyword">from</span> django.http <span class="keyword">import</span> HttpResponse</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="comment"># RESTæ¥å£æµ‹è¯•</span></span><br><span class="line"><span class="meta">@api_view(<span class="params">[<span class="string">&#x27;GET&#x27;</span>, <span class="string">&#x27;POST&#x27;</span>]</span>)</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">restapitest</span>(<span class="params">request</span>):</span></span><br><span class="line">    response = HttpResponse()</span><br><span class="line">    <span class="keyword">if</span> request.method == <span class="string">&#x27;POST&#x27;</span>:</span><br><span class="line">        response.write(<span class="string">&quot;This method is post.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br><span class="line">    <span class="keyword">elif</span> request.method == <span class="string">&#x27;GET&#x27;</span>:</span><br><span class="line">        response.write(<span class="string">&quot;This method is get.&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure><p>åˆ›å»º<code>rest/urls.py</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: utf-8</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"><span class="keyword">from</span> rest_framework.urlpatterns <span class="keyword">import</span> format_suffix_patterns</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> rest_framework.routers <span class="keyword">import</span> DefaultRouter</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> . <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^restapitest/$&#x27;</span>, views.restapitest, name = <span class="string">&#x27;restapitest&#x27;</span>),</span><br><span class="line">]</span><br><span class="line">urlpatterns = format_suffix_patterns(urlpatterns)</span><br></pre></td></tr></table></figure><p>åœ¨<code>restful/urls.py</code>ä¸­æ·»åŠ </p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include, url</span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r&#x27;^admin/&#x27;</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r&#x27;^rest/&#x27;</span>, include(<span class="string">&#x27;rest.urls&#x27;</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>ç¼–è¯‘æµ‹è¯•è„šæœ¬<code>rest.test</code></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#coding=utf-8</span></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> urllib</span><br><span class="line"><span class="keyword">import</span> urllib2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get</span>(<span class="params">url, data</span>):</span></span><br><span class="line">    <span class="comment">#req = urllib2.Request(url)</span></span><br><span class="line">    data = urllib.urlencode(data)</span><br><span class="line">    opener = urllib2.build_opener(urllib2.HTTPCookieProcessor())</span><br><span class="line">    <span class="comment">#response = opener.open(req + &quot;?&quot; + data)</span></span><br><span class="line">    response = opener.<span class="built_in">open</span>(<span class="string">&quot;%s?%s&quot;</span>%(url, data))</span><br><span class="line">    <span class="built_in">print</span> data</span><br><span class="line">    <span class="keyword">return</span> response.read()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">post</span>(<span class="params">url, data</span>):</span></span><br><span class="line">    req = urllib2.Request(url)</span><br><span class="line">    data = urllib.urlencode(data)</span><br><span class="line">    opener = urllib2.build_opener(urllib2.HTTPCookieProcessor())</span><br><span class="line">    response = opener.<span class="built_in">open</span>(req, data)</span><br><span class="line">    <span class="built_in">print</span> data</span><br><span class="line">    <span class="keyword">return</span> response.read()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">gettest</span>():</span></span><br><span class="line">    posturl = <span class="string">&quot;http://xxxx:8000/rest/restapitest&quot;</span></span><br><span class="line">    data = <span class="built_in">dict</span>(fromDate=<span class="string">&quot;2016-02-02&quot;</span>,toDate=<span class="string">&quot;2016-02-24&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> posturl</span><br><span class="line">    <span class="built_in">print</span> get(posturl, data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">posttest</span>():</span></span><br><span class="line">    posturl = <span class="string">&quot;http://xxxx:8000/rest/restapitest&quot;</span></span><br><span class="line">    data = <span class="built_in">dict</span>(fromDate=<span class="string">&quot;2016-02-02&quot;</span>,toDate=<span class="string">&quot;2016-02-04&quot;</span>)</span><br><span class="line">    <span class="built_in">print</span> posturl</span><br><span class="line">    <span class="built_in">print</span> post(posturl, data)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&#x27;__main__&#x27;</span>:</span><br><span class="line">    <span class="comment">#gettest()</span></span><br><span class="line">    posttest()</span><br></pre></td></tr></table></figure><p>uwsgiå¯åŠ¨server (åŠ &amp;ï¼Œè¡¨ç¤ºåå°è¿è¡Œ)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi --socket xxxx:8000 --<span class="built_in">chdir</span> /xxx/djangorest/ --wsgi-file restful/wsgi.py --protocol=http --pidfile rest-uwsgi.pid</span><br></pre></td></tr></table></figure><p>è¿è¡Œæµ‹è¯•è„šæœ¬ï¼Œæˆ–è€…ä»æµè§ˆå™¨è®¿é—®</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python rest.test</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> pyhotn </tag>
            
            <tag> å®‰è£… </tag>
            
            <tag> restapi </tag>
            
            <tag> django </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å°†sublime text 2 æ·»åŠ åˆ°å³é”®èœå•ä¸­</title>
      <link href="/%E5%B0%86sublime%20text2%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95%E4%B8%AD.html"/>
      <url>/%E5%B0%86sublime%20text2%E6%B7%BB%E5%8A%A0%E5%88%B0%E5%8F%B3%E9%94%AE%E8%8F%9C%E5%8D%95%E4%B8%AD.html</url>
      
        <content type="html"><![CDATA[<h2 id="å°†sublime-text2æ·»åŠ åˆ°å³é”®èœå•ä¸­"><a href="#å°†sublime-text2æ·»åŠ åˆ°å³é”®èœå•ä¸­" class="headerlink" title="å°†sublime text2æ·»åŠ åˆ°å³é”®èœå•ä¸­"></a>å°†sublime text2æ·»åŠ åˆ°å³é”®èœå•ä¸­</h2><p>Windowså®‰è£…sublime text2ï¼Œå³é”®æ–‡ä»¶ä¸èƒ½ä½¿ç”¨sublime textæ‰“å¼€ï¼Œå³é”®ä¸­å¹¶æ— æ­¤å¿«æ·é”®ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨æ·»åŠ ä½¿ç”¨sublime textç¼–è¾‘çš„é€‰é¡¹ã€‚</p><p>å°†Sublime Textæ·»åŠ åˆ°å³é”®å¯ä»¥æ¦‚æ‹¬ä¸ºä¸€ä¸ªç»Ÿä¸€çš„åŠŸèƒ½ï¼Œå°±æ˜¯è®²åº”ç”¨ç¨‹åºçš„å¿«æ·é”®æ·»åŠ åˆ°é¼ æ ‡å³é”®ä¸­ã€‚</p><h3 id="ä¿®æ”¹æ³¨å†Œè¡¨"><a href="#ä¿®æ”¹æ³¨å†Œè¡¨" class="headerlink" title="ä¿®æ”¹æ³¨å†Œè¡¨"></a>ä¿®æ”¹æ³¨å†Œè¡¨</h3><hr><ol><li>å¼€å§‹-&gt;è¿è¡Œ-&gt;regeditæ‰“å¼€æ³¨å†Œè¡¨ç¼–è¾‘å™¨ã€‚(å¿«æ·é”® window+R è¾“å…¥regedit å›è½¦)</li><li>é€‰æ‹©<code>HKEY_CLASSES_ROOT</code>-&gt;<code>*</code>-&gt;<code>shell</code>ï¼Œç„¶åå³é”®é€‰æ‹©<code>æ–°å»ºé¡¹</code>ï¼Œå‘½åä¸ºEdit with Sublime Text(è¿™ä¸ªå€¼å°±æ˜¯é¼ æ ‡å³é”®èœå•ä¸­æ˜¾ç¤ºçš„åç§°ï¼Œå¯ä»¥éšä¾¿æ”¹)ï¼Œç„¶ååœ¨å³è¾¹ç©ºç™½åŒºåŸŸå³é”®<code>æ–°å»º</code>-&gt;<code>å­—ç¬¦ä¸²å€¼</code>ï¼Œå‘½åä¸º<code>Icon</code>(è¿™ä¸ªä¸èƒ½æ”¹ï¼Œè¿™é‡Œè®¾ç½®çš„æ˜¯çš„å³é”®èœå•ä¸­æ˜¾ç¤ºçš„å›¾æ ‡)ï¼Œå€¼ä¸º<code>D:\Program Files\Sublime Text 2\sublime_text.exe,0</code>ã€‚</li><li>åœ¨<code>Edit with Sublime Text</code>ä¸‹å³é”®<code>æ–°å»º</code>-&gt;<code>é¡¹</code>ï¼Œå‘½åä¸º<code>Command</code>ï¼Œç„¶åä¿®æ”¹å³è¾¹çš„é»˜è®¤å€¼ä¸º<code>D:\Program Files\Sublime Text 2\sublime_text.exe %1</code></li></ol><p>å®Œæˆï¼Œå…³é—­æ³¨å†Œè¡¨å°±å¯ä»¥ç”¨å³é”®æ‰“å¼€æ–‡ä»¶è¿›è¡Œç¼–è¾‘äº†ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> tool </category>
          
      </categories>
      
      
        <tags>
            
            <tag> sublime text </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>å¸¸ç”¨Hadoopå‘½ä»¤</title>
      <link href="/%E5%B8%B8%E7%94%A8Hadoop%E5%91%BD%E4%BB%A4.html"/>
      <url>/%E5%B8%B8%E7%94%A8Hadoop%E5%91%BD%E4%BB%A4.html</url>
      
        <content type="html"><![CDATA[<p>è®°å½•ä¸‹å¸¸ç”¨çš„Hadoopç›¸å…³çš„å‘½ä»¤ï¼Œå¿˜è®°äº†å®¹æ˜“æ‰¾</p><span id="more"></span><h2 id="HDFSå‘½ä»¤"><a href="#HDFSå‘½ä»¤" class="headerlink" title="HDFSå‘½ä»¤"></a>HDFSå‘½ä»¤</h2><ul><li>æŸä¸ªæ–‡ä»¶çš„blocksä¿¡æ¯</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fsck /user/xx -files -blocks -locations</span><br></pre></td></tr></table></figure><ul><li>é‡Šæ”¾ç§Ÿçº¦</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hdfs debug recoverLease -path /xxxx.lzo</span><br></pre></td></tr></table></figure><ul><li>æ”¹å˜ä¸€ä¸ªæ–‡ä»¶æˆ–è€…ç›®å½•çš„å‰¯æœ¬å› å­</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">hadoop fs -setrep -R 3 /user/xx</span><br></pre></td></tr></table></figure><ul><li><p>æŸ¥çœ‹appçš„log<br><code>yarn logs -applicationId application_1452250357031_0175</code></p></li><li><p>set datanode æ—¥å¿—çº§åˆ«<br><code>hadoop daemonlog  -setlevel namenodeip:50070 datanode DEBUG</code><br>æˆ–è€… åœ¨hadoop-env.shä¸­æ·»åŠ <br><code>export HADOOP_ROOT_LOGGER=DEBUG,RFA</code></p></li><li><p>æŸ¥çœ‹sequenceæ–‡ä»¶<br><code> hadoop dfs -text sequenceFile</code></p></li><li><p>æŸ¥çœ‹å‹ç¼©æ–‡ä»¶<br>lzoæ–‡ä»¶(å…ˆæŒ‰ç…§lzopå‘½ä»¤) <code>hadoop fs -cat /user/2017-03-06/part-r-00255.lzo | lzop -dc | head -1</code><br>gzå‹ç¼© <code>hadoop fs -cat /tmp/temp.txt.gz | gzip -dâ€‹</code>  æˆ–è€… <code>hadoop fs -cat /tmp/temp.txt.gz | zcat</code>â€‹  </p></li><li><p>lzoå»ºç«‹ç´¢å¼•(æ–¹ä¾¿åˆ‡åˆ†å¤šä¸ªsplitï¼Œä¼šåœ¨å½“å‰hdfsç›®å½•ä¸‹åˆ›å»ºä¸€ä¸ª.indexæ–‡ä»¶)<br><code>hadoop jar lib/hadoop-lzo-0.4.15.jar com.hadoop.compression.lzo.DistributedLzoIndexer /user/news_74_8000_201705091820.lzo</code></p></li></ul><h2 id="kafka-amp-zkå‘½ä»¤"><a href="#kafka-amp-zkå‘½ä»¤" class="headerlink" title="kafka&amp;zkå‘½ä»¤"></a>kafka&amp;zkå‘½ä»¤</h2><ul><li><p>å¯åŠ¨kafka<br><code>nohup bin/kafka-server-start.sh config/server.properties &amp;</code><br><code>bin/kafka-server-start.sh -daemon config/server.properties</code></p></li><li><p>åœæ­¢Kafka<br><code>bin/bin/kafka-server-stop.sh</code></p></li><li><p>åˆ—å‡ºkafkaçš„topic<br><code>bin/kafka-topics.sh --list --zookeeper 127.0.0.1:2181,10.xx:2181,10.xx:2181</code></p></li><li><p>åˆ›å»ºtopic<br><code>bin/kafka-topics.sh --create --zookeeper 127.0.0.1:2181,10.xx:2181,10.xx:2181 --topic test --partitions 3 --replication-factor 2</code></p></li><li><p>å¢åŠ topicçš„partitions<br><code>bin/kafka-topics.sh --zookeeper 127.0.0.1:2181 --alter --topic three_replica --partitions 5</code> </p></li><li><p>topicçš„æè¿°ä¿¡æ¯<br><code>bin/kafka-topics.sh --describe --zookeeper 10.xx:2181,10.xx:2181,10.xx:2181 --topic test</code></p></li><li><p>å‘½ä»¤è¡Œç”Ÿäº§æ¶ˆæ¯<br><code>bin/kafka-console-producer.sh --broker-list 127.0.0.1:9092,10.xx:9092,10.xx:9092 --topic test</code></p></li><li><p>å‘½ä»¤è¡Œæ¶ˆè´¹æ¶ˆæ¯<br><code>bin/kafka-console-consumer.sh --zookeeper 127.0.0.1:2181,10.xx:2181,10.1xx:2181 --topic test --from-beginning</code></p></li><li><p>è·å–topic offsetçš„æœ€å°å€¼<br><code>bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list 127.0.0.1:9092,10.xx:9092,10.xx:9092 -topic test --time -2</code></p></li><li><p>è·å–topic offsetçš„æœ€å¤§å€¼<br><code>bin/kafka-run-class.sh kafka.tools.GetOffsetShell --broker-list 127.0.0.1:9092,10.xx:9092,10.xx:9092 -topic test --time -1</code></p></li><li><p>æ‰“å¼€zkå®¢æˆ·ç«¯<br><code>bin/zkCli.sh -server xxx:2181,xx:2181</code></p></li><li><p>åˆ é™¤zkä¸ŠèŠ‚ç‚¹</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">delete /path  //åˆ é™¤æŒ‡å®šèŠ‚ç‚¹ï¼Œåªèƒ½åˆ é™¤éç©ºèŠ‚ç‚¹</span><br><span class="line">rmr /path    //åˆ é™¤pathèŠ‚ç‚¹åŠå­èŠ‚ç‚¹</span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹zkç›®å½•</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ls /      //ä½¿ç”¨lsæŸ¥çœ‹å½“å‰zookeeperä¸­æ‰€åŒ…å«çš„å†…å®¹</span><br><span class="line">ls2 /     //æŸ¥çœ‹å½“å‰èŠ‚ç‚¹æ•°æ®å¹¶èƒ½çœ‹åˆ°æ›´æ–°æ¬¡æ•°ç­‰æ•°æ®</span><br></pre></td></tr></table></figure><ul><li><p>æŸ¥çœ‹zkä¸­å“ªä¸ªæ˜¯leaderåŠfollower<br><code>for i in &#123;55..57&#125;;do echo stat | nc 10.102.143.$i 2181;done</code></p></li><li><p>zk</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> dump| nc 127.0.0.1 2181  //åˆ—å‡ºæœªç»å¤„ç†çš„ä¼šè¯å’Œä¸´æ—¶èŠ‚ç‚¹</span><br><span class="line"><span class="built_in">echo</span> conf | nc 127.0.0.1 2181  //è¾“å‡ºç›¸å…³æœåŠ¡é…ç½®çš„è¯¦ç»†ä¿¡æ¯</span><br></pre></td></tr></table></figure><h2 id="rediså‘½ä»¤"><a href="#rediså‘½ä»¤" class="headerlink" title="rediså‘½ä»¤"></a>rediså‘½ä»¤</h2><ul><li>redis-cli è¿›å…¥</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-cli  <span class="comment"># localhost</span></span><br><span class="line">redis-cli -h hostname -p port -a password</span><br></pre></td></tr></table></figure><p>è¿›å…¥ä¹‹åä½¿ç”¨<code>ping</code>å‘½ä»¤æµ‹è¯•ä¸‹é“¾æ¥æ˜¯å¦æˆåŠŸï¼Œè¿”å›<code>PONG</code>è¡¨ç¤ºé“¾æ¥æˆåŠŸã€‚</p><ul><li>æŸ¥çœ‹redisä¸­çš„key</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ keys * <span class="comment"># redis ä¸­æ‰€æœ‰çš„key</span></span><br><span class="line">$ keys h*  <span class="comment"># redis ä¸­hå¼€å¤´çš„æ‰€æœ‰key</span></span><br><span class="line">$ randomkey  <span class="comment"># éšæœºæ˜¾ç¤ºä¸€ä¸ªkey</span></span><br></pre></td></tr></table></figure><p>åœ¨clientä¸­ä½¿ç”¨ä¸Šè¿°å‘½ä»¤æ—¶ï¼Œæœ‰å¯èƒ½ä¼šæŠ¥<code>Error: Server closed the connection</code>ï¼Œå¯¼è‡´å‘½ä»¤æ— æ³•ä½¿ç”¨ï¼Œä½†å…¶å®ƒå‘½ä»¤æ­£å¸¸ï¼Œå¦‚lrangeã€‚</p><ul><li>æŸ¥çœ‹keyçš„æ•°æ®ç±»å‹</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ <span class="built_in">type</span> xx:xx  <span class="comment"># xx:xx ä¸ºkey</span></span><br></pre></td></tr></table></figure><ul><li>ä½¿ç”¨scanæŸ¥çœ‹åŒ¹é…key</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SCAN cursor [MATCH pattern] [COUNT count] </span></span><br><span class="line">scan 107102208 MATCH net:20170830:V* COUNT 1000</span><br><span class="line"><span class="comment">#æ³¨æ„ï¼šè¿”å›çš„æ¸¸æ ‡ä¸ä¸€å®šæ˜¯é€’å¢çš„ï¼Œå¯èƒ½åä¸€æ¬¡è¿”å›çš„æ¸¸æ ‡æ¯”å‰ä¸€æ¬¡çš„å°ã€‚</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹listä¸­keyå¯¹åº”çš„å€¼</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ lrange top:article 1 2   <span class="comment"># æ˜¾ç¤ºkeyä¸ºtop:articleçš„listä¸­startç´¢å¼•ä¸º1åˆ°endç´¢å¼•ä¸º2çš„æ•°æ®</span></span><br><span class="line">1) <span class="string">&quot;&#123;\&quot;id\&quot;:\&quot;CS25FCED05148UNS\&quot;,\&quot;value\&quot;:[3873,11,64096,0,0,0]&#125;&quot;</span></span><br><span class="line">2) <span class="string">&quot;&#123;\&quot;id\&quot;:\&quot;CS2EK6TU0001875P\&quot;,\&quot;value\&quot;:[3850,10,94762,0,0,0]&#125;&quot;</span></span><br></pre></td></tr></table></figure><ul><li>æŸ¥çœ‹hashæ‰€æœ‰çš„key/value</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$ hgetall xx:xx <span class="comment"># xx:xx ä¸ºkey</span></span><br><span class="line">1) key1        <span class="comment"># hashä¸­çš„key</span></span><br><span class="line">2) value1      <span class="comment"># hashä¸­çš„value</span></span><br></pre></td></tr></table></figure><!-- redis-cli -h 10.160.249.83 -p 6379 keys net:20170830:0503* | head -10 --><h3 id="redis-clusterå‘½ä»¤"><a href="#redis-clusterå‘½ä»¤" class="headerlink" title="redis clusterå‘½ä»¤"></a>redis clusterå‘½ä»¤</h3><ul><li>è¿æ¥å®¢æˆ·ç«¯å‘½ä»¤<br><code>redis-cli -h ip -p port -c</code></li></ul>]]></content>
      
      
      <categories>
          
          <category> Hadoop </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hadoop </tag>
            
            <tag> BigData </tag>
            
            <tag> HDFS </tag>
            
            <tag> read </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Javaè®¾è®¡æ¨¡å¼ä¹‹Builderæ¨¡å¼</title>
      <link href="/Builder%20%E6%A8%A1%E5%BC%8F.html"/>
      <url>/Builder%20%E6%A8%A1%E5%BC%8F.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨è¿™é‡Œæˆ‘æš‚æ—¶è¿™æ ·ç†è§£ï¼Œå°±æ˜¯æŠŠå¤æ‚å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹å’Œç»“æœè¿›è¡Œåˆ†ç¦»        ä¹Ÿå°±æ˜¯è§£è€¦</p><h2 id="Builderæ¨¡å¼æ¦‚å¿µ"><a href="#Builderæ¨¡å¼æ¦‚å¿µ" class="headerlink" title="Builderæ¨¡å¼æ¦‚å¿µ"></a>Builderæ¨¡å¼æ¦‚å¿µ</h2><p>The builder pattern is an object creation software design pattern. Unlike the abstract factory pattern and the factory method pattern whose intention is to enable polymorphism, the intention of the builder pattern is to find a solution to the telescoping constructor anti-pattern[citation needed]. The telescoping constructor anti-pattern occurs when the increase of object constructor parameter combination leads to an exponential list of constructors. Instead of using numerous constructors, the builder pattern uses another object, a builder, that receives each initialization parameter step by step and then returns the resulting constructed object at once. ï¼ˆä»£æ›¿æ„é€ å‡½æ•°ï¼‰</p><p>The builder pattern has another benefit. It can be used for objects that contain flat data (html code, SQL query, X.509 certificateâ€¦), that is to say, data that canâ€™t be easily edited. This type of data cannot be edited step by step and must be edited at once. The best way to construct such an object is to use a builder class.ï¼ˆåˆ›å»ºä¸å¯å˜å¯¹è±¡ï¼‰</p><p>å®šä¹‰<br>åŸæ–‡ â€“ The intent of the Builder design pattern is to separate the construction of a complex object from its representation. By doing so the same construction process can create different representations.   ï¼ˆfrom wikipediaï¼‰<br>è¯‘æ–‡ â€“ å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚</p><p>å®šä¹‰æœ‰ç‚¹æŠ½è±¡ï¼Œå…ˆæ¥çœ‹ä¸ªBuilderçš„ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„ä½¿ç”¨åœºæ™¯ â€”â€” ä½¿ç”¨Builderä»£æ›¿å…·æœ‰å¤šä¸ªå‚æ•°ï¼ˆ4ä¸ªä»¥ä¸Šï¼‰çš„æ„é€ å‡½æ•°</p><span id="more"></span><h3 id="åœºæ™¯ç®€ä»‹"><a href="#åœºæ™¯ç®€ä»‹" class="headerlink" title="åœºæ™¯ç®€ä»‹"></a>åœºæ™¯ç®€ä»‹</h3><blockquote><p>å¦‚ä¸€ä¸ªç±»è¡¨ç¤ºåŒ…è£…é£Ÿå“å¤–é¢æ˜¾ç¤ºçš„è¥å…»æˆåˆ†æ ‡ç­¾ï¼Œæ ‡ç­¾ä¸­æœ‰äº›åŸŸæ˜¯å¿…é¡»çš„ï¼Œä¸è¿‡æœ‰äº›ä¹Ÿæ˜¯å¯é€‰åŸŸã€‚å¤§å¤šæ•°äº§å“åœ¨æŸå‡ ä¸ªå¯é€‰åŸŸä¸­éƒ½æœ‰é0å€¼ã€‚å¯¹äºè¿™æ ·çš„ç±»ï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨é‡å æ„é€ å™¨ï¼ˆtelescoping sconstructorï¼‰æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼å°†ä¼šå‡ºç°è¿‡ä¸ªæ„é€ å‡½æ•°ï¼Œåˆ›å»ºå®ä¾‹çš„æ—¶å€™é€‰æ‹©åˆé€‚çš„æ„é€ å‡½æ•°ã€‚ä¾‹å¦‚å¦‚ä¸‹ä»£ç ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Telescoping constructor pattern - does not scale well!</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NutritionFacts</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;  <span class="comment">//(ml) required</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;     <span class="comment">//(per container) required</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> calories;     <span class="comment">//  optional</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> fat;              <span class="comment">//  optional</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> sodium;           <span class="comment">//  optional</span></span><br><span class="line">    privatefinalintcarbohydrate;        <span class="comment">//  optional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> calories)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, calories, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> calories, <span class="keyword">int</span> fat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, calories, fat, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> calories, <span class="keyword">int</span> fat, <span class="keyword">int</span> sodium)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, calories, fat, sodium, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings, <span class="keyword">int</span> calories, <span class="keyword">int</span> fat, <span class="keyword">int</span> sodium, <span class="keyword">int</span> carbohydrate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servingSize  = servingSize;</span><br><span class="line">        <span class="keyword">this</span>.servings = servings;</span><br><span class="line">        <span class="keyword">this</span>.calories = calories;</span><br><span class="line">        <span class="keyword">this</span>.fat = fat;</span><br><span class="line">        <span class="keyword">this</span>.sodium = sodium;</span><br><span class="line">        <span class="keyword">this</span>.carbohydrate = carbohydrate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ—¶å€™ä½¿ç”¨NutritionFacts nut = new NutritionFacts(xx, xx, xx, xx, 0, xx); è¿™æ ·çš„è¯å¯èƒ½å°±å­˜åœ¨ä½ ä¸æƒ³ç»™sodiumèµ‹å€¼ï¼Œä½†æ˜¯ä½ åˆå¾—ç»™carbohydrateèµ‹å€¼ï¼Œå°±å¯¼è‡´ä½ å¿…é¡»ç»™sodiumä¼ å…¥0ã€‚å¦‚æœå‚æ•°æ•°ç›®æ›´å¤šçš„è¯ï¼Œè¿™ç§æƒ…å†µæ›´ç³Ÿç³•ï¼Œéš¾ä»¥æ§åˆ¶ï¼Œè€Œä¸”å½“ä½ ä¼ å‚çš„é¡ºåºå¼„é”™æ—¶ï¼Œå¹¶ä¸ä¼šæç¤ºé”™è¯¯ï¼Œä½†è¿è¡Œå¯èƒ½ä¼šæŠ¥é”™ï¼Œå¯¹åˆ«äººçš„å¯è¯»æ€§ä¹Ÿä¸é«˜ã€‚</p><h2 id="JavaBeansæ¨¡å¼"><a href="#JavaBeansæ¨¡å¼" class="headerlink" title="JavaBeansæ¨¡å¼"></a>JavaBeansæ¨¡å¼</h2><p>å…ˆæ¥çœ‹ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆ â€”â€” JavaBeansæ¨¡å¼</p><p>JavaBeansæ¨¡å¼æ˜¯è°ƒç”¨ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å±æ€§çš„setteræ–¹æ³•å¯¹æ¯ä¸ªå±æ€§èµ‹å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JavaBeans Pattern - allows inconsistency, mandates mutability</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NutritionFacts</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Parameters initialized to default values (if any)</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> servingSize = -<span class="number">1</span>; <span class="comment">// Required; no default value</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> servings=-<span class="number">1</span>;<span class="comment">//&quot;&quot;&quot;&quot;</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> calories=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> fat=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> sodium=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> carbohydrate = <span class="number">0</span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">   <span class="comment">// Setters  æ±‰å­</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServingSize</span><span class="params">(<span class="keyword">int</span> val)</span>  </span>&#123; servingSize = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServings</span><span class="params">(<span class="keyword">int</span> val)</span>    </span>&#123; servings = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCalories</span><span class="params">(<span class="keyword">int</span> val)</span>    </span>&#123; calories = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFat</span><span class="params">(<span class="keyword">int</span> val)</span>         </span>&#123; fat = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSodium</span><span class="params">(<span class="keyword">int</span> val)</span>      </span>&#123; sodium = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCarbohydrate</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123; carbohydrate = val; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç æ¯”ä½¿ç”¨é‡å æ„é€ å‡½æ•°çš„ä»£ç ç®€å•äº†ç‚¹ï¼Œé˜…è¯»ä¹Ÿè¾ƒä¸ºå®¹æ˜“ï¼Œä½†æ˜¯è°ƒç”¨æ–¹æ³•ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NutritionFacts cocaCola = <span class="keyword">new</span> NutritionFacts();</span><br><span class="line">cocaCola.setServingSize(<span class="number">240</span>);</span><br><span class="line">cocaCola.setServings(<span class="number">8</span>);</span><br><span class="line">cocaCola.setCalories(<span class="number">100</span>);</span><br><span class="line">cocaCola.setSodium(<span class="number">35</span>);</span><br><span class="line">cocaCola.setCarbohydrate(<span class="number">27</span>);</span><br></pre></td></tr></table></figure><p>è¿™ç§æ¨¡å¼å¼¥è¡¥äº†é‡å æ„é€ å‡½æ•°çš„ä¸è¶³ï¼Œä½¿ä»£ç ç®€å•ï¼Œå¯é˜…è¯»ï¼›ä½†æ˜¯åœ¨è°ƒç”¨æ—¶è¦å…ˆnewä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ— æ³•ä¿è¯æˆ‘ä»¬åœ¨ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ä¹‹å‰å·²ç»å¯¹ç›¸åº”çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚</p><p>JavaBeansæ¨¡å¼çš„ç¼ºç‚¹æ˜¯ï¼šä½¿å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹åˆ†åˆ°å‡ ä¸ªè°ƒç”¨ä¸­ï¼Œåœ¨æ„é€ è¿‡ç¨‹ä¸­å¯èƒ½å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚ç±»æ— æ³•ä»…ä»…é€šè¿‡æ£€éªŒæ„é€ å™¨å‚æ•°çš„æœ‰æ•ˆæ€§æ¥ä¿è¯ä¸€è‡´æ€§ã€‚è¯•å›¾ä½¿ç”¨å¤„äºä¸ä¸€è‡´çŠ¶æ€çš„å¯¹è±¡ï¼Œå°†ä¼šå¯¼è‡´å¤±è´¥ã€‚è¿™ç§å¤±è´¥ä¸åŒ…å«é”™è¯¯çš„ä»£ç å¤§ç›¸åŠ²åº­ï¼Œå› ä¸ºå…¶è°ƒè¯•èµ·æ¥ååˆ†å›°éš¾ã€‚JavaBeansä¸èƒ½åˆ›å»ºä¸å¯å˜çš„å®ä¾‹ï¼Œå› ä¸ºéœ€è¦ä½ ä»˜å‡ºé¢å¤–çš„ä»£ä»·æ¥ä¿è¯è¿™ä¸ªç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h2 id="Builderæ¨¡å¼"><a href="#Builderæ¨¡å¼" class="headerlink" title="Builderæ¨¡å¼"></a>Builderæ¨¡å¼</h2><p>ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆ â€”â€” Builderæ¨¡å¼</p><p>æ—¢èƒ½ä¿è¯å‘é‡å æ„é€ å™¨æ¨¡å¼é‚£æ ·çš„å®‰å…¨æ€§ï¼Œä¹Ÿèƒ½ä¿è¯å‘JavaBeansæ¨¡å¼é‚£ä¹ˆå¥½çš„å¯è¯»æ€§ã€‚è¿™å°±æ˜¯Buildeæ¨¡å¼çš„ä¸€ç§å½¢å¼ã€‚ä¸ç›´æ¥ç”Ÿæˆæƒ³è¦çš„å¯¹è±¡ï¼Œè€Œæ˜¯è®©å®¢æˆ·ç«¯åˆ©ç”¨æ‰€æœ‰å¿…è¦çš„å‚æ•°è°ƒç”¨æ„é€ å™¨æˆ–è€…é™æ€å·¥å‚ï¼Œå¾—åˆ°ä¸€ä¸ªbuilderå¯¹è±¡ã€‚ç„¶åå®¢æˆ·ç«¯åœ¨builderä¸Šè°ƒç”¨ç±»ä¼¼setterçš„æ–¹æ³•æ¥è®¾ç½®æ¯ä¸ªç›¸å…³çš„å¯é€‰å‚æ•°ã€‚æœ€åå®¢æˆ·ç«¯è°ƒç”¨æ— å‚çš„buildæ–¹æ³•æ¥ç”Ÿæˆä¸å¯å˜çš„å¯¹è±¡ã€‚è¿™ä¸ªbuilderæ˜¯å®ƒæ„é€ çš„ç±»çš„é™æ€çš„æˆå‘˜ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Builder Pattern</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NutritionFacts</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> calories;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> fat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> sodium;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> carbohydrate;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Required parameters</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;</span><br><span class="line">    <span class="comment">// Optional parameters - initialized to default values</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> calories = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fat = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> carbohydrate = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> sodium = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servingSize = servingSize;</span><br><span class="line">        <span class="keyword">this</span>.servings = servings;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">calories</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; calories = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">fat</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; fat = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">carbohydrate</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; carbohydrate = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">sodium</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; sodium = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> NutritionFacts <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NutritionFacts(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NutritionFacts</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">        servingSize = builder.servingSize;</span><br><span class="line">        servings = builder.servings;</span><br><span class="line">        calories = builder.calories;</span><br><span class="line">        fat = builder.fat;</span><br><span class="line">        sodium = builder.sodium;</span><br><span class="line">        carbohydrate = builder.carbohydrate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ—¶æ˜¯è¿™æ ·çš„ï¼š<br><code>NutritionFacts cocaCola = new NutritionFacts.Builder(240, 8).calories(100).sodium(35).carbohydrate(27).build();</code></p><p>å°±åƒæ„é€ å™¨é‚£æ ·ï¼Œbuilder å¯ä»¥å¼ºåŠ ç»™å®ƒçš„å‚æ•°å˜é‡ï¼ˆè¿™ä¸ªå¼ºåŠ çš„å‚æ•°å˜é‡å¯ä»¥ä½œä¸ºåˆ›å»ºå¯¹è±¡çš„å¿…é¡»å‚æ•°ï¼‰ï¼Œbuild æ–¹æ³•å®ä¾‹åŒ–å®ä½“ç±»ï¼Œå®ä¾‹åŒ–å‰ï¼Œå¯ä»¥å¯¹å‚æ•°è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œåº”è¯¥æŠ›å‡º IllegalStateExceptionï¼Œæˆ–è€…å…¶ä»–è‡ªå®šä¹‰å¼‚å¸¸ã€‚<br>å¦å¤–ä¸€ä¸ªå°ä¼˜ç‚¹æ˜¯ builder å¯ä»¥æœ‰å¤šä¸ªå¯å˜å‚æ•°ã€‚æ„é€ å™¨ï¼Œåƒæ–¹æ³•ä¸€æ ·ï¼Œå¯èƒ½åªæœ‰ä¸€ä¸ªå¯å˜å‚æ•°ã€‚å› ä¸º builder ç”¨ä¸åŒçš„æ–¹æ³•è®¾ç½®å‚æ•°ï¼Œåªè¦ä½ å–œæ¬¢ï¼Œä»–ä»¬å¯ä»¥æœ‰å¾ˆå¤šå¯å˜å‚æ•°ã€‚</p><p>ä»£ç ä¸­NutritionFactsç±»ä¸­å±æ€§éƒ½æ˜¯finalç±»å‹çš„ï¼Œè¿™æ˜¯å¿…é¡»çš„å‘¢è¿˜æ˜¯åªæ˜¯ä¸ºäº†è®©å¯¹è±¡å®ä¾‹ä¸€æ—¦åˆ›å»ºï¼Œå…¶çŠ¶æ€å°±ä¸èƒ½åœ¨æ”¹å˜ã€‚è€ŒJavaBeanså´æ— æ³•åˆ›å»ºè¿™ç§ä¸å¯å˜å¯¹è±¡ã€‚</p><p>ä¸JavaBeansçš„åŒºåˆ«å…¶å®æ˜¯åœ¨äºçœŸæ­£æ„é€ å¯¹è±¡çš„æ—¶é—´ç‚¹ä¸Šã€‚å…¶å®Builderå¹¶æ²¡æœ‰æå‰æŠŠå¯¹è±¡æ„é€ å‡ºæ¥ç„¶åå†ä¸€ä¸ªä¸ªåœ°å¯¹å‚æ•°è¿›è¡Œè®¾ç½®ï¼Œè€Œæ˜¯å…ˆè®¾å®šå€¼ï¼Œå†åœ¨æœ€åçš„build()æ–¹æ³•ä¸­æ„å»ºå‡ºå¯¹è±¡ã€‚è¿™æ ·åœ¨ä¸€äº›å‚æ•°å­˜åœ¨ä¾èµ–å…³ç³»çš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³ä¾èµ–çš„é—®é¢˜ã€‚å½“ç„¶ï¼Œå¯¹äºå‚æ•°çš„ä¼ é€’ä¹Ÿä¸ä¸€å®šè¦æŒ‰ç…§ä¸Šé¢å†™çš„æ–¹å¼ï¼ŒSetterå…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå…¶æ€æƒ³ä¸åœ¨äºæ¨¡æ‹ŸæŒ‰åå­—ä¼ é€’å‚æ•°ï¼Œåœ¨äºåé¢çš„build()ã€‚</p><p>ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBuilderæ¨¡å¼å¤šæ•°æ˜¯ç”¨äºå¯¹è±¡æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥é€æ­¥å»æ„å»ºçš„æ—¶å€™ï¼Œå…¶æ ¸å¿ƒåœ¨äºå°†ç±»çš„æ„å»ºé€»è¾‘è½¬ç§»åˆ°ç±»çš„å®ä¾‹åŒ–å¤–éƒ¨ã€‚å…¶ç»å…¸åº”ç”¨æ˜¯ä»ä¸€æ®µæ–‡æœ¬ä¸­æ„å»ºå¯¹è±¡ï¼Œå› ä¸ºæ–‡æœ¬çš„è¯»å…¥æ˜¯ä»¥æµçš„å½¢å¼ï¼Œé‚£ä¹ˆä¸€å¼€å§‹çš„æ—¶å€™å¯èƒ½æ²¡æœ‰åŠæ³•åˆ›å»ºå®Œæ•´çš„ç›®æ ‡å¯¹è±¡ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨æ„å»ºè€…æ¨¡å¼æ¥è¿›è¡Œæ„å»ºã€‚ä½†æ˜¯åœ¨æ³¨é‡æ€§èƒ½çš„ç¯å¢ƒä¸‹ï¼Œæ¯æ¬¡åˆ›å»ºå®ä¾‹éƒ½å¿…é¡»å…ˆåˆ›å»ºBuilderæ„é€ å™¨ä¹Ÿä¼šæ˜¯ä¸€ç¬”å¼€é”€ï¼Œè€Œä¸”ä»£ç ä¹Ÿæœ‰ç‚¹å†—é•¿ã€‚æ€»çš„æ¥è¯´å¦‚æœç±»æœ‰å¤šä¸ªå±æ€§éœ€è¦å¤šä¸ªæ„é€ å‡½æ•°ï¼ŒBuilderæ¨¡å¼è¿˜æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><h2 id="Builderéƒ¨ä»¶è§£æ"><a href="#Builderéƒ¨ä»¶è§£æ" class="headerlink" title="Builderéƒ¨ä»¶è§£æ"></a>Builderéƒ¨ä»¶è§£æ</h2><p>å†å›åˆ°Builderçš„å®šä¹‰ï¼Œå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚åœ¨è¿™é‡Œæˆ‘æš‚æ—¶è¿™æ ·ç†è§£ï¼Œå°±æ˜¯æŠŠå¤æ‚å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹å’Œç»“æœè¿›è¡Œåˆ†ç¦»ã€‚Builderçš„umlå›¾ä¸ºï¼š<br><img src="/blogimgs/Builder%E6%A8%A1%E5%BC%8F/builderuml.png" alt="Builder umlå›¾" title="Builder umlå›¾"><br>æœ‰ç‚¹ç±»ä¼¼å·¥å‚æ¨¡å¼ï¼Œå…¶ä¸­</p><ul><li>Builderï¼šç”Ÿæˆå™¨æ¥å£ï¼Œå®šä¹‰åˆ›å»ºä¸€ä¸ªProductå¯¹è±¡æ‰€éœ€è¦çš„å„ä¸ªéƒ¨ä»¶çš„æ“ä½œã€‚</li><li>ConcreteBuilderï¼šå…·ä½“çš„ç”Ÿæˆå™¨å®ç°ï¼Œå®ç°å„ä¸ªéƒ¨ä»¶çš„åˆ›å»ºï¼Œå¹¶è´Ÿè´£ç»„è£…Productå¯¹è±¡çš„å„ä¸ªéƒ¨ä»¶ï¼ŒåŒæ—¶è¿˜æä¾›ä¸€ä¸ªè®©ç”¨æˆ·è·å–ç»„è£…å®Œæˆåçš„äº§å“å¯¹è±¡çš„æ–¹æ³•ã€‚</li><li>Directorï¼šæŒ‡å¯¼è€…ï¼Œä¹Ÿè¢«ç§°å¯¼å‘è€…ï¼Œä¸»è¦ç”¨æ¥ä½¿ç”¨Builderæ¥å£ï¼Œä»¥ä¸€ä¸ªç»Ÿä¸€çš„è¿‡ç¨‹æ¥æ„å»ºæ‰€éœ€è¦çš„Productå¯¹è±¡ã€‚</li><li>Productï¼šäº§å“ï¼Œè¡¨ç¤ºè¢«ç”Ÿæˆå™¨æ„å»ºçš„å¤æ‚å¯¹è±¡ï¼ŒåŒ…å«å¤šä¸ªéƒ¨ä»¶ã€‚</li></ul><p>çœ‹äº†ä¸Šé¢çš„umlå›¾å’Œå„ä¸ªéƒ¨ä»¶çš„è§£é‡Šï¼Œå¯èƒ½å°±ä¼šäº§ç”Ÿç–‘é—®äº†ï¼Œä¸Šé¢çš„ä½¿ç”¨Builderä»£æ›¿æ„é€ å‡½æ•°çš„åœºæ™¯ä¸­ä½¿ç”¨çš„è§’è‰²å’ŒUMLä¸­çš„è§’è‰²ä¸å¯¹ç§°äº†ï¼Œä¸è¦ç€æ€¥ï¼Œä¸‹é¢è¿›è¡Œè§£é‡Šï¼š</p><p>ä¸Šé¢çš„ä½¿ç”¨åœºæ™¯æ¯”è¾ƒæ˜ç¡®ï¼Œå°±æ˜¯åˆ›å»ºæŸä¸ªå¤åˆ¶å¯¹è±¡ï¼Œå¯ä»¥è¿›è¡Œé€‚å½“çš„ç®€åŒ–ã€‚å…¶ä¸­Builderæ¨¡å¼åªæ˜¯ç”¨æ¥åˆ›å»ºæŸä¸ªå¯¹è±¡ï¼Œåˆ™å°±æ²¡æœ‰å¿…è¦å®šä¹‰Builderçš„æ¥å£ï¼Œç›´æ¥æä¾›ä¸€ä¸ªå…·ä½“çš„ConcreteBuilderå°±è¡Œï¼›å¦‚æœåªåˆ›å»ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œä¸å¯èƒ½ä¼šæœ‰å¾ˆå¤šç§ä¸åŒçš„é€‰æ‹©å’Œæ­¥éª¤ï¼Œå¯¼æ¼”ç±»Directorå°±å¯ä»¥å¹²æ‰äº†ï¼Œå°†å…¶åŠŸèƒ½ä¸Clientçš„åŠŸèƒ½åˆå¹¶ï¼Œä½¿Clientå…·å¤‡Directorçš„åŠŸèƒ½ï¼Œæ¥æŒ‡å¯¼æ„å»ºå™¨æ¥æ„å»ºéœ€è¦çš„å¤æ‚å¯¹è±¡ã€‚</p><h2 id="Builderæ¨¡å¼çš„åŠŸèƒ½"><a href="#Builderæ¨¡å¼çš„åŠŸèƒ½" class="headerlink" title="Builderæ¨¡å¼çš„åŠŸèƒ½"></a>Builderæ¨¡å¼çš„åŠŸèƒ½</h2><p>ç”Ÿæˆå™¨æ¨¡å¼çš„ä¸»è¦åŠŸèƒ½æ˜¯æ„å»ºå¤æ‚çš„äº§å“ï¼Œè€Œä¸”æ˜¯ç»†åŒ–çš„ï¼Œåˆ†æ­¥éª¤çš„æ„å»ºäº§å“ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆå™¨æ¨¡å¼é‡åœ¨ä¸€æ­¥ä¸€æ­¥è§£å†³æ„é€ å¤æ‚å¯¹è±¡çš„é—®é¢˜ã€‚å¦‚æœä»…ä»…è¿™ä¹ˆè®¤çŸ¥ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½æ˜¯ä¸å¤Ÿçš„ã€‚<br>æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ„å»ºçš„è¿‡ç¨‹æ˜¯ç»Ÿä¸€çš„ã€å›ºå®šä¸å˜çš„ï¼Œå˜åŒ–çš„éƒ¨åˆ†æ”¾åˆ°ç”Ÿæˆå™¨éƒ¨åˆ†äº†ï¼Œåªè¦é…ç½®ä¸åŒçš„ç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆåŒæ ·çš„æ„å»ºè¿‡ç¨‹ï¼Œå°±èƒ½æ„å»ºå‡ºä¸åŒçš„äº§å“æ¥ã€‚ è¿™æ˜¯å¯¹å®šä¹‰ï¼ˆå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤º ï¼‰æ›´è¿›ä¸€æ­¥çš„è§£é‡Šã€‚</p><p>æ­£å¸¸çš„Builderæ¨¡å¼çš„ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š<br>1ã€ç”Ÿæˆå™¨æ¥å£å®šä¹‰çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * ç”Ÿæˆå™¨æ¥å£ï¼Œå®šä¹‰åˆ›å»ºä¸€ä¸ªäº§å“å¯¹è±¡æ‰€éœ€çš„å„ä¸ªéƒ¨ä»¶çš„æ“ä½œ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * ç¤ºæ„æ–¹æ³•ï¼Œæ„å»ºæŸä¸ªéƒ¨ä»¶ </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPart</span><span class="params">()</span></span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>2ã€å…·ä½“ç”Ÿæˆå™¨å®ç°çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å…·ä½“çš„ç”Ÿæˆå™¨å®ç°å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteBuilder</span> <span class="keyword">implements</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> Product resultProduct;  </span><br><span class="line">      </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * è·å–ç”Ÿæˆå™¨æœ€ç»ˆæ„å»ºçš„äº§å“å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> Product <span class="title">getResultProduct</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> resultProduct;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPart</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="comment">//æ„å»ºæŸä¸ªéƒ¨ä»¶çš„åŠŸèƒ½å¤„ç†  </span></span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>3ã€ç›¸åº”çš„äº§å“å¯¹è±¡æ¥å£çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * è¢«æ„å»ºçš„äº§å“å¯¹è±¡çš„æ¥å£ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Product</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//å®šä¹‰äº§å“çš„æ“ä½œ  </span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>4ã€æœ€åæ˜¯æŒ‡å¯¼è€…çš„å®ç°ç¤ºæ„ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æŒ‡å¯¼è€…ï¼ŒæŒ‡å¯¼ä½¿ç”¨ç”Ÿæˆå™¨çš„æ¥å£æ¥æ„å»ºäº§å“å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Director</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * æŒæœ‰å½“å‰éœ€è¦ä½¿ç”¨çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> Builder builder;  </span><br><span class="line">   </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„é€ æ–¹æ³•ï¼Œä¼ äººç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> builder </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Director</span><span class="params">(Builder builder)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.builder = builder;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * ç¤ºæ„æ–¹æ³•ï¼ŒæŒ‡å¯¼ç”Ÿæˆå™¨æ„å»ºæœ€ç»ˆçš„äº§å“å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">construct</span><span class="params">()</span></span>&#123;  </span><br><span class="line">         <span class="comment">//é€šè¿‡ä½¿ç”¨ç”Ÿæˆå™¨æ¥å£æ¥æ„å»ºæœ€ç»ˆçš„äº§å“å¯¹è±¡  </span></span><br><span class="line">         builder.buildPart();  </span><br><span class="line">     &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨åœºæ™¯â€“-å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶"><a href="#åº”ç”¨åœºæ™¯â€“-å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶" class="headerlink" title="åº”ç”¨åœºæ™¯â€“ å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶"></a>åº”ç”¨åœºæ™¯â€“ å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶</h2><p>åœ¨è®¨è®ºå·¥å‚æ–¹æ³•æ¨¡å¼çš„æ—¶å€™ï¼Œæä¾›äº†ä¸€ä¸ªå¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶ã€‚<br>å¯¹äºå¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶ï¼Œé€šå¸¸åœ¨å¯¼å‡ºæ•°æ®ä¸Šï¼Œä¼šæœ‰ä¸€äº›çº¦æŸçš„æ–¹å¼ï¼Œæ¯”å¦‚å¯¼å‡ºæˆæ–‡æœ¬æ ¼å¼ã€æ•°æ®åº“å¤‡ä»½å½¢å¼ã€Excelæ ¼å¼ã€Xmlæ ¼å¼ç­‰ã€‚<br>åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ç« èŠ‚é‡Œé¢ï¼Œè®¨è®ºå¹¶ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼æ¥è§£å†³äº†å¦‚ä½•é€‰æ‹©å…·ä½“å¯¼å‡ºæ–¹å¼çš„é—®é¢˜ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°æ¯ç§æ–¹å¼å…·ä½“å¦‚ä½•å®ç°ã€‚<br>æ¢å¥è¯è¯´ï¼Œåœ¨è®¨è®ºå·¥å‚æ–¹æ³•æ¨¡å¼çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰è®¨è®ºå¦‚ä½•å®ç°å¯¼å‡ºæˆæ–‡æœ¬ã€Xmlç­‰å…·ä½“æ ¼å¼ï¼Œæœ¬ç« å°±æ¥è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚<br>å¯¹äºå¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶ï¼Œé€šå¸¸å¯¹äºå…·ä½“çš„å¯¼å‡ºå†…å®¹å’Œæ ¼å¼æ˜¯æœ‰è¦æ±‚çš„ï¼ŒåŠ å…¥ç°åœ¨æœ‰å¦‚ä¸‹è¦æ±‚ï¼Œç®€å•æè¿°ä¸€ä¸‹ï¼š</p><ul><li>å¯¼å‡ºçš„æ–‡ä»¶ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆæ ¼å¼ï¼Œéƒ½åˆ†æˆ3ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯æ–‡ä»¶å¤´ã€æ–‡ä»¶ä½“ã€æ–‡ä»¶å°¾ã€‚</li><li>åœ¨æ–‡ä»¶å¤´éƒ¨åˆ†ï¼Œéœ€è¦æè¿°å¦‚ä¸‹ä¿¡æ¯ï¼šåˆ†å…¬å¸æˆ–è€…é—¨å¸‚ç¼–å·ã€å¯¼å‡ºæ•°æ®çš„æ—¥æœŸã€‚</li><li>åœ¨æ–‡ä»¶ä½“éƒ¨åˆ†ï¼Œéœ€è¦æè¿°å¦‚ä¸‹ä¿¡æ¯ï¼šè¡¨åç§°ï¼Œç„¶ååˆ†æ¡æè¿°æ•°æ®ã€‚</li><li>åœ¨æ–‡ä»¶å°¾éƒ¨åˆ†ï¼Œéœ€è¦æè¿°å¦‚ä¸‹ä¿¡æ¯ï¼šè¾“å‡ºäººã€‚</li></ul><p>1ã€ä¸‹é¢å°†æè¿°æ–‡ä»¶å„ä¸ªéƒ¨åˆ†çš„æ•°æ®å¯¹è±¡å®šä¹‰å‡ºæ¥<br>æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å¤´çš„å†…å®¹çš„å¯¹è±¡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å¤´çš„å†…å®¹çš„å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportHeaderModel</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * åˆ†å…¬å¸æˆ–è€…é—¨å¸‚ç¼–å· </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String depId;  </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * å¯¼å‡ºæ•°æ®çš„æ—¥æœŸ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String exportDate;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getDepId</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> depId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDepId</span><span class="params">(String depId)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.depId = depId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getExportDate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> exportDate;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExportDate</span><span class="params">(String exportDate)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.exportDate = exportDate;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>æè¿°è¾“å‡ºæ•°æ®çš„å¯¹è±¡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æè¿°è¾“å‡ºæ•°æ®çš„å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportDataModel</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * äº§å“ç¼–å· </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String productId;  </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * é”€å”®ä»·æ ¼ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">double</span> price;  </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * é”€å”®æ•°é‡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">double</span> amount;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getProductId</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> productId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProductId</span><span class="params">(String productId)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.productId = productId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> price;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(<span class="keyword">double</span> price)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.price = price;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getAmount</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> amount;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAmount</span><span class="params">(<span class="keyword">double</span> amount)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.amount = amount;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å°¾çš„å†…å®¹çš„å¯¹è±¡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å°¾çš„å†…å®¹çš„å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportFooterModel</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * è¾“å‡ºäºº </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String exportUser;  </span><br><span class="line">   </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getExportUser</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> exportUser;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExportUser</span><span class="params">(String exportUser)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.exportUser = exportUser;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>2ã€å®šä¹‰Builderæ¥å£ï¼Œä¸»è¦æ˜¯æŠŠå¯¼å‡ºå„ç§æ ¼å¼æ–‡ä»¶çš„å¤„ç†è¿‡ç¨‹çš„æ­¥éª¤å®šä¹‰å‡ºæ¥ï¼Œæ¯ä¸ªæ­¥éª¤è´Ÿè´£æ„å»ºæœ€ç»ˆå¯¼å‡ºæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * ç”Ÿæˆå™¨æ¥å£ï¼Œå®šä¹‰åˆ›å»ºä¸€ä¸ªè¾“å‡ºæ–‡ä»¶å¯¹è±¡æ‰€éœ€çš„å„ä¸ªéƒ¨ä»¶çš„æ“ä½œ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * æ„å»ºè¾“å‡ºæ–‡ä»¶çš„Headeréƒ¨åˆ† </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> ehm </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildHeader</span><span class="params">(ExportHeaderModel ehm)</span></span>;  </span><br><span class="line">       </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„å»ºè¾“å‡ºæ–‡ä»¶çš„Bodyéƒ¨åˆ† </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> mapData </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildBody</span><span class="params">(Map&lt;String,List&lt;ExportDataModel&gt;&gt; mapData)</span></span>;  </span><br><span class="line">       </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„å»ºè¾“å‡ºæ–‡ä»¶çš„Footeréƒ¨åˆ† </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> efm </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildFooter</span><span class="params">(ExportFooterModel efm)</span></span>;  </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>3ã€å…·ä½“çš„ç”Ÿæˆå™¨å®ç°ã€‚<br>å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶çš„çš„ç”Ÿæˆå™¨å®ç°ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å®ç°å¯¼å‡ºæ–‡ä»¶åˆ°æ–‡æœ¬æ–‡ä»¶çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxtBuilder</span> <span class="keyword">implements</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * ç”¨æ¥è®°å½•æ„å»ºçš„æ–‡ä»¶çš„å†…å®¹ï¼Œç›¸å½“äºäº§å“ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> StringBuffer buffer = <span class="keyword">new</span> StringBuffer();  </span><br><span class="line">       </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildHeader</span><span class="params">(ExportHeaderModel ehm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(ehm.getDepId()+<span class="string">&quot;,&quot;</span>+ehm.getExportDate()+<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildBody</span><span class="params">(Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">for</span>(String tablName : mapData.keySet())&#123;  </span><br><span class="line">               </span><br><span class="line">             <span class="comment">//å…ˆæ‹¼æ¥è¡¨å  </span></span><br><span class="line">             buffer.append(tablName+<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">             <span class="comment">//ç„¶åå¾ªç¯æ‹¼æ¥å…·ä½“æ•°æ®  </span></span><br><span class="line">             <span class="keyword">for</span>(ExportDataModel edm : mapData.get(tablName))&#123;  </span><br><span class="line">                 buffer.append(edm.getProductId()+<span class="string">&quot;,&quot;</span>+edm.getPrice()+<span class="string">&quot;,&quot;</span>+edm.getAmount()+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">             &#125;  </span><br><span class="line">         &#125;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildFooter</span><span class="params">(ExportFooterModel efm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(efm.getExportUser());  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> StringBuffer <span class="title">getResult</span><span class="params">()</span></span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> buffer;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>å¯¼å‡ºåˆ°Xmlæ–‡ä»¶çš„çš„ç”Ÿæˆå™¨å®ç°ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å®ç°å¯¼å‡ºæ–‡ä»¶åˆ°Xmlæ–‡ä»¶çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBuilder</span> <span class="keyword">implements</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * ç”¨æ¥è®°å½•æ„å»ºçš„æ–‡ä»¶çš„å†…å®¹ï¼Œç›¸å½“äºäº§å“ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> StringBuffer buffer = <span class="keyword">new</span> StringBuffer();  </span><br><span class="line">       </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildHeader</span><span class="params">(ExportHeaderModel ehm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(<span class="string">&quot;&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;&lt;Report&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;Header&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t\t&lt;DepId&gt;&quot;</span>+ehm.getDepId()+<span class="string">&quot;&lt;/DepId&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t\t&lt;ExportDate&gt;&quot;</span>+ehm.getExportDate()+<span class="string">&quot;&lt;/ExportDate&gt;\n&quot;</span>);  </span><br><span class="line">           </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;/Header&gt;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildBody</span><span class="params">(Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData)</span> </span>&#123;  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;Body&gt;\n&quot;</span>);  </span><br><span class="line">         <span class="keyword">for</span>(String tablName : mapData.keySet())&#123;  </span><br><span class="line">             <span class="comment">//å…ˆæ‹¼æ¥è¡¨å  </span></span><br><span class="line">             buffer.append(<span class="string">&quot;\t\t&lt;Datas TableName=\&quot;&quot;</span>+tablName+<span class="string">&quot;\&quot;&gt;\n&quot;</span>);  </span><br><span class="line">             <span class="comment">//ç„¶åå¾ªç¯æ‹¼æ¥å…·ä½“æ•°æ®  </span></span><br><span class="line">             <span class="keyword">for</span>(ExportDataModel edm : mapData.get(tablName))&#123;  </span><br><span class="line">                   </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t&lt;Data&gt;\n&quot;</span>);  </span><br><span class="line">                   </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t\t&lt;ProductId&gt;&quot;</span>+edm.getProductId()+<span class="string">&quot;&lt;/ProductId&gt;\n&quot;</span>);  </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t\t&lt;Price&gt;&quot;</span>+edm.getPrice()+<span class="string">&quot;&lt;/Price&gt;\n&quot;</span>);  </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t\t&lt;Amount&gt;&quot;</span>+edm.getAmount()+<span class="string">&quot;&lt;/Amount&gt;\n&quot;</span>);  </span><br><span class="line">                   </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t&lt;/Data&gt;\n&quot;</span>);  </span><br><span class="line">             &#125;  </span><br><span class="line">               </span><br><span class="line">             buffer.append(<span class="string">&quot;\t\t&lt;/Datas&gt;\n&quot;</span>);  </span><br><span class="line">         &#125;  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;/Body&gt;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildFooter</span><span class="params">(ExportFooterModel efm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;Footer&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t\t&lt;ExportUser&gt;&quot;</span>+efm.getExportUser()+<span class="string">&quot;&lt;/ExportUser&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;/Footer&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;&lt;/Report&gt;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> StringBuffer <span class="title">getResult</span><span class="params">()</span></span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> buffer;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>4ã€æŒ‡å¯¼è€…ã€‚æœ‰äº†å…·ä½“çš„ç”Ÿæˆå™¨å®ç°åï¼Œéœ€è¦ç”±æŒ‡å¯¼è€…æ¥æŒ‡å¯¼å®ƒè¿›è¡Œå…·ä½“çš„äº§å“æ„å»ºã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æŒ‡å¯¼è€…ï¼ŒæŒ‡å¯¼ä½¿ç”¨ç”Ÿæˆå™¨çš„æ¥å£æ¥æ„å»ºè¾“å‡ºçš„æ–‡ä»¶å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Director</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æŒæœ‰å½“å‰éœ€è¦çš„ä½¿ç”¨çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> Builder builder;  </span><br><span class="line">   </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„é€ æ–¹æ³•ï¼Œä¼ å…¥ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      *  </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> builder </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Director</span><span class="params">(Builder builder)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.builder = builder;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">construct</span><span class="params">(ExportHeaderModel ehm,  </span></span></span><br><span class="line"><span class="params"><span class="function">             Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData, ExportFooterModel efm)</span> </span>&#123;  </span><br><span class="line">   </span><br><span class="line">         <span class="comment">//1.å…ˆæ„å»ºHeader  </span></span><br><span class="line">         builder.buildHeader(ehm);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//2.ç„¶åæ„å»ºBody  </span></span><br><span class="line">         builder.buildBody(mapData);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//3.å†æ„å»ºFooter  </span></span><br><span class="line">         builder.buildFooter(efm);  </span><br><span class="line">     &#125;  </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>5ã€å®¢æˆ·ç«¯æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//å‡†å¤‡æµ‹è¯•æ•°æ®  </span></span><br><span class="line">        ExportHeaderModel ehm = <span class="keyword">new</span> ExportHeaderModel();  </span><br><span class="line">         ehm.setDepId(<span class="string">&quot;ä¸€åˆ†å…¬å¸&quot;</span>);  </span><br><span class="line">         ehm.setExportDate(<span class="string">&quot;2010-05-18&quot;</span>);  </span><br><span class="line">           </span><br><span class="line">         Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData = <span class="keyword">new</span> HashMap&lt;String, List&lt;ExportDataModel&gt;&gt;  </span><br><span class="line">         List&lt;ExportDataModel&gt; col = <span class="keyword">new</span> ArrayList&lt;ExportDataModel&gt;();  </span><br><span class="line">           </span><br><span class="line">         ExportDataModel edm1 = <span class="keyword">new</span> ExportDataModel();  </span><br><span class="line">         edm1.setProductId(<span class="string">&quot;äº§å“001å·&quot;</span>);  </span><br><span class="line">         edm1.setPrice(<span class="number">100</span>);  </span><br><span class="line">         edm1.setAmount(<span class="number">80</span>);  </span><br><span class="line">           </span><br><span class="line">         ExportDataModel edm2 = <span class="keyword">new</span> ExportDataModel();  </span><br><span class="line">         edm2.setProductId(<span class="string">&quot;äº§å“002å·&quot;</span>);  </span><br><span class="line">         edm2.setPrice(<span class="number">120</span>);  </span><br><span class="line">         edm2.setAmount(<span class="number">280</span>);  </span><br><span class="line">           </span><br><span class="line">         ExportDataModel edm3 = <span class="keyword">new</span> ExportDataModel();  </span><br><span class="line">         edm3.setProductId(<span class="string">&quot;äº§å“003å·&quot;</span>);  </span><br><span class="line">         edm3.setPrice(<span class="number">320</span>);  </span><br><span class="line">         edm3.setAmount(<span class="number">380</span>);  </span><br><span class="line">           </span><br><span class="line">         col.add(edm1);  </span><br><span class="line">         col.add(edm2);  </span><br><span class="line">         col.add(edm3);  </span><br><span class="line">           </span><br><span class="line">         mapData.put(<span class="string">&quot;é”€å”®è®°å½•è¡¨&quot;</span>, col);  </span><br><span class="line">           </span><br><span class="line">         ExportFooterModel efm = <span class="keyword">new</span> ExportFooterModel();  </span><br><span class="line">         efm.setExportUser(<span class="string">&quot;å¼ ä¸‰&quot;</span>);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//æµ‹è¯•è¾“å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶  </span></span><br><span class="line">         TxtBuilder txtBuilder = <span class="keyword">new</span> TxtBuilder();  </span><br><span class="line">         <span class="comment">//åˆ›å»ºæŒ‡å¯¼è€…å¯¹è±¡  </span></span><br><span class="line">         Director director = <span class="keyword">new</span> Director(txtBuilder);  </span><br><span class="line">         director.construct(ehm, mapData, efm);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//æŠŠè¦è¾“å‡ºçš„å†…å®¹è¾“å‡ºåˆ°æ§åˆ¶å°çœ‹çœ‹  </span></span><br><span class="line">         System.out.println(<span class="string">&quot;è¾“å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶çš„å†…å®¹:&quot;</span>+txtBuilder.getResult().toString());  </span><br><span class="line">           </span><br><span class="line">         XmlBuilder xmlBuilder = <span class="keyword">new</span> XmlBuilder();  </span><br><span class="line">         Director director2 = <span class="keyword">new</span> Director(xmlBuilder);  </span><br><span class="line">         director2.construct(ehm, mapData, efm);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//æŠŠè¦è¾“å‡ºçš„å†…å®¹è¾“å‡ºåˆ°æ§åˆ¶å°çœ‹çœ‹  </span></span><br><span class="line">         System.out.println(<span class="string">&quot;è¾“å‡ºåˆ°Xmlæ–‡ä»¶çš„å†…å®¹:&quot;</span>+xmlBuilder.getResult().toString());  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½"><a href="#ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½" class="headerlink" title="ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½"></a>ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½</h2><p>ç”Ÿæˆå™¨æ¨¡å¼çš„ä¸»è¦åŠŸèƒ½æ˜¯æ„å»ºå¤æ‚çš„äº§å“ï¼Œè€Œä¸”æ˜¯ç»†åŒ–çš„ï¼Œåˆ†æ­¥éª¤çš„æ„å»ºäº§å“ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆå™¨æ¨¡å¼é‡åœ¨ä¸€æ­¥ä¸€æ­¥è§£å†³æ„é€ å¤æ‚å¯¹è±¡çš„é—®é¢˜ã€‚å¦‚æœä»…ä»…è¿™ä¹ˆè®¤çŸ¥ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½æ˜¯ä¸å¤Ÿçš„ã€‚<br>æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ„å»ºçš„è¿‡ç¨‹æ˜¯ç»Ÿä¸€çš„ã€å›ºå®šä¸å˜çš„ï¼Œå˜åŒ–çš„éƒ¨åˆ†æ”¾åˆ°ç”Ÿæˆå™¨éƒ¨åˆ†äº†ï¼Œåªè¦é…ç½®ä¸åŒçš„ç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆåŒæ ·çš„æ„å»ºè¿‡ç¨‹ï¼Œå°±èƒ½æ„å»ºå‡ºä¸åŒçš„äº§å“æ¥ã€‚</p><p>##å‚è€ƒ<br><a href="http://blog.csdn.net/top_code/article/details/8469297">http://blog.csdn.net/top_code/article/details/8469297</a><br><a href="https://en.wikipedia.org/wiki/Builder_pattern">https://en.wikipedia.org/wiki/Builder_pattern</a></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> Builder </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Builder æ¨¡å¼</title>
      <link href="/test.html"/>
      <url>/test.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨è¿™é‡Œæˆ‘æš‚æ—¶è¿™æ ·ç†è§£ï¼Œå°±æ˜¯æŠŠå¤æ‚å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹å’Œç»“æœè¿›è¡Œåˆ†ç¦»        ä¹Ÿå°±æ˜¯è§£è€¦</p><h2 id="Builderæ¨¡å¼æ¦‚å¿µ"><a href="#Builderæ¨¡å¼æ¦‚å¿µ" class="headerlink" title="Builderæ¨¡å¼æ¦‚å¿µ"></a>Builderæ¨¡å¼æ¦‚å¿µ</h2><p>The builder pattern is an object creation software design pattern. Unlike the abstract factory pattern and the factory method pattern whose intention is to enable polymorphism, the intention of the builder pattern is to find a solution to the telescoping constructor anti-pattern[citation needed]. The telescoping constructor anti-pattern occurs when the increase of object constructor parameter combination leads to an exponential list of constructors. Instead of using numerous constructors, the builder pattern uses another object, a builder, that receives each initialization parameter step by step and then returns the resulting constructed object at once. ï¼ˆä»£æ›¿æ„é€ å‡½æ•°ï¼‰</p><p>The builder pattern has another benefit. It can be used for objects that contain flat data (html code, SQL query, X.509 certificateâ€¦), that is to say, data that canâ€™t be easily edited. This type of data cannot be edited step by step and must be edited at once. The best way to construct such an object is to use a builder class.ï¼ˆåˆ›å»ºä¸å¯å˜å¯¹è±¡ï¼‰</p><p>å®šä¹‰<br>åŸæ–‡ â€“ The intent of the Builder design pattern is to separate the construction of a complex object from its representation. By doing so the same construction process can create different representations.   ï¼ˆfrom wikipediaï¼‰<br>è¯‘æ–‡ â€“ å°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚</p><p>å®šä¹‰æœ‰ç‚¹æŠ½è±¡ï¼Œå…ˆæ¥çœ‹ä¸ªBuilderçš„ä¸€ä¸ªæ¯”è¾ƒç›´è§‚çš„ä½¿ç”¨åœºæ™¯ â€”â€” ä½¿ç”¨Builderä»£æ›¿å…·æœ‰å¤šä¸ªå‚æ•°ï¼ˆ4ä¸ªä»¥ä¸Šï¼‰çš„æ„é€ å‡½æ•°</p><h3 id="åœºæ™¯ç®€ä»‹"><a href="#åœºæ™¯ç®€ä»‹" class="headerlink" title="åœºæ™¯ç®€ä»‹"></a>åœºæ™¯ç®€ä»‹</h3><blockquote><p>å¦‚ä¸€ä¸ªç±»è¡¨ç¤ºåŒ…è£…é£Ÿå“å¤–é¢æ˜¾ç¤ºçš„è¥å…»æˆåˆ†æ ‡ç­¾ï¼Œæ ‡ç­¾ä¸­æœ‰äº›åŸŸæ˜¯å¿…é¡»çš„ï¼Œä¸è¿‡æœ‰äº›ä¹Ÿæ˜¯å¯é€‰åŸŸã€‚å¤§å¤šæ•°äº§å“åœ¨æŸå‡ ä¸ªå¯é€‰åŸŸä¸­éƒ½æœ‰é0å€¼ã€‚å¯¹äºè¿™æ ·çš„ç±»ï¼Œä¸€èˆ¬éƒ½ä½¿ç”¨é‡å æ„é€ å™¨ï¼ˆtelescoping sconstructorï¼‰æ¨¡å¼ã€‚è¿™ç§æ¨¡å¼å°†ä¼šå‡ºç°è¿‡ä¸ªæ„é€ å‡½æ•°ï¼Œåˆ›å»ºå®ä¾‹çš„æ—¶å€™é€‰æ‹©åˆé€‚çš„æ„é€ å‡½æ•°ã€‚ä¾‹å¦‚å¦‚ä¸‹ä»£ç ï¼š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Telescoping constructor pattern - does not scale well!</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NutritionFacts</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;  <span class="comment">//(ml) required</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;     <span class="comment">//(per container) required</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> calories;     <span class="comment">//  optional</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> fat;              <span class="comment">//  optional</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> sodium;           <span class="comment">//  optional</span></span><br><span class="line">    privatefinalintcarbohydrate;        <span class="comment">//  optional</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> calories)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, calories, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> calories, <span class="keyword">int</span> fat)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, calories, fat, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings,</span></span></span><br><span class="line"><span class="params"><span class="function">        <span class="keyword">int</span> calories, <span class="keyword">int</span> fat, <span class="keyword">int</span> sodium)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(servingSize, servings, calories, fat, sodium, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings, <span class="keyword">int</span> calories, <span class="keyword">int</span> fat, <span class="keyword">int</span> sodium, <span class="keyword">int</span> carbohydrate)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servingSize  = servingSize;</span><br><span class="line">        <span class="keyword">this</span>.servings = servings;</span><br><span class="line">        <span class="keyword">this</span>.calories = calories;</span><br><span class="line">        <span class="keyword">this</span>.fat = fat;</span><br><span class="line">        <span class="keyword">this</span>.sodium = sodium;</span><br><span class="line">        <span class="keyword">this</span>.carbohydrate = carbohydrate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨çš„æ—¶å€™ä½¿ç”¨NutritionFacts nut = new NutritionFacts(xx, xx, xx, xx, 0, xx); è¿™æ ·çš„è¯å¯èƒ½å°±å­˜åœ¨ä½ ä¸æƒ³ç»™sodiumèµ‹å€¼ï¼Œä½†æ˜¯ä½ åˆå¾—ç»™carbohydrateèµ‹å€¼ï¼Œå°±å¯¼è‡´ä½ å¿…é¡»ç»™sodiumä¼ å…¥0ã€‚å¦‚æœå‚æ•°æ•°ç›®æ›´å¤šçš„è¯ï¼Œè¿™ç§æƒ…å†µæ›´ç³Ÿç³•ï¼Œéš¾ä»¥æ§åˆ¶ï¼Œè€Œä¸”å½“ä½ ä¼ å‚çš„é¡ºåºå¼„é”™æ—¶ï¼Œå¹¶ä¸ä¼šæç¤ºé”™è¯¯ï¼Œä½†è¿è¡Œå¯èƒ½ä¼šæŠ¥é”™ï¼Œå¯¹åˆ«äººçš„å¯è¯»æ€§ä¹Ÿä¸é«˜ã€‚</p><h2 id="JavaBeansæ¨¡å¼"><a href="#JavaBeansæ¨¡å¼" class="headerlink" title="JavaBeansæ¨¡å¼"></a>JavaBeansæ¨¡å¼</h2><p>å…ˆæ¥çœ‹ç¬¬ä¸€ç§è§£å†³æ–¹æ¡ˆ â€”â€” JavaBeansæ¨¡å¼</p><p>JavaBeansæ¨¡å¼æ˜¯è°ƒç”¨ä¸€ä¸ªæ— å‚æ„é€ å‡½æ•°åˆ›å»ºå¯¹è±¡ï¼Œç„¶åè°ƒç”¨å±æ€§çš„setteræ–¹æ³•å¯¹æ¯ä¸ªå±æ€§èµ‹å€¼ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// JavaBeans Pattern - allows inconsistency, mandates mutability</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NutritionFacts</span> </span>&#123;</span><br><span class="line">   <span class="comment">// Parameters initialized to default values (if any)</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> servingSize = -<span class="number">1</span>; <span class="comment">// Required; no default value</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> servings=-<span class="number">1</span>;<span class="comment">//&quot;&quot;&quot;&quot;</span></span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> calories=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> fat=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> sodium=<span class="number">0</span>;</span><br><span class="line">   <span class="keyword">private</span> <span class="keyword">int</span> carbohydrate = <span class="number">0</span>;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">NutritionFacts</span><span class="params">()</span> </span>&#123; &#125;</span><br><span class="line">   <span class="comment">// Setters  æ±‰å­</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServingSize</span><span class="params">(<span class="keyword">int</span> val)</span>  </span>&#123; servingSize = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setServings</span><span class="params">(<span class="keyword">int</span> val)</span>    </span>&#123; servings = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCalories</span><span class="params">(<span class="keyword">int</span> val)</span>    </span>&#123; calories = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setFat</span><span class="params">(<span class="keyword">int</span> val)</span>         </span>&#123; fat = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setSodium</span><span class="params">(<span class="keyword">int</span> val)</span>      </span>&#123; sodium = val; &#125;</span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setCarbohydrate</span><span class="params">(<span class="keyword">int</span> val)</span> </span>&#123; carbohydrate = val; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è¿™ä¸ªä»£ç æ¯”ä½¿ç”¨é‡å æ„é€ å‡½æ•°çš„ä»£ç ç®€å•äº†ç‚¹ï¼Œé˜…è¯»ä¹Ÿè¾ƒä¸ºå®¹æ˜“ï¼Œä½†æ˜¯è°ƒç”¨æ–¹æ³•ä¸ºï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NutritionFacts cocaCola = <span class="keyword">new</span> NutritionFacts();</span><br><span class="line">cocaCola.setServingSize(<span class="number">240</span>);</span><br><span class="line">cocaCola.setServings(<span class="number">8</span>);</span><br><span class="line">cocaCola.setCalories(<span class="number">100</span>);</span><br><span class="line">cocaCola.setSodium(<span class="number">35</span>);</span><br><span class="line">cocaCola.setCarbohydrate(<span class="number">27</span>);</span><br></pre></td></tr></table></figure><p>è¿™ç§æ¨¡å¼å¼¥è¡¥äº†é‡å æ„é€ å‡½æ•°çš„ä¸è¶³ï¼Œä½¿ä»£ç ç®€å•ï¼Œå¯é˜…è¯»ï¼›ä½†æ˜¯åœ¨è°ƒç”¨æ—¶è¦å…ˆnewä¸€ä¸ªå¯¹è±¡ï¼Œè€Œæ— æ³•ä¿è¯æˆ‘ä»¬åœ¨ä½¿ç”¨è¿™ä¸ªå¯¹è±¡ä¹‹å‰å·²ç»å¯¹ç›¸åº”çš„å±æ€§è¿›è¡Œèµ‹å€¼ã€‚</p><p>JavaBeansæ¨¡å¼çš„ç¼ºç‚¹æ˜¯ï¼šä½¿å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹åˆ†åˆ°å‡ ä¸ªè°ƒç”¨ä¸­ï¼Œåœ¨æ„é€ è¿‡ç¨‹ä¸­å¯èƒ½å¤„äºä¸ä¸€è‡´çš„çŠ¶æ€ã€‚ç±»æ— æ³•ä»…ä»…é€šè¿‡æ£€éªŒæ„é€ å™¨å‚æ•°çš„æœ‰æ•ˆæ€§æ¥ä¿è¯ä¸€è‡´æ€§ã€‚è¯•å›¾ä½¿ç”¨å¤„äºä¸ä¸€è‡´çŠ¶æ€çš„å¯¹è±¡ï¼Œå°†ä¼šå¯¼è‡´å¤±è´¥ã€‚è¿™ç§å¤±è´¥ä¸åŒ…å«é”™è¯¯çš„ä»£ç å¤§ç›¸åŠ²åº­ï¼Œå› ä¸ºå…¶è°ƒè¯•èµ·æ¥ååˆ†å›°éš¾ã€‚JavaBeansä¸èƒ½åˆ›å»ºä¸å¯å˜çš„å®ä¾‹ï¼Œå› ä¸ºéœ€è¦ä½ ä»˜å‡ºé¢å¤–çš„ä»£ä»·æ¥ä¿è¯è¿™ä¸ªç±»æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚</p><h2 id="Builderæ¨¡å¼"><a href="#Builderæ¨¡å¼" class="headerlink" title="Builderæ¨¡å¼"></a>Builderæ¨¡å¼</h2><p>ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆ â€”â€” Builderæ¨¡å¼</p><p>æ—¢èƒ½ä¿è¯å‘é‡å æ„é€ å™¨æ¨¡å¼é‚£æ ·çš„å®‰å…¨æ€§ï¼Œä¹Ÿèƒ½ä¿è¯å‘JavaBeansæ¨¡å¼é‚£ä¹ˆå¥½çš„å¯è¯»æ€§ã€‚è¿™å°±æ˜¯Buildeæ¨¡å¼çš„ä¸€ç§å½¢å¼ã€‚ä¸ç›´æ¥ç”Ÿæˆæƒ³è¦çš„å¯¹è±¡ï¼Œè€Œæ˜¯è®©å®¢æˆ·ç«¯åˆ©ç”¨æ‰€æœ‰å¿…è¦çš„å‚æ•°è°ƒç”¨æ„é€ å™¨æˆ–è€…é™æ€å·¥å‚ï¼Œå¾—åˆ°ä¸€ä¸ªbuilderå¯¹è±¡ã€‚ç„¶åå®¢æˆ·ç«¯åœ¨builderä¸Šè°ƒç”¨ç±»ä¼¼setterçš„æ–¹æ³•æ¥è®¾ç½®æ¯ä¸ªç›¸å…³çš„å¯é€‰å‚æ•°ã€‚æœ€åå®¢æˆ·ç«¯è°ƒç”¨æ— å‚çš„buildæ–¹æ³•æ¥ç”Ÿæˆä¸å¯å˜çš„å¯¹è±¡ã€‚è¿™ä¸ªbuilderæ˜¯å®ƒæ„é€ çš„ç±»çš„é™æ€çš„æˆå‘˜ç±»ã€‚ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Builder Pattern</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NutritionFacts</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> calories;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> fat;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> sodium;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> carbohydrate;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">Builder</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Required parameters</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servingSize;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">int</span> servings;</span><br><span class="line">    <span class="comment">// Optional parameters - initialized to default values</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> calories = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> fat = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> carbohydrate = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> sodium = <span class="number">0</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Builder</span><span class="params">(<span class="keyword">int</span> servingSize, <span class="keyword">int</span> servings)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.servingSize = servingSize;</span><br><span class="line">        <span class="keyword">this</span>.servings = servings;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">calories</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; calories = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">fat</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; fat = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">carbohydrate</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; carbohydrate = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Builder <span class="title">sodium</span><span class="params">(<span class="keyword">int</span> val)</span></span></span><br><span class="line"><span class="function">        </span>&#123; sodium = val; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> NutritionFacts <span class="title">build</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> NutritionFacts(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="title">NutritionFacts</span><span class="params">(Builder builder)</span> </span>&#123;</span><br><span class="line">        servingSize = builder.servingSize;</span><br><span class="line">        servings = builder.servings;</span><br><span class="line">        calories = builder.calories;</span><br><span class="line">        fat = builder.fat;</span><br><span class="line">        sodium = builder.sodium;</span><br><span class="line">        carbohydrate = builder.carbohydrate;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>è°ƒç”¨æ—¶æ˜¯è¿™æ ·çš„ï¼š<br><code>NutritionFacts cocaCola = new NutritionFacts.Builder(240, 8).calories(100).sodium(35).carbohydrate(27).build();</code></p><p>å°±åƒæ„é€ å™¨é‚£æ ·ï¼Œbuilder å¯ä»¥å¼ºåŠ ç»™å®ƒçš„å‚æ•°å˜é‡ï¼ˆè¿™ä¸ªå¼ºåŠ çš„å‚æ•°å˜é‡å¯ä»¥ä½œä¸ºåˆ›å»ºå¯¹è±¡çš„å¿…é¡»å‚æ•°ï¼‰ï¼Œbuild æ–¹æ³•å®ä¾‹åŒ–å®ä½“ç±»ï¼Œå®ä¾‹åŒ–å‰ï¼Œå¯ä»¥å¯¹å‚æ•°è¿›è¡Œæ£€æŸ¥ï¼Œå¦‚æœä¸æ»¡è¶³æ¡ä»¶çš„ï¼Œåº”è¯¥æŠ›å‡º IllegalStateExceptionï¼Œæˆ–è€…å…¶ä»–è‡ªå®šä¹‰å¼‚å¸¸ã€‚<br>å¦å¤–ä¸€ä¸ªå°ä¼˜ç‚¹æ˜¯ builder å¯ä»¥æœ‰å¤šä¸ªå¯å˜å‚æ•°ã€‚æ„é€ å™¨ï¼Œåƒæ–¹æ³•ä¸€æ ·ï¼Œå¯èƒ½åªæœ‰ä¸€ä¸ªå¯å˜å‚æ•°ã€‚å› ä¸º builder ç”¨ä¸åŒçš„æ–¹æ³•è®¾ç½®å‚æ•°ï¼Œåªè¦ä½ å–œæ¬¢ï¼Œä»–ä»¬å¯ä»¥æœ‰å¾ˆå¤šå¯å˜å‚æ•°ã€‚</p><p>ä»£ç ä¸­NutritionFactsç±»ä¸­å±æ€§éƒ½æ˜¯finalç±»å‹çš„ï¼Œè¿™æ˜¯å¿…é¡»çš„å‘¢è¿˜æ˜¯åªæ˜¯ä¸ºäº†è®©å¯¹è±¡å®ä¾‹ä¸€æ—¦åˆ›å»ºï¼Œå…¶çŠ¶æ€å°±ä¸èƒ½åœ¨æ”¹å˜ã€‚è€ŒJavaBeanså´æ— æ³•åˆ›å»ºè¿™ç§ä¸å¯å˜å¯¹è±¡ã€‚</p><p>ä¸JavaBeansçš„åŒºåˆ«å…¶å®æ˜¯åœ¨äºçœŸæ­£æ„é€ å¯¹è±¡çš„æ—¶é—´ç‚¹ä¸Šã€‚å…¶å®Builderå¹¶æ²¡æœ‰æå‰æŠŠå¯¹è±¡æ„é€ å‡ºæ¥ç„¶åå†ä¸€ä¸ªä¸ªåœ°å¯¹å‚æ•°è¿›è¡Œè®¾ç½®ï¼Œè€Œæ˜¯å…ˆè®¾å®šå€¼ï¼Œå†åœ¨æœ€åçš„build()æ–¹æ³•ä¸­æ„å»ºå‡ºå¯¹è±¡ã€‚è¿™æ ·åœ¨ä¸€äº›å‚æ•°å­˜åœ¨ä¾èµ–å…³ç³»çš„æ—¶å€™ï¼Œå¯ä»¥å¾ˆå¥½åœ°è§£å†³ä¾èµ–çš„é—®é¢˜ã€‚å½“ç„¶ï¼Œå¯¹äºå‚æ•°çš„ä¼ é€’ä¹Ÿä¸ä¸€å®šè¦æŒ‰ç…§ä¸Šé¢å†™çš„æ–¹å¼ï¼ŒSetterå…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œå…¶æ€æƒ³ä¸åœ¨äºæ¨¡æ‹ŸæŒ‰åå­—ä¼ é€’å‚æ•°ï¼Œåœ¨äºåé¢çš„build()ã€‚</p><p>ä»ä¸Šé¢çš„ä¾‹å­ä¸­å¯ä»¥çœ‹å‡ºï¼ŒBuilderæ¨¡å¼å¤šæ•°æ˜¯ç”¨äºå¯¹è±¡æ¯”è¾ƒå¤æ‚ï¼Œå¯ä»¥é€æ­¥å»æ„å»ºçš„æ—¶å€™ï¼Œå…¶æ ¸å¿ƒåœ¨äºå°†ç±»çš„æ„å»ºé€»è¾‘è½¬ç§»åˆ°ç±»çš„å®ä¾‹åŒ–å¤–éƒ¨ã€‚å…¶ç»å…¸åº”ç”¨æ˜¯ä»ä¸€æ®µæ–‡æœ¬ä¸­æ„å»ºå¯¹è±¡ï¼Œå› ä¸ºæ–‡æœ¬çš„è¯»å…¥æ˜¯ä»¥æµçš„å½¢å¼ï¼Œé‚£ä¹ˆä¸€å¼€å§‹çš„æ—¶å€™å¯èƒ½æ²¡æœ‰åŠæ³•åˆ›å»ºå®Œæ•´çš„ç›®æ ‡å¯¹è±¡ï¼Œè¿™æ—¶å€™å¯ä»¥ä½¿ç”¨æ„å»ºè€…æ¨¡å¼æ¥è¿›è¡Œæ„å»ºã€‚ä½†æ˜¯åœ¨æ³¨é‡æ€§èƒ½çš„ç¯å¢ƒä¸‹ï¼Œæ¯æ¬¡åˆ›å»ºå®ä¾‹éƒ½å¿…é¡»å…ˆåˆ›å»ºBuilderæ„é€ å™¨ä¹Ÿä¼šæ˜¯ä¸€ç¬”å¼€é”€ï¼Œè€Œä¸”ä»£ç ä¹Ÿæœ‰ç‚¹å†—é•¿ã€‚æ€»çš„æ¥è¯´å¦‚æœç±»æœ‰å¤šä¸ªå±æ€§éœ€è¦å¤šä¸ªæ„é€ å‡½æ•°ï¼ŒBuilderæ¨¡å¼è¿˜æ˜¯ä¸€ä¸ªä¸é”™çš„é€‰æ‹©ã€‚</p><h2 id="Builderéƒ¨ä»¶è§£æ"><a href="#Builderéƒ¨ä»¶è§£æ" class="headerlink" title="Builderéƒ¨ä»¶è§£æ"></a>Builderéƒ¨ä»¶è§£æ</h2><p>å†å›åˆ°Builderçš„å®šä¹‰ï¼Œå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤ºã€‚åœ¨è¿™é‡Œæˆ‘æš‚æ—¶è¿™æ ·ç†è§£ï¼Œå°±æ˜¯æŠŠå¤æ‚å¯¹è±¡çš„æ„å»ºè¿‡ç¨‹å’Œç»“æœè¿›è¡Œåˆ†ç¦»ã€‚Builderçš„umlå›¾ä¸ºï¼š<br><img src="/blogimgs/Builder%E6%A8%A1%E5%BC%8F/builderuml.png" alt="Builder umlå›¾" title="Builder umlå›¾"><br>æœ‰ç‚¹ç±»ä¼¼å·¥å‚æ¨¡å¼ï¼Œå…¶ä¸­</p><ul><li>Builderï¼šç”Ÿæˆå™¨æ¥å£ï¼Œå®šä¹‰åˆ›å»ºä¸€ä¸ªProductå¯¹è±¡æ‰€éœ€è¦çš„å„ä¸ªéƒ¨ä»¶çš„æ“ä½œã€‚</li><li>ConcreteBuilderï¼šå…·ä½“çš„ç”Ÿæˆå™¨å®ç°ï¼Œå®ç°å„ä¸ªéƒ¨ä»¶çš„åˆ›å»ºï¼Œå¹¶è´Ÿè´£ç»„è£…Productå¯¹è±¡çš„å„ä¸ªéƒ¨ä»¶ï¼ŒåŒæ—¶è¿˜æä¾›ä¸€ä¸ªè®©ç”¨æˆ·è·å–ç»„è£…å®Œæˆåçš„äº§å“å¯¹è±¡çš„æ–¹æ³•ã€‚</li><li>Directorï¼šæŒ‡å¯¼è€…ï¼Œä¹Ÿè¢«ç§°å¯¼å‘è€…ï¼Œä¸»è¦ç”¨æ¥ä½¿ç”¨Builderæ¥å£ï¼Œä»¥ä¸€ä¸ªç»Ÿä¸€çš„è¿‡ç¨‹æ¥æ„å»ºæ‰€éœ€è¦çš„Productå¯¹è±¡ã€‚</li><li>Productï¼šäº§å“ï¼Œè¡¨ç¤ºè¢«ç”Ÿæˆå™¨æ„å»ºçš„å¤æ‚å¯¹è±¡ï¼ŒåŒ…å«å¤šä¸ªéƒ¨ä»¶ã€‚</li></ul><p>çœ‹äº†ä¸Šé¢çš„umlå›¾å’Œå„ä¸ªéƒ¨ä»¶çš„è§£é‡Šï¼Œå¯èƒ½å°±ä¼šäº§ç”Ÿç–‘é—®äº†ï¼Œä¸Šé¢çš„ä½¿ç”¨Builderä»£æ›¿æ„é€ å‡½æ•°çš„åœºæ™¯ä¸­ä½¿ç”¨çš„è§’è‰²å’ŒUMLä¸­çš„è§’è‰²ä¸å¯¹ç§°äº†ï¼Œä¸è¦ç€æ€¥ï¼Œä¸‹é¢è¿›è¡Œè§£é‡Šï¼š</p><p>ä¸Šé¢çš„ä½¿ç”¨åœºæ™¯æ¯”è¾ƒæ˜ç¡®ï¼Œå°±æ˜¯åˆ›å»ºæŸä¸ªå¤åˆ¶å¯¹è±¡ï¼Œå¯ä»¥è¿›è¡Œé€‚å½“çš„ç®€åŒ–ã€‚å…¶ä¸­Builderæ¨¡å¼åªæ˜¯ç”¨æ¥åˆ›å»ºæŸä¸ªå¯¹è±¡ï¼Œåˆ™å°±æ²¡æœ‰å¿…è¦å®šä¹‰Builderçš„æ¥å£ï¼Œç›´æ¥æä¾›ä¸€ä¸ªå…·ä½“çš„ConcreteBuilderå°±è¡Œï¼›å¦‚æœåªåˆ›å»ºä¸€ä¸ªå¤æ‚çš„å¯¹è±¡ï¼Œä¸å¯èƒ½ä¼šæœ‰å¾ˆå¤šç§ä¸åŒçš„é€‰æ‹©å’Œæ­¥éª¤ï¼Œå¯¼æ¼”ç±»Directorå°±å¯ä»¥å¹²æ‰äº†ï¼Œå°†å…¶åŠŸèƒ½ä¸Clientçš„åŠŸèƒ½åˆå¹¶ï¼Œä½¿Clientå…·å¤‡Directorçš„åŠŸèƒ½ï¼Œæ¥æŒ‡å¯¼æ„å»ºå™¨æ¥æ„å»ºéœ€è¦çš„å¤æ‚å¯¹è±¡ã€‚</p><h2 id="Builderæ¨¡å¼çš„åŠŸèƒ½"><a href="#Builderæ¨¡å¼çš„åŠŸèƒ½" class="headerlink" title="Builderæ¨¡å¼çš„åŠŸèƒ½"></a>Builderæ¨¡å¼çš„åŠŸèƒ½</h2><p>ç”Ÿæˆå™¨æ¨¡å¼çš„ä¸»è¦åŠŸèƒ½æ˜¯æ„å»ºå¤æ‚çš„äº§å“ï¼Œè€Œä¸”æ˜¯ç»†åŒ–çš„ï¼Œåˆ†æ­¥éª¤çš„æ„å»ºäº§å“ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆå™¨æ¨¡å¼é‡åœ¨ä¸€æ­¥ä¸€æ­¥è§£å†³æ„é€ å¤æ‚å¯¹è±¡çš„é—®é¢˜ã€‚å¦‚æœä»…ä»…è¿™ä¹ˆè®¤çŸ¥ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½æ˜¯ä¸å¤Ÿçš„ã€‚<br>æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ„å»ºçš„è¿‡ç¨‹æ˜¯ç»Ÿä¸€çš„ã€å›ºå®šä¸å˜çš„ï¼Œå˜åŒ–çš„éƒ¨åˆ†æ”¾åˆ°ç”Ÿæˆå™¨éƒ¨åˆ†äº†ï¼Œåªè¦é…ç½®ä¸åŒçš„ç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆåŒæ ·çš„æ„å»ºè¿‡ç¨‹ï¼Œå°±èƒ½æ„å»ºå‡ºä¸åŒçš„äº§å“æ¥ã€‚ è¿™æ˜¯å¯¹å®šä¹‰ï¼ˆå°†ä¸€ä¸ªå¤æ‚å¯¹è±¡çš„æ„å»ºä¸å®ƒçš„è¡¨ç¤ºåˆ†ç¦»ï¼Œä½¿å¾—åŒæ ·çš„æ„å»ºè¿‡ç¨‹å¯ä»¥åˆ›å»ºä¸åŒçš„è¡¨ç¤º ï¼‰æ›´è¿›ä¸€æ­¥çš„è§£é‡Šã€‚</p><p>æ­£å¸¸çš„Builderæ¨¡å¼çš„ä»£ç ç¤ºä¾‹å¦‚ä¸‹ï¼š<br>1ã€ç”Ÿæˆå™¨æ¥å£å®šä¹‰çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * ç”Ÿæˆå™¨æ¥å£ï¼Œå®šä¹‰åˆ›å»ºä¸€ä¸ªäº§å“å¯¹è±¡æ‰€éœ€çš„å„ä¸ªéƒ¨ä»¶çš„æ“ä½œ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * ç¤ºæ„æ–¹æ³•ï¼Œæ„å»ºæŸä¸ªéƒ¨ä»¶ </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPart</span><span class="params">()</span></span>;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>2ã€å…·ä½“ç”Ÿæˆå™¨å®ç°çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å…·ä½“çš„ç”Ÿæˆå™¨å®ç°å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConcreteBuilder</span> <span class="keyword">implements</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">      </span><br><span class="line">    <span class="keyword">private</span> Product resultProduct;  </span><br><span class="line">      </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * è·å–ç”Ÿæˆå™¨æœ€ç»ˆæ„å»ºçš„äº§å“å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@return</span> </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> Product <span class="title">getResultProduct</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> resultProduct;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildPart</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="comment">//æ„å»ºæŸä¸ªéƒ¨ä»¶çš„åŠŸèƒ½å¤„ç†  </span></span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>3ã€ç›¸åº”çš„äº§å“å¯¹è±¡æ¥å£çš„ç¤ºä¾‹ä»£ç </p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * è¢«æ„å»ºçš„äº§å“å¯¹è±¡çš„æ¥å£ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Product</span> </span>&#123;  </span><br><span class="line">    <span class="comment">//å®šä¹‰äº§å“çš„æ“ä½œ  </span></span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><p>4ã€æœ€åæ˜¯æŒ‡å¯¼è€…çš„å®ç°ç¤ºæ„ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æŒ‡å¯¼è€…ï¼ŒæŒ‡å¯¼ä½¿ç”¨ç”Ÿæˆå™¨çš„æ¥å£æ¥æ„å»ºäº§å“å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Director</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * æŒæœ‰å½“å‰éœ€è¦ä½¿ç”¨çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> Builder builder;  </span><br><span class="line">   </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„é€ æ–¹æ³•ï¼Œä¼ äººç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> builder </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Director</span><span class="params">(Builder builder)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.builder = builder;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * ç¤ºæ„æ–¹æ³•ï¼ŒæŒ‡å¯¼ç”Ÿæˆå™¨æ„å»ºæœ€ç»ˆçš„äº§å“å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">construct</span><span class="params">()</span></span>&#123;  </span><br><span class="line">         <span class="comment">//é€šè¿‡ä½¿ç”¨ç”Ÿæˆå™¨æ¥å£æ¥æ„å»ºæœ€ç»ˆçš„äº§å“å¯¹è±¡  </span></span><br><span class="line">         builder.buildPart();  </span><br><span class="line">     &#125;  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure><h2 id="åº”ç”¨åœºæ™¯â€“-å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶"><a href="#åº”ç”¨åœºæ™¯â€“-å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶" class="headerlink" title="åº”ç”¨åœºæ™¯â€“ å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶"></a>åº”ç”¨åœºæ™¯â€“ å¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶</h2><p>åœ¨è®¨è®ºå·¥å‚æ–¹æ³•æ¨¡å¼çš„æ—¶å€™ï¼Œæä¾›äº†ä¸€ä¸ªå¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶ã€‚<br>å¯¹äºå¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶ï¼Œé€šå¸¸åœ¨å¯¼å‡ºæ•°æ®ä¸Šï¼Œä¼šæœ‰ä¸€äº›çº¦æŸçš„æ–¹å¼ï¼Œæ¯”å¦‚å¯¼å‡ºæˆæ–‡æœ¬æ ¼å¼ã€æ•°æ®åº“å¤‡ä»½å½¢å¼ã€Excelæ ¼å¼ã€Xmlæ ¼å¼ç­‰ã€‚<br>åœ¨å·¥å‚æ–¹æ³•æ¨¡å¼ç« èŠ‚é‡Œé¢ï¼Œè®¨è®ºå¹¶ä½¿ç”¨å·¥å‚æ–¹æ³•æ¨¡å¼æ¥è§£å†³äº†å¦‚ä½•é€‰æ‹©å…·ä½“å¯¼å‡ºæ–¹å¼çš„é—®é¢˜ï¼Œå¹¶æ²¡æœ‰æ¶‰åŠåˆ°æ¯ç§æ–¹å¼å…·ä½“å¦‚ä½•å®ç°ã€‚<br>æ¢å¥è¯è¯´ï¼Œåœ¨è®¨è®ºå·¥å‚æ–¹æ³•æ¨¡å¼çš„æ—¶å€™ï¼Œå¹¶æ²¡æœ‰è®¨è®ºå¦‚ä½•å®ç°å¯¼å‡ºæˆæ–‡æœ¬ã€Xmlç­‰å…·ä½“æ ¼å¼ï¼Œæœ¬ç« å°±æ¥è®¨è®ºè¿™ä¸ªé—®é¢˜ã€‚<br>å¯¹äºå¯¼å‡ºæ•°æ®çš„åº”ç”¨æ¡†æ¶ï¼Œé€šå¸¸å¯¹äºå…·ä½“çš„å¯¼å‡ºå†…å®¹å’Œæ ¼å¼æ˜¯æœ‰è¦æ±‚çš„ï¼ŒåŠ å…¥ç°åœ¨æœ‰å¦‚ä¸‹è¦æ±‚ï¼Œç®€å•æè¿°ä¸€ä¸‹ï¼š</p><ul><li>å¯¼å‡ºçš„æ–‡ä»¶ï¼Œä¸ç®¡æ˜¯ä»€ä¹ˆæ ¼å¼ï¼Œéƒ½åˆ†æˆ3ä¸ªéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯æ–‡ä»¶å¤´ã€æ–‡ä»¶ä½“ã€æ–‡ä»¶å°¾ã€‚</li><li>åœ¨æ–‡ä»¶å¤´éƒ¨åˆ†ï¼Œéœ€è¦æè¿°å¦‚ä¸‹ä¿¡æ¯ï¼šåˆ†å…¬å¸æˆ–è€…é—¨å¸‚ç¼–å·ã€å¯¼å‡ºæ•°æ®çš„æ—¥æœŸã€‚</li><li>åœ¨æ–‡ä»¶ä½“éƒ¨åˆ†ï¼Œéœ€è¦æè¿°å¦‚ä¸‹ä¿¡æ¯ï¼šè¡¨åç§°ï¼Œç„¶ååˆ†æ¡æè¿°æ•°æ®ã€‚</li><li>åœ¨æ–‡ä»¶å°¾éƒ¨åˆ†ï¼Œéœ€è¦æè¿°å¦‚ä¸‹ä¿¡æ¯ï¼šè¾“å‡ºäººã€‚</li></ul><p>1ã€ä¸‹é¢å°†æè¿°æ–‡ä»¶å„ä¸ªéƒ¨åˆ†çš„æ•°æ®å¯¹è±¡å®šä¹‰å‡ºæ¥<br>æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å¤´çš„å†…å®¹çš„å¯¹è±¡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å¤´çš„å†…å®¹çš„å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportHeaderModel</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * åˆ†å…¬å¸æˆ–è€…é—¨å¸‚ç¼–å· </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String depId;  </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * å¯¼å‡ºæ•°æ®çš„æ—¥æœŸ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String exportDate;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getDepId</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> depId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setDepId</span><span class="params">(String depId)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.depId = depId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getExportDate</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> exportDate;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExportDate</span><span class="params">(String exportDate)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.exportDate = exportDate;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>æè¿°è¾“å‡ºæ•°æ®çš„å¯¹è±¡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æè¿°è¾“å‡ºæ•°æ®çš„å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportDataModel</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * äº§å“ç¼–å· </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String productId;  </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * é”€å”®ä»·æ ¼ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">double</span> price;  </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * é”€å”®æ•°é‡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> <span class="keyword">double</span> amount;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getProductId</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> productId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProductId</span><span class="params">(String productId)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.productId = productId;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getPrice</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> price;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setPrice</span><span class="params">(<span class="keyword">double</span> price)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.price = price;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">double</span> <span class="title">getAmount</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> amount;  </span><br><span class="line">     &#125;  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setAmount</span><span class="params">(<span class="keyword">double</span> amount)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.amount = amount;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å°¾çš„å†…å®¹çš„å¯¹è±¡ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æè¿°è¾“å‡ºåˆ°æ–‡ä»¶å°¾çš„å†…å®¹çš„å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ExportFooterModel</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * è¾“å‡ºäºº </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> String exportUser;  </span><br><span class="line">   </span><br><span class="line">     <span class="function"><span class="keyword">public</span> String <span class="title">getExportUser</span><span class="params">()</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> exportUser;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setExportUser</span><span class="params">(String exportUser)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.exportUser = exportUser;  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>2ã€å®šä¹‰Builderæ¥å£ï¼Œä¸»è¦æ˜¯æŠŠå¯¼å‡ºå„ç§æ ¼å¼æ–‡ä»¶çš„å¤„ç†è¿‡ç¨‹çš„æ­¥éª¤å®šä¹‰å‡ºæ¥ï¼Œæ¯ä¸ªæ­¥éª¤è´Ÿè´£æ„å»ºæœ€ç»ˆå¯¼å‡ºæ–‡ä»¶çš„ä¸€éƒ¨åˆ†ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * ç”Ÿæˆå™¨æ¥å£ï¼Œå®šä¹‰åˆ›å»ºä¸€ä¸ªè¾“å‡ºæ–‡ä»¶å¯¹è±¡æ‰€éœ€çš„å„ä¸ªéƒ¨ä»¶çš„æ“ä½œ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * æ„å»ºè¾“å‡ºæ–‡ä»¶çš„Headeréƒ¨åˆ† </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> ehm </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildHeader</span><span class="params">(ExportHeaderModel ehm)</span></span>;  </span><br><span class="line">       </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„å»ºè¾“å‡ºæ–‡ä»¶çš„Bodyéƒ¨åˆ† </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> mapData </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildBody</span><span class="params">(Map&lt;String,List&lt;ExportDataModel&gt;&gt; mapData)</span></span>;  </span><br><span class="line">       </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„å»ºè¾“å‡ºæ–‡ä»¶çš„Footeréƒ¨åˆ† </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> efm </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildFooter</span><span class="params">(ExportFooterModel efm)</span></span>;  </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>3ã€å…·ä½“çš„ç”Ÿæˆå™¨å®ç°ã€‚<br>å¯¼å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶çš„çš„ç”Ÿæˆå™¨å®ç°ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å®ç°å¯¼å‡ºæ–‡ä»¶åˆ°æ–‡æœ¬æ–‡ä»¶çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TxtBuilder</span> <span class="keyword">implements</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * ç”¨æ¥è®°å½•æ„å»ºçš„æ–‡ä»¶çš„å†…å®¹ï¼Œç›¸å½“äºäº§å“ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> StringBuffer buffer = <span class="keyword">new</span> StringBuffer();  </span><br><span class="line">       </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildHeader</span><span class="params">(ExportHeaderModel ehm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(ehm.getDepId()+<span class="string">&quot;,&quot;</span>+ehm.getExportDate()+<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildBody</span><span class="params">(Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">for</span>(String tablName : mapData.keySet())&#123;  </span><br><span class="line">               </span><br><span class="line">             <span class="comment">//å…ˆæ‹¼æ¥è¡¨å  </span></span><br><span class="line">             buffer.append(tablName+<span class="string">&quot;\n&quot;</span>);  </span><br><span class="line">             <span class="comment">//ç„¶åå¾ªç¯æ‹¼æ¥å…·ä½“æ•°æ®  </span></span><br><span class="line">             <span class="keyword">for</span>(ExportDataModel edm : mapData.get(tablName))&#123;  </span><br><span class="line">                 buffer.append(edm.getProductId()+<span class="string">&quot;,&quot;</span>+edm.getPrice()+<span class="string">&quot;,&quot;</span>+edm.getAmount()+<span class="string">&quot;\n&quot;</span>)</span><br><span class="line">             &#125;  </span><br><span class="line">         &#125;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildFooter</span><span class="params">(ExportFooterModel efm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(efm.getExportUser());  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> StringBuffer <span class="title">getResult</span><span class="params">()</span></span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> buffer;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>å¯¼å‡ºåˆ°Xmlæ–‡ä»¶çš„çš„ç”Ÿæˆå™¨å®ç°ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * å®ç°å¯¼å‡ºæ–‡ä»¶åˆ°Xmlæ–‡ä»¶çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> * </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">XmlBuilder</span> <span class="keyword">implements</span> <span class="title">Builder</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * ç”¨æ¥è®°å½•æ„å»ºçš„æ–‡ä»¶çš„å†…å®¹ï¼Œç›¸å½“äºäº§å“ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> StringBuffer buffer = <span class="keyword">new</span> StringBuffer();  </span><br><span class="line">       </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildHeader</span><span class="params">(ExportHeaderModel ehm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(<span class="string">&quot;&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;&lt;Report&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;Header&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t\t&lt;DepId&gt;&quot;</span>+ehm.getDepId()+<span class="string">&quot;&lt;/DepId&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t\t&lt;ExportDate&gt;&quot;</span>+ehm.getExportDate()+<span class="string">&quot;&lt;/ExportDate&gt;\n&quot;</span>);  </span><br><span class="line">           </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;/Header&gt;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildBody</span><span class="params">(Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData)</span> </span>&#123;  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;Body&gt;\n&quot;</span>);  </span><br><span class="line">         <span class="keyword">for</span>(String tablName : mapData.keySet())&#123;  </span><br><span class="line">             <span class="comment">//å…ˆæ‹¼æ¥è¡¨å  </span></span><br><span class="line">             buffer.append(<span class="string">&quot;\t\t&lt;Datas TableName=\&quot;&quot;</span>+tablName+<span class="string">&quot;\&quot;&gt;\n&quot;</span>);  </span><br><span class="line">             <span class="comment">//ç„¶åå¾ªç¯æ‹¼æ¥å…·ä½“æ•°æ®  </span></span><br><span class="line">             <span class="keyword">for</span>(ExportDataModel edm : mapData.get(tablName))&#123;  </span><br><span class="line">                   </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t&lt;Data&gt;\n&quot;</span>);  </span><br><span class="line">                   </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t\t&lt;ProductId&gt;&quot;</span>+edm.getProductId()+<span class="string">&quot;&lt;/ProductId&gt;\n&quot;</span>);  </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t\t&lt;Price&gt;&quot;</span>+edm.getPrice()+<span class="string">&quot;&lt;/Price&gt;\n&quot;</span>);  </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t\t&lt;Amount&gt;&quot;</span>+edm.getAmount()+<span class="string">&quot;&lt;/Amount&gt;\n&quot;</span>);  </span><br><span class="line">                   </span><br><span class="line">                 buffer.append(<span class="string">&quot;\t\t\t&lt;/Data&gt;\n&quot;</span>);  </span><br><span class="line">             &#125;  </span><br><span class="line">               </span><br><span class="line">             buffer.append(<span class="string">&quot;\t\t&lt;/Datas&gt;\n&quot;</span>);  </span><br><span class="line">         &#125;  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;/Body&gt;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="meta">@Override</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">buildFooter</span><span class="params">(ExportFooterModel efm)</span> </span>&#123;  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;Footer&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t\t&lt;ExportUser&gt;&quot;</span>+efm.getExportUser()+<span class="string">&quot;&lt;/ExportUser&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;\t&lt;/Footer&gt;\n&quot;</span>);  </span><br><span class="line">         buffer.append(<span class="string">&quot;&lt;/Report&gt;\n&quot;</span>);  </span><br><span class="line">     &#125;  </span><br><span class="line">       </span><br><span class="line">     <span class="function"><span class="keyword">public</span> StringBuffer <span class="title">getResult</span><span class="params">()</span></span>&#123;  </span><br><span class="line">         <span class="keyword">return</span> buffer;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>4ã€æŒ‡å¯¼è€…ã€‚æœ‰äº†å…·ä½“çš„ç”Ÿæˆå™¨å®ç°åï¼Œéœ€è¦ç”±æŒ‡å¯¼è€…æ¥æŒ‡å¯¼å®ƒè¿›è¡Œå…·ä½“çš„äº§å“æ„å»ºã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/** </span></span><br><span class="line"><span class="comment"> * æŒ‡å¯¼è€…ï¼ŒæŒ‡å¯¼ä½¿ç”¨ç”Ÿæˆå™¨çš„æ¥å£æ¥æ„å»ºè¾“å‡ºçš„æ–‡ä»¶å¯¹è±¡ </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> *  </span></span><br><span class="line"><span class="comment"> */</span>  </span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Director</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æŒæœ‰å½“å‰éœ€è¦çš„ä½¿ç”¨çš„ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="keyword">private</span> Builder builder;  </span><br><span class="line">   </span><br><span class="line">     <span class="comment">/** </span></span><br><span class="line"><span class="comment">      * æ„é€ æ–¹æ³•ï¼Œä¼ å…¥ç”Ÿæˆå™¨å¯¹è±¡ </span></span><br><span class="line"><span class="comment">      *  </span></span><br><span class="line"><span class="comment">      * <span class="doctag">@param</span> builder </span></span><br><span class="line"><span class="comment">      */</span>  </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="title">Director</span><span class="params">(Builder builder)</span> </span>&#123;  </span><br><span class="line">         <span class="keyword">this</span>.builder = builder;  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line">     <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">construct</span><span class="params">(ExportHeaderModel ehm,  </span></span></span><br><span class="line"><span class="params"><span class="function">             Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData, ExportFooterModel efm)</span> </span>&#123;  </span><br><span class="line">   </span><br><span class="line">         <span class="comment">//1.å…ˆæ„å»ºHeader  </span></span><br><span class="line">         builder.buildHeader(ehm);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//2.ç„¶åæ„å»ºBody  </span></span><br><span class="line">         builder.buildBody(mapData);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//3.å†æ„å»ºFooter  </span></span><br><span class="line">         builder.buildFooter(efm);  </span><br><span class="line">     &#125;  </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><p>5ã€å®¢æˆ·ç«¯æµ‹è¯•ä»£ç å¦‚ä¸‹ï¼š</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Client</span> </span>&#123;  </span><br><span class="line">  </span><br><span class="line">    <span class="comment">/** </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> args </span></span><br><span class="line"><span class="comment">     */</span>  </span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;  </span><br><span class="line">          </span><br><span class="line">        <span class="comment">//å‡†å¤‡æµ‹è¯•æ•°æ®  </span></span><br><span class="line">        ExportHeaderModel ehm = <span class="keyword">new</span> ExportHeaderModel();  </span><br><span class="line">         ehm.setDepId(<span class="string">&quot;ä¸€åˆ†å…¬å¸&quot;</span>);  </span><br><span class="line">         ehm.setExportDate(<span class="string">&quot;2010-05-18&quot;</span>);  </span><br><span class="line">           </span><br><span class="line">         Map&lt;String, List&lt;ExportDataModel&gt;&gt; mapData = <span class="keyword">new</span> HashMap&lt;String, List&lt;ExportDataModel&gt;&gt;  </span><br><span class="line">         List&lt;ExportDataModel&gt; col = <span class="keyword">new</span> ArrayList&lt;ExportDataModel&gt;();  </span><br><span class="line">           </span><br><span class="line">         ExportDataModel edm1 = <span class="keyword">new</span> ExportDataModel();  </span><br><span class="line">         edm1.setProductId(<span class="string">&quot;äº§å“001å·&quot;</span>);  </span><br><span class="line">         edm1.setPrice(<span class="number">100</span>);  </span><br><span class="line">         edm1.setAmount(<span class="number">80</span>);  </span><br><span class="line">           </span><br><span class="line">         ExportDataModel edm2 = <span class="keyword">new</span> ExportDataModel();  </span><br><span class="line">         edm2.setProductId(<span class="string">&quot;äº§å“002å·&quot;</span>);  </span><br><span class="line">         edm2.setPrice(<span class="number">120</span>);  </span><br><span class="line">         edm2.setAmount(<span class="number">280</span>);  </span><br><span class="line">           </span><br><span class="line">         ExportDataModel edm3 = <span class="keyword">new</span> ExportDataModel();  </span><br><span class="line">         edm3.setProductId(<span class="string">&quot;äº§å“003å·&quot;</span>);  </span><br><span class="line">         edm3.setPrice(<span class="number">320</span>);  </span><br><span class="line">         edm3.setAmount(<span class="number">380</span>);  </span><br><span class="line">           </span><br><span class="line">         col.add(edm1);  </span><br><span class="line">         col.add(edm2);  </span><br><span class="line">         col.add(edm3);  </span><br><span class="line">           </span><br><span class="line">         mapData.put(<span class="string">&quot;é”€å”®è®°å½•è¡¨&quot;</span>, col);  </span><br><span class="line">           </span><br><span class="line">         ExportFooterModel efm = <span class="keyword">new</span> ExportFooterModel();  </span><br><span class="line">         efm.setExportUser(<span class="string">&quot;å¼ ä¸‰&quot;</span>);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//æµ‹è¯•è¾“å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶  </span></span><br><span class="line">         TxtBuilder txtBuilder = <span class="keyword">new</span> TxtBuilder();  </span><br><span class="line">         <span class="comment">//åˆ›å»ºæŒ‡å¯¼è€…å¯¹è±¡  </span></span><br><span class="line">         Director director = <span class="keyword">new</span> Director(txtBuilder);  </span><br><span class="line">         director.construct(ehm, mapData, efm);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//æŠŠè¦è¾“å‡ºçš„å†…å®¹è¾“å‡ºåˆ°æ§åˆ¶å°çœ‹çœ‹  </span></span><br><span class="line">         System.out.println(<span class="string">&quot;è¾“å‡ºåˆ°æ–‡æœ¬æ–‡ä»¶çš„å†…å®¹:&quot;</span>+txtBuilder.getResult().toString());  </span><br><span class="line">           </span><br><span class="line">         XmlBuilder xmlBuilder = <span class="keyword">new</span> XmlBuilder();  </span><br><span class="line">         Director director2 = <span class="keyword">new</span> Director(xmlBuilder);  </span><br><span class="line">         director2.construct(ehm, mapData, efm);  </span><br><span class="line">           </span><br><span class="line">         <span class="comment">//æŠŠè¦è¾“å‡ºçš„å†…å®¹è¾“å‡ºåˆ°æ§åˆ¶å°çœ‹çœ‹  </span></span><br><span class="line">         System.out.println(<span class="string">&quot;è¾“å‡ºåˆ°Xmlæ–‡ä»¶çš„å†…å®¹:&quot;</span>+xmlBuilder.getResult().toString());  </span><br><span class="line">     &#125;  </span><br><span class="line">   </span><br><span class="line"> &#125;  </span><br></pre></td></tr></table></figure><h2 id="ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½"><a href="#ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½" class="headerlink" title="ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½"></a>ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½</h2><p>ç”Ÿæˆå™¨æ¨¡å¼çš„ä¸»è¦åŠŸèƒ½æ˜¯æ„å»ºå¤æ‚çš„äº§å“ï¼Œè€Œä¸”æ˜¯ç»†åŒ–çš„ï¼Œåˆ†æ­¥éª¤çš„æ„å»ºäº§å“ï¼Œä¹Ÿå°±æ˜¯ç”Ÿæˆå™¨æ¨¡å¼é‡åœ¨ä¸€æ­¥ä¸€æ­¥è§£å†³æ„é€ å¤æ‚å¯¹è±¡çš„é—®é¢˜ã€‚å¦‚æœä»…ä»…è¿™ä¹ˆè®¤çŸ¥ç”Ÿæˆå™¨æ¨¡å¼çš„åŠŸèƒ½æ˜¯ä¸å¤Ÿçš„ã€‚<br>æ›´ä¸ºé‡è¦çš„æ˜¯ï¼Œè¿™ä¸ªæ„å»ºçš„è¿‡ç¨‹æ˜¯ç»Ÿä¸€çš„ã€å›ºå®šä¸å˜çš„ï¼Œå˜åŒ–çš„éƒ¨åˆ†æ”¾åˆ°ç”Ÿæˆå™¨éƒ¨åˆ†äº†ï¼Œåªè¦é…ç½®ä¸åŒçš„ç”Ÿæˆå™¨ï¼Œé‚£ä¹ˆåŒæ ·çš„æ„å»ºè¿‡ç¨‹ï¼Œå°±èƒ½æ„å»ºå‡ºä¸åŒçš„äº§å“æ¥ã€‚</p><p>##å‚è€ƒ<br><a href="http://blog.csdn.net/top_code/article/details/8469297">http://blog.csdn.net/top_code/article/details/8469297</a><br><a href="https://en.wikipedia.org/wiki/Builder_pattern">https://en.wikipedia.org/wiki/Builder_pattern</a></p>]]></content>
      
      
      <categories>
          
          <category> Java </category>
          
      </categories>
      
      
        <tags>
            
            <tag> java </tag>
            
            <tag> Builder </tag>
            
            <tag> è®¾è®¡æ¨¡å¼ </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
